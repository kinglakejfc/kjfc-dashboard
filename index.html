<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>KJFC Exec Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@400;600;700;800;900&family=Barlow:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>

/* ════════════════════════════════════════
   ROOT VARIABLES
   ════════════════════════════════════════ */
:root{
  --header-h: 60px;
  --green:        #013C1E;
  --green-mid:    #025a2d;
  --green-light:  #e6f0eb;
  --green-bright: #2e7d4f;
  --yellow:       #FBE201;
  --yellow-dark:  #c9b400;
  --yellow-pale:  #fffde6;
  --yellow-mid:   #fef083;
  --bg:           #f4f6f4;
  --card:         #ffffff;
  --text:         #1a1a1a;
  --text-mid:     #3a3a3a;
  --text-dim:     #6b7a6b;
  --border:       #d8e4d8;
  --border-s:     #adc4ad;
  --red:          #b91c1c;
  --red-light:    #fef2f2;
  --orange:       #c2720a;
  --orange-light: #fef6ec;
  --tg:#9a6700; --tgb:#fffaeb;
  --ts:#4a6070; --tsb:#f0f4f8;
  --tb:#7a4a28; --tbb:#fdf4ec;
  --tc:#013C1E; --tcb:#e6f0eb;
  --td:#1a6b8a; --tdb:#e8f4f8;
  --sh:  0 1px 4px rgba(0,0,0,0.07);
  --shm: 0 4px 18px rgba(0,0,0,0.11);
  --r:   11px;
  --safe-bottom: env(safe-area-inset-bottom, 0px);
}

*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
html{scroll-behavior:smooth;}
body{background:var(--bg);color:var(--text);font-family:'Barlow',sans-serif;min-height:100vh;font-size:16px;}

/* ════════════════════════════════════════
   LOADING SCREEN
   ════════════════════════════════════════ */
#loading-screen{
  position:fixed;inset:0;z-index:1000;background:var(--green);
  display:flex;flex-direction:column;align-items:center;justify-content:center;gap:20px;
  transition:opacity .5s ease;
}
#loading-screen.fade{opacity:0;pointer-events:none;}
.ls-crest{
  width:80px;height:80px;background:var(--yellow);border-radius:50%;
  display:flex;align-items:center;justify-content:center;
  font-family:'Barlow Condensed',sans-serif;font-weight:900;font-size:24px;color:var(--green);
  animation:ls-pulse 1.8s ease-in-out infinite;
  box-shadow:0 0 0 0 rgba(251,226,1,0.5);
}
@keyframes ls-pulse{
  0%{box-shadow:0 0 0 0 rgba(251,226,1,0.5);transform:scale(1);}
  50%{box-shadow:0 0 0 18px rgba(251,226,1,0);transform:scale(1.06);}
  100%{box-shadow:0 0 0 0 rgba(251,226,1,0);transform:scale(1);}
}
.ls-text{
  font-family:'Barlow Condensed',sans-serif;font-size:15px;
  color:rgba(255,255,255,.55);text-transform:uppercase;letter-spacing:3px;
  animation:ls-blink 1.4s ease-in-out infinite;
}
@keyframes ls-blink{0%,100%{opacity:.4;}50%{opacity:1;}}
.ls-bar{width:160px;height:3px;background:rgba(255,255,255,.15);border-radius:2px;overflow:hidden;}
.ls-bar-fill{height:100%;width:0;background:var(--yellow);border-radius:2px;animation:ls-load 2s ease-in-out forwards;}
@keyframes ls-load{0%{width:0;}60%{width:75%;}90%{width:90%;}100%{width:100%;}}

/* Dashboard fade-in on load */
@keyframes dash-fadein{from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);}}
header{animation:dash-fadein .4s ease both;}
.sbar{animation:dash-fadein .4s ease .1s both;}
main{animation:dash-fadein .5s ease .15s both;}
.ls-spinner{width:28px;height:28px;border:3px solid rgba(255,255,255,.2);border-top-color:var(--yellow);border-radius:50%;animation:spin .8s linear infinite;}
@keyframes spin{to{transform:rotate(360deg);}}

/* ════════════════════════════════════════
   LOGIN SCREEN
   ════════════════════════════════════════ */
#login-screen{
  position:fixed;inset:0;z-index:999;background:var(--green);
  display:none;align-items:center;justify-content:center;padding:20px;
  overflow-y:auto;
}
#login-screen.show{display:flex;}
.lwrap{display:flex;flex-direction:column;align-items:center;width:100%;max-width:400px;padding:20px 0;}
.lcrest{width:84px;height:84px;background:var(--yellow);border-radius:50%;display:flex;align-items:center;justify-content:center;font-family:'Barlow Condensed',sans-serif;font-weight:900;font-size:26px;color:var(--green);margin-bottom:14px;border:4px solid rgba(255,255,255,.35);box-shadow:0 4px 24px rgba(0,0,0,.3);}
.lclub{font-family:'Barlow Condensed',sans-serif;font-weight:900;font-size:20px;color:#fff;text-transform:uppercase;letter-spacing:1px;text-align:center;line-height:1.2;margin-bottom:3px;}
.ltag{font-size:11px;color:rgba(255,255,255,.55);letter-spacing:2.5px;text-transform:uppercase;margin-bottom:24px;}
.lbox{background:#fff;border-radius:16px;padding:28px 28px 22px;width:100%;box-shadow:0 8px 40px rgba(0,0,0,.22);}
.lbox h2{font-family:'Barlow Condensed',sans-serif;font-weight:900;font-size:18px;text-transform:uppercase;margin-bottom:3px;}
.lbox p{font-size:12px;color:var(--text-dim);margin-bottom:20px;line-height:1.5;}
.google-btn{
  width:100%;padding:13px 16px;border-radius:8px;border:1.5px solid var(--border);
  background:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:10px;
  font-size:14px;font-weight:600;color:var(--text);transition:all .15s;box-shadow:var(--sh);
}
.google-btn:hover{border-color:var(--border-s);box-shadow:var(--shm);}
.google-btn:active{transform:scale(.98);}
.google-icon{width:20px;height:20px;flex-shrink:0;}
.lerr{color:var(--red);font-size:12px;margin-top:10px;text-align:center;min-height:17px;line-height:1.4;}
.lfooter{margin-top:14px;font-size:11px;color:rgba(255,255,255,.4);text-align:center;line-height:1.5;}

/* ════════════════════════════════════════
   HEADER
   ════════════════════════════════════════ */
header{
  background:var(--green);
  display:flex;align-items:center;justify-content:space-between;
  height:60px;min-height:60px;position:sticky;top:0;z-index:100;
  box-shadow:none;
  padding:0 20px;
  padding-left:max(20px, env(safe-area-inset-left));
  padding-right:max(20px, env(safe-area-inset-right));
  gap:16px;
}
.logo-area{display:flex;align-items:center;gap:10px;min-width:0;flex-shrink:0;}
.logo-badge{width:38px;height:38px;background:var(--yellow);border-radius:50%;display:flex;align-items:center;justify-content:center;font-family:'Barlow Condensed',sans-serif;font-weight:900;font-size:14px;color:var(--green);flex-shrink:0;}
.logo-text{min-width:0;}
.logo-text h1{font-family:'Barlow Condensed',sans-serif;font-weight:900;font-size:22px;text-transform:uppercase;letter-spacing:.4px;line-height:1.1;color:#fff;white-space:nowrap;}
.logo-text small{font-size:10px;color:rgba(255,255,255,.55);text-transform:uppercase;letter-spacing:1.5px;font-weight:600;display:block;}
.hright{display:flex;flex-direction:row;align-items:center;gap:6px;flex-shrink:0;flex-wrap:nowrap;}
.hrow{display:flex;align-items:center;gap:6px;}
.huser{display:flex;align-items:center;gap:8px;flex-shrink:0;}
.hnav{display:flex;align-items:center;gap:4px;}
.hnav-btn{background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.18);color:rgba(255,255,255,.9);padding:4px 12px;border-radius:5px;font-size:11px;cursor:pointer;transition:all .15s;font-weight:600;white-space:nowrap;font-family:'Barlow Condensed',sans-serif;text-transform:uppercase;letter-spacing:.5px;}
.hnav-btn:hover{background:rgba(255,255,255,.25);color:#fff;}
.user-pill{display:flex;align-items:center;gap:7px;background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.2);border-radius:20px;padding:3px 12px 3px 5px;cursor:pointer;transition:background .15s;}
.user-pill:hover{background:rgba(255,255,255,.22);}
.user-pill img{width:22px;height:22px;border-radius:50%;object-fit:cover;}
.user-pill-init{width:22px;height:22px;border-radius:50%;background:var(--yellow);display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:900;color:var(--green);font-family:'Barlow Condensed',sans-serif;flex-shrink:0;}
.user-pill span{font-size:12px;font-weight:600;color:#fff;white-space:nowrap;}
.uchip{display:flex;align-items:center;gap:6px;background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.2);border-radius:16px;padding:3px 10px 3px 4px;cursor:pointer;transition:background .15s;max-width:160px;}
.uchip:hover{background:rgba(255,255,255,.2);}
.uav{width:24px;height:24px;border-radius:50%;overflow:hidden;flex-shrink:0;background:var(--yellow);display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:900;color:var(--green);font-family:'Barlow Condensed',sans-serif;}
.uav img{width:100%;height:100%;object-fit:cover;}
.uname{font-size:12px;font-weight:600;color:#fff;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.lobtn{background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.2);color:rgba(255,255,255,.8);padding:5px 10px;border-radius:5px;font-size:11px;cursor:pointer;transition:all .15s;font-weight:600;white-space:nowrap;}
.lobtn:hover{background:rgba(255,255,255,.22);}

/* ════════════════════════════════════════
   DASHBOARD NAV BAR
   ════════════════════════════════════════ */
.dashboard-nav{
  position:sticky;top:102px;z-index:97;
  background:#fff;box-shadow:0 2px 6px rgba(0,0,0,.06);
}
/* Row 1: dashboard selector — equal width, centered vertically */
.dbar-row1{
  display:flex;align-items:stretch;
  border-bottom:1px solid var(--border);
  background:#f9fafb;
}
.dbar-row1 .dtab.dashboard-tab{
  flex:1;justify-content:center;
  min-height:44px;padding:10px 16px;
  border-bottom:3px solid transparent;
  font-size:13px;font-weight:900;
  letter-spacing:.6px;
}
/* Row 2: sub-tabs */
.dbar-row2{
  display:flex;align-items:stretch;
  border-bottom:2px solid var(--border);
  background:#fff;
}
/* Recruitment row: 7 tabs spread evenly */
.dbar-row2-recruit .dtab{flex:1;justify-content:center;padding:0 4px;min-width:0;}
.dbar-row2-sponsor .dtab{padding:0 18px;}
.dbar-row2:not(.dbar-row2-recruit):not(.dbar-row2-sponsor) .dtab{padding:0 18px;}
.dtab{
  min-height:38px;border:none;border-bottom:3px solid transparent;
  background:transparent;font-size:12px;font-weight:700;cursor:pointer;
  font-family:'Barlow Condensed',sans-serif;text-transform:uppercase;letter-spacing:.4px;
  color:var(--text-dim);white-space:nowrap;transition:all .15s;
  display:flex;align-items:center;gap:4px;
}
.dtab:hover{color:var(--text);background:var(--green-light);}
/* Row 1 (dashboard selector): keep green underline indicator */
.dtab.dashboard-tab.act{color:var(--green-dark,var(--green));background:#fff;border-bottom-color:var(--green);}
/* Row 2/3 (sub-tabs): no underline — use background tint instead */
.dtab.act{color:var(--green);border-bottom-color:transparent;background:var(--green-light);}
.dbar-row1 .dtab.act{background:#fff;border-bottom-color:var(--green);}
.dtab-icon{font-size:14px;line-height:1;flex-shrink:0;}
.dtab-lbl{font-size:11px;}
.fgl{display:block;font-size:11px;font-weight:700;color:var(--text-dim);margin-bottom:4px;text-transform:uppercase;letter-spacing:.4px;}
.fginput{width:100%;padding:8px 10px;border:1.5px solid var(--border);border-radius:7px;font-size:13px;font-family:inherit;box-sizing:border-box;background:#fff;}
.fginput:focus{outline:none;border-color:var(--green);}
textarea.fginput{resize:vertical;}
/* Hamburger menu */
.hamburger-btn{
  display:none;background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.2);
  color:#fff;width:34px;height:34px;border-radius:7px;font-size:18px;cursor:pointer;
  flex-shrink:0;align-items:center;justify-content:center;
}
.hamburger-menu{
  display:none;position:fixed;top:44px;right:8px;min-width:220px;max-width:280px;
  max-height:calc(100vh - 52px);overflow-y:auto;
  background:var(--card);border:1.5px solid var(--border);border-radius:10px;
  box-shadow:0 8px 24px rgba(0,0,0,.2);z-index:500;padding:6px;
  flex-direction:column;gap:2px;
}
.hamburger-menu.open{display:flex;flex-direction:column;}
.hmenu-item{
  width:100%;text-align:left;background:transparent;border:none;cursor:pointer;
  padding:10px 12px;border-radius:7px;font-size:13px;font-weight:600;color:var(--text);
  font-family:'Barlow',sans-serif;transition:background .12s;
}
.hmenu-item:hover{background:var(--green-light);}
.hmenu-danger{color:var(--red)!important;}
.hmenu-active{background:var(--green-light)!important;color:var(--green)!important;font-weight:700;}
.hmenu-divider{height:1px;background:var(--border);margin:4px 0;}
.hmenu-section-lbl{font-size:9px;font-weight:800;text-transform:uppercase;letter-spacing:1.2px;color:var(--text-dim);padding:8px 12px 2px;}
/* Desktop nav group */
.hnav-desktop{display:flex;align-items:center;gap:4px;flex-shrink:0;}
.hnav-sync{display:flex;align-items:center;gap:4px;flex-shrink:0;}
.hnav-signout{} /* always visible on desktop */

/* ════════════════════════════════════════
   SEASON BAR
   ════════════════════════════════════════ */
.sbar{
  background:var(--yellow);
  padding:7px max(16px,env(safe-area-inset-left)) 7px max(16px,env(safe-area-inset-left));
  display:flex;align-items:center;gap:8px;border-bottom:2px solid var(--yellow-dark);
  overflow-x:auto;scrollbar-width:none;
  position:sticky;top:60px;z-index:98;
}
.sbar::-webkit-scrollbar{display:none;}
.slabel{font-size:10px;font-weight:800;text-transform:uppercase;letter-spacing:1px;color:var(--green);opacity:.6;white-space:nowrap;flex-shrink:0;}
.stabs{display:flex;gap:3px;flex-shrink:0;}
.stab{padding:5px 12px;border-radius:4px;font-size:12px;font-weight:800;cursor:pointer;border:none;background:transparent;color:rgba(1,60,30,.5);transition:all .15s;font-family:'Barlow Condensed',sans-serif;letter-spacing:.5px;white-space:nowrap;}
.stab.act{background:var(--green);color:var(--yellow);}
.stab:hover:not(.act){background:rgba(1,60,30,.12);color:var(--green);}
.add-s-btn{padding:5px 10px;border-radius:4px;background:rgba(1,60,30,.12);border:1.5px solid rgba(1,60,30,.2);color:var(--green);font-size:10px;font-weight:800;cursor:pointer;transition:all .15s;font-family:'Barlow Condensed',sans-serif;text-transform:uppercase;white-space:nowrap;flex-shrink:0;}
.add-s-btn:hover{background:rgba(1,60,30,.22);}

/* ════════════════════════════════════════
   PAGE TABS (mobile: bottom nav)
   ════════════════════════════════════════ */
.ptabs-top{display:flex;gap:4px;margin-bottom:14px;overflow-x:auto;scrollbar-width:none;padding-bottom:2px;}
.ptabs-top::-webkit-scrollbar{display:none;}
.access-opt{display:flex;align-items:flex-start;gap:10px;padding:10px 12px;border:1.5px solid var(--border);border-radius:8px;cursor:pointer;transition:all .15s;width:100%;box-sizing:border-box;overflow:hidden;position:relative;}
.access-opt:has(input:checked){border-color:var(--green);background:var(--green-light);}
.access-opt input[type=radio]{position:absolute;opacity:0;width:0;height:0;}
/* Custom radio circle */
.access-opt-check{width:18px;height:18px;border-radius:50%;border:2px solid var(--border-s);background:#fff;flex-shrink:0;margin-top:2px;display:flex;align-items:center;justify-content:center;transition:all .15s;}
.access-opt:has(input:checked) .access-opt-check{border-color:var(--green);background:var(--green);}
.access-opt:has(input:checked) .access-opt-check::after{content:'✓';color:#fff;font-size:11px;font-weight:900;line-height:1;}
.access-opt-body{flex:1;min-width:0;overflow:hidden;}
.access-opt-title{font-weight:700;font-size:13px;color:var(--text);white-space:nowrap;}
.access-opt-desc{font-size:11px;color:var(--text-dim);margin-top:2px;line-height:1.4;word-wrap:break-word;}
.role-tag{display:flex;align-items:center;justify-content:space-between;padding:7px 10px;background:var(--bg);border:1.5px solid var(--border);border-radius:7px;font-size:13px;}
.role-tag-del{background:none;border:none;cursor:pointer;color:var(--text-dim);font-size:16px;line-height:1;padding:0 2px;}
.role-tag-del:hover{color:var(--red);}
.role-tag-default{font-size:10px;color:var(--text-dim);font-style:italic;}
.ptab-soon{opacity:.45;cursor:not-allowed!important;position:relative;}
.ptab-soon:hover{background:var(--card)!important;color:var(--text-dim)!important;border-color:var(--border)!important;}
.ptabs{padding:10px 16px;display:flex;gap:8px;border-top:1px solid var(--border);background:var(--card);}
.soon-badge{display:inline-block;font-size:8px;font-weight:800;background:var(--yellow);color:var(--green);border-radius:3px;padding:1px 4px;margin-left:5px;vertical-align:middle;text-transform:uppercase;letter-spacing:.5px;}
.ptab{padding:7px 14px;border-radius:6px;background:var(--card);color:var(--text-dim);border:1.5px solid var(--border);font-size:11px;font-weight:700;cursor:pointer;transition:all .15s;text-transform:uppercase;letter-spacing:.5px;white-space:nowrap;flex-shrink:0;}
.ptab.act{background:var(--green);color:#fff;border-color:var(--green);}

/* ════════════════════════════════════════
   MAIN CONTENT
   ════════════════════════════════════════ */
main{
  padding:16px max(16px,env(safe-area-inset-right)) calc(16px + var(--safe-bottom)) max(16px,env(safe-area-inset-left));
  max-width:1440px;
  margin:0 auto;
}
/* Recruitment content uses same layout as sponsorship — no override needed */
.sh{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;gap:10px;}
.stitle{font-family:'Barlow Condensed',sans-serif;font-weight:900;font-size:24px;text-transform:uppercase;letter-spacing:1px;color:var(--text);}
.stitle span{color:var(--green);}
.section-title{font-family:'Barlow Condensed',sans-serif;font-weight:900;font-size:20px;text-transform:uppercase;letter-spacing:1px;}

/* ════════════════════════════════════════
   SYNC STATUS BAR
   ════════════════════════════════════════ */
.sync-bar{display:flex;align-items:center;gap:8px;background:var(--card);border:1.5px solid var(--border);border-radius:8px;padding:8px 12px;margin-bottom:14px;font-size:12px;color:var(--text-dim);}
.sync-dot{width:8px;height:8px;border-radius:50%;background:var(--border-s);flex-shrink:0;}
.sync-dot.ok{background:var(--green-bright);}
.sync-dot.loading{background:var(--yellow-dark);animation:pulse 1s ease-in-out infinite;}
.sync-dot.err{background:var(--red);}
@keyframes pulse{0%,100%{opacity:1;}50%{opacity:.4;}}
.sync-refresh{padding:5px 11px;background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.2);color:rgba(255,255,255,.85);border-radius:5px;font-size:11px;font-weight:600;cursor:pointer;transition:all .15s;white-space:nowrap;}
.sync-refresh:hover{background:rgba(255,255,255,.25);color:#fff;}

/* ════════════════════════════════════════
   KPI CARDS
   ════════════════════════════════════════ */
.krow{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:14px;}
.kcard{background:var(--card);border:1.5px solid var(--border);border-radius:var(--r);padding:14px 16px;position:relative;overflow:hidden;box-shadow:var(--sh);cursor:pointer;transition:box-shadow .15s,transform .12s;-webkit-user-select:none;user-select:none;}
.kcard:hover{box-shadow:var(--shm);transform:translateY(-1px);}
.kcard:active{transform:scale(.98);}
.kcard::before{content:'';position:absolute;top:0;left:0;right:0;height:4px;}
.kcard.total::before{background:var(--yellow);}
.kcard.paid::before{background:var(--green);}
.kcard.out::before{background:var(--red);}
.kcard.cnt::before{background:var(--border-s);}
.kcard.cnt{cursor:default;}
.kcard.cnt:hover{box-shadow:var(--sh);transform:none;}
.kcard.cnt:active{transform:none;}
.klbl{font-size:9px;text-transform:uppercase;letter-spacing:1.5px;color:var(--text-dim);font-weight:700;margin-bottom:4px;}
.kval{font-family:'Barlow Condensed',sans-serif;font-size:28px;font-weight:900;line-height:1;}
.kcard.total .kval{color:var(--yellow-dark);}
.kcard.paid .kval{color:var(--green);}
.kcard.out .kval{color:var(--red);}
.ksub{font-size:10px;color:var(--text-dim);margin-top:3px;}
.klink{font-size:9px;color:var(--green);font-weight:700;margin-top:4px;text-decoration:underline;}
.ktrend{font-size:10px;font-weight:700;margin-top:3px;}
.ktrend.up{color:var(--green-bright);}
.ktrend.dn{color:var(--red);}
.pbtrack{height:4px;background:var(--bg);border-radius:3px;overflow:hidden;margin-top:7px;border:1px solid var(--border);}
.pbfill{height:100%;border-radius:3px;background:linear-gradient(90deg,var(--green),var(--green-bright));transition:width .8s;}

/* ════════════════════════════════════════
   DRILL PANEL
   ════════════════════════════════════════ */
.drill-panel{display:none;background:var(--card);border:1.5px solid var(--border);border-radius:var(--r);padding:16px;box-shadow:var(--sh);margin-bottom:14px;animation:slideDown .2s ease;}
.drill-panel.open{display:block;}
@keyframes slideDown{from{opacity:0;transform:translateY(-6px);}to{opacity:1;transform:translateY(0);}}
.drill-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;gap:10px;}
.drill-title{font-family:'Barlow Condensed',sans-serif;font-size:16px;font-weight:900;text-transform:uppercase;letter-spacing:.5px;line-height:1.2;}
.drill-close{background:var(--bg);border:1.5px solid var(--border);color:var(--text-dim);width:28px;height:28px;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:15px;flex-shrink:0;}

/* ════════════════════════════════════════
   PANELS & TWO-COL
   ════════════════════════════════════════ */
.panel{background:var(--card);border:1.5px solid var(--border);border-radius:var(--r);padding:16px;box-shadow:var(--sh);margin-bottom:14px;}
.twocol{display:grid;grid-template-columns:1fr;gap:14px;margin-bottom:14px;}
.ptitle{font-family:'Barlow Condensed',sans-serif;font-size:12px;font-weight:800;text-transform:uppercase;letter-spacing:1px;margin-bottom:12px;color:var(--text-dim);}
.ptitle span{color:var(--text);}

/* ════════════════════════════════════════
   YEAR BARS
   ════════════════════════════════════════ */
.ybargrp{margin-bottom:10px;cursor:pointer;}
.ybargrp:active .btrack{opacity:.8;}
.ybarlbl{display:flex;justify-content:space-between;font-size:11px;margin-bottom:3px;font-weight:600;}
.ybarlbl .yr{color:var(--text-dim);}
.btrack{height:22px;background:var(--bg);border-radius:4px;overflow:hidden;border:1px solid var(--border);}
.bfill{height:100%;border-radius:4px;transition:width .9s cubic-bezier(.4,0,.2,1);display:flex;align-items:center;padding-left:8px;font-size:10px;font-weight:700;}
.bfill.cur{background:var(--yellow);color:var(--green);}
.bfill.prev{background:var(--green);color:rgba(255,255,255,.85);}

/* ════════════════════════════════════════
   TIER LIST
   ════════════════════════════════════════ */
.tlist{display:flex;flex-direction:column;gap:6px;}
.trow{display:flex;align-items:center;gap:8px;padding:9px 10px;background:var(--bg);border-radius:6px;cursor:pointer;transition:all .15s;border:1.5px solid transparent;touch-action:pan-y;}
.trow:hover,.trow:active{background:var(--green-light);border-color:var(--border-s);}
.tdot{width:7px;height:7px;border-radius:50%;flex-shrink:0;}
.tdot.diamond{background:var(--td);}
.tdot.gold{background:var(--tg);}
.tdot.silver{background:var(--ts);}
.tdot.bronze{background:var(--tb);}
.tdot.community{background:var(--tc);}
.tdot.custom{background:#6d28d9;}
.tname{font-weight:700;font-size:13px;flex:1;}
.tcnt{font-size:11px;color:var(--text-dim);}
.tamt{font-family:'Barlow Condensed',sans-serif;font-weight:900;font-size:14px;}

/* ════════════════════════════════════════
   TABLE (mobile: card-style rows)
   ════════════════════════════════════════ */
.toolbar{display:flex;align-items:center;gap:6px;margin-bottom:10px;overflow-x:auto;scrollbar-width:none;padding-bottom:2px;}
.toolbar::-webkit-scrollbar{display:none;}
.fbtn{padding:5px 11px;border-radius:5px;background:var(--bg);color:var(--text-dim);border:1.5px solid var(--border);font-size:11px;font-weight:700;cursor:pointer;transition:all .15s;text-transform:uppercase;letter-spacing:.4px;white-space:nowrap;flex-shrink:0;}
.fbtn:hover,.fbtn.act{background:var(--green);color:#fff;border-color:var(--green);}
.abtn{margin-left:auto;padding:7px 14px;border-radius:6px;background:var(--yellow);color:var(--green);border:none;font-size:12px;font-weight:900;cursor:pointer;transition:all .15s;text-transform:uppercase;letter-spacing:.4px;font-family:'Barlow Condensed',sans-serif;box-shadow:var(--sh);white-space:nowrap;flex-shrink:0;}
.abtn:hover{background:var(--yellow-mid);}
.abtn:active{transform:scale(.97);}

/* Desktop table */
.stw{overflow-x:auto;-webkit-overflow-scrolling:touch;}
table{width:100%;border-collapse:collapse;font-size:13px;}
thead th{text-align:left;padding:8px 10px;font-size:9px;text-transform:uppercase;letter-spacing:1.2px;color:var(--text-dim);font-weight:700;border-bottom:2px solid var(--border);white-space:nowrap;}
th.sortable{cursor:pointer;user-select:none;}
th.sortable:hover{color:var(--text);background:var(--bg);}
th.sortable.sort-act{color:var(--green);}
.sort-arrow{font-size:10px;margin-left:2px;opacity:.5;}
th.sort-act .sort-arrow{opacity:1;color:var(--green);}
tbody tr{border-bottom:1px solid var(--border);cursor:pointer;transition:background .1s;}
tbody tr:hover{background:var(--green-light);}
td{padding:10px 10px;vertical-align:middle;}

/* Mobile sponsor cards */
.sponsor-cards{display:none;flex-direction:column;gap:8px;}
.scard{background:var(--card);border:1.5px solid var(--border);border-radius:9px;padding:14px;cursor:pointer;transition:all .15s;box-shadow:var(--sh);}
.scard:hover{border-color:var(--border-s);box-shadow:var(--shm);}
.scard:active{transform:scale(.99);}
.scard-top{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:8px;gap:8px;}
.scard-name{font-weight:700;font-size:15px;line-height:1.2;}
.scard-amount{font-family:'Barlow Condensed',sans-serif;font-weight:900;font-size:18px;color:var(--text);text-align:right;flex-shrink:0;}
.scard-recv{font-size:10px;color:var(--orange);text-align:right;}
.scard-meta{display:flex;align-items:center;gap:6px;flex-wrap:wrap;}
.scard-edit{margin-left:auto;padding:5px 10px;border-radius:5px;background:var(--bg);border:1.5px solid var(--border);color:var(--text-dim);font-size:11px;font-weight:700;cursor:pointer;}

/* Badges */
.sbadge{display:inline-block;padding:2px 7px;border-radius:20px;font-size:9px;font-weight:800;text-transform:uppercase;letter-spacing:.4px;}
.sbadge.paid{background:var(--green-light);color:var(--green);}
.sbadge.outstanding{background:var(--red-light);color:var(--red);}
.sbadge.partial{background:var(--orange-light);color:var(--orange);}
.sbadge.inkind{background:#f0e6ff;color:#6d28d9;}
.tchip{display:inline-flex;align-items:center;padding:2px 6px;border-radius:4px;font-size:10px;font-weight:700;}
.tchip.diamond{background:var(--tdb);color:var(--td);}
.tchip.gold{background:var(--tgb);color:var(--tg);}
.tchip.silver{background:var(--tsb);color:var(--ts);}
.tchip.bronze{background:var(--tbb);color:var(--tb);}
.tchip.community{background:var(--tcb);color:var(--tc);}
.tchip.custom{background:#f3e8ff;color:#6d28d9;}
.cbadge{display:inline-flex;align-items:center;gap:3px;background:var(--yellow-pale);border:1.5px solid var(--yellow-dark);color:var(--yellow-dark);font-size:9px;font-weight:800;padding:1px 6px;border-radius:10px;}
.actbtn{background:var(--bg);border:1.5px solid var(--border);color:var(--text);padding:3px 9px;border-radius:4px;font-size:11px;cursor:pointer;font-weight:700;transition:all .15s;}
.actbtn:hover{background:var(--green);color:#fff;border-color:var(--green);}

.empty{text-align:center;padding:40px 16px;color:var(--text-dim);}
.empty .icon{font-size:32px;margin-bottom:8px;}
.empty h3{font-size:14px;color:var(--text);margin-bottom:4px;}

/* ════════════════════════════════════════
   DETAIL VIEW
   ════════════════════════════════════════ */
.detailview{display:none;}
.detailview.open{display:block;}
.mainview.h{display:none;}
.backbtn{display:inline-flex;align-items:center;gap:6px;background:var(--green-light);border:1.5px solid var(--border-s);color:var(--green);font-size:12px;font-weight:700;cursor:pointer;margin-bottom:14px;padding:8px 13px;border-radius:6px;text-transform:uppercase;letter-spacing:.5px;}
.backbtn:active{transform:scale(.97);}
.dheader{display:flex;align-items:flex-start;gap:14px;margin-bottom:16px;flex-wrap:wrap;}
.dlogo{width:56px;height:56px;border-radius:8px;background:var(--yellow-pale);display:flex;align-items:center;justify-content:center;font-family:'Barlow Condensed',sans-serif;font-size:20px;font-weight:900;color:var(--yellow-dark);flex-shrink:0;border:2px solid var(--yellow-dark);}
.dinfo{flex:1;min-width:0;}
.dinfo h2{font-family:'Barlow Condensed',sans-serif;font-size:24px;font-weight:900;line-height:1;text-transform:uppercase;}
.dmeta{display:flex;gap:6px;margin-top:6px;flex-wrap:wrap;}
.dkpis{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:13px;}
.dkpi{background:var(--bg);border:1.5px solid var(--border);border-radius:8px;padding:12px 13px;}
.ystrip{display:flex;gap:5px;flex-wrap:wrap;margin-bottom:13px;}
.ypill{display:flex;align-items:center;gap:4px;background:var(--bg);border:1.5px solid var(--border);border-radius:4px;padding:4px 8px;font-size:10px;font-weight:700;color:var(--text-dim);}
.ypill.has{border-color:var(--green);color:var(--green);background:var(--green-light);}
.ydot{width:5px;height:5px;border-radius:50%;background:var(--border-s);}
.ypill.has .ydot{background:var(--green);}
.alog{background:var(--bg);border:1.5px solid var(--border);border-radius:8px;padding:14px;margin-bottom:13px;}
.alog h3{font-size:9px;text-transform:uppercase;letter-spacing:1.2px;color:var(--text-dim);margin-bottom:10px;font-weight:700;}
.aentry{display:flex;align-items:flex-start;gap:8px;padding:6px 0;border-bottom:1px solid var(--border);}
.aentry:last-child{border-bottom:none;}
.adot{width:7px;height:7px;border-radius:50%;flex-shrink:0;margin-top:4px;}
.adot.edit{background:var(--yellow-dark);}
.adot.del{background:var(--red);}
.adot.add{background:var(--green);}
.aact{font-size:12px;font-weight:600;line-height:1.4;}
.amet{font-size:10px;color:var(--text-dim);margin-top:1px;}
.aempty{font-size:12px;color:var(--text-dim);font-style:italic;}

/* ════════════════════════════════════════
   MODALS
   ════════════════════════════════════════ */
.moverlay{
  display:none;position:fixed;inset:0;z-index:200;
  background:rgba(0,0,0,.5);
  align-items:flex-end;justify-content:center;
  padding:0;
}
.moverlay.open{display:flex;}
.modal{
  background:var(--card);border:1.5px solid var(--border);
  border-radius:16px 16px 0 0;
  width:100%;max-width:100%;
  padding:20px 20px calc(20px + var(--safe-bottom));
  position:relative;max-height:92vh;overflow-y:auto;
  animation:slideUp .25s cubic-bezier(.4,0,.2,1);
}
@keyframes slideUp{from{transform:translateY(100%);}to{transform:translateY(0);}}
.modal-handle{width:36px;height:4px;background:var(--border-s);border-radius:2px;margin:0 auto 16px;display:block;}
.mclose{position:absolute;top:16px;right:16px;background:var(--bg);border:1px solid var(--border);color:var(--text);width:30px;height:30px;border-radius:50%;font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center;}
.mtitle{font-family:'Barlow Condensed',sans-serif;font-size:20px;font-weight:900;margin-bottom:2px;text-transform:uppercase;}
.msub{color:var(--text-dim);font-size:12px;margin-bottom:16px;line-height:1.4;}
.frow{display:grid;grid-template-columns:1fr;gap:10px;margin-bottom:10px;}
.frow.two{grid-template-columns:1fr 1fr;}
@media(max-width:520px){.frow.two{grid-template-columns:1fr;} .modal{padding:16px 14px 14px;}}
.frow.full{grid-template-columns:1fr;}
.fg{display:flex;flex-direction:column;gap:4px;}
.fg label{font-size:10px;text-transform:uppercase;letter-spacing:1px;color:var(--text-dim);font-weight:700;}
.fg input,.fg select,.fg textarea{background:#f7faf7;border:1.5px solid var(--border);color:var(--text);padding:11px 12px;border-radius:7px;font-size:15px;font-family:'Barlow',sans-serif;transition:border-color .15s;width:100%;-webkit-appearance:none;}
.fg input:focus,.fg select:focus,.fg textarea:focus{outline:none;border-color:var(--green);background:#fff;}
.fg textarea{resize:vertical;min-height:70px;}
.mactions{display:flex;gap:8px;margin-top:16px;flex-wrap:wrap;}
.mprimary{flex:1;padding:13px;background:var(--green);color:#fff;border:none;border-radius:8px;font-size:15px;font-weight:900;cursor:pointer;font-family:'Barlow Condensed',sans-serif;text-transform:uppercase;letter-spacing:.5px;min-width:120px;transition:opacity .15s;}
.mprimary:disabled{opacity:.6;cursor:not-allowed;}
.mprimary.btn-loading{position:relative;color:transparent !important;pointer-events:none;}
.mprimary.btn-loading::after{content:'';position:absolute;top:50%;left:50%;width:18px;height:18px;margin:-9px 0 0 -9px;border:2.5px solid rgba(255,255,255,.35);border-top-color:#fff;border-radius:50%;animation:spin .7s linear infinite;}
.mdanger.btn-loading{position:relative;color:transparent !important;pointer-events:none;opacity:.7;}
.mdanger.btn-loading::after{content:'';position:absolute;top:50%;left:50%;width:16px;height:16px;margin:-8px 0 0 -8px;border:2.5px solid rgba(180,0,0,.3);border-top-color:var(--red);border-radius:50%;animation:spin .7s linear infinite;}
.mprimary:active{transform:scale(.97);}
.msecondary{padding:13px 16px;background:var(--bg);color:var(--text-dim);border:1.5px solid var(--border);border-radius:8px;font-size:13px;cursor:pointer;font-weight:600;}
.mdanger{padding:13px 14px;background:var(--red-light);color:var(--red);border:1.5px solid #f5c6c2;border-radius:8px;font-size:13px;cursor:pointer;font-weight:700;}

/* Copy from prev */
.copy-prev-wrap{background:var(--green-light);border:1.5px solid var(--border-s);border-radius:8px;padding:11px 13px;margin-bottom:12px;}
.copy-prev-wrap label{font-size:10px;text-transform:uppercase;letter-spacing:1px;color:var(--green);font-weight:800;display:block;margin-bottom:6px;}
.copy-prev-row{display:flex;gap:8px;align-items:center;}
.copy-prev-row select{flex:1;background:#fff;border:1.5px solid var(--border-s);color:var(--text);padding:9px 10px;border-radius:6px;font-size:13px;font-family:'Barlow',sans-serif;-webkit-appearance:none;}
.cbtn{padding:9px 12px;background:var(--green);color:#fff;border:none;border-radius:6px;font-size:12px;font-weight:800;cursor:pointer;font-family:'Barlow Condensed',sans-serif;text-transform:uppercase;white-space:nowrap;}

/* Season mini modal */
.smodal-inner{background:var(--card);border-radius:14px;padding:24px;width:100%;max-width:360px;box-shadow:var(--shm);border:1.5px solid var(--border);margin:auto;}
#season-modal .moverlay-center{align-items:center;}

/* ════════════════════════════════════════
   ACCESS LOG
   ════════════════════════════════════════ */
.atable{width:100%;border-collapse:collapse;font-size:12px;}
.atable th{text-align:left;padding:8px 9px;font-size:9px;text-transform:uppercase;letter-spacing:1.2px;color:var(--text-dim);font-weight:700;border-bottom:2px solid var(--border);}
.atable td{padding:8px 9px;border-bottom:1px solid var(--border);}
.atable tr:last-child td{border-bottom:none;}

/* ════════════════════════════════════════
   USER MANAGEMENT
   ════════════════════════════════════════ */
.user-grid{display:grid;grid-template-columns:1fr;gap:10px;margin-bottom:14px;}
.ucard{background:var(--card);border:1.5px solid var(--border);border-radius:var(--r);padding:14px;box-shadow:var(--sh);}
.ucard-head{display:flex;align-items:center;gap:10px;margin-bottom:9px;}
.ucard-av{width:38px;height:38px;border-radius:50%;background:var(--green);display:flex;align-items:center;justify-content:center;font-family:'Barlow Condensed',sans-serif;font-weight:900;font-size:15px;color:var(--yellow);flex-shrink:0;overflow:hidden;}
.ucard-av img{width:100%;height:100%;object-fit:cover;}
.ucard-name{font-weight:700;font-size:14px;}
.ucard-role{font-size:11px;color:var(--text-dim);}
.ucard-badges{display:flex;gap:5px;margin-bottom:9px;flex-wrap:wrap;}
.ubadge{font-size:9px;font-weight:800;padding:2px 7px;border-radius:10px;text-transform:uppercase;letter-spacing:.4px;}
.ubadge.admin{background:var(--yellow-pale);color:var(--yellow-dark);border:1px solid var(--yellow-dark);}
.ubadge.edit{background:var(--green-light);color:var(--green);border:1px solid var(--border-s);}
.ubadge.view{background:var(--bg);color:var(--text-dim);border:1px solid var(--border);}
.ucard-actions{display:flex;gap:6px;flex-wrap:wrap;}
.uact-btn{padding:6px 10px;border-radius:5px;font-size:11px;font-weight:700;cursor:pointer;border:1.5px solid var(--border);background:var(--bg);color:var(--text-mid);transition:all .15s;}
.uact-btn:hover{background:var(--green);color:#fff;border-color:var(--green);}

/* Profile */
.profile-av-row{display:flex;align-items:center;gap:12px;margin-bottom:14px;}
.profile-av{width:52px;height:52px;border-radius:50%;background:var(--green);display:flex;align-items:center;justify-content:center;font-family:'Barlow Condensed',sans-serif;font-weight:900;font-size:20px;color:var(--yellow);overflow:hidden;}
.profile-av img{width:100%;height:100%;object-fit:cover;}
.profile-info strong{font-size:15px;display:block;}
.profile-info span{font-size:12px;color:var(--text-dim);}
.profile-badges{display:flex;gap:5px;margin-top:4px;flex-wrap:wrap;}
.profile-sec{margin-bottom:18px;padding-bottom:18px;border-bottom:1px solid var(--border);}
.profile-sec:last-child{border-bottom:none;margin-bottom:0;padding-bottom:0;}
.profile-sec h3{font-family:'Barlow Condensed',sans-serif;font-size:14px;font-weight:800;text-transform:uppercase;letter-spacing:.4px;color:var(--text);margin-bottom:11px;}
.msg-ok{background:var(--green-light);border:1px solid var(--border-s);color:var(--green);padding:7px 10px;border-radius:6px;font-size:12px;font-weight:600;margin-top:7px;display:none;}
.msg-err{background:var(--red-light);border:1px solid #f5c6c2;color:var(--red);padding:7px 10px;border-radius:6px;font-size:12px;font-weight:600;margin-top:7px;display:none;}

.chart-label{font-family:'Barlow Condensed',sans-serif;font-weight:900;font-size:11px;text-transform:uppercase;letter-spacing:.5px;color:var(--text-dim);margin-bottom:8px;}
.chart-wrap{position:relative;width:100%;height:160px;}
.chart-wrap-wide{height:130px;}
.chart-wrap canvas{position:absolute;inset:0;width:100%!important;height:100%!important;}

/* ════════════════════════════════════════
   TOAST
   ════════════════════════════════════════ */
.toast{
  position:fixed;bottom:calc(20px + var(--safe-bottom));left:50%;
  transform:translateX(-50%) translateY(80px);
  z-index:400;background:var(--green);color:#fff;
  padding:11px 20px;border-radius:24px;
  font-weight:800;font-size:13px;
  opacity:0;transition:all .3s;
  font-family:'Barlow Condensed',sans-serif;text-transform:uppercase;
  letter-spacing:.5px;box-shadow:var(--shm);white-space:nowrap;
}
.toast.show{transform:translateX(-50%) translateY(0);opacity:1;}
.toast.warn{background:var(--orange);}
.toast.err{background:var(--red);}

/* ════════════════════════════════════════
   RESPONSIVE — TABLET (600px+)
   ════════════════════════════════════════ */
@media(min-width:600px){
  main{padding:20px 24px;max-width:1200px;margin:0 auto;}
  header{height:60px;padding:0 24px;}
  .logo-text small{display:block;}
  .krow{grid-template-columns:repeat(4,1fr);}
  .kval{font-size:30px;}
  .stitle{font-size:26px;}
  .frow{grid-template-columns:1fr 1fr;}
  .frow.full{grid-template-columns:1fr;}
  .moverlay{align-items:center;padding:20px;}
  .modal{border-radius:14px;max-width:560px;animation:modalIn .2s ease;padding:24px;}
  @keyframes modalIn{from{opacity:0;transform:scale(.95);}to{opacity:1;transform:scale(1);}}
  .modal-handle{display:none;}
  .stw table{display:table;}
  .sponsor-cards{display:none!important;}
  .user-grid{grid-template-columns:repeat(auto-fill,minmax(260px,1fr));}
  .twocol{grid-template-columns:1fr 280px;}
}

/* ════════════════════════════════════════
   RESPONSIVE — DESKTOP (960px+)
   ════════════════════════════════════════ */
@media(min-width:960px){
  main{padding:22px 28px;max-width:1200px;margin:0 auto;}
  header{padding:0 28px;}
  .logo-text h1{font-size:17px;}
  .kval{font-size:33px;}
  .stitle{font-size:28px;}
  .twocol{grid-template-columns:1fr 295px;}
}

/* ════════════════════════════════════════
   MOBILE: hide table, show cards
   ════════════════════════════════════════ */
@media(max-width:599px){
  .stw table{display:none;}
  .sponsor-cards{display:flex;}
  .dkpis{grid-template-columns:1fr 1fr 1fr;}
  .dkpi{padding:10px 11px;}
  .dinfo h2{font-size:20px;}
}


/* ── Package manager rows ── */
.pkg-row{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;padding:14px;background:var(--bg);border:1.5px solid var(--border);border-radius:9px;}
input:disabled,select:disabled{background:var(--bg);color:var(--text-dim);cursor:not-allowed;opacity:.7;}
.emoji-pick{background:var(--bg);border:1.5px solid var(--border);border-radius:6px;cursor:pointer;font-size:18px;padding:3px 5px;line-height:1;transition:border-color .15s;}
.emoji-pick:hover{border-color:var(--green);background:var(--green-light);}


.ss-checklist{background:var(--bg);border:1.5px solid var(--border);border-radius:9px;padding:12px 14px;margin-bottom:10px;}
.ss-checklist-title{font-size:9px;text-transform:uppercase;letter-spacing:1.2px;color:var(--text-dim);font-weight:700;margin-bottom:10px;}
.ss-checks{display:grid;grid-template-columns:1fr 1fr;gap:8px;}
@media(max-width:420px){.ss-checks{grid-template-columns:1fr;}}
.ss-check{display:flex;align-items:center;gap:8px;cursor:pointer;font-size:13px;font-weight:500;color:var(--text-mid);user-select:none;}
.ss-check input{position:absolute;opacity:0;width:0;height:0;}
.ss-check-box{width:20px;height:20px;border-radius:5px;border:2px solid var(--border-s);background:#fff;flex-shrink:0;display:flex;align-items:center;justify-content:center;transition:all .15s;}
.ss-check input:checked ~ .ss-check-box{background:var(--green);border-color:var(--green);}
.ss-check input:checked ~ .ss-check-box::after{content:'✓';color:#fff;font-size:12px;font-weight:900;line-height:1;}
.ss-check:hover .ss-check-box{border-color:var(--green);}

/* ── Group modal custom checkboxes (Safari-safe, no accent-color) ── */
.gm-check{display:none;}
.gm-check-box{width:16px;height:16px;border-radius:4px;border:2px solid var(--border-s);background:#fff;flex-shrink:0;display:inline-flex;align-items:center;justify-content:center;transition:all .15s;cursor:pointer;}
.gm-check:checked ~ .gm-check-box{background:var(--green);border-color:var(--green);}
.gm-check:checked ~ .gm-check-box::after{content:'✓';color:#fff;font-size:10px;font-weight:900;line-height:1;}
.gm-check.purple:checked ~ .gm-check-box{background:#7c3aed;border-color:#7c3aed;}

/* ── Checklist badges on ss-row ── */
.chk-badge{display:inline-flex;align-items:center;gap:3px;font-size:9px;font-weight:700;padding:2px 6px;border-radius:10px;background:var(--green-light);color:var(--green);}
.chk-badge.miss{background:#fef2f2;color:#b91c1c;}


.ss-row{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:11px 14px;background:var(--bg);border:1.5px solid var(--border);border-radius:9px;cursor:pointer;transition:all .15s;}
.ss-row:hover{border-color:var(--green);background:var(--green-light);}
.ss-add-btn{background:var(--green);color:#fff;border:none;border-radius:7px;padding:7px 14px;font-size:12px;font-weight:700;cursor:pointer;font-family:'Barlow Condensed',sans-serif;text-transform:uppercase;letter-spacing:.5px;transition:opacity .15s;white-space:nowrap;flex-shrink:0;}
.ss-add-btn:hover{opacity:.85;}

/* ── NEW: Prospect / org status badges ── */
.ostatus{display:inline-block;padding:2px 8px;border-radius:20px;font-size:9px;font-weight:800;text-transform:uppercase;letter-spacing:.5px;}
.ostatus.active{background:var(--green-light);color:var(--green);}
.ostatus.prospect{background:#fef9e6;color:#b45309;}
.ostatus.lapsed{background:#f3f4f6;color:#6b7280;}

/* ── Contact log ── */
.clog-entry{display:flex;gap:10px;padding:10px 0;border-bottom:1px solid var(--border);}
.clog-entry:last-child{border-bottom:none;}
.clog-dot{width:8px;height:8px;border-radius:50%;background:var(--green);flex-shrink:0;margin-top:5px;}
.clog-body{flex:1;min-width:0;}
.clog-meta{font-size:10px;color:var(--text-dim);margin-bottom:2px;}
.clog-notes{font-size:13px;color:var(--text-mid);}

/* ── Address fields ── */
.addr-same-wrap{display:flex;align-items:center;gap:8px;margin-top:4px;}
.addr-same-wrap input[type=checkbox]{width:16px;height:16px;accent-color:var(--green);cursor:pointer;}
.addr-same-wrap label{font-size:12px;color:var(--text-dim);cursor:pointer;}

/* ── Two-panel layout for org detail ── */
.org-detail-wrap{display:flex;gap:16px;flex-wrap:wrap;}
.org-detail-main{flex:1;min-width:260px;}
.org-detail-side{width:280px;flex-shrink:0;}
@media(max-width:640px){.org-detail-side{width:100%;}}

/* ── Season pills on org card ── */
.season-pill{display:inline-flex;align-items:center;gap:5px;background:var(--bg);border:1.5px solid var(--border);border-radius:20px;padding:3px 10px;font-size:11px;cursor:pointer;transition:all .15s;}
.season-pill:hover{border-color:var(--green);background:var(--green-light);}
.season-pill .sp-tier{font-weight:800;}
.season-pill .sp-yr{color:var(--text-dim);}

/* ── Add season to org button ── */
.add-season-pill{display:inline-flex;align-items:center;gap:4px;background:var(--yellow-pale);border:1.5px dashed var(--yellow-dark);border-radius:20px;padding:3px 10px;font-size:11px;cursor:pointer;color:var(--yellow-dark);font-weight:700;transition:all .15s;}
.add-season-pill:hover{background:var(--yellow-mid);}

/* ── Tabs for sponsor view: Active | Prospects ── */
.view-tabs{display:flex;gap:6px;margin-bottom:14px;}
.vtab{padding:6px 14px;border-radius:20px;font-size:12px;font-weight:700;border:1.5px solid var(--border);background:var(--card);cursor:pointer;transition:all .15s;font-family:"Barlow Condensed",sans-serif;text-transform:uppercase;letter-spacing:.5px;}
.vtab.act{background:var(--green);color:#fff;border-color:var(--green);}
.vtab.prospect-tab.act{background:#b45309;border-color:#b45309;}


/* ── PLAYER MODULE ── */
.pl-tab{padding:10px 16px;background:transparent;border:none;border-bottom:3px solid transparent;font-size:12px;font-weight:700;cursor:pointer;font-family:'Barlow Condensed',sans-serif;text-transform:uppercase;letter-spacing:.5px;color:var(--text-dim);white-space:nowrap;transition:all .15s;}
.pl-tab:hover{color:var(--text);background:var(--green-light);}
.pl-tab.act{color:var(--green);border-bottom-color:var(--green);background:#fff;}
.pl-kpi-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:20px;}
@media(max-width:600px){
  .pl-kpi-grid{grid-template-columns:repeat(2,1fr) !important;}
  #overview-charts-grid{grid-template-columns:1fr !important;}
  #pl-body{padding:12px 0 !important;}
}
.pl-kpi{background:var(--card);border:1.5px solid var(--border);border-radius:11px;padding:14px 16px;}
.pl-kpi-label{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--text-dim);margin-bottom:4px;}
.pl-kpi-val{font-size:28px;font-weight:900;font-family:'Barlow Condensed',sans-serif;color:var(--green);}
.pl-kpi-sub{font-size:11px;color:var(--text-dim);margin-top:2px;}
.ag-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:10px;margin-bottom:20px;}
.ag-card{border-radius:10px;padding:14px;cursor:pointer;border:2px solid transparent;transition:all .15s;position:relative;}
.ag-card.green{background:#dcfce7;border-color:#16a34a;}
.ag-card.amber{background:#fef9c3;border-color:#ca8a04;}
.ag-card.red{background:#fee2e2;border-color:#dc2626;}
.ag-card.grey{background:var(--bg);border-color:var(--border);}
.ag-card:hover{transform:translateY(-1px);box-shadow:var(--shm);}
.ag-label{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--text-dim);}
.ag-count{font-size:32px;font-weight:900;font-family:'Barlow Condensed',sans-serif;line-height:1;}
.ag-bar-wrap{height:6px;background:rgba(0,0,0,.08);border-radius:3px;margin:8px 0 4px;}
.ag-bar-fill{height:100%;border-radius:3px;transition:width .4s;}
.ag-meta{font-size:10px;color:var(--text-dim);}
.ag-disp{position:absolute;top:6px;right:8px;font-size:9px;font-weight:700;color:#7c3aed;background:#ede9fe;border-radius:4px;padding:1px 5px;}
.pl-table{width:100%;border-collapse:collapse;font-size:13px;}
.pl-table th{text-align:left;font-size:9px;text-transform:uppercase;letter-spacing:1px;color:var(--text-dim);font-weight:700;padding:6px 8px;border-bottom:2px solid var(--border);}
.pl-table td{padding:9px 8px;border-bottom:1px solid var(--border);vertical-align:middle;}
.pl-table tbody tr{cursor:pointer;transition:background .12s;}
.pl-table tbody tr:hover{background:var(--green-light);}
.disp-tag{background:#ede9fe;color:#7c3aed;font-size:9px;font-weight:700;border-radius:4px;padding:1px 6px;text-transform:uppercase;letter-spacing:.3px;}
.pl-avatar{width:32px;height:32px;border-radius:50%;overflow:hidden;background:var(--green-light);display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:900;color:var(--green);font-family:'Barlow Condensed',sans-serif;flex-shrink:0;}
.pl-avatar img{width:100%;height:100%;object-fit:cover;}
.pl-search{width:100%;padding:9px 12px 9px 34px;border:1.5px solid var(--border);border-radius:8px;font-size:13px;background:var(--card) url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='14' height='14' viewBox='0 0 24 24' fill='none' stroke='%236b7a6b' stroke-width='2'%3E%3Ccircle cx='11' cy='11' r='8'/%3E%3Cpath d='m21 21-4.35-4.35'/%3E%3C/svg%3E") no-repeat 10px center;margin-bottom:12px;}
.pl-search:focus{outline:none;border-color:var(--green);}
.school-bar-row{display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--border);}
.import-drop{border:2px dashed var(--border);border-radius:12px;padding:32px;text-align:center;cursor:pointer;transition:all .2s;background:var(--bg);}
.import-drop.drag{border-color:var(--green);background:var(--green-light);}
.lapsed-row{display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:1px solid var(--border);}

/* ══════════════════════════════════════════
   HAMBURGER MENU
   ══════════════════════════════════════════ */
/* hamburger styles consolidated above */
/* dashboard tab labels - hidden on very small screens */
.dtab-lbl{display:inline;}

/* ── HEADER MOBILE ── */
@media(max-width:640px){
  /* ─ Header ─ keeps sticky so yellow+white bars can stack below it */
  header{padding:0 12px;gap:5px;height:44px !important;min-height:44px !important;max-height:44px !important;box-sizing:border-box;}
  .logo-text small{display:none;}
  .logo-badge{width:30px;height:30px;font-size:11px;}
  .logo-text h1{font-size:17px;}
  #user-name{display:none!important;}
  .user-pill{padding:2px 5px 2px 3px;}
  .desktop-only{display:none !important;}
  .hnav-sync{gap:3px;}
  .lobtn,.hnav-signout{display:none!important;} /* in hamburger */
  .hnav-desktop{display:none!important;} /* in hamburger */
  .hright{gap:4px;flex-wrap:nowrap;position:relative;}
  .hamburger-btn{display:flex;}
  /* ─ Yellow season bar ─ */
  .sbar{padding:4px 10px;top:44px !important;margin-top:0 !important;}
  .stab{padding:3px 10px;font-size:11px;}
  /* ─ Dashboard nav — hidden entirely on mobile, both rows in hamburger ─ */
  .dashboard-nav{display:none !important;}
  /* ─ Charts ─ */
  #overview-charts-grid{grid-template-columns:1fr !important;}
  #pl-body{padding:10px 0 !important;}
}
@media(max-width:420px){
  #dashboard-nav{top:78px;}
}
@media(max-width:380px){
  .logo-badge{width:26px;height:26px;font-size:10px;}
  .logo-text h1{font-size:15px;}
}
/* Table: hide contact column on mobile, allow horizontal scroll */
@media(max-width:600px){
  .stable-wrap{overflow-x:auto;-webkit-overflow-scrolling:touch;}
  .stable{min-width:480px;}
  .col-contact{display:none;}
}
.season-head{display:flex;align-items:center;margin-bottom:16px;gap:8px;flex-wrap:wrap;width:100%;}
.sadd{background:rgba(255,255,255,.15);border:1.5px solid rgba(255,255,255,.3);color:#fff;padding:5px 12px;border-radius:6px;font-size:11px;font-weight:700;cursor:pointer;white-space:nowrap;transition:all .15s;font-family:'Barlow Condensed',sans-serif;text-transform:uppercase;letter-spacing:.5px;}
.sadd:hover{background:rgba(255,255,255,.25);}
.kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:16px;}
@media(max-width:700px){.kpis{grid-template-columns:repeat(2,1fr);}}
.filters{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px;}
.ftab{padding:5px 12px;border-radius:20px;font-size:11px;font-weight:700;border:1.5px solid var(--border);background:var(--card);cursor:pointer;transition:all .15s;font-family:'Barlow Condensed',sans-serif;text-transform:uppercase;letter-spacing:.5px;white-space:nowrap;}
.ftab.act{background:var(--green);color:#fff;border-color:var(--green);}
.mid-row{display:flex;gap:16px;align-items:flex-start;margin-bottom:16px;}
.mid-left{flex:1;min-width:0;margin-bottom:0!important;}
.mid-right{width:260px;flex-shrink:0;margin-bottom:0!important;}
@media(max-width:800px){.mid-row{flex-direction:column;}.mid-right{width:100%;}.mid-left{width:100%;min-width:0;}}
.panel-title{font-family:'Barlow Condensed',sans-serif;font-size:14px;font-weight:800;text-transform:uppercase;letter-spacing:1px;color:var(--text);margin-bottom:10px;}
.side-panel{position:fixed;top:0;right:-420px;width:min(420px,100vw);height:100vh;background:var(--card);box-shadow:-4px 0 24px rgba(0,0,0,.13);z-index:200;transition:right .3s cubic-bezier(.4,0,.2,1),z-index 0s;display:flex;flex-direction:column;overflow:hidden;}
.side-panel.open{right:0;}
.spclose{position:absolute;top:14px;right:16px;background:var(--bg);border:1.5px solid var(--border);border-radius:50%;width:32px;height:32px;font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;z-index:1;}
.sp-title{font-family:'Barlow Condensed',sans-serif;font-size:16px;font-weight:800;text-transform:uppercase;padding:16px 48px 0 16px;letter-spacing:.5px;}
.stable{width:100%;border-collapse:collapse;font-size:13px;}
.stable th{text-align:left;font-size:9px;text-transform:uppercase;letter-spacing:1.2px;color:var(--text-dim);font-weight:700;padding:6px 8px;border-bottom:2px solid var(--border);}
.stable td{padding:10px 8px;border-bottom:1px solid var(--border);vertical-align:middle;}
.stable tr:last-child td{border-bottom:none;}
.stable tbody tr{cursor:pointer;transition:background .12s;}
.stable tbody tr:hover{background:var(--green-light);}

/* ── Admin modal tabs ── */
.adm-tabs{display:flex;gap:4px;padding-bottom:12px;border-bottom:1.5px solid var(--border);flex-wrap:wrap;}
.adm-tab{padding:6px 14px;border-radius:6px;font-size:12px;font-weight:700;border:1.5px solid var(--border);background:var(--bg);cursor:pointer;transition:all .15s;font-family:'Barlow Condensed',sans-serif;text-transform:uppercase;letter-spacing:.5px;color:var(--text-dim);}
.adm-tab.act{background:var(--green);color:#fff;border-color:var(--green);}
.adm-tab:hover:not(.act){border-color:var(--green);color:var(--green);}

</style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
</head>
<body>

<!-- LOADING SCREEN -->
<div id="loading-screen">
  <div class="ls-crest">KJFC</div>
  <div class="ls-text">Loading…</div>
  <div class="ls-bar"><div class="ls-bar-fill"></div></div>
</div>

<!-- LOGIN -->
<div id="login-view" style="display:none;min-height:100vh;display:none;align-items:center;justify-content:center;background:var(--green);">
  <div class="lbox" style="background:#fff;border-radius:18px;padding:36px 28px;width:100%;max-width:380px;margin:24px;box-shadow:0 12px 40px rgba(0,0,0,.18);">
    <div style="text-align:center;margin-bottom:28px;">
      <div style="width:64px;height:64px;background:var(--yellow);border-radius:50%;display:flex;align-items:center;justify-content:center;font-family:'Barlow Condensed',sans-serif;font-weight:900;font-size:22px;color:var(--green);margin:0 auto 14px;">KJFC</div>
      <h1 style="font-family:'Barlow Condensed',sans-serif;font-size:22px;font-weight:900;letter-spacing:.5px;text-transform:uppercase;">Executive Dashboard</h1>
      <p style="font-size:13px;color:var(--text-dim);margin-top:4px;">Kinglake Junior Football Club</p>
    </div>
    <!-- Sign in state -->
    <div id="login-signin-area">
      <div id="google-btn-container" style="margin-bottom:12px;"></div>
      <button id="google-sign-in-btn" style="width:100%;padding:12px;background:var(--green);color:#fff;border:none;border-radius:8px;font-size:14px;font-weight:700;cursor:pointer;font-family:'Barlow Condensed',sans-serif;text-transform:uppercase;letter-spacing:.5px;">Sign in with Google</button>
      <div id="lerr" style="color:var(--red);font-size:12px;text-align:center;margin-top:10px;min-height:16px;"></div>
    </div>
    <!-- Signing in... state (shown after Google auth completes) -->
    <div id="login-progress" style="display:none;text-align:center;padding:8px 0 4px;">
      <div style="width:36px;height:36px;border:3px solid var(--border);border-top-color:var(--green);border-radius:50%;animation:spin .8s linear infinite;margin:0 auto 14px;"></div>
      <div style="font-weight:700;font-size:15px;color:var(--text);margin-bottom:4px;">Signing in…</div>
      <div style="font-size:12px;color:var(--text-dim);">Verifying your Google account</div>
    </div>
  </div>
</div>

<!-- MAIN APP -->
<div id="app" style="display:none;">

  <!-- HEADER -->
  <header>
    <div class="logo-area">
      <div class="logo-badge">KJFC</div>
      <div class="logo-text">
        <h1>Kinglake JFC</h1>
        <small>Executive Dashboard <span style="opacity:.45;font-size:9px;letter-spacing:.5px;">v0.1.182</span></small>
      </div>
    </div>
    <div class="hright">
      <!-- User pill always visible -->
      <div class="user-pill" onclick="openEditMe()" title="My profile" style="flex-shrink:0;">
        <img id="user-pic" src="" style="display:none;">
        <div class="user-pill-init" id="user-init">?</div>
        <span id="user-name"></span>
      </div>
      <!-- Desktop nav items (admin tab in dashboard nav instead) -->
      <div id="header-nav-desktop" class="hnav-desktop"></div>
      <!-- Last loaded timestamp (quiet) + Sign Out -->
      <div class="hnav-sync">
        <button class="lobtn hnav-signout" onclick="doLogout()" id="signout-btn">Sign Out</button>
      </div>
      <!-- Hamburger (mobile only) -->
      <button id="hamburger-btn" class="hamburger-btn" onclick="toggleHamburger()" aria-label="Menu">☰</button>
    </div>

  </header>
  <!-- Hamburger dropdown panel — must be OUTSIDE header (fixed positioning inside sticky creates stacking context) -->
  <div id="hamburger-menu" class="hamburger-menu"></div>

  <!-- SEASON BAR -->
  <div class="sbar">
    <div id="season-tabs" class="stabs"></div>
    <button class="sadd" onclick="openSeasonModal()">+ Season</button>
  </div>

  <!-- DASHBOARD NAV: Row 1 = dashboard switcher, Row 2 = sub-tabs -->
  <div id="dashboard-nav" class="dashboard-nav">
    <!-- Row 1: Dashboard selector -->
    <div class="dbar-row1">
      <button class="dtab dashboard-tab" id="dash-tab-sponsors" onclick="switchDashboard('sponsors')">🏆 Sponsorship</button>
      <button class="dtab dashboard-tab" id="dash-tab-recruitment" onclick="switchDashboard('recruitment')" style="display:none;">🏉 Recruitment</button>
      <button class="dtab dashboard-tab" id="dash-tab-admin" onclick="switchDashboard('admin-panel')" style="display:none;">⚙️ Admin</button>
    </div>
    <!-- Row 2a: Sponsor sub-tabs -->
    <div class="dbar-row2 dbar-row2-sponsor" id="dash-sub-sponsors">
      <button class="dtab act" id="dsub-add-sponsor" onclick="openAddOrg()"><span class="dtab-icon">➕</span><span class="dtab-lbl">Add Sponsor</span></button>
      <button class="dtab" id="dsub-packages" onclick="openPackagesPanel()"><span class="dtab-icon">📦</span><span class="dtab-lbl" id="packages-lbl">Packages</span></button>
    </div>
    <!-- Row 2b: Recruitment sub-tabs -->
    <div class="dbar-row2 dbar-row2-recruit" id="dash-sub-recruitment" style="display:none;">
      <button class="dtab act" data-tab="overview"  onclick="switchPlTab(this,'overview')"><span class="dtab-icon">📊</span><span class="dtab-lbl">Overview</span></button>
      <button class="dtab"     data-tab="players"   onclick="switchPlTab(this,'players')"><span class="dtab-icon">👥</span><span class="dtab-lbl">Players</span></button>
      <button class="dtab"     data-tab="teams"     onclick="switchPlTab(this,'teams')"><span class="dtab-icon">🏉</span><span class="dtab-lbl">Teams</span></button>
      <button class="dtab"     data-tab="import"    onclick="switchPlTab(this,'import')" id="pl-tab-import"><span class="dtab-icon">📥</span><span class="dtab-lbl">Import</span></button>
    </div>
    <!-- Row 2c: Admin sub-tabs (admin only, desktop) -->
    <div class="dbar-row2 dbar-row2-sponsor" id="dash-sub-admin" style="display:none;">
      <button class="dtab act" data-admintab="users" onclick="switchAdminTab(this,'users')"><span class="dtab-icon">👤</span><span class="dtab-lbl">Manage Users</span></button>
      <button class="dtab" data-admintab="groups" onclick="switchAdminTab(this,'groups')"><span class="dtab-icon">🔐</span><span class="dtab-lbl">Access Groups</span></button>
      <button class="dtab" data-admintab="log" onclick="switchAdminTab(this,'log')"><span class="dtab-icon">📋</span><span class="dtab-lbl">Activity Log</span></button>
      <button class="dtab" data-admintab="about" onclick="switchAdminTab(this,'about')"><span class="dtab-icon">ℹ️</span><span class="dtab-lbl">About</span></button>
    </div>
  </div>

  <!-- MAIN -->
  <main id="main-wrap">
    <!-- SPONSORSHIP CONTENT -->
    <div id="sponsor-content" style="display:none;">
    <!-- ROW 1: Season title -->
    <div class="season-head">
      <h2 class="section-title" id="season-span">SPONSORSHIP</h2>
    </div>

    <!-- ROW 2: KPI CARDS (full width, 4 col) -->
    <div class="kpis">
      <div class="kcard" onclick="drillTotal()">
        <div class="klbl">Total Committed</div>
        <div class="kval" id="k-total" style="color:var(--yellow-dark)">$0</div>
        <div class="ksub" id="k-count">0 sponsors</div>
        <div class="ktrend" id="k-trend"></div>
        <div class="klink">View all →</div>
      </div>
      <div class="kcard" onclick="drillPaid()">
        <div class="klbl">Received</div>
        <div class="kval" id="k-paid" style="color:var(--green)">$0</div>
        <div class="ksub" id="k-ppct">0% collected</div>
        <div class="pbtrack"><div class="pbfill" id="k-bar" style="width:0%"></div></div>
        <div class="klink">Paid &amp; partial →</div>
      </div>
      <div class="kcard" onclick="drillOut()">
        <div class="klbl">Outstanding</div>
        <div class="kval" id="k-out" style="color:var(--red)">$0</div>
        <div class="ksub" id="k-outc">0 invoices pending</div>
        <div class="klink">View outstanding →</div>
      </div>
      <div class="kcard" style="cursor:default;">
        <div class="klbl">By Tier</div>
        <div id="tier-mini" style="display:flex;flex-direction:column;gap:5px;margin-top:7px;"></div>
      </div>
    </div>

    <!-- IN-KIND STRIP -->
    <div id="inkind-strip" onclick="drillInKind()" style="display:none;background:var(--card);border:1.5px solid #e9d5ff;border-radius:11px;padding:12px 16px;margin-bottom:16px;align-items:center;gap:12px;cursor:pointer;transition:background .15s;" onmouseenter="this.style.background='#f5f0ff'" onmouseleave="this.style.background='var(--card)'">
      <span style="font-size:18px;">🤝</span>
      <div style="flex:1">
        <div style="font-size:11px;font-weight:700;color:#6d28d9;text-transform:uppercase;letter-spacing:.5px;">In-Kind Sponsors</div>
        <div id="inkind-summary" style="font-size:13px;color:var(--text-mid);"></div>
      </div>
      <span style="font-size:11px;color:#6d28d9;font-weight:600;">View all →</span>
    </div>

    <!-- ROW 3: YOY left + Revenue by Tier right -->
    <div class="mid-row">
      <div class="mid-left panel">
        <div class="panel-title">Year-on-Year <span style="color:var(--green)">Comparison</span> <span style="font-size:10px;font-weight:400;color:var(--text-dim)">(tap to switch season)</span></div>
        <div id="year-bars" style="display:flex;flex-direction:column;gap:8px;margin-top:10px;"></div>
      </div>
      <div class="mid-right panel">
        <div class="panel-title">Revenue <span style="color:var(--green)">by Tier</span></div>
        <div class="tlist" id="tier-list"></div>
      </div>
    </div>

    <!-- ROW 4: Sponsor table — full width -->
    <div class="panel">
      <div class="view-tabs" id="view-tabs">
        <button class="vtab act" onclick="setView('active')" id="vtab-active">Active</button>
        <button class="vtab prospect-tab" onclick="setView('prospect')" id="vtab-prospect">Not in Season</button>
      </div>
      <div class="filters" id="filters" style="margin-bottom:8px;">
        <!-- dynamically rendered by renderFilterTabs() -->
      </div>
      <!-- Search -->
      <div style="margin-bottom:10px;">
        <input type="text" id="sponsor-search" placeholder="🔍  Search sponsors…" oninput="renderTable()" style="width:100%;box-sizing:border-box;padding:8px 12px;border:1.5px solid var(--border);border-radius:7px;font-size:13px;background:var(--bg);color:var(--text);outline:none;transition:border-color .15s;" onfocus="this.style.borderColor='var(--green)'" onblur="this.style.borderColor='var(--border)'">
      </div>
      <div class="stable-wrap">
      <table class="stable" id="stable">
        <thead id="stable-head"><tr>
          <th class="sortable" onclick="sortBy('name')" id="th-name">Sponsor <span class="sort-arrow" id="sa-name"></span></th>
          <th class="sortable" onclick="sortBy('tier')" id="th-tier">Tier <span class="sort-arrow" id="sa-tier"></span></th>
          <th class="sortable" onclick="sortBy('amount')" id="th-amount">Amount <span class="sort-arrow" id="sa-amount"></span></th>
          <th class="sortable" onclick="sortBy('status')" id="th-status">Status <span class="sort-arrow" id="sa-status"></span></th>
          <th class="sortable" onclick="sortBy('yrs')" id="th-yrs">Yrs <span class="sort-arrow" id="sa-yrs"></span></th>
          <th class="col-contact">Contact</th><th></th>
        </tr></thead>
        <tbody id="tbody"></tbody>
      </table>
      </div>
      <div id="tbl-empty" style="display:none;text-align:center;padding:24px;color:var(--text-dim);font-size:13px;">No sponsors for this season yet.</div>
      <div style="margin-top:10px;display:flex;justify-content:flex-end;">
        <button class="actbtn" onclick="exportCSV()" style="font-size:11px;padding:5px 10px;">Export CSV</button>
      </div>
    </div>

    <!-- ROW 5: Prospect pipeline (full width, shown only when prospects exist) -->
    <div class="panel" id="prospect-panel" style="display:none;">
      <div class="panel-title">🎯 Prospect Pipeline</div>
      <div id="prospect-list" style="margin-top:10px;"></div>
    </div>
    <!-- AI OVERVIEW CARD sponsors — bottom of page -->
    <div id="sponsor-ai-card" style="background:rgba(1,60,30,0.72);color:#fff;border-radius:12px;padding:18px 22px;margin-top:8px;position:relative;overflow:hidden;backdrop-filter:blur(2px);">
      <div style="position:absolute;top:0;right:0;width:200px;height:100%;background:linear-gradient(135deg,transparent 55%,rgba(251,226,1,.05));pointer-events:none;"></div>
      <div style="display:flex;align-items:flex-start;gap:12px;">
        <div style="flex-shrink:0;margin-top:2px;">
          <div style="background:var(--yellow);color:var(--green);border-radius:7px;padding:5px 9px;font-family:'Barlow Condensed',sans-serif;font-weight:900;font-size:10px;text-transform:uppercase;letter-spacing:.6px;white-space:nowrap;">AI Summary</div>
          <div id="sponsor-ai-season" style="font-size:9px;opacity:.5;margin-top:3px;text-align:center;font-weight:700;"></div>
          <div id="sponsor-ai-ts" style="font-size:9px;opacity:.5;margin-top:2px;text-align:center;"></div>
        </div>
        <div id="sponsor-ai-text" style="font-size:13px;line-height:1.65;flex:1;opacity:.95;"><span style="opacity:.4;font-size:12px;">Loading…</span></div>
      </div>
    </div>
    </div><!-- /sponsor-content -->

    <!-- RECRUITMENT CONTENT (inline, mirrors sponsorship layout) -->
    <div id="recruitment-content" style="display:none;">
      <!-- Section head mirrors .season-head in sponsorship -->
      <div class="season-head">
        <h2 class="section-title" id="pl-season-span">RECRUITMENT</h2>
      </div>
      <div id="pl-body" style="min-height:calc(100vh - 160px);padding-top:4px;"></div>
    </div>
    <div id="admin-panel-content" style="display:none;"></div>
  </main>



</div><!-- /app -->

<!-- GROUP EDIT MODAL -->
<div class="moverlay" id="group-modal">
  <div class="modal" style="max-width:560px;">
    <div class="modal-handle"></div>
    <button class="mclose" onclick="closeGroupModal()">×</button>
    <div class="mtitle" id="gm-title">New Group</div>
    <div id="gm-builtin-note" style="display:none;background:#fffbeb;border:1px solid #f59e0b;border-radius:8px;padding:9px 12px;margin-bottom:12px;font-size:12px;color:#92400e;line-height:1.5;">
      <strong>Built-in group</strong> — name is fixed but permissions can be customised. Changes apply to all users with this access level who haven't been assigned a custom group.
    </div>
    <div style="margin-bottom:6px;">
      <div class="fg" style="margin-bottom:12px;">
        <label>Group Name *</label>
        <input type="text" id="gm-name" placeholder="e.g. Developer, Coach, Committee Member…">
      </div>
      <div class="fg">
        <label style="margin-bottom:8px;display:block;">Dashboard Permissions</label>
        <div id="gm-perms" style="max-height:420px;overflow-y:auto;"></div>
      </div>
    </div>
    <div class="mactions">
      <button class="mprimary" id="gm-save" onclick="saveGroupModal()">Save Group</button>
      <button class="msecondary" onclick="closeGroupModal()">Cancel</button>
      <button class="mdanger" id="gm-del" style="display:none;" onclick="deleteGroupModal()">Delete Group</button>
    </div>
  </div>
</div>

<!-- ═══════════════ MODALS ═══════════════ -->

<!-- ORG MODAL (Add/Edit sponsor organisation) -->
<div class="moverlay" id="org-modal">
  <div class="modal" style="max-width:520px;">
    <div class="modal-handle"></div>
    <button class="mclose" id="org-mclose">×</button>
    <div class="mtitle" id="org-m-title">Add Sponsor</div>
    <div class="msub" id="org-m-sub">New sponsor organisation.</div>
    <div id="org-dup-warning" style="display:none;"></div>

    <div class="frow two">
      <div class="fg"><label>Business Name *</label><input type="text" id="of-name" placeholder="Business name" autocomplete="organization" oninput="_onOrgNameInput(this.value)"></div>
      <div class="fg"><label>Status</label>
        <select id="of-orgstatus">
          <option value="prospect">Prospect</option>
          <option value="active">Active Sponsor</option>
          <option value="lapsed">Lapsed</option>
        </select>
      </div>
    </div>

    <div class="frow two">
      <div class="fg"><label>Primary Contact Name</label><input type="text" id="of-contact" placeholder="Contact name" autocomplete="name"></div>
      <div class="fg"><label>Contact Email</label><input type="email" id="of-email" placeholder="email@biz.com.au" inputmode="email"></div>
    </div>
    <div class="frow two">
      <div class="fg"><label>Phone</label><input type="text" id="of-phone" placeholder="04xx xxx xxx" inputmode="tel" autocomplete="tel"></div>
      <div class="fg"><label>Website</label><input type="text" id="of-website" placeholder="www.example.com.au" inputmode="url"></div>
    </div>

    <div class="frow full">
      <div class="fg">
        <label>Physical Address</label>
        <input type="text" id="of-physaddr" placeholder="123 Main St, Kinglake VIC 3763" autocomplete="street-address">
      </div>
    </div>
    <div class="frow full">
      <div class="fg">
        <label>Postal Address</label>
        <label class="ss-check" style="margin-bottom:8px;" id="postsame-label">
          <input type="checkbox" id="of-postsame" onchange="togglePostalSame()">
          <span class="ss-check-box"></span>
          <span style="font-size:12px;color:var(--text-dim);">Same as physical address</span>
        </label>
        <input type="text" id="of-postaddr" placeholder="PO Box or postal address" autocomplete="off">
      </div>
    </div>

    <div class="frow full">
      <div class="fg"><label>Notes</label><textarea id="of-notes" placeholder="General notes about this organisation…"></textarea></div>
    </div>
    <div class="mactions">
      <button class="mprimary" id="org-m-save">Add Sponsor</button>
      <button class="msecondary" id="org-m-cancel">Cancel</button>
      <button class="mdanger" id="org-m-del" style="display:none">Delete</button>
    </div>
  </div>
</div>

<!-- SEASON ENTRY MODAL (add/edit a season sponsorship for an org) -->
<div class="moverlay" id="ss-modal">
  <div class="modal" style="max-width:500px;">
    <div class="modal-handle"></div>
    <button class="mclose" id="ss-mclose">×</button>
    <div class="mtitle" id="ss-m-title">Add Season Sponsorship</div>
    <div class="msub" id="ss-m-sub"></div>

    <!-- Row 1: Year + Package selector -->
    <div class="frow two">
      <div class="fg">
        <label>Season *</label>
        <select id="sf-year"></select>
      </div>
      <div class="fg">
        <label>Package *</label>
        <select id="sf-package" onchange="onPackageSelect()">
          <option value="">— Select package —</option>
        </select>
      </div>
    </div>

    <!-- Package details card (populated on select) -->
    <div id="sf-pkg-card" style="display:none;background:var(--green-light);border:1.5px solid var(--border-s);border-radius:9px;padding:10px 14px;margin-bottom:10px;font-size:12px;">
      <div style="font-weight:700;color:var(--green);margin-bottom:3px;" id="sf-pkg-card-name"></div>
      <div style="color:var(--text-dim);" id="sf-pkg-card-benefits"></div>
    </div>

    <!-- Custom package name (shown when "custom" selected) -->
    <div class="frow" id="sf-custom-wrap" style="display:none;">
      <div class="fg">
        <label>Custom Package Name *</label>
        <input type="text" id="sf-custom-name" placeholder="e.g. Naming Rights, Major Partner…">
      </div>
    </div>

    <!-- Row 2: Tier + Amount -->
    <div class="frow two">
      <div class="fg">
        <label>Tier</label>
        <select id="sf-tier">
          <option value="gold">🥇 Gold</option>
          <option value="silver">🥈 Silver</option>
          <option value="bronze">🥉 Bronze</option>
          <option value="community">🤝 Community</option>
          <option value="custom">⭐ Custom</option>
        </select>
      </div>
      <div class="fg" id="sf-amount-wrap">
        <label>Agreed Amount ($) *</label>
        <input type="number" id="sf-amount" placeholder="e.g. 1500" min="0" inputmode="numeric" oninput="updateBalance()">
      </div>
    </div>

    <!-- Row 3: Payment status -->
    <div class="frow two">
      <div class="fg">
        <label>Payment Status *</label>
        <select id="sf-status" onchange="updateSSFields()">
          <option value="">Select status</option>
          <option value="paid">✅ Paid in full</option>
          <option value="outstanding">⏳ Outstanding</option>
          <option value="partial">💛 Partial payment</option>
          <option value="inkind">🤝 In-Kind (no cash)</option>
        </select>
      </div>
      <div class="fg">
        <label>Invoice Number</label>
        <input type="text" id="sf-invoice" placeholder="e.g. INV-2026-001">
      </div>
    </div>

    <!-- Partial payment row -->
    <div class="frow two" id="sf-partial-wrap" style="display:none;">
      <div class="fg">
        <label>Amount Received ($)</label>
        <input type="number" id="sf-paid" placeholder="e.g. 500" min="0" inputmode="numeric" oninput="updateBalance()">
      </div>
      <div class="fg">
        <label>Balance Owing</label>
        <div id="sf-balance" style="padding:11px 12px;background:var(--orange-light);border:1.5px solid #f5c6a0;border-radius:7px;font-size:14px;font-weight:700;color:var(--orange);">—</div>
      </div>
    </div>

    <!-- In-kind description -->
    <div class="frow" id="sf-inkind-wrap" style="display:none;">
      <div class="fg">
        <label>What are they providing? *</label>
        <input type="text" id="sf-inkind-desc" placeholder="e.g. Printing services, catering for finals day…">
      </div>
    </div>

    <!-- Checklist -->
    <div class="ss-checklist">
      <div class="ss-checklist-title">Admin Checklist</div>
      <div class="ss-checks">
        <label class="ss-check"><input type="checkbox" id="chk-invoice"><span class="ss-check-box"></span>Invoice sent</label>
        <label class="ss-check"><input type="checkbox" id="chk-thankyou"><span class="ss-check-box"></span>Thank you email sent</label>
        <label class="ss-check"><input type="checkbox" id="chk-logo"><span class="ss-check-box"></span>Logo on website</label>
        <label class="ss-check"><input type="checkbox" id="chk-top"><span class="ss-check-box"></span>Added to training top</label>
      </div>
    </div>

    <!-- Notes -->
    <div class="frow">
      <div class="fg">
        <label>Notes</label>
        <textarea id="sf-notes" rows="2" placeholder="Any special arrangements, conditions, follow-ups…"></textarea>
      </div>
    </div>

    <div class="mactions">
      <button class="mprimary" id="ss-m-save">Add Sponsorship</button>
      <button class="msecondary" id="ss-m-cancel">Cancel</button>
      <button class="mdanger" id="ss-m-del" style="display:none">Remove Entry</button>
    </div>
  </div>
</div>

<!-- CONTACT LOG MODAL -->
<div class="moverlay" id="cl-modal">
  <div class="modal" style="max-width:400px;">
    <div class="modal-handle"></div>
    <button class="mclose" id="cl-mclose">×</button>
    <div class="mtitle">Log Contact</div>
    <div class="msub" id="cl-m-sub">Record an interaction with this sponsor.</div>
    <div class="frow full">
      <div class="fg"><label>Date</label><input type="date" id="clf-date"></div>
    </div>
    <div class="frow full">
      <div class="fg"><label>Notes *</label><textarea id="clf-notes" placeholder="What was discussed, next steps, outcome…" style="min-height:90px;"></textarea></div>
    </div>
    <div class="mactions">
      <button class="mprimary" id="cl-m-save">Log Contact</button>
      <button class="msecondary" id="cl-m-cancel">Cancel</button>
    </div>
  </div>
</div>

<!-- ORG DETAIL PANEL -->
<div class="moverlay" id="org-detail-overlay" style="align-items:flex-start;padding-top:20px;">
  <div class="modal" style="max-width:680px;max-height:90vh;overflow-y:auto;">
    <div class="modal-handle"></div>
    <button class="mclose" id="od-close">×</button>
    <div id="od-content"></div>
  </div>
</div>

<!-- DRILL DOWN PANEL -->
<div id="drillPanel" class="side-panel">
  <button class="spclose" onclick="closeDrill()">×</button>
  <div class="sp-title" id="drill-title"></div>
  <table class="stable" style="margin-top:10px;font-size:13px;">
    <thead><tr><th>Sponsor</th><th>Tier</th><th>Amount</th><th>Status</th></tr></thead>
    <tbody id="drill-tbody"></tbody>
  </table>
</div>

<!-- SEASON MODAL -->
<div class="moverlay" id="season-modal">
  <div class="smodal-inner">
    <div class="mtitle" style="margin-bottom:12px;">Add Season</div>
    <div class="fg"><label>Year</label><input type="number" id="new-season-yr" min="2020" max="2040" inputmode="numeric"></div>
    <div class="mactions" style="margin-top:14px;">
      <button class="mprimary" onclick="confirmAddSeason()">Add Season</button>
      <button class="msecondary" onclick="closeSeasonModal()">Cancel</button>
    </div>
  </div>
</div>

<!-- RESET MODAL -->
<div class="moverlay" id="reset-modal">
  <div class="smodal-inner">
    <div class="mtitle" style="margin-bottom:8px;">Sign out everywhere?</div>
    <p style="font-size:13px;color:var(--text-dim);margin-bottom:14px;">This will clear your session on this device.</p>
    <div class="mactions">
      <button class="mprimary" onclick="confirmLogout()">Sign Out</button>
      <button class="msecondary" onclick="closeResetModal()">Cancel</button>
    </div>
  </div>
</div>

<!-- USER / EDIT MODAL -->
<div class="moverlay" id="user-modal">
  <div class="modal" style="max-width:420px;">
    <div class="modal-handle"></div>
    <button class="mclose" onclick="closeUserModal()">×</button>
    <div class="mtitle" style="margin-bottom:4px;" id="um-title">Add User</div>
    <div style="margin-bottom:14px;">
      <div class="fg" style="margin-bottom:10px;">
        <label>Email Address *</label>
        <input type="email" id="um-email" placeholder="user@example.com" inputmode="email">
      </div>
      <div class="fg" style="margin-bottom:10px;"><label>Full Name</label><input type="text" id="um-name" placeholder="Full name"></div>
      <div class="fg" style="margin-bottom:10px;"><label>Role</label>
        <select id="um-role"></select>
      </div>
      <div class="fg" id="um-access-row" style="margin-bottom:10px;display:none;">
        <label>Access Level <span style="font-size:10px;color:var(--text-dim);font-weight:400;">(controls what they can save/change)</span></label>
        <select id="um-access">
          <option value="admin">Admin — Full write access</option>
          <option value="edit">Can Edit — Add/edit data on any visible dashboard</option>
          <option value="readonly">Read Only — View only, no changes</option>
        </select>
      </div>
      <div class="fg" id="um-group-row" style="margin-bottom:10px;display:none;">
        <label>Access Group <span style="font-size:10px;color:var(--text-dim);font-weight:400;">(controls which dashboards are visible)</span></label>
        <select id="um-group">
          <option value="">— Use Access Level default —</option>
        </select>
        <div style="font-size:10px;color:var(--text-dim);margin-top:4px;">Optional. Only needed if this person needs a different set of visible tabs to everyone else at their access level. Leave blank to use the built-in default.</div>
      </div>
      <div id="um-access-note" style="display:none;background:var(--bg);border:1.5px solid var(--border);border-radius:8px;padding:10px 12px;font-size:11px;color:var(--text-dim);line-height:1.6;">
        🔐 <strong style="color:var(--text);">Dashboard access</strong> is managed by an Admin.<br>
        Sign in is via Google — only Google accounts that have been added to the dashboard by an admin can access it. Contact your admin to change your access level.
      </div>
    </div>
    <div class="mactions">
      <button class="mprimary" onclick="confirmEditUser()">Save User</button>
      <button class="msecondary" onclick="closeUserModal()">Cancel</button>
      <button class="mdanger" id="um-del-btn" style="display:none" onclick="deleteUserConfirm()">Remove Access</button>
    </div>
  </div>
</div>

<!-- ROLES MODAL -->
<div class="moverlay" id="roles-modal">
  <div class="smodal-inner" style="max-width:360px;width:100%;">
    <div class="mtitle" style="margin-bottom:12px;">Manage Roles</div>
    <div id="roles-list" style="margin-bottom:14px;max-height:260px;overflow-y:auto;"></div>
    <div style="display:flex;gap:8px;">
      <input type="text" id="new-role-input" placeholder="New role name…" style="flex:1;padding:8px 10px;border:1.5px solid var(--border);border-radius:7px;font-size:13px;">
      <button class="mprimary" onclick="addCustomRole()" style="padding:8px 14px;">Add</button>
    </div>
    <div class="mactions" style="margin-top:12px;">
      <button class="msecondary" onclick="closeManageRoles()">Done</button>
    </div>
  </div>
</div>

<!-- PACKAGE MANAGER MODAL -->
<div class="moverlay" id="pkg-modal">
  <div class="modal" style="max-width:460px;">
    <div class="modal-handle"></div>
    <button class="mclose" onclick="closePkgModal()">×</button>
    <div class="mtitle" id="pkg-m-title">Add Package / Tier</div>

    <!-- Tier name + emoji -->
    <div class="frow two">
      <div class="fg">
        <label>Tier Name *</label>
        <select id="pf-tier" onchange="onPkgTierChange()">
          <option value="diamond">Diamond</option>
          <option value="gold">Gold</option>
          <option value="silver">Silver</option>
          <option value="bronze">Bronze</option>
          <option value="community">Community</option>
          <option value="custom">Custom</option>
        </select>
      </div>
      <div class="fg">
        <label>Emoji / Icon</label>
        <div style="display:flex;gap:6px;align-items:center;">
          <input type="text" id="pf-emoji" placeholder="💎" style="width:70px;font-size:22px;text-align:center;" maxlength="4">
          <div style="display:flex;flex-wrap:wrap;gap:4px;flex:1;">
            <button type="button" class="emoji-pick" onclick="document.getElementById('pf-emoji').value=this.textContent">💎</button>
            <button type="button" class="emoji-pick" onclick="document.getElementById('pf-emoji').value=this.textContent">🥇</button>
            <button type="button" class="emoji-pick" onclick="document.getElementById('pf-emoji').value=this.textContent">🥈</button>
            <button type="button" class="emoji-pick" onclick="document.getElementById('pf-emoji').value=this.textContent">🥉</button>
            <button type="button" class="emoji-pick" onclick="document.getElementById('pf-emoji').value=this.textContent">🤝</button>
            <button type="button" class="emoji-pick" onclick="document.getElementById('pf-emoji').value=this.textContent">⭐</button>
            <button type="button" class="emoji-pick" onclick="document.getElementById('pf-emoji').value=this.textContent">🏆</button>
            <button type="button" class="emoji-pick" onclick="document.getElementById('pf-emoji').value=this.textContent">🌟</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Amount + description -->
    <div class="frow two">
      <div class="fg">
        <label>Default Amount ($)</label>
        <input type="number" id="pf-amount" placeholder="e.g. 1500" min="0" inputmode="numeric">
      </div>
      <div class="fg">
        <label>Short Description</label>
        <input type="text" id="pf-desc" placeholder="e.g. Premium naming rights partner">
      </div>
    </div>

    <!-- Benefits -->
    <div class="frow">
      <div class="fg">
        <label>Benefits / Inclusions</label>
        <textarea id="pf-benefits" rows="3" placeholder="e.g. Logo on playing jersey, banner at ground, social media, website, training top…"></textarea>
      </div>
    </div>

    <div class="mactions">
      <button class="mprimary" id="pkg-m-save" onclick="savePkg()">Save Package</button>
      <button class="msecondary" onclick="closePkgModal()">Cancel</button>
      <button class="mdanger" id="pkg-m-del" style="display:none" onclick="deletePkg()">Delete</button>
    </div>
  </div>
</div>

<!-- PLAYER DETAIL MODAL -->
<div class="moverlay" id="player-detail-modal" style="align-items:flex-start;justify-content:center;padding:60px 20px 20px;overflow-y:auto;">
  <div style="background:var(--card);border-radius:14px;width:100%;max-width:580px;max-height:90vh;overflow-y:auto;display:flex;flex-direction:column;">
    <div style="padding:16px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px;position:sticky;top:0;background:var(--card);z-index:1;">
      <div id="pdm-avatar" style="width:48px;height:48px;border-radius:50%;overflow:hidden;flex-shrink:0;background:var(--green-light);display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:900;color:var(--green);font-family:'Barlow Condensed',sans-serif;"></div>
      <div style="flex:1;min-width:0;">
        <div id="pdm-name" style="font-weight:700;font-size:16px;"></div>
        <div id="pdm-meta" style="font-size:12px;color:var(--text-dim);"></div>
      </div>
      <button onclick="closePlayerDetail()" style="background:var(--bg);border:1.5px solid var(--border);border-radius:50%;width:30px;height:30px;font-size:16px;cursor:pointer;">×</button>
    </div>
    <div id="pdm-body" style="padding:20px;"></div>
    <div style="padding:12px 20px;border-top:1px solid var(--border);display:flex;gap:8px;justify-content:flex-end;">
      <button class="msecondary" onclick="closePlayerDetail()">Close</button>
      <button class="mprimary" id="pdm-save-btn" onclick="savePlayerDetail()" style="display:none">Save Changes</button>
    </div>
  </div>
</div>

<!-- TEAM MODAL (static — outside pl-body so position:fixed works correctly) -->
<div class="moverlay" id="team-modal-overlay" style="align-items:flex-start;justify-content:center;padding:60px 20px 20px;overflow-y:auto;">
  <div class="modal" style="border-radius:14px;width:100%;max-width:460px;padding:24px;max-height:none;">
    <div style="font-weight:800;font-size:16px;font-family:'Barlow Condensed',sans-serif;margin-bottom:16px;" id="team-modal-title">Add Team</div>
    <input type="hidden" id="tm-id">
    <div style="display:grid;gap:10px;">
      <div>
        <div style="font-size:11px;font-weight:700;color:var(--text-dim);margin-bottom:4px;">TEAM NAME *</div>
        <input id="tm-name" type="text" placeholder="e.g. U12 Boys Blue" style="width:100%;padding:8px 10px;border:1.5px solid var(--border);border-radius:7px;font-size:13px;">
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
        <div>
          <div style="font-size:11px;font-weight:700;color:var(--text-dim);margin-bottom:4px;">AGE GROUP</div>
          <select id="tm-age" style="width:100%;padding:8px 10px;border:1.5px solid var(--border);border-radius:7px;font-size:13px;">
            <option value="">—</option>
            <option value="U9">U9</option>
            <option value="U10">U10</option>
            <option value="U11">U11</option>
            <option value="U12">U12</option>
            <option value="U13">U13</option>
            <option value="U14">U14</option>
            <option value="U15">U15</option>
            <option value="U16">U16</option>
            <option value="U17">U17</option>
          </select>
        </div>
        <div>
          <div style="font-size:11px;font-weight:700;color:var(--text-dim);margin-bottom:4px;">GENDER</div>
          <select id="tm-gender" style="width:100%;padding:8px 10px;border:1.5px solid var(--border);border-radius:7px;font-size:13px;">
            <option value="">—</option>
            <option value="Mixed">Mixed</option>
            <option value="Male">Male</option>
            <option value="Female">Female</option>
          </select>
        </div>
      </div>
      <div>
        <div style="font-size:11px;font-weight:700;color:var(--text-dim);margin-bottom:4px;">COACH</div>
        <input id="tm-coach" type="text" placeholder="Coach name" style="width:100%;padding:8px 10px;border:1.5px solid var(--border);border-radius:7px;font-size:13px;">
      </div>
      <div>
        <div style="font-size:11px;font-weight:700;color:var(--text-dim);margin-bottom:4px;">ASSISTANT COACH</div>
        <input id="tm-acoach" type="text" placeholder="Assistant coach name" style="width:100%;padding:8px 10px;border:1.5px solid var(--border);border-radius:7px;font-size:13px;">
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
        <div>
          <div style="font-size:11px;font-weight:700;color:var(--text-dim);margin-bottom:4px;">MINIMUM PLAYERS</div>
          <input id="tm-min" type="number" min="1" max="50" placeholder="e.g. 14" style="width:100%;padding:8px 10px;border:1.5px solid var(--border);border-radius:7px;font-size:13px;">
        </div>
        <div>
          <div style="font-size:11px;font-weight:700;color:var(--text-dim);margin-bottom:4px;">CLUB ESTIMATE</div>
          <input id="tm-estimate" type="number" min="0" max="200" placeholder="e.g. 16" style="width:100%;padding:8px 10px;border:1.5px solid var(--border);border-radius:7px;font-size:13px;">
        </div>
      </div>
      <div style="font-size:11px;color:var(--text-dim);line-height:1.5;background:var(--bg);border-radius:7px;padding:8px 10px;margin-top:-4px;">
        💡 <strong>Club Estimate</strong> — your best guess at total likely players before all registrations are in, based on training attendance and expressions of interest. Must be greater than current registered count. Does not affect registered numbers.
      </div>
      <div>
        <div style="font-size:11px;font-weight:700;color:var(--text-dim);margin-bottom:4px;">NOTES</div>
        <textarea id="tm-notes" rows="2" style="width:100%;padding:8px 10px;border:1.5px solid var(--border);border-radius:7px;font-size:13px;resize:vertical;"></textarea>
      </div>
      <details style="border:1.5px solid var(--border);border-radius:8px;overflow:hidden;">
        <summary style="cursor:pointer;padding:8px 12px;background:var(--bg);font-size:11px;font-weight:700;color:var(--text-dim);text-transform:uppercase;letter-spacing:.5px;list-style:none;display:flex;align-items:center;gap:6px;">
          <span>📋</span> Optional: Estimated Players List
          <span style="font-size:10px;font-weight:400;text-transform:none;letter-spacing:0;color:#9ca3af;margin-left:auto;">for record keeping only</span>
        </summary>
        <div style="padding:10px 12px;background:#fff;">
          <div style="font-size:11px;color:var(--text-dim);line-height:1.5;margin-bottom:8px;">
            Names of players expected — from training attendance, expressions of interest, or parent enquiries. One name per line. <strong>This list is for your reference only and does not change any numbers above.</strong>
          </div>
          <textarea id="tm-estimate-names" rows="5" placeholder="e.g.&#10;Alex Smith&#10;Jordan Lee&#10;Sam Brown&#10;Riley Jones" style="width:100%;padding:8px 10px;border:1.5px solid var(--border);border-radius:7px;font-size:12px;resize:vertical;background:var(--bg);"></textarea>
        </div>
      </details>
    </div>
    <div style="display:flex;gap:8px;margin-top:16px;">
      <button class="msecondary" onclick="closeTeamModal()" style="flex:1;">Cancel</button>
      <button class="mprimary" onclick="saveTeamModal()" style="flex:2;">Save Team</button>
    </div>
  </div>
</div>

<!-- PLAYER SLIDEOVER (read-only, from right) -->
<div id="player-slideover-overlay" onclick="closePlayerSlideover()" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.35);z-index:3500;"></div>
<div id="player-slideover" style="position:fixed;top:0;right:0;height:100vh;width:380px;max-width:95vw;background:var(--card);z-index:3501;box-shadow:-4px 0 30px rgba(0,0,0,.18);transform:translateX(100%);transition:transform .25s cubic-bezier(.4,0,.2,1);display:flex;flex-direction:column;">
  <div style="padding:16px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px;">
    <div id="pso-avatar" style="width:44px;height:44px;border-radius:50%;background:var(--green-light);display:flex;align-items:center;justify-content:center;font-size:17px;font-weight:900;color:var(--green);font-family:'Barlow Condensed',sans-serif;flex-shrink:0;"></div>
    <div style="flex:1;min-width:0;">
      <div id="pso-name" style="font-weight:700;font-size:15px;"></div>
      <div id="pso-meta" style="font-size:11px;color:var(--text-dim);margin-top:1px;"></div>
    </div>
    <button onclick="closePlayerSlideover()" style="background:var(--bg);border:1.5px solid var(--border);border-radius:50%;width:28px;height:28px;font-size:16px;cursor:pointer;flex-shrink:0;">×</button>
  </div>
  <div id="pso-body" style="flex:1;overflow-y:auto;padding:16px 20px;"></div>
  <div id="pso-footer" style="padding:12px 20px;border-top:1px solid var(--border);display:none;">
    <button class="mprimary" style="width:100%;" onclick="openPlayerDetailFromSlideover(_psoSinglePid)">Open Full Profile</button>
  </div>
</div>

<!-- PLANNING SLIDEOVER -->


<!-- ADMIN MODAL -->
<div class="moverlay" id="admin-modal">
  <div class="modal" style="max-width:680px;max-height:85vh;display:flex;flex-direction:column;">
    <div class="modal-handle"></div>
    <button class="mclose" onclick="closeAdminModal()">×</button>
    <div class="adm-tabs">
      <button class="adm-tab" data-tab="log" onclick="document.querySelectorAll('.adm-tab').forEach(b=>b.classList.toggle('act',b===this));loadAdminTab('log')">Access Log</button>
      <button class="adm-tab" data-tab="users" onclick="document.querySelectorAll('.adm-tab').forEach(b=>b.classList.toggle('act',b===this));loadAdminTab('users')">Users</button>
      <button class="adm-tab" data-tab="packages" onclick="document.querySelectorAll('.adm-tab').forEach(b=>b.classList.toggle('act',b===this));loadAdminTab('packages')">📦 Packages</button>
    </div>
    <div id="adm-body" style="flex:1;overflow-y:auto;padding:16px 0 4px;"></div>
  </div>
</div>

<div id="toast" class="toast"></div>

<script src="https://accounts.google.com/gsi/client" async defer></script>
<script>
// ── NAME UTILITIES ───────────────────────────────────────────────────────────
// Title-case a name: normalises ALL CAPS / all-lowercase from PlayHQ exports
// e.g. "JOHN SMITH-O'BRIEN" → "John Smith-O'Brien", "mcgregor" → "McGregor"
function toTitleCase(str) {
  if (!str) return str;
  return str.replace(/[^\s\-]+/g, function(word) {
    if (/^[Mm][Cc][A-Za-z]/.test(word)) {
      return word[0].toUpperCase() + word[1].toLowerCase() +
             word[2].toUpperCase() + word.slice(3).toLowerCase();
    }
    return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
  });
}

// ════════════════════════════════════════════════════════
//  CONFIG
// ════════════════════════════════════════════════════════
const GOOGLE_CLIENT_ID = '127701976947-881utr0ljs1eqrfmuoqrsbqh5635vtfl.apps.googleusercontent.com';
const APPS_SCRIPT_URL  = 'https://script.google.com/macros/s/AKfycbzcIR3bT9TUyq-3fRNrS5CfG9ul2ZfRl_HIppOFbqpxtj5mMaJ5aZC3_bw7VKEDoTU/exec';

// ════════════════════════════════════════════════════════
//  STATE
// ════════════════════════════════════════════════════════
let me           = null;
let token        = null;
let orgs         = [];      // SponsorOrgs — one per company
let seasonEntries = [];     // SponsorSeasons — org × year
let years        = [];      // available year list
let packages     = [];      // SponsorPackages — standard packages
let activeSeason = null;
let curFilter    = 'all';
let curView      = 'active';
let curSort      = { col: 'tier', dir: 1 }; // col, dir: 1=asc, -1=desc
let editOrgId    = null;
let editSSId     = null;
let editSSOrg    = null;

// ── DYNAMIC Z-INDEX ──────────────────────────────────────────────────
// Every modal/panel calls bringToFront(el) on open — last opened is always on top
let _zTop = 500;
function bringToFront(el) {
  if (!el) return;
  _zTop += 10;
  el.style.zIndex = _zTop;
}

// Base tier config — extended dynamically from packages
const TIER_ORDER_BASE = {diamond:0,gold:1,silver:2,bronze:3,community:4,custom:5};
const TIER_COLOR = {diamond:'var(--td)',gold:'var(--tg)',silver:'var(--ts)',bronze:'var(--tb)',community:'var(--tc)',custom:'#6d28d9'};
const TIER_LABEL_BASE = {diamond:'Diamond',gold:'Gold',silver:'Silver',bronze:'Bronze',community:'Community',custom:'Custom'};
const TIER_EMOJI_BASE = {diamond:'💎',gold:'🥇',silver:'🥈',bronze:'🥉',community:'🤝',custom:'⭐'};

// Dynamic lookups — updated when packages load
let TO = {...TIER_ORDER_BASE};
let TH = {...TIER_COLOR};
let TL = {...TIER_LABEL_BASE};
let TE = {...TIER_EMOJI_BASE}; // emoji per tier

function rebuildTierLookups() {
  TO = {...TIER_ORDER_BASE};
  TH = {...TIER_COLOR};
  TL = {...TIER_LABEL_BASE};
  TE = {...TIER_EMOJI_BASE};
  packages.forEach(function(p) {
    if (p.tier) {
      TL[p.tier] = cap(p.tier); // tier name = tier key capitalised
      if (p.emoji) TE[p.tier] = p.emoji;
    }
  });
}

// ════════════════════════════════════════════════════════
//  COMPUTED HELPERS
// ════════════════════════════════════════════════════════
// Get season entries for a given year
function ssForYear(year) {
  return seasonEntries.filter(s => +s.year === +year);
}
// Get season entries for an org
function ssForOrg(orgId) {
  return seasonEntries.filter(s => s.orgId === orgId);
}
// Get all orgs that have a season entry for the active year
function activeOrgIds(year) {
  return new Set(ssForYear(year).map(s => s.orgId));
}
// Total number of seasons an org has sponsored
function consecYears(orgId) { return ssForOrg(orgId).length; }

// Sliding colour scale for years of sponsorship
function yrsBadge(n) {
  if (n <= 0) return '';
  if (n === 1) return '<span style="color:var(--text-dim);font-size:11px;font-weight:600">New</span>';
  // Scale: 2=light green → 3=green → 4=teal → 5=blue → 6+=gold/amber
  const scales = [
    null,                                          // 0 (unused)
    null,                                          // 1 = New (handled above)
    {bg:'#e8f5e9',border:'#a5d6a7',col:'#2e7d32'}, // 2
    {bg:'#c8e6c9',border:'#66bb6a',col:'#1b5e20'}, // 3
    {bg:'#b2dfdb',border:'#4db6ac',col:'#004d40'}, // 4
    {bg:'#bbdefb',border:'#64b5f6',col:'#0d47a1'}, // 5
    {bg:'#fffde7',border:'#fdd835',col:'#f57f17'}, // 6
    {bg:'#fff3e0',border:'#ffa726',col:'#e65100'}, // 7+
  ];
  const s = scales[Math.min(n, scales.length-1)];
  const star = n >= 5 ? '★ ' : '';
  return `<span style="display:inline-flex;align-items:center;gap:2px;background:${s.bg};border:1.5px solid ${s.border};color:${s.col};font-size:9px;font-weight:800;padding:2px 7px;border-radius:10px;white-space:nowrap;">${star}${n} yr${n!==1?'s':''}</span>`;
}

// ════════════════════════════════════════════════════════
//  SESSION
// ════════════════════════════════════════════════════════
function saveSession(t, user) { localStorage.setItem('kjfc_token',t); localStorage.setItem('kjfc_user',JSON.stringify(user)); }
function loadSession() {
  token=localStorage.getItem('kjfc_token');
  try{me=JSON.parse(localStorage.getItem('kjfc_user'));}catch{me=null;}
  try{const d=localStorage.getItem('kjfc_dashboard'); if(d) _currentDashboard=d;}catch(e){}
}
function clearSession() { localStorage.removeItem('kjfc_token'); localStorage.removeItem('kjfc_user'); token=null; me=null; }

// ════════════════════════════════════════════════════════
//  API
// ════════════════════════════════════════════════════════
async function api(action, body = {}) {
  return new Promise((resolve) => {
    const cbName = '_kjfc_cb_' + Date.now() + '_' + Math.floor(Math.random()*1e6);
    const params = new URLSearchParams({ action, callback: cbName });
    if (token) params.set('token', token);
    if (action === 'exchangeCode')       params.set('code', body.code || '');
    else if (action === 'getAudit')      params.set('id', body.id || '');
    else if (action === 'getContactLog') params.set('orgId', body.orgId || '');
    else if (Object.keys(body).length > 0) params.set('payload', encodeURIComponent(JSON.stringify(body)));
    const timer = setTimeout(() => { cleanup(); resolve({ error: 'Request timed out' }); }, 30000);
    function cleanup() { clearTimeout(timer); delete window[cbName]; const el=document.getElementById(cbName); if(el) el.remove(); }
    window[cbName] = (data) => {
      cleanup();
      // Force sign out if server returns an auth/permission error while already logged in
      // Excludes exchangeCode (login attempt) — those errors should show on the login screen
      if (action !== 'exchangeCode' && data && data.error && (
        data.error.toLowerCase().includes('unauthori') ||
        data.error.toLowerCase().includes('not authorised') ||
        data.error.toLowerCase().includes('invalid token') ||
        data.error.toLowerCase().includes('token expired') ||
        data.error.toLowerCase().includes('no token') ||
        data.error.toLowerCase().includes('access denied')
      )) {
        clearSession();
        sessionStorage.clear();
        if (window.google) google.accounts.id.disableAutoSelect();
        location.reload();
        return;
      }
      resolve(data);
    };
    const script = document.createElement('script');
    script.id = cbName;
    script.src = APPS_SCRIPT_URL + '?' + params.toString();
    script.onerror = () => { cleanup(); resolve({ error: 'Script load failed' }); };
    document.head.appendChild(script);
  });
}

// Like api() but splits a large patches array into URL-safe batches and
// merges the results — keeps everything within JSONP GET URL limits.
// Matches the chunked-upload pattern used by the CSV importer.
async function apiBatched(action, body, batchSize) {
  const patches = body.patches || [];
  if (!patches.length) return api(action, body);
  const results = { ok: true, patched: 0, notFound: 0 };
  for (let i = 0; i < patches.length; i += batchSize) {
    const batch = patches.slice(i, i + batchSize);
    const res   = await api(action, Object.assign({}, body, { patches: batch }));
    if (res.error) return res; // abort on first error
    results.patched   += res.patched   || 0;
    results.notFound  += res.notFound  || 0;
  }
  return results;
}



// ════════════════════════════════════════════════════════
//  GOOGLE SIGN-IN
// ════════════════════════════════════════════════════════
function initGoogleSignIn() {
  if (!window.google) { setTimeout(initGoogleSignIn, 300); return; }
  google.accounts.id.initialize({ client_id: GOOGLE_CLIENT_ID, callback: handleGoogleCredential, auto_select: false, cancel_on_tap_outside: true });
  function renderGoogleBtn() {
    const container = document.getElementById('google-btn-container'); if (!container) return;
    container.innerHTML = '';
    const lbox = document.querySelector('.lbox');
    const w = Math.min((lbox ? lbox.offsetWidth - 48 : 0) || 300, 360);
    google.accounts.id.renderButton(container, { theme:'outline', size:'large', width:w, text:'continue_with', shape:'rectangular' });
  }
  setTimeout(renderGoogleBtn, 100);
  window.addEventListener('resize', () => setTimeout(renderGoogleBtn, 100));
  document.getElementById('google-sign-in-btn').addEventListener('click', () => google.accounts.id.prompt());
}

async function handleGoogleCredential(response) {
  // Show "Signing in..." progress state immediately
  const signinArea = document.getElementById('login-signin-area');
  const progressArea = document.getElementById('login-progress');
  if (signinArea) signinArea.style.display = 'none';
  if (progressArea) progressArea.style.display = 'block';

  const result = await api('exchangeCode', { code: response.credential });

  if (result.error) {
    // Show error, restore sign-in button
    if (signinArea) signinArea.style.display = 'block';
    if (progressArea) progressArea.style.display = 'none';
    document.getElementById('lerr').textContent = result.error;
    return;
  }
  token = result.token;
  me = { email: result.email, name: result.name, role: result.role, edit: result.edit, admin: result.admin, picture: result.picture, dashboards: result.dashboards || [] };
  saveSession(token, me);
  showApp();
}

// ════════════════════════════════════════════════════════
//  LOAD DATA
// ════════════════════════════════════════════════════════
// Background data sync — refreshes orgs/seasonEntries/packages without touching UI or overlays
async function _syncData() {
  try {
    const data = await api('getAllData');
    if (data.error) return;
    orgs          = data.orgs     || orgs;
    seasonEntries = data.seasons  || seasonEntries;
    packages      = data.packages || packages;
    years         = (data.years   || []).map(Number).sort((a,b) => b-a);
    rebuildTierLookups();
    render();
    setSyncState('ok', 'Saved');
  } catch(e) {}
}

async function loadAll() {
  setSyncState('loading', 'Loading data…');
  try {
    const [data, seasonsRes] = await Promise.all([
      api('getAllData'),
      Promise.resolve(null) // getAllData includes years
    ]);
    if (data.error) throw new Error(data.error);
    orgs          = data.orgs   || [];
    seasonEntries = data.seasons || [];
    years         = (data.years || []).map(Number).sort((a,b) => b-a);
    packages      = data.packages || [];
    // Always default to current calendar year; fall back to most recent
    const curYear = new Date().getFullYear();
    if (!activeSeason || !years.includes(+activeSeason)) {
      activeSeason = years.includes(curYear) ? curYear : (years[0] || null);
    }
    rebuildTierLookups();
    populatePackageSelect();
    renderSeasonTabs();
    // Only render sponsorship KPIs if user can see sponsors
    if (canSeeDash('sponsors')) render();
    // Re-apply whichever dashboard was active, but only if still accessible
    const wasDash = _currentDashboard || 'sponsors';
    if (canSeeDash(wasDash === 'admin-panel' ? 'admin' : wasDash)) {
      switchDashboard(wasDash);
    } else {
      _navigateToFirstDashboard();
    }
  } catch(e) {
    setSyncState('err', 'Load failed: ' + e.message);
    showToast('Load failed', 'err');
  }
}

// ════════════════════════════════════════════════════════
//  APP SHOW / HIDE
// ════════════════════════════════════════════════════════
function showApp() {
  document.getElementById('login-view').style.display = 'none';
  document.getElementById('app').style.display = 'block';
  renderUserUI();
  // Restore saved dashboard if accessible, otherwise navigate to first available
  const _savedDash = _currentDashboard;
  const _savedDashKey = _savedDash === 'admin-panel' ? 'admin' : _savedDash;
  if (_savedDash && canSeeDash(_savedDashKey)) {
    switchDashboard(_savedDash);
  } else {
    _navigateToFirstDashboard();
  }
  loadAll();
  // Security: refresh permissions from backend — catches group changes without sign-out
  _refreshPermissions();
}

async function _refreshPermissions() {
  try {
    const res = await api('getMe');
    if (res && !res.error && res.email) {
      // Update dashboards and access flags from fresh backend data
      const changed = JSON.stringify(me.dashboards) !== JSON.stringify(res.dashboards)
                   || me.admin !== res.admin || me.edit !== res.edit;
      me.dashboards = res.dashboards || me.dashboards;
      me.edit       = res.edit;
      me.admin      = res.admin;
      saveSession(token, me);
      // If permissions changed, re-render UI and re-route to correct dashboard
      if (changed) { renderUserUI(); _navigateToFirstDashboard(); }
    }
  } catch(e) {}
}

function _navigateToFirstDashboard() {
  // Find the first dashboard this user has access to, in priority order
  const order = ['sponsors', 'recruitment', 'admin-panel'];
  const dashKey = { 'sponsors': 'sponsors', 'recruitment': 'recruitment', 'admin-panel': 'admin' };
  for (let i = 0; i < order.length; i++) {
    if (canSeeDash(dashKey[order[i]])) {
      switchDashboard(order[i]);
      return;
    }
  }
  // No dashboards accessible — show a "no access" message
  document.getElementById('sponsor-content').style.display  = 'none';
  document.getElementById('recruitment-content').style.display = 'none';
  document.getElementById('admin-panel-content').style.display = 'none';
  document.getElementById('dash-sub-sponsors').style.display   = 'none';
  document.getElementById('dash-sub-recruitment').style.display = 'none';
  document.getElementById('dash-sub-admin').style.display      = 'none';
  document.querySelectorAll('.dashboard-tab').forEach(b => b.classList.remove('act'));
  const mainContent = document.getElementById('main-content') || document.querySelector('main') || document.getElementById('app');
  const noAccess = document.getElementById('no-access-msg') || document.createElement('div');
  noAccess.id = 'no-access-msg';
  noAccess.style.cssText = 'display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:60vh;text-align:center;padding:40px 20px;';
  noAccess.innerHTML = '<div style="font-size:48px;margin-bottom:16px;">🔒</div>'
    + '<div style="font-family:var(--font-cond),sans-serif;font-size:28px;font-weight:900;color:var(--green);margin-bottom:8px;">No Dashboards Accessible</div>'
    + '<div style="font-size:14px;color:var(--text-dim);max-width:380px;line-height:1.6;">Your account doesn\'t currently have access to any dashboards. Please contact your administrator to have your access group configured.</div>'
    + '<div style="margin-top:20px;font-size:12px;color:var(--text-dim);">Signed in as <strong>' + (me ? me.email : '') + '</strong></div>';
  document.querySelector('#app') && document.querySelector('#app').appendChild(noAccess);
}

function renderUserUI() {
  if (!me) return;
  const name = me.name || me.email;
  document.getElementById('user-name').textContent = name;
  // Initials fallback
  const initEl = document.getElementById('user-init');
  if (initEl) initEl.textContent = name.split(' ').map(w=>w[0]).join('').toUpperCase().slice(0,2);
  const pic = document.getElementById('user-pic');
  if (me.picture) {
    pic.src = me.picture; pic.style.display = 'block';
    if (initEl) initEl.style.display = 'none';
  }
  // Build me.dashboards from group/legacy access before using canSeeDash
  _buildMeDashboards();

  const st = document.getElementById('dash-tab-sponsors');
  if (st) st.style.display = canSeeDash('sponsors') ? 'flex' : 'none';

  const rt = document.getElementById('dash-tab-recruitment');
  if (rt) rt.style.display = canSeeDash('recruitment') ? 'flex' : 'none';

  const at = document.getElementById('dash-tab-admin');
  if (at) at.style.display = canSeeDash('admin') ? 'flex' : 'none';

  const hma = document.getElementById('hmenu-admin');
  if (hma) hma.style.display = canSeeDash('admin') ? 'block' : 'none';

  // Set packages label based on edit permission
  const pkgLbl = document.getElementById('packages-lbl');
  if (pkgLbl) pkgLbl.textContent = canSeeDash('sponsors.edit') ? 'View/Edit Packages' : 'View Packages';

  // Hide Add Sponsor tab for view-only users
  const addSpBtn = document.getElementById('dsub-add-sponsor');
  if (addSpBtn) addSpBtn.style.display = canSeeDash('sponsors.edit') ? '' : 'none';

  // Hide Import tab — admin only
  const importTab = document.getElementById('pl-tab-import');
  if (importTab) importTab.style.display = me?.admin ? '' : 'none';
}

// ════════════════════════════════════════════════════════
//  SEASON TABS
// ════════════════════════════════════════════════════════
function renderSeasonTabs() {
  // After render, scroll active tab into view at start of season bar
  requestAnimationFrame(() => {
    const act = document.querySelector('.stab.act');
    if (act) act.scrollIntoView({ block:'nearest', inline:'start', behavior:'smooth' });
  });
  document.getElementById('season-tabs').innerHTML = years.map(y =>
    `<button class="stab${+y===+activeSeason?' act':''}" data-year="${y}" onclick="switchSeason(${y})">${y}</button>`
  ).join('');
  scrollActiveSeasonIntoView();
  // Only rebuild the year select if the SS modal is NOT open (avoid resetting user's choice)
  const sel = document.getElementById('sf-year');
  if (sel && !document.getElementById('ss-modal').classList.contains('open')) {
    sel.innerHTML = years.map(y=>`<option value="${y}">${y}</option>`).join('');
    sel.value = activeSeason;
  } else if (sel && !sel.innerHTML) {
    // First time — always populate
    sel.innerHTML = years.map(y=>`<option value="${y}">${y}</option>`).join('');
    sel.value = activeSeason;
  }
}

function switchSeason(y) {
  activeSeason = +y;
  renderSeasonTabs();
  render();
  // If recruitment dashboard is active, reload player data for new season
  if (typeof _currentDashboard !== 'undefined' && _currentDashboard === 'recruitment') {
    plSeason = +y;
    plData = null;
    loadPlayerData();
  }
}

// ════════════════════════════════════════════════════════
//  STATS
// ════════════════════════════════════════════════════════
function calcStats(year) {
  const ss       = ssForYear(year);
  const cashSS   = ss.filter(s => s.status !== 'inkind');
  const ikSS     = ss.filter(s => s.status === 'inkind');
  const total    = cashSS.reduce((a,s) => a + +s.amount, 0);
  const recv     = cashSS.reduce((a,s) =>
    s.status==='paid' ? a + +s.amount :
    s.status==='partial' ? a + +(s.paidAmount||0) : a, 0);
  const outCount = cashSS.filter(s => s.status!=='paid').length;
  const byTier   = {};
  const allTiers = [...new Set(['diamond','gold','silver','bronze','community','custom', ...seasonEntries.map(s=>s.tier)])].filter(Boolean);
  allTiers.forEach(t => {
    const ts   = ss.filter(s => String(s.tier).toLowerCase()===t);
    const cash = ts.filter(s => s.status!=='inkind');
    const ik   = ts.filter(s => s.status==='inkind');
    byTier[t]  = { count: ts.length, cashCount: cash.length, ikCount: ik.length,
                   amount: cash.reduce((a,s)=>a+ +s.amount,0) };
  });
  return { total, recv, outstanding: total-recv, outCount, count: ss.length,
           ikCount: ikSS.length, byTier };
}

// ════════════════════════════════════════════════════════
//  MAIN RENDER
// ════════════════════════════════════════════════════════
function render() {
  const cy = activeSeason; if (!cy) return;
  const s    = calcStats(cy);
  const prevYr = years[years.indexOf(cy)+1];
  const prev = prevYr ? calcStats(prevYr) : { total:0 };

  document.getElementById('season-span').textContent = 'Sponsorship ' + cy + ' Season';
  // Capture static sponsor HTML so switchDashboard can restore it
  _sponsorStaticHTML = document.getElementById('sponsor-content').innerHTML || _sponsorStaticHTML;
  document.getElementById('k-total').textContent = fmt(s.total);
  document.getElementById('k-count').textContent = s.count + ' sponsor' + (s.count!==1?'s':'');
  document.getElementById('k-paid').textContent  = fmt(s.recv);
  const pct = s.total>0 ? Math.round(s.recv/s.total*100) : 0;
  document.getElementById('k-ppct').textContent = pct + '% collected';
  document.getElementById('k-bar').style.width  = pct + '%';
  document.getElementById('k-out').textContent  = fmt(s.outstanding);
  document.getElementById('k-outc').textContent = s.outCount + ' invoice' + (s.outCount!==1?'s':'') + ' pending';

  const tEl = document.getElementById('k-trend');
  if (prev.total>0 && s.total>0) {
    const d = s.total-prev.total, pd = Math.round(d/prev.total*100);
    tEl.textContent = (d>=0?'▲ ':'▼ ') + Math.abs(pd) + '% vs ' + prevYr;
    tEl.className = 'ktrend ' + (d>=0?'up':'dn');
  } else tEl.textContent = '';

  // In-kind strip
  const ikStrip = document.getElementById('inkind-strip');
  const ikSumm  = document.getElementById('inkind-summary');
  if (ikStrip) ikStrip.style.display = s.ikCount>0 ? 'flex' : 'none';
  if (ikSumm && s.ikCount>0) ikSumm.textContent = s.ikCount+' in-kind sponsor'+(s.ikCount!==1?'s':'')+' this season';

  // Tier mini (KPI card)
  const activeTiers = Object.keys(s.byTier).filter(t => s.byTier[t].count > 0).sort((a,b)=>(TO[a]||9)-(TO[b]||9));
  document.getElementById('tier-mini').innerHTML = activeTiers.map(t => {
    const d = s.byTier[t]; if (!d.count) return '';
    const col = TH[t] || 'var(--text-dim)';
    const ikBit = d.ikCount>0 ? `<span style="font-size:9px;color:#6d28d9;font-weight:600">&nbsp;(${d.ikCount} in-kind)</span>` : '';
    return `<div style="display:flex;align-items:center;gap:7px"><div style="width:6px;height:6px;border-radius:50%;background:${col};flex-shrink:0"></div><span style="font-size:11px;flex:1">${TL[t]||cap(t)}</span><span style="font-size:12px;font-weight:800;color:${col}">${d.count}${ikBit}</span></div>`;
  }).join('');

  // YOY bars
  const allSt = years.map(y => ({ year:y, ...calcStats(y) }));
  const maxT  = Math.max(...allSt.map(x=>x.total), 1);
  document.getElementById('year-bars').innerHTML = allSt.map(ys => {
    const p2 = Math.round(ys.total/maxT*100);
    const isCur = +ys.year===+cy;
    return `<div class="ybargrp" onclick="switchSeason(${ys.year})" title="View ${ys.year}">
      <div class="ybarlbl"><span class="yr" style="${isCur?'color:var(--text);font-weight:700':''}">${ys.year}${isCur?' ★':''}</span>
      <span style="font-weight:700;color:${isCur?'var(--yellow-dark)':'var(--text-dim)'}">${fmt(ys.total)} <span style="font-size:9px;font-weight:400">(${ys.count})</span></span></div>
      <div class="btrack"><div class="bfill ${isCur?'cur':'prev'}" style="width:${p2}%"></div></div>
    </div>`;
  }).join('');

  // Tier list (revenue by tier)
  const tierListTiers = Object.keys(s.byTier).filter(t => s.byTier[t].count > 0).sort((a,b)=>(TO[a]||9)-(TO[b]||9));
  document.getElementById('tier-list').innerHTML = tierListTiers.map(t => {
    const d = s.byTier[t]; if (!d.count) return '';
    const col = TH[t] || 'var(--text-dim)';
    const ikLabel = d.ikCount>0 ? `<span style="font-size:9px;color:#6d28d9;font-weight:700;margin-left:4px">(${d.ikCount} in-kind)</span>` : '';
    return `<div class="trow" onclick="filterTable('${t}')">
      <div class="tdot ${t}"></div><div class="tname">${TL[t]||cap(t)}${ikLabel}</div>
      <div class="tcnt">${d.count}</div><div class="tamt" style="color:${col}">${fmt(d.amount)}</div>
    </div>`;
  }).join('') || '<div style="color:var(--text-dim);font-size:13px;padding:6px">No sponsors yet.</div>';

  // Prospect pipeline — only for current/future seasons, not completed ones.
  // Season runs Oct–Sep: the "current" season year is the year in which Sep falls.
  // e.g. season 2026 = Oct 2025 – Sep 2026. If today is Oct or later, season = next year.
  const _now = new Date();
  const _currentSeasonYear = _now.getMonth() >= 9 ? _now.getFullYear() + 1 : _now.getFullYear();
  const _isCurOrFuture = +cy >= _currentSeasonYear;
  if (_isCurOrFuture) renderProspects();
  else { const _pp = document.getElementById('prospect-panel'); if (_pp) _pp.style.display='none'; }

  renderFilterTabs();
  renderTableHeaders();
  renderTable();

  // AI summary: blank immediately on season change so stale content never lingers,
  // then load from cache → regenerate if fingerprint changed
  const _spAiEl = document.getElementById('sponsor-ai-text');
  const _spSeasonEl = document.getElementById('sponsor-ai-season');
  const _spTsEl = document.getElementById('sponsor-ai-ts');
  if (_spAiEl) _spAiEl.innerHTML = '<span style="opacity:.4;font-size:12px;">Loading…</span>';
  if (_spSeasonEl) _spSeasonEl.textContent = '';
  if (_spTsEl) _spTsEl.textContent = '';
  // Clear the in-memory guard for this season so we always re-evaluate on switch
  _sponsorAICache[cy] = false;
  _loadSponsorAI(s, cy, prevYr, prev);
}

// ════════════════════════════════════════════════════════
//  SPONSOR AI SUMMARY
// ════════════════════════════════════════════════════════
// ── AI INSIGHT CACHE (backend-persisted, fingerprint-based) ─────────────────
// Insights are stored in the AppSettings sheet and shared across all users.
// Regenerated only when the data fingerprint changes (new import, sponsor update etc.)
// In-memory guards prevent duplicate in-flight requests within a session.
let _sponsorAICache    = {}; // season → true (in-flight guard)
let _overviewAIFetching = {}; // season → true (in-flight guard)

async function _loadSponsorAI(s, season, prevYr, prev) {
  const el = document.getElementById('sponsor-ai-text');
  if (!el) return;

  if (_sponsorAICache[season]) return; // already fetching this season
  _sponsorAICache[season] = true; // mark in-flight
  const _spSeason = season; // capture for stale-callback detection

  // Fingerprint: key figures that signal data has changed
  const _spFP = [season, s.total, s.count, s.recv, s.outCount, s.ikCount].join('|');

  const _spTsEl = document.getElementById('sponsor-ai-ts');
  const _spSnEl = document.getElementById('sponsor-ai-season');

  // Step 1: Load cached insight from sheet immediately — show without delay
  let _spCached = null;
  try {
    _spCached = await api('getAIInsight', { type: 'sponsor', season });
  } catch(e) { /* network issue — proceed to generate */ }

  // Abort if season changed while fetching
  if (activeSeason !== _spSeason) { _sponsorAICache[_spSeason] = false; return; }

  if (_spCached && !_spCached.error && _spCached.html) {
    // Show cached content immediately
    el.innerHTML = _spCached.html;
    if (_spSnEl) _spSnEl.textContent = String(season);
    if (_spTsEl && _spCached.updatedAt) {
      try {
        const d = new Date(_spCached.updatedAt);
        _spTsEl.textContent = 'Generated ' + d.toLocaleDateString('en-AU',{day:'numeric',month:'short'}) + ' ' + d.toLocaleTimeString('en-AU',{hour:'2-digit',minute:'2-digit'});
      } catch(e) {}
    }
    // Fingerprint matches — data unchanged, we're done
    if (_spCached.fingerprint === _spFP) {
      _sponsorAICache[season] = false;
      return;
    }
    // Fingerprint changed — keep cached visible, show updating indicator
    if (_spTsEl) _spTsEl.textContent = 'Updating…';
  }

  // Step 2: Generate fresh insight (cache miss or stale)

  const today   = new Date();
  const pct     = s.total > 0 ? Math.round(s.recv / s.total * 100) : 0;
  const prevPct = prev.total > 0 ? Math.round((prev.recv||0) / prev.total * 100) : null;

  // Tier breakdown string
  const tierStr = Object.entries(s.byTier)
    .filter(([,d]) => d.count > 0)
    .sort((a,b) => (TO[a[0]]||9) - (TO[b[0]]||9))
    .map(([t,d]) => (TL[t]||t) + ': ' + d.count + (d.ikCount ? ' (' + d.ikCount + ' in-kind)' : '') + ' · $' + fmt(d.amount))
    .join('; ');

  // Prospects only meaningful for current season — orgStatus is a live field, not historical
  const _spCurrentYear = today.getFullYear();
  const _spIsCurrentSeason = +season >= _spCurrentYear;
  const prospects = _spIsCurrentSeason ? orgs.filter(o => o.orgStatus === 'prospect').length : 0;

  // Multi-year context
  const yoyStr = years.slice(0,4).map(y => {
    const ys = calcStats(y);
    return y + ': $' + fmt(ys.total) + ' (' + ys.count + ' sponsors)';
  }).join(', ');

  var prompt;
  if (!_spIsCurrentSeason) {
    // Historical season — review framing
    prompt = 'You are helping volunteers at a community junior football club review a completed sponsorship season. '
      + 'This club has no paid staff — everyone involved is a volunteer giving their time. '
      + 'The ' + season + ' season is now complete. Write a warm, honest season review — celebrate achievements, '
      + 'note what the numbers show, and highlight one thing worth carrying into future seasons. '
      + 'Write 3-5 concise bullet points. Each starts with a relevant emoji. Use **bold** for key figures. '
      + 'Speak in past tense. No headers. Each bullet 1-2 sentences max.\n\n'
      + 'Season: ' + season + ' (completed)\n'
      + 'Total raised: $' + fmt(s.total) + ' across ' + s.count + ' sponsors\n'
      + 'Collected: $' + fmt(s.recv) + ' (' + pct + '%)'
      + (prevPct !== null ? ', vs ' + prevPct + '% in ' + prevYr : '') + '\n'
      + (s.ikCount ? 'In-kind: ' + s.ikCount + ' sponsors\n' : '')
      + 'By tier: ' + (tierStr || 'no sponsors') + '\n'
      + 'Historical context: ' + yoyStr;
  } else {
    // Current/upcoming season — forward-looking framing
    prompt = 'You are helping volunteers at a community junior football club understand their sponsorship season. '
      + 'This club has no paid staff — everyone involved is a volunteer giving their time. '
      + 'Today is ' + today.toLocaleDateString('en-AU', {day:'numeric', month:'long', year:'numeric'}) + '. '
      + 'IMPORTANT: Sponsorship payments are not due until the season starts, so any outstanding amounts are completely normal and expected — do not frame them as a problem. '
      + 'Your tone should be warm, encouraging, and data-driven. Celebrate what has been achieved. Be specific with numbers. '
      + 'Write 3-5 concise bullet points. Each starts with a relevant emoji. Use **bold** for key figures. '
      + 'Focus on: pipeline strength, year-on-year progress, tier mix, and one practical next step the team can feel good about. '
      + 'No headers. Each bullet 1-2 sentences max.\n\n'
      + 'Season: ' + season + '\n'
      + 'Total committed: $' + fmt(s.total) + ' across ' + s.count + ' sponsors\n'
      + 'Collected: $' + fmt(s.recv) + ' (' + pct + '%)'
      + (prevPct !== null ? ', vs ' + prevPct + '% collected all of ' + prevYr : '') + '\n'
      + 'Outstanding: $' + fmt(s.outstanding) + ' across ' + s.outCount + ' invoices\n'
      + (s.ikCount ? 'In-kind: ' + s.ikCount + ' sponsors\n' : '')
      + 'By tier: ' + (tierStr || 'no sponsors yet') + '\n'
      + (prospects ? 'Prospects in pipeline: ' + prospects + '\n' : '')
      + 'Historical: ' + yoyStr;
  }

  try {
    const res = await api('getAIInsights', { prompt });
    if (res.error) throw new Error(res.error);
    const raw = (res.text || '').trim();
    if (!raw) { el.textContent = 'No summary available.'; return; }

    const lines = raw.split('\n').map(l => l.trim()).filter(l => l.length > 0);
    const htmlParts = lines.map(line => {
      const cleaned = line.replace(/^[\-\*\u2022]\s*/, '');
      const bolded  = cleaned.replace(/\*\*(.+?)\*\*/g, '<strong style="color:#fff;font-weight:800;">$1</strong>');
      const isWarn  = /\b(outstanding|overdue|behind|risk|unpaid|low|concern|missing|not paid)\b/i.test(cleaned);
      const isGood  = /\b(ahead|strong|great|on track|excellent|above|collected|received)\b/i.test(cleaned);
      const dotCol  = isWarn ? '#fbbf24' : isGood ? '#86efac' : 'rgba(255,255,255,.5)';
      return '<div style="display:flex;gap:10px;margin-bottom:8px;align-items:flex-start;">'
        + '<span style="color:' + dotCol + ';flex-shrink:0;font-size:15px;line-height:1.4;">\u25cf</span>'
        + '<span style="flex:1;">' + bolded + '</span>'
        + '</div>';
    });
    const html = htmlParts.join('');
    // Abort if season changed while generating
    if (activeSeason !== _spSeason) { _sponsorAICache[_spSeason] = false; return; }
    el.innerHTML = html;
    if (_spSnEl) _spSnEl.textContent = String(season);
    if (_spTsEl) _spTsEl.textContent = 'Generated just now';
    // Save to backend so all committee members see the same insight
    const saveRes = await api('saveAIInsight', { type: 'sponsor', season, html, fingerprint: _spFP });
    if (saveRes.error) console.warn('[AI] sponsor save failed:', saveRes.error);
    _sponsorAICache[season] = false;
  } catch(e) {
    _sponsorAICache[_spSeason] = false; // allow retry
    if (activeSeason === _spSeason && !el.innerHTML.includes('●')) {
      el.innerHTML = '<span style="opacity:.5;font-size:12px;">AI summary unavailable — will retry next load</span>';
    }
  }
}

// ════════════════════════════════════════════════════════
//  PROSPECT PIPELINE
// ════════════════════════════════════════════════════════
function renderProspects() {
  const prospects = orgs.filter(o => o.orgStatus === 'prospect');
  const panel = document.getElementById('prospect-panel');
  const list  = document.getElementById('prospect-list');
  if (!prospects.length) { panel.style.display='none'; return; }
  panel.style.display='block';
  list.innerHTML = prospects.map(o => {
    const logs  = ''; // loaded on demand
    const email = o.email ? `<a href="mailto:${o.email}" style="color:var(--green)">${o.email}</a>` : '—';
    return `<div class="trow" onclick="openOrgDetail('${o.id}')" style="margin-bottom:4px;">
      <div style="flex:1;min-width:0;">
        <strong>${o.name}</strong>
        ${o.primaryContact ? `<span style="color:var(--text-dim);font-size:12px;margin-left:6px">${o.primaryContact}</span>` : ''}
      </div>
      ${o.phone ? `<span style="font-size:11px;color:var(--text-dim)">${fmtPhone(o.phone)}</span>` : ''}
    </div>`;
  }).join('');
}

// ════════════════════════════════════════════════════════
//  SPONSOR TABLE
// ════════════════════════════════════════════════════════
function renderTableHeaders() {
  const head = document.getElementById('stable-head');
  if (!head) return;
  if (curView === 'prospect') {
    head.innerHTML = `<tr>
      <th>Sponsor</th>
      <th>Contact</th>
      <th>Phone</th>
      <th>Status</th>
      <th colspan="3"></th>
    </tr>`;
  } else {
    head.innerHTML = `<tr>
      <th class="sortable" onclick="sortBy('name')" id="th-name">Sponsor <span class="sort-arrow" id="sa-name"></span></th>
      <th class="sortable" onclick="sortBy('tier')" id="th-tier">Tier <span class="sort-arrow" id="sa-tier"></span></th>
      <th class="sortable" onclick="sortBy('amount')" id="th-amount">Amount <span class="sort-arrow" id="sa-amount"></span></th>
      <th class="sortable" onclick="sortBy('status')" id="th-status">Status <span class="sort-arrow" id="sa-status"></span></th>
      <th class="sortable" onclick="sortBy('yrs')" id="th-yrs">Yrs <span class="sort-arrow" id="sa-yrs"></span></th>
      <th class="col-contact">Contact</th><th></th>
    </tr>`;
    // Re-apply current sort indicator
    ['name','tier','amount','status','yrs'].forEach(c => {
      const th = document.getElementById('th-' + c);
      const sa = document.getElementById('sa-' + c);
      if (!th || !sa) return;
      const active = c === curSort.col;
      th.classList.toggle('sort-act', active);
      sa.textContent = active ? (curSort.dir === 1 ? '▲' : '▼') : '';
    });
  }
}

function setView(v) {
  curView = v;
  document.getElementById('vtab-active').classList.toggle('act', v==='active');
  document.getElementById('vtab-prospect').classList.toggle('act', v==='prospect');
  document.getElementById('filters').style.display = v==='active' ? '' : 'none';
  if (v==='active') renderFilterTabs();
  renderTableHeaders();
  renderTable();
}

function sortBy(col) {
  if (curSort.col === col) curSort.dir *= -1;
  else { curSort.col = col; curSort.dir = 1; }
  // Update header arrows
  ['name','tier','amount','status','yrs'].forEach(c => {
    const th = document.getElementById('th-' + c);
    const sa = document.getElementById('sa-' + c);
    if (!th || !sa) return;
    const active = c === curSort.col;
    th.classList.toggle('sort-act', active);
    sa.textContent = active ? (curSort.dir === 1 ? '▲' : '▼') : '';
  });
  renderTable();
}

function renderFilterTabs() {
  const container = document.getElementById('filters');
  if (!container) return;
  // Get tiers actually used this season, sorted by tier order
  const ss = ssForYear(activeSeason);
  const usedTiers = [...new Set(ss.map(s => s.tier).filter(Boolean))]
    .sort((a,b) => (TO[a]||9) - (TO[b]||9));
  const hasOwing = ss.some(s => s.status !== 'paid' && s.status !== 'inkind');

  let html = `<button class="ftab${curFilter==='all'?' act':''}" onclick="filterTable('all')">All</button>`;
  usedTiers.forEach(t => {
    html += `<button class="ftab${curFilter===t?' act':''}" onclick="filterTable('${t}')">${TL[t]||cap(t)}</button>`;
  });
  if (hasOwing) {
    html += `<button class="ftab${curFilter==='outstanding'?' act':''}" onclick="filterTable('outstanding')">⚠ Owing</button>`;
  }
  container.innerHTML = html;
}

function filterTable(f) {
  curFilter = f;
  renderFilterTabs();
  renderTable();
}

function renderTable() {
  const cy    = activeSeason;
  const empty = document.getElementById('tbl-empty');
  const tbody = document.getElementById('tbody');

  if (curView === 'prospect') {
    const activeOrgIdSet = activeOrgIds(cy);
    let unlinked = orgs.filter(o => !activeOrgIdSet.has(o.id));

    // Search filter for not-in-season view
    const q2 = (document.getElementById('sponsor-search')?.value||'').toLowerCase().trim();
    if (q2) {
      unlinked = unlinked.filter(o =>
        (o.name||'').toLowerCase().includes(q2) ||
        (o.primaryContact||'').toLowerCase().includes(q2) ||
        (o.phone||'').toLowerCase().includes(q2) ||
        (o.email||'').toLowerCase().includes(q2)
      );
    }

    if (!unlinked.length) {
      tbody.innerHTML=''; empty.style.display='block';
      empty.textContent = q2 ? 'No matches found.' : 'All your sponsors are linked to the ' + cy + ' season.';
      return;
    }
    empty.style.display='none';

    // Sort by name for this view
    unlinked.sort((a,b) => (a.name||'').localeCompare(b.name||''));

    tbody.innerHTML = unlinked.map(o => {
      const statusLabel = o.orgStatus === 'prospect' ? 'Prospect' : 'Not in ' + cy;
      const statusClass = o.orgStatus === 'prospect' ? 'prospect' : 'lapsed';
      const nameHl2 = q2 ? (o.name||'').replace(new RegExp(`(${q2.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')})`, 'gi'), '<mark style="background:var(--yellow-pale);border-radius:2px;">$1</mark>') : (o.name||'');
      return `<tr onclick="openOrgDetail('${o.id}')" style="cursor:pointer">
        <td><strong>${nameHl2}</strong></td>
        <td style="color:var(--text-dim);font-size:12px">${o.primaryContact||'—'}</td>
        <td style="color:var(--text-dim);font-size:12px">${canSeePrivate('sponsors') ? fmtPhone(o.phone) : '••••'}</td>
        <td><span class="ostatus ${statusClass}">${statusLabel}</span></td>
        <td colspan="2"></td>
        <td style="display:flex;gap:4px;">
          ${me?.edit ? `<button class="actbtn" style="background:var(--green);color:#fff;border-color:var(--green);font-size:10px;" onclick="event.stopPropagation();openAddSS('${o.id}')">+ Add to ${cy}</button>` : ''}
          <button class="actbtn" onclick="event.stopPropagation();openEditOrg('${o.id}')">Edit</button>
        </td>
      </tr>`;
    }).join('');
    return;
  }

  // Active view — join season entries with orgs for activeSeason
  let ss = ssForYear(cy);
  if (curFilter!=='all' && curFilter!=='outstanding') ss = ss.filter(s => s.tier===curFilter);
  if (curFilter==='outstanding') ss = ss.filter(s => s.status!=='paid' && s.status!=='inkind');

  // Search filter
  const q = (document.getElementById('sponsor-search')?.value||'').toLowerCase().trim();
  if (q) {
    ss = ss.filter(s => {
      const org = orgs.find(o => o.id===s.orgId);
      return (org?.name||'').toLowerCase().includes(q)
          || (org?.primaryContact||'').toLowerCase().includes(q)
          || (s.tier||'').toLowerCase().includes(q)
          || (s.status||'').toLowerCase().includes(q);
    });
  }

  // Sort
  const STATUS_ORDER = {paid:1,partial:2,outstanding:3,inkind:4};
  ss.sort((a,b) => {
    const orgA = orgs.find(o=>o.id===a.orgId)||{};
    const orgB = orgs.find(o=>o.id===b.orgId)||{};
    let v = 0;
    switch(curSort.col) {
      case 'name':   v = (orgA.name||'').localeCompare(orgB.name||''); break;
      case 'tier':   v = (TO[a.tier]||9)-(TO[b.tier]||9); break;
      case 'amount': v = (+a.amount||0)-(+b.amount||0); break;
      case 'status': v = (STATUS_ORDER[a.status]||9)-(STATUS_ORDER[b.status]||9); break;
      case 'yrs':    v = consecYears(a.orgId)-consecYears(b.orgId); break;
    }
    return v * curSort.dir;
  });

  if (!ss.length) { tbody.innerHTML=''; empty.style.display='block'; empty.textContent= q ? 'No sponsors match your search.' : 'No sponsors for this season yet.'; return; }
  empty.style.display='none';

  tbody.innerHTML = ss.map(s => {
    const org   = orgs.find(o => o.id===s.orgId) || { name: s.orgId, primaryContact:'', phone:'' };
    const c      = consecYears(s.orgId);
    const cBadge = yrsBadge(c);
    const amtH = s.status==='inkind' ? '<span style="color:#6d28d9;font-size:11px;font-weight:700">In-Kind</span>' :
                 s.status==='partial' ? `${fmt(s.amount)}<br><span style="font-size:10px;color:var(--orange)">${fmt(s.paidAmount||0)} recv</span>` :
                 fmt(s.amount);
    const nameHl = q ? (org.name||'').replace(new RegExp(`(${q.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')})`, 'gi'), '<mark style="background:var(--yellow-pale);border-radius:2px;">$1</mark>') : org.name;
    return `<tr onclick="openOrgDetail('${org.id}')" style="cursor:pointer">
      <td><strong>${nameHl}</strong></td>
      <td><span class="tchip ${s.tier}">${TL[s.tier]||cap(s.tier)}</span></td>
      <td>${amtH}</td>
      <td><span class="sbadge ${s.status}">${cap(s.status)}</span></td>
      <td>${cBadge}</td>
      <td style="font-size:11px;color:var(--text-dim)">${org.primaryContact||'—'}</td>
      <td>${me?.edit ? `<button class="actbtn" onclick="event.stopPropagation();openEditSS('${s.id}','${org.id}')">Edit</button>` : ''}</td>
    </tr>`;
  }).join('');
}

// ════════════════════════════════════════════════════════
//  ORG DETAIL PANEL
// ════════════════════════════════════════════════════════
async function openOrgDetail(orgId) {
  const org = orgs.find(o => o.id===orgId); if (!org) return;
  const overlay = document.getElementById('org-detail-overlay');
  bringToFront(overlay);
  overlay.classList.add('open');

  // Render skeleton first
  renderOrgDetail(org, [], true);

  // Fetch contact log
  const logRes = await api('getContactLog', { orgId });
  const clog   = Array.isArray(logRes) ? logRes : [];
  renderOrgDetail(org, clog, false);
}

// Render a single season-entry row (no nested template literals)
function renderSSRow(s, orgId) {
  const tierCol  = TH[s.tier] || 'inherit';
  const tierLbl  = s.customPackage || TL[s.tier] || cap(s.tier);
  const isInKind = s.status === 'inkind';

  const amtHtml = isInKind
    ? '<span style="font-size:11px;color:#6d28d9;font-weight:700;background:#f3e8ff;padding:2px 8px;border-radius:10px;">In-Kind 🤝</span>'
    : '<span style="font-size:14px;font-weight:800;">' + fmt(s.amount) + '</span>';

  const paidHtml = (s.status === 'partial' && +s.paidAmount > 0)
    ? ' <span style="font-size:10px;color:var(--orange);">(' + fmt(s.paidAmount) + ' recv)</span>'
    : '';

  const sBg  = {paid:'#e6f4ec', outstanding:'#fef6ec', partial:'#fef9e6', inkind:'#f3e8ff'}[s.status] || 'var(--bg)';
  const sCol = {paid:'var(--green)', outstanding:'var(--orange)', partial:'#b45309', inkind:'#6d28d9'}[s.status] || 'var(--text-dim)';
  const statusBadge = '<span style="font-size:9px;font-weight:800;background:' + sBg + ';color:' + sCol + ';padding:2px 7px;border-radius:10px;text-transform:uppercase;letter-spacing:.4px;">' + cap(s.status) + '</span>';

  const editHint = (me && me.edit)
    ? '<span style="font-size:11px;color:var(--text-dim);padding:2px 8px;background:var(--bg);border-radius:4px;border:1px solid var(--border);flex-shrink:0;margin-left:2px;">Edit →</span>'
    : '';

  // Checklist mini-summary
  const checks = [
    { key: 'chkInvoiceSent', label: 'Invoice' },
    { key: 'chkThankYou',    label: 'Thank you' },
    { key: 'chkLogoWebsite', label: 'Website' },
    { key: 'chkTrainingTop', label: 'Training top' },
  ];
  const total = checks.length;
  const done  = checks.filter(c => s[c.key] === 'true').length;
  const chkHtml = total > 0
    ? '<span style="font-size:10px;font-weight:700;color:' + (done===total?'var(--green)':'var(--orange)') + ';background:' + (done===total?'var(--green-light)':'var(--orange-light)') + ';padding:2px 7px;border-radius:10px;white-space:nowrap;">'
      + (done===total?'✓ All done':done+'/'+total+' done')+'</span>'
    : '';

  const invoiceHtml = s.invoiceNum
    ? '<span style="font-size:10px;color:var(--text-dim);padding:2px 6px;background:var(--bg);border-radius:4px;border:1px solid var(--border);">🧾 ' + s.invoiceNum + '</span>'
    : '';

  const subLine = (isInKind && s.inkindDesc)
    ? '<div style="font-size:11px;color:#6d28d9;margin-top:3px;">📦 ' + s.inkindDesc + '</div>'
    : (s.notes ? '<div style="font-size:11px;color:var(--text-dim);margin-top:3px;">📋 ' + s.notes + '</div>' : '');

  return '<div class="ss-row" onclick="openEditSS(\'' + s.id + '\',\'' + orgId + '\')">'
    + '<div style="flex:1;min-width:0;">'
    +   '<div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;">'
    +     '<div class="tdot ' + s.tier + '" style="flex-shrink:0;"></div>'
    +     '<span style="font-weight:800;font-size:14px;color:' + tierCol + ';">' + tierLbl + '</span>'
    +     '<span style="font-size:12px;color:var(--text-dim);font-weight:600;">' + s.year + '</span>'
    +     invoiceHtml
    +   '</div>'
    +   subLine
    +   '<div style="display:flex;gap:5px;margin-top:5px;flex-wrap:wrap;">' + chkHtml + '</div>'
    + '</div>'
    + '<div style="display:flex;align-items:flex-start;gap:5px;flex-shrink:0;flex-direction:column;align-items:flex-end;">'
    +   '<div style="display:flex;gap:5px;align-items:center;">' + amtHtml + paidHtml + '</div>'
    +   '<div style="display:flex;gap:5px;align-items:center;">' + statusBadge + editHint + '</div>'
    + '</div>'
    + '</div>';
}

function renderOrgDetail(org, clog, loading) {
  const ssList    = ssForOrg(org.id).sort((a, b) => +b.year - +a.year);
  const _spPriv   = canSeePrivate('sponsors');

  // ── Header buttons ──────────────────────────────────────
  const editOrgBtn = (me && me.edit)
    ? '<button class="actbtn" onclick="openEditOrg(\'' + org.id + '\')">Edit Details</button>'
    : '';
  const addSSBtn = (me && me.edit)
    ? '<button class="ss-add-btn" onclick="openAddSS(\'' + org.id + '\')">+ Add Season Sponsorship</button>'
    : '';

  // ── Address ─────────────────────────────────────────────
  let addrHtml = '';
  if (_spPriv && (org.physAddr || org.postAddr)) {
    addrHtml = '<div style="margin-top:8px;padding-top:8px;border-top:1px solid var(--border);">';
    if (org.physAddr) addrHtml += '<div style="font-size:10px;color:var(--text-dim);font-weight:700;text-transform:uppercase;letter-spacing:.5px;">Physical</div><div style="font-size:12px;margin-bottom:6px;">' + org.physAddr + '</div>';
    if (org.postAddr && !org.postSameAsPhys) addrHtml += '<div style="font-size:10px;color:var(--text-dim);font-weight:700;text-transform:uppercase;letter-spacing:.5px;">Postal</div><div style="font-size:12px;">' + org.postAddr + '</div>';
    if (org.postSameAsPhys) addrHtml += '<div style="font-size:11px;color:var(--text-dim);font-style:italic;">Postal same as physical</div>';
    addrHtml += '</div>';
  }

  // ── Season rows ─────────────────────────────────────────
  let seasonBodyHtml = '';
  if (ssList.length) {
    for (let i = 0; i < ssList.length; i++) {
      seasonBodyHtml += renderSSRow(ssList[i], org.id);
    }
  } else {
    seasonBodyHtml = '<div style="color:var(--text-dim);font-size:13px;padding:12px 0;text-align:center;">No season entries yet — click <strong>Add Season Sponsorship</strong> to get started.</div>';
  }

  // ── Contact log ─────────────────────────────────────────
  let clogHtml = '';
  if (loading) {
    clogHtml = '<div style="color:var(--text-dim);font-size:12px;padding:8px 0;">Loading…</div>';
  } else if (!clog.length) {
    clogHtml = '<div style="color:var(--text-dim);font-size:12px;padding:8px 0;">No contact history yet.</div>';
  } else {
    for (let i = 0; i < clog.length; i++) {
      const cl = clog[i];
      const delBtn = (me && me.edit)
        ? '<button onclick="deleteContactEntry(\'' + cl.id + '\',\'' + org.id + '\')" style="margin-left:auto;font-size:10px;color:var(--red);background:none;border:none;cursor:pointer;padding:2px 4px;">✕</button>'
        : '';
      clogHtml += '<div class="clog-entry"><div class="clog-dot"></div><div class="clog-body">'
        + '<div class="clog-meta" style="display:flex;align-items:center;">' + cl.date + ' · ' + cl.contactedBy + delBtn + '</div>'
        + '<div class="clog-notes">' + cl.notes + '</div>'
        + '</div></div>';
    }
  }

  const addLogBtn = (me && me.edit)
    ? '<button class="actbtn" onclick="openContactLog(\'' + org.id + '\')" style="margin-bottom:10px;width:100%;">+ Log Contact</button>'
    : '';

  const contactHasData = org.primaryContact || (_spPriv && (org.email || org.phone || org.physAddr || org.postAddr));
  let contactHtml = '';
  if (contactHasData) {
    contactHtml = '<div class="panel" style="margin-bottom:12px;">'
      + '<div style="font-size:9px;text-transform:uppercase;letter-spacing:1.2px;color:var(--text-dim);font-weight:700;margin-bottom:8px;">Contact Details</div>'
      + (org.primaryContact ? '<div style="font-size:13px;font-weight:600;margin-bottom:4px;">👤 ' + org.primaryContact + '</div>' : '')
      + (_spPriv && org.email ? '<div style="font-size:12px;margin-bottom:3px;">✉ <a href="mailto:' + org.email + '" style="color:var(--green)">' + org.email + '</a></div>' : '')
      + (_spPriv && org.phone ? '<div style="font-size:12px;margin-bottom:3px;">📞 ' + fmtPhone(org.phone) + '</div>' : '')
      + (!_spPriv && (org.email || org.phone) ? '<div style="font-size:11px;color:var(--text-dim);font-style:italic;">Contact details hidden — contact an admin for access.</div>' : '')
      + addrHtml
      + '</div>';
  }

  const notesHtml = org.notes
    ? '<div class="panel" style="margin-bottom:12px;"><div style="font-size:9px;text-transform:uppercase;letter-spacing:1.2px;color:var(--text-dim);font-weight:700;margin-bottom:6px;">Notes</div><div style="font-size:13px;color:var(--text-mid);">' + org.notes + '</div></div>'
    : '';

  const initials = org.name.split(' ').map(function(w){ return w[0]; }).slice(0,2).join('').toUpperCase();
  const websiteHtml = org.website
    ? '<a href="https://' + org.website + '" target="_blank" rel="noopener" style="color:var(--green);font-size:11px;">' + org.website + ' ↗</a>'
    : '';

  document.getElementById('od-content').innerHTML =
    // Header
    '<div style="display:flex;align-items:flex-start;gap:12px;margin-bottom:16px;">'
    + '<div class="dlogo" style="flex-shrink:0;">' + initials + '</div>'
    + '<div style="flex:1;min-width:0;">'
    +   '<h2 style="font-family:\'Barlow Condensed\',sans-serif;font-size:22px;font-weight:900;line-height:1.1;">' + org.name + '</h2>'
    +   '<div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap;margin-top:4px;">'
    +     '<span class="ostatus ' + org.orgStatus + '">' + cap(org.orgStatus) + '</span>'
    +     websiteHtml
    +   '</div>'
    + '</div>'
    + '<div style="display:flex;gap:6px;flex-shrink:0;">' + editOrgBtn + '</div>'
    + '</div>'

    // Season panel (full width, prominent)
    + '<div class="panel" style="margin-bottom:12px;border-color:var(--border-s);">'
    +   '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;gap:8px;">'
    +     '<div style="font-size:9px;text-transform:uppercase;letter-spacing:1.2px;color:var(--text-dim);font-weight:700;">Sponsorship Packages</div>'
    +     addSSBtn
    +   '</div>'
    +   '<div id="ss-list-' + org.id + '" style="display:flex;flex-direction:column;gap:6px;">' + seasonBodyHtml + '</div>'
    + '</div>'

    // Two-col below
    + '<div class="org-detail-wrap">'
    +   '<div class="org-detail-main">'
    +     contactHtml
    +     notesHtml
    +   '</div>'
    +   '<div class="org-detail-side">'
    +     '<div class="panel">'
    +       '<div style="font-size:9px;text-transform:uppercase;letter-spacing:1.2px;color:var(--text-dim);font-weight:700;margin-bottom:8px;">Contact Log</div>'
    +       addLogBtn
    +       '<div id="clog-list-' + org.id + '">' + clogHtml + '</div>'
    +     '</div>'
    +   '</div>'
    + '</div>';
}

function closeOrgDetail() { document.getElementById('org-detail-overlay').classList.remove('open'); }

// ════════════════════════════════════════════════════════
//  ORG MODAL (add / edit organisation)
// ════════════════════════════════════════════════════════
function resetOrgModal() {
  // Clear any duplicate warning
  const _dw = document.getElementById('org-dup-warning');
  if (_dw) { _dw.style.display = 'none'; _dw.dataset.acknowledgedFor = ''; }
  ['of-name','of-contact','of-email','of-phone','of-website','of-physaddr','of-postaddr','of-notes'].forEach(id => {
    const el = document.getElementById(id); if(el) el.value='';
  });
  document.getElementById('of-orgstatus').value = 'prospect';
  document.getElementById('of-postsame').checked = false;
  document.getElementById('of-postaddr').disabled = false;
}

function togglePostalSame() {
  const same = document.getElementById('of-postsame').checked;
  const postEl = document.getElementById('of-postaddr');
  postEl.disabled = same;
  if (same) postEl.value = document.getElementById('of-physaddr').value;
}

document.getElementById('of-physaddr').addEventListener('input', function() {
  if (document.getElementById('of-postsame').checked) document.getElementById('of-postaddr').value = this.value;
});

// ── DUPLICATE SPONSOR DETECTION ──────────────────────────────────────
// Normalise a business name for comparison: lowercase, strip common suffixes,
// collapse whitespace, remove punctuation
function _normOrgName(s) {
  return (s||'').toLowerCase()
    .replace(/pty\.?\s*ltd\.?|pty|ltd\.?|p\/l|inc\.?|co\.?|group|&|and|the/g, ' ')
    .replace(/[^a-z0-9 ]/g, ' ')
    .replace(/\s+/g, ' ')
    .trim();
}

// Extract initials from a normalised org name: "melbourne food distributors" → "mfd"
function _orgInitials(norm) {
  const SKIP_INIT = new Set(['pty','ltd','the','and','of','for','in','at','by','co','inc']);
  return norm.split(' ').filter(w => w.length >= 2 && !SKIP_INIT.has(w)).map(w => w[0]).join('');
}

// Levenshtein distance (edit distance) between two strings
function _editDist(a, b) {
  const m = a.length, n = b.length;
  const dp = Array.from({length: m+1}, (_, i) => Array.from({length: n+1}, (_, j) => i||j));
  for (let i=1;i<=m;i++) for (let j=1;j<=n;j++)
    dp[i][j] = a[i-1]===b[j-1] ? dp[i-1][j-1] : 1+Math.min(dp[i-1][j], dp[i][j-1], dp[i-1][j-1]);
  return dp[m][n];
}

// Returns true if two org names are likely the same business
// Uses full-string + acronym + token-level matching with edit distance
function _orgSimilar(rawA, rawB) {
  const a = _normOrgName(rawA), b = _normOrgName(rawB);
  if (!a || !b) return false;
  if (a === b) return true;

  // Full-string substring match
  if (a.includes(b) || b.includes(a)) return true;

  // Full-string edit distance (catches typos in short names)
  const maxLen = Math.max(a.length, b.length);
  const fullDist = _editDist(a, b);
  const fullThreshold = maxLen <= 6 ? 1 : maxLen <= 12 ? 2 : Math.floor(maxLen * 0.3);
  if (fullDist <= fullThreshold) return true;

  // Acronym matching: "MFD" vs "Melbourne Food Distributors"
  // Check if one side is an acronym that matches the other's initials
  const initA = _orgInitials(a), initB = _orgInitials(b);
  if (initA && initB) {
    // One is short enough to be an acronym (2-5 chars), the other is multi-word
    if (a.length <= 5 && b.split(' ').length >= 2 && initB === a) return true;
    if (b.length <= 5 && a.split(' ').length >= 2 && initA === b) return true;
    // Also allow 1-char edit distance on initials for slight typos
    if (a.length <= 5 && b.split(' ').length >= 2 && _editDist(initB, a) <= 1) return true;
    if (b.length <= 5 && a.split(' ').length >= 2 && _editDist(initA, b) <= 1) return true;
  }

  // Token-level matching: check each significant word from one name against
  // each significant word from the other. Catches "Matador" vs "Mattador Building"
  const SKIP = new Set(['building','construction','services','group','australia','enterprises','solutions',
                        'industries','management','properties','consulting','professional','international',
                        'national','trading','holdings','investments','trust','aust']);
  const tokensA = a.split(' ').filter(t => t.length >= 4 && !SKIP.has(t));
  const tokensB = b.split(' ').filter(t => t.length >= 4 && !SKIP.has(t));

  if (!tokensA.length || !tokensB.length) return false;

  for (const ta of tokensA) {
    for (const tb of tokensB) {
      if (ta === tb) return true;
      if (ta.includes(tb) || tb.includes(ta)) return true;
      const tMax = Math.max(ta.length, tb.length);
      const tThresh = tMax <= 5 ? 1 : tMax <= 8 ? 1 : 2;
      if (_editDist(ta, tb) <= tThresh) return true;
    }
  }
  return false;
}

function findSimilarOrgs(name) {
  return orgs.filter(o => o.id !== editOrgId && _orgSimilar(name, o.name));
}

// Debounce timer for live duplicate check
let _orgNameDebounce = null;

// Called on every keystroke in the business name field
function _onOrgNameInput(val) {
  // Reset acknowledgement whenever the name changes
  const w = document.getElementById('org-dup-warning');
  if (w) w.dataset.acknowledgedFor = '';

  clearTimeout(_orgNameDebounce);
  const trimmed = val.trim();

  // Hide immediately if field is too short to meaningfully match
  if (trimmed.length < 2) {
    if (w) w.style.display = 'none';
    return;
  }

  // Debounce: wait 350ms after last keystroke before checking
  _orgNameDebounce = setTimeout(function() {
    // Only run on new sponsors (not edits — duplicates don't apply there)
    if (editOrgId) return;
    const similar = findSimilarOrgs(trimmed);
    if (similar.length > 0) {
      _showOrgDupWarning(trimmed, similar);
    } else {
      if (w) w.style.display = 'none';
    }
  }, 350);
}

function _showOrgDupWarning(name, similar) {
  const el = document.getElementById('org-dup-warning');
  if (!el) return;
  el.style.cssText = 'border-radius:8px;padding:12px 16px;margin:0 0 14px 0;background:#fffbeb;border:1.5px solid #f59e0b;font-size:12px;line-height:1.6;box-sizing:border-box;';
  el.dataset.acknowledgedFor = '';
  el.innerHTML =
    '<div style="display:flex;align-items:flex-start;gap:10px;">'
    + '<span style="font-size:18px;flex-shrink:0;">⚠️</span>'
    + '<div style="flex:1;">'
    + '<div style="font-weight:700;color:#92400e;margin-bottom:6px;font-size:13px;">Similar sponsor already exists — please check before adding:</div>'
    + similar.slice(0,3).map(function(o) {
        return '<div style="color:#78350f;padding:2px 0;display:flex;align-items:center;gap:6px;">'
          + '<span style="color:#f59e0b;font-weight:700;">•</span>'
          + '<span style="font-weight:600;">' + o.name + '</span>'
          + '</div>';
      }).join('')
    + '<div style="margin-top:8px;color:#92400e;font-size:11px;">Is this genuinely a different business? Acknowledge below, then complete the form and click <strong>Add Sponsor</strong>.</div>'
    + '<button id="org-dup-ack-btn" onclick="_ackDupWarning()"'
    + ' style="margin-top:10px;background:#f59e0b;color:#fff;border:none;border-radius:6px;padding:7px 14px;font-size:12px;font-weight:700;cursor:pointer;width:100%;">'
    + 'Acknowledge — this is a different business, continue adding'
    + '</button>'
    + '</div></div>';
  el.style.display = 'block';
  // Disable save button until acknowledged
  const saveBtn = document.getElementById('org-m-save');
  if (saveBtn) { saveBtn.disabled = true; saveBtn.style.opacity = '0.45'; saveBtn.style.cursor = 'not-allowed'; }
  el.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function _ackDupWarning() {
  const el = document.getElementById('org-dup-warning');
  const name = document.getElementById('of-name').value.trim();
  if (el) {
    el.dataset.acknowledgedFor = name;
    el.innerHTML = '<div style="display:flex;align-items:center;gap:8px;color:#166534;font-size:12px;font-weight:600;">'
      + '<span style="font-size:16px;">✅</span>'
      + 'Acknowledged — this is a different business. Complete the form and click <strong>Add Sponsor</strong>.'
      + '</div>';
    el.style.background = '#f0fdf4';
    el.style.borderColor = '#86efac';
  }
  // Re-enable save button
  const saveBtn = document.getElementById('org-m-save');
  if (saveBtn) { saveBtn.disabled = false; saveBtn.style.opacity = ''; saveBtn.style.cursor = ''; }
}

function openAddOrg() {
  if (!me?.edit) return;
  editOrgId = null;
  resetOrgModal();
  document.getElementById('org-m-title').textContent = 'Add Sponsor';
  document.getElementById('org-m-save').textContent  = 'Add Sponsor';
  document.getElementById('org-m-del').style.display = 'none';
  // Ensure save button is always enabled when opening fresh
  const _sb = document.getElementById('org-m-save'); if (_sb) { _sb.disabled=false; _sb.style.opacity=''; _sb.style.cursor=''; }
  document.getElementById('org-m-sub').textContent   = 'New sponsor organisation.';
  const m = document.getElementById('org-modal'); bringToFront(m); m.classList.add('open');
}

function openEditOrg(orgId) {
  if (!me?.edit) return;
  const org = orgs.find(o => o.id===orgId); if (!org) return;
  editOrgId = orgId;
  resetOrgModal();
  document.getElementById('org-m-title').textContent    = 'Edit Sponsor';
  document.getElementById('org-m-save').textContent     = 'Save Changes';
  document.getElementById('org-m-del').style.display    = 'block';
  document.getElementById('org-m-sub').textContent      = org.name;
  document.getElementById('of-name').value              = org.name;
  document.getElementById('of-orgstatus').value         = org.orgStatus || 'prospect';
  document.getElementById('of-contact').value           = org.primaryContact || '';
  document.getElementById('of-email').value             = org.email || '';
  document.getElementById('of-phone').value             = org.phone || '';
  document.getElementById('of-website').value           = org.website || '';
  document.getElementById('of-physaddr').value          = org.physAddr || '';
  document.getElementById('of-postaddr').value          = org.postAddr || '';
  document.getElementById('of-notes').value             = org.notes || '';
  document.getElementById('of-postsame').checked        = !!org.postSameAsPhys;
  document.getElementById('of-postaddr').disabled       = !!org.postSameAsPhys;
  const m = document.getElementById('org-modal'); bringToFront(m); m.classList.add('open');
}

function closeOrgModal() { document.getElementById('org-modal').classList.remove('open'); editOrgId=null; }

async function saveOrg() {
  const name = document.getElementById('of-name').value.trim();
  if (!name) { showToast('Enter a business name', 'warn'); return; }

  // Duplicate detection — only on new sponsors, not edits
  // The warning is shown live as they type; on submit we check if it's visible and unacknowledged
  if (!editOrgId) {
    const similar = findSimilarOrgs(name);
    if (similar.length > 0) {
      const _dupWarnEl = document.getElementById('org-dup-warning');
      const _acknowledged = _dupWarnEl && _dupWarnEl.dataset.acknowledgedFor === name;
      if (!_acknowledged) {
        _showOrgDupWarning(name, similar);
        // Scroll the warning into view so user sees they need to act
        _dupWarnEl && _dupWarnEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        return;
      }
    }
  }

  const data = {
    id:             editOrgId || '',
    name,
    orgStatus:      document.getElementById('of-orgstatus').value,
    primaryContact: document.getElementById('of-contact').value.trim(),
    email:          document.getElementById('of-email').value.trim(),
    phone:          document.getElementById('of-phone').value.trim(),
    website:        document.getElementById('of-website').value.trim(),
    physAddr:       document.getElementById('of-physaddr').value.trim(),
    postAddr:       document.getElementById('of-postaddr').value.trim(),
    postSameAsPhys: document.getElementById('of-postsame').checked,
    notes:          document.getElementById('of-notes').value.trim(),
  };
  setSyncState('loading', 'Saving…');
  btnLoading(document.getElementById('org-m-save'), true);
  const res = await api('saveOrg', { data, isNew: !editOrgId });
  btnLoading(document.getElementById('org-m-save'), false);
  if (res.error) { showToast('Error: ' + res.error, 'err'); setSyncState('err','Save failed'); return; }
  // Local update
  const isNew = !editOrgId;
  if (!editOrgId) { data.id = res.id; orgs.push(data); }
  else { const idx=orgs.findIndex(o=>o.id===editOrgId); if(idx>=0) orgs[idx]={...orgs[idx],...data}; }
  closeOrgModal();
  render();
  setSyncState('ok', 'Saved');
  if (isNew) {
    showToast('Sponsor added ✓ — add their season sponsorship below', '');
    setTimeout(() => {
      const newOrgId = data.id;
      if (me?.edit && confirm('Sponsor "' + data.name + '" saved!\n\nWould you like to add their ' + activeSeason + ' season sponsorship package now?')) {
        openAddSS(newOrgId);
      } else {
        openOrgDetail(newOrgId);
      }
    }, 100);
  } else {
    showToast('Sponsor updated ✓');
    // Re-render org detail in-place if it's open for this org
    const _editedOrg = orgs.find(o => o.id === data.id);
    const _detailOverlay = document.getElementById('org-detail-overlay');
    if (_editedOrg && _detailOverlay && _detailOverlay.classList.contains('open')) {
      renderOrgDetail(_editedOrg, [], true);
      const logRes = await api('getContactLog', { orgId: data.id });
      renderOrgDetail(_editedOrg, Array.isArray(logRes) ? logRes : [], false);
    }
  }
  _syncData();
}

async function deleteOrg() {
  const org = orgs.find(o => o.id===editOrgId); if (!org) return;
  // Count how many season records will also be deleted
  const ssCount = seasonEntries.filter(s => s.orgId === editOrgId).length;
  const ssNote  = ssCount > 0 ? '\n\nThis will also permanently delete ' + ssCount + ' season record' + (ssCount!==1?'s':'') + ' for this sponsor.' : '';
  if (!confirm('DELETE SPONSOR\n\n"' + org.name + '"\n' + ssNote + '\n\nType-check: are you viewing the correct sponsor record? This cannot be undone.')) return;
  btnLoading(document.getElementById('org-m-del'), true);
  const res = await api('deleteOrg', { id: editOrgId });
  btnLoading(document.getElementById('org-m-del'), false);
  if (res.error) { showToast('Error: ' + res.error, 'err'); return; }
  orgs = orgs.filter(o => o.id!==editOrgId);
  seasonEntries = seasonEntries.filter(s => s.orgId!==editOrgId);
  closeOrgModal(); closeOrgDetail();
  render();
  showToast('Sponsor deleted');
  loadAll();
}

// ════════════════════════════════════════════════════════
//  SEASON ENTRY MODAL
// ════════════════════════════════════════════════════════
// ════════════════════════════════════════════════════════
//  SEASON ENTRY MODAL — package-aware with checklist
// ════════════════════════════════════════════════════════
function populatePackageSelect() {
  const sel = document.getElementById('sf-package');
  if (!sel) return;
  const cur = sel.value;
  sel.innerHTML = '<option value="">— Select package —</option>';
  const active = packages.filter(p => p.active !== 'false');
  active.sort((a,b) => (b.amount||0) - (a.amount||0));
  active.forEach(p => {
    const opt = document.createElement('option');
    opt.value = p.id;
    const emoji = p.emoji || TE[p.tier] || '';
    opt.textContent = emoji + ' ' + cap(p.tier) + (p.amount ? ' — $' + Number(p.amount).toLocaleString('en-AU') : '');
    sel.appendChild(opt);
  });
  const custom = document.createElement('option');
  custom.value = 'custom';
  custom.textContent = '⭐ Custom / Other…';
  sel.appendChild(custom);
  if (cur) sel.value = cur;

  // Also rebuild sf-tier options from known tiers
  const tierSel = document.getElementById('sf-tier');
  if (tierSel) {
    const curTier = tierSel.value;
    const tiers = [...new Set(['diamond','gold','silver','bronze','community','custom', ...packages.map(p=>p.tier)])].filter(Boolean);
    tierSel.innerHTML = tiers.map(t => `<option value="${t}">${TE[t]||''} ${TL[t]||cap(t)}</option>`).join('');
    if (curTier) tierSel.value = curTier;
  }
}

function onPackageSelect() {
  const pkgId = document.getElementById('sf-package').value;
  const card  = document.getElementById('sf-pkg-card');
  const customWrap = document.getElementById('sf-custom-wrap');

  if (pkgId === 'custom') {
    card.style.display = 'none';
    customWrap.style.display = '';
    document.getElementById('sf-tier').value = 'custom';
    document.getElementById('sf-amount').value = '';
    return;
  }
  customWrap.style.display = 'none';

  const pkg = packages.find(p => p.id === pkgId);
  if (!pkg) { card.style.display = 'none'; return; }

  // Auto-fill tier and amount
  document.getElementById('sf-tier').value   = pkg.tier || 'gold';
  document.getElementById('sf-amount').value = pkg.amount || '';

  // Show benefits card
  document.getElementById('sf-pkg-card-name').textContent     = pkg.name + (pkg.description ? ' — ' + pkg.description : '');
  document.getElementById('sf-pkg-card-benefits').textContent = pkg.benefits ? '✓ ' + pkg.benefits : '';
  card.style.display = '';
  updateBalance();
}

function resetSSModal() {
  document.getElementById('sf-package').value    = '';
  document.getElementById('sf-tier').value       = 'gold';
  document.getElementById('sf-status').value     = '';
  document.getElementById('sf-amount').value     = '';
  document.getElementById('sf-paid').value       = '';
  document.getElementById('sf-invoice').value    = '';
  document.getElementById('sf-notes').value      = '';
  document.getElementById('sf-inkind-desc').value = '';
  document.getElementById('sf-custom-name').value = '';
  document.getElementById('chk-invoice').checked = false;
  document.getElementById('chk-thankyou').checked = false;
  document.getElementById('chk-logo').checked    = false;
  document.getElementById('chk-top').checked     = false;
  document.getElementById('sf-pkg-card').style.display    = 'none';
  document.getElementById('sf-custom-wrap').style.display = 'none';
  document.getElementById('sf-partial-wrap').style.display = 'none';
  document.getElementById('sf-inkind-wrap').style.display  = 'none';
  document.getElementById('sf-amount-wrap').style.display  = '';
}

function openAddSS(orgId) {
  if (!me || !me.edit) return;
  editSSId  = null;
  editSSOrg = orgId;
  const org = orgs.find(o => o.id === orgId);
  document.getElementById('ss-m-title').textContent = 'Add Season Sponsorship';
  document.getElementById('ss-m-sub').textContent   = org ? org.name : '';
  document.getElementById('ss-m-save').textContent  = 'Add Sponsorship';
  document.getElementById('ss-m-del').style.display = 'none';
  resetSSModal();
  // Always rebuild year select fresh when opening modal
  const sel = document.getElementById('sf-year');
  if (sel) {
    sel.innerHTML = years.map(y=>`<option value="${y}">${y}</option>`).join('');
    sel.value = activeSeason;
  }
  const _btf_ss_modal = document.getElementById('ss-modal'); bringToFront(_btf_ss_modal); _btf_ss_modal.classList.add('open');
}

function openEditSS(ssId, orgId) {
  if (!me || !me.edit) return;
  const ss  = seasonEntries.find(s => s.id === ssId); if (!ss) return;
  const org = orgs.find(o => o.id === orgId);
  editSSId  = ssId;
  editSSOrg = orgId;
  document.getElementById('ss-m-title').textContent = 'Edit Sponsorship Package';
  document.getElementById('ss-m-sub').textContent   = (org ? org.name : '') + ' · ' + ss.year;
  document.getElementById('ss-m-save').textContent  = 'Save Changes';
  document.getElementById('ss-m-del').style.display = 'block';

  resetSSModal();
  document.getElementById('sf-year').value      = ss.year;
  document.getElementById('sf-tier').value      = ss.tier || 'gold';
  document.getElementById('sf-status').value    = ss.status;
  document.getElementById('sf-amount').value    = ss.status === 'inkind' ? '' : (ss.amount || '');
  document.getElementById('sf-paid').value      = ss.paidAmount || '';
  document.getElementById('sf-invoice').value   = ss.invoiceNum || '';
  document.getElementById('sf-notes').value     = ss.notes || '';
  document.getElementById('sf-inkind-desc').value = ss.inkindDesc || '';
  document.getElementById('sf-custom-name').value = ss.customPackage || '';
  document.getElementById('chk-invoice').checked  = ss.chkInvoiceSent  === 'true';
  document.getElementById('chk-thankyou').checked = ss.chkThankYou     === 'true';
  document.getElementById('chk-logo').checked     = ss.chkLogoWebsite  === 'true';
  document.getElementById('chk-top').checked      = ss.chkTrainingTop  === 'true';

  // Try to match a package
  if (ss.customPackage) {
    document.getElementById('sf-package').value = 'custom';
    document.getElementById('sf-custom-wrap').style.display = '';
  } else {
    const matchPkg = packages.find(p => p.tier === ss.tier && +p.amount === +ss.amount);
    if (matchPkg) {
      document.getElementById('sf-package').value = matchPkg.id;
      document.getElementById('sf-pkg-card-name').textContent     = matchPkg.name + (matchPkg.description ? ' — ' + matchPkg.description : '');
      document.getElementById('sf-pkg-card-benefits').textContent = matchPkg.benefits ? '✓ ' + matchPkg.benefits : '';
      document.getElementById('sf-pkg-card').style.display = '';
    }
  }
  updateSSFields();
  const _btf_ss_modal = document.getElementById('ss-modal'); bringToFront(_btf_ss_modal); _btf_ss_modal.classList.add('open');
}

function closeSSModal() { document.getElementById('ss-modal').classList.remove('open'); editSSId=null; editSSOrg=null; }

function updateSSFields() {
  const status    = document.getElementById('sf-status').value;
  const isPartial = status === 'partial';
  const isInKind  = status === 'inkind';
  document.getElementById('sf-partial-wrap').style.display  = isPartial ? '' : 'none';
  document.getElementById('sf-inkind-wrap').style.display   = isInKind  ? '' : 'none';
  document.getElementById('sf-amount-wrap').style.display   = isInKind  ? 'none' : '';
  if (isInKind) document.getElementById('sf-amount').value  = '0';
  updateBalance();
}

function updateBalance() {
  const amount = +document.getElementById('sf-amount').value || 0;
  const paid   = +document.getElementById('sf-paid').value   || 0;
  const bal    = document.getElementById('sf-balance');
  if (!bal) return;
  const owing = amount - paid;
  bal.textContent = owing > 0 ? '$' + owing.toLocaleString('en-AU') : owing === 0 ? '✓ Fully paid' : 'Overpaid!';
  bal.style.color = owing > 0 ? 'var(--orange)' : 'var(--green-bright)';
  bal.style.background = owing > 0 ? 'var(--orange-light)' : 'var(--green-light)';
}

document.getElementById('sf-status').addEventListener('change', updateSSFields);

async function saveSS() {
  const pkgId      = document.getElementById('sf-package').value;
  const tier       = document.getElementById('sf-tier').value;
  const status     = document.getElementById('sf-status').value;
  const amount     = document.getElementById('sf-amount').value;
  const notes      = document.getElementById('sf-notes').value.trim();
  const inkindDesc = document.getElementById('sf-inkind-desc').value.trim();
  const customPkg  = document.getElementById('sf-custom-name').value.trim();

  if (!pkgId)  { showToast('Select a package', 'warn'); return; }
  if (!status) { showToast('Select a payment status', 'warn'); return; }
  if (pkgId === 'custom' && !customPkg) { showToast('Enter the custom package name', 'warn'); return; }
  if (status === 'inkind' && !inkindDesc) { showToast('Describe what they\'re providing', 'warn'); return; }
  const finalAmount = status === 'inkind' ? 0 : +amount;
  if (status !== 'inkind' && finalAmount <= 0) { showToast('Enter the agreed amount', 'warn'); return; }

  const data = {
    id: editSSId || '', orgId: editSSOrg,
    year:          +document.getElementById('sf-year').value,
    tier,  status,
    amount:        finalAmount,
    paidAmount:    +document.getElementById('sf-paid').value || 0,
    notes,         inkindDesc,
    invoiceNum:    document.getElementById('sf-invoice').value.trim(),
    chkInvoiceSent:  String(document.getElementById('chk-invoice').checked),
    chkThankYou:     String(document.getElementById('chk-thankyou').checked),
    chkLogoWebsite:  String(document.getElementById('chk-logo').checked),
    chkTrainingTop:  String(document.getElementById('chk-top').checked),
    customPackage:   pkgId === 'custom' ? customPkg : '',
  };

  setSyncState('loading', 'Saving…');
  btnLoading(document.getElementById('ss-m-save'), true);
  const res = await api('saveSeason', { data, isNew: !editSSId });
  btnLoading(document.getElementById('ss-m-save'), false);
  if (res.error) { showToast('Error: ' + res.error, 'err'); setSyncState('err', 'Save failed'); return; }
  if (!editSSId) { data.id = res.id; seasonEntries.push(data); }
  else { const idx = seasonEntries.findIndex(s => s.id === editSSId); if (idx >= 0) seasonEntries[idx] = {...seasonEntries[idx], ...data}; }
  setSyncState('ok', 'Saved');
  const reopenOrgId = editSSOrg;
  const _wasNew = !editSSId;
  closeSSModal();
  showToast(_wasNew ? 'Sponsorship added ✓' : 'Package updated ✓');
  render();
  // Re-render org detail in-place with fresh in-memory data — no overlay disruption
  if (reopenOrgId) {
    const _org = orgs.find(o => o.id === reopenOrgId);
    if (_org) {
      renderOrgDetail(_org, [], true);
      const logRes = await api('getContactLog', { orgId: reopenOrgId });
      renderOrgDetail(_org, Array.isArray(logRes) ? logRes : [], false);
    }
  }
  _syncData(); // background refresh — won't touch overlays
}

async function deleteSS() {
  const _ssOrg = orgs.find(o => o.id === editSSOrg);
  const _ssEntry = seasonEntries.find(s => s.id === editSSId);
  const _ssLabel = (_ssOrg ? '"' + _ssOrg.name + '"' : 'this sponsor') + (_ssEntry ? ' — ' + _ssEntry.year + ' ' + (_ssEntry.customPackage || TL[_ssEntry.tier] || _ssEntry.tier || '') : '');
  if (!confirm('REMOVE SEASON RECORD\n\n' + _ssLabel + '\n\nThis removes this season entry only. The sponsor record is kept.\nThis cannot be undone.')) return;
  btnLoading(document.getElementById('ss-m-del'), true);
  const res = await api('deleteSeason', { id: editSSId });
  btnLoading(document.getElementById('ss-m-del'), false);
  if (res.error) { showToast('Error: '+res.error, 'err'); return; }
  const reopenOrgId = editSSOrg;
  seasonEntries = seasonEntries.filter(s => s.id !== editSSId);
  closeSSModal();
  showToast('Sponsorship entry removed');
  render();
  if (reopenOrgId) {
    const _org = orgs.find(o => o.id === reopenOrgId);
    if (_org) {
      renderOrgDetail(_org, [], true);
      const logRes = await api('getContactLog', { orgId: reopenOrgId });
      renderOrgDetail(_org, Array.isArray(logRes) ? logRes : [], false);
    }
  }
  _syncData();
}

// ════════════════════════════════════════════════════════
//  CONTACT LOG MODAL
// ════════════════════════════════════════════════════════
let clOrgId = null;

function openContactLog(orgId) {
  clOrgId = orgId;
  const org = orgs.find(o=>o.id===orgId);
  document.getElementById('cl-m-sub').textContent = org ? org.name : '';
  document.getElementById('clf-date').value  = new Date().toISOString().slice(0,10);
  document.getElementById('clf-notes').value = '';
  const _btf_cl_modal = document.getElementById('cl-modal'); bringToFront(_btf_cl_modal); _btf_cl_modal.classList.add('open');
}

function closeContactLog() { document.getElementById('cl-modal').classList.remove('open'); clOrgId=null; }

// Refresh only the contact log section of an open org detail — no full re-render
async function _refreshContactLog(orgId) {
  const listEl = document.getElementById('clog-list-' + orgId);
  if (!listEl) return; // org detail not open for this org
  listEl.innerHTML = '<div style="color:var(--text-dim);font-size:12px;padding:8px 0;">Loading…</div>';
  const logRes = await api('getContactLog', { orgId });
  const clog = Array.isArray(logRes) ? logRes : [];
  const org = orgs.find(o => o.id === orgId) || {};
  let html = '';
  if (!clog.length) {
    html = '<div style="color:var(--text-dim);font-size:12px;padding:8px 0;">No contact history yet.</div>';
  } else {
    clog.forEach(function(cl) {
      const delBtn = (me && me.edit)
        ? '<button onclick="deleteContactEntry(\'' + cl.id + '\',\'' + orgId + '\')" style="margin-left:auto;font-size:10px;color:var(--red);background:none;border:none;cursor:pointer;padding:2px 4px;">✕</button>'
        : '';
      html += '<div class="clog-entry"><div class="clog-dot"></div><div class="clog-body">'
        + '<div class="clog-meta" style="display:flex;align-items:center;">' + cl.date + ' · ' + cl.contactedBy + delBtn + '</div>'
        + '<div class="clog-notes">' + cl.notes + '</div>'
        + '</div></div>';
    });
  }
  listEl.innerHTML = html;
}

async function saveContactLog() {
  const notes = document.getElementById('clf-notes').value.trim();
  if (!notes) { showToast('Enter some notes', 'warn'); return; }
  const date = document.getElementById('clf-date').value;
  btnLoading(document.getElementById('cl-m-save'), true);
  const res = await api('addContactLog', { orgId: clOrgId, date, notes });
  btnLoading(document.getElementById('cl-m-save'), false);
  if (res.error) { showToast('Error: '+res.error, 'err'); return; }
  const _savedClOrgId = clOrgId; // capture before closeContactLog nulls it
  closeContactLog();
  showToast('Contact logged ✓');
  _refreshContactLog(_savedClOrgId);
}

async function deleteContactEntry(id, orgId) {
  if (!confirm('Delete this contact log entry?')) return;
  await api('deleteContactLog', { id });
  _refreshContactLog(orgId);
}

// ════════════════════════════════════════════════════════
//  DRILL DOWN
// ════════════════════════════════════════════════════════
function openDrill(title, ssList) {
  document.getElementById('drill-title').textContent = title;
  document.getElementById('drill-tbody').innerHTML = ssList.map(s => {
    const org = orgs.find(o=>o.id===s.orgId)||{name:s.orgId};
    return `<tr onclick="openOrgDetail('${s.orgId}')" style="cursor:pointer">
      <td><strong>${org.name}</strong></td>
      <td><span class="tchip ${s.tier}">${TL[s.tier]||cap(s.tier)}</span></td>
      <td>${s.status==='inkind'?'<span style="color:#6d28d9;font-size:11px">In-Kind</span>':fmt(s.amount)}</td>
      <td><span class="sbadge ${s.status}">${cap(s.status)}</span></td>
    </tr>`;
  }).join('');
  const _btf_drillPanel = document.getElementById('drillPanel'); bringToFront(_btf_drillPanel); _btf_drillPanel.classList.add('open');
}

function drillInKind() {
  const ss = ssForYear(activeSeason).filter(s => s.status === 'inkind');
  openDrill('In-Kind Sponsors — ' + activeSeason + ' (' + ss.length + ')', ss);
}

function closeDrill() { document.getElementById('drillPanel').classList.remove('open'); }
function drillTotal() {
  const ss = ssForYear(activeSeason).sort((a,b)=>(TO[a.tier]||5)-(TO[b.tier]||5));
  openDrill('All Sponsors — ' + activeSeason + ' (' + fmt(ss.filter(s=>s.status!=='inkind').reduce((a,s)=>a+ +s.amount,0)) + ')', ss);
}
function drillPaid() {
  const ss = ssForYear(activeSeason).filter(s=>s.status==='paid'||s.status==='partial').sort((a,b)=>(TO[a.tier]||5)-(TO[b.tier]||5));
  openDrill('Received — ' + activeSeason, ss);
}
function drillOut() {
  const ss = ssForYear(activeSeason).filter(s=>s.status==='outstanding'||s.status==='partial').sort((a,b)=>(TO[a.tier]||5)-(TO[b.tier]||5));
  openDrill('Outstanding — ' + activeSeason, ss);
}

// ════════════════════════════════════════════════════════
//  SEASON YEAR MODAL
// ════════════════════════════════════════════════════════
function openSeasonModal() {
  document.getElementById('new-season-yr').value = (years[0]||2025) + 1;
  const _btf_season_modal = document.getElementById('season-modal'); bringToFront(_btf_season_modal); _btf_season_modal.classList.add('open');
}
function closeSeasonModal() { document.getElementById('season-modal').classList.remove('open'); }
async function confirmAddSeason() {
  const y = +document.getElementById('new-season-yr').value;
  if (!y||y<2020||y>2045) { showToast('Enter a valid year','warn'); return; }
  if (years.includes(y)) { showToast(y+' already exists','warn'); closeSeasonModal(); return; }
  setSyncState('loading','Adding season…');
  const res = await api('addSeason', { year: y });
  if (res.error) { showToast('Error: '+res.error,'err'); return; }
  years.unshift(y); years.sort((a,b)=>b-a);
  closeSeasonModal(); renderSeasonTabs();
  showToast('Season '+y+' added ✓');
}

// ════════════════════════════════════════════════════════
//  EXPORT CSV
// ════════════════════════════════════════════════════════
function exportCSV() {
  const ss = ssForYear(activeSeason);
  const rows = [['Sponsor','Tier','Amount','Status','Received','Contact','Email','Phone','Website','Notes']];
  ss.forEach(s => {
    const org = orgs.find(o=>o.id===s.orgId)||{name:s.orgId};
    rows.push([org.name,s.tier,s.amount,s.status,s.paidAmount||0,org.primaryContact||'',org.email||'',org.phone||'',org.website||'',org.notes||'']);
  });
  const csv = rows.map(r=>r.map(v=>'"'+String(v).replace(/"/g,'""')+'"').join(',')).join('\n');
  const a = document.createElement('a');
  a.href = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csv);
  a.download = 'KJFC_Sponsors_' + activeSeason + '.csv';
  a.click();
  showToast('CSV exported ✓');
}

// ════════════════════════════════════════════════════════
//  LOGOUT
// ════════════════════════════════════════════════════════
async function doLogout() {
  const _btf_reset_modal = document.getElementById('reset-modal'); bringToFront(_btf_reset_modal); _btf_reset_modal.classList.add('open');
}
function closeResetModal() { document.getElementById('reset-modal').classList.remove('open'); }
async function confirmLogout() {
  clearSession();
  if (window.google) google.accounts.id.disableAutoSelect();
  closeResetModal();
  location.reload();
}

// ════════════════════════════════════════════════════════
//  ADMIN MODAL
// ════════════════════════════════════════════════════════
async function openAdminModal(tab) {
  const modal = document.getElementById('admin-modal');
  // Show/hide admin-only tabs based on role
  modal.querySelectorAll('.adm-tab[data-tab="log"], .adm-tab[data-tab="users"]').forEach(b => {
    b.style.display = (me && me.admin) ? '' : 'none';
  });
  bringToFront(modal); modal.classList.add('open');
  // Set active tab
  document.querySelectorAll('.adm-tab').forEach(b => b.classList.toggle('act', b.dataset.tab===tab));
  await loadAdminTab(tab);
}
function closeAdminModal() { document.getElementById('admin-modal').classList.remove('open'); }

async function loadAdminTab(tab, containerId) {
  const body = document.getElementById(containerId || 'adm-body');
  if (tab==='packages') {
    renderPackageManager();
    return;
  }
  if (tab==='log') {
    body.innerHTML = '<div style="color:var(--text-dim);font-size:13px;padding:12px 0;">Loading…</div>';
    const res = await api('getLog');
    if (!Array.isArray(res)) { body.innerHTML='<div style="color:var(--red)">Failed to load</div>'; return; }
    body.innerHTML = `<div style="overflow-x:auto;"><table class="stable" style="font-size:12px;min-width:500px;">
      <thead><tr><th>Time</th><th>User</th><th>Action</th><th>Details</th></tr></thead>
      <tbody>${res.map(r=>`<tr style="cursor:default"><td style="white-space:nowrap">${fmtD(r.timestamp)}</td><td>${r.user||''}</td><td><span style="font-weight:700">${r.action||''}</span></td><td style="color:var(--text-dim)">${r.details||''}</td></tr>`).join('')}</tbody>
    </table></div>`;
    return;
  }
  if (tab==='about') {
    body.innerHTML = '<div style="color:var(--text-dim);font-size:13px;padding:12px 0;">Loading…</div>';
    const usageRes = await api('getAIUsage');
    const today = new Date();
    const todayKey = today.getFullYear() + '-' + String(today.getMonth()+1).padStart(2,'0') + '-' + String(today.getDate()).padStart(2,'0');
    const ydayDate = new Date(today); ydayDate.setDate(ydayDate.getDate()-1);
    const ydayKey  = ydayDate.getFullYear() + '-' + String(ydayDate.getMonth()+1).padStart(2,'0') + '-' + String(ydayDate.getDate()).padStart(2,'0');
    const todayUsage = (usageRes.usage||{})[todayKey] || {calls:0, inputTokens:0, outputTokens:0};
    const ydayUsage  = (usageRes.usage||{})[ydayKey]  || {calls:0, inputTokens:0, outputTokens:0};
    const creditUSD  = usageRes.creditUSD != null ? usageRes.creditUSD : null;
    const creditInfo = creditUSD != null
      ? '<span style="font-family:var(--font-cond),sans-serif;font-size:28px;font-weight:900;color:var(--green);">$' + creditUSD.toFixed(2) + '</span><span style="font-size:11px;color:var(--text-dim);margin-left:6px;">USD remaining</span>'
      : '<span style="font-size:13px;color:var(--text-dim);">Credit balance not available via API — check <a href="https://console.anthropic.com" target="_blank" style="color:var(--green);">console.anthropic.com</a></span>';
    const tc = todayUsage.calls, yc = ydayUsage.calls;
    const tiIn = (todayUsage.inputTokens||0).toLocaleString(), tiOut = (todayUsage.outputTokens||0).toLocaleString();
    const yiIn = (ydayUsage.inputTokens||0).toLocaleString(),  yiOut = (ydayUsage.outputTokens||0).toLocaleString();
    body.innerHTML =
      '<div style="max-width:680px;">'
      + '<div style="background:var(--green);color:#fff;border-radius:12px;padding:20px 22px;margin-bottom:20px;">'
      +   '<div style="font-family:\'Barlow Condensed\',sans-serif;font-size:22px;font-weight:900;letter-spacing:.5px;margin-bottom:4px;">KJFC Executive Dashboard</div>'
      +   '<div style="font-size:12px;opacity:.8;">Community junior football club management tool</div>'
      +   '<div style="margin-top:12px;font-size:11px;opacity:.7;line-height:1.6;">Sponsorship tracking · Player registrations · Team management · AI-powered insights<br>Built for volunteer committees — all data stored in Google Sheets.</div>'
      + '</div>'
      + '<div style="background:var(--card);border:1.5px solid var(--border);border-radius:12px;padding:18px 20px;margin-bottom:16px;">'
      +   '<div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--text-dim);margin-bottom:12px;">🤖 Anthropic API — AI Insights</div>'
      +   '<div style="margin-bottom:14px;">' + creditInfo + '</div>'
      +   '<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">'
      +     '<div style="background:var(--bg);border-radius:9px;padding:12px 14px;">'
      +       '<div style="font-size:10px;text-transform:uppercase;letter-spacing:.6px;color:var(--text-dim);margin-bottom:6px;">Today</div>'
      +       '<div style="font-family:\'Barlow Condensed\',sans-serif;font-size:26px;font-weight:900;color:var(--green);">' + tc + '</div>'
      +       '<div style="font-size:11px;color:var(--text-dim);">API call' + (tc !== 1 ? 's' : '') + '</div>'
      +       '<div style="font-size:11px;color:var(--text-dim);margin-top:3px;">' + tiIn + ' in · ' + tiOut + ' out tokens</div>'
      +     '</div>'
      +     '<div style="background:var(--bg);border-radius:9px;padding:12px 14px;">'
      +       '<div style="font-size:10px;text-transform:uppercase;letter-spacing:.6px;color:var(--text-dim);margin-bottom:6px;">Yesterday</div>'
      +       '<div style="font-family:\'Barlow Condensed\',sans-serif;font-size:26px;font-weight:900;color:#6b7280;">' + yc + '</div>'
      +       '<div style="font-size:11px;color:var(--text-dim);">API call' + (yc !== 1 ? 's' : '') + '</div>'
      +       '<div style="font-size:11px;color:var(--text-dim);margin-top:3px;">' + yiIn + ' in · ' + yiOut + ' out tokens</div>'
      +     '</div>'
      +   '</div>'
      +   '<div style="font-size:11px;color:var(--text-dim);margin-top:10px;line-height:1.5;">'
      +     'AI insights are cached and shared across all committee members — they only regenerate when your data changes, minimising API calls. '
      +     'Usage data updates every 24 hours. Credit balance requires manual check at <a href="https://console.anthropic.com" target="_blank" style="color:var(--green);">console.anthropic.com</a>.'
      +   '</div>'
      + '</div>'
      + '</div>';
    return;
  }
  if (tab==='groups') {
    await renderGroupsTab(containerId);
    return;
  }

  if (tab==='users') {
    body.innerHTML = '<div style="color:var(--text-dim);font-size:13px;padding:12px 0;">Loading…</div>';
    const res = await api('getUsers');
    if (!Array.isArray(res)) { body.innerHTML='<div style="color:var(--red)">Failed to load users</div>'; return; }

    const groups = await _loadGroups();
    const allGroups = [...BUILTIN_GROUP_DEFAULTS_FE, ...(groups.custom||[])];
    const groupName = (id) => { const g = allGroups.find(g => g.id === id); return g ? g.name : null; }; // null if group deleted — hides stale tags
    const accessLabel = { admin:'Admin', edit:'Can Edit', readonly:'View Only' };
    const accessColor = { admin:'var(--green)', edit:'#0d47a1', readonly:'var(--text-dim)' };

    body.innerHTML = `
      <div style="display:flex;justify-content:flex-end;margin-bottom:12px;">
        <button class="mprimary" style="padding:7px 16px;font-size:12px;" onclick="openUserModal(null)">+ Add User</button>
      </div>
      <div style="display:flex;flex-direction:column;gap:8px;" id="users-list">
        ${res.map(u => {
          const acc = u.admin?'admin': u.edit?'edit':'readonly';
          const init = (u.name||u.email).split(' ').map(w=>w[0]).join('').toUpperCase().slice(0,2);
          const grpLabel = (u.group && u.group !== acc) ? groupName(u.group) : null;
          return `<div style="display:flex;align-items:center;gap:10px;padding:12px 14px;background:var(--bg);border-radius:9px;border:1.5px solid var(--border);">
            <div style="width:36px;height:36px;border-radius:50%;background:var(--green-light);display:flex;align-items:center;justify-content:center;font-family:'Barlow Condensed',sans-serif;font-weight:900;font-size:14px;color:var(--green);flex-shrink:0;">${init}</div>
            <div style="flex:1;min-width:0;">
              <div style="font-weight:700;font-size:14px;">${u.name||'—'}</div>
              <div style="font-size:11px;color:var(--text-dim);">${u.email} · <span style="font-weight:600">${u.role||'Member'}</span></div>
            </div>
            <div style="display:flex;flex-direction:column;align-items:flex-end;gap:3px;flex-shrink:0;">
              <span style="font-size:10px;font-weight:800;color:${accessColor[acc]||'var(--text-dim)'};background:var(--bg);border:1.5px solid var(--border);padding:2px 8px;border-radius:10px;white-space:nowrap;">${accessLabel[acc]||acc}</span>
              ${grpLabel ? '<span style="font-size:9px;color:var(--green);background:var(--green-light);padding:1px 6px;border-radius:8px;white-space:nowrap;">🔐 ' + grpLabel + '</span>' : ''}
            </div>
            <button class="actbtn" onclick='openUserModal(${JSON.stringify(u).replace(/'/g,"&#39;")})'>Edit</button>
          </div>`;
        }).join('')}
      </div>
      <p style="font-size:11px;color:var(--text-dim);margin-top:12px;">Users are managed in the <strong>Users</strong> sheet. Changes take effect immediately — no redeploy needed.</p>
    `;
    return;
  }
}

let editingUser = null;

// Let current user edit their own name/role
function openEditMe() {
  if (!me) return;
  openUserModal({ email: me.email, name: me.name, role: me.role, admin: me.admin, edit: me.edit });
}

function openUserModal(u) {
  editingUser = u;
  const isNew = !u;
  const viewerIsAdmin = me && me.admin;
  const isSelf = u && me && u.email === me.email;

  document.getElementById('um-title').textContent = isNew ? 'Add User' : (isSelf ? 'My Profile' : 'Edit User');
  document.getElementById('um-email').value    = u ? u.email : '';
  document.getElementById('um-email').disabled = !isNew;
  document.getElementById('um-name').value     = u ? (u.name||'') : '';
  document.getElementById('um-name').disabled  = !viewerIsAdmin;
  populateRoleSelect();
  document.getElementById('um-role').value     = u ? (u.role||'Member') : 'Member';
  document.getElementById('um-role').disabled  = !viewerIsAdmin;

  const accRow  = document.getElementById('um-access-row');
  const accNote = document.getElementById('um-access-note');
  const grpRow  = document.getElementById('um-group-row');
  if (viewerIsAdmin) {
    accRow.style.display  = 'block';
    accNote.style.display = 'none';
    if (grpRow) grpRow.style.display = 'block';
    const acc = u ? (u.admin?'admin': u.edit?'edit':'readonly') : 'readonly';
    document.getElementById('um-access').value = acc;
    // Populate group dropdown async
    populateGroupSelect(u ? (u.group||'') : '');
  } else {
    accRow.style.display  = 'none';
    if (grpRow) grpRow.style.display = 'none';
    accNote.style.display = 'block';
  }

  // Only admins can save; non-admins see read-only profile info
  const saveBtn = document.getElementById('user-modal').querySelector('.mprimary');
  if (saveBtn) saveBtn.style.display = viewerIsAdmin ? '' : 'none';
  const cancelBtn = document.getElementById('user-modal').querySelector('.msecondary');
  if (cancelBtn) cancelBtn.textContent = viewerIsAdmin ? 'Cancel' : 'Close';

  const delBtn = document.getElementById('um-del-btn');
  delBtn.style.display = (viewerIsAdmin && !isNew && !isSelf) ? 'block' : 'none';

  const _btf_user_modal = document.getElementById('user-modal'); bringToFront(_btf_user_modal); _btf_user_modal.classList.add('open');
}

function closeUserModal() {
  document.getElementById('user-modal').classList.remove('open');
  editingUser = null;
}

async function confirmEditUser() {
  const email  = (document.getElementById('um-email').value||'').trim().toLowerCase();
  const name   = document.getElementById('um-name').value.trim();
  const role   = document.getElementById('um-role').value;
  if (!email) { showToast('Email is required', 'warn'); return; }

  const payload = { email, name, role };
  // Only include access + group if the viewer is an admin
  if (me && me.admin) {
    const grpSel = document.getElementById('um-group');
    const selectedGroup = grpSel ? grpSel.value : '';
    const builtinIds = ['admin', 'edit', 'readonly'];
    if (builtinIds.includes(selectedGroup)) {
      // Builtin group selected — set access to match and clear group column
      // so verifyToken derives permissions from access level cleanly
      payload.access = selectedGroup;
      payload.group  = '';
    } else {
      // Custom group or "use default" — keep access dropdown value, set group
      payload.access = document.getElementById('um-access').value;
      payload.group  = selectedGroup;
    }
  }

  const btn = document.getElementById('user-modal').querySelector('.mprimary');
  btnLoading(btn, true);
  const isNew  = !editingUser;
  // Always use updateUser - backend already exists. Access field simply won't be sent for non-admins.
  const action = isNew ? 'addUser' : 'updateUser';
  const res = await api(action, payload);
  btnLoading(btn, false);

  if (res.error) { showToast('Error: ' + res.error, 'err'); return; }
  closeUserModal();
  showToast(isNew ? 'User added ✓' : 'User updated ✓');
  await loadAdminTab('users', 'admin-panel-body');
}

async function deleteUserConfirm() {
  if (!editingUser) return;
  if (!confirm('Remove ' + (editingUser.name||editingUser.email) + '\'s access? They will no longer be able to sign in.')) return;
  const btn = document.getElementById('um-del-btn');
  btnLoading(btn, true);
  const res = await api('deleteUser', { email: editingUser.email });
  btnLoading(btn, false);
  if (res.error) { showToast('Error: ' + res.error, 'err'); return; }
  closeUserModal();
  showToast('User removed ✓');
  await loadAdminTab('users', 'admin-panel-body');
}

// ════════════════════════════════════════════════════════
//  PACKAGE MANAGER (admin tab)
// ════════════════════════════════════════════════════════
let editPkgId = null;

function openPackagesPanel() {
  openAdminModal('packages');
}

function renderPackageManager() {
  const body = document.getElementById('adm-body');
  // Use TE[] which is rebuilt from loaded packages — includes diamond and custom emoji

  const rows = packages.length ? packages.slice().sort((a,b) => (b.amount||0) - (a.amount||0)).map(function(p) {
    const usageCount = seasonEntries.filter(function(s) {
      return s.tier === p.tier && +s.amount === +p.amount && !s.customPackage;
    }).length;
    return '<div class="pkg-row">'
      + '<div style="display:flex;align-items:flex-start;gap:10px;flex:1;min-width:0;">'
      +   '<div class="tdot ' + (p.tier||'gold') + '" style="flex-shrink:0;margin-top:3px;"></div>'
      +   '<div style="flex:1;min-width:0;">'
      +     '<div style="display:flex;align-items:baseline;gap:8px;flex-wrap:wrap;">'
      +       '<span style="font-weight:800;font-size:15px;">' + p.name + '</span>'
      +       '<span style="font-size:11px;color:var(--text-dim);">' + (TE[p.tier]||'') + ' ' + (TL[p.tier]||p.tier) + '</span>'
      +       (p.active === 'false' ? '<span style="font-size:9px;background:#f3f4f6;color:#6b7280;padding:1px 6px;border-radius:8px;font-weight:700;">Inactive</span>' : '')
      +     '</div>'
      +     (p.description ? '<div style="font-size:12px;color:var(--text-dim);margin-top:2px;">' + p.description + '</div>' : '')
      +     (p.benefits ? '<div style="font-size:11px;color:var(--green);margin-top:3px;">✓ ' + p.benefits + '</div>' : '')
      +   '</div>'
      + '</div>'
      + '<div style="display:flex;flex-direction:column;align-items:flex-end;gap:4px;flex-shrink:0;">'
      +   '<div style="font-size:16px;font-weight:900;color:var(--text);">$' + Number(p.amount||0).toLocaleString('en-AU') + '</div>'
      +   '<div style="font-size:10px;color:var(--text-dim);">' + usageCount + ' use' + (usageCount!==1?'s':'') + '</div>'
      +   (me && me.edit ? '<button class="actbtn" onclick="openPkgModal(\'' + p.id + '\')">Edit</button>' : '')
      + '</div>'
      + '</div>';
  }).join('') : '<div style="color:var(--text-dim);font-size:13px;padding:16px 0;text-align:center;">No packages yet. Add your first one below.</div>';

  body.innerHTML = '<div style="padding-bottom:4px;">'
    + (me && me.edit ? '<button class="ss-add-btn" style="margin-bottom:14px;width:100%;text-align:center;" onclick="openPkgModal(null)">+ Add New Package</button>' : '')
    + '<div style="display:flex;flex-direction:column;gap:8px;">' + rows + '</div>'
    + '<div style="margin-top:16px;padding:12px;background:var(--yellow-pale);border:1.5px solid var(--yellow-dark);border-radius:9px;font-size:12px;color:#6b4900;">'
    +   '<strong>💡 Tip:</strong> Packages define your standard sponsorship tiers. When adding a sponsor to a season, you\'ll pick from these packages — the amount auto-fills. Use <em>Custom/Other</em> for one-off arrangements.'
    + '</div>'
    + '</div>';
}

const DEFAULT_PKG_EMOJI = {diamond:'💎',gold:'🥇',silver:'🥈',bronze:'🥉',community:'🤝',custom:'⭐'};

function onPkgTierChange() {
  const tier = document.getElementById('pf-tier').value;
  const emojiField = document.getElementById('pf-emoji');
  // Only auto-fill emoji if the field is empty — never overwrite a saved custom emoji
  if (!emojiField.value) {
    emojiField.value = DEFAULT_PKG_EMOJI[tier] || '⭐';
  }
}

function openPkgModal(pkgId) {
  editPkgId = pkgId;
  const pkg = pkgId ? packages.find(function(p){ return p.id === pkgId; }) : null;
  document.getElementById('pkg-m-title').textContent = pkg ? 'Edit Package / Tier' : 'Add Package / Tier';
  const _emojiToRestore = pkg ? (pkg.emoji || DEFAULT_PKG_EMOJI[pkg.tier] || '') : '🥇';
  document.getElementById('pf-tier').value     = pkg ? (pkg.tier||'gold') : 'gold';
  document.getElementById('pf-emoji').value    = _emojiToRestore; // set AFTER tier so it's never overwritten
  document.getElementById('pf-amount').value   = pkg ? pkg.amount    : '';
  document.getElementById('pf-desc').value     = pkg ? pkg.description : '';
  document.getElementById('pf-benefits').value = pkg ? pkg.benefits  : '';
  document.getElementById('pkg-m-del').style.display = pkg ? 'block' : 'none';
  const _btf_pkg_modal = document.getElementById('pkg-modal'); bringToFront(_btf_pkg_modal); _btf_pkg_modal.classList.add('open');
}

function closePkgModal() {
  document.getElementById('pkg-modal').classList.remove('open');
  editPkgId = null;
}

async function savePkg() {
  const tier = document.getElementById('pf-tier').value;
  if (!tier) { showToast('Select a tier', 'warn'); return; }
  const data = {
    id:          editPkgId || '',
    name:        cap(tier), // name = tier capitalised
    tier,
    emoji:       document.getElementById('pf-emoji').value.trim() || DEFAULT_PKG_EMOJI[tier] || '',
    amount:      +document.getElementById('pf-amount').value || 0,
    description: document.getElementById('pf-desc').value.trim(),
    benefits:    document.getElementById('pf-benefits').value.trim(),
    active:      'true',
  };
  btnLoading(document.getElementById('pkg-m-save'), true);
  const res = await api('savePackage', { data, isNew: !editPkgId });
  btnLoading(document.getElementById('pkg-m-save'), false);
  if (res.error) { showToast('Error: ' + res.error, 'err'); return; }
  if (!editPkgId) { data.id = res.id; packages.push(data); }
  else { const idx = packages.findIndex(function(p){ return p.id === editPkgId; }); if (idx>=0) packages[idx] = {...packages[idx], ...data}; }
  rebuildTierLookups();
  populatePackageSelect();
  closePkgModal();
  renderPackageManager();
  showToast(editPkgId ? 'Package updated ✓' : 'Package added ✓');
}

async function deletePkg() {
  if (!editPkgId) return;
  const pkg = packages.find(function(p){ return p.id === editPkgId; });
  const inUse = seasonEntries.filter(function(s){ return s.tier === (pkg&&pkg.tier) && +s.amount === +(pkg&&pkg.amount) && !s.customPackage; }).length;
  if (inUse > 0 && !confirm('This package is used by ' + inUse + ' sponsor entry/entries. Delete anyway?')) return;
  btnLoading(document.getElementById('pkg-m-del'), true);
  const res = await api('deletePackage', { id: editPkgId });
  btnLoading(document.getElementById('pkg-m-del'), false);
  if (res.error) { showToast('Error: ' + res.error, 'err'); return; }
  packages = packages.filter(function(p){ return p.id !== editPkgId; });
  rebuildTierLookups();
  populatePackageSelect();
  closePkgModal();
  renderPackageManager();
  showToast('Package deleted');
}

// ════════════════════════════════════════════════════════
//  ROLES
// ════════════════════════════════════════════════════════
const DEFAULT_ROLES = ['President','Vice President','Treasurer','Secretary','Registrar','Committee Member','Coach','Team Manager','Volunteer','Administrator','Member'];
function getRoles() { try { return JSON.parse(localStorage.getItem('kjfc_roles')) || DEFAULT_ROLES; } catch { return DEFAULT_ROLES; } }
function saveRoles(r) { localStorage.setItem('kjfc_roles', JSON.stringify(r)); }
function populateRoleSelect() { const s=document.getElementById('um-role'); s.innerHTML=getRoles().map(r=>`<option>${r}</option>`).join(''); }
function openManageRoles() { renderRolesList(); const _btf_roles_modal = document.getElementById('roles-modal'); bringToFront(_btf_roles_modal); _btf_roles_modal.classList.add('open'); }
function closeManageRoles() { document.getElementById('roles-modal').classList.remove('open'); populateRoleSelect(); }
function renderRolesList() {
  const roles=getRoles();
  document.getElementById('roles-list').innerHTML = roles.map((r,i)=>`
    <div class="role-tag"><span>${r}</span>
      ${DEFAULT_ROLES.includes(r)?'<span style="font-size:9px;color:var(--text-dim);margin-left:auto">default</span>':
        `<button onclick="deleteRole(${i})" style="background:none;border:none;color:var(--red);cursor:pointer;font-size:13px;margin-left:auto;">✕</button>`}
    </div>`).join('');
}
function addCustomRole() { const v=document.getElementById('new-role-input').value.trim(); if(!v) return; const r=getRoles(); if(!r.includes(v)) r.push(v); saveRoles(r); document.getElementById('new-role-input').value=''; renderRolesList(); showToast('Role added ✓'); }
function deleteRole(i) { const r=getRoles(); if(DEFAULT_ROLES.includes(r[i])) return; r.splice(i,1); saveRoles(r); renderRolesList(); }

// ════════════════════════════════════════════════════════
//  ACCESS GROUPS — permission-based dashboard visibility
// ════════════════════════════════════════════════════════

// All dashboards + sub-permissions available for group configuration
// ── DASHBOARD REGISTRY ────────────────────────────────────────────────
// Single source of truth for all dashboards and their permission structure.
// To add a new dashboard: add an entry to DASHBOARDS, update DASHBOARD_PERMS,
// and call canSeeDash / canSeePrivate at render time. No other changes needed.
const DASHBOARDS = [
  { id: 'sponsors',    label: 'Sponsorship', icon: '🏆' },
  { id: 'recruitment', label: 'Recruitment', icon: '🏉' },
  { id: 'admin',       label: 'Admin Panel', icon: '⚙️' },
];

const DASHBOARD_PERMS = [
  // ── Sponsorship ──────────────────────────────────────────────────────
  { key: 'view.sponsors',      label: 'View',            icon: '👁',  desc: 'Access the Sponsorship dashboard',         section: 'Sponsorship' },
  { key: 'edit.sponsors',      label: 'Edit',            icon: '✏️',  desc: 'Add/edit sponsors, packages',              section: 'Sponsorship' },
  { key: 'private.sponsors',   label: 'Full detail',     icon: '🔒',  desc: 'See contact details (phone, email, address). Without this, only sponsor name and tier are visible.', section: 'Sponsorship', privacy: true },
  // ── Recruitment ──────────────────────────────────────────────────────
  { key: 'view.recruitment',   label: 'View',            icon: '👁',  desc: 'Access the Recruitment dashboard',         section: 'Recruitment' },
  { key: 'edit.recruitment',   label: 'Edit',            icon: '✏️',  desc: 'Import players, manage teams',             section: 'Recruitment' },
  { key: 'private.recruitment',label: 'Full detail',     icon: '🔒',  desc: 'See DOB, address, parent contacts, medical, emergency contacts. Without this, only name, school, age group are visible.', section: 'Recruitment', privacy: true },
  // ── Admin ─────────────────────────────────────────────────────────────
  { key: 'view.admin',         label: 'View',            icon: '👁',  desc: 'Access the Admin panel (users, groups, logs)', section: 'Admin' },
  // Future dashboards: add rows here following the same pattern
];

// Built-in groups — defaults shown until admin saves changes in AppSettings
const BUILTIN_GROUP_IDS = ['admin', 'edit', 'readonly'];
const BUILTIN_GROUP_DEFAULTS_FE = [
  { id:'admin',    name:'Admin',     builtin:true, perms:{'view.sponsors':true,'edit.sponsors':true,'private.sponsors':true,'view.recruitment':true,'edit.recruitment':true,'private.recruitment':true,'view.admin':true} },
  { id:'edit',     name:'Can Edit',  builtin:true, perms:{'view.sponsors':true,'edit.sponsors':true,'private.sponsors':true,'view.recruitment':false,'edit.recruitment':false,'private.recruitment':false,'view.admin':false} },
  { id:'readonly', name:'Read Only', builtin:true, perms:{'view.sponsors':true,'edit.sponsors':false,'private.sponsors':false,'view.recruitment':false,'edit.recruitment':false,'private.recruitment':false,'view.admin':false} },
];

let _groupsCache = null; // { builtin:[], custom:[] }
let _editingGroup = null; // group being edited in modal

// ── Derive dashboards from me object ──────────────────────────────
function _buildMeDashboards() {
  // me.dashboards is set from the backend on login and persisted in localStorage.
  // If it's already an array (even empty), trust it — the backend controls visibility.
  // Only fall back to legacy hardcode for genuinely stale sessions with no dashboards key.
  if (!me) return;
  if (Array.isArray(me.dashboards)) return; // already set by backend — do not override
  // Legacy fallback for stale sessions pre-group-support
  me.dashboards = ['sponsors'];
  if (me.edit || me.admin) { me.dashboards.push('sponsors.edit', 'sponsors.private'); }
  if (me.admin) { me.dashboards.push('recruitment','recruitment.edit','recruitment.private','admin'); }
}

// Returns true if the current user can see private/contact details for a context
// context: 'sponsors' | 'recruitment' (matches dashboard id)
function canSeePrivate(context) {
  if (!me) return false;
  if (!me.dashboards) _buildMeDashboards();
  return me.dashboards.indexOf(context + '.private') >= 0;
}

function canSeeDash(dash) {
  if (!me) return false;
  if (!me.dashboards) _buildMeDashboards();
  return me.dashboards.indexOf(dash) >= 0;
}

// ── Populate group select in user modal ───────────────────────────
async function populateGroupSelect(selectedGroupId) {
  const sel = document.getElementById('um-group');
  if (!sel) return;
  const groups = await _loadGroups();
  // Only show custom groups — builtin access levels are set via the Access Level dropdown above
  const custom = groups.custom || [];
  sel.innerHTML = '<option value="">— Use Access Level default —</option>'
    + custom.map(g => '<option value="' + g.id + '"' + (g.id===selectedGroupId?' selected':'') + '>'
        + g.name + '</option>').join('');
}

// ── Load groups (cached per session) ─────────────────────────────
async function _loadGroups() {
  if (_groupsCache) return _groupsCache;
  try {
    const res = await api('getGroups');
    if (!res.error) {
      // Merge stored builtin overrides into frontend defaults
      const storedBuiltins = res.builtin || [];
      const mergedBuiltins = BUILTIN_GROUP_DEFAULTS_FE.map(def => {
        const stored = storedBuiltins.find(s => s.id === def.id);
        return stored ? Object.assign({}, def, { perms: Object.assign({}, def.perms, stored.perms), name: stored.name || def.name }) : def;
      });
      _groupsCache = { builtin: mergedBuiltins, custom: res.custom||[] };
    } else {
      _groupsCache = { builtin: BUILTIN_GROUP_DEFAULTS_FE, custom: [] };
    }
  } catch(e) {
    _groupsCache = { builtin: BUILTIN_GROUP_DEFAULTS_FE, custom: [] };
  }
  return _groupsCache;
}

// ── Render the Groups tab in admin panel ─────────────────────────
async function renderGroupsTab(containerId) {
  const body = document.getElementById(containerId || 'admin-panel-body');
  if (!body) return;
  body.innerHTML = '<div style="color:var(--text-dim);font-size:13px;padding:12px 0;">Loading…</div>';

  // Load groups + user list in parallel
  const [groups, usersRes] = await Promise.all([_loadGroups(), api('getUsers')]);
  const users = Array.isArray(usersRes) ? usersRes : [];
  _groupsRenderCache = { groups, users };

  body.innerHTML = '<div style="max-width:820px;">'
    // ── Explainer ──────────────────────────────────────────────
    + '<div style="background:#fffbeb;border:1.5px solid #f59e0b;border-radius:10px;padding:14px 16px;margin-bottom:22px;font-size:13px;line-height:1.6;color:#92400e;">'
    + '<strong>Two separate settings control what each user can do:</strong>'
    + '<ul style="margin:8px 0 4px 0;padding-left:18px;">'
    + '<li style="margin-bottom:4px;"><strong>Access Level</strong> (set per user in Manage Users) — controls what they can <em>save or change</em>. '
    + '<strong>Admin</strong> = full control incl. user management. <strong>Can Edit</strong> = can add/edit data on any dashboard they can see. <strong>View Only</strong> = read-only, no changes.</li>'
    + '<li><strong>Access Group</strong> (below) — controls which <em>tabs are visible</em> and whether private details (phone, address, DOB) are shown. '
    + 'Built-in groups set the default visibility for each access level. Custom groups let you give an individual user a different set of visible tabs — e.g. a Coach who can see Recruitment but not Sponsors.</li>'
    + '</ul>'
    + '<strong>The Access Group dropdown in Manage Users only shows custom groups</strong> — it only matters if you need to give one person a different view to everyone else at their access level. Most users just use the built-in default.'
    + '</div>'

    // ── Built-in groups ─────────────────────────────────────────
    + '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;">'
    + '<div>'
    + '<div style="font-size:10px;font-weight:800;text-transform:uppercase;letter-spacing:.7px;color:var(--text-dim);">Built-in Groups</div>'
    + '<div style="font-size:11px;color:var(--text-dim);margin-top:2px;">Edit to change visibility for all users at that access level.</div>'
    + '</div>'
    + '</div>'
    + '<div style="display:flex;flex-direction:column;gap:10px;margin-bottom:28px;">'
    + groups.builtin.map(g => _renderGroupCard(g, users)).join('')
    + '</div>'

    // ── Custom groups ────────────────────────────────────────────
    + '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;">'
    + '<div>'
    + '<div style="font-size:10px;font-weight:800;text-transform:uppercase;letter-spacing:.7px;color:var(--text-dim);">Custom Groups</div>'
    + '<div style="font-size:11px;color:var(--text-dim);margin-top:2px;">Assign to individual users to override their default access level visibility.</div>'
    + '</div>'
    + '<button class="mprimary" style="padding:6px 14px;font-size:12px;" onclick="openGroupModal(null)">+ New Group</button>'
    + '</div>'
    + (groups.custom.length === 0
      ? '<div style="color:var(--text-dim);font-size:13px;background:var(--bg);border:1.5px dashed var(--border);border-radius:10px;padding:28px;text-align:center;line-height:1.7;">'
        + '<div style="font-size:22px;margin-bottom:8px;">🔐</div>'
        + '<strong>No custom groups yet.</strong><br>'
        + 'Examples: a <em>Coach</em> group (Recruitment view, no personal details), a <em>Developer</em> group (all dashboards including hidden ones).'
        + '</div>'
      : '<div style="display:flex;flex-direction:column;gap:10px;">' + groups.custom.map(g => _renderGroupCard(g, users)).join('') + '</div>')
    + '</div>';
}

let _groupsRenderCache = null;

function _renderGroupCard(g, users) {
  users = users || (_groupsRenderCache && _groupsRenderCache.users) || [];

  // Count users affected by this group
  const directCount = users.filter(u => u.group === g.id).length;
  // For builtins: count users with matching access level AND no custom group
  const inheritCount = g.builtin ? users.filter(u => u.access === g.id && !u.group).length : 0;
  const totalAffected = directCount + inheritCount;

  // Build permission matrix by section
  const sections = {};
  DASHBOARD_PERMS.forEach(p => {
    if (!sections[p.section]) sections[p.section] = [];
    sections[p.section].push(p);
  });

  const sectionHtml = Object.entries(sections).map(([sec, perms]) => {
    const dashObj = DASHBOARDS.find(d => d.id === sec.toLowerCase() || d.label === sec);
    const viewKey = 'view.' + (dashObj ? dashObj.id : sec.toLowerCase());
    const dashVisible = g.perms && g.perms[viewKey];
    return '<div style="display:flex;align-items:center;padding:8px 0;border-bottom:1px solid var(--border);min-height:40px;">'
      // Dashboard label
      + '<div style="width:120px;flex-shrink:0;">'
      +   '<div style="font-size:11px;font-weight:800;">' + (dashObj ? dashObj.icon + ' ' : '') + sec + '</div>'
      + '</div>'
      // Permission chips row
      + '<div style="display:flex;flex-wrap:wrap;gap:5px;flex:1;">'
      + (dashVisible
          ? perms.map(p => {
              const on = g.perms && g.perms[p.key];
              const isPrivacy = p.privacy;
              return '<span title="' + p.desc + '" style="font-size:10px;padding:3px 9px;border-radius:8px;font-weight:700;cursor:default;display:inline-flex;align-items:center;gap:3px;'
                + (on
                    ? (isPrivacy ? 'background:#ede9fe;color:#6d28d9;' : 'background:var(--green-light);color:var(--green);')
                    : (isPrivacy ? 'background:#f5f3ff;color:#c4b5fd;' : 'background:#f3f4f6;color:#9ca3af;'))
                + '">' + p.icon + ' ' + p.label + '</span>';
            }).join('')
          : '<span style="font-size:11px;color:#9ca3af;font-style:italic;">Hidden — not accessible</span>')
      + '</div>'
      + '</div>';
  }).join('');

  const accentCol = g.id==='admin' ? 'var(--green)' : g.id==='edit' ? '#0d47a1' : g.id==='readonly' ? '#6b7280' : '#7c3aed';
  const userBadge = totalAffected > 0
    ? '<span style="font-size:10px;background:#f3f4f6;color:#6b7280;padding:2px 8px;border-radius:8px;font-weight:700;">'
      + totalAffected + ' user' + (totalAffected !== 1 ? 's' : '')
      + (inheritCount > 0 ? ' (default for ' + inheritCount + ')' : '')
      + '</span>'
    : '<span style="font-size:10px;color:var(--text-dim);">No users</span>';

  return '<div style="background:#fff;border:1.5px solid var(--border);border-left:4px solid '+ accentCol +';border-radius:10px;overflow:hidden;">'
    + '<div style="display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:var(--bg);border-bottom:1px solid var(--border);">'
    +   '<div style="display:flex;align-items:center;gap:8px;flex:1;min-width:0;">'
    +     '<div style="font-size:15px;font-weight:900;">' + _escHtml(g.name) + '</div>'
    +     (g.builtin ? '<span style="font-size:9px;background:#fff;border:1px solid var(--border);color:var(--text-dim);padding:1px 7px;border-radius:6px;font-weight:700;">built-in</span>' : '')
    +     userBadge
    +   '</div>'
    +   '<button class="actbtn" style="margin-left:10px;flex-shrink:0;" onclick="openGroupModal(' + _escHtml(JSON.stringify(JSON.stringify(g))) + ')">Edit</button>'
    + '</div>'
    + '<div style="padding:4px 16px 8px;">' + sectionHtml + '</div>'
    + '</div>';
}

function _escHtml(s) {
  return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// ── Group edit modal ──────────────────────────────────────────────
async function openGroupModal(groupJson) {
  _editingGroup = groupJson ? JSON.parse(groupJson) : { id: '', name: '', perms: {}, builtin: false };

  const overlay = document.getElementById('group-modal');
  if (!overlay) return;

  const isBuiltin = !!_editingGroup.builtin;
  const isNew = !_editingGroup.id;
  document.getElementById('gm-title').textContent = isNew ? 'New Group' : ('Edit: ' + _editingGroup.name);

  // Name field locked for builtins
  const nameField = document.getElementById('gm-name');
  nameField.value = _editingGroup.name || '';
  nameField.disabled = isBuiltin;
  nameField.style.opacity = isBuiltin ? '.6' : '1';

  const builtinNote = document.getElementById('gm-builtin-note');
  if (builtinNote) {
    builtinNote.style.display = isBuiltin ? 'block' : 'none';
    if (isBuiltin) {
      builtinNote.innerHTML = '&zwj;&#x26A0;&#xFE0F; <strong>Built-in group &mdash; name is fixed but permissions are fully editable.</strong> '
        + 'Changes apply immediately to all users at the <strong>' + _escHtml(_editingGroup.name) + '</strong> access level who haven\'t been assigned a custom group.';
    }
  }

  // Render permission sections, one card per dashboard
  const sections = {};
  DASHBOARD_PERMS.forEach(p => {
    if (!sections[p.section]) sections[p.section] = [];
    sections[p.section].push(p);
  });

  document.getElementById('gm-perms').innerHTML = Object.entries(sections).map(([sec, perms]) => {
    const dashObj  = DASHBOARDS.find(d => d.label === sec || d.id === sec.toLowerCase());
    const dashIcon = dashObj ? dashObj.icon : '';
    const dashId   = dashObj ? dashObj.id : sec.toLowerCase();
    const viewPerm = perms.find(p => p.key === 'view.' + dashId);
    const hasView  = viewPerm && _editingGroup.perms && _editingGroup.perms[viewPerm.key];
    const subPerms = perms.filter(p => p !== viewPerm);

    return '<div style="margin-bottom:12px;border:1.5px solid var(--border);border-radius:10px;overflow:hidden;">'
      + '<div style="background:var(--bg);padding:10px 14px;border-bottom:1.5px solid var(--border);display:flex;align-items:center;gap:10px;">'
      +   '<span style="font-size:13px;font-weight:900;flex:1;">' + dashIcon + ' ' + sec + '</span>'
      +   (viewPerm
          ? '<label style="display:flex;align-items:center;gap:7px;cursor:pointer;'
            + 'background:' + (hasView ? 'var(--green-light)' : '#f3f4f6') + ';'
            + 'border:1.5px solid ' + (hasView ? 'var(--green)' : 'var(--border)') + ';'
            + 'border-radius:7px;padding:5px 11px;" id="gm-viewlabel-' + dashId + '">'
            + '<input type="checkbox" class="gm-check" data-perm="' + viewPerm.key + '" data-dash="' + dashId + '" '
            + (hasView ? 'checked' : '')
            + ' onchange="_gmToggleView(\'' + dashId + '\',this.checked)">'
            + '<span class="gm-check-box"></span>'
            + '<span id="gm-viewspan-' + dashId + '" style="font-size:12px;font-weight:800;'
            + 'color:' + (hasView ? 'var(--green)' : '#9ca3af') + ';">&#x1F441; Visible</span>'
            + '</label>'
          : '')
      + '</div>'
      + '<div id="gm-subperms-' + dashId + '" style="padding:10px 14px;display:' + (hasView ? 'block' : 'none') + ';">'
      + (subPerms.length === 0
          ? '<div style="font-size:11px;color:var(--text-dim);padding:4px 0;">No additional permissions for this dashboard.</div>'
          : subPerms.map(p => {
              const isOn = _editingGroup.perms && _editingGroup.perms[p.key];
              const isPrivacy = !!p.privacy;
              const accentColor = isPrivacy ? '#7c3aed' : 'var(--green)';
              const labelBg   = isPrivacy ? (isOn ? '#ede9fe' : 'var(--bg)') : (isOn ? 'var(--green-light)' : 'var(--bg)');
              const labelBord = isPrivacy ? (isOn ? '#a78bfa' : 'var(--border)') : (isOn ? 'var(--green)' : 'var(--border)');
              const indent    = isPrivacy ? 'margin-left:16px;' : '';
              return '<label style="display:flex;align-items:flex-start;gap:10px;padding:9px 11px;border-radius:8px;cursor:pointer;'
                + 'background:' + labelBg + ';border:1.5px solid ' + labelBord + ';margin-bottom:6px;' + indent + '">'
                + '<input type="checkbox" class="gm-check' + (isPrivacy ? ' purple' : '') + '" data-perm="' + p.key + '" data-dash="' + dashId + '" '
                + (isOn ? 'checked' : '')
                + ' onchange="_gmSyncLabel(this)">'
                + '<span class="gm-check-box" style="margin-top:2px;"></span>'
                + '<div style="flex:1;">'
                + '<div style="font-size:13px;font-weight:700;">' + p.icon + ' ' + p.label + '</div>'
                + '<div style="font-size:11px;color:var(--text-dim);margin-top:2px;line-height:1.45;">' + p.desc + '</div>'
                + '</div>'
                + '</label>';
            }).join(''))
      + '</div></div>';
  }).join('');

  const delBtn = document.getElementById('gm-del');
  if (delBtn) delBtn.style.display = (!isNew && !isBuiltin) ? 'block' : 'none';

  bringToFront(overlay);
  overlay.classList.add('open');
}

// Toggle visibility section and collapse/show sub-perms
function _gmToggleView(dashId, isOn) {
  const lbl  = document.getElementById('gm-viewlabel-' + dashId);
  const span = document.getElementById('gm-viewspan-' + dashId);
  const sub  = document.getElementById('gm-subperms-' + dashId);
  if (lbl)  { lbl.style.background = isOn ? 'var(--green-light)' : '#f3f4f6'; lbl.style.borderColor = isOn ? 'var(--green)' : 'var(--border)'; }
  if (span) { span.style.color = isOn ? 'var(--green)' : '#9ca3af'; }
  if (sub)  { sub.style.display = isOn ? 'block' : 'none'; }
  if (!isOn && sub) {
    sub.querySelectorAll('input[type=checkbox]').forEach(cb => { cb.checked = false; _gmSyncLabel(cb); });
  }
}

// Sync a sub-perm label visual state to its checkbox
function _gmSyncLabel(cb) {
  const label = cb.closest('label');
  if (!label) return;
  const permDef = DASHBOARD_PERMS.find(p => p.key === cb.dataset.perm) || {};
  const isPrivacy = !!permDef.privacy;
  const isOn = cb.checked;
  label.style.background  = isOn ? (isPrivacy ? '#ede9fe' : 'var(--green-light)') : 'var(--bg)';
  label.style.borderColor = isOn ? (isPrivacy ? '#a78bfa' : 'var(--green)')        : 'var(--border)';
}

function closeGroupModal() {
  const overlay = document.getElementById('group-modal');
  if (overlay) overlay.classList.remove('open');
  _editingGroup = null;
}

async function saveGroupModal() {
  const _isSavingBuiltin = !!_editingGroup.builtin;
  const name = _isSavingBuiltin
    ? _editingGroup.name  // preserve builtin name — field is disabled
    : document.getElementById('gm-name').value.trim();
  if (!name) { showToast('Group name required', 'warn'); return; }
  const perms = {};
  document.querySelectorAll('#gm-perms input[type=checkbox]').forEach(cb => {
    perms[cb.dataset.perm] = cb.checked;
  });
  const g = { id: _editingGroup.id || '', name, perms, builtin: !!_editingGroup.builtin };
  const btn = document.getElementById('gm-save');
  btnLoading(btn, true);
  const res = await api('saveGroup', { group: g });
  btnLoading(btn, false);
  if (res.error) { showToast('Error: ' + res.error, 'err'); return; }
  showToast('Group saved ✓');
  _groupsCache = null; // invalidate cache
  closeGroupModal();
  renderGroupsTab();
  // Repopulate group select in any open user modal
  const umGroup = document.getElementById('um-group');
  if (umGroup) populateGroupSelect(umGroup.value);
}

async function deleteGroupModal() {
  if (!_editingGroup || !_editingGroup.id) return;
  if (!confirm('Delete group "' + _editingGroup.name + '"?\n\nUsers assigned to this group will fall back to their Access Level defaults.')) return;
  const btn = document.getElementById('gm-del');
  btnLoading(btn, true);
  const res = await api('deleteGroup', { id: _editingGroup.id });
  btnLoading(btn, false);
  if (res.error) { showToast('Error: ' + res.error, 'err'); return; }
  showToast('Group deleted');
  _groupsCache = null;
  closeGroupModal();
  renderGroupsTab();
  const umGroup = document.getElementById('um-group');
  if (umGroup) populateGroupSelect(umGroup.value);
}

// ════════════════════════════════════════════════════════
//  BUTTON LOADING
// ════════════════════════════════════════════════════════
function btnLoading(el, isLoading) {
  if (!el) return;
  if (isLoading) { el.classList.add('btn-loading'); el.disabled=true; }
  else           { el.classList.remove('btn-loading'); el.disabled=false; }
}

// ════════════════════════════════════════════════════════
//  SYNC STATE / TOAST
// ════════════════════════════════════════════════════════
function setSyncState(state, text) {
  return; // sync-state pill removed
  if (state === 'ok') {
    // (loaded pill removed)
    el.style.color = 'rgba(255,255,255,.45)';
  } else if (state === 'loading') {
    el.textContent = 'Loading…';
    el.style.color = 'rgba(255,255,255,.35)';
  } else if (state === 'err') {
    el.textContent = '⚠ ' + text;
    el.style.color = '#fca5a5';
  } else {
    el.textContent = text || '';
  }
  el.className = 'sync-' + state;
}

function fmt(n)    { return '$' + Number(n).toLocaleString('en-AU'); }

function fmtPhone(p) {
  if (!p) return '—';
  // Strip all spaces and non-digits except leading +
  var s = String(p).trim();
  var digits = s.replace(/\D/g, '');
  // Ensure leading zero for local Australian numbers
  if (digits.length === 9 && !digits.startsWith('0')) digits = '0' + digits;
  // Mobile: 04xx xxx xxx (10 digits starting with 04)
  if (digits.length === 10 && digits.startsWith('04')) {
    return digits.slice(0,4) + ' ' + digits.slice(4,7) + ' ' + digits.slice(7);
  }
  // Local landline: 0x xxxx xxxx (10 digits starting with 0, second digit not 4)
  if (digits.length === 10 && digits.startsWith('0')) {
    return digits.slice(0,2) + ' ' + digits.slice(2,6) + ' ' + digits.slice(6);
  }
  // 1300/1800 freecall: 1xxx xxx xxx
  if (digits.length === 10 && (digits.startsWith('13') || digits.startsWith('18'))) {
    return digits.slice(0,4) + ' ' + digits.slice(4,7) + ' ' + digits.slice(7);
  }
  // International +61
  if (s.startsWith('+61') && digits.length === 11) {
    return '+61 ' + fmtPhone('0' + digits.slice(2));
  }
  // Fallback — return as-is but ensure leading zero preserved
  return s;
}

function cap(s)    { return s ? s.charAt(0).toUpperCase() + s.slice(1) : ''; }
function fmtTime(d){ return d.toLocaleTimeString('en-AU', { hour:'2-digit', minute:'2-digit' }); }
function fmtD(iso) {
  if (!iso) return '';
  try { const d=new Date(iso); return d.toLocaleDateString('en-AU',{day:'2-digit',month:'short',year:'numeric'})+' '+d.toLocaleTimeString('en-AU',{hour:'2-digit',minute:'2-digit'}); }
  catch { return iso; }
}

let _toastTimer;
function showToast(msg, type='') {
  const t=document.getElementById('toast');
  t.textContent=msg; t.className='toast'+(type?' toast-'+type:''); t.classList.add('show');
  clearTimeout(_toastTimer); _toastTimer=setTimeout(()=>t.classList.remove('show'),3200);
}

// ════════════════════════════════════════════════════════
//  INIT
// ════════════════════════════════════════════════════════
function init() {
  loadSession();

  // Wire org modal
  document.getElementById('org-m-save').addEventListener('click', saveOrg);
  document.getElementById('org-m-cancel').addEventListener('click', closeOrgModal);
  document.getElementById('org-mclose').addEventListener('click', closeOrgModal);
  document.getElementById('org-m-del').addEventListener('click', deleteOrg);
  document.getElementById('org-modal').addEventListener('click', e => { if(e.target===document.getElementById('org-modal')) closeOrgModal(); });

  // Wire season modal
  document.getElementById('ss-m-save').addEventListener('click', saveSS);
  document.getElementById('ss-m-cancel').addEventListener('click', closeSSModal);
  document.getElementById('ss-mclose').addEventListener('click', closeSSModal);
  document.getElementById('ss-m-del').addEventListener('click', deleteSS);
  document.getElementById('ss-modal').addEventListener('click', e => { if(e.target===document.getElementById('ss-modal')) closeSSModal(); });

  // Wire contact log modal
  document.getElementById('cl-m-save').addEventListener('click', saveContactLog);
  document.getElementById('cl-m-cancel').addEventListener('click', closeContactLog);
  document.getElementById('cl-mclose').addEventListener('click', closeContactLog);
  document.getElementById('cl-modal').addEventListener('click', e => { if(e.target===document.getElementById('cl-modal')) closeContactLog(); });

  // Wire org detail overlay
  document.getElementById('od-close').addEventListener('click', closeOrgDetail);
  document.getElementById('org-detail-overlay').addEventListener('click', e => { if(e.target===document.getElementById('org-detail-overlay')) closeOrgDetail(); });

  // Wire season year modal
  document.getElementById('reset-modal').addEventListener('click', e => { if(e.target===document.getElementById('reset-modal')) closeResetModal(); });

  // Wire roles modal
  const _nri = document.getElementById('new-role-input');
  if (_nri) _nri.addEventListener('keydown', e => { if(e.key==='Enter') addCustomRole(); });
  const _rm = document.getElementById('roles-modal');
  if (_rm) _rm.addEventListener('click', e => { if(e.target===_rm) closeManageRoles(); });

  // Wire admin modal
  const _am = document.getElementById('admin-modal');
  if (_am) _am.addEventListener('click', e => { if(e.target===_am) closeAdminModal(); });

  // Wire pkg modal
  const _pm = document.getElementById('pkg-modal');
  if (_pm) _pm.addEventListener('click', e => { if(e.target===_pm) closePkgModal(); });

  // Hide loading screen
  setTimeout(() => {
    const ls = document.getElementById('loading-screen');
    ls.classList.add('fade');
    setTimeout(() => { ls.style.display='none'; }, 500);
  }, 1200);

  if (token && me) {
    showApp();
  } else {
    document.getElementById('login-view').style.display='flex';
    initGoogleSignIn();
  }
}


// ════════════════════════════════════════════════════════
//  PLAYER MODULE
// ════════════════════════════════════════════════════════
let plData       = null;  // { players, seasons, seasonYears, settings, teams }
let _yearDataCache = {};   // Cache for on-demand year player data { year: { players, seasons } }
let plSeason     = null;
let plTab        = 'overview';
let plSearchQ    = '';
let plDetailId   = null;  // profileId of open player detail

// ── OPEN / CLOSE ─────────────────────────────────────────────────
// ── HAMBURGER MENU ───────────────────────────────────────────────
function switchAdminTab(btn, tab) {
  document.querySelectorAll('#dash-sub-admin .dtab').forEach(b => b.classList.toggle('act', b === btn));
  renderAdminPanel(tab);
}

function renderAdminPanel(tab) {
  const el = document.getElementById('admin-panel-content');
  if (!el) return;
  const activetab = tab || document.querySelector('#dash-sub-admin .dtab.act')?.dataset?.admintab || 'users';
  // Sync active state
  document.querySelectorAll('#dash-sub-admin .dtab').forEach(b => {
    b.classList.toggle('act', b.dataset.admintab === activetab);
  });
  const _tabTitles = { users:'Manage Users', groups:'Access Groups', log:'Activity Log', about:'About' };
  el.innerHTML = '<div class="section-head" style="max-width:1440px;margin:0 auto;padding:0 16px;">'
    + '<h2 class="section-title">' + (_tabTitles[activetab] || activetab) + '</h2>'
    + '</div>'
    + '<div style="max-width:1440px;margin:0 auto;padding:0 16px 24px;" id="admin-panel-body"></div>';
  loadAdminTab(activetab, 'admin-panel-body');
}

function buildHamburgerMenu() {
  const menu = document.getElementById('hamburger-menu');
  const dash  = typeof _currentDashboard !== 'undefined' ? _currentDashboard : 'sponsors';
  const isAdmin = me && me.admin;
  const canEdit = me && (me.edit || me.admin);
  let html = '';

  // ── Sponsorship — always visible ──────────────────────────
  html += `<div class="hmenu-section-lbl">🏆 Sponsorship</div>`;
  html += `<button class="hmenu-item${dash==='sponsors'?' hmenu-active':''}" onclick="switchDashboard('sponsors');toggleHamburger()">📋 Overview</button>`;
  if (canEdit) {
    html += `<button class="hmenu-item" onclick="switchDashboard('sponsors');openAddOrg();toggleHamburger()">➕ Add Sponsor</button>`;
  }
  html += `<button class="hmenu-item" onclick="openPackagesPanel();toggleHamburger()">📦 ${canEdit ? 'View/Edit Packages' : 'View Packages'}</button>`;

  // ── Recruitment ───────────────────────────────────────────
  if (canSeeDash('recruitment')) {
    html += `<div class="hmenu-divider"></div>`;
    html += `<div class="hmenu-section-lbl">🏉 Recruitment</div>`;
    const plTabs = [
      { tab:'overview', icon:'📊', lbl:'Overview'  },
      { tab:'players',  icon:'👥', lbl:'Players'   },
      { tab:'teams',    icon:'🏉', lbl:'Teams'     },
      { tab:'import',   icon:'📥', lbl:'Import'    },
    ];
    plTabs.forEach(t => {
      const isAct = dash==='recruitment' && document.querySelector(`#dash-sub-recruitment .dtab[data-tab="${t.tab}"]`)?.classList.contains('act');
      html += `<button class="hmenu-item${isAct?' hmenu-active':''}" onclick="switchDashboard('recruitment');switchPlTab(document.querySelector('#dash-sub-recruitment .dtab[data-tab=\\'${t.tab}\\']'),'${t.tab}');toggleHamburger()">${t.icon} ${t.lbl}</button>`;
    });
  }

  // ── Admin tools ───────────────────────────────────────────
  if (canSeeDash('admin')) {
    html += `<div class="hmenu-divider"></div>`;
    html += `<div class="hmenu-section-lbl">⚙️ Admin</div>`;
    html += `<button class="hmenu-item" onclick="openAdminModal('log');toggleHamburger()">📋 Access Log</button>`;
    html += `<button class="hmenu-item" onclick="switchDashboard('admin-panel');switchAdminTab(document.querySelector('#dash-sub-admin .dtab[data-admintab=\'about\']'),'about');toggleHamburger()">ℹ️ About</button>`;
    html += `<button class="hmenu-item" onclick="openAdminModal('users');toggleHamburger()">👤 Users</button>`;
  }

  html += `<div class="hmenu-divider"></div>`;
  html += `<button class="hmenu-item" onclick="loadAll();toggleHamburger()">↻ Refresh</button>`;
  html += `<button class="hmenu-item hmenu-danger" onclick="doLogout()">Sign Out</button>`;

  menu.innerHTML = html;
}

function toggleHamburger() {
  const menu = document.getElementById('hamburger-menu');
  const opening = !menu.classList.contains('open');
  if (opening) buildHamburgerMenu();
  menu.classList.toggle('open');
}
// Close hamburger if clicking outside
document.addEventListener('click', function(e) {
  const btn = document.getElementById('hamburger-btn');
  const menu = document.getElementById('hamburger-menu');
  if (menu && menu.classList.contains('open')) {
    if (!btn.contains(e.target) && !menu.contains(e.target)) {
      menu.classList.remove('open');
    }
  }
});

// ── SEASON TAB: scroll active season to left of yellow bar ───────
function scrollActiveSeasonIntoView() {
  const bar = document.getElementById('season-tabs');
  if (!bar) return;
  const active = bar.querySelector('.stab.act');
  if (!active) return;
  requestAnimationFrame(() => {
    const sbar = bar.closest('.sbar');
    if (!sbar) return;
    // Scroll so active season tab is at the left edge (with small gap)
    sbar.scrollLeft = Math.max(0, active.offsetLeft - 8);
  });
}

function openPlayersModal() {
  // Legacy shim — just switch to recruitment dashboard
  switchDashboard('recruitment');
}

function closePlayersModal() {
  switchDashboard('sponsors');
}

let _currentDashboard = 'sponsors';
let _sponsorStaticHTML = '';

function switchDashboard(which) {
  _currentDashboard = which;
  try { localStorage.setItem('kjfc_dashboard', which); } catch(e) {}

  // Dashboard selector tabs
  document.getElementById('dash-tab-sponsors').classList.toggle('act', which === 'sponsors');
  document.getElementById('dash-tab-recruitment').classList.toggle('act', which === 'recruitment');
  const adminTab = document.getElementById('dash-tab-admin');
  if (adminTab) adminTab.classList.toggle('act', which === 'admin-panel');

  // Sub-nav rows
  document.getElementById('dash-sub-sponsors').style.display    = which === 'sponsors'    ? 'flex' : 'none';
  document.getElementById('dash-sub-recruitment').style.display = which === 'recruitment' ? 'flex' : 'none';
  document.getElementById('dash-sub-admin').style.display       = which === 'admin-panel' ? 'flex' : 'none';

  // Content panels
  document.getElementById('sponsor-content').style.display     = which === 'sponsors'    ? 'block' : 'none';
  document.getElementById('recruitment-content').style.display = which === 'recruitment' ? 'block' : 'none';
  const adminContent = document.getElementById('admin-panel-content');
  if (adminContent) adminContent.style.display = which === 'admin-panel' ? 'block' : 'none';

  if (which === 'sponsors') {
    // Always re-render sponsors overview — clear any sub-panel state
    document.querySelectorAll('#dash-sub-sponsors .dtab').forEach(b => b.classList.remove('act'));
    // Restore static sponsor HTML if it was replaced by a sub-panel
    const sc = document.getElementById('sponsor-content');
    if (!sc.querySelector('#season-span')) {
      sc.innerHTML = _sponsorStaticHTML;
    }
    render();
  }

  if (which === 'recruitment') {
    // Read selected season from yellow bar FIRST, then render
    const activeSeasonTab = document.querySelector('.stab.act');
    if (activeSeasonTab && activeSeasonTab.dataset.year) plSeason = +activeSeasonTab.dataset.year;
    // Reset to Overview sub-tab
    const overviewBtn = document.querySelector('#dash-sub-recruitment .dtab[data-tab="overview"]');
    if (overviewBtn) {
      document.querySelectorAll('#dash-sub-recruitment .dtab').forEach(b => b.classList.remove('act'));
      overviewBtn.classList.add('act');
    }
    initPlayerSeasonSel();
    if (!plData) loadPlayerData();
    else renderPlTab();
  }

  if (which === 'admin-panel') {
    renderAdminPanel();
  }
}

// ── PLAYER SLIDEOVER ──────────────────────────────────────────────
// Lightweight read-only panel sliding in from the right.
// Used from overview untargeted group rows — shows all players in that group.

let _slideoverProfileIds = [];

function openUntargetedGroup(evt, label, rowEl) {
  const pids  = (rowEl.dataset.pids || '').split(',').filter(Boolean);
  _slideoverProfileIds = pids;

  const pm   = plPlayerMap();
  const rows = plSeasonRows();

  const overlay = document.getElementById('player-slideover-overlay');
  const panel   = document.getElementById('player-slideover');

  document.getElementById('pso-name').textContent   = label;
  document.getElementById('pso-meta').textContent   = pids.length + ' player' + (pids.length !== 1 ? 's' : '') + ' — click a player to open full profile';
  document.getElementById('pso-avatar').innerHTML   = '<span style="font-size:20px;">👥</span>';

  const players = pids.map(pid => ({
    p:   pm[pid] || {},
    ps:  rows.find(r => r.profileId === pid),
    pid: pid
  })).filter(x => x.p.firstName);

  document.getElementById('pso-body').innerHTML = players.map(({ p, ps, pid }) => {
    const nat      = ps ? playerNaturalAge(ps)          : null;
    const eligible = ps ? playerEligibleGroups(ps, p)   : [];
    const dob      = canSeePrivate('recruitment') ? (normaliseDobFE(p.dob) || p.dob || '—') : null;
    const team     = ps && ps.assignedTeam ? (plTeamById(ps.assignedTeam)||{}).name : null;
    return `<div onclick="openPlayerDetailFromSlideover('${pid}')"
        style="display:flex;align-items:center;gap:12px;padding:10px 12px;border-radius:10px;cursor:pointer;margin-bottom:6px;border:1.5px solid var(--border);background:#fff;"
        onmouseenter="this.style.background='var(--green-light)'"
        onmouseleave="this.style.background='#fff'">
      <div style="width:38px;height:38px;border-radius:50%;background:var(--green-light);display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:900;color:var(--green);font-family:'Barlow Condensed',sans-serif;flex-shrink:0;">${plInitials(p)}</div>
      <div style="flex:1;min-width:0;">
        <div style="font-weight:700;font-size:13px;">${plName(p)}</div>
        <div style="font-size:11px;color:var(--text-dim);margin-top:1px;">DOB: ${dob}</div>
        <div style="font-size:11px;color:var(--text-dim);">
          Age on Jan 1: <strong>${nat !== null ? nat : '?'}</strong>
          &nbsp;·&nbsp; Eligible: <strong>${eligible.length ? eligible.join(', ') : 'none'}</strong>
        </div>
        ${team ? `<div style="font-size:11px;color:var(--green);margin-top:2px;">🏉 ${team}</div>` : ''}
      </div>
      <div style="color:var(--text-dim);font-size:16px;">›</div>
    </div>`;
  }).join('') || '<div style="color:var(--text-dim);padding:20px;text-align:center;">No players found.</div>';

  overlay.style.display = 'block';
  panel.style.transform = 'translateX(0)';
}

function closePlayerSlideover() {
  document.getElementById('player-slideover-overlay').style.display = 'none';
  document.getElementById('player-slideover').style.transform       = 'translateX(100%)';
  _slideoverProfileIds = [];
}
function closePso() { closePlayerSlideover(); }

let _psoSinglePid = null;
function openPlayerDetailFromSlideover(profileId) {
  closePlayerSlideover();
  setTimeout(() => openPlayerDetail(profileId), 220);
}

function closePlayerDetail() {
  document.getElementById('player-detail-modal').classList.remove('open');
  plDetailId = null;
}

// ── SEASON SELECTOR ───────────────────────────────────────────────
function initPlayerSeasonSel() {
  // Sync plSeason with the main yellow season bar (shared season selector)
  if (!plSeason) {
    const cur = new Date().getFullYear();
    const activeTab = document.querySelector('.stab.act');
    plSeason = activeTab ? +activeTab.dataset.year : (years && years.length ? +years[0] : cur);
  }
}

// ── LOAD PLAYER DATA (C: bundle + D: sessionStorage cache + E: skeleton) ──
const _SS_PREFIX = 'kjfc_recruit_';

function _recruitCacheKey(season) { return _SS_PREFIX + season; }

function _loadRecruitFromCache(season) {
  try {
    const raw = sessionStorage.getItem(_recruitCacheKey(season));
    if (!raw) return null;
    const cached = JSON.parse(raw);
    // Cache valid for 5 minutes within the session
    if (Date.now() - cached.ts > 5 * 60 * 1000) { sessionStorage.removeItem(_recruitCacheKey(season)); return null; }
    return cached.data;
  } catch(e) { return null; }
}

function _saveRecruitToCache(season, data) {
  try { sessionStorage.setItem(_recruitCacheKey(season), JSON.stringify({ ts: Date.now(), data })); } catch(e) {}
}

function _invalidateRecruitCache(season) {
  try { sessionStorage.removeItem(_recruitCacheKey(season || plSeason)); } catch(e) {}
}

function _showRecruitSkeleton() {
  document.getElementById('pl-body').innerHTML = `
    <div style="padding:20px;animation:pulse 1.4s ease-in-out infinite;">
      <div style="height:22px;width:160px;background:var(--border);border-radius:6px;margin-bottom:18px;"></div>
      <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:12px;margin-bottom:24px;">
        ${[1,2,3,4,5,6].map(()=>'<div style="height:72px;background:var(--border);border-radius:10px;"></div>').join('')}
      </div>
      <div style="height:16px;width:220px;background:var(--border);border-radius:4px;margin-bottom:10px;"></div>
      <div style="height:16px;width:180px;background:var(--border);border-radius:4px;margin-bottom:10px;"></div>
      <div style="height:16px;width:200px;background:var(--border);border-radius:4px;"></div>
    </div>
    <style>@keyframes pulse{0%,100%{opacity:1}50%{opacity:.45}}</style>`;
}

async function loadPlayerData() {
  // P3-03: Update heading immediately before any loading/skeleton so it's always correct
  const plSpanEl = document.getElementById('pl-season-span');
  if (plSpanEl) plSpanEl.textContent = 'Recruitment ' + plSeason + ' Season';

  // D: Try sessionStorage cache first — instant if switching back to a season
  const cached = _loadRecruitFromCache(plSeason);
  if (cached) {
    plData          = cached.playerData;
    _lastImportDate = cached.lastImport || null;
    _lapsedCache    = cached.lapsed    || [];
    renderPlTab();
    return;
  }

  // E: Show skeleton while loading
  _showRecruitSkeleton();

  // C: Single bundle call instead of 5 separate requests
  const res = await api('getRecruitmentBundle', { season: plSeason });
  if (res.error) {
    document.getElementById('pl-body').innerHTML =
      `<div style="color:var(--red);padding:20px">${res.error}</div>`;
    return;
  }

  plData          = res.playerData;
  _lastImportDate = res.lastImport || null;
  _lapsedCache    = res.lapsed    || [];

  // D: Save to sessionStorage for fast repeat access
  _saveRecruitToCache(plSeason, { playerData: res.playerData, lastImport: res.lastImport, lapsed: res.lapsed });

  // Pre-populate cached AI insight if bundled
  if (res.aiInsight && !res.aiInsight.error) {
    _bundledAiInsight = res.aiInsight;
  }

  renderPlTab();
}

async function loadPlayerView() {
  // plSeason is set by the main yellow season tab bar (switchSeason)
  plData          = null;
  _seasonCfg      = null;  // force reload from Sheets for new season
  _lastImportDate = null;
  _lapsedCache    = null;
  _bundledAiInsight = null;
  _invalidateRecruitCache(plSeason); // D: clear sessionStorage so we get fresh data
  await loadPlayerData();
}

// ── TAB SWITCHING ─────────────────────────────────────────────────
function switchPlTab(btn, tab) {
  // Update dtab buttons in recruitment sub-nav
  document.querySelectorAll('#dash-sub-recruitment .dtab').forEach(b => b.classList.toggle('act', b===btn));
  plTab = tab;
  renderPlTab();
}

function renderPlTab() {
  if (!plData) { loadPlayerData(); return; }
  // Always keep the section heading in sync with the active season
  const plSpanEl = document.getElementById('pl-season-span');
  if (plSpanEl) plSpanEl.textContent = 'Recruitment ' + plSeason + ' Season';
  const fns = {
    overview: renderPlOverview,
    players:  renderPlPlayers,
    teams:    renderPlTeams,
    import:   renderPlImport,
  };
  (fns[plTab] || renderPlOverview)();
}

// ── HELPERS ───────────────────────────────────────────────────────
function plSeasonRows() {
  return (plData.seasons||[]).filter(s => +s.year === +plSeason);
}

function plSeasonTeams() {
  return (plData.teams||[]).filter(t => +t.season === +plSeason);
}

function plTeamById(id) {
  return (plData.teams||[]).find(t => t.id === id) || null;
}

function plPlayerMap() {
  const m = {};
  // Secondary: lapsed players (prior season non-returners)
  (_lapsedCache||[]).forEach(p => { if (p.profileId && p.firstName) m[p.profileId] = p; });
  // Primary: current + previous season player profiles (loaded from server) — overwrite lapsed
  (plData.players||[]).forEach(p => { if (p.profileId) m[p.profileId] = p; });
  return m;
}

// ── Demographic snapshot helpers ──────────────────────────────────────────────
// Season rows carry school/suburb/address as they were at time of registration.
// For past seasons with no snapshot, show blank — don't project current profile
// data backwards, as it will be wrong (e.g. current high school vs primary school).
// Only fall back to the Players profile for the current active season where
// the season row and player profile are effectively the same import.
// Title-case normalisation for display — mirrors the backend toTitleCase logic.
// Applied to suburb/address/school to handle legacy ALL-CAPS data from PlayHQ exports.
function toTitleCaseJS(str) {
  if (!str) return str;
  return str.replace(/[^\s\-]+/g, function(word) {
    if (/^[Mm][Cc][A-Za-z]/.test(word))
      return word[0].toUpperCase() + word[1].toLowerCase() + word[2].toUpperCase() + word.slice(3).toLowerCase();
    return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
  });
}

const _currentSeasonYear = new Date().getFullYear();
// Determine if a season row has had its demographic snapshot captured.
// We use registrationDate as the sentinel — the backfill tool writes all snapshot
// fields (school, suburb, address, registrationDate) together. If registrationDate
// is present, the snapshot ran and we should honour all snapshot fields as-is,
// even if blank (blank means blank in that year's CSV).
// If registrationDate is absent, the backfill hasn't run yet — fall back to the
// current player profile only for the current season.
function _snapshotCaptured(sr) {
  return sr && sr.registrationDate && String(sr.registrationDate).trim() !== '';
}
function seasonSchool(sr, pm) {
  if (!sr) return '';
  const raw = _snapshotCaptured(sr)
    ? (sr.school || '')
    : (+sr.year >= _currentSeasonYear ? ((pm && (pm[sr.profileId]||{}).school) || '') : '');
  // PlayHQ stores school as "School Name, Suburb VIC 3XXX" — show name only
  return toTitleCaseJS(raw.replace(/,.*$/, '').trim());
}
function seasonSuburb(sr, pm) {
  if (!sr) return '';
  if (_snapshotCaptured(sr)) return toTitleCaseJS(sr.suburb || '');
  if (+sr.year >= _currentSeasonYear) return toTitleCaseJS((pm && (pm[sr.profileId]||{}).suburb) || '');
  return '';
}
function seasonAddr(sr, pm) {
  if (!sr) return '';
  if (_snapshotCaptured(sr)) return toTitleCaseJS(sr.address || '');
  if (+sr.year >= _currentSeasonYear) return toTitleCaseJS((pm && (pm[sr.profileId]||{}).address) || '');
  return '';
}

// Effective age group for a player in a season row:
// dispensation overrides to assignedTeam, else calcAge → U-group
function effectiveAgeGroup(ps) {
  // Returns UXX string — used for logic/filtering (team matching etc.)
  if (ps.dispensation && ps.assignedTeam) return ps.assignedTeam;
  if (ps.calcAge) return 'U' + ps.calcAge;
  if (ps.ageGroupRaw) return ps.ageGroupRaw;
  return '?';
}

function ageLabel(ps) {
  // Human-readable age label for player display (not team names)
  // "Age 9 on Jan 1" instead of "U9"
  const nat = playerNaturalAge(ps);
  if (nat !== null) return 'Age ' + nat;
  if (ps.calcAge) return 'Age ' + (ps.calcAge - 1);
  return '?';
}


function plInitials(p) {
  return ((p.firstName||'?')[0] + (p.lastName||'?')[0]).toUpperCase();
}
// Display-safe full name: applies title case so DB inconsistencies don't show in UI
function plName(p) {
  return toTitleCase(p.firstName||'') + ' ' + toTitleCase(p.lastName||'');
}

// ── OVERVIEW TAB ─────────────────────────────────────────────────
const ALL_AGE_GROUPS = ['U9','U10','U11','U12','U13','U14','U15','U16','U17'];

// ── ELIGIBILITY RULES ─────────────────────────────────────────────
// calcAge  = seasonYear - birthYear  (age they TURN during the season year)
// Jan 1 age = calcAge - 1            (age they ARE on January 1)
//
// Natural/lowest group = U(calcAge - 1)
//   e.g. calcAge=12 → 11 on Jan 1 → lowest group is U11
//   e.g. calcAge=13 → 12 on Jan 1 → lowest group is U12
//
// Eligible range = U(calcAge-1) through U(calcAge+1)  [2 years up from natural]
//
// U9 minimum: player must be at least 7 years old by April 30 of the season year.
// This means calcAge must be >= 8 (they're already 7 on Jan 1).
// Exception: calcAge=7 AND born Jan 1–Apr 30 → they turn 7 by the cutoff → eligible for U9 only.
// calcAge=7 born May 1 onwards → miss the cutoff → cannot play.

function playerNaturalAge(ps) {
  // Returns age on Jan 1 (= their natural/lowest group number)
  return (ps.calcAge != null) ? ps.calcAge - 1 : null;
}

function playerEligibleGroups(ps, p) {
  if (ps.calcAge == null) return [];
  const natAge = ps.calcAge - 1;  // age on Jan 1

  // Must be at least 7 on Jan 1 to play (calcAge >= 8),
  // OR calcAge=7 and born before May 1 (turns 7 by Apr 30 cutoff)
  if (natAge < 7) {
    if (natAge === 6 && p && p.dob) {
      // calcAge=7: check if born Jan 1 – Apr 30
      const dob = normaliseDobFE(p.dob);
      if (dob) {
        const parts = dob.split('/');
        const mm = parseInt(parts[1], 10);
        if (mm <= 4) {
          // Born Jan–Apr: turns 7 by April 30 cutoff → eligible for U9 only
          return ['U9'];
        }
      }
    }
    return []; // Too young
  }

  // Eligible: natural group up to natural+2, all capped between U9 and U17
  const groups = [];
  for (let a = natAge; a <= natAge + 2; a++) {
    const g = 'U' + a;
    if (ALL_AGE_GROUPS.includes(g)) groups.push(g);
  }
  return groups;
}

function normaliseDobFE(raw) {
  if (!raw) return '';
  const s = String(raw).trim();
  if (/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(s)) return s;
  const iso = s.match(/^(\d{4})-(\d{2})-(\d{2})/);
  if (iso) return iso[3] + '/' + iso[2] + '/' + iso[1];
  return '';
}

// ── OVERVIEW TAB ──────────────────────────────────────────────────
let _lastImportDate    = null;
let _lapsedCache       = null;
let _bundledAiInsight  = null; // pre-loaded from recruitment bundle

async function renderPlOverview() {
  // Data is now loaded via bundle in loadPlayerData — _lastImportDate and _lapsedCache
  // are already populated. Just render immediately. No extra API calls needed.
  if (!plData) { await loadPlayerData(); return; }

  // Fallback: derive import date from season rows if bundle didn't provide it
  if (!_lastImportDate) {
    const seasonRows = (plData.seasons || []).filter(s => String(s.year) === String(plSeason));
    const dates = seasonRows.map(r => r.importedAt).filter(Boolean).sort();
    if (dates.length) _lastImportDate = dates[dates.length - 1];
  }

  _renderOverviewHTML();
}

function _renderOverviewHTML() {
  const rows   = plSeasonRows();
  const pm     = plPlayerMap();
  const allSea = plData.seasons || [];
  const total  = rows.length;
  const boys   = rows.filter(r => (pm[r.profileId]||{}).gender === 'Male').length;
  const girls  = rows.filter(r => (pm[r.profileId]||{}).gender === 'Female').length;
  const newP   = rows.filter(r => r.newToClub === 'Yes').length;
  const disp   = rows.filter(r => r.dispensation === true || r.dispensation === 'true').length;
  const lapsed = _lapsedCache || [];
  // Average age (natural age = calcAge on Jan 1 of season)
  const _ageVals = rows.map(r => r.calcAge != null ? +r.calcAge - 1 : null).filter(v => v !== null && v >= 5 && v <= 18);
  const avgAge   = _ageVals.length ? _ageVals.reduce((a,b)=>a+b,0)/_ageVals.length : 0;


  // Data freshness — only show for the current active season (Oct–Sep window)
  // Active season: if today is Oct–Dec → season = this year + 1; Jan–Sep → season = this year
  let freshnessHTML = '';
  const _now = new Date();
  const _activeSeasonYear = _now.getMonth() >= 9 ? _now.getFullYear() + 1 : _now.getFullYear();
  if (+plSeason === _activeSeasonYear && _lastImportDate) {
    let imp = new Date(_lastImportDate);
    if (isNaN(imp.getTime()) && !isNaN(Number(_lastImportDate))) {
      imp = new Date((Number(_lastImportDate) - 25569) * 86400000);
    }
    if (isNaN(imp.getTime()) && typeof _lastImportDate === 'string') {
      const m = _lastImportDate.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})/);
      if (m) imp = new Date(+m[3], +m[2]-1, +m[1]);
    }
    if (!isNaN(imp.getTime())) {
      const impDay = new Date(imp.getFullYear(), imp.getMonth(), imp.getDate());
      const nowDay = new Date(_now.getFullYear(), _now.getMonth(), _now.getDate());
      const days = Math.round((nowDay - impDay) / 86400000);
      const fmt  = imp.toLocaleDateString('en-AU', { day:'numeric', month:'short', year:'numeric' });
      const col  = days > 30 ? '#dc2626' : days > 7 ? '#ca8a04' : '#16a34a';
      const daysLabel = days === 0 ? 'today' : days === 1 ? 'yesterday' : days + ' days ago';
      freshnessHTML = `<div style="display:flex;align-items:center;gap:8px;background:#f8faf8;border:1px solid var(--border);border-radius:8px;padding:7px 14px;font-size:11px;margin-bottom:16px;">
        <span style="width:8px;height:8px;border-radius:50%;background:${col};flex-shrink:0;"></span>
        <span>Data current as of <strong>${fmt}</strong></span>
        <span style="color:${col};font-weight:700;">(${daysLabel})</span>
      </div>`;
    }
  }

  // Schools count
  const schools = new Set(rows.map(r => seasonSchool(r, pm)).filter(Boolean)).size;

  // Active teams this season
  const activeTeams = plSeasonTeams().filter(t => t.name).length;

  // Recruitment shortfall: teams with minPlayers set that are below target
  // For a given age group, eligible players have natural age (age+1-1) down to 2 years below,
  // all capped at U9 minimum (natural age 8). School year ≈ age - 5 (Vic: Prep=age5, Yr1=6…).
  // Returns e.g. "Ages 10–12 (Yr 5–7)" for U12.
  function agRecruitTarget(ag) {
    const top = parseInt(ag.slice(1));       // e.g. 12
    const rawBot = top - 2;
    const bot = ag === 'U9' ? 7 : Math.max(8, rawBot); // U9 allows age 7 (Jan–Apr births)
    const yrTop = Math.max(0, top - 5);      // school year (Vic: age-5)
    const yrBot = Math.max(0, bot - 5);
    const ageStr = bot === top ? 'Age ' + bot : 'Ages ' + bot + '–' + top;
    function schYr(n) { return n <= 0 ? 'Prep' : 'Yr ' + n; }
    const yrStr = yrBot === yrTop ? schYr(yrTop) : schYr(yrBot) + '–' + schYr(yrTop);
    return ageStr + ' · ' + yrStr;
  }
  const allTeamsData = plSeasonTeams().filter(t => t.name);
  const teamCountMap = {};
  rows.forEach(s => { if (s.assignedTeam) teamCountMap[s.assignedTeam] = (teamCountMap[s.assignedTeam]||0)+1; });
  const shortTeams = allTeamsData
    .filter(t => t.minPlayers > 0)
    .map(t => ({ t, count: teamCountMap[t.id]||0, short: Math.max(0, t.minPlayers - (teamCountMap[t.id]||0)) }))
    .filter(d => d.short > 0)
    .sort((a,b) => (parseInt((a.t.ageGroup||'').replace(/\D/g,''))||99) - (parseInt((b.t.ageGroup||'').replace(/\D/g,''))||99) || (a.t.name||'').localeCompare(b.t.name||''));
  const totalShort = shortTeams.reduce((s,d) => s+d.short, 0);

  // Retention: players in current season who were also in previous season
  const prevSeason = +plSeason - 1;
  const prevPids = new Set(
    (plData.seasons||[]).filter(s => +s.year === prevSeason).map(s => s.profileId)
  );
  const returnedCount = rows.filter(r => prevPids.has(r.profileId)).length;
  const prevTotal = prevPids.size;
  const retentionPct = prevTotal > 0 ? Math.round(returnedCount / prevTotal * 100) : 0;

  // Year-on-year data for charts
  const allYears = [...new Set(allSea.map(s => +s.year))].sort();
  const yoyData  = allYears.map(y => {
    const yRows = allSea.filter(s => +s.year === y);
    const yPm   = {};
    (plData.players||[]).forEach(p => yPm[p.profileId] = p);
    const yBoys  = yRows.filter(r => (yPm[r.profileId]||{}).gender === 'Male').length;
    const yGirls = yRows.filter(r => (yPm[r.profileId]||{}).gender === 'Female').length;
    return { year: y, total: yRows.length, boys: yBoys, girls: yGirls };
  });

  // Per-age-group year-on-year
  const ageYOY = {};
  allYears.forEach(y => {
    const yRows = allSea.filter(s => +s.year === y);
    yRows.forEach(r => {
      const ag = effectiveAgeGroup(r);
      if (!ageYOY[ag]) ageYOY[ag] = {};
      ageYOY[ag][y] = (ageYOY[ag][y] || 0) + 1;
    });
  });

  // Per-school year-on-year (top 5)
  const schoolYOY = {};
  allSea.forEach(r => {
    const sch = seasonSchool(r, plPlayerMap());
    if (!sch) return;
    const short = sch.replace(/,.*$/,'').trim();
    if (!schoolYOY[short]) schoolYOY[short] = {};
    schoolYOY[short][+r.year] = (schoolYOY[short][+r.year]||0)+1;
  });
  const topSchools = Object.entries(schoolYOY)
    .map(([s,d]) => ({ school:s, total: Object.values(d).reduce((a,b)=>a+b,0), data:d }))
    .sort((a,b)=>b.total-a.total).slice(0,15);

  // Update section heading with season — now handled centrally in renderPlTab

  document.getElementById('pl-body').innerHTML = `
    <div style="padding:0 0 24px;">
      ${freshnessHTML}

      <!-- KPI CARDS — 4 col desktop, 2 col mobile
           Order: Registered, Not Returned, New to Club, Dispensations,
                  Gender Split (full row), Schools, Avg Age -->
      <div class="pl-kpi-grid" style="grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:16px;align-items:start;">
        <div class="pl-kpi" onclick="openRegisteredSlideover()" style="cursor:pointer;">
          <div class="pl-kpi-label">Registered ${plSeason}</div>
          <div class="pl-kpi-val">${total}</div>
          <div class="pl-kpi-sub">all players →</div>
        </div>
        <div class="pl-kpi" onclick="openLapsedSlideover()" style="cursor:pointer;">
          <div class="pl-kpi-label">Not Returned</div>
          <div class="pl-kpi-val" style="color:${lapsed.length>0?'var(--red)':'var(--green-bright)'}">${lapsed.length}</div>
          <div class="pl-kpi-sub">from last season →</div>
        </div>
        <div class="pl-kpi" onclick="openNewPlayersSlideover()" style="cursor:pointer;">
          <div class="pl-kpi-label">New to Club</div>
          <div class="pl-kpi-val" style="color:var(--green-bright)">${newP}</div>
          <div class="pl-kpi-sub">first season →</div>
        </div>
        <div class="pl-kpi" onclick="openDispSlideover()" style="cursor:pointer;">
          <div class="pl-kpi-label">Dispensations</div>
          <div class="pl-kpi-val" style="color:var(--yellow-dark)">${disp}</div>
          <div class="pl-kpi-sub">age override →</div>
        </div>
      </div>

      <!-- CHARTS SECTION -->
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:20px;" id="overview-charts-grid">
        <!-- Row 1: Monthly registrations this season (full width) -->
        <div style="background:#fff;border:1px solid var(--border);border-radius:10px;padding:12px 14px;grid-column:1/-1;">
          <div id="chart-monthly-title" class="chart-label">Registrations by Month</div>
          <div id="chart-monthly-sub" style="font-size:10px;color:var(--text-dim);margin-bottom:6px;">Click bar to see players registered that month</div>
          <div class="chart-wrap" style="height:160px;"><canvas id="chart-monthly"></canvas></div>
        </div>
        <!-- Recruitment Targets — below monthly chart -->
        ${shortTeams.length > 0 ? `<div style="grid-column:1/-1;background:#fff;border:1px solid var(--border);border-radius:10px;padding:12px 14px;">
          <div style="display:flex;align-items:baseline;justify-content:space-between;margin-bottom:10px;flex-wrap:wrap;gap:4px;">
            <div class="chart-label" style="margin-bottom:0;">🎯 Recruitment Targets</div>
            <div style="font-size:10px;color:var(--text-dim);">${totalShort} needed across ${shortTeams.length} team${shortTeams.length!==1?'s':''}</div>
          </div>
          <div style="display:flex;flex-direction:column;gap:8px;">
            ${shortTeams.map(({t, count, short}) => {
              const pct    = Math.min(100, Math.round(count / t.minPlayers * 100));
              const estTot = (t.estimateCount && t.estimateCount > count) ? t.estimateCount : 0;
              const estPct = estTot > 0 ? Math.min(100, Math.round(estTot / t.minPlayers * 100)) : 0;
              const near   = count >= Math.ceil(t.minPlayers * 0.8);
              const barCol = near ? '#4ead72' : '#9ca3af';
              const schoolYr = t.ageGroup ? agRecruitTarget(t.ageGroup) : '';
              return '<div style="display:grid;grid-template-columns:1fr auto;align-items:center;gap:10px;">'
                + '<div>'
                +   '<div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap;margin-bottom:4px;">'
                +     '<span style="font-size:12px;font-weight:700;">' + t.name + '</span>'
                +     (schoolYr ? '<span style="font-size:10px;color:var(--green);background:var(--green-light);padding:1px 5px;border-radius:4px;">' + schoolYr + '</span>' : '')
                +   '</div>'
                +   '<div style="position:relative;height:5px;background:#f0f0f0;border-radius:3px;overflow:hidden;">'
                +     (estPct > pct ? '<div style="position:absolute;inset:0;width:' + estPct + '%;background:#d1fae5;"></div>' : '')
                +     '<div style="position:absolute;inset:0;width:' + pct + '%;background:' + barCol + ';border-radius:3px;"></div>'
                +   '</div>'
                + '</div>'
                + '<div style="text-align:right;white-space:nowrap;flex-shrink:0;">'
                +   '<span style="font-size:12px;font-weight:700;color:var(--text);">' + count + '</span><span style="font-size:11px;color:#d1d5db;">/' + t.minPlayers + '</span>'
                +   '<div style="font-size:10px;color:' + barCol + ';">need ' + short + ' more</div>'
                + '</div>'
                + '</div>';
            }).join('')}
          </div>
        </div>` : ''}
        <!-- Row 2: YOY comparison + Gender -->
        <div style="background:#fff;border:1px solid var(--border);border-radius:10px;padding:12px 14px;">
          <div class="chart-label">Year on Year Comparison</div>
          <div class="chart-wrap"><canvas id="chart-yoy"></canvas></div>
        </div>
        <div style="background:#fff;border:1px solid var(--border);border-radius:10px;padding:12px 14px;">
          <div class="chart-label">Gender by Season</div>
          <div class="chart-wrap"><canvas id="chart-gender"></canvas></div>
        </div>
        <!-- Row 3: Age breakdown (full width) -->
        <div style="background:#fff;border:1px solid var(--border);border-radius:10px;padding:12px 14px;grid-column:1/-1;">
          <div id="chart-age-title" class="chart-label">Age Breakdown</div>
          <div id="chart-age-sub" style="font-size:10px;color:var(--text-dim);margin-bottom:6px;">click bar to view players</div>
          <div class="chart-wrap" style="height:150px;"><canvas id="chart-age"></canvas></div>
        </div>
        <!-- Row 4: Schools (full width) -->
        <div style="background:#fff;border:1px solid var(--border);border-radius:10px;padding:12px 14px;grid-column:1/-1;">
          <div class="chart-label">Schools — ${plSeason} <span style="font-weight:400;text-transform:none;font-size:10px;">· click to view players</span></div>
          <div class="chart-wrap" style="height:450px;"><canvas id="chart-schools"></canvas></div>
        </div>
      </div>

      <!-- Schools + Avg Age + Teams + Retention row -->
      <div class="pl-kpi-grid" style="grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:16px;align-items:start;">
        <div class="pl-kpi" onclick="openSchoolsOverviewSlideover()" style="cursor:pointer;">
          <div class="pl-kpi-label">Schools</div>
          <div class="pl-kpi-val">${schools}</div>
          <div class="pl-kpi-sub">represented →</div>
        </div>
        <div class="pl-kpi">
          <div class="pl-kpi-label">Avg Age</div>
          <div class="pl-kpi-val" style="color:var(--green)">${avgAge > 0 ? avgAge.toFixed(1) : '—'}</div>
          <div class="pl-kpi-sub">at 1 Jan ${plSeason}</div>
        </div>
        <div class="pl-kpi" onclick="openTeamsOverviewSlideover()" style="cursor:pointer;">
          <div class="pl-kpi-label">Teams</div>
          <div class="pl-kpi-val" style="color:var(--green)">${activeTeams}</div>
          <div class="pl-kpi-sub">active ${plSeason} →</div>
        </div>
        <div class="pl-kpi" onclick="openRetentionSlideover()" style="cursor:pointer;">
          <div class="pl-kpi-label">Retention</div>
          <div class="pl-kpi-val" style="color:${retentionPct >= 50 ? 'var(--green-bright)' : retentionPct >= 30 ? 'var(--yellow-dark)' : 'var(--red)'}">${retentionPct}%</div>
          <div class="pl-kpi-sub">returned from ${plSeason-1} →</div>
        </div>
      </div>

      <!-- Gender Split — last year block → arrow → this year block -->
      <div class="pl-kpi" onclick="openGenderSlideover()" style="cursor:pointer;margin-bottom:16px;">
        <div class="pl-kpi-label">Female Participation</div>
        ${(()=>{
          const thisYr  = yoyData.find(d => +d.year === +plSeason) || null;
          const lastYr  = yoyData.find(d => +d.year === +plSeason - 1) || null;
          if (!thisYr) return '<div style="color:var(--text-dim);font-size:13px;">No data</div>';

          const thisPct  = thisYr.total  ? Math.round(thisYr.girls  / thisYr.total  * 100) : 0;
          const lastPct  = lastYr && lastYr.total ? Math.round(lastYr.girls / lastYr.total * 100) : null;
          const diffPct  = lastPct !== null ? thisPct - lastPct : null;
          const diffNum  = lastYr ? thisYr.girls - lastYr.girls : null;
          const arrowCol = diffPct === null ? '#9ca3af' : diffPct > 0 ? '#16a34a' : diffPct < 0 ? '#dc2626' : '#9ca3af';
          const arrowSym = diffPct === null ? '→' : diffPct > 0 ? '↑' : diffPct < 0 ? '↓' : '→';
          const diffLabel = diffPct !== null ? (diffPct > 0 ? '+' : '') + diffPct + 'pp' + (diffNum !== 0 ? ' (' + (diffNum > 0 ? '+' : '') + diffNum + ')' : '') : '';

          const blockThis = '<div style="flex:1;background:rgba(201,180,0,.08);border:2px solid #c9b400;border-radius:12px;padding:16px 20px;">'
            +   '<div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.6px;color:#a09000;margin-bottom:10px;">' + plSeason + ' Season</div>'
            +   '<div style="font-size:48px;font-weight:900;color:#c9b400;line-height:1;">' + thisYr.girls + '</div>'
            +   '<div style="font-size:13px;color:#a09000;margin-top:6px;">female players</div>'
            +   '<div style="font-size:20px;font-weight:700;color:#c9b400;margin-top:8px;">' + thisPct + '%</div>'
            +   '<div style="font-size:11px;color:#a09000;margin-top:2px;">of ' + thisYr.total + ' registered</div>'
            + '</div>';

          const blockArrow = lastYr
            ? '<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;padding:0 16px;gap:6px;flex-shrink:0;">'
            +   '<div style="font-size:40px;font-weight:900;color:' + arrowCol + ';line-height:1;">' + arrowSym + '</div>'
            +   '<div style="font-size:12px;font-weight:800;color:' + arrowCol + ';text-align:center;">' + diffLabel + '</div>'
            + '</div>'
            : '';

          const blockLast = lastYr
            ? '<div style="flex:1;background:#f9fafb;border:1.5px solid var(--border);border-radius:12px;padding:16px 20px;">'
            +   '<div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.6px;color:var(--text-dim);margin-bottom:10px;">Previous season (' + lastYr.year + ')</div>'
            +   '<div style="font-size:48px;font-weight:900;color:var(--text-dim);line-height:1;">' + lastYr.girls + '</div>'
            +   '<div style="font-size:13px;color:var(--text-dim);margin-top:6px;">female players</div>'
            +   '<div style="font-size:20px;font-weight:700;color:var(--text-dim);margin-top:8px;">' + lastPct + '%</div>'
            +   '<div style="font-size:11px;color:var(--text-dim);margin-top:2px;">of ' + lastYr.total + ' registered</div>'
            + '</div>'
            : '';

          return '<div style="display:flex;align-items:center;margin-top:12px;min-height:140px;">'
            + blockThis + blockArrow + blockLast
            + '</div>';
        })()}
      </div>
      <!-- AI OVERVIEW CARD — auto-loads a 3-4 line summary -->
      <div id="ai-overview-card" style="background:rgba(1,60,30,0.72);color:#fff;border-radius:12px;padding:18px 22px;margin-bottom:20px;position:relative;overflow:hidden;backdrop-filter:blur(2px);">
        <div style="position:absolute;top:0;right:0;width:200px;height:100%;background:linear-gradient(135deg,transparent 55%,rgba(251,226,1,.05));pointer-events:none;"></div>
        <div style="display:flex;align-items:flex-start;gap:12px;">
          <div style="flex-shrink:0;margin-top:2px;">
            <div style="background:var(--yellow);color:var(--green);border-radius:7px;padding:5px 9px;font-family:'Barlow Condensed',sans-serif;font-weight:900;font-size:10px;text-transform:uppercase;letter-spacing:.6px;white-space:nowrap;">AI Summary</div>
            <div id="ai-overview-season" style="font-size:9px;opacity:.5;margin-top:3px;text-align:center;font-weight:700;"></div>
            <div id="ai-overview-ts" style="font-size:9px;opacity:.5;margin-top:2px;text-align:center;"></div>
          </div>
          <div id="ai-overview-text" style="font-size:13px;line-height:1.65;flex:1;opacity:.95;"><span style="opacity:.4;font-size:12px;">Loading…</span></div>
        </div>
      </div>
    </div>
  `;

  // Render charts after DOM update
  requestAnimationFrame(() => _renderOverviewCharts(yoyData, ageYOY, topSchools, allYears));
  // Auto-load AI overview — clear guard so season changes always re-evaluate
  _overviewAIFetching[plSeason] = false;
  _loadOverviewAI(rows, pm, yoyData, allYears);
}

async function _loadOverviewAI(rows, pm, yoyData, allYears) {
  const el = document.getElementById('ai-overview-text');
  if (!el) return;

  if (_overviewAIFetching[plSeason]) return; // already fetching for this season
  _overviewAIFetching[plSeason] = true;
  const _aiSeason = plSeason; // capture season at start to detect stale callbacks

  const today    = new Date();
  const total    = rows.length;
  const boys     = rows.filter(r => (pm[r.profileId]||{}).gender === 'Male').length;
  const girls    = total - boys;
  const prevYr   = +plSeason - 1;
  const prevTotal = (plData.seasons||[]).filter(s=>+s.year===prevYr).length;

  // Current month in season (Oct=month0 … Sep=month11)
  const todayYr = today.getFullYear(), todayMo = today.getMonth();
  let currentMonthBucket = -1;
  if (todayYr === +plSeason-1 && todayMo >= 9) currentMonthBucket = todayMo-9;
  else if (todayYr === +plSeason && todayMo <= 8) currentMonthBucket = todayMo+3;
  const MONTH_NAMES2 = ['Oct','Nov','Dec','Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep'];
  const currentMonthName = currentMonthBucket >= 0 ? MONTH_NAMES2[currentMonthBucket] + ' ' + todayYr : 'unknown';

  // Build monthly registration counts for current and previous seasons
  function parseDateStr2(raw) {
    if (!raw) return null;
    var s = (typeof raw === 'string') ? raw.trim() : String(raw);
    var d;
    // DD/MM/YYYY or D/M/YYYY
    if (/^\d{1,2}\/\d{1,2}\/\d{4}/.test(s)) {
      var pts = s.split('/');
      d = new Date(+pts[2], +pts[1]-1, +pts[0]);
    // ISO: YYYY-MM-DD or YYYY-MM-DDTHH:MM or YYYY-MM-DD HH:MM — parse date part only to avoid UTC shift
    } else if (/^\d{4}-\d{2}-\d{2}/.test(s)) {
      var datePart = s.slice(0,10); // 'YYYY-MM-DD'
      var dp = datePart.split('-');
      d = new Date(+dp[0], +dp[1]-1, +dp[2]); // local midnight — no UTC shift
    } else {
      d = new Date(s);
    }
    return (d && !isNaN(d.getTime())) ? d : null;
  }
  function dateBucket2(d, seasonYear) {
    if (!d) return -1;
    var yr=d.getFullYear(), mo=d.getMonth();
    if (yr===seasonYear-1&&mo>=9) return mo-9;
    if (yr===seasonYear&&mo<=8)   return mo+3;
    return -1;
  }

  // Monthly buckets — only use registrationDate (not importedAt fallback)
  // importedAt is the import date, not when the player registered — useless for this chart
  const curMonths = new Array(12).fill(0);
  var hasRealRegDates = 0;
  rows.forEach(function(r){
    var raw = r.registrationDate || r.regDate || null; // NO importedAt fallback
    if (!raw) return;
    var b = dateBucket2(parseDateStr2(raw), +plSeason);
    if (b >= 0) { curMonths[b]++; hasRealRegDates++; }
  });

  // Previous 2 years monthly average — only real registration dates, no importedAt fallback
  const prevYears2 = allYears.filter(function(y){return +y<+plSeason;}).slice(-2);
  const prevAvgMonths = new Array(12).fill(0);
  let hasPrevMonthData = false;
  prevYears2.forEach(function(py){
    (plData.seasons||[]).filter(function(s){return+s.year===+py;}).forEach(function(r){
      var raw = r.registrationDate || r.regDate || null; // no importedAt
      var b = dateBucket2(parseDateStr2(raw), +py);
      if(b>=0){prevAvgMonths[b]++;hasPrevMonthData=true;}
    });
  });
  if(prevYears2.length>1) for(var i=0;i<12;i++) prevAvgMonths[i]=Math.round(prevAvgMonths[i]/prevYears2.length);

  // Cumulative registrations to current month
  let cumCurrent=0, cumPrev=0;
  for(let m=0;m<=currentMonthBucket&&m<12;m++) {
    cumCurrent+=curMonths[m];
    cumPrev+=prevAvgMonths[m];
  }

  // Month-by-month context string
  const monthContext = currentMonthBucket>=0 && hasPrevMonthData
    ? 'Cumulative to '+currentMonthName+': '+cumCurrent+' registered vs '+cumPrev+' at same point last season'
    : 'Monthly registration date data not available in import';

  // Age bands
  const bandCounts = {};
  rows.forEach(r => {
    const p=(plData.players||[]).find(pp=>pp.profileId===r.profileId);
    if(!p||!p.dob) return;
    const d=new Date(p.dob.split('/').reverse().join('-'));
    if(isNaN(d)) return;
    const jan1=new Date(+plSeason,0,1);
    let age=jan1.getFullYear()-d.getFullYear();
    const mo=jan1.getMonth()-d.getMonth();
    if(mo<0||(mo===0&&jan1.getDate()<d.getDate())) age--;
    if(age<5||age>20) return;
    const lo=age%2===0?age-1:age;
    const band=lo+'-'+(lo+1);
    bandCounts[band]=(bandCounts[band]||0)+1;
  });
  const ageStr=Object.entries(bandCounts).sort((a,b)=>parseInt(a[0])-parseInt(b[0])).map(([b,c])=>(b+'yrs:'+c)).join(', ');
  const lapsed=(_lapsedCache||[]).length;
  const retPct=prevTotal>0?Math.round((total-(rows.filter(r=>{
    const pids=new Set((plData.seasons||[]).filter(s=>+s.year===prevYr).map(s=>s.profileId));
    return !pids.has(r.profileId);
  }).length))/prevTotal*100):null;
  const schoolCount=new Set(rows.map(r => seasonSchool(r, pm)).filter(Boolean)).size;

  // Is this a completed historical season or the active/upcoming one?
  const _currentCalYear = today.getFullYear();
  const _seasonComplete = +plSeason < _currentCalYear ||
    (+plSeason === _currentCalYear && today.getMonth() > 8); // past Sep of season year

  // Fingerprint: for past seasons use fixed 'done'; for active season include month bucket
  // so it refreshes as registrations come in each month
  const _estSum = (plData.teams||[]).filter(t=>+t.season===+plSeason&&t.estimateCount>0).reduce((s,t)=>s+(t.estimateCount||0),0);
  const _ovFP = [plSeason, total, prevTotal, lapsed, _seasonComplete ? 'done' : currentMonthBucket, _estSum, 'v3'].join('|');

  // Step 1: Load cached insight from sheet immediately — show without delay
  let _cachedStored = null;
  try {
    _cachedStored = await api('getAIInsight', { type: 'overview', season: plSeason });
  } catch(e) { /* network issue — continue to generate */ }

  // Abort if season changed while we were fetching cache
  if (plSeason !== _aiSeason) { _overviewAIFetching[_aiSeason] = false; return; }

  const _tsEl = document.getElementById('ai-overview-ts');
  if (_cachedStored && !_cachedStored.error && _cachedStored.html) {
    // Show cached content right away — user sees something immediately
    el.innerHTML = _cachedStored.html;
    const _sEl = document.getElementById('ai-overview-season');
    if (_sEl) _sEl.textContent = String(plSeason);
    if (_tsEl && _cachedStored.updatedAt) {
      try {
        const d = new Date(_cachedStored.updatedAt);
        _tsEl.textContent = 'Generated ' + d.toLocaleDateString('en-AU',{day:'numeric',month:'short'}) + ' ' + d.toLocaleTimeString('en-AU',{hour:'2-digit',minute:'2-digit'});
      } catch(tsErr) {}
    }
    // If fingerprint matches — data hasn't changed, we're done
    if (_cachedStored.fingerprint === _ovFP) {
      _overviewAIFetching[plSeason] = false;
      return;
    }
  }

  // Step 2: Fingerprint mismatch (or no cache) — regenerate
  // Keep existing content visible while regenerating; show subtle indicator
  if (_cachedStored && _cachedStored.html) {
    if (_tsEl) _tsEl.textContent = 'Updating\u2026';
  } else {
    el.innerHTML = '<span style="opacity:.4;font-size:12px;">Generating insight\u2026</span>';
  }

  // Prompt branches on _seasonComplete (already defined above)

  var prompt;
  if (_seasonComplete) {
    // Historical review — season is over, summarise what happened
    prompt = 'You are helping volunteers at a community junior football club review a completed season. '
      + 'This club has no paid staff — everyone is a volunteer. '
      + 'Today is ' + today.toLocaleDateString('en-AU',{day:'numeric',month:'long',year:'numeric'}) + '. '
      + 'The ' + plSeason + ' season is now complete. Write a warm, honest season review — celebrate achievements, '
      + 'note what the numbers show, and highlight one thing worth carrying into the next season. '
      + 'Write 3-5 concise bullet points. Each starts with a relevant emoji. Use **bold** for key figures. '
      + 'Speak in past tense. Do not give forward planning advice as if the season is upcoming. '
      + 'No headers. Each bullet 1-2 sentences max.\n\n'
      + 'Season: ' + plSeason + ' (completed)\n'
      + 'Total registered: ' + total + ' (' + boys + 'M / ' + girls + 'F)'
      + (prevTotal ? ', vs ' + prevTotal + ' in ' + prevYr : '') + '\n'
      + 'Age distribution: ' + (ageStr||'insufficient DOB data') + '\n'
      + 'Retention from ' + prevYr + ': ' + (retPct !== null ? retPct + '%' : 'unknown') + ' (' + (total - lapsed) + ' returned)\n'
      + 'Schools represented: ' + schoolCount;
  } else {
    // Active/upcoming season — forward-looking prompt
    // Registration window: Oct (prior year) → ~April (season start). Players must be registered to play.
    const _regDeadline = 'April ' + plSeason;
    const _monthsToDeadline = (() => {
      const apr = new Date(+plSeason, 3, 1); // April 1
      const diff = (apr - today) / (1000 * 60 * 60 * 24 * 30.5);
      return diff > 0 ? Math.round(diff) : 0;
    })();
    const _windowContext = _monthsToDeadline > 0
      ? 'Registration window closes ~' + _regDeadline + ' (season start) — approximately ' + _monthsToDeadline + ' month' + (_monthsToDeadline !== 1 ? 's' : '') + ' remaining to recruit'
      : 'Season has started — registration window has closed';

    prompt = 'You are helping volunteers at a community junior football club understand their player registrations. '
      + 'This club has no paid staff — everyone involved is a volunteer giving their time. '
      + 'Today is ' + today.toLocaleDateString('en-AU',{day:'numeric',month:'long',year:'numeric'}) + '. '
      + 'IMPORTANT CONTEXT: The registration window runs Oct–April (season start). Players must be registered before the season starts to be eligible to play. '
      + 'This is NOT a 12-month window — April is the real deadline. Frame urgency and progress relative to April, not the end of the year. '
      + 'Your tone should be warm, encouraging, and data-driven. Acknowledge the effort the team is putting in. Be specific with numbers. '
      + 'Write 3-5 concise bullet points. Each starts with a relevant emoji. Use **bold** for key figures. '
      + 'Consider: where registrations are at relative to the April deadline, how they compare to the same point last year, '
      + 'which age groups are looking healthy, and one practical next step the team can feel good about taking. '
      + 'Do not use language like "urgent attention" or "concern" — frame everything constructively. '
      + 'No headers. Each bullet 1-2 sentences max.\n\n'
      + 'Season: ' + plSeason + ' (registration window: Oct ' + (+plSeason-1) + ' to ~April ' + plSeason + ')\n'
      + _windowContext + '\n'
      + 'Current date: ' + currentMonthName + ' (month ' + (currentMonthBucket+1) + ' of season window)\n'
      + 'Total registered: ' + total + ' (' + boys + 'M / ' + girls + 'F)'
      + (prevTotal ? ', cf. ' + prevTotal + ' all of ' + prevYr : '') + '\n'
      + monthContext + '\n'
      + 'Age distribution: ' + (ageStr||'insufficient DOB data') + '\n'
      + 'Not returned from ' + prevYr + ': ' + lapsed + (retPct!==null?', retention '+retPct+'%':'') + '\n'
      + 'Schools: ' + schoolCount + '\n'
      + (_estSum > 0 ? 'Club estimates (team demand before full registration): ' + JSON.stringify((plData.teams||[]).filter(t=>+t.season===+plSeason&&t.estimateCount>0).map(t=>({team:t.name,estimate:t.estimateCount,registered:((plData.seasons||[]).filter(s=>+s.year===+plSeason&&s.assignedTeam===t.id).length)}))) : 'No club estimates recorded yet');
  }

  try {
    const res = await api('getAIInsights', { prompt });
    if (res.error) throw new Error(res.error);
    const raw = (res.text||'').trim();
    if (!raw) { el.textContent = 'No summary available.'; return; }

    // Render markdown-style bullet points with bold and colour
    const lines = raw.split('\n').map(l => l.trim()).filter(l => l.length > 0);
    const htmlParts = lines.map(line => {
      // Strip leading bullet/dash chars but keep emoji
      const cleaned = line.replace(/^[\-\*•]\s*/, '');
      // Convert **bold** to styled spans
      const bolded = cleaned.replace(/\*\*(.+?)\*\*/g, '<strong style="color:#fff;font-weight:800;">$1</strong>');
      // Detect tone by keywords for subtle colour coding
      const isWarning = /\b(urgent|low|behind|risk|concern|not returned|lapsed|missing|down)\b/i.test(cleaned);
      const isGood    = /\b(ahead|strong|great|on track|excellent|growing|above)\b/i.test(cleaned);
      const dotColor  = isWarning ? '#fbbf24' : isGood ? '#86efac' : 'rgba(255,255,255,.5)';
      return '<div style="display:flex;gap:10px;margin-bottom:8px;align-items:flex-start;">'
        + '<span style="color:' + dotColor + ';flex-shrink:0;font-size:15px;line-height:1.4;">●</span>'
        + '<span style="flex:1;">' + bolded + '</span>'
        + '</div>';
    });
    const _ovHtml = htmlParts.join('');
    if (plSeason !== _aiSeason) { _overviewAIFetching[_aiSeason] = false; return; } // season changed
    el.innerHTML = _ovHtml;
    const _tsEl2 = document.getElementById('ai-overview-ts');
    if (_tsEl2) _tsEl2.textContent = 'Generated just now';
    const _sEl3 = document.getElementById('ai-overview-season');
    if (_sEl3) _sEl3.textContent = String(plSeason);
    // Save to backend so all committee members see the same insight
    const saveOvRes = await api('saveAIInsight', { type: 'overview', season: plSeason, html: _ovHtml, fingerprint: _ovFP });
    if (saveOvRes.error) console.warn('[AI] overview save failed:', saveOvRes.error);
    _overviewAIFetching[plSeason] = false;
  } catch(e) {
    _overviewAIFetching[_aiSeason] = false; // allow retry
    if (plSeason === _aiSeason && !el.innerHTML.includes('●')) {
      el.innerHTML = '<span style="opacity:.5;font-size:12px;">AI summary unavailable — will retry next load</span>';
    }
  }
}


function _renderOverviewCharts(yoyData, ageYOY, topSchools, allYears) {
  if (typeof Chart === 'undefined') return;
  try { _renderOverviewChartsInner(yoyData, ageYOY, topSchools, allYears); }
  catch(e) { console.error('[Charts] Render failed:', e); }
}
function _renderOverviewChartsInner(yoyData, ageYOY, topSchools, allYears) {
  const GREEN = '#2e7d4f', GREEN_DARK = '#013C1E';
  const YELLOW = '#c9b400', GREEN_LIGHT = '#e6f0eb';
  const AGE_COLORS = ['#013C1E','#025a2d','#2e7d4f','#4ead72','#a8d5b5','#c9b400','#eab308','#f3f4f6'];
  const SCHOOL_COLORS = [GREEN_DARK, GREEN, YELLOW, '#6aa84f', '#4a7c59', '#8db87a'];

  // Update dynamic labels that can't use template literals inside the outer template
  var ageTitle = document.getElementById('chart-age-title');
  var ageSub   = document.getElementById('chart-age-sub');
  var monTitle = document.getElementById('chart-monthly-title');
  var monSub   = document.getElementById('chart-monthly-sub');
  if (ageTitle) ageTitle.textContent = plSeason + ' Age Breakdown';
  if (ageSub)   ageSub.textContent   = 'Age at 1 Jan ' + plSeason + ' \u00b7 click bar to view players';
  if (monTitle) monTitle.textContent = plSeason + ' Registrations by Month';
  if (monSub)   monSub.textContent   = 'Oct ' + (+plSeason-1) + ' \u2013 Sep ' + plSeason + ' \u00b7 based on PlayHQ registration date \u00b7 click a bar to view players';

  var compact = {
    responsive: true, maintainAspectRatio: false,
    plugins: { legend: { display: false } },
    scales: {
      x: { grid:{display:false}, ticks:{font:{size:10},color:'#9ca3af'} },
      y: { beginAtZero:true, grid:{color:'#f3f4f6'}, ticks:{font:{size:10},color:'#9ca3af',maxTicksLimit:5} }
    }
  };

  ['chart-monthly','chart-yoy','chart-gender','chart-age','chart-schools'].forEach(function(id) {
    var el = document.getElementById(id);
    if (el && el._chart) { el._chart.destroy(); el._chart = null; }
  });

  // ── 1. REGISTRATIONS BY MONTH (selected season, Oct–Sep window) ──
  var monthEl = document.getElementById('chart-monthly');
  if (monthEl) {
    var MONTH_NAMES = ['Oct','Nov','Dec','Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep'];
    var seasonRows = (plData.seasons||[]).filter(function(s) { return +s.year === +plSeason; });
    var monthCounts = [0,0,0,0,0,0,0,0,0,0,0,0];
    var monthPids   = [[],[],[],[],[],[],[],[],[],[],[],[]];
    var hasDate = false;

    function parseDateStr(raw) {
      if (!raw) return null;
      var s = (typeof raw === 'string') ? raw.trim() : String(raw);
      var d;
      // DD/MM/YYYY
      if (/^\d{1,2}\/\d{1,2}\/\d{4}/.test(s)) {
        var pts = s.split('/');
        d = new Date(+pts[2], +pts[1]-1, +pts[0]);
      // ISO YYYY-MM-DD (with optional time) — parse date part only to avoid UTC shift
      } else if (/^\d{4}-\d{2}-\d{2}/.test(s)) {
        var dp = s.slice(0,10).split('-');
        d = new Date(+dp[0], +dp[1]-1, +dp[2]);
      } else {
        d = new Date(s);
      }
      return (d && !isNaN(d.getTime())) ? d : null;
    }

    function dateToBucket(d, seasonYear) {
      if (!d) return -1;
      var yr = d.getFullYear(), mo = d.getMonth();
      if (yr === seasonYear-1 && mo >= 9) return mo - 9;
      if (yr === seasonYear   && mo <= 8) return mo + 3;
      return -1;
    }

    seasonRows.forEach(function(r) {
      // Only use real registration dates — importedAt is the import date, not registration date
      var raw = r.registrationDate || r.regDate || null;
      var d   = parseDateStr(raw);
      var b   = dateToBucket(d, +plSeason);
      if (b >= 0) { monthCounts[b]++; monthPids[b].push(r.profileId); hasDate = true; }
    });

    // Previous years monthly average — only real dates
    var prevYears = allYears.filter(function(y) { return +y < +plSeason; }).slice(-2);
    var prevMonthAvg = [0,0,0,0,0,0,0,0,0,0,0,0];
    if (prevYears.length) {
      prevYears.forEach(function(py) {
        (plData.seasons||[]).filter(function(s){return +s.year===+py;}).forEach(function(r) {
          var raw = r.registrationDate || r.regDate || null;
          var d   = parseDateStr(raw);
          var b   = dateToBucket(d, +py);
          if (b >= 0) prevMonthAvg[b]++;
        });
      });
      for (var i=0;i<12;i++) prevMonthAvg[i] = Math.round(prevMonthAvg[i] / prevYears.length);
    }

    // If no real registration dates — show a message instead of misleading data
    if (!hasDate) {
      if (monthEl) monthEl.style.display = 'none';
      var noDateMsg = document.createElement('div');
      noDateMsg.style.cssText = 'text-align:center;padding:20px 16px;font-size:12px;color:var(--text-dim);background:var(--bg);border-radius:8px;border:1px dashed var(--border);margin-bottom:4px;';
      noDateMsg.innerHTML = '📅 Registration date data not yet available for ' + plSeason + '<br>'
        + '<span style="font-size:11px;">Use the <strong>Backfill Registration Dates</strong> tool on the Import tab to add historical dates.</span>';
      if (monthEl && monthEl.parentNode) monthEl.parentNode.insertBefore(noDateMsg, monthEl);
      var monTitle = document.getElementById('chart-monthly-title');
      var monSub   = document.getElementById('chart-monthly-sub');
      if (monTitle) monTitle.style.color = 'var(--text-dim)';
      if (monSub)   monSub.textContent   = 'Run backfill to populate';
    } else {

    // Always show full 12 months (Oct→Sep) — trend line is useful even for future months
    var today2 = new Date();
    var todayBucket = dateToBucket(today2, +plSeason);
    if (todayBucket < 0) todayBucket = 11;

    var trimLabels  = MONTH_NAMES;                     // all 12 months always
    var trimCounts  = monthCounts;                     // zeros for future months
    var trimPrevAvg = prevMonthAvg;                    // trend line shows full year
    var trimPids    = monthPids;                       // only past months have pids

    var hasAnyPrev = prevYears.length > 0 && trimPrevAvg.some(function(v){return v>0;});

    monthEl._chart = new Chart(monthEl, {
      type: 'bar',
      data: {
        labels: trimLabels,
        datasets: [
          { type:'bar',  label: String(plSeason) + ' Season',
            data: trimCounts, backgroundColor: GREEN_LIGHT, borderColor: GREEN, borderWidth:1.5, borderRadius:3 },
          { type:'line', label: 'Trend',
            data: trimCounts, borderColor: GREEN_DARK, backgroundColor:'transparent',
            borderWidth:2, pointRadius:3, pointBackgroundColor:GREEN_DARK, tension:0.3 },
          { type:'line', label: 'Prior yr avg',
            data: trimPrevAvg, borderColor: YELLOW, backgroundColor:'transparent',
            borderWidth:1.5, pointRadius:2, borderDash:[4,3], tension:0.3, hidden: !hasAnyPrev }
        ]
      },
      options: Object.assign({}, compact, {
        plugins: {
          legend: { display: hasAnyPrev, position:'bottom', labels:{
            boxWidth:8, font:{size:9}, color:'#6b7280', padding:8,
            filter: function(item) { return item.text !== String(plSeason) + ' Season'; } // hide bar from legend, keep trend lines
          }},
          tooltip: { callbacks: {
            title: function(items) {
              var idx = MONTH_NAMES.indexOf(items[0].label);
              var yr2 = (idx >= 0 && idx < 3) ? +plSeason-1 : +plSeason;
              return items[0].label + ' ' + yr2;
            },
            label: function(ctx) {
              if (ctx.datasetIndex === 1) return; // suppress duplicate Trend tooltip
              return ctx.dataset.label + ': ' + ctx.parsed.y + ' players' + (ctx.datasetIndex===0 ? ' \u00b7 click to view' : '');
            }
          }}
        },
        onClick: function(e, els) {
          if (!els.length || els[0].datasetIndex !== 0) return;
          var idx  = els[0].index;
          if (idx > todayBucket) return; // no data for future months
          var pids = trimPids[idx];
          if (!pids || !pids.length) return;
          var pm   = plPlayerMap();
          var mnIdx = MONTH_NAMES.indexOf(trimLabels[idx]);
          var labelYr = (mnIdx >= 0 && mnIdx < 3) ? +plSeason-1 : +plSeason;
          _openSimpleSlideover(
            trimLabels[idx] + ' ' + labelYr + ' Registrations',
            pids.length + ' players registered this month',
            pids.map(function(pid) {
              var sr = (plData.seasons||[]).find(function(s){return s.profileId===pid&&+s.year===+plSeason;}) || {};
              return { pid: pid, label: ageLabel(sr), sub: seasonSchool(sr, pm)||'\u2014' };
            })
          );
        }
      })
    });
  } // end else (hasDate)
  } // end if (monthEl)

  // ── 2. YEAR ON YEAR COMPARISON ──
  var yoyEl = document.getElementById('chart-yoy');
  if (yoyEl) {
    var yLabels = yoyData.map(function(d){ return String(d.year); });
    yoyEl._chart = new Chart(yoyEl, {
      type: 'bar',
      data: { labels: yLabels,
        datasets: [
          { type:'bar',  label:'Total', data:yoyData.map(function(d){return d.total;}), backgroundColor:GREEN_LIGHT, borderColor:GREEN, borderWidth:1.5, borderRadius:3 },
          { type:'line', label:'Trend', data:yoyData.map(function(d){return d.total;}), borderColor:GREEN_DARK, backgroundColor:'transparent', borderWidth:2, pointRadius:3, pointBackgroundColor:GREEN_DARK, tension:0.3 }
        ]
      },
      options: Object.assign({}, compact, {
        plugins: { legend:{display:false},
          tooltip:{callbacks:{ title:function(i){return 'Season '+i[0].label;}, label:function(c){return c.parsed.y+' players';} }} },
        // YoY click-through removed — data reliability
      })
    });
  }

  // ── 3. GENDER BY SEASON ──
  var genderEl = document.getElementById('chart-gender');
  if (genderEl) {
    var gLabels = yoyData.map(function(d){ return String(d.year); });
    genderEl._chart = new Chart(genderEl, {
      type: 'bar',
      data: { labels: gLabels,
        datasets: [
          { label:'Male',   data:yoyData.map(function(d){return d.boys;}),  backgroundColor:GREEN+'cc',  borderColor:GREEN,  borderWidth:1, borderRadius:3 },
          { label:'Female', data:yoyData.map(function(d){return d.girls;}), backgroundColor:YELLOW+'99', borderColor:YELLOW, borderWidth:1, borderRadius:3 }
        ]
      },
      options: Object.assign({}, compact, {
        plugins: { legend:{ display:true, position:'bottom', labels:{boxWidth:9,font:{size:9},color:'#6b7280'} },
          tooltip:{callbacks:{ title:function(i){return 'Season '+i[0].label;}, label:function(c){return c.dataset.label+': '+c.parsed.y;} }} },
        scales: Object.assign({}, compact.scales, { x:Object.assign({},compact.scales.x,{stacked:true}), y:Object.assign({},compact.scales.y,{stacked:true}) }),
        // YoY click-through removed — data reliability
      })
    });
  }

  // ── 4. AGE BREAKDOWN current season — one bar per UXX group ──
  var ageEl = document.getElementById('chart-age');
  if (ageEl) {
    var ageRows = (plData.seasons||[]).filter(function(s){return +s.year===+plSeason;});
    var bandMale = {}, bandFemale = {}, bandPids = {};
    var _agePm = plPlayerMap();
    ageRows.forEach(function(r) {
      // P3-04: use calcAge from season row — no DOB required, works without private access
      var age = r.calcAge ? +r.calcAge : null;
      if (!age || age<5 || age>20) return;
      var lo   = age%2===0 ? age-1 : age;
      var band = lo+'-'+(lo+1);
      var gender = r.gender || (_agePm[r.profileId]||{}).gender || '';
      if (gender === 'Female') bandFemale[band] = (bandFemale[band]||0)+1;
      else                     bandMale[band]   = (bandMale[band]||0)+1;
      if (!bandPids[band]) bandPids[band]=[];
      bandPids[band].push(r.profileId);
    });
    var allBands = new Set(Object.keys(bandMale).concat(Object.keys(bandFemale)));
    var bands = Array.from(allBands).sort(function(a,b){return parseInt(a)-parseInt(b);});
    ageEl._chart = new Chart(ageEl, {
      type: 'bar',
      data: { labels: bands,
        datasets: [
          { label:'Male',   data:bands.map(function(b){return bandMale[b]||0;}),
            backgroundColor: GREEN+'cc', borderColor: GREEN, borderWidth:1.5, borderRadius:3, stack:'g' },
          { label:'Female', data:bands.map(function(b){return bandFemale[b]||0;}),
            backgroundColor: '#c9b400cc', borderColor: '#c9b400', borderWidth:1.5, borderRadius:3, stack:'g' }
        ]
      },
      options: Object.assign({}, compact, {
        plugins: {
          legend:{display:true,position:'bottom',labels:{boxWidth:10,font:{size:9},color:'#6b7280',padding:8}},
          tooltip:{callbacks:{
            title:function(i){return 'Ages '+i[0].label+' ('+plSeason+')';},
            label:function(c){return c.dataset.label+': '+c.parsed.y+' · click for detail';}
          }}
        },
        onClick: function(e,els) {
          if (!els.length) return;
          var band = bands[els[0].index];
          var pids = bandPids[band]||[];
          var pm2  = plPlayerMap();
          _openSimpleSlideover(
            'Ages ' + band + ' — ' + plSeason,
            pids.length + ' players',
            pids.map(function(pid){
              var p2 = pm2[pid]||{};
              var sr=(plData.seasons||[]).find(function(s){return s.profileId===pid&&+s.year===+plSeason;})||{};
              return {pid:pid,label:ageLabel(sr),sub:(p2.gender||'—')};
            })
          );
        }
      })
    });
  }

  // ── 5. SCHOOLS BY SEASON ──
  var schoolEl = document.getElementById('chart-schools');
  if (schoolEl) {
    // Bar chart for current season only — shows school breakdown clearly
    var seasonSchoolMap = {};
    var seasonSeaRows = (plData.seasons||[]).filter(function(r){ return +r.year === +plSeason; });
    var pm3 = plPlayerMap();
    seasonSeaRows.forEach(function(r) {
      var sch = seasonSchool(r, pm3) || 'Unknown';
      seasonSchoolMap[sch] = (seasonSchoolMap[sch]||0) + 1;
    });
    var schEntries = Object.entries(seasonSchoolMap).sort(function(a,b){return b[1]-a[1];}).slice(0,15);
    var schLabels  = schEntries.map(function(e){ return e[0].length>20 ? e[0].slice(0,20)+'…' : e[0]; });
    var schCounts  = schEntries.map(function(e){ return e[1]; });
    var schFull    = schEntries.map(function(e){ return e[0]; }); // full names for click handler

    if (schEntries.length) {
      schoolEl._chart = new Chart(schoolEl, {
        type: 'bar',
        data: {
          labels: schLabels,
          datasets: [{
            data: schCounts,
            backgroundColor: GREEN_LIGHT, borderColor: GREEN, borderWidth:1.5, borderRadius:3
          }]
        },
        options: Object.assign({}, compact, {
          indexAxis: 'y',
          plugins: {
            legend: { display: false },
            tooltip: { callbacks: {
              title: function(i) { return schFull[i[0].dataIndex]; },
              label: function(c) { return c.parsed.x + ' players · click for list'; }
            }}
          },
          scales: {
            x: { ticks:{font:{size:9},maxRotation:0}, grid:{display:false}, beginAtZero:true },
            y: { ticks:{font:{size:10},padding:4}, grid:{display:false} }
          },
          onClick: function(e,els) {
            if (els.length) openSchoolPlayersSlideover(schFull[els[0].index]);
          }
        })
      });
    }
  }
}


// ── OVERVIEW SLIDEVERS ────────────────────────────────────────────
let _psoBackFn = null; // stored back function for current slideover level


function _openSimpleSlideover(title, sub, players, backFn) {
  _psoBackFn = backFn || null;
  const pm = plPlayerMap();
  const overlay = document.getElementById('player-slideover-overlay');
  const panel   = document.getElementById('player-slideover');
  document.getElementById('pso-name').textContent  = title;
  document.getElementById('pso-meta').textContent  = sub;
  document.getElementById('pso-avatar').innerHTML  = backFn
    ? '<button onclick="_psoBackFn()" style="background:var(--green-light);border:none;cursor:pointer;font-size:13px;font-weight:700;color:var(--green);padding:5px 10px;border-radius:7px;line-height:1;" title="Back">‹ Back</button>'
    : '<span style="font-size:20px;">👥</span>';
  _psoRenderList(players, pm);
  _psoSinglePid = null;
  document.getElementById('pso-footer').style.display = 'none';
  overlay.style.display = 'block';
  panel.style.transform = 'translateX(0)';
}

function openGenderSlideover() {
  const rows = plSeasonRows();
  const pm   = plPlayerMap();
  const list = rows.map(r => {
    const p = pm[r.profileId]||{};
    return { pid:r.profileId, label: p.gender||'Unknown', sub: ageLabel(r) + ' · ' + (seasonSchool(r, pm)||'—') };
  }).sort((a,b)=>a.label.localeCompare(b.label)||(plName(pm[a.pid]||{})).localeCompare(plName(pm[b.pid]||{})));
  _openSimpleSlideover(`Gender Split — ${plSeason}`, `${list.filter(l=>l.label==='Male').length} male · ${list.filter(l=>l.label==='Female').length} female`, list);
}

function openNewPlayersSlideover() {
  const rows = plSeasonRows().filter(r=>r.newToClub==='Yes');
  const pm   = plPlayerMap();
  _openSimpleSlideover(`New to Club — ${plSeason}`, `${rows.length} first-season players`,
    rows.map(r=>({ pid:r.profileId, label: ageLabel(r), sub: seasonSchool(r,pm)||'—' })));
}

function openLapsedSlideover() {
  const lapsed = _lapsedCache || [];
  const pm     = plPlayerMap();
  // Lapsed players may not be in current season — build from lapsed array directly
  const body = document.getElementById('pso-body');
  const overlay = document.getElementById('player-slideover-overlay');
  const panel   = document.getElementById('player-slideover');
  document.getElementById('pso-name').textContent = `Not Returned — ${plSeason}`;
  document.getElementById('pso-meta').textContent = `${lapsed.length} players from last season not yet re-registered`;
  document.getElementById('pso-avatar').innerHTML = '<span style="font-size:20px;">⚠️</span>';

  body.innerHTML = lapsed.length ? lapsed.map(p => `
    <div onclick="openPlayerDetailFromSlideover('${p.profileId}')"
      style="display:flex;align-items:center;gap:12px;padding:9px 12px;border-radius:10px;cursor:pointer;margin-bottom:5px;border:1.5px solid var(--border);background:#fff;"
      onmouseenter="this.style.background='var(--green-light)'" onmouseleave="this.style.background='#fff'">
      <div style="width:34px;height:34px;border-radius:50%;background:#fef3c7;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:900;color:#92400e;font-family:'Barlow Condensed',sans-serif;flex-shrink:0;">${plInitials(p)}</div>
      <div style="flex:1;min-width:0;">
        <div style="font-weight:700;font-size:13px;">${plName(p)}</div>
        <div style="font-size:11px;color:var(--text-dim);">${p.lastAgeGroup||''} · ${p.school||'—'}</div>
        ${p.parent1Name ? `<div style="font-size:11px;color:var(--text-dim);">${p.parent1Name}${p.parent1Phone?' · '+fmtPhone(p.parent1Phone):''}</div>` : ''}
      </div>
      <div style="color:var(--text-dim);font-size:16px;">›</div>
    </div>`).join('')
  : '<div style="color:var(--text-dim);padding:20px;text-align:center;">No lapsed players — great retention! 🎉</div>';

  _psoSinglePid = null;
  document.getElementById('pso-footer').style.display = 'none';
  overlay.style.display = 'block';
  panel.style.transform = 'translateX(0)';
}

function openDispSlideover() {
  const rows = plSeasonRows().filter(r=>r.dispensation===true||r.dispensation==='true');
  const pm   = plPlayerMap();
  _openSimpleSlideover(`Dispensations — ${plSeason}`, `${rows.length} players with age override`,
    rows.map(r=>({ pid:r.profileId, label:'Dispensation active', sub: ageLabel(r)+' · '+(seasonSchool(r,pm)||'—') })));
}

// Build a player map that merges fetched year data on top of current plData
function _mergedPlayerMap(extraPlayers) {
  const m = {};
  (_lapsedCache||[]).forEach(p => { if (p.profileId && p.firstName) m[p.profileId] = p; });
  (plData.players||[]).forEach(p => { if (p.profileId) m[p.profileId] = p; });
  (extraPlayers||[]).forEach(p => { if (p.profileId) m[p.profileId] = p; });
  return m;
}

// Spinner HTML for slideover loading state
function _psoSpinner(title, sub) {
  const overlay = document.getElementById('player-slideover-overlay');
  const panel   = document.getElementById('player-slideover');
  document.getElementById('pso-name').textContent = title;
  document.getElementById('pso-meta').textContent = sub;
  document.getElementById('pso-avatar').innerHTML = '<span style="font-size:20px;">📅</span>';
  document.getElementById('pso-body').innerHTML =
    '<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;padding:40px 20px;gap:14px;">'
    + '<div style="width:32px;height:32px;border:3px solid var(--border);border-top-color:var(--green);border-radius:50%;animation:spin 0.7s linear infinite;"></div>'
    + '<div style="font-size:13px;color:var(--text-dim);">Loading players…</div>'
    + '</div>';
  document.getElementById('pso-footer').style.display = 'none';
  _psoSinglePid = null;
  overlay.style.display = 'block';
  panel.style.transform = 'translateX(0)';
}

// Render slideover body from a pre-built items array + player map
// Render slideover body from a pre-built items array + player map
function _psoRenderList(items, pm) {
  var body = document.getElementById('pso-body');
  if (!items.length) {
    body.innerHTML = '<div style="color:var(--text-dim);padding:20px;text-align:center;">No players.</div>';
    return;
  }
  body.innerHTML = '';
  items.forEach(function(item) {
    var p      = pm[item.pid] || {};
    var name   = plName(p) || '(Unknown)';
    var el     = document.createElement('div');
    el.style.cssText = 'display:flex;align-items:center;gap:12px;padding:9px 12px;border-radius:10px;cursor:pointer;margin-bottom:5px;border:1.5px solid var(--border);background:#fff;';
    el.addEventListener('mouseenter', function(){ el.style.background = 'var(--green-light)'; });
    el.addEventListener('mouseleave', function(){ el.style.background = '#fff'; });
    el.addEventListener('click', function(){ openPlayerDetailFromSlideover(item.pid); });
    var inner = '<div style="flex:1;min-width:0;">'
      + '<div style="font-weight:700;font-size:13px;">' + name + '</div>';
    if (item.label)  inner += '<div style="font-size:11px;color:var(--text-dim);">' + item.label + '</div>';
    if (item.sub)    inner += '<div style="font-size:11px;color:var(--text-dim);">' + item.sub   + '</div>';
    inner += '</div><div style="color:var(--text-dim);font-size:16px;">›</div>';
    el.innerHTML = inner;
    body.appendChild(el);
  });
}

// Fetch player data for a given year (cached) — returns { players, seasons }
async function _fetchYearData(year) {
  if (_yearDataCache[year]) return _yearDataCache[year];
  const res = await api('getPlayerData', { season: String(year) });
  if (res.error || !res.players) return { players: [], seasons: [] };
  _yearDataCache[year] = { players: res.players, seasons: res.seasons || [] };
  return _yearDataCache[year];
}

async function showYearPlayersSlideover(year) {
  // Season rows for this year are already in plData.seasons (all years loaded)
  const yearRows = (plData.seasons||[]).filter(s => +s.year === +year);

  // If all players for this year are already in our player map, render immediately
  const currentPm = plPlayerMap();
  const allKnown  = yearRows.every(r => currentPm[r.profileId]);

  if (allKnown) {
    const items = yearRows.map(r => ({ pid:r.profileId, label:ageLabel(r), sub:seasonSchool(r,currentPm)||'—' }));
    document.getElementById('pso-name').textContent = `${year} Registrations`;
    document.getElementById('pso-meta').textContent = `${yearRows.length} players`;
    document.getElementById('pso-avatar').innerHTML = '<span style="font-size:20px;">📅</span>';
    document.getElementById('pso-footer').style.display = 'none';
    _psoSinglePid = null;
    document.getElementById('player-slideover-overlay').style.display = 'block';
    document.getElementById('player-slideover').style.transform = 'translateX(0)';
    _psoRenderList(items, currentPm);
    return;
  }

  // Show spinner and fetch
  _psoSpinner(`${year} Registrations`, `Loading…`);
  const yd  = await _fetchYearData(year);
  const pm  = _mergedPlayerMap(yd.players);

  // Also cache fetched players into plData.players for openPlayerDetail click-throughs
  const existingIds = new Set((plData.players||[]).map(p => p.profileId));
  (yd.players||[]).forEach(p => { if (!existingIds.has(p.profileId)) plData.players.push(p); });

  const items = yearRows.map(r => ({ pid:r.profileId, label:ageLabel(r), sub:seasonSchool(r,pm)||'—' }))
                        .sort((a,b) => (plName(pm[a.pid]||{})).localeCompare(plName(pm[b.pid]||{})));

  document.getElementById('pso-name').textContent = `${year} Registrations`;
  document.getElementById('pso-meta').textContent = `${yearRows.length} players`;
  _psoRenderList(items, pm);
}

function openAgeGroupSlideover(ag) {
  const rows = plSeasonRows().filter(r=>effectiveAgeGroup(r)===ag);
  const pm   = plPlayerMap();
  const agNum= parseInt(ag.replace(/\D/g,''));
  const lbl  = isNaN(agNum)?ag:'Age '+(agNum-1);
  _openSimpleSlideover(`${lbl} — ${plSeason}`, `${rows.length} players`,
    rows.map(r=>({ pid:r.profileId, label:(pm[r.profileId]||{}).gender||'—', sub:seasonSchool(r,pm)||'—' })));
}

function openSchoolYearSlideover(school, year) {
  const yearRows = (plData.seasons||[]).filter(s=>+s.year===+year);
  const pm = plPlayerMap();
  const matching = yearRows.filter(r => {
    const p = pm[r.profileId]||{};
    return (seasonSchool(ps, plPlayerMap())||'').replace(/,.*$/,'').trim() === school;
  });
  _openSimpleSlideover(`${school} — ${year}`, `${matching.length} players`,
    matching.map(r=>({ pid:r.profileId, label:ageLabel(r), sub:(pm[r.profileId]||{}).gender||'—' })));
}

function openSchoolsOverviewSlideover() {
  const rows = plSeasonRows();
  const pm   = plPlayerMap();
  const schoolMap = {};
  rows.forEach(r => {
    const school = seasonSchool(r, pm) || 'Unknown';
    if (!schoolMap[school]) schoolMap[school] = [];
    schoolMap[school].push(r);
  });
  const sorted = Object.entries(schoolMap).sort((a,b) => b[1].length - a[1].length);

  const overlay = document.getElementById('player-slideover-overlay');
  const panel   = document.getElementById('player-slideover');
  document.getElementById('pso-name').textContent  = 'Schools — ' + plSeason;
  document.getElementById('pso-meta').textContent  = sorted.length + ' schools represented';
  _psoBackFn = null;
  document.getElementById('pso-avatar').innerHTML  = '<span style="font-size:20px;">🏫</span>';
  _psoSinglePid = null;
  document.getElementById('pso-footer').style.display = 'none';

  document.getElementById('pso-body').innerHTML = sorted.map(([school, srows]) => `
    <div data-school="${school.replace(/"/g,'&quot;')}" onclick="openSchoolPlayersSlideover(this.dataset.school)"
      style="display:flex;align-items:center;gap:12px;padding:10px 14px;border-radius:10px;cursor:pointer;margin-bottom:5px;border:1.5px solid var(--border);background:#fff;"
      onmouseenter="this.style.background='var(--green-light)'" onmouseleave="this.style.background='#fff'">
      <div style="width:34px;height:34px;border-radius:50%;background:var(--green-light);display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0;">🏫</div>
      <div style="flex:1;min-width:0;">
        <div style="font-weight:700;font-size:13px;">${school}</div>
        <div style="font-size:11px;color:var(--text-dim);">${srows.length} player${srows.length!==1?'s':''}</div>
      </div>
      <div style="color:var(--text-dim);font-size:16px;">›</div>
    </div>`).join('');

  overlay.style.display = 'block';
  panel.style.transform = 'translateX(0)';
}

function openSchoolPlayersSlideover(school) {
  const rows = plSeasonRows();
  const pm   = plPlayerMap();
  const matching = rows.filter(r => (seasonSchool(r, pm)||'Unknown') === school);
  _openSimpleSlideover(school, matching.length + ' player' + (matching.length!==1?'s':'') + ' · ' + plSeason,
    matching.map(r => ({ pid: r.profileId, label: ageLabel(r), sub: (pm[r.profileId]||{}).gender||'—' })),
    openSchoolsOverviewSlideover);
}

function openTeamsOverviewSlideover() {
  const teams = plSeasonTeams().filter(t => t.name);
  const overlay = document.getElementById('player-slideover-overlay');
  const panel   = document.getElementById('player-slideover');
  document.getElementById('pso-name').textContent  = 'Teams — ' + plSeason;
  _psoSinglePid = null;
  document.getElementById('pso-footer').style.display = 'none';

  if (!teams.length) {
    document.getElementById('pso-meta').textContent = 'No teams set up yet';
    document.getElementById('pso-avatar').innerHTML = '<span style="font-size:20px;">🏉</span>';
    document.getElementById('pso-body').innerHTML   = '<div style="color:var(--text-dim);padding:20px;text-align:center;">No teams configured for ' + plSeason + '.<br>Set them up in the Teams tab.</div>';
    overlay.style.display = 'block';
    panel.style.transform = 'translateX(0)';
    return;
  }

  const pm = plPlayerMap();
  const teamData = teams.map(t => {
    const players = plSeasonRows().filter(r => r.assignedTeam === t.id);
    return { team: t, players };
  }).sort((a,b) => {
    // Sort youngest to oldest by ageGroup number (U8 < U9 … U18)
    const ag = t => parseInt((t.ageGroup||'').replace(/\D/g,'')) || 99;
    return ag(a.team) - ag(b.team) || (a.team.name||'').localeCompare(b.team.name||'');
  });
  const totalAssigned = teamData.reduce((s,d) => s + d.players.length, 0);

  document.getElementById('pso-meta').textContent  = teams.length + ' team' + (teams.length!==1?'s':'') + ' · ' + totalAssigned + ' players assigned';
  _psoBackFn = null;
  document.getElementById('pso-avatar').innerHTML  = '<span style="font-size:20px;">🏉</span>';

  document.getElementById('pso-body').innerHTML = teamData.map(({team, players}) => `
    <div onclick="openTeamPlayersSlideover('${team.id}')"
      style="display:flex;align-items:center;gap:12px;padding:10px 14px;border-radius:10px;cursor:pointer;margin-bottom:5px;border:1.5px solid var(--border);background:#fff;"
      onmouseenter="this.style.background='var(--green-light)'" onmouseleave="this.style.background='#fff'">
      <div style="width:34px;height:34px;border-radius:50%;background:var(--green-light);display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0;">🏉</div>
      <div style="flex:1;min-width:0;">
        <div style="font-weight:700;font-size:13px;">${team.name}</div>
        <div style="font-size:11px;color:var(--text-dim);">${players.length} player${players.length!==1?'s':''}</div>
      </div>
      <div style="color:var(--text-dim);font-size:16px;">›</div>
    </div>`).join('');

  overlay.style.display = 'block';
  panel.style.transform = 'translateX(0)';
}

function openTeamPlayersSlideover(teamId) {
  const team = plSeasonTeams().find(t => t.id === teamId);
  if (!team) return;
  const rows = plSeasonRows().filter(r => r.assignedTeam === teamId);
  const pm   = plPlayerMap();
  _openSimpleSlideover(team.name, rows.length + ' player' + (rows.length!==1?'s':'') + ' · ' + plSeason,
    rows.map(r => ({ pid: r.profileId, label: ageLabel(r), sub: (pm[r.profileId]||{}).gender||'—' })),
    openTeamsOverviewSlideover);
}

function openRegisteredSlideover() {
  const rows = plSeasonRows();
  const pm   = plPlayerMap();
  _openSimpleSlideover(
    'Registered ' + plSeason,
    rows.length + ' players',
    rows.map(r => ({ pid:r.profileId, label:ageLabel(r), sub:seasonSchool(r,pm)||'—' }))
  );
}

function openAvgAgeSlideover() {
  const rows = plSeasonRows();
  const pm   = plPlayerMap();
  const jan1 = new Date(+plSeason, 0, 1);
  const withAge = rows.map(r => {
    const p = pm[r.profileId]||{};
    let age = null;
    if (p.dob) {
      const d = new Date(p.dob.split('/').reverse().join('-'));
      if (!isNaN(d)) {
        age = jan1.getFullYear() - d.getFullYear();
        const mo = jan1.getMonth() - d.getMonth();
        if (mo < 0 || (mo===0 && jan1.getDate() < d.getDate())) age--;
      }
    }
    return { pid:r.profileId, label: age !== null ? 'Age ' + age : '—', sub:(seasonSchool(r,pm)||'—'), _age: age||999 };
  }).sort((a,b) => a._age - b._age);
  _openSimpleSlideover('Ages — ' + plSeason, 'Age at 1 Jan ' + plSeason, withAge);
}

function openRetentionSlideover() {
  const rows    = plSeasonRows();
  const pm      = plPlayerMap();
  const prevYr  = +plSeason - 1;
  const prevPids = new Set((plData.seasons||[]).filter(s=>+s.year===prevYr).map(s=>s.profileId));
  const returned = rows.filter(r => prevPids.has(r.profileId));
  _openSimpleSlideover(
    'Returned — ' + plSeason,
    returned.length + ' players returned from ' + prevYr,
    returned.map(r => ({ pid:r.profileId, label:ageLabel(r), sub:seasonSchool(r,pm)||'—' }))
  );
}

// ── PLAYERS TAB ───────────────────────────────────────────────────
let _plSort = { col: 'name', dir: 'asc' };

function renderPlPlayers() {
  document.getElementById('pl-body').innerHTML =
    '<div style="display:flex;gap:8px;margin-bottom:12px;align-items:center;">' +
      '<input class="pl-search" id="pl-search" placeholder="Search name, school, suburb…" oninput="renderFilteredPlayers()" style="flex:1;min-width:180px;">' +
    '</div>' +
    '<div id="pl-table-wrap"></div>';
  renderFilteredPlayers();
}

function _plSortIcon(col) {
  if (_plSort.col !== col) return '<span style="color:#d1d5db;margin-left:3px;">↕</span>';
  return _plSort.dir === 'asc'
    ? '<span style="color:var(--green);margin-left:3px;">↑</span>'
    : '<span style="color:var(--green);margin-left:3px;">↓</span>';
}

function plSortBy(col) {
  if (_plSort.col === col) {
    _plSort.dir = _plSort.dir === 'asc' ? 'desc' : 'asc';
  } else {
    _plSort.col = col;
    _plSort.dir = 'asc';
  }
  renderFilteredPlayers();
}

function renderFilteredPlayers() {
  const rows = plSeasonRows();
  const pm   = plPlayerMap();
  const q    = (document.getElementById('pl-search')?.value||'').toLowerCase();

  let filtered = rows.map(r => ({ ps: r, p: pm[r.profileId]||{} }))
    .filter(({ps, p}) => {
      if (!q) return true;
      const hay = [p.firstName, p.lastName, seasonSchool(ps, {[p.profileId]:p}), seasonSuburb(ps, {[p.profileId]:p}), effectiveAgeGroup(ps)].join(' ').toLowerCase();
      return hay.includes(q);
    });

  // Sort by active column
  filtered.sort((a, b) => {
    let va, vb;
    switch (_plSort.col) {
      case 'name':   va = (a.p.lastName||'') + (a.p.firstName||''); vb = (b.p.lastName||'') + (b.p.firstName||''); break;
      case 'age':    va = playerNaturalAge(a.ps) ?? 999;             vb = playerNaturalAge(b.ps) ?? 999;             break;
      case 'gender': va = a.p.gender||'';                            vb = b.p.gender||'';                            break;
      case 'school': va = seasonSchool(a.ps, pm)||'';                vb = seasonSchool(b.ps, pm)||'';                break;
      case 'suburb': va = seasonSuburb(a.ps, pm)||'';                vb = seasonSuburb(b.ps, pm)||'';                break;
      default:       va = ''; vb = '';
    }
    const cmp = typeof va === 'number' ? va - vb : va.localeCompare(vb);
    return _plSort.dir === 'asc' ? cmp : -cmp;
  });

  const wrap = document.getElementById('pl-table-wrap');
  if (!wrap) return;
  if (!filtered.length) {
    wrap.innerHTML = '<div style="color:var(--text-dim);padding:20px;text-align:center;">No players match.</div>';
    return;
  }

  const thStyle = 'cursor:pointer;user-select:none;white-space:nowrap;';

  wrap.innerHTML =
    '<div style="font-size:11px;color:var(--text-dim);margin-bottom:8px;">' + filtered.length + ' player' + (filtered.length!==1?'s':'') + '</div>'
    + '<div style="overflow-x:auto;">'
    + '<table class="pl-table"><thead><tr>'
    + '<th></th>'
    + '<th onclick="plSortBy(&quot;name&quot;)" style="' + thStyle + '">Name' + _plSortIcon('name') + '</th>'
    + '<th onclick="plSortBy(&quot;age&quot;)" style="' + thStyle + '">Age' + _plSortIcon('age') + '</th>'
    + '<th onclick="plSortBy(&quot;gender&quot;)" style="' + thStyle + '">Gender' + _plSortIcon('gender') + '</th>'
    + '<th onclick="plSortBy(&quot;school&quot;)" style="' + thStyle + '">School' + _plSortIcon('school') + '</th>'
    + '<th onclick="plSortBy(&quot;suburb&quot;)" style="' + thStyle + '">Suburb' + _plSortIcon('suburb') + '</th>'
    + '<th>New</th><th>📸</th><th></th>'
    + '</tr></thead><tbody>'
    + filtered.map(({ps, p}) => {
        const agDisplay = playerNaturalAge(ps) !== null ? playerNaturalAge(ps) : (ps.calcAge ? ps.calcAge - 1 : '—');
        const init  = plInitials(p);
        const photo = p.photoUrl ? '<img src="' + p.photoUrl + '" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">' : init;
        const dispTag = (ps.dispensation===true||ps.dispensation==='true') ? '<span class="disp-tag">disp.</span>' : '';
        return '<tr onclick="openPlayerDetail(&quot;' + p.profileId + '&quot;)">'
          + '<td><div class="pl-avatar">' + photo + '</div></td>'
          + '<td><strong>' + plName(p) + '</strong></td>'
          + '<td>' + agDisplay + ' ' + dispTag + '</td>'
          + '<td>' + (p.gender||'—') + '</td>'
          + '<td style="font-size:11px;max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">' + (seasonSchool(ps,pm)||'—') + '</td>'
          + '<td style="font-size:11px;">' + (seasonSuburb(ps,pm)||'—') + '</td>'
          + '<td>' + (ps.newToClub==='Yes' ? '<span style="color:var(--green);font-weight:700;font-size:11px;">✓ New</span>' : '—') + '</td>'
          + '<td style="text-align:center;">' + (p.photoConsent==='No' ? '<span style="color:#dc2626;font-size:11px;" title="Opted out">✗</span>' : '<span style="color:var(--green);font-size:13px;" title="Consent given">✓</span>') + '</td>'
          + '<td><button class="actbtn" onclick="event.stopPropagation();openPlayerDetail(&quot;' + p.profileId + '&quot;)">View</button></td>'
          + '</tr>';
      }).join('')
    + '</tbody></table></div>';
}

// ── PLAYER DETAIL MODAL ───────────────────────────────────────────

// Helper: builds contact/medical HTML when user has private access.
// Extracted to avoid nested template literals which cause parse issues.
function _plPrivContactHtml(p) {
  function guardCard(label, name, phone, email) {
    return '<div style="background:var(--bg);border-radius:8px;padding:10px 12px;">'
      + '<div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--text-dim);margin-bottom:6px;">' + label + '</div>'
      + '<div style="font-size:12px;font-weight:600;">' + (name || '—') + '</div>'
      + '<div style="font-size:12px;color:var(--text-dim);">' + (phone ? fmtPhone(phone) : '—') + '</div>'
      + '<div style="font-size:11px;color:var(--text-dim);word-break:break-all;">' + (email || '—') + '</div>'
      + '</div>';
  }
  let html = '<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px;">'
    + guardCard('Parent/Guardian 1', p.parent1Name, p.parent1Phone, p.parent1Email)
    + guardCard('Parent/Guardian 2', p.parent2Name, p.parent2Phone, p.parent2Email)
    + '</div>';

  html += '<div style="background:#fff8f0;border:1px solid #fed7aa;border-radius:8px;padding:10px 12px;margin-bottom:14px;">'
    + '<div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:#b45309;margin-bottom:4px;">Emergency Contact</div>'
    + '<div style="font-size:13px;font-weight:600;">' + (p.emergencyName || '—') + (p.emergencyRelationship ? ' (' + p.emergencyRelationship + ')' : '') + '</div>'
    + '<div style="font-size:12px;color:var(--text-dim);">' + (p.emergencyPhone ? fmtPhone(p.emergencyPhone) : '—') + (p.emergencyEmail ? ' · ' + p.emergencyEmail : '') + '</div>'
    + '</div>';

  if (p.accountHolder || p.accountHolderMobile || p.accountHolderEmail) {
    html += '<div style="background:var(--bg);border-radius:8px;padding:10px 12px;margin-bottom:14px;">'
      + '<div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--text-dim);margin-bottom:4px;">Account Holder (registered)</div>'
      + '<div style="font-size:13px;font-weight:600;">' + (p.accountHolder || '—') + '</div>'
      + '<div style="font-size:12px;color:var(--text-dim);">' + (p.accountHolderMobile ? fmtPhone(p.accountHolderMobile) : '—') + (p.accountHolderEmail ? ' · ' + p.accountHolderEmail : '') + '</div>'
      + '</div>';
  }
  if (p.medicalFlag === 'Yes' || p.medicalDetails) {
    html += '<div style="background:#fef2f2;border:1px solid #fca5a5;border-radius:8px;padding:10px 12px;margin-bottom:14px;">'
      + '<div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:#dc2626;margin-bottom:4px;">⚕ Medical / Allergies</div>'
      + '<div style="font-size:13px;">' + (p.medicalDetails || 'Flagged — see registration notes') + '</div>'
      + '</div>';
  }
  return html;
}

function openPlayerDetail(profileId) {
  const pm  = plPlayerMap();
  const p   = pm[profileId];
  if (!p) return;
  // Show Save button only for users with edit permission
  const _saveBtn = document.getElementById('pdm-save-btn');
  if (_saveBtn) _saveBtn.style.display = me?.edit ? '' : 'none';

  // Primary: look for a current season row
  let ps = plSeasonRows().find(r => r.profileId === profileId);

  // Fallback: lapsed player — synthesise a season row from lapsed cache data
  // so calcAge, ageGroupRaw, gender etc are all available in the modal
  if (!ps) {
    const lp = (_lapsedCache||[]).find(l => l.profileId === profileId);
    if (lp) {
      ps = {
        profileId:       profileId,
        year:            lp.lastYear    || (+plSeason - 1),
        calcAge:         lp.calcAge     || null,
        ageGroupRaw:     lp.lastAgeGroup|| '',
        gender:          lp.gender      || p.gender || '',
        school:          lp.school      || p.school || '',
        suburb:          lp.suburb      || p.suburb || '',
        newToClub:       '',
        assignedTeam:    '',
        dispensation:    false,
        dispensationNote:'',
        notes:           '',
        _fromLapsed:     true  // flag — this player is not in current season
      };
    }
  }

  ps = ps || {};
  plDetailId = profileId;

  const init = plInitials(p);
  const ag   = effectiveAgeGroup(ps);
  const disp = ps.dispensation===true||ps.dispensation==='true';

  document.getElementById('pdm-avatar').innerHTML = init;
  document.getElementById('pdm-name').textContent  = plName(p);
  const _plPriv = canSeePrivate('recruitment');
  const _metaBase = _plPriv
    ? `${ageLabel(ps)} · ${p.gender||''} · DOB ${normaliseDob(p.dob)||''} · ${seasonSuburb(ps, {[ps.profileId]: p})||p.suburb||''}`
    : `${ageLabel(ps)} · ${p.gender||''}`;
  // For lapsed players, clarify data is from their last registered season
  const _metaEl = document.getElementById('pdm-meta');
  if (ps._fromLapsed) {
    _metaEl.innerHTML = `<span>${_metaBase}</span> <span style="background:#fef3c7;color:#92400e;font-size:10px;font-weight:700;padding:1px 6px;border-radius:8px;margin-left:4px;">Not returned ${ps.year||''}</span>`;
  } else {
    _metaEl.textContent = _metaBase;
  }

  // photoUrl is stored as a data URL — use directly, no async fetch needed

  // Compute age + eligibility for nearby groups
  const calcAgeVal = ps.calcAge ? +ps.calcAge : null;
  const natAgeVal  = calcAgeVal ? calcAgeVal - 1 : null; // age on Jan 1 of season
  const eligible   = natAgeVal ? playerEligibleGroups(ps, p) : [];

  // Build seasons history for this player
  const allPlayerSeasons = (plData.seasons||[])
    .filter(s => s.profileId === profileId)
    .sort((a,b) => b.year - a.year);



  document.getElementById('pdm-body').innerHTML = `
    <!-- Avatar + consent -->
    <div style="display:flex;align-items:center;gap:14px;margin-bottom:16px;padding-bottom:16px;border-bottom:1px solid var(--border);">
      <div style="width:64px;height:64px;border-radius:50%;background:var(--green-light);display:flex;align-items:center;justify-content:center;font-size:24px;font-weight:900;color:var(--green);font-weight:900;flex-shrink:0;">${init}</div>
      <div>
        <label style="font-size:12px;display:flex;align-items:center;gap:7px;cursor:pointer;">
          <input type="checkbox" id="pdm-photo-consent" ${p.photoConsent!=='No'?'checked':''}
            style="width:14px;height:14px;accent-color:var(--green);cursor:pointer;">
          <span style="font-weight:600;">📸 Photo consent</span>
        </label>
        <div style="font-size:10px;color:var(--text-dim);margin-top:3px;margin-left:21px;">
          ${p.photoConsent==='No' ? '<span style="color:#dc2626;">Opted out — do not publish photos</span>' : 'Consent assumed (default Yes). Uncheck only if parent has explicitly opted out.'}
        </div>
      </div>
    </div>

    <!-- Registered seasons -->
    <div style="background:var(--bg);border-radius:10px;padding:12px 14px;margin-bottom:16px;">
      <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--text-dim);margin-bottom:8px;">Registered Seasons</div>
      ${allPlayerSeasons.length ? `
        <div style="display:flex;flex-wrap:wrap;gap:6px;">
          ${allPlayerSeasons.map(s => {
            const team = plTeamById(s.assignedTeam);
            const isCur = +s.year === +plSeason;
            return `<div style="background:${isCur?'var(--green)':'#fff'};color:${isCur?'#fff':'var(--text)'};border:1.5px solid ${isCur?'var(--green)':'var(--border)'};border-radius:8px;padding:5px 10px;font-size:12px;">
              <div style="font-weight:700;">${s.year}</div>
              <div style="font-size:10px;opacity:.8;">${s.ageGroupRaw||('U'+(s.calcAge||'?'))}</div>
              ${team ? `<div style="font-size:10px;opacity:.8;">🏉 ${team.name}</div>` : '<div style="font-size:10px;opacity:.6;">No team</div>'}
              ${s.dispensation ? '<div style="font-size:9px;opacity:.8;">⚡ Disp</div>' : ''}
            </div>`;
          }).join('')}
        </div>` : '<div style="font-size:12px;color:var(--text-dim);">No season records found</div>'}
    </div>

    <!-- Age / Dispensation -->
    <div style="background:var(--bg);border-radius:10px;padding:12px 14px;margin-bottom:16px;">
      <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--text-dim);margin-bottom:8px;">Age & Team Assignment</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:8px;">
        <span style="font-size:13px;">Age on Jan 1: <strong>${natAgeVal||'?'}</strong> → eligible: ${eligible.map(g=>`<span style="background:var(--green-light);color:var(--green);padding:2px 8px;border-radius:10px;font-size:11px;font-weight:700;">${g}</span>`).join(' ')}</span>
      </div>
      <!-- Team assignment — always visible -->
      <div style="margin-bottom:10px;">
        <div style="font-size:11px;color:var(--text-dim);margin-bottom:4px;">Assigned team</div>
        <select id="pdm-assigned-team" style="padding:6px 8px;border:1.5px solid var(--border);border-radius:6px;font-size:12px;width:100%;">
          <option value="">— unassigned —</option>
          ${plSeasonTeams().map(t=>`<option value="${t.id}" ${ps.assignedTeam===t.id?'selected':''}>${t.name}</option>`).join('')}
          ${!plSeasonTeams().length ? '<option disabled style="color:#999;">No teams yet — set up in Teams tab</option>' : ''}
        </select>
      </div>
      <!-- Dispensation -->
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
        <label style="font-size:12px;display:flex;align-items:center;gap:6px;cursor:pointer;">
          <input type="checkbox" id="pdm-disp" ${disp?'checked':''} onchange="document.getElementById('pdm-disp-note-wrap').style.display=this.checked?'block':'none'">
          <span style="font-weight:600;color:#7c3aed;">Dispensation — playing outside natural age group</span>
        </label>
      </div>
      <div id="pdm-disp-note-wrap" style="display:${disp?'block':'none'};margin-top:8px;">
        <input id="pdm-disp-note" type="text" value="${ps.dispensationNote||''}" placeholder="Dispensation note (e.g. League approved 12/02/26)"
          style="width:100%;padding:6px 8px;border:1.5px solid #a78bfa;border-radius:6px;font-size:12px;">
      </div>
    </div>

    <!-- Contact details — gated by privacy permission -->
    ${_plPriv ? _plPrivContactHtml(p) : '<div style="background:#f8f8f8;border:1.5px dashed var(--border);border-radius:8px;padding:12px 14px;margin-bottom:14px;font-size:12px;color:var(--text-dim);">🔒 Contact details, medical information and emergency contacts are restricted to users with full detail access.</div>'}

    <!-- School + Suburb + ATSI -->
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px;">
      <div><div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--text-dim);margin-bottom:3px;">School</div><div style="font-size:13px;">${seasonSchool(ps,{[ps.profileId]:p})||'—'}</div><div style="font-size:11px;color:var(--text-dim);">Year ${ps.schoolYear||p.schoolYear||'—'}</div></div>
      <div><div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--text-dim);margin-bottom:3px;">Address</div>${_plPriv ? (()=>{const _a=seasonAddr(ps,{[ps.profileId]:p})||p.address;const _s=seasonSuburb(ps,{[ps.profileId]:p})||p.suburb;const _pc=ps.postcode||p.postcode;return (_a?`<div style="font-size:12px;">${_a}</div>`:'')+([_s,_pc,p.state].filter(Boolean).length?`<div style="font-size:12px;">${[_s,_pc,p.state].filter(Boolean).join(' ')}</div>`:'')+(!_a&&!_s&&!_pc?'<div style="font-size:12px;">—</div>':'');})() : '<div style="font-size:12px;color:var(--text-dim);">Hidden</div>'} ${_plPriv && p.atsi&&p.atsi!=='No'?`<div style="font-size:10px;color:#7c3aed;margin-top:2px;">ATSI: ${p.atsi}</div>`:''}</div>
    </div>

    <!-- Notes -->
    <div><div style="font-size:11px;font-weight:700;color:var(--text-dim);margin-bottom:4px;">Season Notes</div>
    <textarea id="pdm-notes" rows="2" placeholder="Any notes about this player for ${plSeason}…"
      style="width:100%;padding:8px;border:1.5px solid var(--border);border-radius:7px;font-size:13px;resize:vertical;">${ps.notes||''}</textarea></div>
  `;

  const modal = document.getElementById('player-detail-modal');
  bringToFront(modal);
  modal.classList.add('open');
}


async function savePlayerDetail() {
  if (!plDetailId) return;
  const ps = plSeasonRows().find(r=>r.profileId===plDetailId)||{};

  const photoConsent = document.getElementById('pdm-photo-consent')?.checked ? 'Yes' : 'No';
  const dispensation = document.getElementById('pdm-disp')?.checked||false;
  const assignedTeam = document.getElementById('pdm-assigned-team')?.value||'';
  const dispNote     = document.getElementById('pdm-disp-note')?.value?.trim()||'';
  const notes        = document.getElementById('pdm-notes')?.value?.trim()||'';

  const btn = document.getElementById('pdm-save-btn');
  btnLoading(btn, true);

  const [r1, r2] = await Promise.all([
    api('updatePlayer', { profileId: plDetailId, photoConsent }),
    ps.id ? api('updatePlayerSeason', { id: ps.id, dispensation, assignedTeam, dispensationNote: dispNote, notes }) : Promise.resolve({ok:true})
  ]);

  btnLoading(btn, false);
  if (r1.error || r2?.error) { showToast('Save failed: '+(r1.error||r2?.error), 'err'); return; }

  // Update local data
  const p = (plData.players||[]).find(x=>x.profileId===plDetailId);
  if (p) { p.photoUrl = photoUrl; p.photoConsent = photoConsent; }
  if (ps.id) {
    Object.assign(ps, { dispensation, assignedTeam, dispensationNote: dispNote, notes });
  }

  _invalidateRecruitCache(); // D: fresh data needed after player change
  showToast('Player saved ✓');
  closePlayerDetail();
  renderPlTab();
}

// ── LAPSED / NOT RETURNED TAB ─────────────────────────────────────
async function renderPlLapsed() {
  document.getElementById('pl-body').innerHTML =
    '<div style="text-align:center;padding:32px;color:var(--text-dim)"><div class="ls-spinner" style="margin:0 auto 12px"></div>Finding lapsed players…</div>';
  const res = await api('getLapsedPlayers', { year: plSeason });
  if (res.error) { document.getElementById('pl-body').innerHTML=`<div style="color:var(--red);padding:20px">${res.error}</div>`; return; }
  const lapsed = res.lapsed||[];
  if (!lapsed.length) {
    document.getElementById('pl-body').innerHTML =
      `<div style="text-align:center;padding:40px;color:var(--text-dim);">
        <div style="font-size:32px;margin-bottom:8px;">✅</div>
        All players from ${res.prevYear} have re-registered for ${plSeason}${res.prevYear?(', or there is no '+res.prevYear+' data yet'):''}.</div>`;
    return;
  }

  const calcCurAge = p => p.calcAge;

  document.getElementById('pl-body').innerHTML = `
    <div style="background:#fef9c3;border:1.5px solid #ca8a04;border-radius:10px;padding:12px 16px;margin-bottom:16px;display:flex;gap:10px;align-items:center;">
      <span style="font-size:20px;">⚠️</span>
      <div><strong>${lapsed.length} player${lapsed.length!==1?'s':''}</strong> registered in ${res.prevYear} have not yet re-registered for ${res.year}.</div>
    </div>
    <input class="pl-search" id="lapsed-search" placeholder="Search name, school…" oninput="filterLapsed()" style="width:100%;margin-bottom:12px;">
    <div id="lapsed-list">
    ${lapsed.map(p => `
      <div class="lapsed-row" id="lapsed-${p.profileId}" onclick="openPlayerDetail('${p.profileId}')"
           style="cursor:pointer;" onmouseenter="this.style.background='var(--green-light)'" onmouseleave="this.style.background=''">
        <div class="pl-avatar">${plInitials(p)}</div>
        <div style="flex:1;min-width:0;">
          <div style="font-weight:700;font-size:13px;">${plName(p)}
            <span style="font-size:10px;font-weight:400;color:var(--text-dim);margin-left:6px;">${p.lastAgeGroup||''} · ${p.gender||''}</span>
          </div>
          <div style="font-size:11px;color:var(--text-dim);">Age ${calcCurAge(p)||'?'} in ${res.year} · ${seasonSchool(res,{[res.profileId]:p})||'—'}${canSeePrivate('recruitment') ? ' · ' + (seasonSuburb(res,{[res.profileId]:p})||'—') : ''}</div>
        </div>
        <div style="flex-shrink:0;min-width:180px;">
          ${canSeePrivate('recruitment') ? (
            (p.parent1Name||p.parent1Phone ? '<div style="font-size:11px;display:flex;gap:6px;align-items:baseline;"><span style="font-weight:600;font-size:11px;min-width:90px;">' + (p.parent1Name||'') + '</span><span style="color:var(--text-dim);">' + (p.parent1Phone?fmtPhone(p.parent1Phone):'') + '</span></div>' : '') +
            (p.parent2Name||p.parent2Phone ? '<div style="font-size:11px;display:flex;gap:6px;align-items:baseline;margin-top:1px;"><span style="font-weight:600;font-size:11px;min-width:90px;">' + (p.parent2Name||'') + '</span><span style="color:var(--text-dim);">' + (p.parent2Phone?fmtPhone(p.parent2Phone):'') + '</span></div>' : '') +
            (!p.parent1Name&&!p.parent1Phone&&!p.parent2Name&&!p.parent2Phone ? '<div style="font-size:11px;color:var(--text-dim);">No contact info</div>' : '')
          ) : '<div style="font-size:11px;color:var(--text-dim);">🔒 Restricted</div>'}
        </div>
      </div>`).join('')}
    </div>
    <div style="margin-top:12px;text-align:right;">
      <button class="msecondary" onclick="exportLapsed(${JSON.stringify(lapsed).replace(/"/g,'&quot;')})">⬇ Export CSV</button>
    </div>
  `;
}

function filterLapsed() {
  const q = (document.getElementById('lapsed-search')?.value||'').toLowerCase();
  document.querySelectorAll('.lapsed-row').forEach(row => {
    row.style.display = !q || row.textContent.toLowerCase().includes(q) ? '' : 'none';
  });
}

function exportLapsed(lapsed) {
  const rows = [['First Name','Last Name','Last Age Group','Age This Year','School','Suburb','Parent Name','Parent Phone','Parent Email']];
  const _lPriv = canSeePrivate('recruitment');
  lapsed.forEach(p => rows.push([toTitleCase(p.firstName||''),toTitleCase(p.lastName||''),p.lastAgeGroup||'',p.calcAge||'',p.school||'',_lPriv?p.suburb||'':'',_lPriv?p.parent1Name||'':'',_lPriv?p.parent1Phone||'':'',_lPriv?p.parent1Email||'':'']));
  const csv = rows.map(r=>r.map(v=>'"'+String(v).replace(/"/g,'""')+'"').join(',')).join('\n');
  const a = document.createElement('a');
  a.href = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csv);
  a.download = `lapsed_players_${plSeason}.csv`;
  a.click();
}

// ── SCHOOLS TAB ───────────────────────────────────────────────────

// ── IMPORT TAB ────────────────────────────────────────────────────
// ── IMPORT STATE ─────────────────────────────────────────────────
let _importData = null; // { season, include[], exclude[] } set after parsing

// ── TEAMS TAB ────────────────────────────────────────────────────────────────
function renderPlTeams() {
  const body        = document.getElementById('pl-body');
  const teams       = plSeasonTeams();
  const allRows     = (plData.seasons||[]).filter(s => +s.year === +plSeason);
  const pm          = plPlayerMap();
  const teamCount   = {};
  allRows.forEach(s => { if (s.assignedTeam) teamCount[s.assignedTeam] = (teamCount[s.assignedTeam]||0)+1; });
  const unassigned  = allRows.filter(s => !s.assignedTeam).length;

  body.innerHTML = `
    <div style="padding:16px 20px;">
      <div style="margin-bottom:16px;">
        <div style="font-size:14px;font-weight:700;margin-bottom:4px;">${plSeason} Teams</div>
        <div style="font-size:12px;color:var(--text-dim);margin-bottom:10px;">${teams.length} team${teams.length!==1?'s':''} · ${allRows.length} registered · ${unassigned} unassigned</div>
        <button class="mprimary" onclick="openTeamModal(null)" style="font-size:12px;padding:7px 14px;">+ Add Team</button>
      </div>

      ${teams.length === 0 ? `
        <div style="text-align:center;padding:40px 20px;color:var(--text-dim);">
          <div style="font-size:32px;margin-bottom:10px;">🏉</div>
          <div style="font-weight:700;margin-bottom:6px;">No teams set up for ${plSeason}</div>
          <div style="font-size:13px;margin-bottom:16px;">Create a team, then click it to assign players.</div>
          <button class="mprimary" onclick="openTeamModal(null)">+ Add First Team</button>
        </div>
      ` : `
        <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:14px;">
          ${[...teams].sort((a,b) => (parseInt((a.ageGroup||'').replace(/\D/g,''))||99) - (parseInt((b.ageGroup||'').replace(/\D/g,''))||99) || (a.name||'').localeCompare(b.name||'')).map(t => {
            const count    = teamCount[t.id] || 0;
            const roster   = allRows.filter(s => s.assignedTeam === t.id).map(s => pm[s.profileId]).filter(Boolean);
            const minP     = t.minPlayers || 0;
            const estTotal = (t.estimateCount && t.estimateCount > count) ? t.estimateCount : 0;
            const pct      = minP > 0 ? Math.min(100, Math.round(count / minP * 100)) : 0;
            const estPct   = (minP > 0 && estTotal > 0) ? Math.min(100, Math.round(estTotal / minP * 100)) : 0;
            const colour   = !minP ? '#9ca3af'
                           : count >= minP ? '#16a34a'
                           : count >= Math.ceil(minP * 0.8) ? '#ca8a04'
                           : '#dc2626';
            return `
              <div onclick="openTeamSlide('${t.id}')"
                style="background:#fff;border:2px solid var(--border);border-radius:14px;overflow:hidden;cursor:pointer;transition:all .15s;"
                onmouseenter="this.style.borderColor='var(--green)';this.style.boxShadow='0 4px 16px rgba(22,163,74,.15)'"
                onmouseleave="this.style.borderColor='var(--border)';this.style.boxShadow=''">
                <!-- Header -->
                <div style="background:var(--green);padding:12px 14px;display:flex;justify-content:space-between;align-items:flex-start;">
                  <div style="flex:1;min-width:0;">
                    <div style="font-weight:900;font-size:15px;color:#fff;font-weight:900;letter-spacing:.3px;">${t.name}</div>
                    <div style="font-size:11px;color:rgba(255,255,255,.75);margin-top:1px;">${[t.ageGroup,t.gender].filter(Boolean).join(' · ')}</div>
                  </div>
                  <div style="display:flex;gap:5px;margin-left:8px;" onclick="event.stopPropagation()">
                    <button onclick="openTeamModal('${t.id}')" style="background:rgba(255,255,255,.15);border:none;color:#fff;padding:3px 8px;border-radius:6px;font-size:11px;cursor:pointer;font-weight:600;">Edit</button>
                    <button onclick="deleteTeamConfirm('${t.id}','${t.name.replace(/'/g,"&#39;")}')" style="background:rgba(255,0,0,.25);border:none;color:#fff;padding:3px 8px;border-radius:6px;font-size:11px;cursor:pointer;font-weight:600;">✕</button>
                  </div>
                </div>
                <!-- Body -->
                <div style="padding:12px 14px;">
                  ${t.coach ? `<div style="font-size:11px;color:var(--text-dim);margin-bottom:8px;">👤 ${t.coach}${t.assistantCoach?' · '+t.assistantCoach:''}</div>` : ''}
                  <!-- Count + bar -->
                  <div style="display:flex;align-items:baseline;justify-content:space-between;margin-bottom:4px;">
                    <div style="display:flex;align-items:baseline;gap:6px;">
                      <span style="font-family:'Barlow Condensed',sans-serif;font-weight:900;font-size:24px;color:${colour};">${count}</span>
                      <span style="font-size:11px;color:var(--text-dim);">registered</span>
                      ${estTotal > 0 ? '<span style="font-size:11px;color:#6b7280;">· est. ' + estTotal + '</span>' : ''}
                    </div>
                    ${minP > 0 ? '<span style="font-size:11px;font-weight:700;color:' + colour + ';">' + (count >= minP ? '✓ meets min' : (minP-count) + ' more needed') + '</span>' : ''}
                  </div>
                  ${minP > 0 ? '<div style="position:relative;height:7px;background:#e5e7eb;border-radius:4px;margin-bottom:' + (estTotal>0?'5':'8') + 'px;">'
                    + (estPct > pct ? '<div title="Club estimate (' + estTotal + ')" style="position:absolute;height:7px;border-radius:4px;background:#bfdbfe;width:' + estPct + '%;"></div>' : '')
                    + '<div title="Registered (' + count + ')" style="position:absolute;height:7px;border-radius:4px;background:' + colour + ';width:' + pct + '%;transition:width .3s;"></div>'
                    + '</div>' : '<div style="height:7px;margin-bottom:8px;"></div>'}
                  ${estTotal > 0 ? '<div style="font-size:10px;color:#6b7280;margin-bottom:5px;">📊 Club estimate: <strong>' + estTotal + '</strong>' + (minP > 0 && estTotal >= minP ? ' <span style=\"color:#16a34a;font-weight:700;\">Est. viable ✓</span>' : '') + '</div>' : ''}
                  <!-- Mini roster -->
                  ${roster.length ? `
                    <div style="display:flex;flex-wrap:wrap;gap:3px;margin-bottom:${t.estimateNames?.length?'6':'0'}px;">
                      ${roster.slice(0,8).map(p=>`<span style="background:var(--green-light);color:var(--green);font-size:10px;font-weight:600;padding:1px 6px;border-radius:8px;">${plName(p)}</span>`).join('')}
                      ${roster.length > 8 ? `<span style="background:#f3f4f6;color:var(--text-dim);font-size:10px;font-weight:600;padding:1px 6px;border-radius:8px;">+${roster.length-8} more</span>` : ''}
                    </div>` : `<div style="font-size:11px;color:var(--text-dim);font-style:italic;margin-bottom:${t.estimateNames?.length?'6':'0'}px;">Click to assign players →</div>`}
                  ${t.estimateNames?.length ? '<div style="border-top:1px solid var(--border);padding-top:5px;margin-top:2px;font-size:10px;color:#6b7280;">📋 ' + t.estimateNames.slice(0,4).join(', ') + (t.estimateNames.length>4?' <em>+' + (t.estimateNames.length-4) + ' more</em>':'') + '</div>' : ''}
                </div>
              </div>`;
          }).join('')}
        </div>
      `}
    </div>

  `;
}

// ── TEAM ASSIGNMENT SLIDEOVER ──────────────────────────────────────
// Click a team card → slide in from right → toggle players to assign/unassign
// Same UX pattern as planning slideover. Saves immediately per toggle.

let _teamSlideId     = null;
let _teamSlideFilter = 'all'; // all | assigned | unassigned | byAG

async function openTeamSlide(teamId) {
  _teamSlideId     = teamId;
  _teamSlideFilter = 'all';

  // Reuse or create overlay/panel
  let overlay = document.getElementById('team-slide-overlay');
  let panel   = document.getElementById('team-slide');
  if (!overlay) {
    overlay = document.createElement('div');
    overlay.id = 'team-slide-overlay';
    overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.35);z-index:3500;display:none;';
    overlay.onclick = closeTeamSlide;
    document.body.appendChild(overlay);

    panel = document.createElement('div');
    panel.id = 'team-slide';
    panel.style.cssText = 'position:fixed;top:0;right:0;height:100vh;width:440px;max-width:98vw;background:var(--card);z-index:3501;box-shadow:-4px 0 30px rgba(0,0,0,.18);transform:translateX(100%);transition:transform .25s cubic-bezier(.4,0,.2,1);display:flex;flex-direction:column;';
    panel.innerHTML = `
      <div style="background:var(--green);padding:14px 18px;display:flex;align-items:center;gap:12px;flex-shrink:0;">
        <div style="flex:1;">
          <div id="tsl-title" style="font-family:'Barlow Condensed',sans-serif;font-weight:900;font-size:18px;color:#fff;text-transform:uppercase;letter-spacing:.5px;"></div>
          <div id="tsl-sub" style="font-size:11px;color:rgba(255,255,255,.7);margin-top:1px;"></div>
        </div>
        <button onclick="closeTeamSlide()" style="background:rgba(255,255,255,.15);border:1px solid rgba(255,255,255,.3);color:#fff;width:30px;height:30px;border-radius:50%;font-size:16px;cursor:pointer;">×</button>
      </div>
      <div id="tsl-stats" style="background:var(--bg);border-bottom:1.5px solid var(--border);padding:10px 16px;display:flex;gap:16px;flex-shrink:0;flex-wrap:wrap;font-size:12px;"></div>
      <div id="tsl-filters" style="display:flex;border-bottom:1.5px solid var(--border);flex-shrink:0;background:#fff;overflow-x:auto;"></div>
      <div id="tsl-body" style="flex:1;overflow-y:auto;padding:12px 14px;"></div>
      <div style="padding:12px 16px;border-top:1.5px solid var(--border);background:#fff;flex-shrink:0;">
        <button class="msecondary" onclick="closeTeamSlide()" style="width:100%;">Close</button>
      </div>`;
    document.body.appendChild(panel);
  }

  overlay.style.display = 'block';
  panel.style.transform = 'translateX(0)';
  _renderTeamSlide();
}

function _renderTeamSlide() {
  const teamId  = _teamSlideId;
  const teams   = plSeasonTeams();
  const team    = teams.find(t => t.id === teamId);
  if (!team) return;

  const allRows = (plData.seasons||[]).filter(s => +s.year === +plSeason);
  const pm      = plPlayerMap();

  // Players assigned to THIS team
  const assignedIds = new Set(allRows.filter(s => s.assignedTeam === teamId).map(s => s.profileId));

  // Build player list: only eligible players for this team's age group (+ dispensation players)
  // Plus anyone already assigned to this team regardless of eligibility
  const players = allRows.map(r => {
    const p   = pm[r.profileId] || {};
    const nat = playerNaturalAge(r);
    const ag  = effectiveAgeGroup(r);
    const eligible = playerEligibleGroups(r, p);
    const hasDisp  = r.dispensation === true || r.dispensation === 'true';
    const onThisTeam = assignedIds.has(r.profileId);
    // Include if: on this team, OR has dispensation, OR eligible for team's age group, OR team has no age group set
    const include = onThisTeam || hasDisp || !team.ageGroup || eligible.includes(team.ageGroup);
    return { r, p, nat, ag, assigned: assignedIds.has(r.profileId), include };
  }).filter(e => e.p.firstName && e.include)
    .sort((a, b) => {
      if (a.assigned !== b.assigned) return a.assigned ? -1 : 1;
      return (a.nat||0) - (b.nat||0) || (a.p.lastName||'').localeCompare(b.p.lastName||'');
    });

  // Filter
  const agGroups = [...new Set(players.map(e => e.ag).filter(Boolean))].sort();
  let visible = players;
  if (_teamSlideFilter === 'assigned')   visible = players.filter(e => e.assigned);
  if (_teamSlideFilter === 'unassigned') visible = players.filter(e => !e.r.assignedTeam);
  if (_teamSlideFilter.startsWith('ag:')) {
    const filterAG = _teamSlideFilter.slice(3);
    visible = players.filter(e => e.ag === filterAG);
  }

  const assignedCount = players.filter(e => e.assigned).length;

  document.getElementById('tsl-title').textContent = team.name;
  document.getElementById('tsl-sub').textContent   = assignedCount + ' assigned · click player to toggle';
  const totalUnassigned = allRows.filter(s => !s.assignedTeam).length;
  document.getElementById('tsl-stats').innerHTML   = `
    <span><strong>${assignedCount}</strong> on this team</span>
    <span style="color:var(--text-dim);">|</span>
    <span>${totalUnassigned} have no team</span>
    ${team.coach ? `<span style="color:var(--text-dim);">|</span><span>👤 ${team.coach}</span>` : ''}
  `;

  // Filter tabs: All | Assigned | Unassigned | each age group (label as "Age X on Jan 1")
  document.getElementById('tsl-filters').innerHTML = [
    { key: 'all',        label: `All (${players.length})` },
    { key: 'assigned',   label: `On team (${assignedCount})` },
    { key: 'unassigned', label: `No team (${allRows.filter(s=>!s.assignedTeam).length})` },
    ...agGroups.map(ag => {
      // Convert UXX → "Age X on Jan 1" for display
      const agNum = parseInt(ag.slice(1));
      const displayLabel = isNaN(agNum) ? ag : 'Age ' + (agNum - 1);
      return { key: 'ag:' + ag, label: displayLabel + ' (' + players.filter(e=>e.ag===ag).length + ')' };
    })
  ].map(f => `<button class="pl-tab${_teamSlideFilter===f.key?' act':''}"
    onclick="tslSetFilter('${f.key}')"
    style="flex-shrink:0;padding:8px 12px;font-size:11px;">${f.label}</button>`).join('');

  if (!visible.length) {
    document.getElementById('tsl-body').innerHTML =
      '<div style="text-align:center;padding:30px;color:var(--text-dim);">No players in this view.</div>';
    return;
  }

  document.getElementById('tsl-body').innerHTML = visible.map(({ r, p, ag, nat, assigned }) => {
    const pid  = r.profileId;
    const dob  = normaliseDobFE(p.dob) || p.dob || '—';
    const gender = p.gender === 'Male' ? '♂' : p.gender === 'Female' ? '♀' : '';
    // Check if assigned to a different team
    const otherTeam = r.assignedTeam && r.assignedTeam !== teamId
      ? (teams.find(t => t.id === r.assignedTeam)||{}).name : null;

    return `<div id="tsl-row-${pid}" onclick="toggleTeamPlayer('${pid}','${r.id}')"
        style="display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:10px;cursor:pointer;margin-bottom:6px;
               border:2px solid ${assigned ? 'var(--green)' : 'var(--border)'};
               background:${assigned ? 'var(--green-light)' : '#fff'};transition:all .12s;"
        onmouseenter="if(!this.classList.contains('tsl-saving'))this.style.background='${assigned?'#dcfce7':'#f0fdf4'}'"
        onmouseleave="this.style.background='${assigned ? 'var(--green-light)' : '#fff'}'">
      <!-- Tick circle -->
      <div style="width:22px;height:22px;border-radius:50%;border:2px solid ${assigned ? 'var(--green)' : '#d1d5db'};
                  background:${assigned ? 'var(--green)' : '#fff'};display:flex;align-items:center;justify-content:center;flex-shrink:0;">
        ${assigned ? '<span style="color:#fff;font-size:12px;font-weight:900;">✓</span>' : ''}
      </div>
      <!-- Avatar -->
      <div style="width:34px;height:34px;border-radius:50%;background:${assigned ? 'var(--green)' : 'var(--green-light)'};
                  display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:900;
                  color:${assigned ? '#fff' : 'var(--green)'};font-family:'Barlow Condensed',sans-serif;flex-shrink:0;">
        ${plInitials(p)}
      </div>
      <!-- Info -->
      <div style="flex:1;min-width:0;">
        <div style="font-weight:700;font-size:13px;">${plName(p)} <span style="color:var(--text-dim);font-weight:400;font-size:12px;">${gender}</span></div>
        <div style="font-size:11px;color:var(--text-dim);margin-top:1px;">
          ${nat !== null ? `<span style="background:var(--green-light);color:var(--green);font-size:10px;font-weight:700;padding:1px 5px;border-radius:6px;margin-right:4px;">Age ${nat} on Jan 1</span>` : ''}
          DOB: ${dob}
        </div>
        ${otherTeam ? `<div style="font-size:10px;font-weight:700;color:#ca8a04;margin-top:2px;">⚠ On ${otherTeam}</div>` : ''}
      </div>
      <div style="color:var(--text-dim);font-size:16px;flex-shrink:0;">${assigned ? '✓' : '+'}</div>
    </div>`;
  }).join('');
}

function tslSetFilter(f) {
  _teamSlideFilter = f;
  _renderTeamSlide();
}

async function toggleTeamPlayer(profileId, seasonRowId) {
  const teamId  = _teamSlideId;
  const allRows = (plData.seasons||[]).filter(s => +s.year === +plSeason);
  const row     = allRows.find(s => s.profileId === profileId);
  if (!row) return;

  const isAssigned = row.assignedTeam === teamId;
  const newTeamId  = isAssigned ? '' : teamId;

  // Optimistic update
  row.assignedTeam = newTeamId;
  _renderTeamSlide();

  const res = await api('updatePlayerSeason', { id: row.id, assignedTeam: newTeamId });
  if (res.error) {
    // Revert
    row.assignedTeam = isAssigned ? teamId : '';
    _renderTeamSlide();
    showToast('Failed to update: ' + res.error, 'err');
    return;
  }

  // Refresh team cards in background
  if (document.querySelector('#pl-body .mprimary')) renderPlTeams();
}

function closeTeamSlide() {
  const overlay = document.getElementById('team-slide-overlay');
  const panel   = document.getElementById('team-slide');
  if (overlay) overlay.style.display = 'none';
  if (panel)   panel.style.transform = 'translateX(100%)';
  _teamSlideId = null;
  // Refresh cards with latest counts
  renderPlTeams();
}


function openTeamModal(teamId) {
  const overlay = document.getElementById('team-modal-overlay');
  const t = teamId ? (plData.teams||[]).find(t=>t.id===teamId) : null;
  document.getElementById('team-modal-title').textContent = t ? 'Edit Team' : 'Add Team';
  document.getElementById('tm-id').value       = t?.id || '';
  document.getElementById('tm-name').value     = t?.name || '';
  document.getElementById('tm-age').value      = t?.ageGroup || '';
  document.getElementById('tm-gender').value   = t?.gender || '';
  document.getElementById('tm-coach').value    = t?.coach || '';
  document.getElementById('tm-acoach').value   = t?.assistantCoach || '';
  document.getElementById('tm-notes').value    = t?.notes || '';
  document.getElementById('tm-min').value      = t?.minPlayers || '';
  document.getElementById('tm-estimate').value       = t?.estimateCount || '';
  document.getElementById('tm-estimate-names').value = (t?.estimateNames || []).join('\n');
  overlay.classList.add('open');
}

function closeTeamModal() {
  const overlay = document.getElementById('team-modal-overlay');
  if (overlay) overlay.classList.remove('open');
}

async function saveTeamModal() {
  const name = document.getElementById('tm-name').value.trim();
  if (!name) { showToast('Team name is required', 'err'); return; }
  const _estVal = parseInt(document.getElementById('tm-estimate').value) || 0;
  const _tmId   = document.getElementById('tm-id').value;
  if (_estVal > 0) {
    const _registeredCount = _tmId ? ((plData.seasons||[]).filter(s => +s.year===+plSeason && s.assignedTeam===_tmId).length) : 0;
    if (_estVal <= _registeredCount) { showToast('Club estimate must be greater than registered count (' + _registeredCount + ')', 'warn'); return; }
  }
  const payload = {
    id:             document.getElementById('tm-id').value || undefined,
    season:         plSeason,
    name,
    ageGroup:       document.getElementById('tm-age').value,
    gender:         document.getElementById('tm-gender').value,
    coach:          document.getElementById('tm-coach').value.trim(),
    assistantCoach: document.getElementById('tm-acoach').value.trim(),
    notes:          document.getElementById('tm-notes').value.trim(),
    minPlayers:     parseInt(document.getElementById('tm-min').value) || 0,
    estimateCount:  parseInt(document.getElementById('tm-estimate').value) || 0,
    estimateNames:  document.getElementById('tm-estimate-names').value.split('\n').map(s=>s.trim()).filter(Boolean),
  };
  const res = await api('saveTeam', payload);
  if (res.error) { showToast('Save failed: ' + res.error, 'err'); return; }

  const newTeam  = { ...payload, id: res.id };
  const existing = (plData.teams||[]).findIndex(t => t.id === payload.id);
  if (existing >= 0) plData.teams[existing] = newTeam;
  else { plData.teams = plData.teams || []; plData.teams.push(newTeam); }

  closeTeamModal();
  _invalidateRecruitCache(); // D: fresh data needed after team change
  showToast(payload.id ? 'Team updated ✓' : 'Team added ✓');
  renderPlTeams();
}

async function deleteTeamConfirm(id, name) {
  if (!confirm(`Delete team "${name}"? Players assigned to it will become unassigned.`)) return;
  const res = await api('deleteTeam', { id });
  if (res.error) { showToast('Delete failed: ' + res.error, 'err'); return; }
  plData.teams = (plData.teams||[]).filter(t => t.id !== id);
  (plData.seasons||[]).forEach(s => { if (s.assignedTeam === id) s.assignedTeam = ''; });
  showToast(`Team "${name}" deleted`);
  renderPlTeams();
}

function renderPlImport() {
  _importData = null;
  document.getElementById('pl-body').innerHTML = `
    <div style="max-width:720px;">
      <h3 style="font-family:'Barlow Condensed',sans-serif;font-weight:900;font-size:17px;text-transform:uppercase;margin-bottom:8px;">Import PlayHQ Data</h3>
      ${_lastImportDate ? `<div style="font-size:12px;color:var(--text-dim);margin-bottom:10px;padding:6px 10px;background:var(--bg);border-radius:6px;border:1px solid var(--border);display:inline-block;">
        Last import: <strong>${(function(){
          var d=new Date(_lastImportDate);
          if(isNaN(d.getTime())&&!isNaN(Number(_lastImportDate))) d=new Date((Number(_lastImportDate)-25569)*86400000);
          if(isNaN(d.getTime())&&typeof _lastImportDate==='string'){var m=_lastImportDate.match(/(\d{1,2})\/(\d{1,2})\/(\d{4})/);if(m)d=new Date(+m[3],+m[2]-1,+m[1]);}
          return isNaN(d.getTime()) ? _lastImportDate : d.toLocaleDateString('en-AU',{day:'numeric',month:'short',year:'numeric'});
        })()} — ${plSeason} season</strong>
      </div>` : ''}
      <p style="font-size:13px;color:var(--text-dim);margin-bottom:16px;line-height:1.6;">
        Export a <strong>participants CSV</strong> from the PlayHQ admin portal, then drag it here.
        You'll be able to review all records — included, excluded, and duplicates — before committing.
      </p>
      <div style="margin-bottom:14px;display:flex;gap:10px;align-items:center;">
        <label style="font-size:12px;font-weight:700;color:var(--text-dim);">Import for season:</label>
        <select id="import-season" style="padding:6px 10px;border:1.5px solid var(--border);border-radius:6px;font-size:13px;"
          onchange="if(_importData){_importData=null;document.getElementById('import-review').innerHTML='<div style=\'color:var(--text-dim);font-size:13px;padding:12px 0;\'>Season changed — re-drop your file to re-process with the new season.</div>';}">
          ${(years||[new Date().getFullYear()]).map(y=>`<option value="${y}" ${y==plSeason?'selected':''}>${y}</option>`).join('')}
        </select>
      </div>
      <div class="import-drop" id="import-drop"
        ondragover="event.preventDefault();this.classList.add('drag')"
        ondragleave="this.classList.remove('drag')"
        ondrop="handleImportDrop(event)"
        onclick="document.getElementById('import-file-input').click()">
        <div style="font-size:32px;margin-bottom:8px;">📂</div>
        <div style="font-weight:700;font-size:14px;margin-bottom:4px;">Drop participants CSV here</div>
        <div style="font-size:12px;color:var(--text-dim);">or click to browse · PlayHQ participants export</div>
      </div>
      <input type="file" id="import-file-input" accept=".csv" style="display:none" onchange="handleImportFile(this.files[0])">
      <div id="import-review" style="margin-top:20px;"></div>

      <!-- ── ONE-OFF: Backfill registration dates (admin only) ─── -->
      ${me && me.admin ? `
        <details style="margin-top:28px;border:1.5px solid #fbbf24;border-radius:10px;overflow:hidden;">
        <summary style="cursor:pointer;padding:10px 14px;background:#fffbeb;font-size:12px;font-weight:700;color:#92400e;list-style:none;display:flex;align-items:center;gap:8px;">
          <span>🛠️</span> <span>One-off: Backfill Season Snapshot</span>
          <span style="margin-left:auto;font-size:10px;font-weight:400;color:#b45309;">Admin tool — run once per historical season</span>
        </summary>
        <div style="padding:14px 16px;background:#fffdf5;border-top:1px solid #fde68a;">
          <p style="font-size:12px;color:#78350f;margin:0 0 10px;line-height:1.6;">
            Upload the original PlayHQ participants CSV for a historical season. This tool patches
            <strong>registration date, school, suburb and address</strong> into the Seasons sheet for existing players —
            so historical views show the correct data for that year, not current profile data.
            Run once per historical season.
          </p>
          <div style="display:flex;gap:10px;align-items:center;margin-bottom:10px;flex-wrap:wrap;">
            <label style="font-size:12px;font-weight:700;color:#78350f;">Season:</label>
            <select id="backfill-season" style="padding:5px 8px;border:1.5px solid #fde68a;border-radius:6px;font-size:12px;background:#fff;">
              ${(years||[new Date().getFullYear()]).map(y=>`<option value="${y}" ${y==plSeason?'selected':''}>${y}</option>`).join('')}
            </select>
            <label style="font-size:12px;font-weight:700;color:#78350f;">CSV file:</label>
            <input type="file" id="backfill-file-input" accept=".csv" style="font-size:12px;">
          </div>
          <button onclick="runDateBackfill()" style="background:#ca8a04;color:#fff;border:none;border-radius:6px;padding:7px 14px;font-size:12px;font-weight:700;cursor:pointer;">
            📅 Patch Dates
          </button>
          <div id="backfill-status" style="margin-top:10px;font-size:12px;"></div>
        </div>
      </details>

      <!-- ── TESTING: Clear season players ────────────────────────── -->
      <details style="margin-top:12px;border:1.5px solid #fca5a5;border-radius:10px;overflow:hidden;">
        <summary style="cursor:pointer;padding:10px 14px;background:#fff5f5;font-size:12px;font-weight:700;color:#991b1b;list-style:none;display:flex;align-items:center;gap:8px;">
          <span>🗑️</span> <span>Testing: Clear Season Players</span>
          <span style="margin-left:auto;font-size:10px;font-weight:400;color:#b91c1c;">Destructive — use for testing imports only</span>
        </summary>
        <div style="padding:14px 16px;background:#fff8f8;border-top:1px solid #fca5a5;">
          <p style="font-size:12px;color:#7f1d1d;margin:0 0 10px;line-height:1.6;">
            Deletes all <strong>PlayerSeasons rows</strong> for the selected season so you can re-import cleanly.
            Player records in the Players sheet are <strong>not affected</strong> — only the season registrations.
            Use this to test that new imports correctly capture registration dates.
          </p>
          <div style="display:flex;gap:10px;align-items:center;margin-bottom:10px;flex-wrap:wrap;">
            <label style="font-size:12px;font-weight:700;color:#991b1b;">Season to clear:</label>
            <select id="clear-season-sel" style="padding:5px 8px;border:1.5px solid #fca5a5;border-radius:6px;font-size:12px;background:#fff;">
              ${(years||[new Date().getFullYear()]).map(y=>`<option value="${y}" ${y==plSeason?'selected':''}>${y}</option>`).join('')}
            </select>
          </div>
          <button onclick="runClearSeason()" style="background:#dc2626;color:#fff;border:none;border-radius:6px;padding:7px 14px;font-size:12px;font-weight:700;cursor:pointer;">
            🗑️ Clear Season Players
          </button>
          <div id="clear-season-status" style="margin-top:10px;font-size:12px;"></div>
        </div>
      </details>
      ` : ''}
    </div>
  `;
}

async function runDateBackfill() {
  const fileInput  = document.getElementById('backfill-file-input');
  const seasonSel  = document.getElementById('backfill-season');
  const statusEl   = document.getElementById('backfill-status');
  if (!fileInput || !fileInput.files[0]) {
    statusEl.innerHTML = '<span style="color:#dc2626;">⚠️ Please select a CSV file first.</span>'; return;
  }
  const season = +seasonSel.value;
  statusEl.innerHTML = '<span style="color:#78350f;">Reading file…</span>';

  const reader = new FileReader();
  reader.onload = async ev => {
    const rows = parseCSV(ev.target.result).filter(r => (r['First Name']||'').trim());
    if (!rows.length) {
      statusEl.innerHTML = '<span style="color:#dc2626;">⚠️ No rows found in CSV.</span>'; return;
    }

    const sampleKeys = Object.keys(rows[0]);
    const dateCol = ['Registration Timestamp','Registration Date','Created Date','Registered Date'].find(c => sampleKeys.includes(c));
    if (!dateCol) {
      statusEl.innerHTML = `<span style="color:#dc2626;">⚠️ No registration date column found. Available: ${sampleKeys.join(', ')}</span>`; return;
    }

    // Build patches: registration date + demographic snapshot
    const patches = [];
    rows.forEach(r => {
      const profileId = (r['Profile ID']||'').trim();
      if (!profileId) return;
      const patch = {
        profileId,
        season,
        registrationDate: (r[dateCol]||'').trim(),
        school:    toTitleCaseJS((r['School Details']||'').trim()),
        schoolYear:(r['School Year']||'').trim(),
        address:   toTitleCaseJS((r['Participant Address']||'').trim()),
        suburb:    toTitleCaseJS((r['Participant Suburb/Town']||'').trim()),
        postcode:  (r['Participant Postcode']||'').trim(),
      };
      if (patch.registrationDate || patch.school || patch.suburb) patches.push(patch);
    });

    if (!patches.length) {
      statusEl.innerHTML = '<span style="color:#dc2626;">⚠️ No patchable rows found.</span>'; return;
    }

    statusEl.innerHTML = `<span style="color:#78350f;">Patching ${patches.length} records in batches…</span>`;
    try {
      const res = await apiBatched('patchRegistrationDates', { patches }, 5);
      if (res.error) throw new Error(res.error);
      statusEl.innerHTML = `<span style="color:#16a34a;">✅ Patched ${res.patched||patches.length} records for ${season}. Refresh to see updated charts and school data.</span>`;
    } catch(e) {
      statusEl.innerHTML = `<span style="color:#dc2626;">❌ Error: ${e.message}</span>`;
    }
  };
  reader.readAsText(fileInput.files[0]);
}

async function runClearSeason() {
  const seasonSel = document.getElementById('clear-season-sel');
  const statusEl  = document.getElementById('clear-season-status');
  const season    = +seasonSel.value;

  // Double-confirm — this is destructive
  if (!confirm(`Delete ALL player registrations for the ${season} season?\n\nThis removes season rows only — player records are kept.\nUse only for testing imports.`)) return;

  statusEl.innerHTML = `<span style="color:#991b1b;">Clearing ${season} season players…</span>`;
  try {
    const res = await api('clearSeasonPlayers', { season });
    if (res.error) throw new Error(res.error);
    statusEl.innerHTML = `<span style="color:#16a34a;">✅ Deleted ${res.deleted} season rows for ${season}. You can now re-import to test registration date capture.</span>`;
    // Reload data so the dashboard reflects the cleared state
    plData   = null;
    plSeason = season;
    loadAll();
  } catch(e) {
    statusEl.innerHTML = `<span style="color:#dc2626;">❌ Error: ${e.message}</span>`;
  }
}

function handleImportDrop(e) {
  e.preventDefault();
  document.getElementById('import-drop').classList.remove('drag');
  const file = e.dataTransfer.files[0];
  if (file) handleImportFile(file);
}

function handleImportFile(file) {
  if (!file) return;
  const review = document.getElementById('import-review');
  review.innerHTML = '<div style="color:var(--text-dim);font-size:13px;padding:16px 0;">Reading file…</div>';

  const reader = new FileReader();
  reader.onload = ev => {
    const allRows  = parseCSV(ev.target.result).filter(r => (r['First Name']||'').trim());

    // ── Auto-detect season from CSV's own Season column ──────────────
    // The CSV contains a "Season" column (e.g. "2026") — always use this
    // so historical imports calculate age against the correct year, not today's season.
    const csvSeason = allRows.find(r => r['Season'] && /^\d{4}$/.test((r['Season']||'').trim()))?.['Season']?.trim();
    const selEl     = document.getElementById('import-season');
    let   season    = +selEl.value;

    if (csvSeason) {
      season = +csvSeason;
      // Add option if not already in selector
      if (![...selEl.options].some(o => +o.value === season)) {
        const opt = document.createElement('option');
        opt.value = season; opt.textContent = season;
        selEl.appendChild(opt);
      }
      selEl.value = season;
    }

    // Compare against the import selector's value (not plSeason, which is the main
    // dashboard season and may legitimately differ from the import target year)
    const importSelSeason = +selEl.value;
    const seasonChanged = csvSeason && +csvSeason !== importSelSeason;

    // Build existing player lookup for duplicate detection
    const pm = plPlayerMap();
    const existingSeasonIds = new Set(
      (plData?.seasons||[]).filter(s=>+s.year===season).map(s=>s.profileId)
    );

    // Categorise every row
    const categorised = allRows.map((r, idx) => {
      const firstName = toTitleCase((r['First Name']||'').trim());
      const lastName  = toTitleCase((r['Last Name']||'').trim());
      const dob       = (r['Date of Birth']||'').trim();
      const profileId = (r['Profile ID']||'').trim() ||
                        'kjfc_'+firstName.toLowerCase()+'_'+lastName.toLowerCase()+'_'+dob.replace(/\//g,'');
      // Age is always calculated against the SEASON year (what age they turn in that calendar year)
      const age       = calcAgeClient(dob, season);
      const ageGroup  = (r['Age Group']||'').toUpperCase();
      const role      = (r['Role']||'').trim();
      const club      = (r['Club']||'').trim();
      const status    = (r['Status']||'').trim();
      const gender    = (r['Gender']||'').trim();
      const school    = (r['School Details']||'').trim().replace(/,.*$/,'');
      const suburb    = (r['Participant Suburb/Town']||'').trim();
      // Registration date — PlayHQ exports this as "Registration Date" or "Created Date"
      const registrationDate = (r['Registration Timestamp']||r['Registration Date']||r['Created Date']||r['Registered Date']||'').trim();

      // Exclusion reasons
      let excludeReason = null;
      if (status && status !== 'Active' && status !== 'Pending') excludeReason = `Status: ${status}`;
      else if (role && role !== 'Player')                         excludeReason = `Role: ${role}`;
      else if (club && !club.toLowerCase().includes('kinglake'))  excludeReason = `Club: ${club}`;
      else if (ageGroup === 'SENIOR')                             excludeReason = 'Senior (age group tag)';
      else if (age !== null && age > 17)                          excludeReason = `Over 17 (age ${age} in ${season})`;
      else if (age !== null && age < 5)                           excludeReason = `Age error (age ${age})`;

      // Duplicate detection
      let dupType = null;
      if (!excludeReason) {
        if (existingSeasonIds.has(profileId)) {
          dupType = 'already_this_season';
        } else {
          if (pm[profileId]) {
            dupType = 'returning';
          } else {
            const nameKey = `${firstName.toLowerCase()}_${lastName.toLowerCase()}_${dob}`;
            const fuzzyMatch = Object.values(pm).find(p =>
              `${p.firstName.toLowerCase()}_${p.lastName.toLowerCase()}_${p.dob}` === nameKey
            );
            if (fuzzyMatch) dupType = 'name_dob_match';

            const csvDup = allRows.slice(0, idx).find(prev =>
              (prev['First Name']||'').trim().toLowerCase() === firstName.toLowerCase() &&
              (prev['Last Name']||'').trim().toLowerCase()  === lastName.toLowerCase()  &&
              (prev['Date of Birth']||'').trim()            === dob
            );
            if (csvDup) dupType = 'csv_duplicate';
          }
        }
      }

      return { r, idx, firstName, lastName, dob, profileId, age, ageGroup, gender, school, suburb,
               excludeReason, dupType,
               // Pre-checked: new players + returning (contact update) + name_dob_match (contact update)
               // Unchecked: already_this_season (skip), csv_duplicate (skip), any excluded row
               _checked: !excludeReason && dupType !== 'already_this_season' && dupType !== 'csv_duplicate' };
    });

    _importData = { season, rows: categorised, file: file.name, rawCsv: ev.target.result };
    renderImportReview(categorised, season, file.name, seasonChanged ? csvSeason : null);
  };
  reader.readAsText(file);
}

function renderImportReview(rows, season, filename, autoDetectedSeason) {
  const review = document.getElementById('import-review');

  const include = rows.filter(r => !r.excludeReason);
  const exclude = rows.filter(r =>  r.excludeReason);
  const dups    = include.filter(r => r.dupType && r.dupType !== 'returning');
  const fresh   = include.filter(r => !r.dupType);
  const returning = include.filter(r => r.dupType === 'returning');

  const tabs = [
    { id:'inc',  label:`✓ Include (${include.length})`,  colour:'var(--green)' },
    { id:'exc',  label:`✗ Excluded (${exclude.length})`, colour:'var(--red)'   },
    { id:'dup',  label:`⚠ Flagged (${dups.length})`,    colour:'#ca8a04'      },
  ];

  review.innerHTML = `
    <!-- Auto-detect notice: only shown when CSV season differs from selector -->
    ${autoDetectedSeason ? `
    <div style="background:#fefce8;border:1.5px solid #fde68a;border-radius:10px;padding:10px 14px;margin-bottom:12px;display:flex;gap:8px;align-items:center;">
      <span style="font-size:16px;">⚠️</span>
      <div style="font-size:13px;">CSV season (<strong>${autoDetectedSeason}</strong>) differs from the selected import season (<strong>${season}</strong>). Ages are calculated against <strong>end of ${season}</strong>. Use the selector above to correct this if needed.</div>
    </div>` : ''}

    <!-- Summary bar -->
    <div style="background:var(--green-light);border:1.5px solid var(--green);border-radius:10px;padding:13px 16px;margin-bottom:16px;">
      <div style="font-weight:700;font-size:14px;color:var(--green);margin-bottom:6px;">📂 ${filename} — Season ${season}</div>
      <div style="display:flex;gap:20px;flex-wrap:wrap;font-size:13px;">
        <span><strong style="color:var(--green)">${include.length}</strong> to include</span>
        <span><strong style="color:var(--red)">${exclude.length}</strong> excluded</span>
        <span><strong style="color:#ca8a04">${dups.length}</strong> flagged</span>
        <span><strong>${fresh.length}</strong> new · <strong>${returning.length}</strong> update contact details · <strong>${rows.filter(r=>r.dupType==='already_this_season').length}</strong> already imported</span>
      </div>
      <div style="font-size:11px;color:var(--text-dim);margin-top:5px;">Age eligibility assessed at end of ${season} (player's age turning during ${season} calendar year)</div>
    </div>

    <!-- View tabs -->
    <div style="display:flex;gap:0;margin-bottom:0;border-bottom:2px solid var(--border);">
      ${tabs.map((t,i)=>`<button class="imp-vtab${i===0?' act':''}" data-vtab="${t.id}"
        onclick="switchImportTab(this,'${t.id}')"
        style="padding:8px 16px;background:transparent;border:none;border-bottom:3px solid ${i===0?t.colour:'transparent'};
               font-size:12px;font-weight:700;cursor:pointer;color:${i===0?t.colour:'var(--text-dim)'};
               font-family:'Barlow Condensed',sans-serif;text-transform:uppercase;letter-spacing:.5px;white-space:nowrap;">
        ${t.label}</button>`).join('')}
      <div style="flex:1;"></div>
      <button onclick="importToggleAll(true)"  style="font-size:11px;padding:6px 10px;background:transparent;border:none;color:var(--green);cursor:pointer;font-weight:700;">✓ All</button>
      <button onclick="importToggleAll(false)" style="font-size:11px;padding:6px 10px;background:transparent;border:none;color:var(--red);cursor:pointer;font-weight:700;">✗ None</button>
    </div>

    <!-- Record list -->
    <div id="imp-list" style="max-height:420px;overflow-y:auto;border:1.5px solid var(--border);border-top:none;border-radius:0 0 8px 8px;"></div>

    <!-- Confirm bar -->
    <div style="margin-top:14px;display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
      <div id="imp-sel-count" style="flex:1;font-size:13px;color:var(--text-dim);"></div>
      <button class="msecondary" onclick="renderPlImport()">← Start over</button>
      <button class="mprimary" id="imp-confirm-btn" onclick="runImport()">Import selected players</button>
    </div>
  `;

  renderImportTab('inc', rows);
  updateImportCount(rows);
}

function switchImportTab(btn, tabId) {
  document.querySelectorAll('.imp-vtab').forEach(b => {
    b.style.borderBottomColor = 'transparent';
    b.style.color = 'var(--text-dim)';
    b.classList.remove('act');
  });
  const colours = { inc:'var(--green)', exc:'var(--red)', dup:'#ca8a04' };
  btn.style.borderBottomColor = colours[tabId]||'var(--green)';
  btn.style.color = colours[tabId]||'var(--green)';
  btn.classList.add('act');
  renderImportTab(tabId, _importData.rows);
}

function renderImportTab(tabId, rows) {
  const list = document.getElementById('imp-list');
  if (!list) return;

  let filtered;
  if (tabId === 'inc') filtered = rows.filter(r => !r.excludeReason);
  else if (tabId === 'exc') filtered = rows.filter(r =>  r.excludeReason);
  else filtered = rows.filter(r => !r.excludeReason && r.dupType);

  if (!filtered.length) {
    list.innerHTML = `<div style="padding:24px;text-align:center;color:var(--text-dim);font-size:13px;">No records in this category.</div>`;
    return;
  }

  const dupColour = {
    already_this_season: { bg:'#f0fdf4', badge:'#16a34a', label:'Already imported' },
    returning:           { bg:'#eff6ff', badge:'#2563eb', label:'Returning — will update contact details' },
    name_dob_match:      { bg:'#fefce8', badge:'#ca8a04', label:'Name+DOB match — will update contact details' },
    csv_duplicate:       { bg:'#fef2f2', badge:'#dc2626', label:'Duplicate in file' },
  };

  list.innerHTML = filtered.map(item => {
    const age     = item.age;
    const ageDisp = age ? `U${age}` : (item.ageGroup||'?');
    const dc      = item.dupType ? dupColour[item.dupType] : null;
    const rowBg   = item.excludeReason ? '#fef2f2' : (dc?.bg || '#fff');
    const canCheck = !item.excludeReason;

    return `<div style="display:flex;align-items:center;gap:10px;padding:9px 12px;border-bottom:1px solid var(--border);background:${rowBg};${!item._checked&&canCheck?'opacity:.6':''}" id="imp-row-${item.idx}">
      ${canCheck
        ? `<input type="checkbox" ${item._checked?'checked':''} onchange="importToggleRow(${item.idx},this.checked)"
             style="width:15px;height:15px;cursor:pointer;accent-color:var(--green);flex-shrink:0;">`
        : `<div style="width:15px;height:15px;flex-shrink:0;"></div>`}
      <div style="flex:1;min-width:0;">
        <div style="font-size:13px;font-weight:600;">${toTitleCase(item.firstName)} ${toTitleCase(item.lastName)}
          ${dc ? `<span style="background:${dc.bg};color:${dc.badge};border:1px solid ${dc.badge};font-size:9px;font-weight:700;border-radius:4px;padding:1px 5px;margin-left:4px;text-transform:uppercase;">${dc.label}</span>` : ''}
          ${item.excludeReason ? `<span style="background:#fee2e2;color:#dc2626;font-size:9px;font-weight:700;border-radius:4px;padding:1px 5px;margin-left:4px;">${item.excludeReason}</span>` : ''}
        </div>
        <div style="font-size:11px;color:var(--text-dim);margin-top:1px;">
          ${ageDisp} · ${item.gender||'—'} · DOB ${item.dob||'—'} · ${item.school||item.suburb||'—'}
        </div>
      </div>
    </div>`;
  }).join('');
}

function importToggleRow(idx, checked) {
  if (!_importData) return;
  const item = _importData.rows.find(r => r.idx === idx);
  if (item) item._checked = checked;
  const row = document.getElementById(`imp-row-${idx}`);
  if (row) row.style.opacity = checked ? '1' : '0.6';
  updateImportCount(_importData.rows);
}

function importToggleAll(checked) {
  if (!_importData) return;
  _importData.rows.forEach(r => { if (!r.excludeReason) r._checked = checked; });
  // Re-render the active tab
  const activeTab = document.querySelector('.imp-vtab.act');
  const tabId = activeTab?.dataset?.vtab || 'inc';
  renderImportTab(tabId, _importData.rows);
  updateImportCount(_importData.rows);
}

function updateImportCount(rows) {
  const sel = rows.filter(r => r._checked).length;
  const el  = document.getElementById('imp-sel-count');
  const btn = document.getElementById('imp-confirm-btn');
  if (el)  el.textContent  = `${sel} player${sel!==1?'s':''} selected for import`;
  if (btn) btn.textContent = `Import ${sel} player${sel!==1?'s':''}`;
  if (btn) btn.disabled    = sel === 0;
}

async function runImport() {
  if (!_importData) return;
  const selected = _importData.rows.filter(r => r._checked);
  const season   = _importData.season;
  if (!selected.length) { showToast('No players selected', 'err'); return; }

  const btn     = document.getElementById('imp-confirm-btn');
  const countEl = document.getElementById('imp-sel-count');
  btn.disabled  = true;
  console.log('[KJFC import] Starting import: ' + selected.length + ' players, season ' + season);

  const setStatus = (msg, colour) => {
    if (!countEl) return;
    countEl.innerHTML = `<span style="font-size:13px;color:${colour||'var(--text-dim)'};">${msg}</span>`;
  };

  // ── Step 1: Build filtered CSV (only selected rows) ───────────────────────
  setStatus('Preparing CSV…');
  const allParsed   = parseCSV(_importData.rawCsv);
  const selectedKeys = new Set(selected.map(item => {
    const r = item.r;
    return (r['Profile ID']||'').trim() ||
      ((r['First Name']||'').trim()+'_'+(r['Last Name']||'').trim()+'_'+(r['Date of Birth']||'').trim());
  }));
  const filteredRows = allParsed.filter(r => {
    const key = (r['Profile ID']||'').trim() ||
      ((r['First Name']||'').trim()+'_'+(r['Last Name']||'').trim()+'_'+(r['Date of Birth']||'').trim());
    return selectedKeys.has(key);
  });
  const csvHeaders = Object.keys(allParsed[0] || {});
  const esc = v => { const s = String(v||''); return (s.includes(',') || s.includes('"') || s.includes('\n')) ? '"'+s.replace(/"/g,'""')+'"' : s; };
  const csvText = [
    csvHeaders.map(esc).join(','),
    ...filteredRows.map(r => csvHeaders.map(h => esc(r[h]||'')).join(','))
  ].join('\n');

  // ── Step 2: Chunked JSONP upload via ScriptProperties ────────────────────
  // CSV is base64-encoded first to eliminate special chars (commas, quotes,
  // slashes) that would bloat URLs when JSON+encodeURIComponent'd.
  // Base64 output is only A-Za-z0-9+/= — ~2% URL encoding overhead vs ~50% raw.
  // 65KB CSV → ~87KB base64, split into 2000-char chunks = ~44 JSONP calls.
  // Each URL stays under 2500 chars — well within all limits.
  const b64Csv = btoa(unescape(encodeURIComponent(csvText)));
  const CHUNK_SIZE = 2000; // base64 chars per chunk — safe for URL encoding
  const chunks = [];
  for (let i = 0; i < b64Csv.length; i += CHUNK_SIZE) {
    chunks.push(b64Csv.slice(i, i + CHUNK_SIZE));
  }
  console.log('[KJFC import] Uploading ' + chunks.length + ' chunks (' + csvText.length + ' chars total)');

  // 2a: Start upload session
  setStatus('Starting upload… (0/' + chunks.length + ')');
  const startRes = await api('startUpload', { totalChunks: chunks.length });
  if (startRes.error) {
    btn.disabled = false;
    setStatus('❌ Upload failed: ' + startRes.error, '#dc2626');
    showToast('Upload failed: ' + startRes.error, 'err');
    return;
  }
  const uploadId = startRes.uploadId;

  // 2b: Send chunks in parallel batches of 8 — ~8x faster than sequential
  const PARALLEL = 8;
  let sent = 0;
  for (let i = 0; i < chunks.length; i += PARALLEL) {
    const batch = chunks.slice(i, i + PARALLEL);
    const results = await Promise.all(
      batch.map((data, j) => api('appendChunk', { uploadId, index: i + j, data }))
    );
    for (let j = 0; j < results.length; j++) {
      if (results[j].error) {
        btn.disabled = false;
        setStatus('❌ Chunk ' + (i+j) + ' failed: ' + results[j].error, '#dc2626');
        showToast('Upload failed: ' + results[j].error, 'err');
        return;
      }
    }
    sent += batch.length;
    setStatus('Uploading… ' + sent + '/' + chunks.length);
  }

  // 2c: Finalise — backend reassembles, saves to Drive, runs import
  setStatus('Importing players…');
  const res = await api('finaliseUpload', { uploadId, season });

  btn.disabled = false;
  console.log('[KJFC import] finaliseUpload result:', JSON.stringify(res));
  if (!res || res.error) {
    setStatus('❌ Import failed: ' + (res && res.error || 'Unknown error'), '#dc2626');
    showToast('Import failed: ' + (res && res.error || 'Unknown error'), 'err');
    return;
  }

  const s = res.stats || {};
  setStatus('✓ Import complete', 'var(--green)');
  _invalidateRecruitCache(); // D: fresh data after import
  showToast(`Import done — ${s.imported} new · ${s.updated} updated · ${s.seniors} seniors excluded${s.errors?' · '+s.errors+' errors':''}`);
  _importData = null;
  plData      = null;
  plSeason    = season;
  // season-sel removed — plSeason set directly below
  await loadPlayerData();
  switchPlTab(document.querySelector('.pl-tab[data-tab="overview"]'), 'overview');
}


// Client-side age calc (mirrors backend)
// Normalise any DOB to DD/MM/YYYY - handles ISO strings and existing strings
function normaliseDob(raw) {
  if (!raw) return '';
  if (raw instanceof Date && !isNaN(raw)) {
    return String(raw.getDate()).padStart(2,'0') + '/' +
           String(raw.getMonth()+1).padStart(2,'0') + '/' + raw.getFullYear();
  }
  const s = String(raw).trim();
  if (/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(s)) return s;
  const iso = s.match(/^(\d{4})-(\d{2})-(\d{2})/);
  if (iso) return iso[3] + '/' + iso[2] + '/' + iso[1];
  return s;
}

function calcAgeClient(dobStr, season) {
  if (!dobStr) return null;
  const s = normaliseDob(dobStr);
  const parts = s.split('/');
  if (parts.length < 3) return null;
  let yr = parseInt(parts[2], 10);
  if (yr < 100) yr += (yr < 30 ? 2000 : 1900);
  return parseInt(season, 10) - yr;
}

function parseCSV(text) {
  const lines = text.split(/\r?\n/);
  if (!lines.length) return [];
  const headers = parseCSVLine(lines[0]);
  const rows = [];
  for (let i = 1; i < lines.length; i++) {
    if (!lines[i].trim()) continue;
    const vals = parseCSVLine(lines[i]);
    if (!vals.some(v=>v.trim())) continue;
    const obj = {};
    headers.forEach((h,i) => obj[h] = vals[i]||'');
    rows.push(obj);
  }
  return rows;
}

function parseCSVLine(line) {
  const result = [];
  let cur = '', inQ = false;
  for (let i = 0; i < line.length; i++) {
    const c = line[i];
    if (c === '"') { inQ = !inQ; }
    else if (c === ',' && !inQ) { result.push(cur); cur = ''; }
    else { cur += c; }
  }
  result.push(cur);
  return result;
}

// ── SETTINGS TAB ─────────────────────────────────────────────────

document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>