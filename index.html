<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>KJFC Exec Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@400;600;700;800;900&family=Barlow:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ROOT VARIABLES
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root{
  --green:        #013C1E;
  --green-mid:    #025a2d;
  --green-light:  #e6f0eb;
  --green-bright: #2e7d4f;
  --yellow:       #FBE201;
  --yellow-dark:  #c9b400;
  --yellow-pale:  #fffde6;
  --yellow-mid:   #fef083;
  --bg:           #f4f6f4;
  --card:         #ffffff;
  --text:         #1a1a1a;
  --text-mid:     #3a3a3a;
  --text-dim:     #6b7a6b;
  --border:       #d8e4d8;
  --border-s:     #adc4ad;
  --red:          #b91c1c;
  --red-light:    #fef2f2;
  --orange:       #c2720a;
  --orange-light: #fef6ec;
  --tg:#9a6700; --tgb:#fffaeb;
  --ts:#4a6070; --tsb:#f0f4f8;
  --tb:#7a4a28; --tbb:#fdf4ec;
  --tc:#013C1E; --tcb:#e6f0eb;
  --sh:  0 1px 4px rgba(0,0,0,0.07);
  --shm: 0 4px 18px rgba(0,0,0,0.11);
  --r:   11px;
  --safe-bottom: env(safe-area-inset-bottom, 0px);
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
html{scroll-behavior:smooth;}
body{background:var(--bg);color:var(--text);font-family:'Barlow',sans-serif;min-height:100vh;font-size:16px;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LOADING SCREEN
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#loading-screen{
  position:fixed;inset:0;z-index:1000;background:var(--green);
  display:flex;flex-direction:column;align-items:center;justify-content:center;gap:20px;
  transition:opacity .5s ease;
}
#loading-screen.fade{opacity:0;pointer-events:none;}
.ls-crest{
  width:80px;height:80px;background:var(--yellow);border-radius:50%;
  display:flex;align-items:center;justify-content:center;
  font-family:'Barlow Condensed',sans-serif;font-weight:900;font-size:24px;color:var(--green);
  animation:ls-pulse 1.8s ease-in-out infinite;
  box-shadow:0 0 0 0 rgba(251,226,1,0.5);
}
@keyframes ls-pulse{
  0%{box-shadow:0 0 0 0 rgba(251,226,1,0.5);transform:scale(1);}
  50%{box-shadow:0 0 0 18px rgba(251,226,1,0);transform:scale(1.06);}
  100%{box-shadow:0 0 0 0 rgba(251,226,1,0);transform:scale(1);}
}
.ls-text{
  font-family:'Barlow Condensed',sans-serif;font-size:15px;
  color:rgba(255,255,255,.55);text-transform:uppercase;letter-spacing:3px;
  animation:ls-blink 1.4s ease-in-out infinite;
}
@keyframes ls-blink{0%,100%{opacity:.4;}50%{opacity:1;}}
.ls-bar{width:160px;height:3px;background:rgba(255,255,255,.15);border-radius:2px;overflow:hidden;}
.ls-bar-fill{height:100%;width:0;background:var(--yellow);border-radius:2px;animation:ls-load 2s ease-in-out forwards;}
@keyframes ls-load{0%{width:0;}60%{width:75%;}90%{width:90%;}100%{width:100%;}}

/* Dashboard fade-in on load */
@keyframes dash-fadein{from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);}}
header{animation:dash-fadein .4s ease both;}
.sbar{animation:dash-fadein .4s ease .1s both;}
main{animation:dash-fadein .5s ease .15s both;}
.ls-spinner{width:28px;height:28px;border:3px solid rgba(255,255,255,.2);border-top-color:var(--yellow);border-radius:50%;animation:spin .8s linear infinite;}
@keyframes spin{to{transform:rotate(360deg);}}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LOGIN SCREEN
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#login-screen{
  position:fixed;inset:0;z-index:999;background:var(--green);
  display:none;align-items:center;justify-content:center;padding:20px;
  overflow-y:auto;
}
#login-screen.show{display:flex;}
.lwrap{display:flex;flex-direction:column;align-items:center;width:100%;max-width:400px;padding:20px 0;}
.lcrest{width:84px;height:84px;background:var(--yellow);border-radius:50%;display:flex;align-items:center;justify-content:center;font-family:'Barlow Condensed',sans-serif;font-weight:900;font-size:26px;color:var(--green);margin-bottom:14px;border:4px solid rgba(255,255,255,.35);box-shadow:0 4px 24px rgba(0,0,0,.3);}
.lclub{font-family:'Barlow Condensed',sans-serif;font-weight:900;font-size:20px;color:#fff;text-transform:uppercase;letter-spacing:1px;text-align:center;line-height:1.2;margin-bottom:3px;}
.ltag{font-size:11px;color:rgba(255,255,255,.55);letter-spacing:2.5px;text-transform:uppercase;margin-bottom:24px;}
.lbox{background:#fff;border-radius:16px;padding:28px 28px 22px;width:100%;box-shadow:0 8px 40px rgba(0,0,0,.22);}
.lbox h2{font-family:'Barlow Condensed',sans-serif;font-weight:900;font-size:18px;text-transform:uppercase;margin-bottom:3px;}
.lbox p{font-size:12px;color:var(--text-dim);margin-bottom:20px;line-height:1.5;}
.google-btn{
  width:100%;padding:13px 16px;border-radius:8px;border:1.5px solid var(--border);
  background:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:10px;
  font-size:14px;font-weight:600;color:var(--text);transition:all .15s;box-shadow:var(--sh);
}
.google-btn:hover{border-color:var(--border-s);box-shadow:var(--shm);}
.google-btn:active{transform:scale(.98);}
.google-icon{width:20px;height:20px;flex-shrink:0;}
.lerr{color:var(--red);font-size:12px;margin-top:10px;text-align:center;min-height:17px;line-height:1.4;}
.lfooter{margin-top:14px;font-size:11px;color:rgba(255,255,255,.4);text-align:center;line-height:1.5;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HEADER
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
header{
  background:var(--green);padding:0 16px;
  display:flex;align-items:center;justify-content:space-between;
  height:56px;position:sticky;top:0;z-index:100;
  box-shadow:0 2px 8px rgba(0,0,0,.18);
  padding-left:max(16px, env(safe-area-inset-left));
  padding-right:max(16px, env(safe-area-inset-right));
}
.logo-area{display:flex;align-items:center;gap:10px;min-width:0;}
.logo-badge{width:34px;height:34px;background:var(--yellow);border-radius:50%;display:flex;align-items:center;justify-content:center;font-family:'Barlow Condensed',sans-serif;font-weight:900;font-size:13px;color:var(--green);flex-shrink:0;}
.logo-text{min-width:0;}
.logo-text h1{font-family:'Barlow Condensed',sans-serif;font-weight:900;font-size:16px;text-transform:uppercase;letter-spacing:.4px;line-height:1.1;color:#fff;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.logo-text small{font-size:9px;color:rgba(255,255,255,.5);text-transform:uppercase;letter-spacing:1.5px;font-weight:600;display:none;}
.huser{display:flex;align-items:center;gap:8px;flex-shrink:0;}
.uchip{display:flex;align-items:center;gap:6px;background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.2);border-radius:16px;padding:3px 10px 3px 4px;cursor:pointer;transition:background .15s;max-width:160px;}
.uchip:hover{background:rgba(255,255,255,.2);}
.uav{width:24px;height:24px;border-radius:50%;overflow:hidden;flex-shrink:0;background:var(--yellow);display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:900;color:var(--green);font-family:'Barlow Condensed',sans-serif;}
.uav img{width:100%;height:100%;object-fit:cover;}
.uname{font-size:12px;font-weight:600;color:#fff;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.lobtn{background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.2);color:rgba(255,255,255,.8);padding:5px 10px;border-radius:5px;font-size:11px;cursor:pointer;transition:all .15s;font-weight:600;white-space:nowrap;}
.lobtn:hover{background:rgba(255,255,255,.22);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SEASON BAR
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.sbar{
  background:var(--yellow);
  padding:7px max(16px,env(safe-area-inset-left)) 7px max(16px,env(safe-area-inset-left));
  display:flex;align-items:center;gap:8px;border-bottom:2px solid var(--yellow-dark);
  overflow-x:auto;scrollbar-width:none;
}
.sbar::-webkit-scrollbar{display:none;}
.slabel{font-size:10px;font-weight:800;text-transform:uppercase;letter-spacing:1px;color:var(--green);opacity:.6;white-space:nowrap;flex-shrink:0;}
.stabs{display:flex;gap:3px;flex-shrink:0;}
.stab{padding:5px 12px;border-radius:4px;font-size:12px;font-weight:800;cursor:pointer;border:none;background:transparent;color:rgba(1,60,30,.5);transition:all .15s;font-family:'Barlow Condensed',sans-serif;letter-spacing:.5px;white-space:nowrap;}
.stab.act{background:var(--green);color:var(--yellow);}
.stab:hover:not(.act){background:rgba(1,60,30,.12);color:var(--green);}
.add-s-btn{padding:5px 10px;border-radius:4px;background:rgba(1,60,30,.12);border:1.5px solid rgba(1,60,30,.2);color:var(--green);font-size:10px;font-weight:800;cursor:pointer;transition:all .15s;font-family:'Barlow Condensed',sans-serif;text-transform:uppercase;white-space:nowrap;flex-shrink:0;}
.add-s-btn:hover{background:rgba(1,60,30,.22);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PAGE TABS (mobile: bottom nav)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.ptabs-top{display:flex;gap:4px;margin-bottom:14px;overflow-x:auto;scrollbar-width:none;padding-bottom:2px;}
.ptabs-top::-webkit-scrollbar{display:none;}
.access-opt{display:flex;align-items:flex-start;gap:10px;padding:10px 12px;border:1.5px solid var(--border);border-radius:8px;cursor:pointer;transition:all .15s;width:100%;box-sizing:border-box;overflow:hidden;position:relative;}
.access-opt:has(input:checked){border-color:var(--green);background:var(--green-light);}
.access-opt input[type=radio]{position:absolute;opacity:0;width:0;height:0;}
/* Custom radio circle */
.access-opt-check{width:18px;height:18px;border-radius:50%;border:2px solid var(--border-s);background:#fff;flex-shrink:0;margin-top:2px;display:flex;align-items:center;justify-content:center;transition:all .15s;}
.access-opt:has(input:checked) .access-opt-check{border-color:var(--green);background:var(--green);}
.access-opt:has(input:checked) .access-opt-check::after{content:'âœ“';color:#fff;font-size:11px;font-weight:900;line-height:1;}
.access-opt-body{flex:1;min-width:0;overflow:hidden;}
.access-opt-title{font-weight:700;font-size:13px;color:var(--text);white-space:nowrap;}
.access-opt-desc{font-size:11px;color:var(--text-dim);margin-top:2px;line-height:1.4;word-wrap:break-word;}
.role-tag{display:flex;align-items:center;justify-content:space-between;padding:7px 10px;background:var(--bg);border:1.5px solid var(--border);border-radius:7px;font-size:13px;}
.role-tag-del{background:none;border:none;cursor:pointer;color:var(--text-dim);font-size:16px;line-height:1;padding:0 2px;}
.role-tag-del:hover{color:var(--red);}
.role-tag-default{font-size:10px;color:var(--text-dim);font-style:italic;}
.ptab-soon{opacity:.45;cursor:not-allowed!important;position:relative;}
.ptab-soon:hover{background:var(--card)!important;color:var(--text-dim)!important;border-color:var(--border)!important;}
.ptabs{padding:10px 16px;display:flex;gap:8px;border-top:1px solid var(--border);background:var(--card);}
.soon-badge{display:inline-block;font-size:8px;font-weight:800;background:var(--yellow);color:var(--green);border-radius:3px;padding:1px 4px;margin-left:5px;vertical-align:middle;text-transform:uppercase;letter-spacing:.5px;}
.ptab{padding:7px 14px;border-radius:6px;background:var(--card);color:var(--text-dim);border:1.5px solid var(--border);font-size:11px;font-weight:700;cursor:pointer;transition:all .15s;text-transform:uppercase;letter-spacing:.5px;white-space:nowrap;flex-shrink:0;}
.ptab.act{background:var(--green);color:#fff;border-color:var(--green);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MAIN CONTENT
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
main{
  padding:16px max(16px,env(safe-area-inset-right)) calc(16px + var(--safe-bottom)) max(16px,env(safe-area-inset-left));
  max-width:1440px;
  display:flex;
  gap:20px;
  align-items:flex-start;
}
.sh{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;gap:10px;}
.stitle{font-family:'Barlow Condensed',sans-serif;font-weight:900;font-size:24px;text-transform:uppercase;letter-spacing:1px;color:var(--text);}
.stitle span{color:var(--green);}
.section-title{font-family:'Barlow Condensed',sans-serif;font-weight:900;font-size:20px;text-transform:uppercase;letter-spacing:1px;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SYNC STATUS BAR
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.sync-bar{display:flex;align-items:center;gap:8px;background:var(--card);border:1.5px solid var(--border);border-radius:8px;padding:8px 12px;margin-bottom:14px;font-size:12px;color:var(--text-dim);}
.sync-dot{width:8px;height:8px;border-radius:50%;background:var(--border-s);flex-shrink:0;}
.sync-dot.ok{background:var(--green-bright);}
.sync-dot.loading{background:var(--yellow-dark);animation:pulse 1s ease-in-out infinite;}
.sync-dot.err{background:var(--red);}
@keyframes pulse{0%,100%{opacity:1;}50%{opacity:.4;}}
.sync-refresh{margin-left:auto;padding:4px 10px;background:var(--green-light);border:1px solid var(--border-s);color:var(--green);border-radius:4px;font-size:11px;font-weight:700;cursor:pointer;transition:all .15s;}
.sync-refresh:hover{background:var(--green);color:#fff;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   KPI CARDS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.krow{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:14px;}
.kcard{background:var(--card);border:1.5px solid var(--border);border-radius:var(--r);padding:14px 16px;position:relative;overflow:hidden;box-shadow:var(--sh);cursor:pointer;transition:box-shadow .15s,transform .12s;-webkit-user-select:none;user-select:none;}
.kcard:hover{box-shadow:var(--shm);transform:translateY(-1px);}
.kcard:active{transform:scale(.98);}
.kcard::before{content:'';position:absolute;top:0;left:0;right:0;height:4px;}
.kcard.total::before{background:var(--yellow);}
.kcard.paid::before{background:var(--green);}
.kcard.out::before{background:var(--red);}
.kcard.cnt::before{background:var(--border-s);}
.kcard.cnt{cursor:default;}
.kcard.cnt:hover{box-shadow:var(--sh);transform:none;}
.kcard.cnt:active{transform:none;}
.klbl{font-size:9px;text-transform:uppercase;letter-spacing:1.5px;color:var(--text-dim);font-weight:700;margin-bottom:4px;}
.kval{font-family:'Barlow Condensed',sans-serif;font-size:28px;font-weight:900;line-height:1;}
.kcard.total .kval{color:var(--yellow-dark);}
.kcard.paid .kval{color:var(--green);}
.kcard.out .kval{color:var(--red);}
.ksub{font-size:10px;color:var(--text-dim);margin-top:3px;}
.klink{font-size:9px;color:var(--green);font-weight:700;margin-top:4px;text-decoration:underline;}
.ktrend{font-size:10px;font-weight:700;margin-top:3px;}
.ktrend.up{color:var(--green-bright);}
.ktrend.dn{color:var(--red);}
.pbtrack{height:4px;background:var(--bg);border-radius:3px;overflow:hidden;margin-top:7px;border:1px solid var(--border);}
.pbfill{height:100%;border-radius:3px;background:linear-gradient(90deg,var(--green),var(--green-bright));transition:width .8s;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DRILL PANEL
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.drill-panel{display:none;background:var(--card);border:1.5px solid var(--border);border-radius:var(--r);padding:16px;box-shadow:var(--sh);margin-bottom:14px;animation:slideDown .2s ease;}
.drill-panel.open{display:block;}
@keyframes slideDown{from{opacity:0;transform:translateY(-6px);}to{opacity:1;transform:translateY(0);}}
.drill-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;gap:10px;}
.drill-title{font-family:'Barlow Condensed',sans-serif;font-size:16px;font-weight:900;text-transform:uppercase;letter-spacing:.5px;line-height:1.2;}
.drill-close{background:var(--bg);border:1.5px solid var(--border);color:var(--text-dim);width:28px;height:28px;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:15px;flex-shrink:0;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PANELS & TWO-COL
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.panel{background:var(--card);border:1.5px solid var(--border);border-radius:var(--r);padding:16px;box-shadow:var(--sh);margin-bottom:14px;}
.twocol{display:grid;grid-template-columns:1fr;gap:14px;margin-bottom:14px;}
.ptitle{font-family:'Barlow Condensed',sans-serif;font-size:12px;font-weight:800;text-transform:uppercase;letter-spacing:1px;margin-bottom:12px;color:var(--text-dim);}
.ptitle span{color:var(--text);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   YEAR BARS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.ybargrp{margin-bottom:10px;cursor:pointer;}
.ybargrp:active .btrack{opacity:.8;}
.ybarlbl{display:flex;justify-content:space-between;font-size:11px;margin-bottom:3px;font-weight:600;}
.ybarlbl .yr{color:var(--text-dim);}
.btrack{height:22px;background:var(--bg);border-radius:4px;overflow:hidden;border:1px solid var(--border);}
.bfill{height:100%;border-radius:4px;transition:width .9s cubic-bezier(.4,0,.2,1);display:flex;align-items:center;padding-left:8px;font-size:10px;font-weight:700;}
.bfill.cur{background:var(--yellow);color:var(--green);}
.bfill.prev{background:var(--green);color:rgba(255,255,255,.85);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TIER LIST
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.tlist{display:flex;flex-direction:column;gap:6px;}
.trow{display:flex;align-items:center;gap:8px;padding:9px 10px;background:var(--bg);border-radius:6px;cursor:pointer;transition:all .15s;border:1.5px solid transparent;touch-action:pan-y;}
.trow:hover,.trow:active{background:var(--green-light);border-color:var(--border-s);}
.tdot{width:7px;height:7px;border-radius:50%;flex-shrink:0;}
.tdot.gold{background:var(--tg);}
.tdot.silver{background:var(--ts);}
.tdot.bronze{background:var(--tb);}
.tdot.community{background:var(--tc);}
.tname{font-weight:700;font-size:13px;flex:1;}
.tcnt{font-size:11px;color:var(--text-dim);}
.tamt{font-family:'Barlow Condensed',sans-serif;font-weight:900;font-size:14px;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TABLE (mobile: card-style rows)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.toolbar{display:flex;align-items:center;gap:6px;margin-bottom:10px;overflow-x:auto;scrollbar-width:none;padding-bottom:2px;}
.toolbar::-webkit-scrollbar{display:none;}
.fbtn{padding:5px 11px;border-radius:5px;background:var(--bg);color:var(--text-dim);border:1.5px solid var(--border);font-size:11px;font-weight:700;cursor:pointer;transition:all .15s;text-transform:uppercase;letter-spacing:.4px;white-space:nowrap;flex-shrink:0;}
.fbtn:hover,.fbtn.act{background:var(--green);color:#fff;border-color:var(--green);}
.abtn{margin-left:auto;padding:7px 14px;border-radius:6px;background:var(--yellow);color:var(--green);border:none;font-size:12px;font-weight:900;cursor:pointer;transition:all .15s;text-transform:uppercase;letter-spacing:.4px;font-family:'Barlow Condensed',sans-serif;box-shadow:var(--sh);white-space:nowrap;flex-shrink:0;}
.abtn:hover{background:var(--yellow-mid);}
.abtn:active{transform:scale(.97);}

/* Desktop table */
.stw{overflow-x:auto;-webkit-overflow-scrolling:touch;}
table{width:100%;border-collapse:collapse;font-size:13px;}
thead th{text-align:left;padding:8px 10px;font-size:9px;text-transform:uppercase;letter-spacing:1.2px;color:var(--text-dim);font-weight:700;border-bottom:2px solid var(--border);white-space:nowrap;}
tbody tr{border-bottom:1px solid var(--border);cursor:pointer;transition:background .1s;}
tbody tr:hover{background:var(--green-light);}
td{padding:10px 10px;vertical-align:middle;}

/* Mobile sponsor cards */
.sponsor-cards{display:none;flex-direction:column;gap:8px;}
.scard{background:var(--card);border:1.5px solid var(--border);border-radius:9px;padding:14px;cursor:pointer;transition:all .15s;box-shadow:var(--sh);}
.scard:hover{border-color:var(--border-s);box-shadow:var(--shm);}
.scard:active{transform:scale(.99);}
.scard-top{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:8px;gap:8px;}
.scard-name{font-weight:700;font-size:15px;line-height:1.2;}
.scard-amount{font-family:'Barlow Condensed',sans-serif;font-weight:900;font-size:18px;color:var(--text);text-align:right;flex-shrink:0;}
.scard-recv{font-size:10px;color:var(--orange);text-align:right;}
.scard-meta{display:flex;align-items:center;gap:6px;flex-wrap:wrap;}
.scard-edit{margin-left:auto;padding:5px 10px;border-radius:5px;background:var(--bg);border:1.5px solid var(--border);color:var(--text-dim);font-size:11px;font-weight:700;cursor:pointer;}

/* Badges */
.sbadge{display:inline-block;padding:2px 7px;border-radius:20px;font-size:9px;font-weight:800;text-transform:uppercase;letter-spacing:.4px;}
.sbadge.paid{background:var(--green-light);color:var(--green);}
.sbadge.outstanding{background:var(--red-light);color:var(--red);}
.sbadge.partial{background:var(--orange-light);color:var(--orange);}
.sbadge.inkind{background:#f0e6ff;color:#6d28d9;}
.tchip{display:inline-flex;align-items:center;padding:2px 6px;border-radius:4px;font-size:10px;font-weight:700;}
.tchip.gold{background:var(--tgb);color:var(--tg);}
.tchip.silver{background:var(--tsb);color:var(--ts);}
.tchip.bronze{background:var(--tbb);color:var(--tb);}
.tchip.community{background:var(--tcb);color:var(--tc);}
.cbadge{display:inline-flex;align-items:center;gap:3px;background:var(--yellow-pale);border:1.5px solid var(--yellow-dark);color:var(--yellow-dark);font-size:9px;font-weight:800;padding:1px 6px;border-radius:10px;}
.actbtn{background:var(--bg);border:1.5px solid var(--border);color:var(--text);padding:3px 9px;border-radius:4px;font-size:11px;cursor:pointer;font-weight:700;transition:all .15s;}
.actbtn:hover{background:var(--green);color:#fff;border-color:var(--green);}

.empty{text-align:center;padding:40px 16px;color:var(--text-dim);}
.empty .icon{font-size:32px;margin-bottom:8px;}
.empty h3{font-size:14px;color:var(--text);margin-bottom:4px;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DETAIL VIEW
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.detailview{display:none;}
.detailview.open{display:block;}
.mainview.h{display:none;}
.backbtn{display:inline-flex;align-items:center;gap:6px;background:var(--green-light);border:1.5px solid var(--border-s);color:var(--green);font-size:12px;font-weight:700;cursor:pointer;margin-bottom:14px;padding:8px 13px;border-radius:6px;text-transform:uppercase;letter-spacing:.5px;}
.backbtn:active{transform:scale(.97);}
.dheader{display:flex;align-items:flex-start;gap:14px;margin-bottom:16px;flex-wrap:wrap;}
.dlogo{width:56px;height:56px;border-radius:8px;background:var(--yellow-pale);display:flex;align-items:center;justify-content:center;font-family:'Barlow Condensed',sans-serif;font-size:20px;font-weight:900;color:var(--yellow-dark);flex-shrink:0;border:2px solid var(--yellow-dark);}
.dinfo{flex:1;min-width:0;}
.dinfo h2{font-family:'Barlow Condensed',sans-serif;font-size:24px;font-weight:900;line-height:1;text-transform:uppercase;}
.dmeta{display:flex;gap:6px;margin-top:6px;flex-wrap:wrap;}
.dkpis{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:13px;}
.dkpi{background:var(--bg);border:1.5px solid var(--border);border-radius:8px;padding:12px 13px;}
.ystrip{display:flex;gap:5px;flex-wrap:wrap;margin-bottom:13px;}
.ypill{display:flex;align-items:center;gap:4px;background:var(--bg);border:1.5px solid var(--border);border-radius:4px;padding:4px 8px;font-size:10px;font-weight:700;color:var(--text-dim);}
.ypill.has{border-color:var(--green);color:var(--green);background:var(--green-light);}
.ydot{width:5px;height:5px;border-radius:50%;background:var(--border-s);}
.ypill.has .ydot{background:var(--green);}
.alog{background:var(--bg);border:1.5px solid var(--border);border-radius:8px;padding:14px;margin-bottom:13px;}
.alog h3{font-size:9px;text-transform:uppercase;letter-spacing:1.2px;color:var(--text-dim);margin-bottom:10px;font-weight:700;}
.aentry{display:flex;align-items:flex-start;gap:8px;padding:6px 0;border-bottom:1px solid var(--border);}
.aentry:last-child{border-bottom:none;}
.adot{width:7px;height:7px;border-radius:50%;flex-shrink:0;margin-top:4px;}
.adot.edit{background:var(--yellow-dark);}
.adot.del{background:var(--red);}
.adot.add{background:var(--green);}
.aact{font-size:12px;font-weight:600;line-height:1.4;}
.amet{font-size:10px;color:var(--text-dim);margin-top:1px;}
.aempty{font-size:12px;color:var(--text-dim);font-style:italic;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MODALS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.moverlay{
  display:none;position:fixed;inset:0;z-index:200;
  background:rgba(0,0,0,.5);
  align-items:flex-end;justify-content:center;
  padding:0;
}
.moverlay.open{display:flex;}
.modal{
  background:var(--card);border:1.5px solid var(--border);
  border-radius:16px 16px 0 0;
  width:100%;max-width:100%;
  padding:20px 20px calc(20px + var(--safe-bottom));
  position:relative;max-height:92vh;overflow-y:auto;
  animation:slideUp .25s cubic-bezier(.4,0,.2,1);
}
@keyframes slideUp{from{transform:translateY(100%);}to{transform:translateY(0);}}
.modal-handle{width:36px;height:4px;background:var(--border-s);border-radius:2px;margin:0 auto 16px;display:block;}
.mclose{position:absolute;top:16px;right:16px;background:var(--bg);border:1px solid var(--border);color:var(--text);width:30px;height:30px;border-radius:50%;font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center;}
.mtitle{font-family:'Barlow Condensed',sans-serif;font-size:20px;font-weight:900;margin-bottom:2px;text-transform:uppercase;}
.msub{color:var(--text-dim);font-size:12px;margin-bottom:16px;line-height:1.4;}
.frow{display:grid;grid-template-columns:1fr;gap:10px;margin-bottom:10px;}
.frow.two{grid-template-columns:1fr 1fr;}
.frow.full{grid-template-columns:1fr;}
.fg{display:flex;flex-direction:column;gap:4px;}
.fg label{font-size:10px;text-transform:uppercase;letter-spacing:1px;color:var(--text-dim);font-weight:700;}
.fg input,.fg select,.fg textarea{background:#f7faf7;border:1.5px solid var(--border);color:var(--text);padding:11px 12px;border-radius:7px;font-size:15px;font-family:'Barlow',sans-serif;transition:border-color .15s;width:100%;-webkit-appearance:none;}
.fg input:focus,.fg select:focus,.fg textarea:focus{outline:none;border-color:var(--green);background:#fff;}
.fg textarea{resize:vertical;min-height:70px;}
.mactions{display:flex;gap:8px;margin-top:16px;flex-wrap:wrap;}
.mprimary{flex:1;padding:13px;background:var(--green);color:#fff;border:none;border-radius:8px;font-size:15px;font-weight:900;cursor:pointer;font-family:'Barlow Condensed',sans-serif;text-transform:uppercase;letter-spacing:.5px;min-width:120px;transition:opacity .15s;}
.mprimary:disabled{opacity:.6;cursor:not-allowed;}
.mprimary.btn-loading{position:relative;color:transparent !important;pointer-events:none;}
.mprimary.btn-loading::after{content:'';position:absolute;top:50%;left:50%;width:18px;height:18px;margin:-9px 0 0 -9px;border:2.5px solid rgba(255,255,255,.35);border-top-color:#fff;border-radius:50%;animation:spin .7s linear infinite;}
.mdanger.btn-loading{position:relative;color:transparent !important;pointer-events:none;opacity:.7;}
.mdanger.btn-loading::after{content:'';position:absolute;top:50%;left:50%;width:16px;height:16px;margin:-8px 0 0 -8px;border:2.5px solid rgba(180,0,0,.3);border-top-color:var(--red);border-radius:50%;animation:spin .7s linear infinite;}
.mprimary:active{transform:scale(.97);}
.msecondary{padding:13px 16px;background:var(--bg);color:var(--text-dim);border:1.5px solid var(--border);border-radius:8px;font-size:13px;cursor:pointer;font-weight:600;}
.mdanger{padding:13px 14px;background:var(--red-light);color:var(--red);border:1.5px solid #f5c6c2;border-radius:8px;font-size:13px;cursor:pointer;font-weight:700;}

/* Copy from prev */
.copy-prev-wrap{background:var(--green-light);border:1.5px solid var(--border-s);border-radius:8px;padding:11px 13px;margin-bottom:12px;}
.copy-prev-wrap label{font-size:10px;text-transform:uppercase;letter-spacing:1px;color:var(--green);font-weight:800;display:block;margin-bottom:6px;}
.copy-prev-row{display:flex;gap:8px;align-items:center;}
.copy-prev-row select{flex:1;background:#fff;border:1.5px solid var(--border-s);color:var(--text);padding:9px 10px;border-radius:6px;font-size:13px;font-family:'Barlow',sans-serif;-webkit-appearance:none;}
.cbtn{padding:9px 12px;background:var(--green);color:#fff;border:none;border-radius:6px;font-size:12px;font-weight:800;cursor:pointer;font-family:'Barlow Condensed',sans-serif;text-transform:uppercase;white-space:nowrap;}

/* Season mini modal */
.smodal-inner{background:var(--card);border-radius:14px;padding:24px;width:100%;max-width:360px;box-shadow:var(--shm);border:1.5px solid var(--border);margin:auto;}
#season-modal .moverlay-center{align-items:center;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ACCESS LOG
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.atable{width:100%;border-collapse:collapse;font-size:12px;}
.atable th{text-align:left;padding:8px 9px;font-size:9px;text-transform:uppercase;letter-spacing:1.2px;color:var(--text-dim);font-weight:700;border-bottom:2px solid var(--border);}
.atable td{padding:8px 9px;border-bottom:1px solid var(--border);}
.atable tr:last-child td{border-bottom:none;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   USER MANAGEMENT
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.user-grid{display:grid;grid-template-columns:1fr;gap:10px;margin-bottom:14px;}
.ucard{background:var(--card);border:1.5px solid var(--border);border-radius:var(--r);padding:14px;box-shadow:var(--sh);}
.ucard-head{display:flex;align-items:center;gap:10px;margin-bottom:9px;}
.ucard-av{width:38px;height:38px;border-radius:50%;background:var(--green);display:flex;align-items:center;justify-content:center;font-family:'Barlow Condensed',sans-serif;font-weight:900;font-size:15px;color:var(--yellow);flex-shrink:0;overflow:hidden;}
.ucard-av img{width:100%;height:100%;object-fit:cover;}
.ucard-name{font-weight:700;font-size:14px;}
.ucard-role{font-size:11px;color:var(--text-dim);}
.ucard-badges{display:flex;gap:5px;margin-bottom:9px;flex-wrap:wrap;}
.ubadge{font-size:9px;font-weight:800;padding:2px 7px;border-radius:10px;text-transform:uppercase;letter-spacing:.4px;}
.ubadge.admin{background:var(--yellow-pale);color:var(--yellow-dark);border:1px solid var(--yellow-dark);}
.ubadge.edit{background:var(--green-light);color:var(--green);border:1px solid var(--border-s);}
.ubadge.view{background:var(--bg);color:var(--text-dim);border:1px solid var(--border);}
.ucard-actions{display:flex;gap:6px;flex-wrap:wrap;}
.uact-btn{padding:6px 10px;border-radius:5px;font-size:11px;font-weight:700;cursor:pointer;border:1.5px solid var(--border);background:var(--bg);color:var(--text-mid);transition:all .15s;}
.uact-btn:hover{background:var(--green);color:#fff;border-color:var(--green);}

/* Profile */
.profile-av-row{display:flex;align-items:center;gap:12px;margin-bottom:14px;}
.profile-av{width:52px;height:52px;border-radius:50%;background:var(--green);display:flex;align-items:center;justify-content:center;font-family:'Barlow Condensed',sans-serif;font-weight:900;font-size:20px;color:var(--yellow);overflow:hidden;}
.profile-av img{width:100%;height:100%;object-fit:cover;}
.profile-info strong{font-size:15px;display:block;}
.profile-info span{font-size:12px;color:var(--text-dim);}
.profile-badges{display:flex;gap:5px;margin-top:4px;flex-wrap:wrap;}
.profile-sec{margin-bottom:18px;padding-bottom:18px;border-bottom:1px solid var(--border);}
.profile-sec:last-child{border-bottom:none;margin-bottom:0;padding-bottom:0;}
.profile-sec h3{font-family:'Barlow Condensed',sans-serif;font-size:14px;font-weight:800;text-transform:uppercase;letter-spacing:.4px;color:var(--text);margin-bottom:11px;}
.msg-ok{background:var(--green-light);border:1px solid var(--border-s);color:var(--green);padding:7px 10px;border-radius:6px;font-size:12px;font-weight:600;margin-top:7px;display:none;}
.msg-err{background:var(--red-light);border:1px solid #f5c6c2;color:var(--red);padding:7px 10px;border-radius:6px;font-size:12px;font-weight:600;margin-top:7px;display:none;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOAST
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.toast{
  position:fixed;bottom:calc(20px + var(--safe-bottom));left:50%;
  transform:translateX(-50%) translateY(80px);
  z-index:400;background:var(--green);color:#fff;
  padding:11px 20px;border-radius:24px;
  font-weight:800;font-size:13px;
  opacity:0;transition:all .3s;
  font-family:'Barlow Condensed',sans-serif;text-transform:uppercase;
  letter-spacing:.5px;box-shadow:var(--shm);white-space:nowrap;
}
.toast.show{transform:translateX(-50%) translateY(0);opacity:1;}
.toast.warn{background:var(--orange);}
.toast.err{background:var(--red);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESPONSIVE â€” TABLET (600px+)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media(min-width:600px){
  main{padding:20px 24px;max-width:1200px;margin:0 auto;}
  header{height:60px;padding:0 24px;}
  .logo-text small{display:block;}
  .krow{grid-template-columns:repeat(4,1fr);}
  .kval{font-size:30px;}
  .stitle{font-size:26px;}
  .frow{grid-template-columns:1fr 1fr;}
  .frow.full{grid-template-columns:1fr;}
  .moverlay{align-items:center;padding:20px;}
  .modal{border-radius:14px;max-width:560px;animation:modalIn .2s ease;padding:24px;}
  @keyframes modalIn{from{opacity:0;transform:scale(.95);}to{opacity:1;transform:scale(1);}}
  .modal-handle{display:none;}
  .stw table{display:table;}
  .sponsor-cards{display:none!important;}
  .user-grid{grid-template-columns:repeat(auto-fill,minmax(260px,1fr));}
  .twocol{grid-template-columns:1fr 280px;}
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESPONSIVE â€” DESKTOP (960px+)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media(min-width:960px){
  main{padding:22px 28px;max-width:1200px;margin:0 auto;}
  header{padding:0 28px;}
  .logo-text h1{font-size:17px;}
  .kval{font-size:33px;}
  .stitle{font-size:28px;}
  .twocol{grid-template-columns:1fr 295px;}
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MOBILE: hide table, show cards
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media(max-width:599px){
  .stw table{display:none;}
  .sponsor-cards{display:flex;}
  .dkpis{grid-template-columns:1fr 1fr 1fr;}
  .dkpi{padding:10px 11px;}
  .dinfo h2{font-size:20px;}
}


/* â”€â”€ NEW: Prospect / org status badges â”€â”€ */
.ostatus{display:inline-block;padding:2px 8px;border-radius:20px;font-size:9px;font-weight:800;text-transform:uppercase;letter-spacing:.5px;}
.ostatus.active{background:var(--green-light);color:var(--green);}
.ostatus.prospect{background:#fef9e6;color:#b45309;}
.ostatus.lapsed{background:#f3f4f6;color:#6b7280;}

/* â”€â”€ Contact log â”€â”€ */
.clog-entry{display:flex;gap:10px;padding:10px 0;border-bottom:1px solid var(--border);}
.clog-entry:last-child{border-bottom:none;}
.clog-dot{width:8px;height:8px;border-radius:50%;background:var(--green);flex-shrink:0;margin-top:5px;}
.clog-body{flex:1;min-width:0;}
.clog-meta{font-size:10px;color:var(--text-dim);margin-bottom:2px;}
.clog-notes{font-size:13px;color:var(--text-mid);}

/* â”€â”€ Address fields â”€â”€ */
.addr-same-wrap{display:flex;align-items:center;gap:8px;margin-top:4px;}
.addr-same-wrap input[type=checkbox]{width:16px;height:16px;accent-color:var(--green);cursor:pointer;}
.addr-same-wrap label{font-size:12px;color:var(--text-dim);cursor:pointer;}

/* â”€â”€ Two-panel layout for org detail â”€â”€ */
.org-detail-wrap{display:flex;gap:16px;flex-wrap:wrap;}
.org-detail-main{flex:1;min-width:260px;}
.org-detail-side{width:280px;flex-shrink:0;}
@media(max-width:640px){.org-detail-side{width:100%;}}

/* â”€â”€ Season pills on org card â”€â”€ */
.season-pill{display:inline-flex;align-items:center;gap:5px;background:var(--bg);border:1.5px solid var(--border);border-radius:20px;padding:3px 10px;font-size:11px;cursor:pointer;transition:all .15s;}
.season-pill:hover{border-color:var(--green);background:var(--green-light);}
.season-pill .sp-tier{font-weight:800;}
.season-pill .sp-yr{color:var(--text-dim);}

/* â”€â”€ Add season to org button â”€â”€ */
.add-season-pill{display:inline-flex;align-items:center;gap:4px;background:var(--yellow-pale);border:1.5px dashed var(--yellow-dark);border-radius:20px;padding:3px 10px;font-size:11px;cursor:pointer;color:var(--yellow-dark);font-weight:700;transition:all .15s;}
.add-season-pill:hover{background:var(--yellow-mid);}

/* â”€â”€ Tabs for sponsor view: Active | Prospects â”€â”€ */
.view-tabs{display:flex;gap:6px;margin-bottom:14px;}
.vtab{padding:6px 14px;border-radius:20px;font-size:12px;font-weight:700;border:1.5px solid var(--border);background:var(--card);cursor:pointer;transition:all .15s;font-family:"Barlow Condensed",sans-serif;text-transform:uppercase;letter-spacing:.5px;}
.vtab.act{background:var(--green);color:#fff;border-color:var(--green);}
.vtab.prospect-tab.act{background:#b45309;border-color:#b45309;}


/* â”€â”€ MISSING LAYOUT CSS â”€â”€ */
.hright{display:flex;align-items:center;gap:10px;flex-shrink:0;}
.season-head{display:flex;align-items:center;margin-bottom:16px;gap:8px;flex-wrap:wrap;}
.sadd{background:rgba(255,255,255,.15);border:1.5px solid rgba(255,255,255,.3);color:#fff;padding:5px 12px;border-radius:6px;font-size:11px;font-weight:700;cursor:pointer;white-space:nowrap;transition:all .15s;font-family:'Barlow Condensed',sans-serif;text-transform:uppercase;letter-spacing:.5px;}
.sadd:hover{background:rgba(255,255,255,.25);}
.kpis{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-bottom:16px;}
@media(min-width:600px){.kpis{grid-template-columns:repeat(4,1fr);}}
.filters{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px;}
.ftab{padding:5px 12px;border-radius:20px;font-size:11px;font-weight:700;border:1.5px solid var(--border);background:var(--card);cursor:pointer;transition:all .15s;font-family:'Barlow Condensed',sans-serif;text-transform:uppercase;letter-spacing:.5px;white-space:nowrap;}
.ftab.act{background:var(--green);color:#fff;border-color:var(--green);}
.left-col{flex:1;min-width:0;}
.right-col{width:300px;flex-shrink:0;}
@media(max-width:900px){.right-col{width:100%;}}
.panel-title{font-family:'Barlow Condensed',sans-serif;font-size:14px;font-weight:800;text-transform:uppercase;letter-spacing:1px;color:var(--text);margin-bottom:10px;}
.side-panel{position:fixed;top:0;right:-420px;width:min(420px,100vw);height:100vh;background:var(--card);box-shadow:-4px 0 24px rgba(0,0,0,.13);z-index:200;transition:right .3s cubic-bezier(.4,0,.2,1);display:flex;flex-direction:column;overflow:hidden;}
.side-panel.open{right:0;}
.spclose{position:absolute;top:14px;right:16px;background:var(--bg);border:1.5px solid var(--border);border-radius:50%;width:32px;height:32px;font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;z-index:1;}
.sp-title{font-family:'Barlow Condensed',sans-serif;font-size:16px;font-weight:800;text-transform:uppercase;padding:16px 48px 0 16px;letter-spacing:.5px;}
.stable{width:100%;border-collapse:collapse;font-size:13px;}
.stable th{text-align:left;font-size:9px;text-transform:uppercase;letter-spacing:1.2px;color:var(--text-dim);font-weight:700;padding:6px 8px;border-bottom:2px solid var(--border);}
.stable td{padding:10px 8px;border-bottom:1px solid var(--border);vertical-align:middle;}
.stable tr:last-child td{border-bottom:none;}
.stable tbody tr{cursor:pointer;transition:background .12s;}
.stable tbody tr:hover{background:var(--green-light);}
#sync-state,.sync-ok,.sync-loading,.sync-err{font-size:11px;font-weight:600;padding:3px 8px;border-radius:20px;white-space:nowrap;}
.sync-ok{background:var(--green-light);color:var(--green);}
.sync-loading{background:var(--yellow-pale);color:var(--yellow-dark);}
.sync-err{background:var(--red-light);color:var(--red);}

</style>
</head>
<body>

<!-- LOADING SCREEN -->
<div id="loading-screen">
  <div class="ls-crest">KJFC</div>
  <div class="ls-text">Loadingâ€¦</div>
  <div class="ls-bar"><div class="ls-bar-fill"></div></div>
</div>

<!-- LOGIN -->
<div id="login-view" style="display:none;min-height:100vh;display:none;align-items:center;justify-content:center;background:var(--green);">
  <div class="lbox" style="background:#fff;border-radius:18px;padding:36px 28px;width:100%;max-width:380px;margin:24px;box-shadow:0 12px 40px rgba(0,0,0,.18);">
    <div style="text-align:center;margin-bottom:28px;">
      <div style="width:64px;height:64px;background:var(--yellow);border-radius:50%;display:flex;align-items:center;justify-content:center;font-family:'Barlow Condensed',sans-serif;font-weight:900;font-size:22px;color:var(--green);margin:0 auto 14px;">KJFC</div>
      <h1 style="font-family:'Barlow Condensed',sans-serif;font-size:22px;font-weight:900;letter-spacing:.5px;text-transform:uppercase;">Executive Dashboard</h1>
      <p style="font-size:13px;color:var(--text-dim);margin-top:4px;">Kinglake Junior Football Club</p>
    </div>
    <div id="google-btn-container" style="margin-bottom:12px;"></div>
    <button id="google-sign-in-btn" style="width:100%;padding:12px;background:var(--green);color:#fff;border:none;border-radius:8px;font-size:14px;font-weight:700;cursor:pointer;font-family:'Barlow Condensed',sans-serif;text-transform:uppercase;letter-spacing:.5px;">Sign in with Google</button>
    <div id="lerr" style="color:var(--red);font-size:12px;text-align:center;margin-top:10px;min-height:16px;"></div>
  </div>
</div>

<!-- MAIN APP -->
<div id="app" style="display:none;">

  <!-- HEADER -->
  <header>
    <div class="logo-area">
      <div class="logo-badge">KJFC</div>
      <div class="logo-text">
        <h1>Exec Dashboard</h1>
        <small>Kinglake JFC</small>
      </div>
    </div>
    <div class="hright">
      <div id="sync-state" class="sync-ok">â—&nbsp;Synced</div>
      <button class="sync-refresh" onclick="loadAll()">â†» Refresh</button>
      <div class="huser">
        <img id="user-pic" src="" style="width:28px;height:28px;border-radius:50%;display:none;object-fit:cover;">
        <span id="user-name"></span>
      </div>
      <button class="lobtn" onclick="doLogout()">Sign Out</button>
    </div>
  </header>

  <!-- SEASON BAR -->
  <div class="sbar">
    <div id="season-tabs" class="stabs"></div>
    <button class="sadd" onclick="openSeasonModal()">+ Season</button>
  </div>

  <!-- MAIN -->
  <main>
    <!-- LEFT: KPIs + Charts -->
    <div class="left-col">
      <div class="season-head">
        <h2 class="section-title" id="season-span">SPONSORSHIP</h2>
        <button class="actbtn" onclick="openAddOrg()" id="add-sponsor-btn" style="margin-left:auto">+ Add Sponsor</button>
      </div>

      <!-- KPI CARDS -->
      <div class="kpis">
        <div class="kcard" onclick="drillTotal()" style="cursor:pointer">
          <div class="klbl">Total Committed</div>
          <div class="kval" id="k-total" style="color:var(--yellow-dark)">$0</div>
          <div class="ksub" id="k-count">0 sponsors</div>
          <div class="ktrend" id="k-trend"></div>
          <div class="klink">View all â†’</div>
        </div>
        <div class="kcard" onclick="drillPaid()" style="cursor:pointer">
          <div class="klbl">Received</div>
          <div class="kval" id="k-paid" style="color:var(--green)">$0</div>
          <div class="ksub" id="k-ppct">0% collected</div>
          <div class="pbtrack"><div class="pbfill" id="k-bar" style="width:0%"></div></div>
          <div class="klink">Paid &amp; partial â†’</div>
        </div>
        <div class="kcard" onclick="drillOut()" style="cursor:pointer">
          <div class="klbl">Outstanding</div>
          <div class="kval" id="k-out" style="color:var(--red)">$0</div>
          <div class="ksub" id="k-outc">0 invoices pending</div>
          <div class="klink">View outstanding â†’</div>
        </div>
        <div class="kcard">
          <div class="klbl">By Tier</div>
          <div id="tier-mini" style="display:flex;flex-direction:column;gap:5px;margin-top:7px;"></div>
        </div>
      </div>

      <!-- IN-KIND STRIP -->
      <div id="inkind-strip" style="display:none;background:var(--card);border:1.5px solid #e9d5ff;border-radius:11px;padding:12px 16px;margin-bottom:16px;align-items:center;gap:12px;">
        <span style="font-size:18px;">ğŸ¤</span>
        <div>
          <div style="font-size:11px;font-weight:700;color:#6d28d9;text-transform:uppercase;letter-spacing:.5px;">In-Kind Sponsors</div>
          <div id="inkind-summary" style="font-size:13px;color:var(--text-mid);"></div>
        </div>
      </div>

      <!-- YOY -->
      <div class="panel" style="margin-bottom:16px;">
        <div class="panel-title">Year-on-Year <span style="color:var(--green)">Comparison</span> <span style="font-size:10px;font-weight:400;color:var(--text-dim)">(tap to switch season)</span></div>
        <div id="year-bars" style="display:flex;flex-direction:column;gap:8px;margin-top:10px;"></div>
      </div>

      <!-- PROSPECT PIPELINE -->
      <div class="panel" style="margin-bottom:16px;" id="prospect-panel">
        <div class="panel-title">ğŸ¯ Prospect Pipeline</div>
        <div id="prospect-list" style="margin-top:10px;"></div>
      </div>
    </div>

    <!-- RIGHT: Tier breakdown + Sponsor list -->
    <div class="right-col">
      <div class="panel" style="margin-bottom:16px;">
        <div class="panel-title">Revenue <span style="color:var(--green)">by Tier</span></div>
        <div class="tlist" id="tier-list"></div>
      </div>

      <!-- SPONSOR TABLE -->
      <div class="panel">
        <!-- View toggle: Active | Prospects -->
        <div class="view-tabs" id="view-tabs">
          <button class="vtab act" onclick="setView('active')" id="vtab-active">Active</button>
          <button class="vtab prospect-tab" onclick="setView('prospect')" id="vtab-prospect">Prospects</button>
        </div>
        <!-- Tier filters -->
        <div class="filters" id="filters" style="margin-bottom:12px;">
          <button class="ftab act" onclick="filterTable('all')">All</button>
          <button class="ftab" onclick="filterTable('gold')">Gold</button>
          <button class="ftab" onclick="filterTable('silver')">Silver</button>
          <button class="ftab" onclick="filterTable('bronze')">Bronze</button>
          <button class="ftab" onclick="filterTable('community')">Community</button>
          <button class="ftab" onclick="filterTable('outstanding')">âš  Owing</button>
        </div>
        <table class="stable" id="stable">
          <thead><tr>
            <th>Sponsor</th><th>Tier</th><th>Amount</th><th>Status</th><th>Yrs</th><th>Contact</th><th></th>
          </tr></thead>
          <tbody id="tbody"></tbody>
        </table>
        <div id="tbl-empty" style="display:none;text-align:center;padding:24px;color:var(--text-dim);font-size:13px;">No sponsors for this season yet.</div>
        <div id="export-wrap" style="margin-top:10px;display:flex;justify-content:flex-end;">
          <button class="actbtn" onclick="exportCSV()" style="font-size:11px;padding:5px 10px;">Export CSV</button>
        </div>
      </div>
    </div>
  </main>

  <!-- TABS (Players, Finance coming soon) -->
  <div class="ptabs">
    <button class="ptab ptab-soon" disabled title="Coming soon">Players <span class="soon-badge">Soon</span></button>
    <button class="ptab ptab-soon" disabled title="Coming soon">Finance <span class="soon-badge">Soon</span></button>
  </div>

  <!-- ADMIN PANEL -->
  <div id="admin-section" style="display:none;">
    <div class="panel" style="margin:16px;max-width:900px;margin-left:auto;margin-right:auto;">
      <div class="panel-title">Admin Tools</div>
      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;">
        <button class="actbtn" onclick="renderAccessLog()">Access Log</button>
        <button class="actbtn" onclick="renderUserGrid()">Manage Users</button>
      </div>
      <div id="access-log-wrap" style="margin-top:14px;display:none;"></div>
      <div id="user-grid-wrap" style="margin-top:14px;display:none;"></div>
    </div>
  </div>

</div><!-- /app -->

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MODALS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

<!-- ORG MODAL (Add/Edit sponsor organisation) -->
<div class="moverlay" id="org-modal">
  <div class="modal" style="max-width:520px;">
    <div class="modal-handle"></div>
    <button class="mclose" id="org-mclose">Ã—</button>
    <div class="mtitle" id="org-m-title">Add Sponsor</div>
    <div class="msub" id="org-m-sub">New sponsor organisation.</div>

    <div class="frow two">
      <div class="fg"><label>Business Name *</label><input type="text" id="of-name" placeholder="Business name" autocomplete="organization"></div>
      <div class="fg"><label>Status</label>
        <select id="of-orgstatus">
          <option value="prospect">Prospect</option>
          <option value="active">Active Sponsor</option>
          <option value="lapsed">Lapsed</option>
        </select>
      </div>
    </div>

    <div class="frow two">
      <div class="fg"><label>Primary Contact Name</label><input type="text" id="of-contact" placeholder="Contact name" autocomplete="name"></div>
      <div class="fg"><label>Contact Email</label><input type="email" id="of-email" placeholder="email@biz.com.au" inputmode="email"></div>
    </div>
    <div class="frow two">
      <div class="fg"><label>Phone</label><input type="tel" id="of-phone" placeholder="04xx xxx xxx" inputmode="tel"></div>
      <div class="fg"><label>Website</label><input type="text" id="of-website" placeholder="www.example.com.au" inputmode="url"></div>
    </div>

    <div class="frow full">
      <div class="fg">
        <label>Physical Address</label>
        <input type="text" id="of-physaddr" placeholder="123 Main St, Kinglake VIC 3763" autocomplete="street-address">
      </div>
    </div>
    <div class="frow full">
      <div class="fg">
        <label>Postal Address</label>
        <div class="addr-same-wrap" style="margin-bottom:6px;">
          <input type="checkbox" id="of-postsame" onchange="togglePostalSame()">
          <label for="of-postsame">Same as physical address</label>
        </div>
        <input type="text" id="of-postaddr" placeholder="PO Box or postal address" autocomplete="off">
      </div>
    </div>

    <div class="frow full">
      <div class="fg"><label>Notes</label><textarea id="of-notes" placeholder="General notes about this organisationâ€¦"></textarea></div>
    </div>
    <div class="mactions">
      <button class="mprimary" id="org-m-save">Add Sponsor</button>
      <button class="msecondary" id="org-m-cancel">Cancel</button>
      <button class="mdanger" id="org-m-del" style="display:none">Delete</button>
    </div>
  </div>
</div>

<!-- SEASON ENTRY MODAL (add/edit a season sponsorship for an org) -->
<div class="moverlay" id="ss-modal">
  <div class="modal" style="max-width:420px;">
    <div class="modal-handle"></div>
    <button class="mclose" id="ss-mclose">Ã—</button>
    <div class="mtitle" id="ss-m-title">Add Season Sponsorship</div>
    <div class="msub" id="ss-m-sub"></div>
    <div class="frow two">
      <div class="fg"><label>Season *</label><select id="sf-year"></select></div>
      <div class="fg"><label>Tier *</label>
        <select id="sf-tier">
          <option value="">Select tier</option>
          <option value="gold">Gold</option>
          <option value="silver">Silver</option>
          <option value="bronze">Bronze</option>
          <option value="community">Community</option>
        </select>
      </div>
    </div>
    <div class="frow two">
      <div class="fg"><label>Payment Status *</label>
        <select id="sf-status">
          <option value="">Select status</option>
          <option value="paid">Paid</option>
          <option value="outstanding">Outstanding</option>
          <option value="partial">Partial</option>
          <option value="inkind">In-Kind</option>
        </select>
      </div>
      <div class="fg" id="sf-amount-wrap"><label>Amount ($) *</label><input type="number" id="sf-amount" placeholder="2000" min="0" inputmode="numeric"></div>
    </div>
    <div class="frow" id="sf-partial-wrap" style="display:none;">
      <div class="fg"><label>Amount Received ($)</label><input type="number" id="sf-paid" placeholder="500" min="0" inputmode="numeric"></div>
    </div>
    <div class="mactions">
      <button class="mprimary" id="ss-m-save">Add</button>
      <button class="msecondary" id="ss-m-cancel">Cancel</button>
      <button class="mdanger" id="ss-m-del" style="display:none">Remove</button>
    </div>
  </div>
</div>

<!-- CONTACT LOG MODAL -->
<div class="moverlay" id="cl-modal">
  <div class="modal" style="max-width:400px;">
    <div class="modal-handle"></div>
    <button class="mclose" id="cl-mclose">Ã—</button>
    <div class="mtitle">Log Contact</div>
    <div class="msub" id="cl-m-sub">Record an interaction with this sponsor.</div>
    <div class="frow full">
      <div class="fg"><label>Date</label><input type="date" id="clf-date"></div>
    </div>
    <div class="frow full">
      <div class="fg"><label>Notes *</label><textarea id="clf-notes" placeholder="What was discussed, next steps, outcomeâ€¦" style="min-height:90px;"></textarea></div>
    </div>
    <div class="mactions">
      <button class="mprimary" id="cl-m-save">Log Contact</button>
      <button class="msecondary" id="cl-m-cancel">Cancel</button>
    </div>
  </div>
</div>

<!-- ORG DETAIL PANEL -->
<div class="moverlay" id="org-detail-overlay" style="align-items:flex-start;padding-top:20px;">
  <div class="modal" style="max-width:680px;max-height:90vh;overflow-y:auto;">
    <div class="modal-handle"></div>
    <button class="mclose" id="od-close">Ã—</button>
    <div id="od-content"></div>
  </div>
</div>

<!-- DRILL DOWN PANEL -->
<div id="drillPanel" class="side-panel">
  <button class="spclose" onclick="closeDrill()">Ã—</button>
  <div class="sp-title" id="drill-title"></div>
  <table class="stable" style="margin-top:10px;font-size:13px;">
    <thead><tr><th>Sponsor</th><th>Tier</th><th>Amount</th><th>Status</th></tr></thead>
    <tbody id="drill-tbody"></tbody>
  </table>
</div>

<!-- SEASON MODAL -->
<div class="moverlay" id="season-modal">
  <div class="smodal-inner">
    <div class="mtitle" style="margin-bottom:12px;">Add Season</div>
    <div class="fg"><label>Year</label><input type="number" id="new-season-yr" min="2020" max="2040" inputmode="numeric"></div>
    <div class="mactions" style="margin-top:14px;">
      <button class="mprimary" onclick="confirmAddSeason()">Add Season</button>
      <button class="msecondary" onclick="closeSeasonModal()">Cancel</button>
    </div>
  </div>
</div>

<!-- RESET MODAL -->
<div class="moverlay" id="reset-modal">
  <div class="smodal-inner">
    <div class="mtitle" style="margin-bottom:8px;">Sign out everywhere?</div>
    <p style="font-size:13px;color:var(--text-dim);margin-bottom:14px;">This will clear your session on this device.</p>
    <div class="mactions">
      <button class="mprimary" onclick="confirmLogout()">Sign Out</button>
      <button class="msecondary" onclick="closeResetModal()">Cancel</button>
    </div>
  </div>
</div>

<!-- USER / EDIT MODAL -->
<div class="moverlay" id="user-modal">
  <div class="smodal-inner" style="max-width:420px;width:100%;overflow:hidden;">
    <div class="mtitle" style="margin-bottom:4px;" id="um-title">Edit User</div>
    <div style="margin-bottom:14px;">
      <div class="fg" style="margin-bottom:10px;"><label>Full Name</label><input type="text" id="um-name" placeholder="Full name"></div>
      <div class="fg" style="margin-bottom:10px;"><label>Role</label>
        <select id="um-role"></select>
        <button onclick="openManageRoles()" style="margin-top:6px;font-size:11px;color:var(--text-dim);background:none;border:none;cursor:pointer;padding:0;text-decoration:underline;">âš™ Manage roles</button>
      </div>
      <div class="fg">
        <label>Access Level</label>
        <div style="display:flex;flex-direction:column;gap:8px;margin-top:6px;">
          <label class="access-opt"><input type="radio" name="access-level" value="admin"><div class="access-opt-check"></div><div class="access-opt-body"><div class="access-opt-title">Admin</div><div class="access-opt-desc">Full access: manage users, seasons, access log, all sponsor data</div></div></label>
          <label class="access-opt"><input type="radio" name="access-level" value="edit"><div class="access-opt-check"></div><div class="access-opt-body"><div class="access-opt-title">Can Edit</div><div class="access-opt-desc">Add/edit/delete sponsors only</div></div></label>
          <label class="access-opt"><input type="radio" name="access-level" value="readonly"><div class="access-opt-check"></div><div class="access-opt-body"><div class="access-opt-title">Read Only</div><div class="access-opt-desc">View dashboard only, no changes</div></div></label>
        </div>
        <p style="font-size:10px;color:var(--text-dim);margin-top:8px;">Access level changes require a Code.gs update and redeploy.</p>
      </div>
    </div>
    <div class="mactions">
      <button class="mprimary" onclick="confirmEditUser()">Save</button>
      <button class="msecondary" onclick="closeUserModal()">Cancel</button>
    </div>
  </div>
</div>

<!-- ROLES MODAL -->
<div class="moverlay" id="roles-modal">
  <div class="smodal-inner" style="max-width:360px;width:100%;">
    <div class="mtitle" style="margin-bottom:12px;">Manage Roles</div>
    <div id="roles-list" style="margin-bottom:14px;max-height:260px;overflow-y:auto;"></div>
    <div style="display:flex;gap:8px;">
      <input type="text" id="new-role-input" placeholder="New role nameâ€¦" style="flex:1;padding:8px 10px;border:1.5px solid var(--border);border-radius:7px;font-size:13px;">
      <button class="mprimary" onclick="addCustomRole()" style="padding:8px 14px;">Add</button>
    </div>
    <div class="mactions" style="margin-top:12px;">
      <button class="msecondary" onclick="closeManageRoles()">Done</button>
    </div>
  </div>
</div>

<div id="toast" class="toast"></div>

<script src="https://accounts.google.com/gsi/client" async defer></script>
<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const GOOGLE_CLIENT_ID = '127701976947-881utr0ljs1eqrfmuoqrsbqh5635vtfl.apps.googleusercontent.com';
const APPS_SCRIPT_URL  = 'https://script.google.com/macros/s/AKfycbx4KydnDFJplWv2ODdSd9PAzd0yKumsJjNG4jixajxMEy3sbCyf9npgvqsy7PqAsjmx/exec';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let me           = null;
let token        = null;
let orgs         = [];      // SponsorOrgs â€” one per company
let seasonEntries = [];     // SponsorSeasons â€” org Ã— year
let years        = [];      // available year list
let activeSeason = null;
let curFilter    = 'all';
let curView      = 'active'; // 'active' | 'prospect'
let editOrgId    = null;     // org being edited
let editSSId     = null;     // season entry being edited
let editSSOrg    = null;     // orgId for season edit

const TO = {gold:1,silver:2,bronze:3,community:4};
const TH = {gold:'#9a6700',silver:'#4a6070',bronze:'#7a4a28',community:'#013C1E'};
const TL = {gold:'Gold',silver:'Silver',bronze:'Bronze',community:'Community'};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  COMPUTED HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Get season entries for a given year
function ssForYear(year) {
  return seasonEntries.filter(s => +s.year === +year);
}
// Get season entries for an org
function ssForOrg(orgId) {
  return seasonEntries.filter(s => s.orgId === orgId);
}
// Get all orgs that have a season entry for the active year
function activeOrgIds(year) {
  return new Set(ssForYear(year).map(s => s.orgId));
}
// Count consecutive years for an org
function consecYears(orgId) {
  const ys = ssForOrg(orgId).map(s => +s.year).sort((a,b) => b-a);
  let c = 0;
  for (let i = 0; i < ys.length; i++) {
    if (ys[i] === (years[0] - i)) c++; else break;
  }
  return c;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SESSION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function saveSession(t, user) { localStorage.setItem('kjfc_token',t); localStorage.setItem('kjfc_user',JSON.stringify(user)); }
function loadSession() { token=localStorage.getItem('kjfc_token'); try{me=JSON.parse(localStorage.getItem('kjfc_user'));}catch{me=null;} }
function clearSession() { localStorage.removeItem('kjfc_token'); localStorage.removeItem('kjfc_user'); token=null; me=null; }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  API
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function api(action, body = {}) {
  return new Promise((resolve) => {
    const cbName = '_kjfc_cb_' + Date.now() + '_' + Math.floor(Math.random()*1e6);
    const params = new URLSearchParams({ action, callback: cbName });
    if (token) params.set('token', token);
    if (action === 'exchangeCode')    params.set('code', body.code || '');
    else if (action === 'getAudit')   params.set('id', body.id || '');
    else if (action === 'getContactLog') params.set('orgId', body.orgId || '');
    else if (Object.keys(body).length > 0) params.set('payload', encodeURIComponent(JSON.stringify(body)));
    const timer = setTimeout(() => { cleanup(); resolve({ error: 'Request timed out' }); }, 20000);
    function cleanup() { clearTimeout(timer); delete window[cbName]; const el=document.getElementById(cbName); if(el) el.remove(); }
    window[cbName] = (data) => { cleanup(); resolve(data); };
    const script = document.createElement('script');
    script.id = cbName;
    script.src = APPS_SCRIPT_URL + '?' + params.toString();
    script.onerror = () => { cleanup(); resolve({ error: 'Script load failed' }); };
    document.head.appendChild(script);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GOOGLE SIGN-IN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initGoogleSignIn() {
  if (!window.google) { setTimeout(initGoogleSignIn, 300); return; }
  google.accounts.id.initialize({ client_id: GOOGLE_CLIENT_ID, callback: handleGoogleCredential, auto_select: false, cancel_on_tap_outside: true });
  function renderGoogleBtn() {
    const container = document.getElementById('google-btn-container'); if (!container) return;
    container.innerHTML = '';
    const lbox = document.querySelector('.lbox');
    const w = Math.min((lbox ? lbox.offsetWidth - 48 : 0) || 300, 360);
    google.accounts.id.renderButton(container, { theme:'outline', size:'large', width:w, text:'continue_with', shape:'rectangular' });
  }
  setTimeout(renderGoogleBtn, 100);
  window.addEventListener('resize', () => setTimeout(renderGoogleBtn, 100));
  document.getElementById('google-sign-in-btn').addEventListener('click', () => google.accounts.id.prompt());
}

async function handleGoogleCredential(response) {
  setSyncState('loading', 'Verifying identityâ€¦');
  const result = await api('exchangeCode', { code: response.credential });
  if (result.error) { document.getElementById('lerr').textContent = result.error; setSyncState('ok',''); return; }
  token = result.token;
  me = { email: result.email, name: result.name, role: result.role, edit: result.edit, admin: result.admin, picture: result.picture };
  saveSession(token, me);
  showApp();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LOAD DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadAll() {
  setSyncState('loading', 'Loading dataâ€¦');
  try {
    const [data, seasonsRes] = await Promise.all([
      api('getAllData'),
      Promise.resolve(null) // getAllData includes years
    ]);
    if (data.error) throw new Error(data.error);
    orgs          = data.orgs   || [];
    seasonEntries = data.seasons || [];
    years         = (data.years || []).sort((a,b) => b-a);
    if (!activeSeason || !years.includes(activeSeason)) activeSeason = years[0] || null;
    renderSeasonTabs();
    render();
    setSyncState('ok', 'Synced Â· ' + fmtTime(new Date()));
  } catch(e) {
    setSyncState('err', 'Load failed: ' + e.message);
    showToast('Load failed', 'err');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  APP SHOW / HIDE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showApp() {
  document.getElementById('login-view').style.display = 'none';
  document.getElementById('app').style.display = 'block';
  renderUserUI();
  loadAll();
}

function renderUserUI() {
  if (!me) return;
  document.getElementById('user-name').textContent = me.name || me.email;
  const pic = document.getElementById('user-pic');
  if (me.picture) { pic.src = me.picture; pic.style.display = 'block'; }
  if (me.admin) document.getElementById('admin-section').style.display = 'block';
  if (!me.edit) { const b = document.getElementById('add-sponsor-btn'); if(b) b.style.display='none'; }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SEASON TABS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderSeasonTabs() {
  document.getElementById('season-tabs').innerHTML = years.map(y =>
    `<button class="stab${+y===+activeSeason?' act':''}" onclick="switchSeason(${y})">${y}</button>`
  ).join('');
  const sel = document.getElementById('sf-year');
  if (sel) { sel.innerHTML = years.map(y=>`<option value="${y}">${y}</option>`).join(''); sel.value = activeSeason; }
}

function switchSeason(y) { activeSeason = +y; renderSeasonTabs(); render(); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function calcStats(year) {
  const ss       = ssForYear(year);
  const cashSS   = ss.filter(s => s.status !== 'inkind');
  const ikSS     = ss.filter(s => s.status === 'inkind');
  const total    = cashSS.reduce((a,s) => a + +s.amount, 0);
  const recv     = cashSS.reduce((a,s) =>
    s.status==='paid' ? a + +s.amount :
    s.status==='partial' ? a + +(s.paidAmount||0) : a, 0);
  const outCount = cashSS.filter(s => s.status!=='paid').length;
  const byTier   = {};
  ['gold','silver','bronze','community'].forEach(t => {
    const ts   = ss.filter(s => String(s.tier).toLowerCase()===t);
    const cash = ts.filter(s => s.status!=='inkind');
    const ik   = ts.filter(s => s.status==='inkind');
    byTier[t]  = { count: ts.length, cashCount: cash.length, ikCount: ik.length,
                   amount: cash.reduce((a,s)=>a+ +s.amount,0) };
  });
  return { total, recv, outstanding: total-recv, outCount, count: ss.length,
           ikCount: ikSS.length, byTier };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MAIN RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function render() {
  const cy = activeSeason; if (!cy) return;
  const s    = calcStats(cy);
  const prevYr = years[years.indexOf(cy)+1];
  const prev = prevYr ? calcStats(prevYr) : { total:0 };

  document.getElementById('season-span').textContent = 'Sponsorship ' + cy + ' Season';
  document.getElementById('k-total').textContent = fmt(s.total);
  document.getElementById('k-count').textContent = s.count + ' sponsor' + (s.count!==1?'s':'');
  document.getElementById('k-paid').textContent  = fmt(s.recv);
  const pct = s.total>0 ? Math.round(s.recv/s.total*100) : 0;
  document.getElementById('k-ppct').textContent = pct + '% collected';
  document.getElementById('k-bar').style.width  = pct + '%';
  document.getElementById('k-out').textContent  = fmt(s.outstanding);
  document.getElementById('k-outc').textContent = s.outCount + ' invoice' + (s.outCount!==1?'s':'') + ' pending';

  const tEl = document.getElementById('k-trend');
  if (prev.total>0 && s.total>0) {
    const d = s.total-prev.total, pd = Math.round(d/prev.total*100);
    tEl.textContent = (d>=0?'â–² ':'â–¼ ') + Math.abs(pd) + '% vs ' + prevYr;
    tEl.className = 'ktrend ' + (d>=0?'up':'dn');
  } else tEl.textContent = '';

  // In-kind strip
  const ikStrip = document.getElementById('inkind-strip');
  const ikSumm  = document.getElementById('inkind-summary');
  if (ikStrip) ikStrip.style.display = s.ikCount>0 ? 'flex' : 'none';
  if (ikSumm && s.ikCount>0) ikSumm.textContent = s.ikCount+' in-kind sponsor'+(s.ikCount!==1?'s':'')+' this season';

  // Tier mini
  document.getElementById('tier-mini').innerHTML = ['gold','silver','bronze','community'].map(t => {
    const d = s.byTier[t]; if (!d.count) return '';
    const ikBit = d.ikCount>0 ? `<span style="font-size:9px;color:#6d28d9;font-weight:600"> (inc. ${d.ikCount} in-kind)</span>` : '';
    return `<div style="display:flex;align-items:center;gap:7px"><div style="width:6px;height:6px;border-radius:50%;background:${TH[t]};flex-shrink:0"></div><span style="font-size:11px;flex:1">${TL[t]}</span><span style="font-size:12px;font-weight:800;color:${TH[t]}">${d.count}${ikBit}</span></div>`;
  }).join('');

  // YOY bars
  const allSt = years.map(y => ({ year:y, ...calcStats(y) }));
  const maxT  = Math.max(...allSt.map(x=>x.total), 1);
  document.getElementById('year-bars').innerHTML = allSt.map(ys => {
    const p2 = Math.round(ys.total/maxT*100);
    const isCur = +ys.year===+cy;
    return `<div class="ybargrp" onclick="switchSeason(${ys.year})" title="View ${ys.year}">
      <div class="ybarlbl"><span class="yr" style="${isCur?'color:var(--text);font-weight:700':''}">${ys.year}${isCur?' â˜…':''}</span>
      <span style="font-weight:700;color:${isCur?'var(--yellow-dark)':'var(--text-dim)'}">${fmt(ys.total)} <span style="font-size:9px;font-weight:400">(${ys.count})</span></span></div>
      <div class="btrack"><div class="bfill ${isCur?'cur':'prev'}" style="width:${p2}%"></div></div>
    </div>`;
  }).join('');

  // Tier list (revenue by tier)
  document.getElementById('tier-list').innerHTML = ['gold','silver','bronze','community'].map(t => {
    const d = s.byTier[t]; if (!d.count) return '';
    const ikLabel = d.ikCount>0 ? `<span style="font-size:9px;color:#6d28d9;font-weight:700;margin-left:4px">(inc. ${d.ikCount} in-kind)</span>` : '';
    return `<div class="trow" onclick="filterTable('${t}')">
      <div class="tdot ${t}"></div><div class="tname">${TL[t]}${ikLabel}</div>
      <div class="tcnt">${d.count}</div><div class="tamt" style="color:${TH[t]}">${fmt(d.amount)}</div>
    </div>`;
  }).join('') || '<div style="color:var(--text-dim);font-size:13px;padding:6px">No sponsors yet.</div>';

  // Prospect pipeline
  renderProspects();

  renderTable();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PROSPECT PIPELINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderProspects() {
  const prospects = orgs.filter(o => o.orgStatus === 'prospect');
  const panel = document.getElementById('prospect-panel');
  const list  = document.getElementById('prospect-list');
  if (!prospects.length) { panel.style.display='none'; return; }
  panel.style.display='block';
  list.innerHTML = prospects.map(o => {
    const logs  = ''; // loaded on demand
    const email = o.email ? `<a href="mailto:${o.email}" style="color:var(--green)">${o.email}</a>` : 'â€”';
    return `<div class="trow" onclick="openOrgDetail('${o.id}')" style="margin-bottom:4px;">
      <div style="flex:1;min-width:0;">
        <strong>${o.name}</strong>
        ${o.primaryContact ? `<span style="color:var(--text-dim);font-size:12px;margin-left:6px">${o.primaryContact}</span>` : ''}
      </div>
      ${o.phone ? `<span style="font-size:11px;color:var(--text-dim)">${o.phone}</span>` : ''}
    </div>`;
  }).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SPONSOR TABLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setView(v) {
  curView = v;
  document.getElementById('vtab-active').classList.toggle('act', v==='active');
  document.getElementById('vtab-prospect').classList.toggle('act', v==='prospect');
  // Hide tier filters for prospect view
  document.getElementById('filters').style.display = v==='active' ? '' : 'none';
  renderTable();
}

function filterTable(f) {
  curFilter = f;
  document.querySelectorAll('.ftab').forEach(b => b.classList.remove('act'));
  event.target.classList.add('act');
  renderTable();
}

function renderTable() {
  const cy    = activeSeason;
  const empty = document.getElementById('tbl-empty');
  const tbody = document.getElementById('tbody');

  if (curView === 'prospect') {
    // Show prospects â€” orgs with status=prospect or no season entry this year
    const prospects = orgs.filter(o => o.orgStatus==='prospect');
    if (!prospects.length) { tbody.innerHTML=''; empty.style.display='block'; empty.textContent='No prospects yet. Add one with + Add Sponsor.'; return; }
    empty.style.display='none';
    tbody.innerHTML = prospects.map(o => {
      const lastContact = ''; // shown in detail
      return `<tr onclick="openOrgDetail('${o.id}')" style="cursor:pointer">
        <td><strong>${o.name}</strong></td>
        <td colspan="3" style="color:var(--text-dim);font-size:12px">${o.primaryContact||'â€”'} ${o.email?'Â· '+o.email:''}</td>
        <td><span class="ostatus prospect">Prospect</span></td>
        <td>${o.phone||'â€”'}</td>
        <td><button class="actbtn" onclick="event.stopPropagation();openEditOrg('${o.id}')">Edit</button></td>
      </tr>`;
    }).join('');
    return;
  }

  // Active view â€” join season entries with orgs for activeSeason
  let ss = ssForYear(cy);
  if (curFilter!=='all' && curFilter!=='outstanding') ss = ss.filter(s => s.tier===curFilter);
  if (curFilter==='outstanding') ss = ss.filter(s => s.status!=='paid' && s.status!=='inkind');
  ss.sort((a,b) => (TO[a.tier]||5)-(TO[b.tier]||5));

  if (!ss.length) { tbody.innerHTML=''; empty.style.display='block'; empty.textContent='No sponsors for this season yet.'; return; }
  empty.style.display='none';

  tbody.innerHTML = ss.map(s => {
    const org   = orgs.find(o => o.id===s.orgId) || { name: s.orgId, primaryContact:'', phone:'' };
    const c     = consecYears(s.orgId);
    const cBadge = c>1 ? `<span class="cbadge">â˜… ${c} yrs</span>` : `<span style="color:var(--text-dim);font-size:11px">1st</span>`;
    const amtH = s.status==='inkind' ? '<span style="color:#6d28d9;font-size:11px;font-weight:700">In-Kind</span>' :
                 s.status==='partial' ? `${fmt(s.amount)}<br><span style="font-size:10px;color:var(--orange)">${fmt(s.paidAmount||0)} recv</span>` :
                 fmt(s.amount);
    return `<tr onclick="openOrgDetail('${org.id}')" style="cursor:pointer">
      <td><strong>${org.name}</strong></td>
      <td><span class="tchip ${s.tier}">${TL[s.tier]||cap(s.tier)}</span></td>
      <td>${amtH}</td>
      <td><span class="sbadge ${s.status}">${cap(s.status)}</span></td>
      <td>${cBadge}</td>
      <td style="font-size:11px;color:var(--text-dim)">${org.primaryContact||'â€”'}</td>
      <td><button class="actbtn" onclick="event.stopPropagation();openEditSS('${s.id}','${org.id}')">Edit</button></td>
    </tr>`;
  }).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ORG DETAIL PANEL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function openOrgDetail(orgId) {
  const org = orgs.find(o => o.id===orgId); if (!org) return;
  const overlay = document.getElementById('org-detail-overlay');
  overlay.classList.add('open');

  // Render skeleton first
  renderOrgDetail(org, [], true);

  // Fetch contact log
  const logRes = await api('getContactLog', { orgId });
  const clog   = Array.isArray(logRes) ? logRes : [];
  renderOrgDetail(org, clog, false);
}

function renderOrgDetail(org, clog, loading) {
  const ssList  = ssForOrg(org.id).sort((a,b) => +b.year - +a.year);
  const editBtn = me?.edit ? `<button class="actbtn" onclick="openEditOrg('${org.id}')">Edit</button>` : '';

  const addrSection = (org.physAddr || org.postAddr) ? `
    <div style="margin-bottom:12px;">
      ${org.physAddr ? `<div style="font-size:11px;color:var(--text-dim);font-weight:700;text-transform:uppercase;letter-spacing:.5px;">Physical Address</div><div style="font-size:13px;margin-bottom:6px;">${org.physAddr}</div>` : ''}
      ${org.postAddr && !org.postSameAsPhys ? `<div style="font-size:11px;color:var(--text-dim);font-weight:700;text-transform:uppercase;letter-spacing:.5px;">Postal Address</div><div style="font-size:13px;">${org.postAddr}</div>` : ''}
      ${org.postSameAsPhys ? `<div style="font-size:11px;color:var(--text-dim);font-style:italic;">Postal same as physical</div>` : ''}
    </div>` : '';

  const seasonHtml = ssList.length ? ssList.map(s =>
    `<span class="season-pill" onclick="openEditSS('${s.id}','${org.id}')">
      <span class="sp-tier" style="color:${TH[s.tier]||'inherit'}">${TL[s.tier]||s.tier}</span>
      <span class="sp-yr">${s.year}</span>
      <span class="sbadge ${s.status}" style="font-size:8px;padding:1px 5px;">${cap(s.status)}</span>
    </span>`
  ).join(' ') : '<span style="color:var(--text-dim);font-size:12px">No season entries</span>';

  const addSSBtn = me?.edit ? `<span class="add-season-pill" onclick="openAddSS('${org.id}')">+ Add Season</span>` : '';

  const clogHtml = loading ? '<div style="color:var(--text-dim);font-size:12px;padding:8px 0;">Loading contact logâ€¦</div>' :
    !clog.length ? '<div style="color:var(--text-dim);font-size:12px;padding:8px 0;">No contact history yet.</div>' :
    clog.map(c => `
      <div class="clog-entry">
        <div class="clog-dot"></div>
        <div class="clog-body">
          <div class="clog-meta">${c.date} Â· ${c.contactedBy}
            ${me?.edit ? `<button onclick="deleteContactEntry('${c.id}','${org.id}')" style="margin-left:8px;font-size:10px;color:var(--red);background:none;border:none;cursor:pointer;">âœ•</button>` : ''}
          </div>
          <div class="clog-notes">${c.notes}</div>
        </div>
      </div>`).join('');

  const addLogBtn = me?.edit ? `<button class="actbtn" onclick="openContactLog('${org.id}')" style="margin-bottom:10px;">+ Log Contact</button>` : '';

  document.getElementById('od-content').innerHTML = `
    <div style="display:flex;align-items:flex-start;gap:12px;margin-bottom:16px;">
      <div class="dlogo" style="flex-shrink:0;">${org.name.split(' ').map(w=>w[0]).slice(0,2).join('').toUpperCase()}</div>
      <div style="flex:1;min-width:0;">
        <h2 style="font-family:'Barlow Condensed',sans-serif;font-size:22px;font-weight:900;">${org.name}</h2>
        <div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap;margin-top:4px;">
          <span class="ostatus ${org.orgStatus}">${cap(org.orgStatus)}</span>
          ${org.website ? `<a href="https://${org.website}" target="_blank" rel="noopener" style="color:var(--green);font-size:11px;">${org.website} â†—</a>` : ''}
        </div>
      </div>
      ${editBtn}
    </div>

    <div class="org-detail-wrap">
      <div class="org-detail-main">
        ${org.primaryContact||org.email||org.phone ? `
        <div class="panel" style="margin-bottom:12px;">
          <div style="font-size:9px;text-transform:uppercase;letter-spacing:1.2px;color:var(--text-dim);font-weight:700;margin-bottom:8px;">Contact Details</div>
          ${org.primaryContact ? `<div style="font-size:13px;font-weight:600;margin-bottom:4px;">ğŸ‘¤ ${org.primaryContact}</div>` : ''}
          ${org.email ? `<div style="font-size:12px;margin-bottom:3px;">âœ‰ <a href="mailto:${org.email}" style="color:var(--green)">${org.email}</a></div>` : ''}
          ${org.phone ? `<div style="font-size:12px;margin-bottom:3px;">ğŸ“ ${org.phone}</div>` : ''}
          ${addrSection}
        </div>` : ''}

        <div class="panel" style="margin-bottom:12px;">
          <div style="font-size:9px;text-transform:uppercase;letter-spacing:1.2px;color:var(--text-dim);font-weight:700;margin-bottom:8px;">Season History</div>
          <div style="display:flex;flex-wrap:wrap;gap:6px;align-items:center;">
            ${seasonHtml}
            ${addSSBtn}
          </div>
        </div>

        ${org.notes ? `<div class="panel" style="margin-bottom:12px;">
          <div style="font-size:9px;text-transform:uppercase;letter-spacing:1.2px;color:var(--text-dim);font-weight:700;margin-bottom:6px;">Notes</div>
          <div style="font-size:13px;color:var(--text-mid);">${org.notes}</div>
        </div>` : ''}
      </div>

      <div class="org-detail-side">
        <div class="panel">
          <div style="font-size:9px;text-transform:uppercase;letter-spacing:1.2px;color:var(--text-dim);font-weight:700;margin-bottom:8px;">Contact Log</div>
          ${addLogBtn}
          <div id="clog-list-${org.id}">${clogHtml}</div>
        </div>
      </div>
    </div>`;
}

function closeOrgDetail() { document.getElementById('org-detail-overlay').classList.remove('open'); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ORG MODAL (add / edit organisation)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function resetOrgModal() {
  ['of-name','of-contact','of-email','of-phone','of-website','of-physaddr','of-postaddr','of-notes'].forEach(id => {
    const el = document.getElementById(id); if(el) el.value='';
  });
  document.getElementById('of-orgstatus').value = 'prospect';
  document.getElementById('of-postsame').checked = false;
  document.getElementById('of-postaddr').disabled = false;
}

function togglePostalSame() {
  const same = document.getElementById('of-postsame').checked;
  const postEl = document.getElementById('of-postaddr');
  postEl.disabled = same;
  if (same) postEl.value = document.getElementById('of-physaddr').value;
}

document.getElementById('of-physaddr').addEventListener('input', function() {
  if (document.getElementById('of-postsame').checked) document.getElementById('of-postaddr').value = this.value;
});

function openAddOrg() {
  if (!me?.edit) return;
  editOrgId = null;
  resetOrgModal();
  document.getElementById('org-m-title').textContent = 'Add Sponsor';
  document.getElementById('org-m-save').textContent  = 'Add Sponsor';
  document.getElementById('org-m-del').style.display = 'none';
  document.getElementById('org-m-sub').textContent   = 'New sponsor organisation.';
  document.getElementById('org-modal').classList.add('open');
}

function openEditOrg(orgId) {
  if (!me?.edit) return;
  const org = orgs.find(o => o.id===orgId); if (!org) return;
  editOrgId = orgId;
  resetOrgModal();
  document.getElementById('org-m-title').textContent    = 'Edit Sponsor';
  document.getElementById('org-m-save').textContent     = 'Save Changes';
  document.getElementById('org-m-del').style.display    = 'block';
  document.getElementById('org-m-sub').textContent      = org.name;
  document.getElementById('of-name').value              = org.name;
  document.getElementById('of-orgstatus').value         = org.orgStatus || 'prospect';
  document.getElementById('of-contact').value           = org.primaryContact || '';
  document.getElementById('of-email').value             = org.email || '';
  document.getElementById('of-phone').value             = org.phone || '';
  document.getElementById('of-website').value           = org.website || '';
  document.getElementById('of-physaddr').value          = org.physAddr || '';
  document.getElementById('of-postaddr').value          = org.postAddr || '';
  document.getElementById('of-notes').value             = org.notes || '';
  document.getElementById('of-postsame').checked        = !!org.postSameAsPhys;
  document.getElementById('of-postaddr').disabled       = !!org.postSameAsPhys;
  document.getElementById('org-modal').classList.add('open');
}

function closeOrgModal() { document.getElementById('org-modal').classList.remove('open'); editOrgId=null; }

async function saveOrg() {
  const name = document.getElementById('of-name').value.trim();
  if (!name) { showToast('Enter a business name', 'warn'); return; }
  const data = {
    id:             editOrgId || '',
    name,
    orgStatus:      document.getElementById('of-orgstatus').value,
    primaryContact: document.getElementById('of-contact').value.trim(),
    email:          document.getElementById('of-email').value.trim(),
    phone:          document.getElementById('of-phone').value.trim(),
    website:        document.getElementById('of-website').value.trim(),
    physAddr:       document.getElementById('of-physaddr').value.trim(),
    postAddr:       document.getElementById('of-postaddr').value.trim(),
    postSameAsPhys: document.getElementById('of-postsame').checked,
    notes:          document.getElementById('of-notes').value.trim(),
  };
  setSyncState('loading', 'Savingâ€¦');
  btnLoading(document.getElementById('org-m-save'), true);
  const res = await api('saveOrg', { data, isNew: !editOrgId });
  btnLoading(document.getElementById('org-m-save'), false);
  if (res.error) { showToast('Error: ' + res.error, 'err'); setSyncState('err','Save failed'); return; }
  // Local update
  if (!editOrgId) { data.id = res.id; orgs.push(data); }
  else { const idx=orgs.findIndex(o=>o.id===editOrgId); if(idx>=0) orgs[idx]={...orgs[idx],...data}; }
  closeOrgModal();
  render();
  showToast(editOrgId ? 'Sponsor updated âœ“' : 'Sponsor added âœ“');
  loadAll();
}

async function deleteOrg() {
  const org = orgs.find(o => o.id===editOrgId); if (!org) return;
  if (!confirm(`Delete ${org.name} and all their season records? This cannot be undone.`)) return;
  btnLoading(document.getElementById('org-m-del'), true);
  const res = await api('deleteOrg', { id: editOrgId });
  btnLoading(document.getElementById('org-m-del'), false);
  if (res.error) { showToast('Error: ' + res.error, 'err'); return; }
  orgs = orgs.filter(o => o.id!==editOrgId);
  seasonEntries = seasonEntries.filter(s => s.orgId!==editOrgId);
  closeOrgModal(); closeOrgDetail();
  render();
  showToast('Sponsor deleted');
  loadAll();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SEASON ENTRY MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openAddSS(orgId) {
  if (!me?.edit) return;
  editSSId  = null;
  editSSOrg = orgId;
  const org = orgs.find(o=>o.id===orgId);
  document.getElementById('ss-m-title').textContent = 'Add Season Sponsorship';
  document.getElementById('ss-m-sub').textContent   = org ? org.name : '';
  document.getElementById('ss-m-save').textContent  = 'Add';
  document.getElementById('ss-m-del').style.display = 'none';
  document.getElementById('sf-tier').value   = '';
  document.getElementById('sf-status').value = '';
  document.getElementById('sf-amount').value = '';
  document.getElementById('sf-paid').value   = '';
  document.getElementById('sf-partial-wrap').style.display = 'none';
  document.getElementById('sf-amount-wrap').style.display  = '';
  // Default to activeSeason
  const sel = document.getElementById('sf-year');
  if (sel) sel.value = activeSeason;
  document.getElementById('ss-modal').classList.add('open');
}

function openEditSS(ssId, orgId) {
  if (!me?.edit) return;
  const ss  = seasonEntries.find(s=>s.id===ssId); if (!ss) return;
  const org = orgs.find(o=>o.id===orgId);
  editSSId  = ssId;
  editSSOrg = orgId;
  document.getElementById('ss-m-title').textContent = 'Edit Season Sponsorship';
  document.getElementById('ss-m-sub').textContent   = (org?org.name:'') + ' Â· ' + ss.year;
  document.getElementById('ss-m-save').textContent  = 'Save';
  document.getElementById('ss-m-del').style.display = 'block';
  document.getElementById('sf-year').value   = ss.year;
  document.getElementById('sf-tier').value   = ss.tier;
  document.getElementById('sf-status').value = ss.status;
  document.getElementById('sf-amount').value = ss.status==='inkind' ? '' : ss.amount;
  document.getElementById('sf-paid').value   = ss.paidAmount || '';
  document.getElementById('sf-partial-wrap').style.display = ss.status==='partial' ? '' : 'none';
  document.getElementById('sf-amount-wrap').style.display  = ss.status==='inkind'  ? 'none' : '';
  document.getElementById('ss-modal').classList.add('open');
}

function closeSSModal() { document.getElementById('ss-modal').classList.remove('open'); editSSId=null; editSSOrg=null; }

document.getElementById('sf-status').addEventListener('change', function() {
  const isPartial = this.value==='partial', isInKind = this.value==='inkind';
  document.getElementById('sf-partial-wrap').style.display = isPartial ? '' : 'none';
  document.getElementById('sf-amount-wrap').style.display  = isInKind  ? 'none' : '';
  if (isInKind) document.getElementById('sf-amount').value = '0';
});

async function saveSS() {
  const tier   = document.getElementById('sf-tier').value;
  const status = document.getElementById('sf-status').value;
  const amount = document.getElementById('sf-amount').value;
  if (!tier)   { showToast('Select a tier', 'warn'); return; }
  if (!status) { showToast('Select a payment status', 'warn'); return; }
  const finalAmount = status==='inkind' ? 0 : +amount;
  if (status!=='inkind' && (!amount || +amount<=0)) { showToast('Enter a valid amount', 'warn'); return; }
  const data = {
    id: editSSId||'', orgId: editSSOrg,
    year: +document.getElementById('sf-year').value,
    tier, status,
    amount: finalAmount,
    paidAmount: +document.getElementById('sf-paid').value||0,
  };
  setSyncState('loading', 'Savingâ€¦');
  btnLoading(document.getElementById('ss-m-save'), true);
  const res = await api('saveSeason', { data, isNew: !editSSId });
  btnLoading(document.getElementById('ss-m-save'), false);
  if (res.error) { showToast('Error: ' + res.error, 'err'); setSyncState('err','Save failed'); return; }
  if (!editSSId) { data.id=res.id; seasonEntries.push(data); }
  else { const idx=seasonEntries.findIndex(s=>s.id===editSSId); if(idx>=0) seasonEntries[idx]={...seasonEntries[idx],...data}; }
  closeSSModal(); render();
  showToast(editSSId ? 'Updated âœ“' : 'Season entry added âœ“');
  loadAll();
}

async function deleteSS() {
  if (!confirm('Remove this season entry?')) return;
  btnLoading(document.getElementById('ss-m-del'), true);
  const res = await api('deleteSeason', { id: editSSId });
  btnLoading(document.getElementById('ss-m-del'), false);
  if (res.error) { showToast('Error: '+res.error, 'err'); return; }
  seasonEntries = seasonEntries.filter(s=>s.id!==editSSId);
  closeSSModal(); render();
  showToast('Season entry removed');
  loadAll();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONTACT LOG MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let clOrgId = null;

function openContactLog(orgId) {
  clOrgId = orgId;
  const org = orgs.find(o=>o.id===orgId);
  document.getElementById('cl-m-sub').textContent = org ? org.name : '';
  document.getElementById('clf-date').value  = new Date().toISOString().slice(0,10);
  document.getElementById('clf-notes').value = '';
  document.getElementById('cl-modal').classList.add('open');
}

function closeContactLog() { document.getElementById('cl-modal').classList.remove('open'); clOrgId=null; }

async function saveContactLog() {
  const notes = document.getElementById('clf-notes').value.trim();
  if (!notes) { showToast('Enter some notes', 'warn'); return; }
  const date = document.getElementById('clf-date').value;
  btnLoading(document.getElementById('cl-m-save'), true);
  const res = await api('addContactLog', { orgId: clOrgId, date, notes });
  btnLoading(document.getElementById('cl-m-save'), false);
  if (res.error) { showToast('Error: '+res.error, 'err'); return; }
  closeContactLog();
  showToast('Contact logged âœ“');
  // Refresh the org detail if open
  const od = document.getElementById('org-detail-overlay');
  if (od.classList.contains('open')) openOrgDetail(clOrgId);
}

async function deleteContactEntry(id, orgId) {
  if (!confirm('Delete this contact log entry?')) return;
  await api('deleteContactLog', { id });
  openOrgDetail(orgId); // refresh
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DRILL DOWN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openDrill(title, ssList) {
  document.getElementById('drill-title').textContent = title;
  document.getElementById('drill-tbody').innerHTML = ssList.map(s => {
    const org = orgs.find(o=>o.id===s.orgId)||{name:s.orgId};
    return `<tr onclick="openOrgDetail('${s.orgId}')" style="cursor:pointer">
      <td><strong>${org.name}</strong></td>
      <td><span class="tchip ${s.tier}">${TL[s.tier]||cap(s.tier)}</span></td>
      <td>${s.status==='inkind'?'<span style="color:#6d28d9;font-size:11px">In-Kind</span>':fmt(s.amount)}</td>
      <td><span class="sbadge ${s.status}">${cap(s.status)}</span></td>
    </tr>`;
  }).join('');
  document.getElementById('drillPanel').classList.add('open');
}

function closeDrill() { document.getElementById('drillPanel').classList.remove('open'); }

function drillTotal() {
  const ss = ssForYear(activeSeason).sort((a,b)=>(TO[a.tier]||5)-(TO[b.tier]||5));
  openDrill('All Sponsors â€” ' + activeSeason + ' (' + fmt(ss.filter(s=>s.status!=='inkind').reduce((a,s)=>a+ +s.amount,0)) + ')', ss);
}
function drillPaid() {
  const ss = ssForYear(activeSeason).filter(s=>s.status==='paid'||s.status==='partial').sort((a,b)=>(TO[a.tier]||5)-(TO[b.tier]||5));
  openDrill('Received â€” ' + activeSeason, ss);
}
function drillOut() {
  const ss = ssForYear(activeSeason).filter(s=>s.status==='outstanding'||s.status==='partial').sort((a,b)=>(TO[a.tier]||5)-(TO[b.tier]||5));
  openDrill('Outstanding â€” ' + activeSeason, ss);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SEASON YEAR MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openSeasonModal() {
  document.getElementById('new-season-yr').value = (years[0]||2025) + 1;
  document.getElementById('season-modal').classList.add('open');
}
function closeSeasonModal() { document.getElementById('season-modal').classList.remove('open'); }
async function confirmAddSeason() {
  const y = +document.getElementById('new-season-yr').value;
  if (!y||y<2020||y>2045) { showToast('Enter a valid year','warn'); return; }
  if (years.includes(y)) { showToast(y+' already exists','warn'); closeSeasonModal(); return; }
  setSyncState('loading','Adding seasonâ€¦');
  const res = await api('addSeason', { year: y });
  if (res.error) { showToast('Error: '+res.error,'err'); return; }
  years.unshift(y); years.sort((a,b)=>b-a);
  closeSeasonModal(); renderSeasonTabs();
  showToast('Season '+y+' added âœ“');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  EXPORT CSV
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function exportCSV() {
  const ss = ssForYear(activeSeason);
  const rows = [['Sponsor','Tier','Amount','Status','Received','Contact','Email','Phone','Website','Notes']];
  ss.forEach(s => {
    const org = orgs.find(o=>o.id===s.orgId)||{name:s.orgId};
    rows.push([org.name,s.tier,s.amount,s.status,s.paidAmount||0,org.primaryContact||'',org.email||'',org.phone||'',org.website||'',org.notes||'']);
  });
  const csv = rows.map(r=>r.map(v=>'"'+String(v).replace(/"/g,'""')+'"').join(',')).join('\n');
  const a = document.createElement('a');
  a.href = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csv);
  a.download = 'KJFC_Sponsors_' + activeSeason + '.csv';
  a.click();
  showToast('CSV exported âœ“');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LOGOUT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function doLogout() {
  document.getElementById('reset-modal').classList.add('open');
}
function closeResetModal() { document.getElementById('reset-modal').classList.remove('open'); }
async function confirmLogout() {
  clearSession();
  if (window.google) google.accounts.id.disableAutoSelect();
  closeResetModal();
  location.reload();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ADMIN: ACCESS LOG + USER GRID
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function renderAccessLog() {
  const wrap = document.getElementById('access-log-wrap');
  wrap.style.display = wrap.style.display==='none' ? 'block' : 'none';
  if (wrap.style.display==='none') return;
  wrap.innerHTML = '<div style="color:var(--text-dim);font-size:13px;">Loadingâ€¦</div>';
  const res = await api('getLog');
  if (!Array.isArray(res)) { wrap.innerHTML='<div style="color:var(--red)">Failed to load</div>'; return; }
  wrap.innerHTML = `<table class="stable" style="font-size:11px;">
    <thead><tr><th>Time</th><th>User</th><th>Action</th><th>Details</th></tr></thead>
    <tbody>${res.map(r=>`<tr><td>${fmtD(r.timestamp)}</td><td>${r.user||''}</td><td>${r.action||''}</td><td style="max-width:220px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${r.details||''}</td></tr>`).join('')}</tbody>
  </table>`;
}

let editingUser = null;
async function renderUserGrid() {
  const wrap = document.getElementById('user-grid-wrap');
  wrap.style.display = wrap.style.display==='none' ? 'block' : 'none';
  if (wrap.style.display==='none') return;
  wrap.innerHTML = '<div style="color:var(--text-dim);font-size:13px;">Loadingâ€¦</div>';
  const res = await api('getUsers');
  if (!Array.isArray(res)) { wrap.innerHTML='<div style="color:var(--red)">Failed</div>'; return; }
  wrap.innerHTML = `<div style="display:flex;flex-direction:column;gap:8px;margin-top:8px;">
    ${res.map(u=>`<div style="display:flex;align-items:center;gap:10px;padding:10px;background:var(--bg);border-radius:8px;">
      <div style="flex:1;min-width:0;"><div style="font-weight:600;font-size:13px;">${u.name||u.email}</div>
      <div style="font-size:11px;color:var(--text-dim);">${u.email} Â· ${u.role}</div></div>
      <button class="actbtn" onclick="openUserModal(${JSON.stringify(u).replace(/"/g,'&quot;')})">Edit</button>
    </div>`).join('')}
  </div>`;
}

function openUserModal(u) {
  editingUser = u;
  document.getElementById('um-title').textContent = 'Edit: ' + (u.name||u.email);
  document.getElementById('um-name').value = u.name||'';
  populateRoleSelect(); document.getElementById('um-role').value = u.role||'Member';
  const lvl = u.admin?'admin': u.edit?'edit':'readonly';
  document.querySelectorAll('input[name="access-level"]').forEach(r => r.checked = r.value===lvl);
  document.getElementById('user-modal').classList.add('open');
}
function closeUserModal() { document.getElementById('user-modal').classList.remove('open'); editingUser=null; }
async function confirmEditUser() {
  if (!editingUser) return;
  const res = await api('updateUser', { email: editingUser.email, name: document.getElementById('um-name').value.trim(), role: document.getElementById('um-role').value });
  if (res.error) { showToast('Error: '+res.error,'err'); return; }
  closeUserModal(); showToast('User updated âœ“'); loadAll();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ROLES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const DEFAULT_ROLES = ['President','Vice President','Treasurer','Secretary','Registrar','Committee Member','Coach','Team Manager','Volunteer','Administrator','Member'];
function getRoles() { try { return JSON.parse(localStorage.getItem('kjfc_roles')) || DEFAULT_ROLES; } catch { return DEFAULT_ROLES; } }
function saveRoles(r) { localStorage.setItem('kjfc_roles', JSON.stringify(r)); }
function populateRoleSelect() { const s=document.getElementById('um-role'); s.innerHTML=getRoles().map(r=>`<option>${r}</option>`).join(''); }
function openManageRoles() { renderRolesList(); document.getElementById('roles-modal').classList.add('open'); }
function closeManageRoles() { document.getElementById('roles-modal').classList.remove('open'); populateRoleSelect(); }
function renderRolesList() {
  const roles=getRoles();
  document.getElementById('roles-list').innerHTML = roles.map((r,i)=>`
    <div class="role-tag"><span>${r}</span>
      ${DEFAULT_ROLES.includes(r)?'<span style="font-size:9px;color:var(--text-dim);margin-left:auto">default</span>':
        `<button onclick="deleteRole(${i})" style="background:none;border:none;color:var(--red);cursor:pointer;font-size:13px;margin-left:auto;">âœ•</button>`}
    </div>`).join('');
}
function addCustomRole() { const v=document.getElementById('new-role-input').value.trim(); if(!v) return; const r=getRoles(); if(!r.includes(v)) r.push(v); saveRoles(r); document.getElementById('new-role-input').value=''; renderRolesList(); showToast('Role added âœ“'); }
function deleteRole(i) { const r=getRoles(); if(DEFAULT_ROLES.includes(r[i])) return; r.splice(i,1); saveRoles(r); renderRolesList(); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BUTTON LOADING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function btnLoading(el, isLoading) {
  if (!el) return;
  if (isLoading) { el.classList.add('btn-loading'); el.disabled=true; }
  else           { el.classList.remove('btn-loading'); el.disabled=false; }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SYNC STATE / TOAST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setSyncState(state, text) {
  const el = document.getElementById('sync-state'); if (!el) return;
  el.textContent = (state==='loading'?'âŸ³ ':state==='err'?'âœ• ':'â— ') + text;
  el.className = 'sync-' + state;
}

function fmt(n)    { return '$' + Number(n).toLocaleString('en-AU'); }
function cap(s)    { return s ? s.charAt(0).toUpperCase() + s.slice(1) : ''; }
function fmtTime(d){ return d.toLocaleTimeString('en-AU', { hour:'2-digit', minute:'2-digit' }); }
function fmtD(iso) {
  if (!iso) return '';
  try { const d=new Date(iso); return d.toLocaleDateString('en-AU',{day:'2-digit',month:'short',year:'numeric'})+' '+d.toLocaleTimeString('en-AU',{hour:'2-digit',minute:'2-digit'}); }
  catch { return iso; }
}

let _toastTimer;
function showToast(msg, type='') {
  const t=document.getElementById('toast');
  t.textContent=msg; t.className='toast'+(type?' toast-'+type:''); t.classList.add('show');
  clearTimeout(_toastTimer); _toastTimer=setTimeout(()=>t.classList.remove('show'),3200);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function init() {
  loadSession();

  // Wire org modal
  document.getElementById('org-m-save').addEventListener('click', saveOrg);
  document.getElementById('org-m-cancel').addEventListener('click', closeOrgModal);
  document.getElementById('org-mclose').addEventListener('click', closeOrgModal);
  document.getElementById('org-m-del').addEventListener('click', deleteOrg);
  document.getElementById('org-modal').addEventListener('click', e => { if(e.target===document.getElementById('org-modal')) closeOrgModal(); });

  // Wire season modal
  document.getElementById('ss-m-save').addEventListener('click', saveSS);
  document.getElementById('ss-m-cancel').addEventListener('click', closeSSModal);
  document.getElementById('ss-mclose').addEventListener('click', closeSSModal);
  document.getElementById('ss-m-del').addEventListener('click', deleteSS);
  document.getElementById('ss-modal').addEventListener('click', e => { if(e.target===document.getElementById('ss-modal')) closeSSModal(); });

  // Wire contact log modal
  document.getElementById('cl-m-save').addEventListener('click', saveContactLog);
  document.getElementById('cl-m-cancel').addEventListener('click', closeContactLog);
  document.getElementById('cl-mclose').addEventListener('click', closeContactLog);
  document.getElementById('cl-modal').addEventListener('click', e => { if(e.target===document.getElementById('cl-modal')) closeContactLog(); });

  // Wire org detail overlay
  document.getElementById('od-close').addEventListener('click', closeOrgDetail);
  document.getElementById('org-detail-overlay').addEventListener('click', e => { if(e.target===document.getElementById('org-detail-overlay')) closeOrgDetail(); });

  // Wire season year modal
  document.getElementById('reset-modal').addEventListener('click', e => { if(e.target===document.getElementById('reset-modal')) closeResetModal(); });

  // Wire roles modal
  const _nri = document.getElementById('new-role-input');
  if (_nri) _nri.addEventListener('keydown', e => { if(e.key==='Enter') addCustomRole(); });
  const _rm = document.getElementById('roles-modal');
  if (_rm) _rm.addEventListener('click', e => { if(e.target===_rm) closeManageRoles(); });

  // Hide loading screen
  setTimeout(() => {
    const ls = document.getElementById('loading-screen');
    ls.classList.add('fade');
    setTimeout(() => { ls.style.display='none'; }, 500);
  }, 1200);

  if (token && me) {
    showApp();
  } else {
    document.getElementById('login-view').style.display='flex';
    initGoogleSignIn();
  }
}

document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>