<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>KJFC Exec Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@400;600;700;800;900&family=Barlow:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ROOT VARIABLES
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root{
  --green:        #013C1E;
  --green-mid:    #025a2d;
  --green-light:  #e6f0eb;
  --green-bright: #2e7d4f;
  --yellow:       #FBE201;
  --yellow-dark:  #c9b400;
  --yellow-pale:  #fffde6;
  --yellow-mid:   #fef083;
  --bg:           #f4f6f4;
  --card:         #ffffff;
  --text:         #1a1a1a;
  --text-mid:     #3a3a3a;
  --text-dim:     #6b7a6b;
  --border:       #d8e4d8;
  --border-s:     #adc4ad;
  --red:          #b91c1c;
  --red-light:    #fef2f2;
  --orange:       #c2720a;
  --orange-light: #fef6ec;
  --tg:#9a6700; --tgb:#fffaeb;
  --ts:#4a6070; --tsb:#f0f4f8;
  --tb:#7a4a28; --tbb:#fdf4ec;
  --tc:#013C1E; --tcb:#e6f0eb;
  --sh:  0 1px 4px rgba(0,0,0,0.07);
  --shm: 0 4px 18px rgba(0,0,0,0.11);
  --r:   11px;
  --safe-bottom: env(safe-area-inset-bottom, 0px);
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
html{scroll-behavior:smooth;}
body{background:var(--bg);color:var(--text);font-family:'Barlow',sans-serif;min-height:100vh;font-size:16px;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LOADING SCREEN
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#loading-screen{
  position:fixed;inset:0;z-index:1000;background:var(--green);
  display:flex;flex-direction:column;align-items:center;justify-content:center;gap:20px;
  transition:opacity .5s ease;
}
#loading-screen.fade{opacity:0;pointer-events:none;}
.ls-crest{
  width:80px;height:80px;background:var(--yellow);border-radius:50%;
  display:flex;align-items:center;justify-content:center;
  font-family:'Barlow Condensed',sans-serif;font-weight:900;font-size:24px;color:var(--green);
  animation:ls-pulse 1.8s ease-in-out infinite;
  box-shadow:0 0 0 0 rgba(251,226,1,0.5);
}
@keyframes ls-pulse{
  0%{box-shadow:0 0 0 0 rgba(251,226,1,0.5);transform:scale(1);}
  50%{box-shadow:0 0 0 18px rgba(251,226,1,0);transform:scale(1.06);}
  100%{box-shadow:0 0 0 0 rgba(251,226,1,0);transform:scale(1);}
}
.ls-text{
  font-family:'Barlow Condensed',sans-serif;font-size:15px;
  color:rgba(255,255,255,.55);text-transform:uppercase;letter-spacing:3px;
  animation:ls-blink 1.4s ease-in-out infinite;
}
@keyframes ls-blink{0%,100%{opacity:.4;}50%{opacity:1;}}
.ls-bar{width:160px;height:3px;background:rgba(255,255,255,.15);border-radius:2px;overflow:hidden;}
.ls-bar-fill{height:100%;width:0;background:var(--yellow);border-radius:2px;animation:ls-load 2s ease-in-out forwards;}
@keyframes ls-load{0%{width:0;}60%{width:75%;}90%{width:90%;}100%{width:100%;}}

/* Dashboard fade-in on load */
@keyframes dash-fadein{from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);}}
header{animation:dash-fadein .4s ease both;}
.sbar{animation:dash-fadein .4s ease .1s both;}
main{animation:dash-fadein .5s ease .15s both;}
.ls-spinner{width:28px;height:28px;border:3px solid rgba(255,255,255,.2);border-top-color:var(--yellow);border-radius:50%;animation:spin .8s linear infinite;}
@keyframes spin{to{transform:rotate(360deg);}}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LOGIN SCREEN
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#login-screen{
  position:fixed;inset:0;z-index:999;background:var(--green);
  display:none;align-items:center;justify-content:center;padding:20px;
  overflow-y:auto;
}
#login-screen.show{display:flex;}
.lwrap{display:flex;flex-direction:column;align-items:center;width:100%;max-width:400px;padding:20px 0;}
.lcrest{width:84px;height:84px;background:var(--yellow);border-radius:50%;display:flex;align-items:center;justify-content:center;font-family:'Barlow Condensed',sans-serif;font-weight:900;font-size:26px;color:var(--green);margin-bottom:14px;border:4px solid rgba(255,255,255,.35);box-shadow:0 4px 24px rgba(0,0,0,.3);}
.lclub{font-family:'Barlow Condensed',sans-serif;font-weight:900;font-size:20px;color:#fff;text-transform:uppercase;letter-spacing:1px;text-align:center;line-height:1.2;margin-bottom:3px;}
.ltag{font-size:11px;color:rgba(255,255,255,.55);letter-spacing:2.5px;text-transform:uppercase;margin-bottom:24px;}
.lbox{background:#fff;border-radius:16px;padding:28px 28px 22px;width:100%;box-shadow:0 8px 40px rgba(0,0,0,.22);}
.lbox h2{font-family:'Barlow Condensed',sans-serif;font-weight:900;font-size:18px;text-transform:uppercase;margin-bottom:3px;}
.lbox p{font-size:12px;color:var(--text-dim);margin-bottom:20px;line-height:1.5;}
.google-btn{
  width:100%;padding:13px 16px;border-radius:8px;border:1.5px solid var(--border);
  background:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:10px;
  font-size:14px;font-weight:600;color:var(--text);transition:all .15s;box-shadow:var(--sh);
}
.google-btn:hover{border-color:var(--border-s);box-shadow:var(--shm);}
.google-btn:active{transform:scale(.98);}
.google-icon{width:20px;height:20px;flex-shrink:0;}
.lerr{color:var(--red);font-size:12px;margin-top:10px;text-align:center;min-height:17px;line-height:1.4;}
.lfooter{margin-top:14px;font-size:11px;color:rgba(255,255,255,.4);text-align:center;line-height:1.5;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HEADER
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
header{
  background:var(--green);padding:0 16px;
  display:flex;align-items:center;justify-content:space-between;
  height:56px;position:sticky;top:0;z-index:100;
  box-shadow:0 2px 8px rgba(0,0,0,.18);
  padding-left:max(16px, env(safe-area-inset-left));
  padding-right:max(16px, env(safe-area-inset-right));
}
.logo-area{display:flex;align-items:center;gap:10px;min-width:0;}
.logo-badge{width:34px;height:34px;background:var(--yellow);border-radius:50%;display:flex;align-items:center;justify-content:center;font-family:'Barlow Condensed',sans-serif;font-weight:900;font-size:13px;color:var(--green);flex-shrink:0;}
.logo-text{min-width:0;}
.logo-text h1{font-family:'Barlow Condensed',sans-serif;font-weight:900;font-size:16px;text-transform:uppercase;letter-spacing:.4px;line-height:1.1;color:#fff;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.logo-text small{font-size:9px;color:rgba(255,255,255,.5);text-transform:uppercase;letter-spacing:1.5px;font-weight:600;display:none;}
.huser{display:flex;align-items:center;gap:8px;flex-shrink:0;}
.uchip{display:flex;align-items:center;gap:6px;background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.2);border-radius:16px;padding:3px 10px 3px 4px;cursor:pointer;transition:background .15s;max-width:160px;}
.uchip:hover{background:rgba(255,255,255,.2);}
.uav{width:24px;height:24px;border-radius:50%;overflow:hidden;flex-shrink:0;background:var(--yellow);display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:900;color:var(--green);font-family:'Barlow Condensed',sans-serif;}
.uav img{width:100%;height:100%;object-fit:cover;}
.uname{font-size:12px;font-weight:600;color:#fff;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.lobtn{background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.2);color:rgba(255,255,255,.8);padding:5px 10px;border-radius:5px;font-size:11px;cursor:pointer;transition:all .15s;font-weight:600;white-space:nowrap;}
.lobtn:hover{background:rgba(255,255,255,.22);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SEASON BAR
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.sbar{
  background:var(--yellow);
  padding:7px max(16px,env(safe-area-inset-left)) 7px max(16px,env(safe-area-inset-left));
  display:flex;align-items:center;gap:8px;border-bottom:2px solid var(--yellow-dark);
  overflow-x:auto;scrollbar-width:none;
}
.sbar::-webkit-scrollbar{display:none;}
.slabel{font-size:10px;font-weight:800;text-transform:uppercase;letter-spacing:1px;color:var(--green);opacity:.6;white-space:nowrap;flex-shrink:0;}
.stabs{display:flex;gap:3px;flex-shrink:0;}
.stab{padding:5px 12px;border-radius:4px;font-size:12px;font-weight:800;cursor:pointer;border:none;background:transparent;color:rgba(1,60,30,.5);transition:all .15s;font-family:'Barlow Condensed',sans-serif;letter-spacing:.5px;white-space:nowrap;}
.stab.act{background:var(--green);color:var(--yellow);}
.stab:hover:not(.act){background:rgba(1,60,30,.12);color:var(--green);}
.add-s-btn{padding:5px 10px;border-radius:4px;background:rgba(1,60,30,.12);border:1.5px solid rgba(1,60,30,.2);color:var(--green);font-size:10px;font-weight:800;cursor:pointer;transition:all .15s;font-family:'Barlow Condensed',sans-serif;text-transform:uppercase;white-space:nowrap;flex-shrink:0;}
.add-s-btn:hover{background:rgba(1,60,30,.22);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PAGE TABS (mobile: bottom nav)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.ptabs-top{display:flex;gap:4px;margin-bottom:14px;overflow-x:auto;scrollbar-width:none;padding-bottom:2px;}
.ptabs-top::-webkit-scrollbar{display:none;}
.access-opt{display:flex;align-items:flex-start;gap:10px;padding:10px 12px;border:1.5px solid var(--border);border-radius:8px;cursor:pointer;transition:all .15s;width:100%;box-sizing:border-box;overflow:hidden;}
.access-opt:has(input:checked){border-color:var(--green);background:var(--green-light);}
.access-opt input[type=radio]{margin-top:3px;accent-color:var(--green);flex-shrink:0;width:16px;height:16px;}
.access-opt-body{flex:1;min-width:0;overflow:hidden;}
.access-opt-title{font-weight:700;font-size:13px;color:var(--text);white-space:nowrap;}
.access-opt-desc{font-size:11px;color:var(--text-dim);margin-top:2px;line-height:1.4;word-wrap:break-word;}
.role-tag{display:flex;align-items:center;justify-content:space-between;padding:7px 10px;background:var(--bg);border:1.5px solid var(--border);border-radius:7px;font-size:13px;}
.role-tag-del{background:none;border:none;cursor:pointer;color:var(--text-dim);font-size:16px;line-height:1;padding:0 2px;}
.role-tag-del:hover{color:var(--red);}
.role-tag-default{font-size:10px;color:var(--text-dim);font-style:italic;}
.ptab-soon{opacity:.45;cursor:not-allowed!important;position:relative;}
.ptab-soon:hover{background:var(--card)!important;color:var(--text-dim)!important;border-color:var(--border)!important;}
.soon-badge{display:inline-block;font-size:8px;font-weight:800;background:var(--yellow);color:var(--green);border-radius:3px;padding:1px 4px;margin-left:5px;vertical-align:middle;text-transform:uppercase;letter-spacing:.5px;}
.ptab{padding:7px 14px;border-radius:6px;background:var(--card);color:var(--text-dim);border:1.5px solid var(--border);font-size:11px;font-weight:700;cursor:pointer;transition:all .15s;text-transform:uppercase;letter-spacing:.5px;white-space:nowrap;flex-shrink:0;}
.ptab.act{background:var(--green);color:#fff;border-color:var(--green);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MAIN CONTENT
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
main{
  padding:16px max(16px,env(safe-area-inset-right)) calc(16px + var(--safe-bottom)) max(16px,env(safe-area-inset-left));
  max-width:1440px;
}
.sh{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;gap:10px;}
.stitle{font-family:'Barlow Condensed',sans-serif;font-weight:900;font-size:24px;text-transform:uppercase;letter-spacing:1px;color:var(--text);}
.stitle span{color:var(--green);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SYNC STATUS BAR
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.sync-bar{display:flex;align-items:center;gap:8px;background:var(--card);border:1.5px solid var(--border);border-radius:8px;padding:8px 12px;margin-bottom:14px;font-size:12px;color:var(--text-dim);}
.sync-dot{width:8px;height:8px;border-radius:50%;background:var(--border-s);flex-shrink:0;}
.sync-dot.ok{background:var(--green-bright);}
.sync-dot.loading{background:var(--yellow-dark);animation:pulse 1s ease-in-out infinite;}
.sync-dot.err{background:var(--red);}
@keyframes pulse{0%,100%{opacity:1;}50%{opacity:.4;}}
.sync-refresh{margin-left:auto;padding:4px 10px;background:var(--green-light);border:1px solid var(--border-s);color:var(--green);border-radius:4px;font-size:11px;font-weight:700;cursor:pointer;transition:all .15s;}
.sync-refresh:hover{background:var(--green);color:#fff;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   KPI CARDS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.krow{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:14px;}
.kcard{background:var(--card);border:1.5px solid var(--border);border-radius:var(--r);padding:14px 16px;position:relative;overflow:hidden;box-shadow:var(--sh);cursor:pointer;transition:box-shadow .15s,transform .12s;-webkit-user-select:none;user-select:none;}
.kcard:hover{box-shadow:var(--shm);transform:translateY(-1px);}
.kcard:active{transform:scale(.98);}
.kcard::before{content:'';position:absolute;top:0;left:0;right:0;height:4px;}
.kcard.total::before{background:var(--yellow);}
.kcard.paid::before{background:var(--green);}
.kcard.out::before{background:var(--red);}
.kcard.cnt::before{background:var(--border-s);}
.kcard.cnt{cursor:default;}
.kcard.cnt:hover{box-shadow:var(--sh);transform:none;}
.kcard.cnt:active{transform:none;}
.klbl{font-size:9px;text-transform:uppercase;letter-spacing:1.5px;color:var(--text-dim);font-weight:700;margin-bottom:4px;}
.kval{font-family:'Barlow Condensed',sans-serif;font-size:28px;font-weight:900;line-height:1;}
.kcard.total .kval{color:var(--yellow-dark);}
.kcard.paid .kval{color:var(--green);}
.kcard.out .kval{color:var(--red);}
.ksub{font-size:10px;color:var(--text-dim);margin-top:3px;}
.klink{font-size:9px;color:var(--green);font-weight:700;margin-top:4px;text-decoration:underline;}
.ktrend{font-size:10px;font-weight:700;margin-top:3px;}
.ktrend.up{color:var(--green-bright);}
.ktrend.dn{color:var(--red);}
.pbtrack{height:4px;background:var(--bg);border-radius:3px;overflow:hidden;margin-top:7px;border:1px solid var(--border);}
.pbfill{height:100%;border-radius:3px;background:linear-gradient(90deg,var(--green),var(--green-bright));transition:width .8s;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DRILL PANEL
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.drill-panel{display:none;background:var(--card);border:1.5px solid var(--border);border-radius:var(--r);padding:16px;box-shadow:var(--sh);margin-bottom:14px;animation:slideDown .2s ease;}
.drill-panel.open{display:block;}
@keyframes slideDown{from{opacity:0;transform:translateY(-6px);}to{opacity:1;transform:translateY(0);}}
.drill-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;gap:10px;}
.drill-title{font-family:'Barlow Condensed',sans-serif;font-size:16px;font-weight:900;text-transform:uppercase;letter-spacing:.5px;line-height:1.2;}
.drill-close{background:var(--bg);border:1.5px solid var(--border);color:var(--text-dim);width:28px;height:28px;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:15px;flex-shrink:0;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PANELS & TWO-COL
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.panel{background:var(--card);border:1.5px solid var(--border);border-radius:var(--r);padding:16px;box-shadow:var(--sh);margin-bottom:14px;}
.twocol{display:grid;grid-template-columns:1fr;gap:14px;margin-bottom:14px;}
.ptitle{font-family:'Barlow Condensed',sans-serif;font-size:12px;font-weight:800;text-transform:uppercase;letter-spacing:1px;margin-bottom:12px;color:var(--text-dim);}
.ptitle span{color:var(--text);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   YEAR BARS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.ybargrp{margin-bottom:10px;cursor:pointer;}
.ybargrp:active .btrack{opacity:.8;}
.ybarlbl{display:flex;justify-content:space-between;font-size:11px;margin-bottom:3px;font-weight:600;}
.ybarlbl .yr{color:var(--text-dim);}
.btrack{height:22px;background:var(--bg);border-radius:4px;overflow:hidden;border:1px solid var(--border);}
.bfill{height:100%;border-radius:4px;transition:width .9s cubic-bezier(.4,0,.2,1);display:flex;align-items:center;padding-left:8px;font-size:10px;font-weight:700;}
.bfill.cur{background:var(--yellow);color:var(--green);}
.bfill.prev{background:var(--green);color:rgba(255,255,255,.85);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TIER LIST
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.tlist{display:flex;flex-direction:column;gap:6px;}
.trow{display:flex;align-items:center;gap:8px;padding:9px 10px;background:var(--bg);border-radius:6px;cursor:pointer;transition:all .15s;border:1.5px solid transparent;touch-action:pan-y;}
.trow:hover,.trow:active{background:var(--green-light);border-color:var(--border-s);}
.tdot{width:7px;height:7px;border-radius:50%;flex-shrink:0;}
.tdot.gold{background:var(--tg);}
.tdot.silver{background:var(--ts);}
.tdot.bronze{background:var(--tb);}
.tdot.community{background:var(--tc);}
.tname{font-weight:700;font-size:13px;flex:1;}
.tcnt{font-size:11px;color:var(--text-dim);}
.tamt{font-family:'Barlow Condensed',sans-serif;font-weight:900;font-size:14px;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TABLE (mobile: card-style rows)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.toolbar{display:flex;align-items:center;gap:6px;margin-bottom:10px;overflow-x:auto;scrollbar-width:none;padding-bottom:2px;}
.toolbar::-webkit-scrollbar{display:none;}
.fbtn{padding:5px 11px;border-radius:5px;background:var(--bg);color:var(--text-dim);border:1.5px solid var(--border);font-size:11px;font-weight:700;cursor:pointer;transition:all .15s;text-transform:uppercase;letter-spacing:.4px;white-space:nowrap;flex-shrink:0;}
.fbtn:hover,.fbtn.act{background:var(--green);color:#fff;border-color:var(--green);}
.abtn{margin-left:auto;padding:7px 14px;border-radius:6px;background:var(--yellow);color:var(--green);border:none;font-size:12px;font-weight:900;cursor:pointer;transition:all .15s;text-transform:uppercase;letter-spacing:.4px;font-family:'Barlow Condensed',sans-serif;box-shadow:var(--sh);white-space:nowrap;flex-shrink:0;}
.abtn:hover{background:var(--yellow-mid);}
.abtn:active{transform:scale(.97);}

/* Desktop table */
.stw{overflow-x:auto;-webkit-overflow-scrolling:touch;}
table{width:100%;border-collapse:collapse;font-size:13px;}
thead th{text-align:left;padding:8px 10px;font-size:9px;text-transform:uppercase;letter-spacing:1.2px;color:var(--text-dim);font-weight:700;border-bottom:2px solid var(--border);white-space:nowrap;}
tbody tr{border-bottom:1px solid var(--border);cursor:pointer;transition:background .1s;}
tbody tr:hover{background:var(--green-light);}
td{padding:10px 10px;vertical-align:middle;}

/* Mobile sponsor cards */
.sponsor-cards{display:none;flex-direction:column;gap:8px;}
.scard{background:var(--card);border:1.5px solid var(--border);border-radius:9px;padding:14px;cursor:pointer;transition:all .15s;box-shadow:var(--sh);}
.scard:hover{border-color:var(--border-s);box-shadow:var(--shm);}
.scard:active{transform:scale(.99);}
.scard-top{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:8px;gap:8px;}
.scard-name{font-weight:700;font-size:15px;line-height:1.2;}
.scard-amount{font-family:'Barlow Condensed',sans-serif;font-weight:900;font-size:18px;color:var(--text);text-align:right;flex-shrink:0;}
.scard-recv{font-size:10px;color:var(--orange);text-align:right;}
.scard-meta{display:flex;align-items:center;gap:6px;flex-wrap:wrap;}
.scard-edit{margin-left:auto;padding:5px 10px;border-radius:5px;background:var(--bg);border:1.5px solid var(--border);color:var(--text-dim);font-size:11px;font-weight:700;cursor:pointer;}

/* Badges */
.sbadge{display:inline-block;padding:2px 7px;border-radius:20px;font-size:9px;font-weight:800;text-transform:uppercase;letter-spacing:.4px;}
.sbadge.paid{background:var(--green-light);color:var(--green);}
.sbadge.outstanding{background:var(--red-light);color:var(--red);}
.sbadge.partial{background:var(--orange-light);color:var(--orange);}
.tchip{display:inline-flex;align-items:center;padding:2px 6px;border-radius:4px;font-size:10px;font-weight:700;}
.tchip.gold{background:var(--tgb);color:var(--tg);}
.tchip.silver{background:var(--tsb);color:var(--ts);}
.tchip.bronze{background:var(--tbb);color:var(--tb);}
.tchip.community{background:var(--tcb);color:var(--tc);}
.cbadge{display:inline-flex;align-items:center;gap:3px;background:var(--yellow-pale);border:1.5px solid var(--yellow-dark);color:var(--yellow-dark);font-size:9px;font-weight:800;padding:1px 6px;border-radius:10px;}
.actbtn{background:var(--bg);border:1.5px solid var(--border);color:var(--text);padding:3px 9px;border-radius:4px;font-size:11px;cursor:pointer;font-weight:700;transition:all .15s;}
.actbtn:hover{background:var(--green);color:#fff;border-color:var(--green);}

.empty{text-align:center;padding:40px 16px;color:var(--text-dim);}
.empty .icon{font-size:32px;margin-bottom:8px;}
.empty h3{font-size:14px;color:var(--text);margin-bottom:4px;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DETAIL VIEW
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.detailview{display:none;}
.detailview.open{display:block;}
.mainview.h{display:none;}
.backbtn{display:inline-flex;align-items:center;gap:6px;background:var(--green-light);border:1.5px solid var(--border-s);color:var(--green);font-size:12px;font-weight:700;cursor:pointer;margin-bottom:14px;padding:8px 13px;border-radius:6px;text-transform:uppercase;letter-spacing:.5px;}
.backbtn:active{transform:scale(.97);}
.dheader{display:flex;align-items:flex-start;gap:14px;margin-bottom:16px;flex-wrap:wrap;}
.dlogo{width:56px;height:56px;border-radius:8px;background:var(--yellow-pale);display:flex;align-items:center;justify-content:center;font-family:'Barlow Condensed',sans-serif;font-size:20px;font-weight:900;color:var(--yellow-dark);flex-shrink:0;border:2px solid var(--yellow-dark);}
.dinfo{flex:1;min-width:0;}
.dinfo h2{font-family:'Barlow Condensed',sans-serif;font-size:24px;font-weight:900;line-height:1;text-transform:uppercase;}
.dmeta{display:flex;gap:6px;margin-top:6px;flex-wrap:wrap;}
.dkpis{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:13px;}
.dkpi{background:var(--bg);border:1.5px solid var(--border);border-radius:8px;padding:12px 13px;}
.ystrip{display:flex;gap:5px;flex-wrap:wrap;margin-bottom:13px;}
.ypill{display:flex;align-items:center;gap:4px;background:var(--bg);border:1.5px solid var(--border);border-radius:4px;padding:4px 8px;font-size:10px;font-weight:700;color:var(--text-dim);}
.ypill.has{border-color:var(--green);color:var(--green);background:var(--green-light);}
.ydot{width:5px;height:5px;border-radius:50%;background:var(--border-s);}
.ypill.has .ydot{background:var(--green);}
.alog{background:var(--bg);border:1.5px solid var(--border);border-radius:8px;padding:14px;margin-bottom:13px;}
.alog h3{font-size:9px;text-transform:uppercase;letter-spacing:1.2px;color:var(--text-dim);margin-bottom:10px;font-weight:700;}
.aentry{display:flex;align-items:flex-start;gap:8px;padding:6px 0;border-bottom:1px solid var(--border);}
.aentry:last-child{border-bottom:none;}
.adot{width:7px;height:7px;border-radius:50%;flex-shrink:0;margin-top:4px;}
.adot.edit{background:var(--yellow-dark);}
.adot.del{background:var(--red);}
.adot.add{background:var(--green);}
.aact{font-size:12px;font-weight:600;line-height:1.4;}
.amet{font-size:10px;color:var(--text-dim);margin-top:1px;}
.aempty{font-size:12px;color:var(--text-dim);font-style:italic;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MODALS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.moverlay{
  display:none;position:fixed;inset:0;z-index:200;
  background:rgba(0,0,0,.5);
  align-items:flex-end;justify-content:center;
  padding:0;
}
.moverlay.open{display:flex;}
.modal{
  background:var(--card);border:1.5px solid var(--border);
  border-radius:16px 16px 0 0;
  width:100%;max-width:100%;
  padding:20px 20px calc(20px + var(--safe-bottom));
  position:relative;max-height:92vh;overflow-y:auto;
  animation:slideUp .25s cubic-bezier(.4,0,.2,1);
}
@keyframes slideUp{from{transform:translateY(100%);}to{transform:translateY(0);}}
.modal-handle{width:36px;height:4px;background:var(--border-s);border-radius:2px;margin:0 auto 16px;display:block;}
.mclose{position:absolute;top:16px;right:16px;background:var(--bg);border:1px solid var(--border);color:var(--text);width:30px;height:30px;border-radius:50%;font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center;}
.mtitle{font-family:'Barlow Condensed',sans-serif;font-size:20px;font-weight:900;margin-bottom:2px;text-transform:uppercase;}
.msub{color:var(--text-dim);font-size:12px;margin-bottom:16px;line-height:1.4;}
.frow{display:grid;grid-template-columns:1fr;gap:10px;margin-bottom:10px;}
.frow.two{grid-template-columns:1fr 1fr;}
.frow.full{grid-template-columns:1fr;}
.fg{display:flex;flex-direction:column;gap:4px;}
.fg label{font-size:10px;text-transform:uppercase;letter-spacing:1px;color:var(--text-dim);font-weight:700;}
.fg input,.fg select,.fg textarea{background:#f7faf7;border:1.5px solid var(--border);color:var(--text);padding:11px 12px;border-radius:7px;font-size:15px;font-family:'Barlow',sans-serif;transition:border-color .15s;width:100%;-webkit-appearance:none;}
.fg input:focus,.fg select:focus,.fg textarea:focus{outline:none;border-color:var(--green);background:#fff;}
.fg textarea{resize:vertical;min-height:70px;}
.mactions{display:flex;gap:8px;margin-top:16px;flex-wrap:wrap;}
.mprimary{flex:1;padding:13px;background:var(--green);color:#fff;border:none;border-radius:8px;font-size:15px;font-weight:900;cursor:pointer;font-family:'Barlow Condensed',sans-serif;text-transform:uppercase;letter-spacing:.5px;min-width:120px;}
.mprimary:active{transform:scale(.97);}
.msecondary{padding:13px 16px;background:var(--bg);color:var(--text-dim);border:1.5px solid var(--border);border-radius:8px;font-size:13px;cursor:pointer;font-weight:600;}
.mdanger{padding:13px 14px;background:var(--red-light);color:var(--red);border:1.5px solid #f5c6c2;border-radius:8px;font-size:13px;cursor:pointer;font-weight:700;}

/* Copy from prev */
.copy-prev-wrap{background:var(--green-light);border:1.5px solid var(--border-s);border-radius:8px;padding:11px 13px;margin-bottom:12px;}
.copy-prev-wrap label{font-size:10px;text-transform:uppercase;letter-spacing:1px;color:var(--green);font-weight:800;display:block;margin-bottom:6px;}
.copy-prev-row{display:flex;gap:8px;align-items:center;}
.copy-prev-row select{flex:1;background:#fff;border:1.5px solid var(--border-s);color:var(--text);padding:9px 10px;border-radius:6px;font-size:13px;font-family:'Barlow',sans-serif;-webkit-appearance:none;}
.cbtn{padding:9px 12px;background:var(--green);color:#fff;border:none;border-radius:6px;font-size:12px;font-weight:800;cursor:pointer;font-family:'Barlow Condensed',sans-serif;text-transform:uppercase;white-space:nowrap;}

/* Season mini modal */
.smodal-inner{background:var(--card);border-radius:14px;padding:24px;width:100%;max-width:360px;box-shadow:var(--shm);border:1.5px solid var(--border);margin:auto;}
#season-modal .moverlay-center{align-items:center;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ACCESS LOG
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.atable{width:100%;border-collapse:collapse;font-size:12px;}
.atable th{text-align:left;padding:8px 9px;font-size:9px;text-transform:uppercase;letter-spacing:1.2px;color:var(--text-dim);font-weight:700;border-bottom:2px solid var(--border);}
.atable td{padding:8px 9px;border-bottom:1px solid var(--border);}
.atable tr:last-child td{border-bottom:none;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   USER MANAGEMENT
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.user-grid{display:grid;grid-template-columns:1fr;gap:10px;margin-bottom:14px;}
.ucard{background:var(--card);border:1.5px solid var(--border);border-radius:var(--r);padding:14px;box-shadow:var(--sh);}
.ucard-head{display:flex;align-items:center;gap:10px;margin-bottom:9px;}
.ucard-av{width:38px;height:38px;border-radius:50%;background:var(--green);display:flex;align-items:center;justify-content:center;font-family:'Barlow Condensed',sans-serif;font-weight:900;font-size:15px;color:var(--yellow);flex-shrink:0;overflow:hidden;}
.ucard-av img{width:100%;height:100%;object-fit:cover;}
.ucard-name{font-weight:700;font-size:14px;}
.ucard-role{font-size:11px;color:var(--text-dim);}
.ucard-badges{display:flex;gap:5px;margin-bottom:9px;flex-wrap:wrap;}
.ubadge{font-size:9px;font-weight:800;padding:2px 7px;border-radius:10px;text-transform:uppercase;letter-spacing:.4px;}
.ubadge.admin{background:var(--yellow-pale);color:var(--yellow-dark);border:1px solid var(--yellow-dark);}
.ubadge.edit{background:var(--green-light);color:var(--green);border:1px solid var(--border-s);}
.ubadge.view{background:var(--bg);color:var(--text-dim);border:1px solid var(--border);}
.ucard-actions{display:flex;gap:6px;flex-wrap:wrap;}
.uact-btn{padding:6px 10px;border-radius:5px;font-size:11px;font-weight:700;cursor:pointer;border:1.5px solid var(--border);background:var(--bg);color:var(--text-mid);transition:all .15s;}
.uact-btn:hover{background:var(--green);color:#fff;border-color:var(--green);}

/* Profile */
.profile-av-row{display:flex;align-items:center;gap:12px;margin-bottom:14px;}
.profile-av{width:52px;height:52px;border-radius:50%;background:var(--green);display:flex;align-items:center;justify-content:center;font-family:'Barlow Condensed',sans-serif;font-weight:900;font-size:20px;color:var(--yellow);overflow:hidden;}
.profile-av img{width:100%;height:100%;object-fit:cover;}
.profile-info strong{font-size:15px;display:block;}
.profile-info span{font-size:12px;color:var(--text-dim);}
.profile-badges{display:flex;gap:5px;margin-top:4px;flex-wrap:wrap;}
.profile-sec{margin-bottom:18px;padding-bottom:18px;border-bottom:1px solid var(--border);}
.profile-sec:last-child{border-bottom:none;margin-bottom:0;padding-bottom:0;}
.profile-sec h3{font-family:'Barlow Condensed',sans-serif;font-size:14px;font-weight:800;text-transform:uppercase;letter-spacing:.4px;color:var(--text);margin-bottom:11px;}
.msg-ok{background:var(--green-light);border:1px solid var(--border-s);color:var(--green);padding:7px 10px;border-radius:6px;font-size:12px;font-weight:600;margin-top:7px;display:none;}
.msg-err{background:var(--red-light);border:1px solid #f5c6c2;color:var(--red);padding:7px 10px;border-radius:6px;font-size:12px;font-weight:600;margin-top:7px;display:none;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOAST
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.toast{
  position:fixed;bottom:calc(20px + var(--safe-bottom));left:50%;
  transform:translateX(-50%) translateY(80px);
  z-index:400;background:var(--green);color:#fff;
  padding:11px 20px;border-radius:24px;
  font-weight:800;font-size:13px;
  opacity:0;transition:all .3s;
  font-family:'Barlow Condensed',sans-serif;text-transform:uppercase;
  letter-spacing:.5px;box-shadow:var(--shm);white-space:nowrap;
}
.toast.show{transform:translateX(-50%) translateY(0);opacity:1;}
.toast.warn{background:var(--orange);}
.toast.err{background:var(--red);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESPONSIVE â€” TABLET (600px+)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media(min-width:600px){
  main{padding:20px 24px;max-width:1200px;margin:0 auto;}
  header{height:60px;padding:0 24px;}
  .logo-text small{display:block;}
  .krow{grid-template-columns:repeat(4,1fr);}
  .kval{font-size:30px;}
  .stitle{font-size:26px;}
  .frow{grid-template-columns:1fr 1fr;}
  .frow.full{grid-template-columns:1fr;}
  .moverlay{align-items:center;padding:20px;}
  .modal{border-radius:14px;max-width:560px;animation:modalIn .2s ease;padding:24px;}
  @keyframes modalIn{from{opacity:0;transform:scale(.95);}to{opacity:1;transform:scale(1);}}
  .modal-handle{display:none;}
  .stw table{display:table;}
  .sponsor-cards{display:none!important;}
  .user-grid{grid-template-columns:repeat(auto-fill,minmax(260px,1fr));}
  .twocol{grid-template-columns:1fr 280px;}
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESPONSIVE â€” DESKTOP (960px+)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media(min-width:960px){
  main{padding:22px 28px;max-width:1200px;margin:0 auto;}
  header{padding:0 28px;}
  .logo-text h1{font-size:17px;}
  .kval{font-size:33px;}
  .stitle{font-size:28px;}
  .twocol{grid-template-columns:1fr 295px;}
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MOBILE: hide table, show cards
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media(max-width:599px){
  .stw table{display:none;}
  .sponsor-cards{display:flex;}
  .dkpis{grid-template-columns:1fr 1fr 1fr;}
  .dkpi{padding:10px 11px;}
  .dinfo h2{font-size:20px;}
}
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â• LOADING â•â•â•â•â•â•â•â• -->
<div id="loading-screen">
  <div class="ls-crest" style="font-size:18px;">KJFC</div>
  <div class="ls-text">Loadingâ€¦</div>
  <div class="ls-spinner"></div>
</div>

<!-- â•â•â•â•â•â•â•â• LOGIN â•â•â•â•â•â•â•â• -->
<div id="login-screen">
  <div class="lwrap">
    <div class="lcrest">KJFC</div>
    <div class="lclub">Kinglake Junior<br>Football Club</div>
    <div class="ltag">Exec Dashboard</div>
    <div class="lbox">
      <h2>Sign In</h2>
      <p>Use your approved Google account to access the executive dashboard.</p>
      <div id="google-btn-container" style="display:flex;justify-content:center;min-height:44px;width:100%;"></div>
      <button class="google-btn" id="google-sign-in-btn" style="display:none">Continue with Google</button>
      <div class="lerr" id="lerr"></div>
    </div>
    <div class="lfooter">Access is restricted to approved club members.<br>Sign-ins are recorded in the activity log.</div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â• APP â•â•â•â•â•â•â•â• -->
<header>
  <div class="logo-area">
    <div class="logo-badge" style="font-size:11px;">KJFC</div>
    <div class="logo-text">
      <h1>Kinglake JFC</h1>
      <small>Exec Dashboard</small>
    </div>
  </div>
  <div class="huser">
    <div class="uchip" onclick="openProfile()">
      <div class="uav" id="uav"><span id="uav-init">?</span></div>
      <div class="uname" id="uname">â€”</div>
    </div>
    <button class="lobtn" onclick="doLogout()">Sign Out</button>
  </div>
</header>

<!-- SEASON BAR -->
<div class="sbar">
  <span class="slabel">Season:</span>
  <div class="stabs" id="stabs"></div>
  <button class="add-s-btn" id="addseasbtn" onclick="openSeasonModal()" style="display:none">+ Season</button>
</div>

<main>
  <!-- PAGE TABS -->
  <div class="ptabs-top" id="ptabs">
    <button class="ptab act" onclick="setTab('overview',this)">Overview</button>
    <button class="ptab" id="tab-access-btn" onclick="setTab('access',this)" style="display:none">Access Log</button>
    <button class="ptab" id="tab-users-btn" onclick="setTab('users',this)" style="display:none">Users</button>
    <button class="ptab ptab-soon" disabled title="Coming soon">Players <span class="soon-badge">Soon</span></button>
    <button class="ptab ptab-soon" disabled title="Coming soon">Finance <span class="soon-badge">Soon</span></button>
  </div>

  <!-- SYNC STATUS -->
  <div class="sync-bar" id="sync-bar">
    <div class="sync-dot loading" id="sync-dot"></div>
    <span id="sync-text">Connecting to Google Sheetsâ€¦</span>
    <button class="sync-refresh" onclick="loadAll()">â†» Refresh</button>
  </div>

  <!-- â•â• OVERVIEW â•â• -->
  <div id="tab-overview">
    <div class="mainview" id="mainView">
      <div class="sh">
        <h2 class="stitle">Sponsorship <span id="season-span">Overview</span></h2>
        <button class="abtn" id="add-btn" onclick="openAdd()" style="display:none">+ Add Sponsor</button>
      </div>

      <div class="krow">
        <div class="kcard total" onclick="drillTotal()">
          <div class="klbl">Total Committed</div>
          <div class="kval" id="k-total">â€”</div>
          <div class="ksub" id="k-count"></div>
          <div class="ktrend" id="k-trend"></div>
          <div class="klink">View all â†’</div>
        </div>
        <div class="kcard paid" onclick="drillPaid()">
          <div class="klbl">Received</div>
          <div class="kval" id="k-paid">â€”</div>
          <div class="ksub" id="k-ppct"></div>
          <div class="pbtrack"><div class="pbfill" id="k-bar" style="width:0%"></div></div>
          <div class="klink">Paid &amp; partial â†’</div>
        </div>
        <div class="kcard out" onclick="drillOut()">
          <div class="klbl">Outstanding</div>
          <div class="kval" id="k-out">â€”</div>
          <div class="ksub" id="k-outc"></div>
          <div class="klink">View outstanding â†’</div>
        </div>
        <div class="kcard cnt">
          <div class="klbl">By Tier</div>
          <div id="tier-mini" style="display:flex;flex-direction:column;gap:5px;margin-top:7px;"></div>
        </div>
      </div>

      <!-- DRILL PANEL -->
      <div class="drill-panel" id="drillPanel">
        <div class="drill-header">
          <div class="drill-title" id="drillTitle">Sponsors</div>
          <button class="drill-close" onclick="closeDrill()">Ã—</button>
        </div>
        <div class="stw">
          <table>
            <thead><tr><th>Sponsor</th><th>Tier</th><th>Amount</th><th>Status</th><th>Contact</th></tr></thead>
            <tbody id="drill-body"></tbody>
          </table>
          <div class="sponsor-cards" id="drill-cards"></div>
        </div>
      </div>

      <div class="twocol">
        <div class="panel">
          <div class="ptitle"><span>Year-on-Year</span> Comparison <span style="font-size:10px;font-weight:500;text-transform:none;letter-spacing:0;color:var(--text-dim)">(tap to switch season)</span></div>
          <div id="year-bars"></div>
        </div>
        <div class="panel">
          <div class="ptitle"><span>Revenue</span> by Tier</div>
          <div class="tlist" id="tier-list"></div>
        </div>
      </div>

      <div class="panel">
        <div class="toolbar">
          <button class="fbtn act" onclick="filterTable('all',this)">All</button>
          <button class="fbtn" onclick="filterTable('gold',this)">Gold</button>
          <button class="fbtn" onclick="filterTable('silver',this)">Silver</button>
          <button class="fbtn" onclick="filterTable('bronze',this)">Bronze</button>
          <button class="fbtn" onclick="filterTable('community',this)">Community</button>
          <button class="fbtn" onclick="filterTable('outstanding',this)">âš  Owing</button>
        </div>
        <!-- Desktop table -->
        <div class="stw">
          <table>
            <thead><tr><th>Sponsor</th><th>Tier</th><th>Amount</th><th>Status</th><th>Yrs</th><th>Contact</th><th></th></tr></thead>
            <tbody id="tbl-body"></tbody>
          </table>
        </div>
        <!-- Mobile cards -->
        <div class="sponsor-cards" id="sponsor-cards"></div>
        <div class="empty" id="tbl-empty" style="display:none">
          <div class="icon">ğŸ†</div>
          <h3>No sponsors yet</h3>
          <p>Tap "+ Add Sponsor" to get started.</p>
        </div>
      </div>
    </div>

    <div class="detailview" id="detailView">
      <button class="backbtn" onclick="closeDetail()">â† Back</button>
      <div id="detail-content"></div>
    </div>
  </div>

  <!-- â•â• ACCESS LOG â•â• -->
  <div id="tab-access" style="display:none">
    <div class="panel">
      <div style="margin-bottom:12px">
        <div style="font-family:'Barlow Condensed',sans-serif;font-size:18px;font-weight:900;text-transform:uppercase;margin-bottom:3px">Access &amp; Activity Log</div>
        <div style="font-size:12px;color:var(--text-dim)">All sign-ins and data changes are recorded in Google Sheets.</div>
      </div>
      <div style="overflow-x:auto;-webkit-overflow-scrolling:touch;">
        <table class="atable">
          <thead><tr><th>Date &amp; Time</th><th>User</th><th>Role</th><th>Action</th><th>Details</th></tr></thead>
          <tbody id="log-body"></tbody>
        </table>
        <div id="log-empty" style="display:none;padding:24px;text-align:center;color:var(--text-dim);font-size:13px">No activity logged yet.</div>
      </div>
    </div>
  </div>

  <!-- â•â• USERS â•â• -->
  <div id="tab-users" style="display:none">
    <div class="sh" style="margin-bottom:12px">
      <div style="font-family:'Barlow Condensed',sans-serif;font-size:20px;font-weight:900;text-transform:uppercase">Users</div>
    </div>
    <div style="background:var(--orange-light);border:1.5px solid var(--orange);border-radius:8px;padding:12px 14px;margin-bottom:14px;font-size:12px;line-height:1.5;">
      <strong>âš  To add or remove users:</strong> Edit <code>ALLOWED_EMAILS</code> and <code>PERMISSIONS</code> in <code>Code.gs</code> in Google Apps Script, then re-deploy. This keeps access control in your version-controlled code rather than the spreadsheet.
    </div>
    <div class="user-grid" id="user-grid"></div>
  </div>
</main>

<!-- â•â•â•â•â•â•â•â• SPONSOR MODAL â•â•â•â•â•â•â•â• -->
<div class="moverlay" id="sponsor-modal">
  <div class="modal">
    <div class="modal-handle"></div>
    <button class="mclose" id="mclose-btn">Ã—</button>
    <div class="mtitle" id="m-title">Add Sponsor</div>
    <div class="msub" id="m-sub">New entry for this season.</div>

    <div class="copy-prev-wrap" id="copy-prev-wrap">
      <label>ğŸ“‹ Copy from a previous season</label>
      <div class="copy-prev-row">
        <select id="copy-prev-select"><option value="">â€” Select past sponsor â€”</option></select>
        <button class="cbtn" onclick="copyFromPrev()">Copy</button>
      </div>
    </div>

    <div class="frow two">
      <div class="fg"><label>Sponsor Name *</label><input type="text" id="f-name" placeholder="Business name" autocomplete="organization"></div>
      <div class="fg"><label>Tier *</label>
        <select id="f-tier">
          <option value="">Select tier</option>
          <option value="gold">Gold</option>
          <option value="silver">Silver</option>
          <option value="bronze">Bronze</option>
          <option value="community">Community</option>
        </select>
      </div>
    </div>
    <div class="frow two">
      <div class="fg"><label>Season</label><select id="f-year"></select></div>
      <div class="fg"><label>Amount ($) *</label><input type="number" id="f-amount" placeholder="2000" min="0" inputmode="numeric"></div>
    </div>
    <div class="frow two">
      <div class="fg"><label>Payment Status *</label>
        <select id="f-status">
          <option value="">Select status</option>
          <option value="paid">Paid</option>
          <option value="outstanding">Outstanding</option>
          <option value="partial">Partial</option>
        </select>
      </div>
      <div class="fg" id="f-partial-wrap" style="display:none">
        <label>Amount Received ($)</label>
        <input type="number" id="f-paid" placeholder="500" min="0" inputmode="numeric">
      </div>
    </div>
    <div class="frow two">
      <div class="fg"><label>Contact Name</label><input type="text" id="f-contact" placeholder="Name" autocomplete="name"></div>
      <div class="fg"><label>Contact Email</label><input type="email" id="f-email" placeholder="email@biz.com.au" autocomplete="email" inputmode="email"></div>
    </div>
    <div class="frow two">
      <div class="fg"><label>Phone</label><input type="tel" id="f-phone" placeholder="04xx xxx xxx" autocomplete="tel" inputmode="tel"></div>
      <div class="fg"><label>Website</label><input type="text" id="f-website" placeholder="www.example.com.au" inputmode="url"></div>
    </div>
    <div class="frow full">
      <div class="fg"><label>Notes / Benefits</label><textarea id="f-notes" placeholder="Signage, social posts, PA announcementsâ€¦"></textarea></div>
    </div>
    <div class="mactions">
      <button class="mprimary" id="m-save">Add Sponsor</button>
      <button class="msecondary" id="m-cancel">Cancel</button>
      <button class="mdanger" id="m-del" style="display:none">Delete</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â• SEASON MODAL â•â•â•â•â•â•â•â• -->
<div class="moverlay" id="season-modal" style="align-items:center;padding:20px;">
  <div class="smodal-inner">
    <div style="font-family:'Barlow Condensed',sans-serif;font-size:18px;font-weight:900;text-transform:uppercase;margin-bottom:4px">Add Season</div>
    <div style="font-size:12px;color:var(--text-dim);margin-bottom:16px;line-height:1.4">Create a new season. All historical data remains intact.</div>
    <div class="fg" style="margin-bottom:14px">
      <label>Season Year</label>
      <input type="number" id="new-season-yr" placeholder="e.g. 2027" min="2020" max="2045" inputmode="numeric">
    </div>
    <div style="display:flex;gap:8px">
      <button class="mprimary" onclick="confirmAddSeason()">Add Season</button>
      <button class="msecondary" onclick="closeSeasonModal()">Cancel</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â• PROFILE MODAL â•â•â•â•â•â•â•â• -->
<div class="moverlay" id="profile-modal">
  <div class="modal">
    <div class="modal-handle"></div>
    <button class="mclose" onclick="closeProfileModal()">Ã—</button>
    <div class="mtitle">My Profile</div>
    <div class="msub">Manage your account.</div>

    <div class="profile-sec">
      <div class="profile-av-row">
        <div class="profile-av" id="prof-av"><span id="prof-av-init">?</span></div>
        <div class="profile-info">
          <strong id="prof-name">â€”</strong>
          <span id="prof-email">â€”</span>
          <div class="profile-badges" id="prof-badges"></div>
        </div>
      </div>
      <p style="font-size:12px;color:var(--text-dim);line-height:1.5">Your account is managed via Google Sign-In. To change your name or profile picture, update your Google account.</p>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â• EDIT USER MODAL â•â•â•â•â•â•â•â• -->
<div class="moverlay" id="reset-modal" style="align-items:center;padding:20px;">
  <div class="smodal-inner" style="max-width:420px;width:100%;overflow:hidden;">
    <div style="font-family:'Barlow Condensed',sans-serif;font-size:18px;font-weight:900;text-transform:uppercase;margin-bottom:4px">Edit User</div>
    <div class="msub" id="reset-sub">Update display name, role and access level.</div>
    <input type="hidden" id="reset-email">

    <div class="fg" style="margin-bottom:10px">
      <label>Display Name</label>
      <input type="text" id="reset-name" placeholder="Display name">
    </div>

    <div class="fg" style="margin-bottom:10px">
      <label>Role</label>
      <div style="display:flex;gap:6px;">
        <select id="reset-role" style="flex:1;padding:9px 12px;border:1.5px solid var(--border);border-radius:8px;font-size:14px;font-family:'Barlow',sans-serif;background:var(--bg);color:var(--text);cursor:pointer;"></select>
        <button onclick="openManageRoles()" style="padding:8px 10px;border:1.5px solid var(--border);border-radius:8px;background:var(--bg);cursor:pointer;font-size:13px;color:var(--text-dim);white-space:nowrap;" title="Manage role list">âš™ Roles</button>
      </div>
    </div>

    <div class="fg" style="margin-bottom:14px">
      <label>Access Level</label>
      <div style="display:flex;flex-direction:column;gap:7px;margin-top:4px;width:100%;overflow:hidden;" id="access-level-group">
        <label class="access-opt" id="opt-admin">
          <input type="radio" name="access-level" value="admin">
          <div class="access-opt-body">
            <div class="access-opt-title">Admin</div>
            <div class="access-opt-desc">Full access â€” manage users, seasons, access log & all sponsor data</div>
          </div>
        </label>
        <label class="access-opt" id="opt-edit">
          <input type="radio" name="access-level" value="edit">
          <div class="access-opt-body">
            <div class="access-opt-title">Can Edit</div>
            <div class="access-opt-desc">Add, edit and delete sponsors. Cannot manage users or view logs.</div>
          </div>
        </label>
        <label class="access-opt" id="opt-readonly">
          <input type="radio" name="access-level" value="readonly">
          <div class="access-opt-body">
            <div class="access-opt-title">Read Only</div>
            <div class="access-opt-desc">View dashboard only. Cannot make any changes.</div>
          </div>
        </label>
      </div>
      <div style="margin-top:8px;font-size:11px;color:var(--text-dim);line-height:1.4;">
        âš  Access level changes take effect after updating <code>PERMISSIONS</code> in Code.gs and re-deploying.
      </div>
    </div>

    <div class="msg-ok" id="reset-ok">Saved successfully.</div>
    <div class="msg-err" id="reset-err">Something went wrong.</div>
    <div style="display:flex;gap:8px;margin-top:12px">
      <button class="mprimary" onclick="confirmEditUser()">Save</button>
      <button class="msecondary" onclick="closeResetModal()">Cancel</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â• MANAGE ROLES MODAL â•â•â•â•â•â•â•â• -->
<div class="moverlay" id="roles-modal" style="align-items:center;padding:20px;">
  <div class="smodal-inner" style="max-width:360px;width:100%;">
    <div style="font-family:'Barlow Condensed',sans-serif;font-size:18px;font-weight:900;text-transform:uppercase;margin-bottom:4px">Manage Roles</div>
    <div class="msub">Add or remove roles from the dropdown list.</div>
    <div id="roles-list" style="margin:12px 0;display:flex;flex-direction:column;gap:6px;max-height:240px;overflow-y:auto;"></div>
    <div style="display:flex;gap:6px;margin-bottom:12px;">
      <input type="text" id="new-role-input" placeholder="New role nameâ€¦" style="flex:1;padding:8px 10px;border:1.5px solid var(--border);border-radius:8px;font-size:13px;font-family:'Barlow',sans-serif;">
      <button class="mprimary" onclick="addCustomRole()" style="padding:8px 14px;">Add</button>
    </div>
    <button class="msecondary" onclick="closeManageRoles()" style="width:100%;">Done</button>
  </div>
</div>

<div class="toast" id="toast"></div>

<!-- Google Identity Services -->
<script src="https://accounts.google.com/gsi/client" async defer></script>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONFIG â€” REPLACE THESE TWO VALUES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const GOOGLE_CLIENT_ID = '127701976947-881utr0ljs1eqrfmuoqrsbqh5635vtfl.apps.googleusercontent.com';
const APPS_SCRIPT_URL  = 'https://script.google.com/macros/s/AKfycbwKC6PhkqKzd0wBXUr7ZtpNN642og-5GbR_qmaT0tY1A3u_zOQCpt0TT94xxLlQSa3x/exec';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let me          = null;    // current user object
let token       = null;    // session token from backend
let sponsors    = [];      // all sponsor records
let seasons     = [];      // all seasons (sorted desc)
let activeSeason = null;
let curFilter   = 'all';
let editId      = null;

const TO = {gold:1,silver:2,bronze:3,community:4};
const TH = {gold:'#9a6700',silver:'#4a6070',bronze:'#7a4a28',community:'#013C1E'};
const TL = {gold:'Gold',silver:'Silver',bronze:'Bronze',community:'Community'};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SESSION PERSISTENCE (localStorage â€” just the token)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function saveSession(t, user) {
  localStorage.setItem('kjfc_token', t);
  localStorage.setItem('kjfc_user', JSON.stringify(user));
}
function loadSession() {
  token = localStorage.getItem('kjfc_token');
  try { me = JSON.parse(localStorage.getItem('kjfc_user')); } catch { me = null; }
}
function clearSession() {
  localStorage.removeItem('kjfc_token');
  localStorage.removeItem('kjfc_user');
  token = null; me = null;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  API CALLS TO APPS SCRIPT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function api(action, body = {}) {
  // JSONP â€” bypasses CORS preflight which Apps Script can't handle
  return new Promise((resolve) => {
    const cbName = '_kjfc_cb_' + Date.now() + '_' + Math.floor(Math.random() * 1e6);
    const params = new URLSearchParams({ action, callback: cbName });
    if (token) params.set('token', token);
    if (action === 'exchangeCode')   params.set('code', body.code || '');
    else if (action === 'getAudit')  params.set('id', body.id || '');
    else if (Object.keys(body).length > 0) params.set('payload', encodeURIComponent(JSON.stringify(body)));

    const timer = setTimeout(() => { cleanup(); resolve({ error: 'Request timed out' }); }, 15000);
    function cleanup() { clearTimeout(timer); delete window[cbName]; const el = document.getElementById(cbName); if (el) el.remove(); }
    window[cbName] = (data) => { cleanup(); resolve(data); };
    const script = document.createElement('script');
    script.id = cbName;
    script.src = APPS_SCRIPT_URL + '?' + params.toString();
    script.onerror = () => { cleanup(); resolve({ error: 'Script load failed' }); };
    document.head.appendChild(script);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GOOGLE SIGN-IN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initGoogleSignIn() {
  if (!window.google) {
    setTimeout(initGoogleSignIn, 300);
    return;
  }
  google.accounts.id.initialize({
    client_id: GOOGLE_CLIENT_ID,
    callback: handleGoogleCredential,
    auto_select: false,
    cancel_on_tap_outside: true,
  });
  function renderGoogleBtn() {
    const container = document.getElementById('google-btn-container');
    if (!container) return;
    container.innerHTML = '';
    // Use lbox width or fallback to 300 â€” never rely on container.offsetWidth which can be 0
    const lbox = document.querySelector('.lbox');
    const w = Math.min((lbox ? lbox.offsetWidth - 48 : 0) || 300, 360);
    google.accounts.id.renderButton(container, {
      theme: 'outline', size: 'large', width: w,
      text: 'continue_with', shape: 'rectangular'
    });
  }
  // Render after a short delay to ensure DOM is laid out
  setTimeout(renderGoogleBtn, 100);
  window.addEventListener('orientationchange', () => setTimeout(renderGoogleBtn, 300));
  window.addEventListener('resize', () => setTimeout(renderGoogleBtn, 100));
  document.getElementById('google-sign-in-btn').addEventListener('click', () => {
    google.accounts.id.prompt();
  });
}

async function handleGoogleCredential(response) {
  setSyncState('loading', 'Verifying identityâ€¦');
  const result = await api('exchangeCode', { code: response.credential });
  if (result.error) {
    document.getElementById('lerr').textContent = result.error;
    setSyncState('err', 'Sign-in failed');
    return;
  }
  token = result.token;
  me = { email: result.email, name: result.name, role: result.role, edit: result.edit, admin: result.admin, picture: result.picture };
  saveSession(token, me);
  showApp();
}

async function doLogout() {
  if (window.google) google.accounts.id.disableAutoSelect();
  clearSession();
  sponsors = []; seasons = [];
  document.getElementById('login-screen').style.display = 'flex';
  document.getElementById('login-screen').classList.add('show');
  document.getElementById('lerr').textContent = '';
  hideLoading();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LOAD DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadAll() {
  setSyncState('loading', 'Loading dataâ€¦');
  try {
    const [spRes, seRes] = await Promise.all([
      api('getSponsors'),
      api('getSeasons'),
    ]);
    if (spRes.error || seRes.error) throw new Error(spRes.error || seRes.error);
    sponsors = spRes;
    seasons  = seRes;
    if (!activeSeason || !seasons.includes(activeSeason)) activeSeason = seasons[0];
    renderSeasonTabs();
    populateYearDropdown();
    render();
    setSyncState('ok', 'Synced with Google Sheets Â· ' + fmtTime(new Date()));
  } catch (e) {
    setSyncState('err', 'Could not load data: ' + e.message);
    showToast('Load failed â€” check connection', 'err');
  }
}

function setSyncState(state, text) {
  const dot  = document.getElementById('sync-dot');
  const span = document.getElementById('sync-text');
  dot.className = 'sync-dot ' + state;
  span.textContent = text;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function init() {
  loadSession();
  initGoogleSignIn();
  // Attach listeners safely now DOM is guaranteed ready
  const _nri = document.getElementById('new-role-input');
  if (_nri) _nri.addEventListener('keydown', e => { if (e.key === 'Enter') addCustomRole(); });
  const _rm = document.getElementById('roles-modal');
  if (_rm) _rm.addEventListener('click', e => { if (e.target === _rm) closeManageRoles(); });
  const _rsm = document.getElementById('reset-modal');
  if (_rsm) _rsm.addEventListener('click', e => { if (e.target === _rsm) closeResetModal(); });

  if (token && me) {
    // Verify token is still valid
    const check = await api('getMe');
    if (check.error) {
      clearSession();
      showLoginScreen();
      hideLoading();
      return;
    }
    me = { ...me, ...check };
    showApp();
  } else {
    showLoginScreen();
    hideLoading();
  }
}

function showLoginScreen() {
  document.getElementById('login-screen').classList.add('show');
  document.getElementById('login-screen').style.display = 'flex';
  hideLoading();
}

function showApp() {
  document.getElementById('login-screen').classList.remove('show');
  document.getElementById('login-screen').style.display = 'none';
  renderUserUI();
  loadAll();
  hideLoading();
}

function hideLoading() {
  const ls = document.getElementById('loading-screen');
  ls.classList.add('fade');
  setTimeout(() => ls.style.display = 'none', 450);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDER USER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderUserUI() {
  if (!me) return;
  const init = me.name.split(' ').map(w => w[0]).join('').toUpperCase().slice(0, 2);
  document.getElementById('uav-init').textContent = init;
  document.getElementById('uname').textContent = me.name.split(' ')[0];
  if (me.picture) {
    document.getElementById('uav').innerHTML = `<img src="${me.picture}" alt="">`;
  }
  document.getElementById('add-btn').style.display      = me.edit  ? 'block' : 'none';
  document.getElementById('addseasbtn').style.display   = me.admin ? 'inline-block' : 'none';
  document.getElementById('tab-access-btn').style.display = me.admin ? 'inline-block' : 'none';
  document.getElementById('tab-users-btn').style.display  = me.admin ? 'inline-block' : 'none';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SEASONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderSeasonTabs() {
  document.getElementById('stabs').innerHTML = seasons.map(y =>
    `<button class="stab${y === activeSeason ? ' act' : ''}" onclick="switchSeason(${y})">${y}</button>`
  ).join('');
}

function switchSeason(year) {
  activeSeason = year;
  closeDrill();
  closeDetail();
  renderSeasonTabs();
  curFilter = 'all';
  document.querySelectorAll('.fbtn').forEach((b, i) => b.classList.toggle('act', i === 0));
  render();
  populateYearDropdown();
}

function openSeasonModal() {
  document.getElementById('new-season-yr').value = seasons[0] + 1;
  document.getElementById('season-modal').classList.add('open');
}
function closeSeasonModal() { document.getElementById('season-modal').classList.remove('open'); }

async function confirmAddSeason() {
  const y = +document.getElementById('new-season-yr').value;
  if (!y || y < 2020 || y > 2045) { showToast('Enter a valid year', 'warn'); return; }
  if (seasons.includes(y)) { showToast(y + ' already exists', 'warn'); closeSeasonModal(); return; }
  setSyncState('loading', 'Adding seasonâ€¦');
  const res = await api('addSeason', { year: y });
  if (res.error) { showToast('Error: ' + res.error, 'err'); return; }
  closeSeasonModal();
  showToast('Season ' + y + ' added âœ“');
  await loadAll();
  activeSeason = y;
  renderSeasonTabs();
}

function populateYearDropdown() {
  const sel = document.getElementById('f-year');
  sel.innerHTML = seasons.map(y => `<option value="${y}">${y}</option>`).join('');
  sel.value = activeSeason;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function calcStats(year) {
  const rows = sponsors.filter(s => s.year === year);
  const total = rows.reduce((a, s) => a + +s.amount, 0);
  const recv  = rows.reduce((a, s) =>
    s.status === 'paid' ? a + +s.amount :
    s.status === 'partial' ? a + +(s.paidAmount || 0) : a, 0);
  const outCount = rows.filter(s => s.status !== 'paid').length;
  const byTier = {};
  ['gold','silver','bronze','community'].forEach(t => {
    const ts = rows.filter(s => s.tier === t);
    byTier[t] = { count: ts.length, amount: ts.reduce((a, s) => a + +s.amount, 0) };
  });
  return { total, recv, outstanding: total - recv, outCount, count: rows.length, byTier };
}

function consecYears(name) {
  const lower = name.toLowerCase();
  const has = sponsors.filter(s => s.name.toLowerCase() === lower).map(s => s.year);
  let c = 0, y = seasons[0];
  for (const yr of seasons) {
    if (yr === y && has.includes(yr)) { c++; y--; } else break;
  }
  return c;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MAIN RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function render() {
  const cy = activeSeason;
  if (!cy) return;
  const s = calcStats(cy);
  const prevYr = seasons[seasons.indexOf(cy) + 1];
  const prev = prevYr ? calcStats(prevYr) : { total: 0 };

  document.getElementById('season-span').textContent = cy + ' Season';
  document.getElementById('k-total').textContent = fmt(s.total);
  document.getElementById('k-count').textContent = s.count + ' sponsor' + (s.count !== 1 ? 's' : '');
  document.getElementById('k-paid').textContent = fmt(s.recv);
  const pct = s.total > 0 ? Math.round(s.recv / s.total * 100) : 0;
  document.getElementById('k-ppct').textContent = pct + '% collected';
  document.getElementById('k-bar').style.width = pct + '%';
  document.getElementById('k-out').textContent = fmt(s.outstanding);
  document.getElementById('k-outc').textContent = s.outCount + ' invoice' + (s.outCount !== 1 ? 's' : '') + ' pending';

  const tEl = document.getElementById('k-trend');
  if (prev.total > 0 && s.total > 0) {
    const d = s.total - prev.total, pd = Math.round(d / prev.total * 100);
    tEl.textContent = (d >= 0 ? 'â–² ' : 'â–¼ ') + Math.abs(pd) + '% vs ' + prevYr;
    tEl.className = 'ktrend ' + (d >= 0 ? 'up' : 'dn');
  } else tEl.textContent = '';

  document.getElementById('tier-mini').innerHTML = ['gold','silver','bronze','community'].map(t =>
    s.byTier[t].count > 0
      ? `<div style="display:flex;align-items:center;gap:7px"><div style="width:6px;height:6px;border-radius:50%;background:${TH[t]};flex-shrink:0"></div><span style="font-size:11px;flex:1">${TL[t]}</span><span style="font-size:12px;font-weight:800;color:${TH[t]}">${s.byTier[t].count}</span></div>`
      : ''
  ).join('');

  // Year bars
  const allSt = seasons.map(y => ({ year: y, ...calcStats(y) }));
  const maxT = Math.max(...allSt.map(x => x.total), 1);
  document.getElementById('year-bars').innerHTML = allSt.map(ys => {
    const p2 = Math.round(ys.total / maxT * 100);
    const isCur = ys.year === cy;
    return `<div class="ybargrp" onclick="switchSeason(${ys.year})" title="View ${ys.year}">
      <div class="ybarlbl">
        <span class="yr" style="${isCur?'color:var(--text);font-weight:700':''}">${ys.year}${isCur?' â˜…':''}</span>
        <span style="font-weight:700;color:${isCur?'var(--yellow-dark)':'var(--text-dim)'}">${fmt(ys.total)} <span style="font-size:9px;font-weight:400">(${ys.count})</span></span>
      </div>
      <div class="btrack"><div class="bfill ${isCur?'cur':'prev'}" style="width:${p2}%"></div></div>
    </div>`;
  }).join('');

  // Tier breakdown
  document.getElementById('tier-list').innerHTML = ['gold','silver','bronze','community'].map(t => {
    const d = s.byTier[t]; if (!d.count) return '';
    return `<div class="trow" onclick="filterTable('${t}',null)">
      <div class="tdot ${t}"></div>
      <div class="tname">${TL[t]}</div>
      <div class="tcnt">${d.count}</div>
      <div class="tamt" style="color:${TH[t]}">${fmt(d.amount)}</div>
    </div>`;
  }).join('') || '<div style="color:var(--text-dim);font-size:13px;padding:6px">No sponsors yet.</div>';

  renderTable();
}

function renderTable() {
  const cy = activeSeason;
  const empty = document.getElementById('tbl-empty');
  let rows = sponsors.filter(s => s.year === cy);
  if (curFilter !== 'all' && curFilter !== 'outstanding') rows = rows.filter(s => s.tier === curFilter);
  else if (curFilter === 'outstanding') rows = rows.filter(s => s.status !== 'paid');
  rows.sort((a, b) => (TO[a.tier] || 5) - (TO[b.tier] || 5));

  if (!rows.length) {
    document.getElementById('tbl-body').innerHTML = '';
    document.getElementById('sponsor-cards').innerHTML = '';
    empty.style.display = 'block';
    return;
  }
  empty.style.display = 'none';

  // Desktop table rows
  document.getElementById('tbl-body').innerHTML = rows.map(s => {
    const c   = consecYears(s.name);
    const cH  = c > 1 ? `<span class="cbadge">â˜…${c}</span>` : '<span style="color:var(--text-dim);font-size:10px">1st</span>';
    const aH  = s.status === 'partial'
      ? `<div style="font-family:'Barlow Condensed',sans-serif;font-weight:800;font-size:14px">${fmt(s.amount)}</div><div style="font-size:10px;color:var(--orange)">${fmt(s.paidAmount||0)} recv</div>`
      : `<div style="font-family:'Barlow Condensed',sans-serif;font-weight:800;font-size:14px">${fmt(s.amount)}</div>`;
    const eBtn = me?.edit ? `<button class="actbtn" onclick="event.stopPropagation();openEdit('${s.id}')">Edit</button>` : '';
    return `<tr onclick="openDetail('${s.id}')">
      <td><strong>${s.name}</strong></td>
      <td><span class="tchip ${s.tier}">${TL[s.tier]}</span></td>
      <td>${aH}</td>
      <td><span class="sbadge ${s.status}">${cap(s.status)}</span></td>
      <td>${cH}</td>
      <td style="font-size:12px;color:var(--text-dim)">${s.contact || 'â€”'}</td>
      <td>${eBtn}</td>
    </tr>`;
  }).join('');

  // Mobile cards
  document.getElementById('sponsor-cards').innerHTML = rows.map(s => {
    const c   = consecYears(s.name);
    const recv = s.status === 'paid' ? +s.amount : s.status === 'partial' ? +(s.paidAmount||0) : 0;
    const eBtn = me?.edit ? `<button class="scard-edit" onclick="event.stopPropagation();openEdit('${s.id}')">Edit</button>` : '';
    return `<div class="scard" onclick="openDetail('${s.id}')">
      <div class="scard-top">
        <div>
          <div class="scard-name">${s.name}</div>
          ${c > 1 ? `<span class="cbadge" style="margin-top:4px;display:inline-flex">â˜… ${c} yrs</span>` : ''}
        </div>
        <div>
          <div class="scard-amount">${fmt(s.amount)}</div>
          ${s.status === 'partial' ? `<div class="scard-recv">${fmt(recv)} recv</div>` : ''}
        </div>
      </div>
      <div class="scard-meta">
        <span class="tchip ${s.tier}">${TL[s.tier]}</span>
        <span class="sbadge ${s.status}">${cap(s.status)}</span>
        ${eBtn}
      </div>
    </div>`;
  }).join('');
}

function filterTable(f, btn) {
  curFilter = f;
  closeDrill();
  document.querySelectorAll('.fbtn').forEach(b => b.classList.remove('act'));
  if (btn) btn.classList.add('act');
  renderTable();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DRILL-DOWN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openDrill(title, rows) {
  document.getElementById('drillTitle').textContent = title;
  const body = rows.map(s => {
    const aH = s.status === 'partial'
      ? `${fmt(s.amount)} <span style="font-size:10px;color:var(--orange)">(${fmt(s.paidAmount||0)} recv)</span>`
      : fmt(s.amount);
    return `<tr onclick="openDetail('${s.id}')" style="cursor:pointer">
      <td><strong>${s.name}</strong></td>
      <td><span class="tchip ${s.tier}">${TL[s.tier]}</span></td>
      <td style="font-family:'Barlow Condensed',sans-serif;font-weight:800">${aH}</td>
      <td><span class="sbadge ${s.status}">${cap(s.status)}</span></td>
      <td style="font-size:12px;color:var(--text-dim)">${s.contact||'â€”'}</td>
    </tr>`;
  }).join('');
  document.getElementById('drill-body').innerHTML = body;

  // Mobile cards for drill
  document.getElementById('drill-cards').innerHTML = rows.map(s =>
    `<div class="scard" onclick="openDetail('${s.id}')">
      <div class="scard-top">
        <div class="scard-name">${s.name}</div>
        <div class="scard-amount">${fmt(s.amount)}</div>
      </div>
      <div class="scard-meta">
        <span class="tchip ${s.tier}">${TL[s.tier]}</span>
        <span class="sbadge ${s.status}">${cap(s.status)}</span>
      </div>
    </div>`
  ).join('');

  document.getElementById('drillPanel').classList.add('open');
}
function closeDrill() { document.getElementById('drillPanel').classList.remove('open'); }

function drillTotal() {
  const rows = sponsors.filter(s => s.year === activeSeason).sort((a,b) => (TO[a.tier]||5)-(TO[b.tier]||5));
  openDrill(`All Sponsors â€” ${activeSeason} (${fmt(rows.reduce((a,s)=>a+ +s.amount,0))})`, rows);
}
function drillPaid() {
  const rows = sponsors.filter(s => s.year === activeSeason && (s.status==='paid'||s.status==='partial')).sort((a,b) => (TO[a.tier]||5)-(TO[b.tier]||5));
  const total = rows.reduce((a,s) => s.status==='paid' ? a+ +s.amount : a+(+(s.paidAmount||0)), 0);
  openDrill(`Received â€” ${activeSeason} (${fmt(total)} across ${rows.length} sponsors)`, rows);
}
function drillOut() {
  const rows = sponsors.filter(s => s.year === activeSeason && (s.status==='outstanding'||s.status==='partial')).sort((a,b) => (TO[a.tier]||5)-(TO[b.tier]||5));
  const total = rows.reduce((a,s) => s.status==='partial' ? a+(+s.amount-(+s.paidAmount||0)) : a+ +s.amount, 0);
  openDrill(`Outstanding â€” ${activeSeason} (${fmt(total)} still owing)`, rows);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DETAIL VIEW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function openDetail(id) {
  const s = sponsors.find(x => x.id === id); if (!s) return;
  const recv = s.status==='paid' ? +s.amount : s.status==='partial' ? +(s.paidAmount||0) : 0;
  const pct  = s.amount > 0 ? Math.round(recv / s.amount * 100) : 0;
  const init = s.name.split(' ').map(w=>w[0]).slice(0,2).join('').toUpperCase();
  const c    = consecYears(s.name);

  const yPills = seasons.map(y => {
    const r = sponsors.find(x => x.name.toLowerCase()===s.name.toLowerCase() && x.year===y);
    return `<div class="ypill${r?' has':''}"><div class="ydot"></div><span>${y}</span>${r?`<span style="font-size:9px"> ${fmt(r.amount)}</span>`:''}</div>`;
  }).join('');

  // Load audit
  const auditRes = await api('getAudit', { id });
  const audits = Array.isArray(auditRes) ? auditRes : [];
  const auditHtml = audits.length
    ? audits.map(a => `<div class="aentry"><div class="adot ${a.action==='DELETED'?'del':a.action==='ADDED'?'add':'edit'}"></div><div><div class="aact">${a.action}${a.details?' â€” '+a.details:''}</div><div class="amet">${fmtD(a.timestamp||a.ts)} Â· ${a.user} (${a.role})</div></div></div>`).join('')
    : '<div class="aempty">No changes recorded yet.</div>';

  const eBtn = me?.edit ? `<button class="actbtn" style="margin-left:auto" onclick="openEdit('${s.id}')">Edit</button>` : '';

  document.getElementById('detail-content').innerHTML = `
    <div class="dheader">
      <div class="dlogo">${init}</div>
      <div class="dinfo">
        <h2>${s.name}</h2>
        <div class="dmeta">
          <span class="tchip ${s.tier}">${TL[s.tier]}</span>
          <span class="sbadge ${s.status}">${cap(s.status)}</span>
          ${c>1?`<span class="cbadge">â˜… ${c} yrs</span>`:''}
          ${s.website?`<a href="https://${s.website}" target="_blank" rel="noopener" style="color:var(--green);font-size:11px;font-weight:600">${s.website} â†—</a>`:''}
        </div>
      </div>
      ${eBtn}
    </div>

    <div style="margin-bottom:13px">
      <div style="font-size:9px;text-transform:uppercase;letter-spacing:1.2px;color:var(--text-dim);font-weight:700;margin-bottom:7px">Sponsorship History</div>
      <div class="ystrip">${yPills}</div>
    </div>

    <div class="dkpis">
      <div class="dkpi"><div class="klbl">${s.year} Value</div><div class="kval" style="color:var(--yellow-dark);font-size:22px">${fmt(s.amount)}</div></div>
      <div class="dkpi"><div class="klbl">Received</div><div class="kval" style="color:var(--green);font-size:22px">${fmt(recv)}</div><div class="ksub">${pct}%</div></div>
      <div class="dkpi"><div class="klbl">Owing</div><div class="kval" style="color:${s.amount-recv>0?'var(--red)':'var(--green)'};font-size:22px">${fmt(s.amount-recv)}</div></div>
    </div>

    <div class="panel" style="margin-bottom:12px">
      <div style="font-size:9px;text-transform:uppercase;letter-spacing:1.2px;color:var(--text-dim);font-weight:700;margin-bottom:8px">Payment Progress</div>
      <div class="pbtrack" style="height:8px"><div class="pbfill" style="width:${pct}%"></div></div>
      <div style="display:flex;justify-content:space-between;margin-top:5px;font-size:10px;color:var(--text-dim)"><span>${fmt(recv)} received</span><span>${fmt(s.amount-recv)} remaining</span></div>
    </div>

    ${s.contact||s.email||s.phone?`
    <div class="panel" style="margin-bottom:12px">
      <div style="font-size:9px;text-transform:uppercase;letter-spacing:1.2px;color:var(--text-dim);font-weight:700;margin-bottom:8px">Contact</div>
      <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:10px">
        ${s.contact?`<div><div style="font-size:9px;color:var(--text-dim);margin-bottom:2px">NAME</div><div style="font-weight:600;font-size:13px">${s.contact}</div></div>`:''}
        ${s.email?`<div><div style="font-size:9px;color:var(--text-dim);margin-bottom:2px">EMAIL</div><a href="mailto:${s.email}" style="color:var(--green);font-weight:600;font-size:12px;word-break:break-all">${s.email}</a></div>`:''}
        ${s.phone?`<div><div style="font-size:9px;color:var(--text-dim);margin-bottom:2px">PHONE</div><a href="tel:${s.phone}" style="color:var(--green);font-weight:600;font-size:13px">${s.phone}</a></div>`:''}
      </div>
    </div>`:''}

    ${s.notes?`
    <div class="panel" style="margin-bottom:12px">
      <div style="font-size:9px;text-transform:uppercase;letter-spacing:1.2px;color:var(--text-dim);font-weight:700;margin-bottom:7px">Notes &amp; Benefits</div>
      <p style="font-size:13px;line-height:1.6;color:var(--text-mid)">${s.notes}</p>
    </div>`:''}

    <div class="alog"><h3>Change History</h3>${auditHtml}</div>
  `;

  document.getElementById('mainView').classList.add('h');
  document.getElementById('detailView').classList.add('open');
  window.scrollTo(0, 0);
}

function closeDetail() {
  document.getElementById('mainView').classList.remove('h');
  document.getElementById('detailView').classList.remove('open');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SPONSOR MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function resetModal() {
  ['f-name','f-amount','f-paid','f-contact','f-email','f-phone','f-website','f-notes'].forEach(id => document.getElementById(id).value = '');
  document.getElementById('f-tier').value = '';
  document.getElementById('f-status').value = '';
  document.getElementById('f-partial-wrap').style.display = 'none';
}

function openAdd() {
  if (!me?.edit) return;
  editId = null;
  document.getElementById('m-title').textContent = 'Add Sponsor';
  document.getElementById('m-save').textContent = 'Add Sponsor';
  document.getElementById('m-del').style.display = 'none';
  document.getElementById('m-sub').textContent = 'New entry for ' + activeSeason + ' season.';
  document.getElementById('copy-prev-wrap').style.display = 'block';
  resetModal();
  populateYearDropdown();
  populateCopyPrev();
  document.getElementById('sponsor-modal').classList.add('open');
}

function openEdit(id) {
  if (!me?.edit) return;
  const s = sponsors.find(x => x.id === id); if (!s) return;
  editId = id;
  document.getElementById('m-title').textContent = 'Edit Sponsor';
  document.getElementById('m-save').textContent = 'Save Changes';
  document.getElementById('m-del').style.display = 'block';
  document.getElementById('m-sub').textContent = s.name + ' Â· ' + s.year;
  document.getElementById('copy-prev-wrap').style.display = 'none';
  populateYearDropdown();
  document.getElementById('f-name').value    = s.name;
  document.getElementById('f-tier').value    = s.tier;
  document.getElementById('f-year').value    = s.year;
  document.getElementById('f-amount').value  = s.amount;
  document.getElementById('f-status').value  = s.status;
  document.getElementById('f-paid').value    = s.paidAmount || '';
  document.getElementById('f-contact').value = s.contact || '';
  document.getElementById('f-email').value   = s.email || '';
  document.getElementById('f-phone').value   = s.phone || '';
  document.getElementById('f-website').value = s.website || '';
  document.getElementById('f-notes').value   = s.notes || '';
  document.getElementById('f-partial-wrap').style.display = s.status === 'partial' ? 'flex' : 'none';
  document.getElementById('sponsor-modal').classList.add('open');
}

function closeModal() { document.getElementById('sponsor-modal').classList.remove('open'); editId = null; }

async function saveSponsor() {
  if (!me?.edit) return;
  const name   = document.getElementById('f-name').value.trim();
  const tier   = document.getElementById('f-tier').value;
  const amount = document.getElementById('f-amount').value;
  const status = document.getElementById('f-status').value;
  if (!name)             { showToast('Enter a sponsor name', 'warn'); return; }
  if (!tier)             { showToast('Select a tier', 'warn'); return; }
  if (!amount || +amount <= 0) { showToast('Enter a valid amount', 'warn'); return; }
  if (!status)           { showToast('Select a payment status', 'warn'); return; }

  const data = {
    id:         editId || '',
    name, tier,
    year:       +document.getElementById('f-year').value,
    amount:     +amount,
    status,
    paidAmount: +document.getElementById('f-paid').value || 0,
    contact:    document.getElementById('f-contact').value.trim(),
    email:      document.getElementById('f-email').value.trim(),
    phone:      document.getElementById('f-phone').value.trim(),
    website:    document.getElementById('f-website').value.trim(),
    notes:      document.getElementById('f-notes').value.trim(),
  };

  setSyncState('loading', 'Savingâ€¦');
  document.getElementById('m-save').disabled = true;
  const res = await api('saveSponsor', { data, isNew: !editId });
  document.getElementById('m-save').disabled = false;

  if (res.error) { showToast('Error: ' + res.error, 'err'); setSyncState('err', 'Save failed'); return; }

  closeModal();
  showToast(editId ? 'Sponsor updated âœ“' : 'Sponsor added âœ“');
  await loadAll();
  if (editId && document.getElementById('detailView').classList.contains('open')) openDetail(editId);
}

async function deleteSponsor() {
  if (!me?.edit || !editId) return;
  const s = sponsors.find(x => x.id === editId);
  if (!confirm(`Delete ${s?.name || 'this sponsor'}? This cannot be undone.`)) return;
  setSyncState('loading', 'Deletingâ€¦');
  const res = await api('deleteSponsor', { id: editId });
  if (res.error) { showToast('Error: ' + res.error, 'err'); return; }
  closeModal(); closeDetail();
  showToast('Sponsor deleted');
  await loadAll();
}

// Wire modal buttons
document.getElementById('m-save').addEventListener('click', saveSponsor);
document.getElementById('m-cancel').addEventListener('click', closeModal);
document.getElementById('mclose-btn').addEventListener('click', closeModal);
document.getElementById('m-del').addEventListener('click', deleteSponsor);
document.getElementById('f-status').addEventListener('change', function() {
  document.getElementById('f-partial-wrap').style.display = this.value === 'partial' ? 'flex' : 'none';
});
document.getElementById('sponsor-modal').addEventListener('click', e => { if (e.target === document.getElementById('sponsor-modal')) closeModal(); });
document.getElementById('season-modal').addEventListener('click',  e => { if (e.target === document.getElementById('season-modal'))  closeSeasonModal(); });

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  COPY FROM PREVIOUS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function populateCopyPrev() {
  const pastSponsors = sponsors.filter(s => s.year !== activeSeason);
  const seen = new Set();
  const opts = ['<option value="">â€” Select past sponsor â€”</option>'];
  pastSponsors.sort((a,b) => b.year - a.year).forEach(s => {
    const key = s.name.toLowerCase();
    if (!seen.has(key)) {
      seen.add(key);
      opts.push(`<option value="${s.id}">${s.name} (${s.year} â€” ${TL[s.tier]})</option>`);
    }
  });
  document.getElementById('copy-prev-select').innerHTML = opts.join('');
  document.getElementById('copy-prev-wrap').style.display = pastSponsors.length ? 'block' : 'none';
}

function copyFromPrev() {
  const id = document.getElementById('copy-prev-select').value;
  if (!id) { showToast('Select a past sponsor first', 'warn'); return; }
  const s = sponsors.find(x => x.id === id); if (!s) return;
  document.getElementById('f-name').value    = s.name;
  document.getElementById('f-tier').value    = s.tier;
  document.getElementById('f-contact').value = s.contact || '';
  document.getElementById('f-email').value   = s.email || '';
  document.getElementById('f-phone').value   = s.phone || '';
  document.getElementById('f-website').value = s.website || '';
  document.getElementById('f-notes').value   = s.notes || '';
  document.getElementById('f-amount').value  = s.amount;
  document.getElementById('f-status').value  = 'outstanding';
  document.getElementById('f-paid').value    = '';
  document.getElementById('f-partial-wrap').style.display = 'none';
  showToast('Copied from ' + s.year + ' âœ“');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ACCESS LOG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function renderAccessLog() {
  setSyncState('loading', 'Loading logâ€¦');
  const logs = await api('getLog');
  setSyncState('ok', 'Loaded');
  const body = document.getElementById('log-body');
  const empty = document.getElementById('log-empty');
  if (!Array.isArray(logs) || !logs.length) { body.innerHTML = ''; empty.style.display = 'block'; return; }
  empty.style.display = 'none';
  body.innerHTML = logs.map(l => {
    const c = l.type==='login'?'var(--green)':l.action?.includes('DELETE')?'var(--red)':l.action?.includes('ADD')?'var(--green-bright)':'var(--yellow-dark)';
    return `<tr>
      <td style="color:var(--text-dim);white-space:nowrap;font-size:11px">${fmtD(l.timestamp||l.ts)}</td>
      <td style="font-weight:600;font-size:12px">${l.user||l.name||''}</td>
      <td style="color:var(--text-dim);font-size:11px">${l.role||''}</td>
      <td><span style="font-weight:800;color:${c};font-size:10px">${l.action||''}</span></td>
      <td style="color:var(--text-dim);font-size:11px">${l.details||''}</td>
    </tr>`;
  }).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  USERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function renderUserGrid() {
  const users = await api('getUsers');
  if (!Array.isArray(users)) return;
  document.getElementById('user-grid').innerHTML = users.map(u => {
    const init = (u.name||u.email||'?').split(' ').map(w=>w[0]).join('').toUpperCase().slice(0,2);
    const isSelf = me && me.email === u.email;
    return `<div class="ucard">
      <div class="ucard-head">
        <div class="ucard-av">${init}</div>
        <div>
          <div class="ucard-name">${u.name}${isSelf?' <span style="font-size:10px;color:var(--text-dim)">(you)</span>':''}</div>
          <div class="ucard-role">${u.role} Â· ${u.email}</div>
        </div>
      </div>
      <div class="ucard-badges">
        ${u.admin?'<span class="ubadge admin">Admin</span>':''}
        ${u.edit?'<span class="ubadge edit">Can Edit</span>':'<span class="ubadge view">View Only</span>'}
      </div>
      <div class="ucard-actions">
        <button class="uact-btn" onclick="openEditUser('${u.email}','${u.name}','${u.role}',${u.admin},${u.edit})">Edit Name/Role</button>
      </div>
    </div>`;
  }).join('');
}

// â”€â”€ ROLES MANAGEMENT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const DEFAULT_ROLES = ['President','Vice President','Treasurer','Secretary','Registrar',
  'Committee Member','Coach','Team Manager','Volunteer','Administrator','Member'];

function getRoles() {
  try {
    const stored = localStorage.getItem('kjfc_roles');
    return stored ? JSON.parse(stored) : [...DEFAULT_ROLES];
  } catch(e) { return [...DEFAULT_ROLES]; }
}
function saveRoles(roles) {
  localStorage.setItem('kjfc_roles', JSON.stringify(roles));
}
function populateRoleSelect(currentRole) {
  const sel = document.getElementById('reset-role');
  const roles = getRoles();
  sel.innerHTML = roles.map(r => `<option value="${r}"${r===currentRole?' selected':''}>${r}</option>`).join('');
  if (!sel.value && roles.length) sel.value = roles[0];
}
function openManageRoles() {
  renderRolesList();
  document.getElementById('roles-modal').classList.add('open');
}
function closeManageRoles() {
  document.getElementById('roles-modal').classList.remove('open');
  // Refresh the role select with any changes
  const currentRole = document.getElementById('reset-role').value;
  populateRoleSelect(currentRole);
}
function renderRolesList() {
  const roles = getRoles();
  document.getElementById('roles-list').innerHTML = roles.map((r, i) => `
    <div class="role-tag">
      <span>${r}</span>
      ${DEFAULT_ROLES.includes(r)
        ? '<span class="role-tag-default">default</span>'
        : `<button class="role-tag-del" onclick="deleteRole(${i})" title="Remove">âœ•</button>`}
    </div>`).join('');
}
function addCustomRole() {
  const input = document.getElementById('new-role-input');
  const val = input.value.trim();
  if (!val) return;
  const roles = getRoles();
  if (roles.includes(val)) { showToast('Role already exists'); return; }
  roles.push(val);
  saveRoles(roles);
  input.value = '';
  renderRolesList();
  showToast('Role added âœ“');
}
function deleteRole(idx) {
  const roles = getRoles();
  roles.splice(idx, 1);
  saveRoles(roles);
  renderRolesList();
}
// These are attached inside init() to ensure DOM is ready

// â”€â”€ EDIT USER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openEditUser(email, name, role, isAdmin, canEdit) {
  document.getElementById('reset-email').value = email;
  document.getElementById('reset-name').value  = name;
  populateRoleSelect(role);
  // Set access level radio
  const level = isAdmin ? 'admin' : canEdit ? 'edit' : 'readonly';
  document.querySelector(`input[name="access-level"][value="${level}"]`).checked = true;
  document.getElementById('reset-sub').textContent = 'Editing ' + email;
  document.getElementById('reset-ok').style.display  = 'none';
  document.getElementById('reset-err').style.display = 'none';
  document.getElementById('reset-modal').classList.add('open');
}
function closeResetModal() { document.getElementById('reset-modal').classList.remove('open'); }

async function confirmEditUser() {
  const email  = document.getElementById('reset-email').value;
  const name   = document.getElementById('reset-name').value.trim();
  const role   = document.getElementById('reset-role').value.trim();
  const access = document.querySelector('input[name="access-level"]:checked')?.value || 'readonly';
  const ok = document.getElementById('reset-ok'), err = document.getElementById('reset-err');
  ok.style.display = 'none'; err.style.display = 'none';
  const res = await api('updateUser', { email, name, role, access });
  if (res.error) { err.textContent = res.error; err.style.display = 'block'; return; }
  ok.style.display = 'block';
  setTimeout(() => closeResetModal(), 1200);
  showToast('User updated âœ“');
  loadAll();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PROFILE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openProfile() {
  if (!me) return;
  const init = me.name.split(' ').map(w=>w[0]).join('').toUpperCase().slice(0,2);
  document.getElementById('prof-av-init').textContent = init;
  if (me.picture) document.getElementById('prof-av').innerHTML = `<img src="${me.picture}" alt="">`;
  document.getElementById('prof-name').textContent = me.name;
  document.getElementById('prof-email').textContent = me.email;
  document.getElementById('prof-badges').innerHTML =
    (me.admin ? '<span class="ubadge admin">Admin</span>' : '') +
    (me.edit  ? '<span class="ubadge edit">Can Edit</span>' : '<span class="ubadge view">View Only</span>');
  document.getElementById('profile-modal').classList.add('open');
}
function closeProfileModal() { document.getElementById('profile-modal').classList.remove('open'); }
document.getElementById('profile-modal').addEventListener('click', e => { if (e.target === document.getElementById('profile-modal')) closeProfileModal(); });

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TABS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setTab(tab, btn) {
  document.querySelectorAll('.ptab').forEach(b => b.classList.remove('act'));
  btn.classList.add('act');
  ['overview','access','users'].forEach(t => {
    document.getElementById('tab-' + t).style.display = t === tab ? 'block' : 'none';
  });
  if (tab === 'access') renderAccessLog();
  if (tab === 'users')  renderUserGrid();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function fmt(n)    { return '$' + Number(n).toLocaleString('en-AU'); }
function cap(s)    { return s.charAt(0).toUpperCase() + s.slice(1); }
function fmtTime(d){ return d.toLocaleTimeString('en-AU', { hour:'2-digit', minute:'2-digit' }); }
function fmtD(iso) {
  if (!iso) return 'â€”';
  const d = new Date(iso);
  return d.toLocaleDateString('en-AU', {day:'2-digit',month:'short',year:'numeric'}) + ' ' +
         d.toLocaleTimeString('en-AU', {hour:'2-digit',minute:'2-digit'});
}
function showToast(msg, type = '') {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = 'toast show' + (type ? ' ' + type : '');
  clearTimeout(t._t);
  t._t = setTimeout(() => t.classList.remove('show'), 2800);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  EXPORT CSV
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.kjfc = {
  exportCSV() {
    const hdr = 'Year,Name,Tier,Amount,Status,Paid,Contact,Email,Phone,Website,Notes';
    const rows = sponsors.sort((a,b) => b.year - a.year).map(r =>
      [r.year,`"${r.name}"`,r.tier,r.amount,r.status,r.paidAmount||0,`"${r.contact||''}"`,r.email,r.phone,r.website,`"${(r.notes||'').replace(/"/g,"'")}"`].join(',')
    );
    const csv = [hdr,...rows].join('\n');
    const a = document.createElement('a');
    a.href = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csv);
    a.download = 'kjfc_sponsors.csv';
    a.click();
    showToast('CSV exported âœ“');
  }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  START
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
init();
</script>
</body>
</html>
