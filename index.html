<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>KJFC Exec Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@400;600;700;800;900&family=Barlow:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>

/* ════════════════════════════════════════
   ROOT VARIABLES
   ════════════════════════════════════════ */
:root{
  --green:        #013C1E;
  --green-mid:    #025a2d;
  --green-light:  #e6f0eb;
  --green-bright: #2e7d4f;
  --yellow:       #FBE201;
  --yellow-dark:  #c9b400;
  --yellow-pale:  #fffde6;
  --yellow-mid:   #fef083;
  --bg:           #f4f6f4;
  --card:         #ffffff;
  --text:         #1a1a1a;
  --text-mid:     #3a3a3a;
  --text-dim:     #6b7a6b;
  --border:       #d8e4d8;
  --border-s:     #adc4ad;
  --red:          #b91c1c;
  --red-light:    #fef2f2;
  --orange:       #c2720a;
  --orange-light: #fef6ec;
  --tg:#9a6700; --tgb:#fffaeb;
  --ts:#4a6070; --tsb:#f0f4f8;
  --tb:#7a4a28; --tbb:#fdf4ec;
  --tc:#013C1E; --tcb:#e6f0eb;
  --td:#1a6b8a; --tdb:#e8f4f8;
  --sh:  0 1px 4px rgba(0,0,0,0.07);
  --shm: 0 4px 18px rgba(0,0,0,0.11);
  --r:   11px;
  --safe-bottom: env(safe-area-inset-bottom, 0px);
}

*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
html{scroll-behavior:smooth;}
body{background:var(--bg);color:var(--text);font-family:'Barlow',sans-serif;min-height:100vh;font-size:16px;}

/* ════════════════════════════════════════
   LOADING SCREEN
   ════════════════════════════════════════ */
#loading-screen{
  position:fixed;inset:0;z-index:1000;background:var(--green);
  display:flex;flex-direction:column;align-items:center;justify-content:center;gap:20px;
  transition:opacity .5s ease;
}
#loading-screen.fade{opacity:0;pointer-events:none;}
.ls-crest{
  width:80px;height:80px;background:var(--yellow);border-radius:50%;
  display:flex;align-items:center;justify-content:center;
  font-family:'Barlow Condensed',sans-serif;font-weight:900;font-size:24px;color:var(--green);
  animation:ls-pulse 1.8s ease-in-out infinite;
  box-shadow:0 0 0 0 rgba(251,226,1,0.5);
}
@keyframes ls-pulse{
  0%{box-shadow:0 0 0 0 rgba(251,226,1,0.5);transform:scale(1);}
  50%{box-shadow:0 0 0 18px rgba(251,226,1,0);transform:scale(1.06);}
  100%{box-shadow:0 0 0 0 rgba(251,226,1,0);transform:scale(1);}
}
.ls-text{
  font-family:'Barlow Condensed',sans-serif;font-size:15px;
  color:rgba(255,255,255,.55);text-transform:uppercase;letter-spacing:3px;
  animation:ls-blink 1.4s ease-in-out infinite;
}
@keyframes ls-blink{0%,100%{opacity:.4;}50%{opacity:1;}}
.ls-bar{width:160px;height:3px;background:rgba(255,255,255,.15);border-radius:2px;overflow:hidden;}
.ls-bar-fill{height:100%;width:0;background:var(--yellow);border-radius:2px;animation:ls-load 2s ease-in-out forwards;}
@keyframes ls-load{0%{width:0;}60%{width:75%;}90%{width:90%;}100%{width:100%;}}

/* Dashboard fade-in on load */
@keyframes dash-fadein{from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);}}
header{animation:dash-fadein .4s ease both;}
.sbar{animation:dash-fadein .4s ease .1s both;}
main{animation:dash-fadein .5s ease .15s both;}
.ls-spinner{width:28px;height:28px;border:3px solid rgba(255,255,255,.2);border-top-color:var(--yellow);border-radius:50%;animation:spin .8s linear infinite;}
@keyframes spin{to{transform:rotate(360deg);}}

/* ════════════════════════════════════════
   LOGIN SCREEN
   ════════════════════════════════════════ */
#login-screen{
  position:fixed;inset:0;z-index:999;background:var(--green);
  display:none;align-items:center;justify-content:center;padding:20px;
  overflow-y:auto;
}
#login-screen.show{display:flex;}
.lwrap{display:flex;flex-direction:column;align-items:center;width:100%;max-width:400px;padding:20px 0;}
.lcrest{width:84px;height:84px;background:var(--yellow);border-radius:50%;display:flex;align-items:center;justify-content:center;font-family:'Barlow Condensed',sans-serif;font-weight:900;font-size:26px;color:var(--green);margin-bottom:14px;border:4px solid rgba(255,255,255,.35);box-shadow:0 4px 24px rgba(0,0,0,.3);}
.lclub{font-family:'Barlow Condensed',sans-serif;font-weight:900;font-size:20px;color:#fff;text-transform:uppercase;letter-spacing:1px;text-align:center;line-height:1.2;margin-bottom:3px;}
.ltag{font-size:11px;color:rgba(255,255,255,.55);letter-spacing:2.5px;text-transform:uppercase;margin-bottom:24px;}
.lbox{background:#fff;border-radius:16px;padding:28px 28px 22px;width:100%;box-shadow:0 8px 40px rgba(0,0,0,.22);}
.lbox h2{font-family:'Barlow Condensed',sans-serif;font-weight:900;font-size:18px;text-transform:uppercase;margin-bottom:3px;}
.lbox p{font-size:12px;color:var(--text-dim);margin-bottom:20px;line-height:1.5;}
.google-btn{
  width:100%;padding:13px 16px;border-radius:8px;border:1.5px solid var(--border);
  background:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:10px;
  font-size:14px;font-weight:600;color:var(--text);transition:all .15s;box-shadow:var(--sh);
}
.google-btn:hover{border-color:var(--border-s);box-shadow:var(--shm);}
.google-btn:active{transform:scale(.98);}
.google-icon{width:20px;height:20px;flex-shrink:0;}
.lerr{color:var(--red);font-size:12px;margin-top:10px;text-align:center;min-height:17px;line-height:1.4;}
.lfooter{margin-top:14px;font-size:11px;color:rgba(255,255,255,.4);text-align:center;line-height:1.5;}

/* ════════════════════════════════════════
   HEADER
   ════════════════════════════════════════ */
header{
  background:var(--green);
  display:flex;align-items:center;justify-content:space-between;
  min-height:60px;position:sticky;top:0;z-index:100;
  box-shadow:0 2px 8px rgba(0,0,0,.18);
  padding:8px 20px;
  padding-left:max(20px, env(safe-area-inset-left));
  padding-right:max(20px, env(safe-area-inset-right));
  gap:16px;
}
.logo-area{display:flex;align-items:center;gap:10px;min-width:0;flex-shrink:0;}
.logo-badge{width:38px;height:38px;background:var(--yellow);border-radius:50%;display:flex;align-items:center;justify-content:center;font-family:'Barlow Condensed',sans-serif;font-weight:900;font-size:14px;color:var(--green);flex-shrink:0;}
.logo-text{min-width:0;}
.logo-text h1{font-family:'Barlow Condensed',sans-serif;font-weight:900;font-size:22px;text-transform:uppercase;letter-spacing:.4px;line-height:1.1;color:#fff;white-space:nowrap;}
.logo-text small{font-size:10px;color:rgba(255,255,255,.55);text-transform:uppercase;letter-spacing:1.5px;font-weight:600;display:block;}
.hright{display:flex;flex-direction:row;align-items:center;gap:6px;flex-shrink:0;flex-wrap:nowrap;}
.hrow{display:flex;align-items:center;gap:6px;}
.huser{display:flex;align-items:center;gap:8px;flex-shrink:0;}
.hnav{display:flex;align-items:center;gap:4px;}
.hnav-btn{background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.18);color:rgba(255,255,255,.9);padding:4px 12px;border-radius:5px;font-size:11px;cursor:pointer;transition:all .15s;font-weight:600;white-space:nowrap;font-family:'Barlow Condensed',sans-serif;text-transform:uppercase;letter-spacing:.5px;}
.hnav-btn:hover{background:rgba(255,255,255,.25);color:#fff;}
.user-pill{display:flex;align-items:center;gap:7px;background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.2);border-radius:20px;padding:3px 12px 3px 5px;cursor:pointer;transition:background .15s;}
.user-pill:hover{background:rgba(255,255,255,.22);}
.user-pill img{width:22px;height:22px;border-radius:50%;object-fit:cover;}
.user-pill-init{width:22px;height:22px;border-radius:50%;background:var(--yellow);display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:900;color:var(--green);font-family:'Barlow Condensed',sans-serif;flex-shrink:0;}
.user-pill span{font-size:12px;font-weight:600;color:#fff;white-space:nowrap;}
.uchip{display:flex;align-items:center;gap:6px;background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.2);border-radius:16px;padding:3px 10px 3px 4px;cursor:pointer;transition:background .15s;max-width:160px;}
.uchip:hover{background:rgba(255,255,255,.2);}
.uav{width:24px;height:24px;border-radius:50%;overflow:hidden;flex-shrink:0;background:var(--yellow);display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:900;color:var(--green);font-family:'Barlow Condensed',sans-serif;}
.uav img{width:100%;height:100%;object-fit:cover;}
.uname{font-size:12px;font-weight:600;color:#fff;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.lobtn{background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.2);color:rgba(255,255,255,.8);padding:5px 10px;border-radius:5px;font-size:11px;cursor:pointer;transition:all .15s;font-weight:600;white-space:nowrap;}
.lobtn:hover{background:rgba(255,255,255,.22);}

/* ════════════════════════════════════════
   SEASON BAR
   ════════════════════════════════════════ */
.sbar{
  background:var(--yellow);
  padding:7px max(16px,env(safe-area-inset-left)) 7px max(16px,env(safe-area-inset-left));
  display:flex;align-items:center;gap:8px;border-bottom:2px solid var(--yellow-dark);
  overflow-x:auto;scrollbar-width:none;
}
.sbar::-webkit-scrollbar{display:none;}
.slabel{font-size:10px;font-weight:800;text-transform:uppercase;letter-spacing:1px;color:var(--green);opacity:.6;white-space:nowrap;flex-shrink:0;}
.stabs{display:flex;gap:3px;flex-shrink:0;}
.stab{padding:5px 12px;border-radius:4px;font-size:12px;font-weight:800;cursor:pointer;border:none;background:transparent;color:rgba(1,60,30,.5);transition:all .15s;font-family:'Barlow Condensed',sans-serif;letter-spacing:.5px;white-space:nowrap;}
.stab.act{background:var(--green);color:var(--yellow);}
.stab:hover:not(.act){background:rgba(1,60,30,.12);color:var(--green);}
.add-s-btn{padding:5px 10px;border-radius:4px;background:rgba(1,60,30,.12);border:1.5px solid rgba(1,60,30,.2);color:var(--green);font-size:10px;font-weight:800;cursor:pointer;transition:all .15s;font-family:'Barlow Condensed',sans-serif;text-transform:uppercase;white-space:nowrap;flex-shrink:0;}
.add-s-btn:hover{background:rgba(1,60,30,.22);}

/* ════════════════════════════════════════
   PAGE TABS (mobile: bottom nav)
   ════════════════════════════════════════ */
.ptabs-top{display:flex;gap:4px;margin-bottom:14px;overflow-x:auto;scrollbar-width:none;padding-bottom:2px;}
.ptabs-top::-webkit-scrollbar{display:none;}
.access-opt{display:flex;align-items:flex-start;gap:10px;padding:10px 12px;border:1.5px solid var(--border);border-radius:8px;cursor:pointer;transition:all .15s;width:100%;box-sizing:border-box;overflow:hidden;position:relative;}
.access-opt:has(input:checked){border-color:var(--green);background:var(--green-light);}
.access-opt input[type=radio]{position:absolute;opacity:0;width:0;height:0;}
/* Custom radio circle */
.access-opt-check{width:18px;height:18px;border-radius:50%;border:2px solid var(--border-s);background:#fff;flex-shrink:0;margin-top:2px;display:flex;align-items:center;justify-content:center;transition:all .15s;}
.access-opt:has(input:checked) .access-opt-check{border-color:var(--green);background:var(--green);}
.access-opt:has(input:checked) .access-opt-check::after{content:'✓';color:#fff;font-size:11px;font-weight:900;line-height:1;}
.access-opt-body{flex:1;min-width:0;overflow:hidden;}
.access-opt-title{font-weight:700;font-size:13px;color:var(--text);white-space:nowrap;}
.access-opt-desc{font-size:11px;color:var(--text-dim);margin-top:2px;line-height:1.4;word-wrap:break-word;}
.role-tag{display:flex;align-items:center;justify-content:space-between;padding:7px 10px;background:var(--bg);border:1.5px solid var(--border);border-radius:7px;font-size:13px;}
.role-tag-del{background:none;border:none;cursor:pointer;color:var(--text-dim);font-size:16px;line-height:1;padding:0 2px;}
.role-tag-del:hover{color:var(--red);}
.role-tag-default{font-size:10px;color:var(--text-dim);font-style:italic;}
.ptab-soon{opacity:.45;cursor:not-allowed!important;position:relative;}
.ptab-soon:hover{background:var(--card)!important;color:var(--text-dim)!important;border-color:var(--border)!important;}
.ptabs{padding:10px 16px;display:flex;gap:8px;border-top:1px solid var(--border);background:var(--card);}
.soon-badge{display:inline-block;font-size:8px;font-weight:800;background:var(--yellow);color:var(--green);border-radius:3px;padding:1px 4px;margin-left:5px;vertical-align:middle;text-transform:uppercase;letter-spacing:.5px;}
.ptab{padding:7px 14px;border-radius:6px;background:var(--card);color:var(--text-dim);border:1.5px solid var(--border);font-size:11px;font-weight:700;cursor:pointer;transition:all .15s;text-transform:uppercase;letter-spacing:.5px;white-space:nowrap;flex-shrink:0;}
.ptab.act{background:var(--green);color:#fff;border-color:var(--green);}

/* ════════════════════════════════════════
   MAIN CONTENT
   ════════════════════════════════════════ */
main{
  padding:16px max(16px,env(safe-area-inset-right)) calc(16px + var(--safe-bottom)) max(16px,env(safe-area-inset-left));
  max-width:1440px;
  margin:0 auto;
}
.sh{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;gap:10px;}
.stitle{font-family:'Barlow Condensed',sans-serif;font-weight:900;font-size:24px;text-transform:uppercase;letter-spacing:1px;color:var(--text);}
.stitle span{color:var(--green);}
.section-title{font-family:'Barlow Condensed',sans-serif;font-weight:900;font-size:20px;text-transform:uppercase;letter-spacing:1px;}

/* ════════════════════════════════════════
   SYNC STATUS BAR
   ════════════════════════════════════════ */
.sync-bar{display:flex;align-items:center;gap:8px;background:var(--card);border:1.5px solid var(--border);border-radius:8px;padding:8px 12px;margin-bottom:14px;font-size:12px;color:var(--text-dim);}
.sync-dot{width:8px;height:8px;border-radius:50%;background:var(--border-s);flex-shrink:0;}
.sync-dot.ok{background:var(--green-bright);}
.sync-dot.loading{background:var(--yellow-dark);animation:pulse 1s ease-in-out infinite;}
.sync-dot.err{background:var(--red);}
@keyframes pulse{0%,100%{opacity:1;}50%{opacity:.4;}}
.sync-refresh{padding:5px 11px;background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.2);color:rgba(255,255,255,.85);border-radius:5px;font-size:11px;font-weight:600;cursor:pointer;transition:all .15s;white-space:nowrap;}
.sync-refresh:hover{background:rgba(255,255,255,.25);color:#fff;}

/* ════════════════════════════════════════
   KPI CARDS
   ════════════════════════════════════════ */
.krow{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:14px;}
.kcard{background:var(--card);border:1.5px solid var(--border);border-radius:var(--r);padding:14px 16px;position:relative;overflow:hidden;box-shadow:var(--sh);cursor:pointer;transition:box-shadow .15s,transform .12s;-webkit-user-select:none;user-select:none;}
.kcard:hover{box-shadow:var(--shm);transform:translateY(-1px);}
.kcard:active{transform:scale(.98);}
.kcard::before{content:'';position:absolute;top:0;left:0;right:0;height:4px;}
.kcard.total::before{background:var(--yellow);}
.kcard.paid::before{background:var(--green);}
.kcard.out::before{background:var(--red);}
.kcard.cnt::before{background:var(--border-s);}
.kcard.cnt{cursor:default;}
.kcard.cnt:hover{box-shadow:var(--sh);transform:none;}
.kcard.cnt:active{transform:none;}
.klbl{font-size:9px;text-transform:uppercase;letter-spacing:1.5px;color:var(--text-dim);font-weight:700;margin-bottom:4px;}
.kval{font-family:'Barlow Condensed',sans-serif;font-size:28px;font-weight:900;line-height:1;}
.kcard.total .kval{color:var(--yellow-dark);}
.kcard.paid .kval{color:var(--green);}
.kcard.out .kval{color:var(--red);}
.ksub{font-size:10px;color:var(--text-dim);margin-top:3px;}
.klink{font-size:9px;color:var(--green);font-weight:700;margin-top:4px;text-decoration:underline;}
.ktrend{font-size:10px;font-weight:700;margin-top:3px;}
.ktrend.up{color:var(--green-bright);}
.ktrend.dn{color:var(--red);}
.pbtrack{height:4px;background:var(--bg);border-radius:3px;overflow:hidden;margin-top:7px;border:1px solid var(--border);}
.pbfill{height:100%;border-radius:3px;background:linear-gradient(90deg,var(--green),var(--green-bright));transition:width .8s;}

/* ════════════════════════════════════════
   DRILL PANEL
   ════════════════════════════════════════ */
.drill-panel{display:none;background:var(--card);border:1.5px solid var(--border);border-radius:var(--r);padding:16px;box-shadow:var(--sh);margin-bottom:14px;animation:slideDown .2s ease;}
.drill-panel.open{display:block;}
@keyframes slideDown{from{opacity:0;transform:translateY(-6px);}to{opacity:1;transform:translateY(0);}}
.drill-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;gap:10px;}
.drill-title{font-family:'Barlow Condensed',sans-serif;font-size:16px;font-weight:900;text-transform:uppercase;letter-spacing:.5px;line-height:1.2;}
.drill-close{background:var(--bg);border:1.5px solid var(--border);color:var(--text-dim);width:28px;height:28px;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:15px;flex-shrink:0;}

/* ════════════════════════════════════════
   PANELS & TWO-COL
   ════════════════════════════════════════ */
.panel{background:var(--card);border:1.5px solid var(--border);border-radius:var(--r);padding:16px;box-shadow:var(--sh);margin-bottom:14px;}
.twocol{display:grid;grid-template-columns:1fr;gap:14px;margin-bottom:14px;}
.ptitle{font-family:'Barlow Condensed',sans-serif;font-size:12px;font-weight:800;text-transform:uppercase;letter-spacing:1px;margin-bottom:12px;color:var(--text-dim);}
.ptitle span{color:var(--text);}

/* ════════════════════════════════════════
   YEAR BARS
   ════════════════════════════════════════ */
.ybargrp{margin-bottom:10px;cursor:pointer;}
.ybargrp:active .btrack{opacity:.8;}
.ybarlbl{display:flex;justify-content:space-between;font-size:11px;margin-bottom:3px;font-weight:600;}
.ybarlbl .yr{color:var(--text-dim);}
.btrack{height:22px;background:var(--bg);border-radius:4px;overflow:hidden;border:1px solid var(--border);}
.bfill{height:100%;border-radius:4px;transition:width .9s cubic-bezier(.4,0,.2,1);display:flex;align-items:center;padding-left:8px;font-size:10px;font-weight:700;}
.bfill.cur{background:var(--yellow);color:var(--green);}
.bfill.prev{background:var(--green);color:rgba(255,255,255,.85);}

/* ════════════════════════════════════════
   TIER LIST
   ════════════════════════════════════════ */
.tlist{display:flex;flex-direction:column;gap:6px;}
.trow{display:flex;align-items:center;gap:8px;padding:9px 10px;background:var(--bg);border-radius:6px;cursor:pointer;transition:all .15s;border:1.5px solid transparent;touch-action:pan-y;}
.trow:hover,.trow:active{background:var(--green-light);border-color:var(--border-s);}
.tdot{width:7px;height:7px;border-radius:50%;flex-shrink:0;}
.tdot.diamond{background:var(--td);}
.tdot.gold{background:var(--tg);}
.tdot.silver{background:var(--ts);}
.tdot.bronze{background:var(--tb);}
.tdot.community{background:var(--tc);}
.tdot.custom{background:#6d28d9;}
.tname{font-weight:700;font-size:13px;flex:1;}
.tcnt{font-size:11px;color:var(--text-dim);}
.tamt{font-family:'Barlow Condensed',sans-serif;font-weight:900;font-size:14px;}

/* ════════════════════════════════════════
   TABLE (mobile: card-style rows)
   ════════════════════════════════════════ */
.toolbar{display:flex;align-items:center;gap:6px;margin-bottom:10px;overflow-x:auto;scrollbar-width:none;padding-bottom:2px;}
.toolbar::-webkit-scrollbar{display:none;}
.fbtn{padding:5px 11px;border-radius:5px;background:var(--bg);color:var(--text-dim);border:1.5px solid var(--border);font-size:11px;font-weight:700;cursor:pointer;transition:all .15s;text-transform:uppercase;letter-spacing:.4px;white-space:nowrap;flex-shrink:0;}
.fbtn:hover,.fbtn.act{background:var(--green);color:#fff;border-color:var(--green);}
.abtn{margin-left:auto;padding:7px 14px;border-radius:6px;background:var(--yellow);color:var(--green);border:none;font-size:12px;font-weight:900;cursor:pointer;transition:all .15s;text-transform:uppercase;letter-spacing:.4px;font-family:'Barlow Condensed',sans-serif;box-shadow:var(--sh);white-space:nowrap;flex-shrink:0;}
.abtn:hover{background:var(--yellow-mid);}
.abtn:active{transform:scale(.97);}

/* Desktop table */
.stw{overflow-x:auto;-webkit-overflow-scrolling:touch;}
table{width:100%;border-collapse:collapse;font-size:13px;}
thead th{text-align:left;padding:8px 10px;font-size:9px;text-transform:uppercase;letter-spacing:1.2px;color:var(--text-dim);font-weight:700;border-bottom:2px solid var(--border);white-space:nowrap;}
th.sortable{cursor:pointer;user-select:none;}
th.sortable:hover{color:var(--text);background:var(--bg);}
th.sortable.sort-act{color:var(--green);}
.sort-arrow{font-size:10px;margin-left:2px;opacity:.5;}
th.sort-act .sort-arrow{opacity:1;color:var(--green);}
tbody tr{border-bottom:1px solid var(--border);cursor:pointer;transition:background .1s;}
tbody tr:hover{background:var(--green-light);}
td{padding:10px 10px;vertical-align:middle;}

/* Mobile sponsor cards */
.sponsor-cards{display:none;flex-direction:column;gap:8px;}
.scard{background:var(--card);border:1.5px solid var(--border);border-radius:9px;padding:14px;cursor:pointer;transition:all .15s;box-shadow:var(--sh);}
.scard:hover{border-color:var(--border-s);box-shadow:var(--shm);}
.scard:active{transform:scale(.99);}
.scard-top{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:8px;gap:8px;}
.scard-name{font-weight:700;font-size:15px;line-height:1.2;}
.scard-amount{font-family:'Barlow Condensed',sans-serif;font-weight:900;font-size:18px;color:var(--text);text-align:right;flex-shrink:0;}
.scard-recv{font-size:10px;color:var(--orange);text-align:right;}
.scard-meta{display:flex;align-items:center;gap:6px;flex-wrap:wrap;}
.scard-edit{margin-left:auto;padding:5px 10px;border-radius:5px;background:var(--bg);border:1.5px solid var(--border);color:var(--text-dim);font-size:11px;font-weight:700;cursor:pointer;}

/* Badges */
.sbadge{display:inline-block;padding:2px 7px;border-radius:20px;font-size:9px;font-weight:800;text-transform:uppercase;letter-spacing:.4px;}
.sbadge.paid{background:var(--green-light);color:var(--green);}
.sbadge.outstanding{background:var(--red-light);color:var(--red);}
.sbadge.partial{background:var(--orange-light);color:var(--orange);}
.sbadge.inkind{background:#f0e6ff;color:#6d28d9;}
.tchip{display:inline-flex;align-items:center;padding:2px 6px;border-radius:4px;font-size:10px;font-weight:700;}
.tchip.diamond{background:var(--tdb);color:var(--td);}
.tchip.gold{background:var(--tgb);color:var(--tg);}
.tchip.silver{background:var(--tsb);color:var(--ts);}
.tchip.bronze{background:var(--tbb);color:var(--tb);}
.tchip.community{background:var(--tcb);color:var(--tc);}
.tchip.custom{background:#f3e8ff;color:#6d28d9;}
.cbadge{display:inline-flex;align-items:center;gap:3px;background:var(--yellow-pale);border:1.5px solid var(--yellow-dark);color:var(--yellow-dark);font-size:9px;font-weight:800;padding:1px 6px;border-radius:10px;}
.actbtn{background:var(--bg);border:1.5px solid var(--border);color:var(--text);padding:3px 9px;border-radius:4px;font-size:11px;cursor:pointer;font-weight:700;transition:all .15s;}
.actbtn:hover{background:var(--green);color:#fff;border-color:var(--green);}

.empty{text-align:center;padding:40px 16px;color:var(--text-dim);}
.empty .icon{font-size:32px;margin-bottom:8px;}
.empty h3{font-size:14px;color:var(--text);margin-bottom:4px;}

/* ════════════════════════════════════════
   DETAIL VIEW
   ════════════════════════════════════════ */
.detailview{display:none;}
.detailview.open{display:block;}
.mainview.h{display:none;}
.backbtn{display:inline-flex;align-items:center;gap:6px;background:var(--green-light);border:1.5px solid var(--border-s);color:var(--green);font-size:12px;font-weight:700;cursor:pointer;margin-bottom:14px;padding:8px 13px;border-radius:6px;text-transform:uppercase;letter-spacing:.5px;}
.backbtn:active{transform:scale(.97);}
.dheader{display:flex;align-items:flex-start;gap:14px;margin-bottom:16px;flex-wrap:wrap;}
.dlogo{width:56px;height:56px;border-radius:8px;background:var(--yellow-pale);display:flex;align-items:center;justify-content:center;font-family:'Barlow Condensed',sans-serif;font-size:20px;font-weight:900;color:var(--yellow-dark);flex-shrink:0;border:2px solid var(--yellow-dark);}
.dinfo{flex:1;min-width:0;}
.dinfo h2{font-family:'Barlow Condensed',sans-serif;font-size:24px;font-weight:900;line-height:1;text-transform:uppercase;}
.dmeta{display:flex;gap:6px;margin-top:6px;flex-wrap:wrap;}
.dkpis{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:13px;}
.dkpi{background:var(--bg);border:1.5px solid var(--border);border-radius:8px;padding:12px 13px;}
.ystrip{display:flex;gap:5px;flex-wrap:wrap;margin-bottom:13px;}
.ypill{display:flex;align-items:center;gap:4px;background:var(--bg);border:1.5px solid var(--border);border-radius:4px;padding:4px 8px;font-size:10px;font-weight:700;color:var(--text-dim);}
.ypill.has{border-color:var(--green);color:var(--green);background:var(--green-light);}
.ydot{width:5px;height:5px;border-radius:50%;background:var(--border-s);}
.ypill.has .ydot{background:var(--green);}
.alog{background:var(--bg);border:1.5px solid var(--border);border-radius:8px;padding:14px;margin-bottom:13px;}
.alog h3{font-size:9px;text-transform:uppercase;letter-spacing:1.2px;color:var(--text-dim);margin-bottom:10px;font-weight:700;}
.aentry{display:flex;align-items:flex-start;gap:8px;padding:6px 0;border-bottom:1px solid var(--border);}
.aentry:last-child{border-bottom:none;}
.adot{width:7px;height:7px;border-radius:50%;flex-shrink:0;margin-top:4px;}
.adot.edit{background:var(--yellow-dark);}
.adot.del{background:var(--red);}
.adot.add{background:var(--green);}
.aact{font-size:12px;font-weight:600;line-height:1.4;}
.amet{font-size:10px;color:var(--text-dim);margin-top:1px;}
.aempty{font-size:12px;color:var(--text-dim);font-style:italic;}

/* ════════════════════════════════════════
   MODALS
   ════════════════════════════════════════ */
.moverlay{
  display:none;position:fixed;inset:0;z-index:200;
  background:rgba(0,0,0,.5);
  align-items:flex-end;justify-content:center;
  padding:0;
}
.moverlay.open{display:flex;}
.modal{
  background:var(--card);border:1.5px solid var(--border);
  border-radius:16px 16px 0 0;
  width:100%;max-width:100%;
  padding:20px 20px calc(20px + var(--safe-bottom));
  position:relative;max-height:92vh;overflow-y:auto;
  animation:slideUp .25s cubic-bezier(.4,0,.2,1);
}
@keyframes slideUp{from{transform:translateY(100%);}to{transform:translateY(0);}}
.modal-handle{width:36px;height:4px;background:var(--border-s);border-radius:2px;margin:0 auto 16px;display:block;}
.mclose{position:absolute;top:16px;right:16px;background:var(--bg);border:1px solid var(--border);color:var(--text);width:30px;height:30px;border-radius:50%;font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center;}
.mtitle{font-family:'Barlow Condensed',sans-serif;font-size:20px;font-weight:900;margin-bottom:2px;text-transform:uppercase;}
.msub{color:var(--text-dim);font-size:12px;margin-bottom:16px;line-height:1.4;}
.frow{display:grid;grid-template-columns:1fr;gap:10px;margin-bottom:10px;}
.frow.two{grid-template-columns:1fr 1fr;}
.frow.full{grid-template-columns:1fr;}
.fg{display:flex;flex-direction:column;gap:4px;}
.fg label{font-size:10px;text-transform:uppercase;letter-spacing:1px;color:var(--text-dim);font-weight:700;}
.fg input,.fg select,.fg textarea{background:#f7faf7;border:1.5px solid var(--border);color:var(--text);padding:11px 12px;border-radius:7px;font-size:15px;font-family:'Barlow',sans-serif;transition:border-color .15s;width:100%;-webkit-appearance:none;}
.fg input:focus,.fg select:focus,.fg textarea:focus{outline:none;border-color:var(--green);background:#fff;}
.fg textarea{resize:vertical;min-height:70px;}
.mactions{display:flex;gap:8px;margin-top:16px;flex-wrap:wrap;}
.mprimary{flex:1;padding:13px;background:var(--green);color:#fff;border:none;border-radius:8px;font-size:15px;font-weight:900;cursor:pointer;font-family:'Barlow Condensed',sans-serif;text-transform:uppercase;letter-spacing:.5px;min-width:120px;transition:opacity .15s;}
.mprimary:disabled{opacity:.6;cursor:not-allowed;}
.mprimary.btn-loading{position:relative;color:transparent !important;pointer-events:none;}
.mprimary.btn-loading::after{content:'';position:absolute;top:50%;left:50%;width:18px;height:18px;margin:-9px 0 0 -9px;border:2.5px solid rgba(255,255,255,.35);border-top-color:#fff;border-radius:50%;animation:spin .7s linear infinite;}
.mdanger.btn-loading{position:relative;color:transparent !important;pointer-events:none;opacity:.7;}
.mdanger.btn-loading::after{content:'';position:absolute;top:50%;left:50%;width:16px;height:16px;margin:-8px 0 0 -8px;border:2.5px solid rgba(180,0,0,.3);border-top-color:var(--red);border-radius:50%;animation:spin .7s linear infinite;}
.mprimary:active{transform:scale(.97);}
.msecondary{padding:13px 16px;background:var(--bg);color:var(--text-dim);border:1.5px solid var(--border);border-radius:8px;font-size:13px;cursor:pointer;font-weight:600;}
.mdanger{padding:13px 14px;background:var(--red-light);color:var(--red);border:1.5px solid #f5c6c2;border-radius:8px;font-size:13px;cursor:pointer;font-weight:700;}

/* Copy from prev */
.copy-prev-wrap{background:var(--green-light);border:1.5px solid var(--border-s);border-radius:8px;padding:11px 13px;margin-bottom:12px;}
.copy-prev-wrap label{font-size:10px;text-transform:uppercase;letter-spacing:1px;color:var(--green);font-weight:800;display:block;margin-bottom:6px;}
.copy-prev-row{display:flex;gap:8px;align-items:center;}
.copy-prev-row select{flex:1;background:#fff;border:1.5px solid var(--border-s);color:var(--text);padding:9px 10px;border-radius:6px;font-size:13px;font-family:'Barlow',sans-serif;-webkit-appearance:none;}
.cbtn{padding:9px 12px;background:var(--green);color:#fff;border:none;border-radius:6px;font-size:12px;font-weight:800;cursor:pointer;font-family:'Barlow Condensed',sans-serif;text-transform:uppercase;white-space:nowrap;}

/* Season mini modal */
.smodal-inner{background:var(--card);border-radius:14px;padding:24px;width:100%;max-width:360px;box-shadow:var(--shm);border:1.5px solid var(--border);margin:auto;}
#season-modal .moverlay-center{align-items:center;}

/* ════════════════════════════════════════
   ACCESS LOG
   ════════════════════════════════════════ */
.atable{width:100%;border-collapse:collapse;font-size:12px;}
.atable th{text-align:left;padding:8px 9px;font-size:9px;text-transform:uppercase;letter-spacing:1.2px;color:var(--text-dim);font-weight:700;border-bottom:2px solid var(--border);}
.atable td{padding:8px 9px;border-bottom:1px solid var(--border);}
.atable tr:last-child td{border-bottom:none;}

/* ════════════════════════════════════════
   USER MANAGEMENT
   ════════════════════════════════════════ */
.user-grid{display:grid;grid-template-columns:1fr;gap:10px;margin-bottom:14px;}
.ucard{background:var(--card);border:1.5px solid var(--border);border-radius:var(--r);padding:14px;box-shadow:var(--sh);}
.ucard-head{display:flex;align-items:center;gap:10px;margin-bottom:9px;}
.ucard-av{width:38px;height:38px;border-radius:50%;background:var(--green);display:flex;align-items:center;justify-content:center;font-family:'Barlow Condensed',sans-serif;font-weight:900;font-size:15px;color:var(--yellow);flex-shrink:0;overflow:hidden;}
.ucard-av img{width:100%;height:100%;object-fit:cover;}
.ucard-name{font-weight:700;font-size:14px;}
.ucard-role{font-size:11px;color:var(--text-dim);}
.ucard-badges{display:flex;gap:5px;margin-bottom:9px;flex-wrap:wrap;}
.ubadge{font-size:9px;font-weight:800;padding:2px 7px;border-radius:10px;text-transform:uppercase;letter-spacing:.4px;}
.ubadge.admin{background:var(--yellow-pale);color:var(--yellow-dark);border:1px solid var(--yellow-dark);}
.ubadge.edit{background:var(--green-light);color:var(--green);border:1px solid var(--border-s);}
.ubadge.view{background:var(--bg);color:var(--text-dim);border:1px solid var(--border);}
.ucard-actions{display:flex;gap:6px;flex-wrap:wrap;}
.uact-btn{padding:6px 10px;border-radius:5px;font-size:11px;font-weight:700;cursor:pointer;border:1.5px solid var(--border);background:var(--bg);color:var(--text-mid);transition:all .15s;}
.uact-btn:hover{background:var(--green);color:#fff;border-color:var(--green);}

/* Profile */
.profile-av-row{display:flex;align-items:center;gap:12px;margin-bottom:14px;}
.profile-av{width:52px;height:52px;border-radius:50%;background:var(--green);display:flex;align-items:center;justify-content:center;font-family:'Barlow Condensed',sans-serif;font-weight:900;font-size:20px;color:var(--yellow);overflow:hidden;}
.profile-av img{width:100%;height:100%;object-fit:cover;}
.profile-info strong{font-size:15px;display:block;}
.profile-info span{font-size:12px;color:var(--text-dim);}
.profile-badges{display:flex;gap:5px;margin-top:4px;flex-wrap:wrap;}
.profile-sec{margin-bottom:18px;padding-bottom:18px;border-bottom:1px solid var(--border);}
.profile-sec:last-child{border-bottom:none;margin-bottom:0;padding-bottom:0;}
.profile-sec h3{font-family:'Barlow Condensed',sans-serif;font-size:14px;font-weight:800;text-transform:uppercase;letter-spacing:.4px;color:var(--text);margin-bottom:11px;}
.msg-ok{background:var(--green-light);border:1px solid var(--border-s);color:var(--green);padding:7px 10px;border-radius:6px;font-size:12px;font-weight:600;margin-top:7px;display:none;}
.msg-err{background:var(--red-light);border:1px solid #f5c6c2;color:var(--red);padding:7px 10px;border-radius:6px;font-size:12px;font-weight:600;margin-top:7px;display:none;}

/* ════════════════════════════════════════
   TOAST
   ════════════════════════════════════════ */
.toast{
  position:fixed;bottom:calc(20px + var(--safe-bottom));left:50%;
  transform:translateX(-50%) translateY(80px);
  z-index:400;background:var(--green);color:#fff;
  padding:11px 20px;border-radius:24px;
  font-weight:800;font-size:13px;
  opacity:0;transition:all .3s;
  font-family:'Barlow Condensed',sans-serif;text-transform:uppercase;
  letter-spacing:.5px;box-shadow:var(--shm);white-space:nowrap;
}
.toast.show{transform:translateX(-50%) translateY(0);opacity:1;}
.toast.warn{background:var(--orange);}
.toast.err{background:var(--red);}

/* ════════════════════════════════════════
   RESPONSIVE — TABLET (600px+)
   ════════════════════════════════════════ */
@media(min-width:600px){
  main{padding:20px 24px;max-width:1200px;margin:0 auto;}
  header{height:60px;padding:0 24px;}
  .logo-text small{display:block;}
  .krow{grid-template-columns:repeat(4,1fr);}
  .kval{font-size:30px;}
  .stitle{font-size:26px;}
  .frow{grid-template-columns:1fr 1fr;}
  .frow.full{grid-template-columns:1fr;}
  .moverlay{align-items:center;padding:20px;}
  .modal{border-radius:14px;max-width:560px;animation:modalIn .2s ease;padding:24px;}
  @keyframes modalIn{from{opacity:0;transform:scale(.95);}to{opacity:1;transform:scale(1);}}
  .modal-handle{display:none;}
  .stw table{display:table;}
  .sponsor-cards{display:none!important;}
  .user-grid{grid-template-columns:repeat(auto-fill,minmax(260px,1fr));}
  .twocol{grid-template-columns:1fr 280px;}
}

/* ════════════════════════════════════════
   RESPONSIVE — DESKTOP (960px+)
   ════════════════════════════════════════ */
@media(min-width:960px){
  main{padding:22px 28px;max-width:1200px;margin:0 auto;}
  header{padding:0 28px;}
  .logo-text h1{font-size:17px;}
  .kval{font-size:33px;}
  .stitle{font-size:28px;}
  .twocol{grid-template-columns:1fr 295px;}
}

/* ════════════════════════════════════════
   MOBILE: hide table, show cards
   ════════════════════════════════════════ */
@media(max-width:599px){
  .stw table{display:none;}
  .sponsor-cards{display:flex;}
  .dkpis{grid-template-columns:1fr 1fr 1fr;}
  .dkpi{padding:10px 11px;}
  .dinfo h2{font-size:20px;}
}


/* ── Package manager rows ── */
.pkg-row{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;padding:14px;background:var(--bg);border:1.5px solid var(--border);border-radius:9px;}
input:disabled,select:disabled{background:var(--bg);color:var(--text-dim);cursor:not-allowed;opacity:.7;}
.emoji-pick{background:var(--bg);border:1.5px solid var(--border);border-radius:6px;cursor:pointer;font-size:18px;padding:3px 5px;line-height:1;transition:border-color .15s;}
.emoji-pick:hover{border-color:var(--green);background:var(--green-light);}


.ss-checklist{background:var(--bg);border:1.5px solid var(--border);border-radius:9px;padding:12px 14px;margin-bottom:10px;}
.ss-checklist-title{font-size:9px;text-transform:uppercase;letter-spacing:1.2px;color:var(--text-dim);font-weight:700;margin-bottom:10px;}
.ss-checks{display:grid;grid-template-columns:1fr 1fr;gap:8px;}
@media(max-width:420px){.ss-checks{grid-template-columns:1fr;}}
.ss-check{display:flex;align-items:center;gap:8px;cursor:pointer;font-size:13px;font-weight:500;color:var(--text-mid);user-select:none;}
.ss-check input{position:absolute;opacity:0;width:0;height:0;}
.ss-check-box{width:20px;height:20px;border-radius:5px;border:2px solid var(--border-s);background:#fff;flex-shrink:0;display:flex;align-items:center;justify-content:center;transition:all .15s;}
.ss-check input:checked ~ .ss-check-box{background:var(--green);border-color:var(--green);}
.ss-check input:checked ~ .ss-check-box::after{content:'✓';color:#fff;font-size:12px;font-weight:900;line-height:1;}
.ss-check:hover .ss-check-box{border-color:var(--green);}

/* ── Checklist badges on ss-row ── */
.chk-badge{display:inline-flex;align-items:center;gap:3px;font-size:9px;font-weight:700;padding:2px 6px;border-radius:10px;background:var(--green-light);color:var(--green);}
.chk-badge.miss{background:#fef2f2;color:#b91c1c;}


.ss-row{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:11px 14px;background:var(--bg);border:1.5px solid var(--border);border-radius:9px;cursor:pointer;transition:all .15s;}
.ss-row:hover{border-color:var(--green);background:var(--green-light);}
.ss-add-btn{background:var(--green);color:#fff;border:none;border-radius:7px;padding:7px 14px;font-size:12px;font-weight:700;cursor:pointer;font-family:'Barlow Condensed',sans-serif;text-transform:uppercase;letter-spacing:.5px;transition:opacity .15s;white-space:nowrap;flex-shrink:0;}
.ss-add-btn:hover{opacity:.85;}

/* ── NEW: Prospect / org status badges ── */
.ostatus{display:inline-block;padding:2px 8px;border-radius:20px;font-size:9px;font-weight:800;text-transform:uppercase;letter-spacing:.5px;}
.ostatus.active{background:var(--green-light);color:var(--green);}
.ostatus.prospect{background:#fef9e6;color:#b45309;}
.ostatus.lapsed{background:#f3f4f6;color:#6b7280;}

/* ── Contact log ── */
.clog-entry{display:flex;gap:10px;padding:10px 0;border-bottom:1px solid var(--border);}
.clog-entry:last-child{border-bottom:none;}
.clog-dot{width:8px;height:8px;border-radius:50%;background:var(--green);flex-shrink:0;margin-top:5px;}
.clog-body{flex:1;min-width:0;}
.clog-meta{font-size:10px;color:var(--text-dim);margin-bottom:2px;}
.clog-notes{font-size:13px;color:var(--text-mid);}

/* ── Address fields ── */
.addr-same-wrap{display:flex;align-items:center;gap:8px;margin-top:4px;}
.addr-same-wrap input[type=checkbox]{width:16px;height:16px;accent-color:var(--green);cursor:pointer;}
.addr-same-wrap label{font-size:12px;color:var(--text-dim);cursor:pointer;}

/* ── Two-panel layout for org detail ── */
.org-detail-wrap{display:flex;gap:16px;flex-wrap:wrap;}
.org-detail-main{flex:1;min-width:260px;}
.org-detail-side{width:280px;flex-shrink:0;}
@media(max-width:640px){.org-detail-side{width:100%;}}

/* ── Season pills on org card ── */
.season-pill{display:inline-flex;align-items:center;gap:5px;background:var(--bg);border:1.5px solid var(--border);border-radius:20px;padding:3px 10px;font-size:11px;cursor:pointer;transition:all .15s;}
.season-pill:hover{border-color:var(--green);background:var(--green-light);}
.season-pill .sp-tier{font-weight:800;}
.season-pill .sp-yr{color:var(--text-dim);}

/* ── Add season to org button ── */
.add-season-pill{display:inline-flex;align-items:center;gap:4px;background:var(--yellow-pale);border:1.5px dashed var(--yellow-dark);border-radius:20px;padding:3px 10px;font-size:11px;cursor:pointer;color:var(--yellow-dark);font-weight:700;transition:all .15s;}
.add-season-pill:hover{background:var(--yellow-mid);}

/* ── Tabs for sponsor view: Active | Prospects ── */
.view-tabs{display:flex;gap:6px;margin-bottom:14px;}
.vtab{padding:6px 14px;border-radius:20px;font-size:12px;font-weight:700;border:1.5px solid var(--border);background:var(--card);cursor:pointer;transition:all .15s;font-family:"Barlow Condensed",sans-serif;text-transform:uppercase;letter-spacing:.5px;}
.vtab.act{background:var(--green);color:#fff;border-color:var(--green);}
.vtab.prospect-tab.act{background:#b45309;border-color:#b45309;}


/* ── PLAYER MODULE ── */
.pl-tab{padding:10px 16px;background:transparent;border:none;border-bottom:3px solid transparent;font-size:12px;font-weight:700;cursor:pointer;font-family:'Barlow Condensed',sans-serif;text-transform:uppercase;letter-spacing:.5px;color:var(--text-dim);white-space:nowrap;transition:all .15s;}
.pl-tab:hover{color:var(--text);background:var(--green-light);}
.pl-tab.act{color:var(--green);border-bottom-color:var(--green);background:#fff;}
.pl-kpi-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:20px;}
@media(max-width:600px){.pl-kpi-grid{grid-template-columns:repeat(2,1fr);}}
.pl-kpi{background:var(--card);border:1.5px solid var(--border);border-radius:11px;padding:14px 16px;}
.pl-kpi-label{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--text-dim);margin-bottom:4px;}
.pl-kpi-val{font-size:28px;font-weight:900;font-family:'Barlow Condensed',sans-serif;color:var(--green);}
.pl-kpi-sub{font-size:11px;color:var(--text-dim);margin-top:2px;}
.ag-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:10px;margin-bottom:20px;}
.ag-card{border-radius:10px;padding:14px;cursor:pointer;border:2px solid transparent;transition:all .15s;position:relative;}
.ag-card.green{background:#dcfce7;border-color:#16a34a;}
.ag-card.amber{background:#fef9c3;border-color:#ca8a04;}
.ag-card.red{background:#fee2e2;border-color:#dc2626;}
.ag-card.grey{background:var(--bg);border-color:var(--border);}
.ag-card:hover{transform:translateY(-1px);box-shadow:var(--shm);}
.ag-label{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--text-dim);}
.ag-count{font-size:32px;font-weight:900;font-family:'Barlow Condensed',sans-serif;line-height:1;}
.ag-bar-wrap{height:6px;background:rgba(0,0,0,.08);border-radius:3px;margin:8px 0 4px;}
.ag-bar-fill{height:100%;border-radius:3px;transition:width .4s;}
.ag-meta{font-size:10px;color:var(--text-dim);}
.ag-disp{position:absolute;top:6px;right:8px;font-size:9px;font-weight:700;color:#7c3aed;background:#ede9fe;border-radius:4px;padding:1px 5px;}
.pl-table{width:100%;border-collapse:collapse;font-size:13px;}
.pl-table th{text-align:left;font-size:9px;text-transform:uppercase;letter-spacing:1px;color:var(--text-dim);font-weight:700;padding:6px 8px;border-bottom:2px solid var(--border);}
.pl-table td{padding:9px 8px;border-bottom:1px solid var(--border);vertical-align:middle;}
.pl-table tbody tr{cursor:pointer;transition:background .12s;}
.pl-table tbody tr:hover{background:var(--green-light);}
.disp-tag{background:#ede9fe;color:#7c3aed;font-size:9px;font-weight:700;border-radius:4px;padding:1px 6px;text-transform:uppercase;letter-spacing:.3px;}
.pl-avatar{width:32px;height:32px;border-radius:50%;overflow:hidden;background:var(--green-light);display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:900;color:var(--green);font-family:'Barlow Condensed',sans-serif;flex-shrink:0;}
.pl-avatar img{width:100%;height:100%;object-fit:cover;}
.pl-search{width:100%;padding:9px 12px 9px 34px;border:1.5px solid var(--border);border-radius:8px;font-size:13px;background:var(--card) url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='14' height='14' viewBox='0 0 24 24' fill='none' stroke='%236b7a6b' stroke-width='2'%3E%3Ccircle cx='11' cy='11' r='8'/%3E%3Cpath d='m21 21-4.35-4.35'/%3E%3C/svg%3E") no-repeat 10px center;margin-bottom:12px;}
.pl-search:focus{outline:none;border-color:var(--green);}
.school-bar-row{display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--border);}
.school-bar-track{flex:1;height:8px;background:var(--bg);border-radius:4px;overflow:hidden;}
.school-bar-fill{height:100%;background:var(--green);border-radius:4px;transition:width .4s;}
.import-drop{border:2px dashed var(--border);border-radius:12px;padding:32px;text-align:center;cursor:pointer;transition:all .2s;background:var(--bg);}
.import-drop.drag{border-color:var(--green);background:var(--green-light);}
.lapsed-row{display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:1px solid var(--border);}

/* ── HEADER MOBILE ── */
@media(max-width:640px){
  header{flex-wrap:wrap;padding:8px 12px;gap:6px;}
  .logo-area{flex:1;min-width:0;}
  /* hright drops to its own full-width row */
  .hright{
    width:100%;
    flex-wrap:wrap;
    gap:4px;
    justify-content:flex-end;
  }
  /* Hide name in user pill - just show avatar circle */
  #user-name{display:none!important;}
  .user-pill{padding:3px 7px 3px 4px;}
  /* Compact buttons */
  .hnav-btn{padding:4px 8px;font-size:10px;letter-spacing:0;}
  #sync-state{display:none;}
  .sync-refresh{padding:4px 8px;font-size:10px;}
  .lobtn{padding:4px 8px;font-size:10px;}
}
@media(max-width:380px){
  .logo-text small{display:none;}
  .logo-badge{width:30px;height:30px;font-size:11px;}
  .logo-text h1{font-size:16px;}
  .hnav-btn{padding:3px 6px;font-size:9px;}
}
/* Table: hide contact column on mobile, allow horizontal scroll */
@media(max-width:600px){
  .stable-wrap{overflow-x:auto;-webkit-overflow-scrolling:touch;}
  .stable{min-width:480px;}
  .col-contact{display:none;}
}
.season-head{display:flex;align-items:center;margin-bottom:16px;gap:8px;flex-wrap:wrap;width:100%;}
.sadd{background:rgba(255,255,255,.15);border:1.5px solid rgba(255,255,255,.3);color:#fff;padding:5px 12px;border-radius:6px;font-size:11px;font-weight:700;cursor:pointer;white-space:nowrap;transition:all .15s;font-family:'Barlow Condensed',sans-serif;text-transform:uppercase;letter-spacing:.5px;}
.sadd:hover{background:rgba(255,255,255,.25);}
.kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:16px;}
@media(max-width:700px){.kpis{grid-template-columns:repeat(2,1fr);}}
.filters{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px;}
.ftab{padding:5px 12px;border-radius:20px;font-size:11px;font-weight:700;border:1.5px solid var(--border);background:var(--card);cursor:pointer;transition:all .15s;font-family:'Barlow Condensed',sans-serif;text-transform:uppercase;letter-spacing:.5px;white-space:nowrap;}
.ftab.act{background:var(--green);color:#fff;border-color:var(--green);}
.mid-row{display:flex;gap:16px;align-items:flex-start;margin-bottom:16px;}
.mid-left{flex:1;min-width:0;margin-bottom:0!important;}
.mid-right{width:260px;flex-shrink:0;margin-bottom:0!important;}
@media(max-width:800px){.mid-row{flex-direction:column;}.mid-right{width:100%;}.mid-left{width:100%;min-width:0;}}
.panel-title{font-family:'Barlow Condensed',sans-serif;font-size:14px;font-weight:800;text-transform:uppercase;letter-spacing:1px;color:var(--text);margin-bottom:10px;}
.side-panel{position:fixed;top:0;right:-420px;width:min(420px,100vw);height:100vh;background:var(--card);box-shadow:-4px 0 24px rgba(0,0,0,.13);z-index:200;transition:right .3s cubic-bezier(.4,0,.2,1),z-index 0s;display:flex;flex-direction:column;overflow:hidden;}
.side-panel.open{right:0;}
.spclose{position:absolute;top:14px;right:16px;background:var(--bg);border:1.5px solid var(--border);border-radius:50%;width:32px;height:32px;font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;z-index:1;}
.sp-title{font-family:'Barlow Condensed',sans-serif;font-size:16px;font-weight:800;text-transform:uppercase;padding:16px 48px 0 16px;letter-spacing:.5px;}
.stable{width:100%;border-collapse:collapse;font-size:13px;}
.stable th{text-align:left;font-size:9px;text-transform:uppercase;letter-spacing:1.2px;color:var(--text-dim);font-weight:700;padding:6px 8px;border-bottom:2px solid var(--border);}
.stable td{padding:10px 8px;border-bottom:1px solid var(--border);vertical-align:middle;}
.stable tr:last-child td{border-bottom:none;}
.stable tbody tr{cursor:pointer;transition:background .12s;}
.stable tbody tr:hover{background:var(--green-light);}
#sync-state,.sync-ok,.sync-loading,.sync-err{font-size:11px;font-weight:600;padding:3px 8px;border-radius:20px;white-space:nowrap;}
.sync-ok{background:var(--green-light);color:var(--green);}
.sync-loading{background:var(--yellow-pale);color:var(--yellow-dark);}
.sync-err{background:var(--red-light);color:var(--red);}

/* ── Admin modal tabs ── */
.adm-tabs{display:flex;gap:4px;padding-bottom:12px;border-bottom:1.5px solid var(--border);flex-wrap:wrap;}
.adm-tab{padding:6px 14px;border-radius:6px;font-size:12px;font-weight:700;border:1.5px solid var(--border);background:var(--bg);cursor:pointer;transition:all .15s;font-family:'Barlow Condensed',sans-serif;text-transform:uppercase;letter-spacing:.5px;color:var(--text-dim);}
.adm-tab.act{background:var(--green);color:#fff;border-color:var(--green);}
.adm-tab:hover:not(.act){border-color:var(--green);color:var(--green);}

</style>
</head>
<body>

<!-- LOADING SCREEN -->
<div id="loading-screen">
  <div class="ls-crest">KJFC</div>
  <div class="ls-text">Loading…</div>
  <div class="ls-bar"><div class="ls-bar-fill"></div></div>
</div>

<!-- LOGIN -->
<div id="login-view" style="display:none;min-height:100vh;display:none;align-items:center;justify-content:center;background:var(--green);">
  <div class="lbox" style="background:#fff;border-radius:18px;padding:36px 28px;width:100%;max-width:380px;margin:24px;box-shadow:0 12px 40px rgba(0,0,0,.18);">
    <div style="text-align:center;margin-bottom:28px;">
      <div style="width:64px;height:64px;background:var(--yellow);border-radius:50%;display:flex;align-items:center;justify-content:center;font-family:'Barlow Condensed',sans-serif;font-weight:900;font-size:22px;color:var(--green);margin:0 auto 14px;">KJFC</div>
      <h1 style="font-family:'Barlow Condensed',sans-serif;font-size:22px;font-weight:900;letter-spacing:.5px;text-transform:uppercase;">Executive Dashboard</h1>
      <p style="font-size:13px;color:var(--text-dim);margin-top:4px;">Kinglake Junior Football Club</p>
    </div>
    <!-- Sign in state -->
    <div id="login-signin-area">
      <div id="google-btn-container" style="margin-bottom:12px;"></div>
      <button id="google-sign-in-btn" style="width:100%;padding:12px;background:var(--green);color:#fff;border:none;border-radius:8px;font-size:14px;font-weight:700;cursor:pointer;font-family:'Barlow Condensed',sans-serif;text-transform:uppercase;letter-spacing:.5px;">Sign in with Google</button>
      <div id="lerr" style="color:var(--red);font-size:12px;text-align:center;margin-top:10px;min-height:16px;"></div>
    </div>
    <!-- Signing in... state (shown after Google auth completes) -->
    <div id="login-progress" style="display:none;text-align:center;padding:8px 0 4px;">
      <div style="width:36px;height:36px;border:3px solid var(--border);border-top-color:var(--green);border-radius:50%;animation:spin .8s linear infinite;margin:0 auto 14px;"></div>
      <div style="font-weight:700;font-size:15px;color:var(--text);margin-bottom:4px;">Signing in…</div>
      <div style="font-size:12px;color:var(--text-dim);">Verifying your Google account</div>
    </div>
  </div>
</div>

<!-- MAIN APP -->
<div id="app" style="display:none;">

  <!-- HEADER -->
  <header>
    <div class="logo-area">
      <div class="logo-badge">KJFC</div>
      <div class="logo-text">
        <h1>Kinglake JFC</h1>
        <small>Executive Dashboard</small>
      </div>
    </div>
    <div class="hright">
      <!-- User pill always visible -->
      <div class="user-pill" onclick="openEditMe()" title="My profile" style="flex-shrink:0;">
        <img id="user-pic" src="" style="display:none;">
        <div class="user-pill-init" id="user-init">?</div>
        <span id="user-name"></span>
      </div>
      <!-- Admin nav (admin only) -->
      <!-- Packages visible to all users -->
      <button class="hnav-btn" onclick="openAdminModal('packages')">Packages</button>
      <!-- Admin-only nav -->
      <div id="admin-nav-btns" style="display:none;align-items:center;gap:4px;">
        <button class="hnav-btn" onclick="openAdminModal('log')">Access Log</button>
        <button class="hnav-btn" onclick="openAdminModal('users')">Users</button>
        <button class="hnav-btn" id="players-nav-btn" onclick="openPlayersModal()" style="opacity:0.5;" title="Players — Admin only (beta)">🏉 Players</button>
      </div>
      <!-- Sync + Refresh + Sign Out -->
      <div style="display:flex;align-items:center;gap:4px;margin-left:auto;">
        <div id="sync-state" class="sync-ok">●&nbsp;Synced</div>
        <button class="sync-refresh" onclick="loadAll()"><span class="refresh-icon">↻</span> Refresh</button>
        <button class="lobtn" onclick="doLogout()">Sign Out</button>
      </div>
    </div>
  </header>

  <!-- SEASON BAR -->
  <div class="sbar">
    <div id="season-tabs" class="stabs"></div>
    <button class="sadd" onclick="openSeasonModal()">+ Season</button>
  </div>

  <!-- MAIN -->
  <main>
    <!-- ROW 1: Season title + Add button -->
    <div class="season-head">
      <h2 class="section-title" id="season-span">SPONSORSHIP</h2>
      <button class="actbtn" onclick="openAddOrg()" id="add-sponsor-btn" style="margin-left:auto">+ Add Sponsor</button>
    </div>

    <!-- ROW 2: KPI CARDS (full width, 4 col) -->
    <div class="kpis">
      <div class="kcard" onclick="drillTotal()">
        <div class="klbl">Total Committed</div>
        <div class="kval" id="k-total" style="color:var(--yellow-dark)">$0</div>
        <div class="ksub" id="k-count">0 sponsors</div>
        <div class="ktrend" id="k-trend"></div>
        <div class="klink">View all →</div>
      </div>
      <div class="kcard" onclick="drillPaid()">
        <div class="klbl">Received</div>
        <div class="kval" id="k-paid" style="color:var(--green)">$0</div>
        <div class="ksub" id="k-ppct">0% collected</div>
        <div class="pbtrack"><div class="pbfill" id="k-bar" style="width:0%"></div></div>
        <div class="klink">Paid &amp; partial →</div>
      </div>
      <div class="kcard" onclick="drillOut()">
        <div class="klbl">Outstanding</div>
        <div class="kval" id="k-out" style="color:var(--red)">$0</div>
        <div class="ksub" id="k-outc">0 invoices pending</div>
        <div class="klink">View outstanding →</div>
      </div>
      <div class="kcard" style="cursor:default;">
        <div class="klbl">By Tier</div>
        <div id="tier-mini" style="display:flex;flex-direction:column;gap:5px;margin-top:7px;"></div>
      </div>
    </div>

    <!-- IN-KIND STRIP -->
    <div id="inkind-strip" onclick="drillInKind()" style="display:none;background:var(--card);border:1.5px solid #e9d5ff;border-radius:11px;padding:12px 16px;margin-bottom:16px;align-items:center;gap:12px;cursor:pointer;transition:background .15s;" onmouseenter="this.style.background='#f5f0ff'" onmouseleave="this.style.background='var(--card)'">
      <span style="font-size:18px;">🤝</span>
      <div style="flex:1">
        <div style="font-size:11px;font-weight:700;color:#6d28d9;text-transform:uppercase;letter-spacing:.5px;">In-Kind Sponsors</div>
        <div id="inkind-summary" style="font-size:13px;color:var(--text-mid);"></div>
      </div>
      <span style="font-size:11px;color:#6d28d9;font-weight:600;">View all →</span>
    </div>

    <!-- ROW 3: YOY left + Revenue by Tier right -->
    <div class="mid-row">
      <div class="mid-left panel">
        <div class="panel-title">Year-on-Year <span style="color:var(--green)">Comparison</span> <span style="font-size:10px;font-weight:400;color:var(--text-dim)">(tap to switch season)</span></div>
        <div id="year-bars" style="display:flex;flex-direction:column;gap:8px;margin-top:10px;"></div>
      </div>
      <div class="mid-right panel">
        <div class="panel-title">Revenue <span style="color:var(--green)">by Tier</span></div>
        <div class="tlist" id="tier-list"></div>
      </div>
    </div>

    <!-- ROW 4: Sponsor table — full width -->
    <div class="panel">
      <div class="view-tabs" id="view-tabs">
        <button class="vtab act" onclick="setView('active')" id="vtab-active">Active</button>
        <button class="vtab prospect-tab" onclick="setView('prospect')" id="vtab-prospect">Not in Season</button>
      </div>
      <div class="filters" id="filters" style="margin-bottom:8px;">
        <!-- dynamically rendered by renderFilterTabs() -->
      </div>
      <!-- Search -->
      <div style="margin-bottom:10px;">
        <input type="text" id="sponsor-search" placeholder="🔍  Search sponsors…" oninput="renderTable()" style="width:100%;box-sizing:border-box;padding:8px 12px;border:1.5px solid var(--border);border-radius:7px;font-size:13px;background:var(--bg);color:var(--text);outline:none;transition:border-color .15s;" onfocus="this.style.borderColor='var(--green)'" onblur="this.style.borderColor='var(--border)'">
      </div>
      <div class="stable-wrap">
      <table class="stable" id="stable">
        <thead id="stable-head"><tr>
          <th class="sortable" onclick="sortBy('name')" id="th-name">Sponsor <span class="sort-arrow" id="sa-name"></span></th>
          <th class="sortable" onclick="sortBy('tier')" id="th-tier">Tier <span class="sort-arrow" id="sa-tier"></span></th>
          <th class="sortable" onclick="sortBy('amount')" id="th-amount">Amount <span class="sort-arrow" id="sa-amount"></span></th>
          <th class="sortable" onclick="sortBy('status')" id="th-status">Status <span class="sort-arrow" id="sa-status"></span></th>
          <th class="sortable" onclick="sortBy('yrs')" id="th-yrs">Yrs <span class="sort-arrow" id="sa-yrs"></span></th>
          <th class="col-contact">Contact</th><th></th>
        </tr></thead>
        <tbody id="tbody"></tbody>
      </table>
      </div>
      <div id="tbl-empty" style="display:none;text-align:center;padding:24px;color:var(--text-dim);font-size:13px;">No sponsors for this season yet.</div>
      <div style="margin-top:10px;display:flex;justify-content:flex-end;">
        <button class="actbtn" onclick="exportCSV()" style="font-size:11px;padding:5px 10px;">Export CSV</button>
      </div>
    </div>

    <!-- ROW 5: Prospect pipeline (full width, shown only when prospects exist) -->
    <div class="panel" id="prospect-panel" style="display:none;">
      <div class="panel-title">🎯 Prospect Pipeline</div>
      <div id="prospect-list" style="margin-top:10px;"></div>
    </div>
  </main>



</div><!-- /app -->

<!-- ═══════════════ MODALS ═══════════════ -->

<!-- ORG MODAL (Add/Edit sponsor organisation) -->
<div class="moverlay" id="org-modal">
  <div class="modal" style="max-width:520px;">
    <div class="modal-handle"></div>
    <button class="mclose" id="org-mclose">×</button>
    <div class="mtitle" id="org-m-title">Add Sponsor</div>
    <div class="msub" id="org-m-sub">New sponsor organisation.</div>

    <div class="frow two">
      <div class="fg"><label>Business Name *</label><input type="text" id="of-name" placeholder="Business name" autocomplete="organization"></div>
      <div class="fg"><label>Status</label>
        <select id="of-orgstatus">
          <option value="prospect">Prospect</option>
          <option value="active">Active Sponsor</option>
          <option value="lapsed">Lapsed</option>
        </select>
      </div>
    </div>

    <div class="frow two">
      <div class="fg"><label>Primary Contact Name</label><input type="text" id="of-contact" placeholder="Contact name" autocomplete="name"></div>
      <div class="fg"><label>Contact Email</label><input type="email" id="of-email" placeholder="email@biz.com.au" inputmode="email"></div>
    </div>
    <div class="frow two">
      <div class="fg"><label>Phone</label><input type="text" id="of-phone" placeholder="04xx xxx xxx" inputmode="tel" autocomplete="tel"></div>
      <div class="fg"><label>Website</label><input type="text" id="of-website" placeholder="www.example.com.au" inputmode="url"></div>
    </div>

    <div class="frow full">
      <div class="fg">
        <label>Physical Address</label>
        <input type="text" id="of-physaddr" placeholder="123 Main St, Kinglake VIC 3763" autocomplete="street-address">
      </div>
    </div>
    <div class="frow full">
      <div class="fg">
        <label>Postal Address</label>
        <label class="ss-check" style="margin-bottom:8px;" id="postsame-label">
          <input type="checkbox" id="of-postsame" onchange="togglePostalSame()">
          <span class="ss-check-box"></span>
          <span style="font-size:12px;color:var(--text-dim);">Same as physical address</span>
        </label>
        <input type="text" id="of-postaddr" placeholder="PO Box or postal address" autocomplete="off">
      </div>
    </div>

    <div class="frow full">
      <div class="fg"><label>Notes</label><textarea id="of-notes" placeholder="General notes about this organisation…"></textarea></div>
    </div>
    <div class="mactions">
      <button class="mprimary" id="org-m-save">Add Sponsor</button>
      <button class="msecondary" id="org-m-cancel">Cancel</button>
      <button class="mdanger" id="org-m-del" style="display:none">Delete</button>
    </div>
  </div>
</div>

<!-- SEASON ENTRY MODAL (add/edit a season sponsorship for an org) -->
<div class="moverlay" id="ss-modal">
  <div class="modal" style="max-width:500px;">
    <div class="modal-handle"></div>
    <button class="mclose" id="ss-mclose">×</button>
    <div class="mtitle" id="ss-m-title">Add Season Sponsorship</div>
    <div class="msub" id="ss-m-sub"></div>

    <!-- Row 1: Year + Package selector -->
    <div class="frow two">
      <div class="fg">
        <label>Season *</label>
        <select id="sf-year"></select>
      </div>
      <div class="fg">
        <label>Package *</label>
        <select id="sf-package" onchange="onPackageSelect()">
          <option value="">— Select package —</option>
        </select>
      </div>
    </div>

    <!-- Package details card (populated on select) -->
    <div id="sf-pkg-card" style="display:none;background:var(--green-light);border:1.5px solid var(--border-s);border-radius:9px;padding:10px 14px;margin-bottom:10px;font-size:12px;">
      <div style="font-weight:700;color:var(--green);margin-bottom:3px;" id="sf-pkg-card-name"></div>
      <div style="color:var(--text-dim);" id="sf-pkg-card-benefits"></div>
    </div>

    <!-- Custom package name (shown when "custom" selected) -->
    <div class="frow" id="sf-custom-wrap" style="display:none;">
      <div class="fg">
        <label>Custom Package Name *</label>
        <input type="text" id="sf-custom-name" placeholder="e.g. Naming Rights, Major Partner…">
      </div>
    </div>

    <!-- Row 2: Tier + Amount -->
    <div class="frow two">
      <div class="fg">
        <label>Tier</label>
        <select id="sf-tier">
          <option value="gold">🥇 Gold</option>
          <option value="silver">🥈 Silver</option>
          <option value="bronze">🥉 Bronze</option>
          <option value="community">🤝 Community</option>
          <option value="custom">⭐ Custom</option>
        </select>
      </div>
      <div class="fg" id="sf-amount-wrap">
        <label>Agreed Amount ($) *</label>
        <input type="number" id="sf-amount" placeholder="e.g. 1500" min="0" inputmode="numeric" oninput="updateBalance()">
      </div>
    </div>

    <!-- Row 3: Payment status -->
    <div class="frow two">
      <div class="fg">
        <label>Payment Status *</label>
        <select id="sf-status" onchange="updateSSFields()">
          <option value="">Select status</option>
          <option value="paid">✅ Paid in full</option>
          <option value="outstanding">⏳ Outstanding</option>
          <option value="partial">💛 Partial payment</option>
          <option value="inkind">🤝 In-Kind (no cash)</option>
        </select>
      </div>
      <div class="fg">
        <label>Invoice Number</label>
        <input type="text" id="sf-invoice" placeholder="e.g. INV-2026-001">
      </div>
    </div>

    <!-- Partial payment row -->
    <div class="frow two" id="sf-partial-wrap" style="display:none;">
      <div class="fg">
        <label>Amount Received ($)</label>
        <input type="number" id="sf-paid" placeholder="e.g. 500" min="0" inputmode="numeric" oninput="updateBalance()">
      </div>
      <div class="fg">
        <label>Balance Owing</label>
        <div id="sf-balance" style="padding:11px 12px;background:var(--orange-light);border:1.5px solid #f5c6a0;border-radius:7px;font-size:14px;font-weight:700;color:var(--orange);">—</div>
      </div>
    </div>

    <!-- In-kind description -->
    <div class="frow" id="sf-inkind-wrap" style="display:none;">
      <div class="fg">
        <label>What are they providing? *</label>
        <input type="text" id="sf-inkind-desc" placeholder="e.g. Printing services, catering for finals day…">
      </div>
    </div>

    <!-- Checklist -->
    <div class="ss-checklist">
      <div class="ss-checklist-title">Admin Checklist</div>
      <div class="ss-checks">
        <label class="ss-check"><input type="checkbox" id="chk-invoice"><span class="ss-check-box"></span>Invoice sent</label>
        <label class="ss-check"><input type="checkbox" id="chk-thankyou"><span class="ss-check-box"></span>Thank you email sent</label>
        <label class="ss-check"><input type="checkbox" id="chk-logo"><span class="ss-check-box"></span>Logo on website</label>
        <label class="ss-check"><input type="checkbox" id="chk-top"><span class="ss-check-box"></span>Added to training top</label>
      </div>
    </div>

    <!-- Notes -->
    <div class="frow">
      <div class="fg">
        <label>Notes</label>
        <textarea id="sf-notes" rows="2" placeholder="Any special arrangements, conditions, follow-ups…"></textarea>
      </div>
    </div>

    <div class="mactions">
      <button class="mprimary" id="ss-m-save">Add Sponsorship</button>
      <button class="msecondary" id="ss-m-cancel">Cancel</button>
      <button class="mdanger" id="ss-m-del" style="display:none">Remove Entry</button>
    </div>
  </div>
</div>

<!-- CONTACT LOG MODAL -->
<div class="moverlay" id="cl-modal">
  <div class="modal" style="max-width:400px;">
    <div class="modal-handle"></div>
    <button class="mclose" id="cl-mclose">×</button>
    <div class="mtitle">Log Contact</div>
    <div class="msub" id="cl-m-sub">Record an interaction with this sponsor.</div>
    <div class="frow full">
      <div class="fg"><label>Date</label><input type="date" id="clf-date"></div>
    </div>
    <div class="frow full">
      <div class="fg"><label>Notes *</label><textarea id="clf-notes" placeholder="What was discussed, next steps, outcome…" style="min-height:90px;"></textarea></div>
    </div>
    <div class="mactions">
      <button class="mprimary" id="cl-m-save">Log Contact</button>
      <button class="msecondary" id="cl-m-cancel">Cancel</button>
    </div>
  </div>
</div>

<!-- ORG DETAIL PANEL -->
<div class="moverlay" id="org-detail-overlay" style="align-items:flex-start;padding-top:20px;">
  <div class="modal" style="max-width:680px;max-height:90vh;overflow-y:auto;">
    <div class="modal-handle"></div>
    <button class="mclose" id="od-close">×</button>
    <div id="od-content"></div>
  </div>
</div>

<!-- DRILL DOWN PANEL -->
<div id="drillPanel" class="side-panel">
  <button class="spclose" onclick="closeDrill()">×</button>
  <div class="sp-title" id="drill-title"></div>
  <table class="stable" style="margin-top:10px;font-size:13px;">
    <thead><tr><th>Sponsor</th><th>Tier</th><th>Amount</th><th>Status</th></tr></thead>
    <tbody id="drill-tbody"></tbody>
  </table>
</div>

<!-- SEASON MODAL -->
<div class="moverlay" id="season-modal">
  <div class="smodal-inner">
    <div class="mtitle" style="margin-bottom:12px;">Add Season</div>
    <div class="fg"><label>Year</label><input type="number" id="new-season-yr" min="2020" max="2040" inputmode="numeric"></div>
    <div class="mactions" style="margin-top:14px;">
      <button class="mprimary" onclick="confirmAddSeason()">Add Season</button>
      <button class="msecondary" onclick="closeSeasonModal()">Cancel</button>
    </div>
  </div>
</div>

<!-- RESET MODAL -->
<div class="moverlay" id="reset-modal">
  <div class="smodal-inner">
    <div class="mtitle" style="margin-bottom:8px;">Sign out everywhere?</div>
    <p style="font-size:13px;color:var(--text-dim);margin-bottom:14px;">This will clear your session on this device.</p>
    <div class="mactions">
      <button class="mprimary" onclick="confirmLogout()">Sign Out</button>
      <button class="msecondary" onclick="closeResetModal()">Cancel</button>
    </div>
  </div>
</div>

<!-- USER / EDIT MODAL -->
<div class="moverlay" id="user-modal">
  <div class="modal" style="max-width:420px;">
    <div class="modal-handle"></div>
    <button class="mclose" onclick="closeUserModal()">×</button>
    <div class="mtitle" style="margin-bottom:4px;" id="um-title">Add User</div>
    <div style="margin-bottom:14px;">
      <div class="fg" style="margin-bottom:10px;">
        <label>Email Address *</label>
        <input type="email" id="um-email" placeholder="user@example.com" inputmode="email">
      </div>
      <div class="fg" style="margin-bottom:10px;"><label>Full Name</label><input type="text" id="um-name" placeholder="Full name"></div>
      <div class="fg" style="margin-bottom:10px;"><label>Role</label>
        <select id="um-role"></select>
      </div>
      <div class="fg" id="um-access-row" style="margin-bottom:10px;display:none;">
        <label>Access Level</label>
        <select id="um-access">
          <option value="admin">Admin — Full access</option>
          <option value="edit">Can Edit — Add/edit sponsors</option>
          <option value="readonly">Read Only — View only</option>
        </select>
      </div>
      <div id="um-access-note" style="display:none;background:var(--bg);border:1.5px solid var(--border);border-radius:8px;padding:10px 12px;font-size:11px;color:var(--text-dim);line-height:1.6;">
        🔐 <strong style="color:var(--text);">Dashboard access</strong> is managed by an Admin.<br>
        Sign in is via Google — only Google accounts that have been added to the dashboard by an admin can access it. Contact your admin to change your access level.
      </div>
    </div>
    <div class="mactions">
      <button class="mprimary" onclick="confirmEditUser()">Save User</button>
      <button class="msecondary" onclick="closeUserModal()">Cancel</button>
      <button class="mdanger" id="um-del-btn" style="display:none" onclick="deleteUserConfirm()">Remove Access</button>
    </div>
  </div>
</div>

<!-- ROLES MODAL -->
<div class="moverlay" id="roles-modal">
  <div class="smodal-inner" style="max-width:360px;width:100%;">
    <div class="mtitle" style="margin-bottom:12px;">Manage Roles</div>
    <div id="roles-list" style="margin-bottom:14px;max-height:260px;overflow-y:auto;"></div>
    <div style="display:flex;gap:8px;">
      <input type="text" id="new-role-input" placeholder="New role name…" style="flex:1;padding:8px 10px;border:1.5px solid var(--border);border-radius:7px;font-size:13px;">
      <button class="mprimary" onclick="addCustomRole()" style="padding:8px 14px;">Add</button>
    </div>
    <div class="mactions" style="margin-top:12px;">
      <button class="msecondary" onclick="closeManageRoles()">Done</button>
    </div>
  </div>
</div>

<!-- PACKAGE MANAGER MODAL -->
<div class="moverlay" id="pkg-modal">
  <div class="modal" style="max-width:460px;">
    <div class="modal-handle"></div>
    <button class="mclose" onclick="closePkgModal()">×</button>
    <div class="mtitle" id="pkg-m-title">Add Package / Tier</div>

    <!-- Tier name + emoji -->
    <div class="frow two">
      <div class="fg">
        <label>Tier Name *</label>
        <select id="pf-tier" onchange="onPkgTierChange()">
          <option value="diamond">Diamond</option>
          <option value="gold">Gold</option>
          <option value="silver">Silver</option>
          <option value="bronze">Bronze</option>
          <option value="community">Community</option>
          <option value="custom">Custom</option>
        </select>
      </div>
      <div class="fg">
        <label>Emoji / Icon</label>
        <div style="display:flex;gap:6px;align-items:center;">
          <input type="text" id="pf-emoji" placeholder="💎" style="width:70px;font-size:22px;text-align:center;" maxlength="4">
          <div style="display:flex;flex-wrap:wrap;gap:4px;flex:1;">
            <button type="button" class="emoji-pick" onclick="document.getElementById('pf-emoji').value=this.textContent">💎</button>
            <button type="button" class="emoji-pick" onclick="document.getElementById('pf-emoji').value=this.textContent">🥇</button>
            <button type="button" class="emoji-pick" onclick="document.getElementById('pf-emoji').value=this.textContent">🥈</button>
            <button type="button" class="emoji-pick" onclick="document.getElementById('pf-emoji').value=this.textContent">🥉</button>
            <button type="button" class="emoji-pick" onclick="document.getElementById('pf-emoji').value=this.textContent">🤝</button>
            <button type="button" class="emoji-pick" onclick="document.getElementById('pf-emoji').value=this.textContent">⭐</button>
            <button type="button" class="emoji-pick" onclick="document.getElementById('pf-emoji').value=this.textContent">🏆</button>
            <button type="button" class="emoji-pick" onclick="document.getElementById('pf-emoji').value=this.textContent">🌟</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Amount + description -->
    <div class="frow two">
      <div class="fg">
        <label>Default Amount ($)</label>
        <input type="number" id="pf-amount" placeholder="e.g. 1500" min="0" inputmode="numeric">
      </div>
      <div class="fg">
        <label>Short Description</label>
        <input type="text" id="pf-desc" placeholder="e.g. Premium naming rights partner">
      </div>
    </div>

    <!-- Benefits -->
    <div class="frow">
      <div class="fg">
        <label>Benefits / Inclusions</label>
        <textarea id="pf-benefits" rows="3" placeholder="e.g. Logo on playing jersey, banner at ground, social media, website, training top…"></textarea>
      </div>
    </div>

    <div class="mactions">
      <button class="mprimary" id="pkg-m-save" onclick="savePkg()">Save Package</button>
      <button class="msecondary" onclick="closePkgModal()">Cancel</button>
      <button class="mdanger" id="pkg-m-del" style="display:none" onclick="deletePkg()">Delete</button>
    </div>
  </div>
</div>

<!-- PLAYERS MODAL -->
<div class="moverlay" id="players-modal" style="align-items:stretch;padding:0;">
  <div style="background:var(--card);width:100%;max-width:100%;height:100vh;display:flex;flex-direction:column;overflow:hidden;">
    <div style="background:var(--green);padding:14px 20px;display:flex;align-items:center;gap:12px;flex-shrink:0;">
      <span style="font-size:22px;">🏉</span>
      <div style="flex:1;">
        <div style="font-family:'Barlow Condensed',sans-serif;font-weight:900;font-size:20px;color:#fff;text-transform:uppercase;letter-spacing:.5px;">Player & Recruitment Dashboard</div>
        <div style="font-size:11px;color:rgba(255,255,255,.6);margin-top:1px;">Admin only — Beta</div>
      </div>
      <select id="pl-season-sel" style="background:rgba(255,255,255,.15);border:1px solid rgba(255,255,255,.3);color:#fff;padding:5px 10px;border-radius:6px;font-size:12px;font-weight:700;cursor:pointer;" onchange="loadPlayerView()"></select>
      <button onclick="closePlayersModal()" style="background:rgba(255,255,255,.15);border:1px solid rgba(255,255,255,.3);color:#fff;width:32px;height:32px;border-radius:50%;font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;">×</button>
    </div>
    <!-- Tab bar -->
    <div style="display:flex;gap:0;background:var(--bg);border-bottom:2px solid var(--border);flex-shrink:0;overflow-x:auto;">
      <button class="pl-tab act" data-tab="overview"  onclick="switchPlTab(this,'overview')">📊 Overview</button>
      <button class="pl-tab"     data-tab="players"   onclick="switchPlTab(this,'players')">👥 Players</button>
      <button class="pl-tab"     data-tab="lapsed"    onclick="switchPlTab(this,'lapsed')">⚠️ Not Returned</button>
      <button class="pl-tab"     data-tab="schools"   onclick="switchPlTab(this,'schools')">🏫 Schools</button>
      <button class="pl-tab"     data-tab="teams"     onclick="switchPlTab(this,'teams')">🏉 Teams</button>
      <button class="pl-tab"     data-tab="import"    onclick="switchPlTab(this,'import')">📥 Import</button>
      <button class="pl-tab"     data-tab="settings"  onclick="switchPlTab(this,'settings')">⚙️ Settings</button>
    </div>
    <!-- Body -->
    <div id="pl-body" style="flex:1;overflow-y:auto;padding:20px;"></div>
  </div>
</div>

<!-- PLAYER DETAIL MODAL -->
<div class="moverlay" id="player-detail-modal" style="align-items:center;justify-content:center;padding:20px;">
  <div style="background:var(--card);border-radius:14px;width:100%;max-width:580px;max-height:90vh;overflow-y:auto;display:flex;flex-direction:column;">
    <div style="padding:16px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px;position:sticky;top:0;background:var(--card);z-index:1;">
      <div id="pdm-avatar" style="width:48px;height:48px;border-radius:50%;overflow:hidden;flex-shrink:0;background:var(--green-light);display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:900;color:var(--green);font-family:'Barlow Condensed',sans-serif;"></div>
      <div style="flex:1;min-width:0;">
        <div id="pdm-name" style="font-weight:700;font-size:16px;"></div>
        <div id="pdm-meta" style="font-size:12px;color:var(--text-dim);"></div>
      </div>
      <button onclick="closePlayerDetail()" style="background:var(--bg);border:1.5px solid var(--border);border-radius:50%;width:30px;height:30px;font-size:16px;cursor:pointer;">×</button>
    </div>
    <div id="pdm-body" style="padding:20px;"></div>
    <div style="padding:12px 20px;border-top:1px solid var(--border);display:flex;gap:8px;justify-content:flex-end;">
      <button class="msecondary" onclick="closePlayerDetail()">Close</button>
      <button class="mprimary" id="pdm-save-btn" onclick="savePlayerDetail()">Save Changes</button>
    </div>
  </div>
</div>

<!-- ADMIN MODAL -->
<div class="moverlay" id="admin-modal">
  <div class="modal" style="max-width:680px;max-height:85vh;display:flex;flex-direction:column;">
    <div class="modal-handle"></div>
    <button class="mclose" onclick="closeAdminModal()">×</button>
    <div class="adm-tabs">
      <button class="adm-tab" data-tab="log" onclick="document.querySelectorAll('.adm-tab').forEach(b=>b.classList.toggle('act',b===this));loadAdminTab('log')">Access Log</button>
      <button class="adm-tab" data-tab="users" onclick="document.querySelectorAll('.adm-tab').forEach(b=>b.classList.toggle('act',b===this));loadAdminTab('users')">Users</button>
      <button class="adm-tab" data-tab="packages" onclick="document.querySelectorAll('.adm-tab').forEach(b=>b.classList.toggle('act',b===this));loadAdminTab('packages')">📦 Packages</button>
    </div>
    <div id="adm-body" style="flex:1;overflow-y:auto;padding:16px 0 4px;"></div>
  </div>
</div>

<div id="toast" class="toast"></div>

<script src="https://accounts.google.com/gsi/client" async defer></script>
<script>
// ── NAME UTILITIES ───────────────────────────────────────────────────────────
// Title-case a name: normalises ALL CAPS / all-lowercase from PlayHQ exports
// e.g. "JOHN SMITH-O'BRIEN" → "John Smith-O'Brien", "mcgregor" → "McGregor"
function toTitleCase(str) {
  if (!str) return str;
  return str.replace(/[^\s\-]+/g, function(word) {
    if (/^[Mm][Cc][A-Za-z]/.test(word)) {
      return word[0].toUpperCase() + word[1].toLowerCase() +
             word[2].toUpperCase() + word.slice(3).toLowerCase();
    }
    return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
  });
}

// ════════════════════════════════════════════════════════
//  CONFIG
// ════════════════════════════════════════════════════════
const GOOGLE_CLIENT_ID = '127701976947-881utr0ljs1eqrfmuoqrsbqh5635vtfl.apps.googleusercontent.com';
const APPS_SCRIPT_URL  = 'https://script.google.com/macros/s/AKfycbzcIR3bT9TUyq-3fRNrS5CfG9ul2ZfRl_HIppOFbqpxtj5mMaJ5aZC3_bw7VKEDoTU/exec';

// ════════════════════════════════════════════════════════
//  STATE
// ════════════════════════════════════════════════════════
let me           = null;
let token        = null;
let orgs         = [];      // SponsorOrgs — one per company
let seasonEntries = [];     // SponsorSeasons — org × year
let years        = [];      // available year list
let packages     = [];      // SponsorPackages — standard packages
let activeSeason = null;
let curFilter    = 'all';
let curView      = 'active';
let curSort      = { col: 'tier', dir: 1 }; // col, dir: 1=asc, -1=desc
let editOrgId    = null;
let editSSId     = null;
let editSSOrg    = null;

// ── DYNAMIC Z-INDEX ──────────────────────────────────────────────────
// Every modal/panel calls bringToFront(el) on open — last opened is always on top
let _zTop = 500;
function bringToFront(el) {
  if (!el) return;
  _zTop += 10;
  el.style.zIndex = _zTop;
}

// Base tier config — extended dynamically from packages
const TIER_ORDER_BASE = {diamond:0,gold:1,silver:2,bronze:3,community:4,custom:5};
const TIER_COLOR = {diamond:'var(--td)',gold:'var(--tg)',silver:'var(--ts)',bronze:'var(--tb)',community:'var(--tc)',custom:'#6d28d9'};
const TIER_LABEL_BASE = {diamond:'Diamond',gold:'Gold',silver:'Silver',bronze:'Bronze',community:'Community',custom:'Custom'};
const TIER_EMOJI_BASE = {diamond:'💎',gold:'🥇',silver:'🥈',bronze:'🥉',community:'🤝',custom:'⭐'};

// Dynamic lookups — updated when packages load
let TO = {...TIER_ORDER_BASE};
let TH = {...TIER_COLOR};
let TL = {...TIER_LABEL_BASE};
let TE = {...TIER_EMOJI_BASE}; // emoji per tier

function rebuildTierLookups() {
  TO = {...TIER_ORDER_BASE};
  TH = {...TIER_COLOR};
  TL = {...TIER_LABEL_BASE};
  TE = {...TIER_EMOJI_BASE};
  packages.forEach(function(p) {
    if (p.tier) {
      TL[p.tier] = cap(p.tier); // tier name = tier key capitalised
      if (p.emoji) TE[p.tier] = p.emoji;
    }
  });
}

// ════════════════════════════════════════════════════════
//  COMPUTED HELPERS
// ════════════════════════════════════════════════════════
// Get season entries for a given year
function ssForYear(year) {
  return seasonEntries.filter(s => +s.year === +year);
}
// Get season entries for an org
function ssForOrg(orgId) {
  return seasonEntries.filter(s => s.orgId === orgId);
}
// Get all orgs that have a season entry for the active year
function activeOrgIds(year) {
  return new Set(ssForYear(year).map(s => s.orgId));
}
// Total number of seasons an org has sponsored
function consecYears(orgId) { return ssForOrg(orgId).length; }

// Sliding colour scale for years of sponsorship
function yrsBadge(n) {
  if (n <= 0) return '';
  if (n === 1) return '<span style="color:var(--text-dim);font-size:11px;font-weight:600">New</span>';
  // Scale: 2=light green → 3=green → 4=teal → 5=blue → 6+=gold/amber
  const scales = [
    null,                                          // 0 (unused)
    null,                                          // 1 = New (handled above)
    {bg:'#e8f5e9',border:'#a5d6a7',col:'#2e7d32'}, // 2
    {bg:'#c8e6c9',border:'#66bb6a',col:'#1b5e20'}, // 3
    {bg:'#b2dfdb',border:'#4db6ac',col:'#004d40'}, // 4
    {bg:'#bbdefb',border:'#64b5f6',col:'#0d47a1'}, // 5
    {bg:'#fffde7',border:'#fdd835',col:'#f57f17'}, // 6
    {bg:'#fff3e0',border:'#ffa726',col:'#e65100'}, // 7+
  ];
  const s = scales[Math.min(n, scales.length-1)];
  const star = n >= 5 ? '★ ' : '';
  return `<span style="display:inline-flex;align-items:center;gap:2px;background:${s.bg};border:1.5px solid ${s.border};color:${s.col};font-size:9px;font-weight:800;padding:2px 7px;border-radius:10px;white-space:nowrap;">${star}${n} yr${n!==1?'s':''}</span>`;
}

// ════════════════════════════════════════════════════════
//  SESSION
// ════════════════════════════════════════════════════════
function saveSession(t, user) { localStorage.setItem('kjfc_token',t); localStorage.setItem('kjfc_user',JSON.stringify(user)); }
function loadSession() { token=localStorage.getItem('kjfc_token'); try{me=JSON.parse(localStorage.getItem('kjfc_user'));}catch{me=null;} }
function clearSession() { localStorage.removeItem('kjfc_token'); localStorage.removeItem('kjfc_user'); token=null; me=null; }

// ════════════════════════════════════════════════════════
//  API
// ════════════════════════════════════════════════════════
async function api(action, body = {}) {
  return new Promise((resolve) => {
    const cbName = '_kjfc_cb_' + Date.now() + '_' + Math.floor(Math.random()*1e6);
    const params = new URLSearchParams({ action, callback: cbName });
    if (token) params.set('token', token);
    if (action === 'exchangeCode')       params.set('code', body.code || '');
    else if (action === 'getAudit')      params.set('id', body.id || '');
    else if (action === 'getContactLog') params.set('orgId', body.orgId || '');
    else if (Object.keys(body).length > 0) params.set('payload', encodeURIComponent(JSON.stringify(body)));
    const timer = setTimeout(() => { cleanup(); resolve({ error: 'Request timed out' }); }, 30000);
    function cleanup() { clearTimeout(timer); delete window[cbName]; const el=document.getElementById(cbName); if(el) el.remove(); }
    window[cbName] = (data) => { cleanup(); resolve(data); };
    const script = document.createElement('script');
    script.id = cbName;
    script.src = APPS_SCRIPT_URL + '?' + params.toString();
    script.onerror = () => { cleanup(); resolve({ error: 'Script load failed' }); };
    document.head.appendChild(script);
  });
}



// ════════════════════════════════════════════════════════
//  GOOGLE SIGN-IN
// ════════════════════════════════════════════════════════
function initGoogleSignIn() {
  if (!window.google) { setTimeout(initGoogleSignIn, 300); return; }
  google.accounts.id.initialize({ client_id: GOOGLE_CLIENT_ID, callback: handleGoogleCredential, auto_select: false, cancel_on_tap_outside: true });
  function renderGoogleBtn() {
    const container = document.getElementById('google-btn-container'); if (!container) return;
    container.innerHTML = '';
    const lbox = document.querySelector('.lbox');
    const w = Math.min((lbox ? lbox.offsetWidth - 48 : 0) || 300, 360);
    google.accounts.id.renderButton(container, { theme:'outline', size:'large', width:w, text:'continue_with', shape:'rectangular' });
  }
  setTimeout(renderGoogleBtn, 100);
  window.addEventListener('resize', () => setTimeout(renderGoogleBtn, 100));
  document.getElementById('google-sign-in-btn').addEventListener('click', () => google.accounts.id.prompt());
}

async function handleGoogleCredential(response) {
  // Show "Signing in..." progress state immediately
  const signinArea = document.getElementById('login-signin-area');
  const progressArea = document.getElementById('login-progress');
  if (signinArea) signinArea.style.display = 'none';
  if (progressArea) progressArea.style.display = 'block';

  const result = await api('exchangeCode', { code: response.credential });

  if (result.error) {
    // Show error, restore sign-in button
    if (signinArea) signinArea.style.display = 'block';
    if (progressArea) progressArea.style.display = 'none';
    document.getElementById('lerr').textContent = result.error;
    return;
  }
  token = result.token;
  me = { email: result.email, name: result.name, role: result.role, edit: result.edit, admin: result.admin, picture: result.picture };
  saveSession(token, me);
  showApp();
}

// ════════════════════════════════════════════════════════
//  LOAD DATA
// ════════════════════════════════════════════════════════
async function loadAll() {
  setSyncState('loading', 'Loading data…');
  try {
    const [data, seasonsRes] = await Promise.all([
      api('getAllData'),
      Promise.resolve(null) // getAllData includes years
    ]);
    if (data.error) throw new Error(data.error);
    orgs          = data.orgs   || [];
    seasonEntries = data.seasons || [];
    years         = (data.years || []).map(Number).sort((a,b) => b-a);
    packages      = data.packages || [];
    // Always default to current calendar year; fall back to most recent
    const curYear = new Date().getFullYear();
    if (!activeSeason || !years.includes(+activeSeason)) {
      activeSeason = years.includes(curYear) ? curYear : (years[0] || null);
    }
    rebuildTierLookups();
    populatePackageSelect();
    renderSeasonTabs();
    render();
    setSyncState('ok', 'Synced · ' + fmtTime(new Date()));
    // If player modal was opened before sponsor data loaded, refresh its season selector now
    const plModal = document.getElementById('players-modal');
    if (plModal && plModal.classList.contains('open')) {
      initPlayerSeasonSel();
      // If player data loaded against an incomplete year list, reload it
      if (!plData) loadPlayerData();
    }
  } catch(e) {
    setSyncState('err', 'Load failed: ' + e.message);
    showToast('Load failed', 'err');
  }
}

// ════════════════════════════════════════════════════════
//  APP SHOW / HIDE
// ════════════════════════════════════════════════════════
function showApp() {
  document.getElementById('login-view').style.display = 'none';
  document.getElementById('app').style.display = 'block';
  renderUserUI();
  loadAll();
}

function renderUserUI() {
  if (!me) return;
  const name = me.name || me.email;
  document.getElementById('user-name').textContent = name;
  // Initials fallback
  const initEl = document.getElementById('user-init');
  if (initEl) initEl.textContent = name.split(' ').map(w=>w[0]).join('').toUpperCase().slice(0,2);
  const pic = document.getElementById('user-pic');
  if (me.picture) {
    pic.src = me.picture; pic.style.display = 'block';
    if (initEl) initEl.style.display = 'none';
  }
  if (me.admin) { const el = document.getElementById('admin-nav-btns'); if(el) el.style.display='flex'; }  if (!me.edit) { const b = document.getElementById('add-sponsor-btn'); if(b) b.style.display='none'; }
}

// ════════════════════════════════════════════════════════
//  SEASON TABS
// ════════════════════════════════════════════════════════
function renderSeasonTabs() {
  document.getElementById('season-tabs').innerHTML = years.map(y =>
    `<button class="stab${+y===+activeSeason?' act':''}" onclick="switchSeason(${y})">${y}</button>`
  ).join('');
  // Only rebuild the year select if the SS modal is NOT open (avoid resetting user's choice)
  const sel = document.getElementById('sf-year');
  if (sel && !document.getElementById('ss-modal').classList.contains('open')) {
    sel.innerHTML = years.map(y=>`<option value="${y}">${y}</option>`).join('');
    sel.value = activeSeason;
  } else if (sel && !sel.innerHTML) {
    // First time — always populate
    sel.innerHTML = years.map(y=>`<option value="${y}">${y}</option>`).join('');
    sel.value = activeSeason;
  }
}

function switchSeason(y) { activeSeason = +y; renderSeasonTabs(); render(); }

// ════════════════════════════════════════════════════════
//  STATS
// ════════════════════════════════════════════════════════
function calcStats(year) {
  const ss       = ssForYear(year);
  const cashSS   = ss.filter(s => s.status !== 'inkind');
  const ikSS     = ss.filter(s => s.status === 'inkind');
  const total    = cashSS.reduce((a,s) => a + +s.amount, 0);
  const recv     = cashSS.reduce((a,s) =>
    s.status==='paid' ? a + +s.amount :
    s.status==='partial' ? a + +(s.paidAmount||0) : a, 0);
  const outCount = cashSS.filter(s => s.status!=='paid').length;
  const byTier   = {};
  const allTiers = [...new Set(['diamond','gold','silver','bronze','community','custom', ...seasonEntries.map(s=>s.tier)])].filter(Boolean);
  allTiers.forEach(t => {
    const ts   = ss.filter(s => String(s.tier).toLowerCase()===t);
    const cash = ts.filter(s => s.status!=='inkind');
    const ik   = ts.filter(s => s.status==='inkind');
    byTier[t]  = { count: ts.length, cashCount: cash.length, ikCount: ik.length,
                   amount: cash.reduce((a,s)=>a+ +s.amount,0) };
  });
  return { total, recv, outstanding: total-recv, outCount, count: ss.length,
           ikCount: ikSS.length, byTier };
}

// ════════════════════════════════════════════════════════
//  MAIN RENDER
// ════════════════════════════════════════════════════════
function render() {
  const cy = activeSeason; if (!cy) return;
  const s    = calcStats(cy);
  const prevYr = years[years.indexOf(cy)+1];
  const prev = prevYr ? calcStats(prevYr) : { total:0 };

  document.getElementById('season-span').textContent = 'Sponsorship ' + cy + ' Season';
  document.getElementById('k-total').textContent = fmt(s.total);
  document.getElementById('k-count').textContent = s.count + ' sponsor' + (s.count!==1?'s':'');
  document.getElementById('k-paid').textContent  = fmt(s.recv);
  const pct = s.total>0 ? Math.round(s.recv/s.total*100) : 0;
  document.getElementById('k-ppct').textContent = pct + '% collected';
  document.getElementById('k-bar').style.width  = pct + '%';
  document.getElementById('k-out').textContent  = fmt(s.outstanding);
  document.getElementById('k-outc').textContent = s.outCount + ' invoice' + (s.outCount!==1?'s':'') + ' pending';

  const tEl = document.getElementById('k-trend');
  if (prev.total>0 && s.total>0) {
    const d = s.total-prev.total, pd = Math.round(d/prev.total*100);
    tEl.textContent = (d>=0?'▲ ':'▼ ') + Math.abs(pd) + '% vs ' + prevYr;
    tEl.className = 'ktrend ' + (d>=0?'up':'dn');
  } else tEl.textContent = '';

  // In-kind strip
  const ikStrip = document.getElementById('inkind-strip');
  const ikSumm  = document.getElementById('inkind-summary');
  if (ikStrip) ikStrip.style.display = s.ikCount>0 ? 'flex' : 'none';
  if (ikSumm && s.ikCount>0) ikSumm.textContent = s.ikCount+' in-kind sponsor'+(s.ikCount!==1?'s':'')+' this season';

  // Tier mini (KPI card)
  const activeTiers = Object.keys(s.byTier).filter(t => s.byTier[t].count > 0).sort((a,b)=>(TO[a]||9)-(TO[b]||9));
  document.getElementById('tier-mini').innerHTML = activeTiers.map(t => {
    const d = s.byTier[t]; if (!d.count) return '';
    const col = TH[t] || 'var(--text-dim)';
    const ikBit = d.ikCount>0 ? `<span style="font-size:9px;color:#6d28d9;font-weight:600">&nbsp;(${d.ikCount} in-kind)</span>` : '';
    return `<div style="display:flex;align-items:center;gap:7px"><div style="width:6px;height:6px;border-radius:50%;background:${col};flex-shrink:0"></div><span style="font-size:11px;flex:1">${TL[t]||cap(t)}</span><span style="font-size:12px;font-weight:800;color:${col}">${d.count}${ikBit}</span></div>`;
  }).join('');

  // YOY bars
  const allSt = years.map(y => ({ year:y, ...calcStats(y) }));
  const maxT  = Math.max(...allSt.map(x=>x.total), 1);
  document.getElementById('year-bars').innerHTML = allSt.map(ys => {
    const p2 = Math.round(ys.total/maxT*100);
    const isCur = +ys.year===+cy;
    return `<div class="ybargrp" onclick="switchSeason(${ys.year})" title="View ${ys.year}">
      <div class="ybarlbl"><span class="yr" style="${isCur?'color:var(--text);font-weight:700':''}">${ys.year}${isCur?' ★':''}</span>
      <span style="font-weight:700;color:${isCur?'var(--yellow-dark)':'var(--text-dim)'}">${fmt(ys.total)} <span style="font-size:9px;font-weight:400">(${ys.count})</span></span></div>
      <div class="btrack"><div class="bfill ${isCur?'cur':'prev'}" style="width:${p2}%"></div></div>
    </div>`;
  }).join('');

  // Tier list (revenue by tier)
  const tierListTiers = Object.keys(s.byTier).filter(t => s.byTier[t].count > 0).sort((a,b)=>(TO[a]||9)-(TO[b]||9));
  document.getElementById('tier-list').innerHTML = tierListTiers.map(t => {
    const d = s.byTier[t]; if (!d.count) return '';
    const col = TH[t] || 'var(--text-dim)';
    const ikLabel = d.ikCount>0 ? `<span style="font-size:9px;color:#6d28d9;font-weight:700;margin-left:4px">(${d.ikCount} in-kind)</span>` : '';
    return `<div class="trow" onclick="filterTable('${t}')">
      <div class="tdot ${t}"></div><div class="tname">${TL[t]||cap(t)}${ikLabel}</div>
      <div class="tcnt">${d.count}</div><div class="tamt" style="color:${col}">${fmt(d.amount)}</div>
    </div>`;
  }).join('') || '<div style="color:var(--text-dim);font-size:13px;padding:6px">No sponsors yet.</div>';

  // Prospect pipeline
  renderProspects();

  renderFilterTabs();
  renderTableHeaders();
  renderTable();
}

// ════════════════════════════════════════════════════════
//  PROSPECT PIPELINE
// ════════════════════════════════════════════════════════
function renderProspects() {
  const prospects = orgs.filter(o => o.orgStatus === 'prospect');
  const panel = document.getElementById('prospect-panel');
  const list  = document.getElementById('prospect-list');
  if (!prospects.length) { panel.style.display='none'; return; }
  panel.style.display='block';
  list.innerHTML = prospects.map(o => {
    const logs  = ''; // loaded on demand
    const email = o.email ? `<a href="mailto:${o.email}" style="color:var(--green)">${o.email}</a>` : '—';
    return `<div class="trow" onclick="openOrgDetail('${o.id}')" style="margin-bottom:4px;">
      <div style="flex:1;min-width:0;">
        <strong>${o.name}</strong>
        ${o.primaryContact ? `<span style="color:var(--text-dim);font-size:12px;margin-left:6px">${o.primaryContact}</span>` : ''}
      </div>
      ${o.phone ? `<span style="font-size:11px;color:var(--text-dim)">${fmtPhone(o.phone)}</span>` : ''}
    </div>`;
  }).join('');
}

// ════════════════════════════════════════════════════════
//  SPONSOR TABLE
// ════════════════════════════════════════════════════════
function renderTableHeaders() {
  const head = document.getElementById('stable-head');
  if (!head) return;
  if (curView === 'prospect') {
    head.innerHTML = `<tr>
      <th>Sponsor</th>
      <th>Contact</th>
      <th>Phone</th>
      <th>Status</th>
      <th colspan="3"></th>
    </tr>`;
  } else {
    head.innerHTML = `<tr>
      <th class="sortable" onclick="sortBy('name')" id="th-name">Sponsor <span class="sort-arrow" id="sa-name"></span></th>
      <th class="sortable" onclick="sortBy('tier')" id="th-tier">Tier <span class="sort-arrow" id="sa-tier"></span></th>
      <th class="sortable" onclick="sortBy('amount')" id="th-amount">Amount <span class="sort-arrow" id="sa-amount"></span></th>
      <th class="sortable" onclick="sortBy('status')" id="th-status">Status <span class="sort-arrow" id="sa-status"></span></th>
      <th class="sortable" onclick="sortBy('yrs')" id="th-yrs">Yrs <span class="sort-arrow" id="sa-yrs"></span></th>
      <th class="col-contact">Contact</th><th></th>
    </tr>`;
    // Re-apply current sort indicator
    ['name','tier','amount','status','yrs'].forEach(c => {
      const th = document.getElementById('th-' + c);
      const sa = document.getElementById('sa-' + c);
      if (!th || !sa) return;
      const active = c === curSort.col;
      th.classList.toggle('sort-act', active);
      sa.textContent = active ? (curSort.dir === 1 ? '▲' : '▼') : '';
    });
  }
}

function setView(v) {
  curView = v;
  document.getElementById('vtab-active').classList.toggle('act', v==='active');
  document.getElementById('vtab-prospect').classList.toggle('act', v==='prospect');
  document.getElementById('filters').style.display = v==='active' ? '' : 'none';
  if (v==='active') renderFilterTabs();
  renderTableHeaders();
  renderTable();
}

function sortBy(col) {
  if (curSort.col === col) curSort.dir *= -1;
  else { curSort.col = col; curSort.dir = 1; }
  // Update header arrows
  ['name','tier','amount','status','yrs'].forEach(c => {
    const th = document.getElementById('th-' + c);
    const sa = document.getElementById('sa-' + c);
    if (!th || !sa) return;
    const active = c === curSort.col;
    th.classList.toggle('sort-act', active);
    sa.textContent = active ? (curSort.dir === 1 ? '▲' : '▼') : '';
  });
  renderTable();
}

function renderFilterTabs() {
  const container = document.getElementById('filters');
  if (!container) return;
  // Get tiers actually used this season, sorted by tier order
  const ss = ssForYear(activeSeason);
  const usedTiers = [...new Set(ss.map(s => s.tier).filter(Boolean))]
    .sort((a,b) => (TO[a]||9) - (TO[b]||9));
  const hasOwing = ss.some(s => s.status !== 'paid' && s.status !== 'inkind');

  let html = `<button class="ftab${curFilter==='all'?' act':''}" onclick="filterTable('all')">All</button>`;
  usedTiers.forEach(t => {
    html += `<button class="ftab${curFilter===t?' act':''}" onclick="filterTable('${t}')">${TL[t]||cap(t)}</button>`;
  });
  if (hasOwing) {
    html += `<button class="ftab${curFilter==='outstanding'?' act':''}" onclick="filterTable('outstanding')">⚠ Owing</button>`;
  }
  container.innerHTML = html;
}

function filterTable(f) {
  curFilter = f;
  renderFilterTabs();
  renderTable();
}

function renderTable() {
  const cy    = activeSeason;
  const empty = document.getElementById('tbl-empty');
  const tbody = document.getElementById('tbody');

  if (curView === 'prospect') {
    const activeOrgIdSet = activeOrgIds(cy);
    let unlinked = orgs.filter(o => !activeOrgIdSet.has(o.id));

    // Search filter for not-in-season view
    const q2 = (document.getElementById('sponsor-search')?.value||'').toLowerCase().trim();
    if (q2) {
      unlinked = unlinked.filter(o =>
        (o.name||'').toLowerCase().includes(q2) ||
        (o.primaryContact||'').toLowerCase().includes(q2) ||
        (o.phone||'').toLowerCase().includes(q2) ||
        (o.email||'').toLowerCase().includes(q2)
      );
    }

    if (!unlinked.length) {
      tbody.innerHTML=''; empty.style.display='block';
      empty.textContent = q2 ? 'No matches found.' : 'All your sponsors are linked to the ' + cy + ' season.';
      return;
    }
    empty.style.display='none';

    // Sort by name for this view
    unlinked.sort((a,b) => (a.name||'').localeCompare(b.name||''));

    tbody.innerHTML = unlinked.map(o => {
      const statusLabel = o.orgStatus === 'prospect' ? 'Prospect' : 'Not in ' + cy;
      const statusClass = o.orgStatus === 'prospect' ? 'prospect' : 'lapsed';
      const nameHl2 = q2 ? (o.name||'').replace(new RegExp(`(${q2.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')})`, 'gi'), '<mark style="background:var(--yellow-pale);border-radius:2px;">$1</mark>') : (o.name||'');
      return `<tr onclick="openOrgDetail('${o.id}')" style="cursor:pointer">
        <td><strong>${nameHl2}</strong></td>
        <td style="color:var(--text-dim);font-size:12px">${o.primaryContact||'—'}</td>
        <td style="color:var(--text-dim);font-size:12px">${fmtPhone(o.phone)}</td>
        <td><span class="ostatus ${statusClass}">${statusLabel}</span></td>
        <td colspan="2"></td>
        <td style="display:flex;gap:4px;">
          ${me?.edit ? `<button class="actbtn" style="background:var(--green);color:#fff;border-color:var(--green);font-size:10px;" onclick="event.stopPropagation();openAddSS('${o.id}')">+ Add to ${cy}</button>` : ''}
          <button class="actbtn" onclick="event.stopPropagation();openEditOrg('${o.id}')">Edit</button>
        </td>
      </tr>`;
    }).join('');
    return;
  }

  // Active view — join season entries with orgs for activeSeason
  let ss = ssForYear(cy);
  if (curFilter!=='all' && curFilter!=='outstanding') ss = ss.filter(s => s.tier===curFilter);
  if (curFilter==='outstanding') ss = ss.filter(s => s.status!=='paid' && s.status!=='inkind');

  // Search filter
  const q = (document.getElementById('sponsor-search')?.value||'').toLowerCase().trim();
  if (q) {
    ss = ss.filter(s => {
      const org = orgs.find(o => o.id===s.orgId);
      return (org?.name||'').toLowerCase().includes(q)
          || (org?.primaryContact||'').toLowerCase().includes(q)
          || (s.tier||'').toLowerCase().includes(q)
          || (s.status||'').toLowerCase().includes(q);
    });
  }

  // Sort
  const STATUS_ORDER = {paid:1,partial:2,outstanding:3,inkind:4};
  ss.sort((a,b) => {
    const orgA = orgs.find(o=>o.id===a.orgId)||{};
    const orgB = orgs.find(o=>o.id===b.orgId)||{};
    let v = 0;
    switch(curSort.col) {
      case 'name':   v = (orgA.name||'').localeCompare(orgB.name||''); break;
      case 'tier':   v = (TO[a.tier]||9)-(TO[b.tier]||9); break;
      case 'amount': v = (+a.amount||0)-(+b.amount||0); break;
      case 'status': v = (STATUS_ORDER[a.status]||9)-(STATUS_ORDER[b.status]||9); break;
      case 'yrs':    v = consecYears(a.orgId)-consecYears(b.orgId); break;
    }
    return v * curSort.dir;
  });

  if (!ss.length) { tbody.innerHTML=''; empty.style.display='block'; empty.textContent= q ? 'No sponsors match your search.' : 'No sponsors for this season yet.'; return; }
  empty.style.display='none';

  tbody.innerHTML = ss.map(s => {
    const org   = orgs.find(o => o.id===s.orgId) || { name: s.orgId, primaryContact:'', phone:'' };
    const c      = consecYears(s.orgId);
    const cBadge = yrsBadge(c);
    const amtH = s.status==='inkind' ? '<span style="color:#6d28d9;font-size:11px;font-weight:700">In-Kind</span>' :
                 s.status==='partial' ? `${fmt(s.amount)}<br><span style="font-size:10px;color:var(--orange)">${fmt(s.paidAmount||0)} recv</span>` :
                 fmt(s.amount);
    const nameHl = q ? (org.name||'').replace(new RegExp(`(${q.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')})`, 'gi'), '<mark style="background:var(--yellow-pale);border-radius:2px;">$1</mark>') : org.name;
    return `<tr onclick="openOrgDetail('${org.id}')" style="cursor:pointer">
      <td><strong>${nameHl}</strong></td>
      <td><span class="tchip ${s.tier}">${TL[s.tier]||cap(s.tier)}</span></td>
      <td>${amtH}</td>
      <td><span class="sbadge ${s.status}">${cap(s.status)}</span></td>
      <td>${cBadge}</td>
      <td style="font-size:11px;color:var(--text-dim)">${org.primaryContact||'—'}</td>
      <td><button class="actbtn" onclick="event.stopPropagation();openEditSS('${s.id}','${org.id}')">Edit</button></td>
    </tr>`;
  }).join('');
}

// ════════════════════════════════════════════════════════
//  ORG DETAIL PANEL
// ════════════════════════════════════════════════════════
async function openOrgDetail(orgId) {
  const org = orgs.find(o => o.id===orgId); if (!org) return;
  const overlay = document.getElementById('org-detail-overlay');
  bringToFront(overlay);
  overlay.classList.add('open');

  // Render skeleton first
  renderOrgDetail(org, [], true);

  // Fetch contact log
  const logRes = await api('getContactLog', { orgId });
  const clog   = Array.isArray(logRes) ? logRes : [];
  renderOrgDetail(org, clog, false);
}

// Render a single season-entry row (no nested template literals)
function renderSSRow(s, orgId) {
  const tierCol  = TH[s.tier] || 'inherit';
  const tierLbl  = s.customPackage || TL[s.tier] || cap(s.tier);
  const isInKind = s.status === 'inkind';

  const amtHtml = isInKind
    ? '<span style="font-size:11px;color:#6d28d9;font-weight:700;background:#f3e8ff;padding:2px 8px;border-radius:10px;">In-Kind 🤝</span>'
    : '<span style="font-size:14px;font-weight:800;">' + fmt(s.amount) + '</span>';

  const paidHtml = (s.status === 'partial' && +s.paidAmount > 0)
    ? ' <span style="font-size:10px;color:var(--orange);">(' + fmt(s.paidAmount) + ' recv)</span>'
    : '';

  const sBg  = {paid:'#e6f4ec', outstanding:'#fef6ec', partial:'#fef9e6', inkind:'#f3e8ff'}[s.status] || 'var(--bg)';
  const sCol = {paid:'var(--green)', outstanding:'var(--orange)', partial:'#b45309', inkind:'#6d28d9'}[s.status] || 'var(--text-dim)';
  const statusBadge = '<span style="font-size:9px;font-weight:800;background:' + sBg + ';color:' + sCol + ';padding:2px 7px;border-radius:10px;text-transform:uppercase;letter-spacing:.4px;">' + cap(s.status) + '</span>';

  const editHint = (me && me.edit)
    ? '<span style="font-size:11px;color:var(--text-dim);padding:2px 8px;background:var(--bg);border-radius:4px;border:1px solid var(--border);flex-shrink:0;margin-left:2px;">Edit →</span>'
    : '';

  // Checklist mini-summary
  const checks = [
    { key: 'chkInvoiceSent', label: 'Invoice' },
    { key: 'chkThankYou',    label: 'Thank you' },
    { key: 'chkLogoWebsite', label: 'Website' },
    { key: 'chkTrainingTop', label: 'Training top' },
  ];
  const total = checks.length;
  const done  = checks.filter(c => s[c.key] === 'true').length;
  const chkHtml = total > 0
    ? '<span style="font-size:10px;font-weight:700;color:' + (done===total?'var(--green)':'var(--orange)') + ';background:' + (done===total?'var(--green-light)':'var(--orange-light)') + ';padding:2px 7px;border-radius:10px;white-space:nowrap;">'
      + (done===total?'✓ All done':done+'/'+total+' done')+'</span>'
    : '';

  const invoiceHtml = s.invoiceNum
    ? '<span style="font-size:10px;color:var(--text-dim);padding:2px 6px;background:var(--bg);border-radius:4px;border:1px solid var(--border);">🧾 ' + s.invoiceNum + '</span>'
    : '';

  const subLine = (isInKind && s.inkindDesc)
    ? '<div style="font-size:11px;color:#6d28d9;margin-top:3px;">📦 ' + s.inkindDesc + '</div>'
    : (s.notes ? '<div style="font-size:11px;color:var(--text-dim);margin-top:3px;">📋 ' + s.notes + '</div>' : '');

  return '<div class="ss-row" onclick="openEditSS(\'' + s.id + '\',\'' + orgId + '\')">'
    + '<div style="flex:1;min-width:0;">'
    +   '<div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;">'
    +     '<div class="tdot ' + s.tier + '" style="flex-shrink:0;"></div>'
    +     '<span style="font-weight:800;font-size:14px;color:' + tierCol + ';">' + tierLbl + '</span>'
    +     '<span style="font-size:12px;color:var(--text-dim);font-weight:600;">' + s.year + '</span>'
    +     invoiceHtml
    +   '</div>'
    +   subLine
    +   '<div style="display:flex;gap:5px;margin-top:5px;flex-wrap:wrap;">' + chkHtml + '</div>'
    + '</div>'
    + '<div style="display:flex;align-items:flex-start;gap:5px;flex-shrink:0;flex-direction:column;align-items:flex-end;">'
    +   '<div style="display:flex;gap:5px;align-items:center;">' + amtHtml + paidHtml + '</div>'
    +   '<div style="display:flex;gap:5px;align-items:center;">' + statusBadge + editHint + '</div>'
    + '</div>'
    + '</div>';
}

function renderOrgDetail(org, clog, loading) {
  const ssList = ssForOrg(org.id).sort((a, b) => +b.year - +a.year);

  // ── Header buttons ──────────────────────────────────────
  const editOrgBtn = (me && me.edit)
    ? '<button class="actbtn" onclick="openEditOrg(\'' + org.id + '\')">Edit Details</button>'
    : '';
  const addSSBtn = (me && me.edit)
    ? '<button class="ss-add-btn" onclick="openAddSS(\'' + org.id + '\')">+ Add Season Sponsorship</button>'
    : '';

  // ── Address ─────────────────────────────────────────────
  let addrHtml = '';
  if (org.physAddr || org.postAddr) {
    addrHtml = '<div style="margin-top:8px;padding-top:8px;border-top:1px solid var(--border);">';
    if (org.physAddr) addrHtml += '<div style="font-size:10px;color:var(--text-dim);font-weight:700;text-transform:uppercase;letter-spacing:.5px;">Physical</div><div style="font-size:12px;margin-bottom:6px;">' + org.physAddr + '</div>';
    if (org.postAddr && !org.postSameAsPhys) addrHtml += '<div style="font-size:10px;color:var(--text-dim);font-weight:700;text-transform:uppercase;letter-spacing:.5px;">Postal</div><div style="font-size:12px;">' + org.postAddr + '</div>';
    if (org.postSameAsPhys) addrHtml += '<div style="font-size:11px;color:var(--text-dim);font-style:italic;">Postal same as physical</div>';
    addrHtml += '</div>';
  }

  // ── Season rows ─────────────────────────────────────────
  let seasonBodyHtml = '';
  if (ssList.length) {
    for (let i = 0; i < ssList.length; i++) {
      seasonBodyHtml += renderSSRow(ssList[i], org.id);
    }
  } else {
    seasonBodyHtml = '<div style="color:var(--text-dim);font-size:13px;padding:12px 0;text-align:center;">No season entries yet — click <strong>Add Season Sponsorship</strong> to get started.</div>';
  }

  // ── Contact log ─────────────────────────────────────────
  let clogHtml = '';
  if (loading) {
    clogHtml = '<div style="color:var(--text-dim);font-size:12px;padding:8px 0;">Loading…</div>';
  } else if (!clog.length) {
    clogHtml = '<div style="color:var(--text-dim);font-size:12px;padding:8px 0;">No contact history yet.</div>';
  } else {
    for (let i = 0; i < clog.length; i++) {
      const cl = clog[i];
      const delBtn = (me && me.edit)
        ? '<button onclick="deleteContactEntry(\'' + cl.id + '\',\'' + org.id + '\')" style="margin-left:auto;font-size:10px;color:var(--red);background:none;border:none;cursor:pointer;padding:2px 4px;">✕</button>'
        : '';
      clogHtml += '<div class="clog-entry"><div class="clog-dot"></div><div class="clog-body">'
        + '<div class="clog-meta" style="display:flex;align-items:center;">' + cl.date + ' · ' + cl.contactedBy + delBtn + '</div>'
        + '<div class="clog-notes">' + cl.notes + '</div>'
        + '</div></div>';
    }
  }

  const addLogBtn = (me && me.edit)
    ? '<button class="actbtn" onclick="openContactLog(\'' + org.id + '\')" style="margin-bottom:10px;width:100%;">+ Log Contact</button>'
    : '';

  const contactHasData = org.primaryContact || org.email || org.phone || org.physAddr || org.postAddr;
  let contactHtml = '';
  if (contactHasData) {
    contactHtml = '<div class="panel" style="margin-bottom:12px;">'
      + '<div style="font-size:9px;text-transform:uppercase;letter-spacing:1.2px;color:var(--text-dim);font-weight:700;margin-bottom:8px;">Contact Details</div>'
      + (org.primaryContact ? '<div style="font-size:13px;font-weight:600;margin-bottom:4px;">👤 ' + org.primaryContact + '</div>' : '')
      + (org.email ? '<div style="font-size:12px;margin-bottom:3px;">✉ <a href="mailto:' + org.email + '" style="color:var(--green)">' + org.email + '</a></div>' : '')
      + (org.phone ? '<div style="font-size:12px;margin-bottom:3px;">📞 ' + fmtPhone(org.phone) + '</div>' : '')
      + addrHtml
      + '</div>';
  }

  const notesHtml = org.notes
    ? '<div class="panel" style="margin-bottom:12px;"><div style="font-size:9px;text-transform:uppercase;letter-spacing:1.2px;color:var(--text-dim);font-weight:700;margin-bottom:6px;">Notes</div><div style="font-size:13px;color:var(--text-mid);">' + org.notes + '</div></div>'
    : '';

  const initials = org.name.split(' ').map(function(w){ return w[0]; }).slice(0,2).join('').toUpperCase();
  const websiteHtml = org.website
    ? '<a href="https://' + org.website + '" target="_blank" rel="noopener" style="color:var(--green);font-size:11px;">' + org.website + ' ↗</a>'
    : '';

  document.getElementById('od-content').innerHTML =
    // Header
    '<div style="display:flex;align-items:flex-start;gap:12px;margin-bottom:16px;">'
    + '<div class="dlogo" style="flex-shrink:0;">' + initials + '</div>'
    + '<div style="flex:1;min-width:0;">'
    +   '<h2 style="font-family:\'Barlow Condensed\',sans-serif;font-size:22px;font-weight:900;line-height:1.1;">' + org.name + '</h2>'
    +   '<div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap;margin-top:4px;">'
    +     '<span class="ostatus ' + org.orgStatus + '">' + cap(org.orgStatus) + '</span>'
    +     websiteHtml
    +   '</div>'
    + '</div>'
    + '<div style="display:flex;gap:6px;flex-shrink:0;">' + editOrgBtn + '</div>'
    + '</div>'

    // Season panel (full width, prominent)
    + '<div class="panel" style="margin-bottom:12px;border-color:var(--border-s);">'
    +   '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;gap:8px;">'
    +     '<div style="font-size:9px;text-transform:uppercase;letter-spacing:1.2px;color:var(--text-dim);font-weight:700;">Sponsorship Packages</div>'
    +     addSSBtn
    +   '</div>'
    +   '<div id="ss-list-' + org.id + '" style="display:flex;flex-direction:column;gap:6px;">' + seasonBodyHtml + '</div>'
    + '</div>'

    // Two-col below
    + '<div class="org-detail-wrap">'
    +   '<div class="org-detail-main">'
    +     contactHtml
    +     notesHtml
    +   '</div>'
    +   '<div class="org-detail-side">'
    +     '<div class="panel">'
    +       '<div style="font-size:9px;text-transform:uppercase;letter-spacing:1.2px;color:var(--text-dim);font-weight:700;margin-bottom:8px;">Contact Log</div>'
    +       addLogBtn
    +       '<div id="clog-list-' + org.id + '">' + clogHtml + '</div>'
    +     '</div>'
    +   '</div>'
    + '</div>';
}

function closeOrgDetail() { document.getElementById('org-detail-overlay').classList.remove('open'); }

// ════════════════════════════════════════════════════════
//  ORG MODAL (add / edit organisation)
// ════════════════════════════════════════════════════════
function resetOrgModal() {
  ['of-name','of-contact','of-email','of-phone','of-website','of-physaddr','of-postaddr','of-notes'].forEach(id => {
    const el = document.getElementById(id); if(el) el.value='';
  });
  document.getElementById('of-orgstatus').value = 'prospect';
  document.getElementById('of-postsame').checked = false;
  document.getElementById('of-postaddr').disabled = false;
}

function togglePostalSame() {
  const same = document.getElementById('of-postsame').checked;
  const postEl = document.getElementById('of-postaddr');
  postEl.disabled = same;
  if (same) postEl.value = document.getElementById('of-physaddr').value;
}

document.getElementById('of-physaddr').addEventListener('input', function() {
  if (document.getElementById('of-postsame').checked) document.getElementById('of-postaddr').value = this.value;
});

function openAddOrg() {
  if (!me?.edit) return;
  editOrgId = null;
  resetOrgModal();
  document.getElementById('org-m-title').textContent = 'Add Sponsor';
  document.getElementById('org-m-save').textContent  = 'Add Sponsor';
  document.getElementById('org-m-del').style.display = 'none';
  document.getElementById('org-m-sub').textContent   = 'New sponsor organisation.';
  const _btf_org_modal = document.getElementById('org-modal'); bringToFront(_btf_org_modal); _btf_org_modal.classList.add('open');
}

function openEditOrg(orgId) {
  if (!me?.edit) return;
  const org = orgs.find(o => o.id===orgId); if (!org) return;
  editOrgId = orgId;
  resetOrgModal();
  document.getElementById('org-m-title').textContent    = 'Edit Sponsor';
  document.getElementById('org-m-save').textContent     = 'Save Changes';
  document.getElementById('org-m-del').style.display    = 'block';
  document.getElementById('org-m-sub').textContent      = org.name;
  document.getElementById('of-name').value              = org.name;
  document.getElementById('of-orgstatus').value         = org.orgStatus || 'prospect';
  document.getElementById('of-contact').value           = org.primaryContact || '';
  document.getElementById('of-email').value             = org.email || '';
  document.getElementById('of-phone').value             = org.phone || '';
  document.getElementById('of-website').value           = org.website || '';
  document.getElementById('of-physaddr').value          = org.physAddr || '';
  document.getElementById('of-postaddr').value          = org.postAddr || '';
  document.getElementById('of-notes').value             = org.notes || '';
  document.getElementById('of-postsame').checked        = !!org.postSameAsPhys;
  document.getElementById('of-postaddr').disabled       = !!org.postSameAsPhys;
  const _btf_org_modal = document.getElementById('org-modal'); bringToFront(_btf_org_modal); _btf_org_modal.classList.add('open');
}

function closeOrgModal() { document.getElementById('org-modal').classList.remove('open'); editOrgId=null; }

async function saveOrg() {
  const name = document.getElementById('of-name').value.trim();
  if (!name) { showToast('Enter a business name', 'warn'); return; }
  const data = {
    id:             editOrgId || '',
    name,
    orgStatus:      document.getElementById('of-orgstatus').value,
    primaryContact: document.getElementById('of-contact').value.trim(),
    email:          document.getElementById('of-email').value.trim(),
    phone:          document.getElementById('of-phone').value.trim(),
    website:        document.getElementById('of-website').value.trim(),
    physAddr:       document.getElementById('of-physaddr').value.trim(),
    postAddr:       document.getElementById('of-postaddr').value.trim(),
    postSameAsPhys: document.getElementById('of-postsame').checked,
    notes:          document.getElementById('of-notes').value.trim(),
  };
  setSyncState('loading', 'Saving…');
  btnLoading(document.getElementById('org-m-save'), true);
  const res = await api('saveOrg', { data, isNew: !editOrgId });
  btnLoading(document.getElementById('org-m-save'), false);
  if (res.error) { showToast('Error: ' + res.error, 'err'); setSyncState('err','Save failed'); return; }
  // Local update
  const isNew = !editOrgId;
  if (!editOrgId) { data.id = res.id; orgs.push(data); }
  else { const idx=orgs.findIndex(o=>o.id===editOrgId); if(idx>=0) orgs[idx]={...orgs[idx],...data}; }
  closeOrgModal();
  render();
  setSyncState('ok', 'Saved');
  if (isNew) {
    showToast('Sponsor added ✓ — add their season sponsorship below', '');
    // Prompt to add season entry for the new org
    setTimeout(() => {
      const newOrgId = data.id;
      if (me?.edit && confirm('Sponsor "' + data.name + '" saved!\n\nWould you like to add their ' + activeSeason + ' season sponsorship package now?')) {
        openAddSS(newOrgId);
      } else {
        openOrgDetail(newOrgId);
      }
    }, 100);
  } else {
    showToast('Sponsor updated ✓');
  }
  loadAll();
}

async function deleteOrg() {
  const org = orgs.find(o => o.id===editOrgId); if (!org) return;
  if (!confirm(`Delete ${org.name} and all their season records? This cannot be undone.`)) return;
  btnLoading(document.getElementById('org-m-del'), true);
  const res = await api('deleteOrg', { id: editOrgId });
  btnLoading(document.getElementById('org-m-del'), false);
  if (res.error) { showToast('Error: ' + res.error, 'err'); return; }
  orgs = orgs.filter(o => o.id!==editOrgId);
  seasonEntries = seasonEntries.filter(s => s.orgId!==editOrgId);
  closeOrgModal(); closeOrgDetail();
  render();
  showToast('Sponsor deleted');
  loadAll();
}

// ════════════════════════════════════════════════════════
//  SEASON ENTRY MODAL
// ════════════════════════════════════════════════════════
// ════════════════════════════════════════════════════════
//  SEASON ENTRY MODAL — package-aware with checklist
// ════════════════════════════════════════════════════════
function populatePackageSelect() {
  const sel = document.getElementById('sf-package');
  if (!sel) return;
  const cur = sel.value;
  sel.innerHTML = '<option value="">— Select package —</option>';
  const active = packages.filter(p => p.active !== 'false');
  active.sort((a,b) => (b.amount||0) - (a.amount||0));
  active.forEach(p => {
    const opt = document.createElement('option');
    opt.value = p.id;
    const emoji = p.emoji || TE[p.tier] || '';
    opt.textContent = emoji + ' ' + cap(p.tier) + (p.amount ? ' — $' + Number(p.amount).toLocaleString('en-AU') : '');
    sel.appendChild(opt);
  });
  const custom = document.createElement('option');
  custom.value = 'custom';
  custom.textContent = '⭐ Custom / Other…';
  sel.appendChild(custom);
  if (cur) sel.value = cur;

  // Also rebuild sf-tier options from known tiers
  const tierSel = document.getElementById('sf-tier');
  if (tierSel) {
    const curTier = tierSel.value;
    const tiers = [...new Set(['diamond','gold','silver','bronze','community','custom', ...packages.map(p=>p.tier)])].filter(Boolean);
    tierSel.innerHTML = tiers.map(t => `<option value="${t}">${TE[t]||''} ${TL[t]||cap(t)}</option>`).join('');
    if (curTier) tierSel.value = curTier;
  }
}

function onPackageSelect() {
  const pkgId = document.getElementById('sf-package').value;
  const card  = document.getElementById('sf-pkg-card');
  const customWrap = document.getElementById('sf-custom-wrap');

  if (pkgId === 'custom') {
    card.style.display = 'none';
    customWrap.style.display = '';
    document.getElementById('sf-tier').value = 'custom';
    document.getElementById('sf-amount').value = '';
    return;
  }
  customWrap.style.display = 'none';

  const pkg = packages.find(p => p.id === pkgId);
  if (!pkg) { card.style.display = 'none'; return; }

  // Auto-fill tier and amount
  document.getElementById('sf-tier').value   = pkg.tier || 'gold';
  document.getElementById('sf-amount').value = pkg.amount || '';

  // Show benefits card
  document.getElementById('sf-pkg-card-name').textContent     = pkg.name + (pkg.description ? ' — ' + pkg.description : '');
  document.getElementById('sf-pkg-card-benefits').textContent = pkg.benefits ? '✓ ' + pkg.benefits : '';
  card.style.display = '';
  updateBalance();
}

function resetSSModal() {
  document.getElementById('sf-package').value    = '';
  document.getElementById('sf-tier').value       = 'gold';
  document.getElementById('sf-status').value     = '';
  document.getElementById('sf-amount').value     = '';
  document.getElementById('sf-paid').value       = '';
  document.getElementById('sf-invoice').value    = '';
  document.getElementById('sf-notes').value      = '';
  document.getElementById('sf-inkind-desc').value = '';
  document.getElementById('sf-custom-name').value = '';
  document.getElementById('chk-invoice').checked = false;
  document.getElementById('chk-thankyou').checked = false;
  document.getElementById('chk-logo').checked    = false;
  document.getElementById('chk-top').checked     = false;
  document.getElementById('sf-pkg-card').style.display    = 'none';
  document.getElementById('sf-custom-wrap').style.display = 'none';
  document.getElementById('sf-partial-wrap').style.display = 'none';
  document.getElementById('sf-inkind-wrap').style.display  = 'none';
  document.getElementById('sf-amount-wrap').style.display  = '';
}

function openAddSS(orgId) {
  if (!me || !me.edit) return;
  editSSId  = null;
  editSSOrg = orgId;
  const org = orgs.find(o => o.id === orgId);
  document.getElementById('ss-m-title').textContent = 'Add Season Sponsorship';
  document.getElementById('ss-m-sub').textContent   = org ? org.name : '';
  document.getElementById('ss-m-save').textContent  = 'Add Sponsorship';
  document.getElementById('ss-m-del').style.display = 'none';
  resetSSModal();
  // Always rebuild year select fresh when opening modal
  const sel = document.getElementById('sf-year');
  if (sel) {
    sel.innerHTML = years.map(y=>`<option value="${y}">${y}</option>`).join('');
    sel.value = activeSeason;
  }
  const _btf_ss_modal = document.getElementById('ss-modal'); bringToFront(_btf_ss_modal); _btf_ss_modal.classList.add('open');
}

function openEditSS(ssId, orgId) {
  if (!me || !me.edit) return;
  const ss  = seasonEntries.find(s => s.id === ssId); if (!ss) return;
  const org = orgs.find(o => o.id === orgId);
  editSSId  = ssId;
  editSSOrg = orgId;
  document.getElementById('ss-m-title').textContent = 'Edit Sponsorship Package';
  document.getElementById('ss-m-sub').textContent   = (org ? org.name : '') + ' · ' + ss.year;
  document.getElementById('ss-m-save').textContent  = 'Save Changes';
  document.getElementById('ss-m-del').style.display = 'block';

  resetSSModal();
  document.getElementById('sf-year').value      = ss.year;
  document.getElementById('sf-tier').value      = ss.tier || 'gold';
  document.getElementById('sf-status').value    = ss.status;
  document.getElementById('sf-amount').value    = ss.status === 'inkind' ? '' : (ss.amount || '');
  document.getElementById('sf-paid').value      = ss.paidAmount || '';
  document.getElementById('sf-invoice').value   = ss.invoiceNum || '';
  document.getElementById('sf-notes').value     = ss.notes || '';
  document.getElementById('sf-inkind-desc').value = ss.inkindDesc || '';
  document.getElementById('sf-custom-name').value = ss.customPackage || '';
  document.getElementById('chk-invoice').checked  = ss.chkInvoiceSent  === 'true';
  document.getElementById('chk-thankyou').checked = ss.chkThankYou     === 'true';
  document.getElementById('chk-logo').checked     = ss.chkLogoWebsite  === 'true';
  document.getElementById('chk-top').checked      = ss.chkTrainingTop  === 'true';

  // Try to match a package
  if (ss.customPackage) {
    document.getElementById('sf-package').value = 'custom';
    document.getElementById('sf-custom-wrap').style.display = '';
  } else {
    const matchPkg = packages.find(p => p.tier === ss.tier && +p.amount === +ss.amount);
    if (matchPkg) {
      document.getElementById('sf-package').value = matchPkg.id;
      document.getElementById('sf-pkg-card-name').textContent     = matchPkg.name + (matchPkg.description ? ' — ' + matchPkg.description : '');
      document.getElementById('sf-pkg-card-benefits').textContent = matchPkg.benefits ? '✓ ' + matchPkg.benefits : '';
      document.getElementById('sf-pkg-card').style.display = '';
    }
  }
  updateSSFields();
  const _btf_ss_modal = document.getElementById('ss-modal'); bringToFront(_btf_ss_modal); _btf_ss_modal.classList.add('open');
}

function closeSSModal() { document.getElementById('ss-modal').classList.remove('open'); editSSId=null; editSSOrg=null; }

function updateSSFields() {
  const status    = document.getElementById('sf-status').value;
  const isPartial = status === 'partial';
  const isInKind  = status === 'inkind';
  document.getElementById('sf-partial-wrap').style.display  = isPartial ? '' : 'none';
  document.getElementById('sf-inkind-wrap').style.display   = isInKind  ? '' : 'none';
  document.getElementById('sf-amount-wrap').style.display   = isInKind  ? 'none' : '';
  if (isInKind) document.getElementById('sf-amount').value  = '0';
  updateBalance();
}

function updateBalance() {
  const amount = +document.getElementById('sf-amount').value || 0;
  const paid   = +document.getElementById('sf-paid').value   || 0;
  const bal    = document.getElementById('sf-balance');
  if (!bal) return;
  const owing = amount - paid;
  bal.textContent = owing > 0 ? '$' + owing.toLocaleString('en-AU') : owing === 0 ? '✓ Fully paid' : 'Overpaid!';
  bal.style.color = owing > 0 ? 'var(--orange)' : 'var(--green-bright)';
  bal.style.background = owing > 0 ? 'var(--orange-light)' : 'var(--green-light)';
}

document.getElementById('sf-status').addEventListener('change', updateSSFields);

async function saveSS() {
  const pkgId      = document.getElementById('sf-package').value;
  const tier       = document.getElementById('sf-tier').value;
  const status     = document.getElementById('sf-status').value;
  const amount     = document.getElementById('sf-amount').value;
  const notes      = document.getElementById('sf-notes').value.trim();
  const inkindDesc = document.getElementById('sf-inkind-desc').value.trim();
  const customPkg  = document.getElementById('sf-custom-name').value.trim();

  if (!pkgId)  { showToast('Select a package', 'warn'); return; }
  if (!status) { showToast('Select a payment status', 'warn'); return; }
  if (pkgId === 'custom' && !customPkg) { showToast('Enter the custom package name', 'warn'); return; }
  if (status === 'inkind' && !inkindDesc) { showToast('Describe what they\'re providing', 'warn'); return; }
  const finalAmount = status === 'inkind' ? 0 : +amount;
  if (status !== 'inkind' && finalAmount <= 0) { showToast('Enter the agreed amount', 'warn'); return; }

  const data = {
    id: editSSId || '', orgId: editSSOrg,
    year:          +document.getElementById('sf-year').value,
    tier,  status,
    amount:        finalAmount,
    paidAmount:    +document.getElementById('sf-paid').value || 0,
    notes,         inkindDesc,
    invoiceNum:    document.getElementById('sf-invoice').value.trim(),
    chkInvoiceSent:  String(document.getElementById('chk-invoice').checked),
    chkThankYou:     String(document.getElementById('chk-thankyou').checked),
    chkLogoWebsite:  String(document.getElementById('chk-logo').checked),
    chkTrainingTop:  String(document.getElementById('chk-top').checked),
    customPackage:   pkgId === 'custom' ? customPkg : '',
  };

  setSyncState('loading', 'Saving…');
  btnLoading(document.getElementById('ss-m-save'), true);
  const res = await api('saveSeason', { data, isNew: !editSSId });
  btnLoading(document.getElementById('ss-m-save'), false);
  if (res.error) { showToast('Error: ' + res.error, 'err'); setSyncState('err', 'Save failed'); return; }
  if (!editSSId) { data.id = res.id; seasonEntries.push(data); }
  else { const idx = seasonEntries.findIndex(s => s.id === editSSId); if (idx >= 0) seasonEntries[idx] = {...seasonEntries[idx], ...data}; }
  setSyncState('ok', 'Saved');
  const reopenOrgId = editSSOrg;
  closeSSModal(); render();
  showToast(editSSId ? 'Package updated ✓' : 'Sponsorship added ✓');
  if (reopenOrgId) setTimeout(() => openOrgDetail(reopenOrgId), 80);
  loadAll();
}

async function deleteSS() {
  if (!confirm('Remove this season entry?')) return;
  btnLoading(document.getElementById('ss-m-del'), true);
  const res = await api('deleteSeason', { id: editSSId });
  btnLoading(document.getElementById('ss-m-del'), false);
  if (res.error) { showToast('Error: '+res.error, 'err'); return; }
  const reopenOrgId = editSSOrg;
  seasonEntries = seasonEntries.filter(s => s.id !== editSSId);
  closeSSModal(); render();
  showToast('Sponsorship entry removed');
  if (reopenOrgId) setTimeout(() => openOrgDetail(reopenOrgId), 100);
  loadAll();
}

// ════════════════════════════════════════════════════════
//  CONTACT LOG MODAL
// ════════════════════════════════════════════════════════
let clOrgId = null;

function openContactLog(orgId) {
  clOrgId = orgId;
  const org = orgs.find(o=>o.id===orgId);
  document.getElementById('cl-m-sub').textContent = org ? org.name : '';
  document.getElementById('clf-date').value  = new Date().toISOString().slice(0,10);
  document.getElementById('clf-notes').value = '';
  const _btf_cl_modal = document.getElementById('cl-modal'); bringToFront(_btf_cl_modal); _btf_cl_modal.classList.add('open');
}

function closeContactLog() { document.getElementById('cl-modal').classList.remove('open'); clOrgId=null; }

async function saveContactLog() {
  const notes = document.getElementById('clf-notes').value.trim();
  if (!notes) { showToast('Enter some notes', 'warn'); return; }
  const date = document.getElementById('clf-date').value;
  btnLoading(document.getElementById('cl-m-save'), true);
  const res = await api('addContactLog', { orgId: clOrgId, date, notes });
  btnLoading(document.getElementById('cl-m-save'), false);
  if (res.error) { showToast('Error: '+res.error, 'err'); return; }
  closeContactLog();
  showToast('Contact logged ✓');
  // Refresh the org detail if open
  const od = document.getElementById('org-detail-overlay');
  if (od.classList.contains('open')) openOrgDetail(clOrgId);
}

async function deleteContactEntry(id, orgId) {
  if (!confirm('Delete this contact log entry?')) return;
  await api('deleteContactLog', { id });
  openOrgDetail(orgId); // refresh
}

// ════════════════════════════════════════════════════════
//  DRILL DOWN
// ════════════════════════════════════════════════════════
function openDrill(title, ssList) {
  document.getElementById('drill-title').textContent = title;
  document.getElementById('drill-tbody').innerHTML = ssList.map(s => {
    const org = orgs.find(o=>o.id===s.orgId)||{name:s.orgId};
    return `<tr onclick="openOrgDetail('${s.orgId}')" style="cursor:pointer">
      <td><strong>${org.name}</strong></td>
      <td><span class="tchip ${s.tier}">${TL[s.tier]||cap(s.tier)}</span></td>
      <td>${s.status==='inkind'?'<span style="color:#6d28d9;font-size:11px">In-Kind</span>':fmt(s.amount)}</td>
      <td><span class="sbadge ${s.status}">${cap(s.status)}</span></td>
    </tr>`;
  }).join('');
  const _btf_drillPanel = document.getElementById('drillPanel'); bringToFront(_btf_drillPanel); _btf_drillPanel.classList.add('open');
}

function drillInKind() {
  const ss = ssForYear(activeSeason).filter(s => s.status === 'inkind');
  openDrill('In-Kind Sponsors — ' + activeSeason + ' (' + ss.length + ')', ss);
}

function closeDrill() { document.getElementById('drillPanel').classList.remove('open'); }
function drillTotal() {
  const ss = ssForYear(activeSeason).sort((a,b)=>(TO[a.tier]||5)-(TO[b.tier]||5));
  openDrill('All Sponsors — ' + activeSeason + ' (' + fmt(ss.filter(s=>s.status!=='inkind').reduce((a,s)=>a+ +s.amount,0)) + ')', ss);
}
function drillPaid() {
  const ss = ssForYear(activeSeason).filter(s=>s.status==='paid'||s.status==='partial').sort((a,b)=>(TO[a.tier]||5)-(TO[b.tier]||5));
  openDrill('Received — ' + activeSeason, ss);
}
function drillOut() {
  const ss = ssForYear(activeSeason).filter(s=>s.status==='outstanding'||s.status==='partial').sort((a,b)=>(TO[a.tier]||5)-(TO[b.tier]||5));
  openDrill('Outstanding — ' + activeSeason, ss);
}

// ════════════════════════════════════════════════════════
//  SEASON YEAR MODAL
// ════════════════════════════════════════════════════════
function openSeasonModal() {
  document.getElementById('new-season-yr').value = (years[0]||2025) + 1;
  const _btf_season_modal = document.getElementById('season-modal'); bringToFront(_btf_season_modal); _btf_season_modal.classList.add('open');
}
function closeSeasonModal() { document.getElementById('season-modal').classList.remove('open'); }
async function confirmAddSeason() {
  const y = +document.getElementById('new-season-yr').value;
  if (!y||y<2020||y>2045) { showToast('Enter a valid year','warn'); return; }
  if (years.includes(y)) { showToast(y+' already exists','warn'); closeSeasonModal(); return; }
  setSyncState('loading','Adding season…');
  const res = await api('addSeason', { year: y });
  if (res.error) { showToast('Error: '+res.error,'err'); return; }
  years.unshift(y); years.sort((a,b)=>b-a);
  closeSeasonModal(); renderSeasonTabs();
  showToast('Season '+y+' added ✓');
}

// ════════════════════════════════════════════════════════
//  EXPORT CSV
// ════════════════════════════════════════════════════════
function exportCSV() {
  const ss = ssForYear(activeSeason);
  const rows = [['Sponsor','Tier','Amount','Status','Received','Contact','Email','Phone','Website','Notes']];
  ss.forEach(s => {
    const org = orgs.find(o=>o.id===s.orgId)||{name:s.orgId};
    rows.push([org.name,s.tier,s.amount,s.status,s.paidAmount||0,org.primaryContact||'',org.email||'',org.phone||'',org.website||'',org.notes||'']);
  });
  const csv = rows.map(r=>r.map(v=>'"'+String(v).replace(/"/g,'""')+'"').join(',')).join('\n');
  const a = document.createElement('a');
  a.href = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csv);
  a.download = 'KJFC_Sponsors_' + activeSeason + '.csv';
  a.click();
  showToast('CSV exported ✓');
}

// ════════════════════════════════════════════════════════
//  LOGOUT
// ════════════════════════════════════════════════════════
async function doLogout() {
  const _btf_reset_modal = document.getElementById('reset-modal'); bringToFront(_btf_reset_modal); _btf_reset_modal.classList.add('open');
}
function closeResetModal() { document.getElementById('reset-modal').classList.remove('open'); }
async function confirmLogout() {
  clearSession();
  if (window.google) google.accounts.id.disableAutoSelect();
  closeResetModal();
  location.reload();
}

// ════════════════════════════════════════════════════════
//  ADMIN MODAL
// ════════════════════════════════════════════════════════
async function openAdminModal(tab) {
  const modal = document.getElementById('admin-modal');
  // Show/hide admin-only tabs based on role
  modal.querySelectorAll('.adm-tab[data-tab="log"], .adm-tab[data-tab="users"]').forEach(b => {
    b.style.display = (me && me.admin) ? '' : 'none';
  });
  bringToFront(modal); modal.classList.add('open');
  // Set active tab
  document.querySelectorAll('.adm-tab').forEach(b => b.classList.toggle('act', b.dataset.tab===tab));
  await loadAdminTab(tab);
}
function closeAdminModal() { document.getElementById('admin-modal').classList.remove('open'); }

async function loadAdminTab(tab) {
  const body = document.getElementById('adm-body');
  if (tab==='packages') {
    renderPackageManager();
    return;
  }
  if (tab==='log') {
    body.innerHTML = '<div style="color:var(--text-dim);font-size:13px;padding:12px 0;">Loading…</div>';
    const res = await api('getLog');
    if (!Array.isArray(res)) { body.innerHTML='<div style="color:var(--red)">Failed to load</div>'; return; }
    body.innerHTML = `<div style="overflow-x:auto;"><table class="stable" style="font-size:12px;min-width:500px;">
      <thead><tr><th>Time</th><th>User</th><th>Action</th><th>Details</th></tr></thead>
      <tbody>${res.map(r=>`<tr style="cursor:default"><td style="white-space:nowrap">${fmtD(r.timestamp)}</td><td>${r.user||''}</td><td><span style="font-weight:700">${r.action||''}</span></td><td style="color:var(--text-dim)">${r.details||''}</td></tr>`).join('')}</tbody>
    </table></div>`;
    return;
  }
  if (tab==='users') {
    body.innerHTML = '<div style="color:var(--text-dim);font-size:13px;padding:12px 0;">Loading…</div>';
    const res = await api('getUsers');
    if (!Array.isArray(res)) { body.innerHTML='<div style="color:var(--red)">Failed to load users</div>'; return; }

    const accessLabel = { admin:'Admin', edit:'Can Edit', readonly:'Read Only' };
    const accessColor = { admin:'var(--green)', edit:'#0d47a1', readonly:'var(--text-dim)' };

    body.innerHTML = `
      <div style="display:flex;justify-content:flex-end;margin-bottom:12px;">
        <button class="mprimary" style="padding:7px 16px;font-size:12px;" onclick="openUserModal(null)">+ Add User</button>
      </div>
      <div style="display:flex;flex-direction:column;gap:8px;" id="users-list">
        ${res.map(u => {
          const acc = u.admin?'admin': u.edit?'edit':'readonly';
          const init = (u.name||u.email).split(' ').map(w=>w[0]).join('').toUpperCase().slice(0,2);
          return `<div style="display:flex;align-items:center;gap:10px;padding:12px 14px;background:var(--bg);border-radius:9px;border:1.5px solid var(--border);">
            <div style="width:36px;height:36px;border-radius:50%;background:var(--green-light);display:flex;align-items:center;justify-content:center;font-family:'Barlow Condensed',sans-serif;font-weight:900;font-size:14px;color:var(--green);flex-shrink:0;">${init}</div>
            <div style="flex:1;min-width:0;">
              <div style="font-weight:700;font-size:14px;">${u.name||'—'}</div>
              <div style="font-size:11px;color:var(--text-dim);">${u.email} · <span style="font-weight:600">${u.role||'Member'}</span></div>
            </div>
            <span style="font-size:10px;font-weight:800;color:${accessColor[acc]||'var(--text-dim)'};background:var(--bg);border:1.5px solid var(--border);padding:2px 8px;border-radius:10px;white-space:nowrap;">${accessLabel[acc]||acc}</span>
            <button class="actbtn" onclick='openUserModal(${JSON.stringify(u).replace(/'/g,"&#39;")})'>Edit</button>
          </div>`;
        }).join('')}
      </div>
      <p style="font-size:11px;color:var(--text-dim);margin-top:12px;">Users are managed in the <strong>Users</strong> sheet. Changes take effect immediately — no redeploy needed.</p>
    `;
    return;
  }
}

let editingUser = null;

// Let current user edit their own name/role
function openEditMe() {
  if (!me) return;
  openUserModal({ email: me.email, name: me.name, role: me.role, admin: me.admin, edit: me.edit });
}

function openUserModal(u) {
  editingUser = u;
  const isNew = !u;
  const viewerIsAdmin = me && me.admin;
  const isSelf = u && me && u.email === me.email;

  document.getElementById('um-title').textContent = isNew ? 'Add User' : (isSelf ? 'My Profile' : 'Edit User');
  document.getElementById('um-email').value    = u ? u.email : '';
  document.getElementById('um-email').disabled = !isNew;
  document.getElementById('um-name').value     = u ? (u.name||'') : '';
  document.getElementById('um-name').disabled  = !viewerIsAdmin;
  populateRoleSelect();
  document.getElementById('um-role').value     = u ? (u.role||'Member') : 'Member';
  document.getElementById('um-role').disabled  = !viewerIsAdmin;

  const accRow  = document.getElementById('um-access-row');
  const accNote = document.getElementById('um-access-note');
  if (viewerIsAdmin) {
    accRow.style.display  = 'block';
    accNote.style.display = 'none';
    const acc = u ? (u.admin?'admin': u.edit?'edit':'readonly') : 'readonly';
    document.getElementById('um-access').value = acc;
  } else {
    accRow.style.display  = 'none';
    accNote.style.display = 'block';
  }

  // Only admins can save; non-admins see read-only profile info
  const saveBtn = document.getElementById('user-modal').querySelector('.mprimary');
  if (saveBtn) saveBtn.style.display = viewerIsAdmin ? '' : 'none';
  const cancelBtn = document.getElementById('user-modal').querySelector('.msecondary');
  if (cancelBtn) cancelBtn.textContent = viewerIsAdmin ? 'Cancel' : 'Close';

  const delBtn = document.getElementById('um-del-btn');
  delBtn.style.display = (viewerIsAdmin && !isNew && !isSelf) ? 'block' : 'none';

  const _btf_user_modal = document.getElementById('user-modal'); bringToFront(_btf_user_modal); _btf_user_modal.classList.add('open');
}

function closeUserModal() {
  document.getElementById('user-modal').classList.remove('open');
  editingUser = null;
}

async function confirmEditUser() {
  const email  = (document.getElementById('um-email').value||'').trim().toLowerCase();
  const name   = document.getElementById('um-name').value.trim();
  const role   = document.getElementById('um-role').value;
  if (!email) { showToast('Email is required', 'warn'); return; }

  const payload = { email, name, role };
  // Only include access if the viewer is an admin
  if (me && me.admin) {
    payload.access = document.getElementById('um-access').value;
  }

  const btn = document.getElementById('user-modal').querySelector('.mprimary');
  btnLoading(btn, true);
  const isNew  = !editingUser;
  // Always use updateUser - backend already exists. Access field simply won't be sent for non-admins.
  const action = isNew ? 'addUser' : 'updateUser';
  const res = await api(action, payload);
  btnLoading(btn, false);

  if (res.error) { showToast('Error: ' + res.error, 'err'); return; }
  closeUserModal();
  showToast(isNew ? 'User added ✓' : 'User updated ✓');
  await loadAdminTab('users');
}

async function deleteUserConfirm() {
  if (!editingUser) return;
  if (!confirm('Remove ' + (editingUser.name||editingUser.email) + '\'s access? They will no longer be able to sign in.')) return;
  const btn = document.getElementById('um-del-btn');
  btnLoading(btn, true);
  const res = await api('deleteUser', { email: editingUser.email });
  btnLoading(btn, false);
  if (res.error) { showToast('Error: ' + res.error, 'err'); return; }
  closeUserModal();
  showToast('User removed ✓');
  await loadAdminTab('users');
}

// ════════════════════════════════════════════════════════
//  PACKAGE MANAGER (admin tab)
// ════════════════════════════════════════════════════════
let editPkgId = null;

function renderPackageManager() {
  const body = document.getElementById('adm-body');
  const tierLabel = { gold:'🥇 Gold', silver:'🥈 Silver', bronze:'🥉 Bronze', community:'🤝 Community', custom:'⭐ Custom' };

  const rows = packages.length ? packages.slice().sort((a,b) => (b.amount||0) - (a.amount||0)).map(function(p) {
    const usageCount = seasonEntries.filter(function(s) {
      return s.tier === p.tier && +s.amount === +p.amount && !s.customPackage;
    }).length;
    return '<div class="pkg-row">'
      + '<div style="display:flex;align-items:flex-start;gap:10px;flex:1;min-width:0;">'
      +   '<div class="tdot ' + (p.tier||'gold') + '" style="flex-shrink:0;margin-top:3px;"></div>'
      +   '<div style="flex:1;min-width:0;">'
      +     '<div style="display:flex;align-items:baseline;gap:8px;flex-wrap:wrap;">'
      +       '<span style="font-weight:800;font-size:15px;">' + p.name + '</span>'
      +       '<span style="font-size:11px;color:var(--text-dim);">' + (tierLabel[p.tier]||p.tier) + '</span>'
      +       (p.active === 'false' ? '<span style="font-size:9px;background:#f3f4f6;color:#6b7280;padding:1px 6px;border-radius:8px;font-weight:700;">Inactive</span>' : '')
      +     '</div>'
      +     (p.description ? '<div style="font-size:12px;color:var(--text-dim);margin-top:2px;">' + p.description + '</div>' : '')
      +     (p.benefits ? '<div style="font-size:11px;color:var(--green);margin-top:3px;">✓ ' + p.benefits + '</div>' : '')
      +   '</div>'
      + '</div>'
      + '<div style="display:flex;flex-direction:column;align-items:flex-end;gap:4px;flex-shrink:0;">'
      +   '<div style="font-size:16px;font-weight:900;color:var(--text);">$' + Number(p.amount||0).toLocaleString('en-AU') + '</div>'
      +   '<div style="font-size:10px;color:var(--text-dim);">' + usageCount + ' use' + (usageCount!==1?'s':'') + '</div>'
      +   (me && me.edit ? '<button class="actbtn" onclick="openPkgModal(\'' + p.id + '\')">Edit</button>' : '')
      + '</div>'
      + '</div>';
  }).join('') : '<div style="color:var(--text-dim);font-size:13px;padding:16px 0;text-align:center;">No packages yet. Add your first one below.</div>';

  body.innerHTML = '<div style="padding-bottom:4px;">'
    + (me && me.edit ? '<button class="ss-add-btn" style="margin-bottom:14px;width:100%;text-align:center;" onclick="openPkgModal(null)">+ Add New Package</button>' : '')
    + '<div style="display:flex;flex-direction:column;gap:8px;">' + rows + '</div>'
    + '<div style="margin-top:16px;padding:12px;background:var(--yellow-pale);border:1.5px solid var(--yellow-dark);border-radius:9px;font-size:12px;color:#6b4900;">'
    +   '<strong>💡 Tip:</strong> Packages define your standard sponsorship tiers. When adding a sponsor to a season, you\'ll pick from these packages — the amount auto-fills. Use <em>Custom/Other</em> for one-off arrangements.'
    + '</div>'
    + '</div>';
}

const DEFAULT_PKG_EMOJI = {diamond:'💎',gold:'🥇',silver:'🥈',bronze:'🥉',community:'🤝',custom:'⭐'};

function onPkgTierChange() {
  const tier = document.getElementById('pf-tier').value;
  const emojiField = document.getElementById('pf-emoji');
  if (!emojiField.value || Object.values(DEFAULT_PKG_EMOJI).includes(emojiField.value)) {
    emojiField.value = DEFAULT_PKG_EMOJI[tier] || '⭐';
  }
}

function openPkgModal(pkgId) {
  editPkgId = pkgId;
  const pkg = pkgId ? packages.find(function(p){ return p.id === pkgId; }) : null;
  document.getElementById('pkg-m-title').textContent = pkg ? 'Edit Package / Tier' : 'Add Package / Tier';
  document.getElementById('pf-tier').value     = pkg ? (pkg.tier||'gold') : 'gold';
  document.getElementById('pf-emoji').value    = pkg ? (pkg.emoji || DEFAULT_PKG_EMOJI[pkg.tier] || '') : '🥇';
  document.getElementById('pf-amount').value   = pkg ? pkg.amount    : '';
  document.getElementById('pf-desc').value     = pkg ? pkg.description : '';
  document.getElementById('pf-benefits').value = pkg ? pkg.benefits  : '';
  document.getElementById('pkg-m-del').style.display = pkg ? 'block' : 'none';
  const _btf_pkg_modal = document.getElementById('pkg-modal'); bringToFront(_btf_pkg_modal); _btf_pkg_modal.classList.add('open');
}

function closePkgModal() {
  document.getElementById('pkg-modal').classList.remove('open');
  editPkgId = null;
}

async function savePkg() {
  const tier = document.getElementById('pf-tier').value;
  if (!tier) { showToast('Select a tier', 'warn'); return; }
  const data = {
    id:          editPkgId || '',
    name:        cap(tier), // name = tier capitalised
    tier,
    emoji:       document.getElementById('pf-emoji').value.trim() || DEFAULT_PKG_EMOJI[tier] || '',
    amount:      +document.getElementById('pf-amount').value || 0,
    description: document.getElementById('pf-desc').value.trim(),
    benefits:    document.getElementById('pf-benefits').value.trim(),
    active:      'true',
  };
  btnLoading(document.getElementById('pkg-m-save'), true);
  const res = await api('savePackage', { data, isNew: !editPkgId });
  btnLoading(document.getElementById('pkg-m-save'), false);
  if (res.error) { showToast('Error: ' + res.error, 'err'); return; }
  if (!editPkgId) { data.id = res.id; packages.push(data); }
  else { const idx = packages.findIndex(function(p){ return p.id === editPkgId; }); if (idx>=0) packages[idx] = {...packages[idx], ...data}; }
  rebuildTierLookups();
  populatePackageSelect();
  closePkgModal();
  renderPackageManager();
  showToast(editPkgId ? 'Package updated ✓' : 'Package added ✓');
}

async function deletePkg() {
  if (!editPkgId) return;
  const pkg = packages.find(function(p){ return p.id === editPkgId; });
  const inUse = seasonEntries.filter(function(s){ return s.tier === (pkg&&pkg.tier) && +s.amount === +(pkg&&pkg.amount) && !s.customPackage; }).length;
  if (inUse > 0 && !confirm('This package is used by ' + inUse + ' sponsor entry/entries. Delete anyway?')) return;
  btnLoading(document.getElementById('pkg-m-del'), true);
  const res = await api('deletePackage', { id: editPkgId });
  btnLoading(document.getElementById('pkg-m-del'), false);
  if (res.error) { showToast('Error: ' + res.error, 'err'); return; }
  packages = packages.filter(function(p){ return p.id !== editPkgId; });
  rebuildTierLookups();
  populatePackageSelect();
  closePkgModal();
  renderPackageManager();
  showToast('Package deleted');
}

// ════════════════════════════════════════════════════════
//  ROLES
// ════════════════════════════════════════════════════════
const DEFAULT_ROLES = ['President','Vice President','Treasurer','Secretary','Registrar','Committee Member','Coach','Team Manager','Volunteer','Administrator','Member'];
function getRoles() { try { return JSON.parse(localStorage.getItem('kjfc_roles')) || DEFAULT_ROLES; } catch { return DEFAULT_ROLES; } }
function saveRoles(r) { localStorage.setItem('kjfc_roles', JSON.stringify(r)); }
function populateRoleSelect() { const s=document.getElementById('um-role'); s.innerHTML=getRoles().map(r=>`<option>${r}</option>`).join(''); }
function openManageRoles() { renderRolesList(); const _btf_roles_modal = document.getElementById('roles-modal'); bringToFront(_btf_roles_modal); _btf_roles_modal.classList.add('open'); }
function closeManageRoles() { document.getElementById('roles-modal').classList.remove('open'); populateRoleSelect(); }
function renderRolesList() {
  const roles=getRoles();
  document.getElementById('roles-list').innerHTML = roles.map((r,i)=>`
    <div class="role-tag"><span>${r}</span>
      ${DEFAULT_ROLES.includes(r)?'<span style="font-size:9px;color:var(--text-dim);margin-left:auto">default</span>':
        `<button onclick="deleteRole(${i})" style="background:none;border:none;color:var(--red);cursor:pointer;font-size:13px;margin-left:auto;">✕</button>`}
    </div>`).join('');
}
function addCustomRole() { const v=document.getElementById('new-role-input').value.trim(); if(!v) return; const r=getRoles(); if(!r.includes(v)) r.push(v); saveRoles(r); document.getElementById('new-role-input').value=''; renderRolesList(); showToast('Role added ✓'); }
function deleteRole(i) { const r=getRoles(); if(DEFAULT_ROLES.includes(r[i])) return; r.splice(i,1); saveRoles(r); renderRolesList(); }

// ════════════════════════════════════════════════════════
//  BUTTON LOADING
// ════════════════════════════════════════════════════════
function btnLoading(el, isLoading) {
  if (!el) return;
  if (isLoading) { el.classList.add('btn-loading'); el.disabled=true; }
  else           { el.classList.remove('btn-loading'); el.disabled=false; }
}

// ════════════════════════════════════════════════════════
//  SYNC STATE / TOAST
// ════════════════════════════════════════════════════════
function setSyncState(state, text) {
  const el = document.getElementById('sync-state'); if (!el) return;
  el.textContent = (state==='loading'?'⟳ ':state==='err'?'✕ ':'● ') + text;
  el.className = 'sync-' + state;
}

function fmt(n)    { return '$' + Number(n).toLocaleString('en-AU'); }

function fmtPhone(p) {
  if (!p) return '—';
  // Strip all spaces and non-digits except leading +
  var s = String(p).trim();
  var digits = s.replace(/\D/g, '');
  // Ensure leading zero for local Australian numbers
  if (digits.length === 9 && !digits.startsWith('0')) digits = '0' + digits;
  // Mobile: 04xx xxx xxx (10 digits starting with 04)
  if (digits.length === 10 && digits.startsWith('04')) {
    return digits.slice(0,4) + ' ' + digits.slice(4,7) + ' ' + digits.slice(7);
  }
  // Local landline: 0x xxxx xxxx (10 digits starting with 0, second digit not 4)
  if (digits.length === 10 && digits.startsWith('0')) {
    return digits.slice(0,2) + ' ' + digits.slice(2,6) + ' ' + digits.slice(6);
  }
  // 1300/1800 freecall: 1xxx xxx xxx
  if (digits.length === 10 && (digits.startsWith('13') || digits.startsWith('18'))) {
    return digits.slice(0,4) + ' ' + digits.slice(4,7) + ' ' + digits.slice(7);
  }
  // International +61
  if (s.startsWith('+61') && digits.length === 11) {
    return '+61 ' + fmtPhone('0' + digits.slice(2));
  }
  // Fallback — return as-is but ensure leading zero preserved
  return s;
}

function cap(s)    { return s ? s.charAt(0).toUpperCase() + s.slice(1) : ''; }
function fmtTime(d){ return d.toLocaleTimeString('en-AU', { hour:'2-digit', minute:'2-digit' }); }
function fmtD(iso) {
  if (!iso) return '';
  try { const d=new Date(iso); return d.toLocaleDateString('en-AU',{day:'2-digit',month:'short',year:'numeric'})+' '+d.toLocaleTimeString('en-AU',{hour:'2-digit',minute:'2-digit'}); }
  catch { return iso; }
}

let _toastTimer;
function showToast(msg, type='') {
  const t=document.getElementById('toast');
  t.textContent=msg; t.className='toast'+(type?' toast-'+type:''); t.classList.add('show');
  clearTimeout(_toastTimer); _toastTimer=setTimeout(()=>t.classList.remove('show'),3200);
}

// ════════════════════════════════════════════════════════
//  INIT
// ════════════════════════════════════════════════════════
function init() {
  loadSession();

  // Wire org modal
  document.getElementById('org-m-save').addEventListener('click', saveOrg);
  document.getElementById('org-m-cancel').addEventListener('click', closeOrgModal);
  document.getElementById('org-mclose').addEventListener('click', closeOrgModal);
  document.getElementById('org-m-del').addEventListener('click', deleteOrg);
  document.getElementById('org-modal').addEventListener('click', e => { if(e.target===document.getElementById('org-modal')) closeOrgModal(); });

  // Wire season modal
  document.getElementById('ss-m-save').addEventListener('click', saveSS);
  document.getElementById('ss-m-cancel').addEventListener('click', closeSSModal);
  document.getElementById('ss-mclose').addEventListener('click', closeSSModal);
  document.getElementById('ss-m-del').addEventListener('click', deleteSS);
  document.getElementById('ss-modal').addEventListener('click', e => { if(e.target===document.getElementById('ss-modal')) closeSSModal(); });

  // Wire contact log modal
  document.getElementById('cl-m-save').addEventListener('click', saveContactLog);
  document.getElementById('cl-m-cancel').addEventListener('click', closeContactLog);
  document.getElementById('cl-mclose').addEventListener('click', closeContactLog);
  document.getElementById('cl-modal').addEventListener('click', e => { if(e.target===document.getElementById('cl-modal')) closeContactLog(); });

  // Wire org detail overlay
  document.getElementById('od-close').addEventListener('click', closeOrgDetail);
  document.getElementById('org-detail-overlay').addEventListener('click', e => { if(e.target===document.getElementById('org-detail-overlay')) closeOrgDetail(); });

  // Wire season year modal
  document.getElementById('reset-modal').addEventListener('click', e => { if(e.target===document.getElementById('reset-modal')) closeResetModal(); });

  // Wire roles modal
  const _nri = document.getElementById('new-role-input');
  if (_nri) _nri.addEventListener('keydown', e => { if(e.key==='Enter') addCustomRole(); });
  const _rm = document.getElementById('roles-modal');
  if (_rm) _rm.addEventListener('click', e => { if(e.target===_rm) closeManageRoles(); });

  // Wire admin modal
  const _am = document.getElementById('admin-modal');
  if (_am) _am.addEventListener('click', e => { if(e.target===_am) closeAdminModal(); });

  // Wire pkg modal
  const _pm = document.getElementById('pkg-modal');
  if (_pm) _pm.addEventListener('click', e => { if(e.target===_pm) closePkgModal(); });

  // Hide loading screen
  setTimeout(() => {
    const ls = document.getElementById('loading-screen');
    ls.classList.add('fade');
    setTimeout(() => { ls.style.display='none'; }, 500);
  }, 1200);

  if (token && me) {
    showApp();
  } else {
    document.getElementById('login-view').style.display='flex';
    initGoogleSignIn();
  }
}


// ════════════════════════════════════════════════════════
//  PLAYER MODULE
// ════════════════════════════════════════════════════════
let plData       = null;  // { players, seasons, seasonYears, settings, teams }
let plSeason     = null;
let plTab        = 'overview';
let plSearchQ    = '';
let plDetailId   = null;  // profileId of open player detail

// ── OPEN / CLOSE ─────────────────────────────────────────────────
function openPlayersModal() {
  const modal = document.getElementById('players-modal');
  bringToFront(modal);
  modal.classList.add('open');
  initPlayerSeasonSel();
  if (!plData) loadPlayerData();
}

function closePlayersModal() {
  document.getElementById('players-modal').classList.remove('open');
}

function closePlayerDetail() {
  document.getElementById('player-detail-modal').classList.remove('open');
  plDetailId = null;
}

// ── SEASON SELECTOR ───────────────────────────────────────────────
function initPlayerSeasonSel() {
  const sel = document.getElementById('pl-season-sel');
  const cur  = new Date().getFullYear();
  // Use sponsorship years as baseline; if loadAll() hasn't completed yet,
  // fall back to a range of recent years so the modal is still usable.
  const baseYears = (years && years.length > 0)
    ? [...years]
    : [cur, cur-1, cur-2, cur-3, cur-4]; // fallback: last 5 years
  const opts = baseYears.sort((a,b)=>b-a);
  const selected = plSeason || cur;
  sel.innerHTML = opts.map(y =>
    `<option value="${y}" ${y==selected?'selected':''}>${y}</option>`
  ).join('');
  if (!plSeason) plSeason = selected;
}

// ── LOAD PLAYER DATA ──────────────────────────────────────────────
async function loadPlayerData() {
  document.getElementById('pl-body').innerHTML =
    '<div style="text-align:center;padding:40px;color:var(--text-dim)"><div class="ls-spinner" style="margin:0 auto 12px"></div>Loading player data…</div>';
  const res = await api('getPlayerData', { season: plSeason });
  if (res.error) {
    document.getElementById('pl-body').innerHTML =
      `<div style="color:var(--red);padding:20px">${res.error}</div>`;
    return;
  }
  plData = res;
  // Merge player season years into season selector
  if (res.seasonYears && res.seasonYears.length) {
    const sel = document.getElementById('pl-season-sel');
    const existing = [...sel.options].map(o=>+o.value);
    res.seasonYears.forEach(y => {
      if (!existing.includes(+y)) {
        const o = document.createElement('option');
        o.value = y; o.textContent = y;
        sel.appendChild(o);
      }
    });
  }
  renderPlTab();
}

async function loadPlayerView() {
  plSeason = +document.getElementById('pl-season-sel').value;
  plData = null;
  await loadPlayerData();
}

// ── TAB SWITCHING ─────────────────────────────────────────────────
function switchPlTab(btn, tab) {
  document.querySelectorAll('.pl-tab').forEach(b => b.classList.toggle('act', b===btn));
  plTab = tab;
  renderPlTab();
}

function renderPlTab() {
  if (!plData) { loadPlayerData(); return; }
  const fns = {
    overview: renderPlOverview,
    players:  renderPlPlayers,
    lapsed:   renderPlLapsed,
    schools:  renderPlSchools,
    teams:    renderPlTeams,
    import:   renderPlImport,
    settings: renderPlSettings,
  };
  (fns[plTab] || renderPlOverview)();
}

// ── HELPERS ───────────────────────────────────────────────────────
function plSeasonRows() {
  return (plData.seasons||[]).filter(s => +s.year === +plSeason);
}

function plSeasonTeams() {
  return (plData.teams||[]).filter(t => +t.season === +plSeason);
}

function plTeamById(id) {
  return (plData.teams||[]).find(t => t.id === id) || null;
}

function plPlayerMap() {
  const m = {};
  (plData.players||[]).forEach(p => m[p.profileId] = p);
  return m;
}

// Effective age group for a player in a season row:
// dispensation overrides to assignedTeam, else calcAge → U-group
function effectiveAgeGroup(ps) {
  if (ps.dispensation && ps.assignedTeam) return ps.assignedTeam;
  if (ps.calcAge) return 'U' + ps.calcAge;
  if (ps.ageGroupRaw) return ps.ageGroupRaw;
  return '?';
}

// Get settings map: ageGroup → setting
function settingsMap() {
  const m = {};
  (plData.settings||[]).forEach(s => m[s.ageGroup] = s);
  return m;
}

function agColour(count, min, max) {
  if (!min) return 'grey';
  if (count >= min) return 'green';
  if (count >= Math.ceil(min * 0.7)) return 'amber';
  return 'red';
}

function plInitials(p) {
  return ((p.firstName||'?')[0] + (p.lastName||'?')[0]).toUpperCase();
}
// Display-safe full name: applies title case so DB inconsistencies don't show in UI
function plName(p) {
  return toTitleCase(p.firstName||'') + ' ' + toTitleCase(p.lastName||'');
}

// ── OVERVIEW TAB ─────────────────────────────────────────────────
function renderPlOverview() {
  const rows   = plSeasonRows();
  const pm     = plPlayerMap();
  const sm     = settingsMap();
  const total  = rows.length;
  const boys   = rows.filter(r => (pm[r.profileId]||{}).gender === 'Male').length;
  const girls  = rows.filter(r => (pm[r.profileId]||{}).gender === 'Female').length;
  const newP   = rows.filter(r => r.newToClub === 'Yes').length;
  const disp   = rows.filter(r => r.dispensation === true || r.dispensation === 'true').length;

  // Group by effective age group
  const byAG = {};
  rows.forEach(r => {
    const ag = effectiveAgeGroup(r);
    if (!byAG[ag]) byAG[ag] = [];
    byAG[ag].push(r);
  });

  const agOrder = ['U9','U10','U11','U12','U13','U14','U15','U16','U17','?'];
  const agCards = agOrder.filter(ag => byAG[ag]).map(ag => {
    const group   = byAG[ag];
    const setting = sm[ag] || { minPlayers: 14, maxPlayers: 24 };
    const count   = group.length;
    const min     = +setting.minPlayers || 14;
    const max     = +setting.maxPlayers || 24;
    const colour  = agColour(count, min, max);
    const pct     = Math.min(100, Math.round(count/max*100));
    const dispCount = group.filter(r=>r.dispensation===true||r.dispensation==='true').length;
    const boyCount = group.filter(r=>(pm[r.profileId]||{}).gender==='Male').length;
    const girlCount = group.filter(r=>(pm[r.profileId]||{}).gender==='Female').length;
    return `<div class="ag-card ${colour}" onclick="showAgeGroup('${ag}')">
      ${dispCount>0?`<div class="ag-disp">⚡ ${dispCount} disp.</div>`:''}
      <div class="ag-label">${ag}</div>
      <div class="ag-count" style="color:${colour==='green'?'#16a34a':colour==='amber'?'#ca8a04':'#dc2626'}">${count}</div>
      <div class="ag-bar-wrap"><div class="ag-bar-fill" style="width:${pct}%;background:${colour==='green'?'#16a34a':colour==='amber'?'#ca8a04':'#dc2626'}"></div></div>
      <div class="ag-meta">Min ${min} · Max ${max}</div>
      <div class="ag-meta">${boyCount}M · ${girlCount}F</div>
    </div>`;
  }).join('');

  // Recruit needed: age groups with enough players to plausibly need just a few more
  const alerts = agOrder.filter(ag => byAG[ag]).map(ag => {
    const count = (byAG[ag]||[]).length;
    const min   = +(sm[ag]||{minPlayers:14}).minPlayers || 14;
    if (count < min) {
      const need = min - count;
      return `<div style="display:flex;align-items:center;gap:8px;padding:8px 10px;background:#fff;border-radius:8px;margin-bottom:6px;border-left:3px solid ${count<Math.ceil(min*.5)?'#dc2626':'#ca8a04'}">
        <span style="font-size:18px;">${count<Math.ceil(min*.5)?'🔴':'🟡'}</span>
        <div><strong>${ag}</strong> — needs ${need} more player${need!==1?'s':''} <span style="color:var(--text-dim);font-size:11px">(${count}/${min} min)</span></div>
      </div>`;
    }
    return null;
  }).filter(Boolean);

  document.getElementById('pl-body').innerHTML = `
    <div class="pl-kpi-grid">
      <div class="pl-kpi"><div class="pl-kpi-label">Registered ${plSeason}</div><div class="pl-kpi-val">${total}</div><div class="pl-kpi-sub">${boys} boys · ${girls} girls</div></div>
      <div class="pl-kpi"><div class="pl-kpi-label">Age Groups</div><div class="pl-kpi-val">${Object.keys(byAG).filter(k=>k!=='?').length}</div><div class="pl-kpi-sub">${agOrder.filter(ag=>byAG[ag]&&(byAG[ag].length>=(+(sm[ag]||{}).minPlayers||14))).length} viable teams</div></div>
      <div class="pl-kpi"><div class="pl-kpi-label">New to Club</div><div class="pl-kpi-val" style="color:var(--green-bright)">${newP}</div><div class="pl-kpi-sub">first season at KJFC</div></div>
      <div class="pl-kpi"><div class="pl-kpi-label">Dispensations</div><div class="pl-kpi-val" style="color:#7c3aed">${disp}</div><div class="pl-kpi-sub">age override active</div></div>
    </div>

    <h3 style="font-family:'Barlow Condensed',sans-serif;font-weight:900;font-size:16px;text-transform:uppercase;letter-spacing:.5px;margin-bottom:12px;color:var(--text);">Age Group Breakdown — ${plSeason}</h3>
    ${total===0?'<div style="color:var(--text-dim);padding:20px;text-align:center">No player data for this season. Use the Import tab to load players.</div>':agCards||'<div style="color:var(--text-dim)">No players this season.</div>'}

    ${alerts.length?`<h3 style="font-family:'Barlow Condensed',sans-serif;font-weight:900;font-size:16px;text-transform:uppercase;letter-spacing:.5px;margin:20px 0 10px;color:var(--text);">🎯 Recruitment Focus</h3><div style="background:var(--bg);border-radius:10px;padding:12px;">${alerts.join('')}</div>`:''}
  `;
}

function showAgeGroup(ag) {
  switchPlTab(document.querySelector('.pl-tab[data-tab="players"]'), 'players');
  setTimeout(()=>{ document.getElementById('pl-filter-ag').value=ag; renderFilteredPlayers(); }, 50);
}

// ── PLAYERS TAB ───────────────────────────────────────────────────
function renderPlPlayers() {
  const rows = plSeasonRows();
  const pm   = plPlayerMap();
  const ags  = [...new Set(rows.map(r=>effectiveAgeGroup(r)))].sort();

  document.getElementById('pl-body').innerHTML = `
    <div style="display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap;align-items:center;">
      <input class="pl-search" id="pl-search" placeholder="Search name, school, suburb…" oninput="renderFilteredPlayers()" style="flex:1;min-width:180px;">
      <select id="pl-filter-ag" onchange="renderFilteredPlayers()" style="padding:8px 10px;border:1.5px solid var(--border);border-radius:8px;font-size:12px;background:var(--card);">
        <option value="">All age groups</option>
        ${ags.map(a=>`<option value="${a}">${a}</option>`).join('')}
      </select>
      <select id="pl-filter-gender" onchange="renderFilteredPlayers()" style="padding:8px 10px;border:1.5px solid var(--border);border-radius:8px;font-size:12px;background:var(--card);">
        <option value="">All genders</option>
        <option value="Male">Boys</option>
        <option value="Female">Girls</option>
      </select>
    </div>
    <div id="pl-table-wrap"></div>
  `;
  renderFilteredPlayers();
}

function renderFilteredPlayers() {
  const rows   = plSeasonRows();
  const pm     = plPlayerMap();
  const q      = (document.getElementById('pl-search')?.value||'').toLowerCase();
  const agF    = document.getElementById('pl-filter-ag')?.value||'';
  const genF   = document.getElementById('pl-filter-gender')?.value||'';

  let filtered = rows.map(r => ({ ps: r, p: pm[r.profileId]||{} }))
    .filter(({ps,p}) => {
      if (agF  && effectiveAgeGroup(ps) !== agF)  return false;
      if (genF && p.gender !== genF)               return false;
      if (q) {
        const hay = [p.firstName,p.lastName,p.school,p.suburb,effectiveAgeGroup(ps)].join(' ').toLowerCase();
        if (!hay.includes(q)) return false;
      }
      return true;
    })
    .sort((a,b) => (a.p.lastName||'').localeCompare(b.p.lastName||''));

  const wrap = document.getElementById('pl-table-wrap');
  if (!wrap) return;
  if (!filtered.length) {
    wrap.innerHTML = '<div style="color:var(--text-dim);padding:20px;text-align:center;">No players match.</div>';
    return;
  }

  wrap.innerHTML = `
    <div style="font-size:11px;color:var(--text-dim);margin-bottom:8px;">${filtered.length} player${filtered.length!==1?'s':''}</div>
    <div style="overflow-x:auto;">
    <table class="pl-table">
      <thead><tr>
        <th></th><th>Name</th><th>Age Grp</th><th>Gender</th><th>School</th><th>Suburb</th><th>New</th><th>📸</th><th></th>
      </tr></thead>
      <tbody>
        ${filtered.map(({ps,p}) => {
          const ag   = effectiveAgeGroup(ps);
          const init = plInitials(p);
          const photo = p.photoUrl ? `<img src="${p.photoUrl}" onerror="this.style.display='none'">` : init;
          const dispTag = (ps.dispensation===true||ps.dispensation==='true') ? '<span class="disp-tag">disp.</span>' : '';
          return `<tr onclick="openPlayerDetail('${p.profileId}')">
            <td><div class="pl-avatar">${photo}</div></td>
            <td><strong>${plName(p)}</strong></td>
            <td>${ag} ${dispTag}</td>
            <td>${p.gender||'—'}</td>
            <td style="font-size:11px;max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${p.school||'—'}</td>
            <td style="font-size:11px;">${p.suburb||'—'}</td>
            <td>${ps.newToClub==='Yes'?'<span style="color:var(--green);font-weight:700;font-size:11px;">✓ New</span>':'—'}</td>
            <td style="text-align:center;">${p.photoConsent==='No'?'<span style="color:#dc2626;font-size:11px;" title="Opted out">✗</span>':'<span style="color:var(--green);font-size:13px;" title="Consent given (or assumed by default)">✓</span>'}</td>
            <td><button class="actbtn" onclick="event.stopPropagation();openPlayerDetail('${p.profileId}')">View</button></td>
          </tr>`;
        }).join('')}
      </tbody>
    </table></div>
  `;
}

// ── PLAYER DETAIL MODAL ───────────────────────────────────────────
function openPlayerDetail(profileId) {
  const p   = (plData.players||[]).find(x=>x.profileId===profileId);
  if (!p) return;
  const ps  = plSeasonRows().find(r=>r.profileId===profileId) || {};
  plDetailId = profileId;

  const init  = plInitials(p);
  const photo = p.photoUrl;
  const ag    = effectiveAgeGroup(ps);
  const disp  = ps.dispensation===true||ps.dispensation==='true';

  document.getElementById('pdm-avatar').innerHTML = photo
    ? `<img src="${photo}" style="width:100%;height:100%;object-fit:cover;border-radius:50%;" onerror="this.style.display='none'">${init}`
    : init;
  document.getElementById('pdm-name').textContent  = plName(p);
  document.getElementById('pdm-meta').textContent  = `${ag} · ${p.gender||''} · DOB ${normaliseDob(p.dob)||''} · ${p.suburb||''}`;

  // Compute age + eligibility for nearby groups
  const calcAgeVal = ps.calcAge ? +ps.calcAge : null;
  const eligible = calcAgeVal ? [calcAgeVal-1, calcAgeVal, calcAgeVal+1].filter(a=>a>=9&&a<=17).map(a=>'U'+a) : [];

  // Build seasons history for this player
  const allPlayerSeasons = (plData.seasons||[])
    .filter(s => s.profileId === profileId)
    .sort((a,b) => b.year - a.year);

  // Determine photo src: fileId stored → use Drive thumbnail URL pattern
  const photoSrc = photo
    ? (photo.startsWith('http') ? photo : `https://lh3.googleusercontent.com/d/${photo}=s200`)
    : null;

  document.getElementById('pdm-body').innerHTML = `
    <!-- Photo + consent -->
    <div style="display:flex;align-items:flex-start;gap:14px;margin-bottom:16px;padding-bottom:16px;border-bottom:1px solid var(--border);">
      <!-- Avatar / photo -->
      <div style="position:relative;flex-shrink:0;">
        <div id="pdm-avatar-large" style="width:72px;height:72px;border-radius:50%;overflow:hidden;background:var(--green-light);display:flex;align-items:center;justify-content:center;font-size:26px;font-weight:900;color:var(--green);font-family:'Barlow Condensed',sans-serif;cursor:pointer;border:2px solid var(--border);" onclick="document.getElementById('pdm-photo-file').click()" title="Click to upload photo">
          ${photoSrc ? `<img id="pdm-photo-img" src="${photoSrc}" style="width:100%;height:100%;object-fit:cover;" onerror="this.style.display='none'">` : ''}
          <span id="pdm-avatar-initials">${init}</span>
        </div>
        <div style="position:absolute;bottom:-2px;right:-2px;width:20px;height:20px;background:var(--green);border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;border:2px solid #fff;" onclick="document.getElementById('pdm-photo-file').click()" title="Upload photo">
          <span style="color:#fff;font-size:10px;line-height:1;">📷</span>
        </div>
        <input type="file" id="pdm-photo-file" accept="image/*" style="display:none" onchange="handlePhotoUpload(this)">
      </div>

      <!-- Photo controls -->
      <div style="flex:1;">
        <div id="pdm-photo-status" style="font-size:11px;color:var(--text-dim);margin-bottom:6px;">
          ${photoSrc ? '✓ Photo stored in Drive (private)' : 'No photo — click avatar to upload'}
        </div>
        ${photoSrc ? `<button onclick="removePlayerPhoto()" style="font-size:11px;padding:3px 10px;border:1px solid var(--border);border-radius:5px;background:#fff;cursor:pointer;color:var(--text-dim);">Remove photo</button>` : ''}
        <input type="hidden" id="pdm-photo" value="${p.photoUrl||''}">
        <div style="margin-top:10px;">
          <label style="font-size:12px;display:flex;align-items:center;gap:7px;cursor:pointer;">
            <input type="checkbox" id="pdm-photo-consent" ${p.photoConsent!=='No'?'checked':''}
              style="width:14px;height:14px;accent-color:var(--green);cursor:pointer;">
            <span style="font-weight:600;">📸 Photo consent</span>
          </label>
          <div style="font-size:10px;color:var(--text-dim);margin-top:2px;margin-left:21px;">
            ${p.photoConsent==='No' ? '<span style="color:#dc2626;">Opted out — do not publish photos</span>' : 'Consent assumed (default Yes). Uncheck only if parent has explicitly opted out.'}
          </div>
        </div>
      </div>
    </div>

    <!-- Registered seasons -->
    <div style="background:var(--bg);border-radius:10px;padding:12px 14px;margin-bottom:16px;">
      <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--text-dim);margin-bottom:8px;">Registered Seasons</div>
      ${allPlayerSeasons.length ? `
        <div style="display:flex;flex-wrap:wrap;gap:6px;">
          ${allPlayerSeasons.map(s => {
            const team = plTeamById(s.assignedTeam);
            const isCur = +s.year === +plSeason;
            return `<div style="background:${isCur?'var(--green)':'#fff'};color:${isCur?'#fff':'var(--text)'};border:1.5px solid ${isCur?'var(--green)':'var(--border)'};border-radius:8px;padding:5px 10px;font-size:12px;">
              <div style="font-weight:700;">${s.year}</div>
              <div style="font-size:10px;opacity:.8;">${s.ageGroupRaw||('U'+(s.calcAge||'?'))}</div>
              ${team ? `<div style="font-size:10px;opacity:.8;">🏉 ${team.name}</div>` : '<div style="font-size:10px;opacity:.6;">No team</div>'}
              ${s.dispensation ? '<div style="font-size:9px;opacity:.8;">⚡ Disp</div>' : ''}
            </div>`;
          }).join('')}
        </div>` : '<div style="font-size:12px;color:var(--text-dim);">No season records found</div>'}
    </div>

    <!-- Age / Dispensation -->
    <div style="background:var(--bg);border-radius:10px;padding:12px 14px;margin-bottom:16px;">
      <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--text-dim);margin-bottom:8px;">Age & Team Assignment</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:8px;">
        <span style="font-size:13px;">Calculated age <strong>${calcAgeVal||'?'}</strong> → eligible: ${eligible.map(g=>`<span style="background:var(--green-light);color:var(--green);padding:2px 8px;border-radius:10px;font-size:11px;font-weight:700;">${g}</span>`).join(' ')}</span>
      </div>
      <!-- Team assignment — always visible -->
      <div style="margin-bottom:10px;">
        <div style="font-size:11px;color:var(--text-dim);margin-bottom:4px;">Assigned team</div>
        <select id="pdm-assigned-team" style="padding:6px 8px;border:1.5px solid var(--border);border-radius:6px;font-size:12px;width:100%;">
          <option value="">— unassigned —</option>
          ${plSeasonTeams().map(t=>`<option value="${t.id}" ${ps.assignedTeam===t.id?'selected':''}>${t.name}</option>`).join('')}
          ${!plSeasonTeams().length ? '<option disabled style="color:#999;">No teams yet — set up in Teams tab</option>' : ''}
        </select>
      </div>
      <!-- Dispensation -->
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
        <label style="font-size:12px;display:flex;align-items:center;gap:6px;cursor:pointer;">
          <input type="checkbox" id="pdm-disp" ${disp?'checked':''} onchange="document.getElementById('pdm-disp-note-wrap').style.display=this.checked?'block':'none'">
          <span style="font-weight:600;color:#7c3aed;">Dispensation — playing outside natural age group</span>
        </label>
      </div>
      <div id="pdm-disp-note-wrap" style="display:${disp?'block':'none'};margin-top:8px;">
        <input id="pdm-disp-note" type="text" value="${ps.dispensationNote||''}" placeholder="Dispensation note (e.g. League approved 12/02/26)"
          style="width:100%;padding:6px 8px;border:1.5px solid #a78bfa;border-radius:6px;font-size:12px;">
      </div>
    </div>

    <!-- Contact details -->
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px;">
      ${[
        ['Parent/Guardian 1','parent1Name',p.parent1Name,'parent1Phone',p.parent1Phone,'parent1Email',p.parent1Email],
        ['Parent/Guardian 2','parent2Name',p.parent2Name,'parent2Phone',p.parent2Phone,'parent2Email',p.parent2Email],
      ].map(([label,nk,nv,pk,pv,ek,ev])=>`
        <div style="background:var(--bg);border-radius:8px;padding:10px 12px;">
          <div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--text-dim);margin-bottom:6px;">${label}</div>
          <div style="font-size:12px;font-weight:600;">${nv||'—'}</div>
          <div style="font-size:12px;color:var(--text-dim);">${pv?fmtPhone(pv):'—'}</div>
          <div style="font-size:11px;color:var(--text-dim);word-break:break-all;">${ev||'—'}</div>
        </div>`).join('')}
    </div>

    <!-- Emergency contact -->
    <div style="background:#fff8f0;border:1px solid #fed7aa;border-radius:8px;padding:10px 12px;margin-bottom:14px;">
      <div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:#b45309;margin-bottom:4px;">Emergency Contact</div>
      <div style="font-size:13px;font-weight:600;">${p.emergencyName||'—'} ${p.emergencyRelationship?'('+p.emergencyRelationship+')':''}</div>
      <div style="font-size:12px;color:var(--text-dim);">${p.emergencyPhone?fmtPhone(p.emergencyPhone):'—'}${p.emergencyEmail?' · '+p.emergencyEmail:''}</div>
    </div>

    <!-- Account Holder -->
    ${(p.accountHolder||p.accountHolderMobile||p.accountHolderEmail) ? `
    <div style="background:var(--bg);border-radius:8px;padding:10px 12px;margin-bottom:14px;">
      <div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--text-dim);margin-bottom:4px;">Account Holder (registered)</div>
      <div style="font-size:13px;font-weight:600;">${p.accountHolder||'—'}</div>
      <div style="font-size:12px;color:var(--text-dim);">${p.accountHolderMobile?fmtPhone(p.accountHolderMobile):'—'}${p.accountHolderEmail?' · '+p.accountHolderEmail:''}</div>
    </div>` : ''}

    <!-- Medical -->
    ${(p.medicalFlag==='Yes'||p.medicalDetails) ? `
    <div style="background:#fef2f2;border:1px solid #fca5a5;border-radius:8px;padding:10px 12px;margin-bottom:14px;">
      <div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:#dc2626;margin-bottom:4px;">⚕ Medical / Allergies</div>
      <div style="font-size:13px;">${p.medicalDetails||'Flagged — see registration notes'}</div>
    </div>` : ''}

    <!-- School + Suburb + ATSI -->
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px;">
      <div><div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--text-dim);margin-bottom:3px;">School</div><div style="font-size:13px;">${p.school||'—'}</div><div style="font-size:11px;color:var(--text-dim);">Year ${p.schoolYear||'—'}</div></div>
      <div><div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--text-dim);margin-bottom:3px;">Address</div>${p.address?`<div style="font-size:12px;">${p.address}</div>`:''}${[p.suburb,p.postcode,p.state].filter(Boolean).length?`<div style="font-size:12px;">${[p.suburb,p.postcode,p.state].filter(Boolean).join(' ')}</div>`:''}<div style="font-size:12px;">${(!p.address&&!p.suburb&&!p.postcode)?'—':''}</div>${p.atsi&&p.atsi!=='No'?`<div style="font-size:10px;color:#7c3aed;margin-top:2px;">ATSI: ${p.atsi}</div>`:''}</div>
    </div>

    <!-- Notes -->
    <div><div style="font-size:11px;font-weight:700;color:var(--text-dim);margin-bottom:4px;">Season Notes</div>
    <textarea id="pdm-notes" rows="2" placeholder="Any notes about this player for ${plSeason}…"
      style="width:100%;padding:8px;border:1.5px solid var(--border);border-radius:7px;font-size:13px;resize:vertical;">${ps.notes||''}</textarea></div>
  `;

  const modal = document.getElementById('player-detail-modal');
  bringToFront(modal);
  modal.classList.add('open');
}

// ── PLAYER PHOTO UPLOAD ──────────────────────────────────────────────────────
// Flow: user picks file → resize in canvas → chunked upload to backend →
//       backend stores in private Drive folder → fileId saved on player record.
// Photos are NEVER publicly accessible — Drive folder is private.

async function handlePhotoUpload(input) {
  const file = input.files[0];
  if (!file || !plDetailId) return;

  const statusEl = document.getElementById('pdm-photo-status');
  const avatarEl = document.getElementById('pdm-avatar-large');
  if (statusEl) statusEl.textContent = '⏳ Resizing…';

  // Resize to max 400×400px using canvas
  let dataUrl;
  try {
    dataUrl = await resizeImage(file, 400);
  } catch(e) {
    if (statusEl) statusEl.textContent = '❌ Resize failed: ' + e.message;
    showToast('Image resize failed', 'err');
    return;
  }

  if (statusEl) statusEl.textContent = '⏳ Uploading to Drive…';

  // Convert dataUrl to base64 string (strip the data:image/jpeg;base64, prefix)
  const b64 = dataUrl.split(',')[1];
  const mimeType = 'image/jpeg';

  // Get upload URL from backend (creates placeholder in private Drive folder)
  const urlRes = await api('getPhotoUploadUrl', { profileId: plDetailId, mimeType });
  if (urlRes.error) {
    if (statusEl) statusEl.textContent = '❌ ' + urlRes.error;
    showToast('Upload failed: ' + urlRes.error, 'err');
    return;
  }

  // Upload image bytes using chunked JSONP (same approach as CSV import)
  const CHUNK = 2000;
  const chunks = [];
  for (let i = 0; i < b64.length; i += CHUNK) chunks.push(b64.slice(i, i + CHUNK));

  const startRes = await api('startUpload', { totalChunks: chunks.length });
  if (startRes.error) {
    if (statusEl) statusEl.textContent = '❌ ' + startRes.error;
    return;
  }
  const uploadId = startRes.uploadId;

  // Send chunks in parallel batches
  for (let i = 0; i < chunks.length; i += 8) {
    const batch = chunks.slice(i, i + 8);
    const results = await Promise.all(batch.map((data, j) => api('appendChunk', { uploadId, index: i+j, data })));
    for (const r of results) {
      if (r.error) {
        if (statusEl) statusEl.textContent = '❌ Chunk upload failed: ' + r.error;
        return;
      }
    }
    if (statusEl) statusEl.textContent = `⏳ Uploading… ${Math.min(i+8, chunks.length)}/${chunks.length}`;
  }

  // Finalise: backend reassembles, writes to Drive file, saves fileId on player
  const finalRes = await api('finalisePhotoToPlayer', {
    uploadId,
    profileId: plDetailId,
    fileId: urlRes.fileId
  });

  if (finalRes.error) {
    if (statusEl) statusEl.textContent = '❌ ' + finalRes.error;
    showToast('Photo save failed: ' + finalRes.error, 'err');
    return;
  }

  // Update UI: show photo in avatar and update hidden input
  const thumbUrl = `https://lh3.googleusercontent.com/d/${urlRes.fileId}=s200`;
  const imgEl = document.getElementById('pdm-photo-img');
  const initEl = document.getElementById('pdm-avatar-initials');
  if (imgEl) { imgEl.src = thumbUrl; imgEl.style.display = ''; }
  else if (avatarEl) {
    avatarEl.innerHTML = `<img id="pdm-photo-img" src="${thumbUrl}" style="width:100%;height:100%;object-fit:cover;">`;
  }
  if (initEl) initEl.style.display = 'none';
  document.getElementById('pdm-photo').value = urlRes.fileId;
  if (statusEl) statusEl.innerHTML = '✓ Photo stored in Drive (private) <button onclick="removePlayerPhoto()" style="font-size:11px;padding:2px 8px;border:1px solid var(--border);border-radius:5px;background:#fff;cursor:pointer;color:var(--text-dim);margin-left:8px;">Remove</button>';

  // Update local plData
  const p = (plData.players||[]).find(x=>x.profileId===plDetailId);
  if (p) p.photoUrl = urlRes.fileId;

  showToast('Photo uploaded successfully');
  input.value = ''; // reset file input
}

function resizeImage(file, maxSize) {
  return new Promise((resolve, reject) => {
    const img = new Image();
    const url = URL.createObjectURL(file);
    img.onload = () => {
      URL.revokeObjectURL(url);
      const w = img.width, h = img.height;
      const scale = Math.min(maxSize/w, maxSize/h, 1);
      const canvas = document.createElement('canvas');
      canvas.width  = Math.round(w * scale);
      canvas.height = Math.round(h * scale);
      canvas.getContext('2d').drawImage(img, 0, 0, canvas.width, canvas.height);
      resolve(canvas.toDataURL('image/jpeg', 0.85));
    };
    img.onerror = () => reject(new Error('Could not load image'));
    img.src = url;
  });
}

async function removePlayerPhoto() {
  if (!plDetailId) return;
  if (!confirm("Remove this player's photo?")) return;
  const res = await api('updatePlayer', { profileId: plDetailId, photoUrl: '' });
  if (res.error) { showToast('Remove failed: ' + res.error, 'err'); return; }
  const p = (plData.players||[]).find(x=>x.profileId===plDetailId);
  if (p) p.photoUrl = '';
  document.getElementById('pdm-photo').value = '';
  const avatarEl = document.getElementById('pdm-avatar-large');
  const p2 = (plData.players||[]).find(x=>x.profileId===plDetailId);
  if (avatarEl) avatarEl.innerHTML = `<span id="pdm-avatar-initials">${plInitials(p2||{})}</span>`;
  const statusEl = document.getElementById('pdm-photo-status');
  if (statusEl) statusEl.textContent = 'No photo — click avatar to upload';
  showToast('Photo removed');
}

async function savePlayerDetail() {
  if (!plDetailId) return;
  const ps = plSeasonRows().find(r=>r.profileId===plDetailId)||{};

  const photoUrl     = document.getElementById('pdm-photo')?.value?.trim()||'';  // hidden input, set by upload
  const photoConsent = document.getElementById('pdm-photo-consent')?.checked ? 'Yes' : 'No';
  const dispensation = document.getElementById('pdm-disp')?.checked||false;
  const assignedTeam = document.getElementById('pdm-assigned-team')?.value||'';
  const dispNote     = document.getElementById('pdm-disp-note')?.value?.trim()||'';
  const notes        = document.getElementById('pdm-notes')?.value?.trim()||'';

  const btn = document.getElementById('pdm-save-btn');
  btnLoading(btn, true);

  const [r1, r2] = await Promise.all([
    api('updatePlayer', { profileId: plDetailId, photoUrl, photoConsent }),
    ps.id ? api('updatePlayerSeason', { id: ps.id, dispensation, assignedTeam, dispensationNote: dispNote, notes }) : Promise.resolve({ok:true})
  ]);

  btnLoading(btn, false);
  if (r1.error || r2?.error) { showToast('Save failed: '+(r1.error||r2?.error), 'err'); return; }

  // Update local data
  const p = (plData.players||[]).find(x=>x.profileId===plDetailId);
  if (p) { p.photoUrl = photoUrl; p.photoConsent = photoConsent; }
  if (ps.id) {
    Object.assign(ps, { dispensation, assignedTeam, dispensationNote: dispNote, notes });
  }

  showToast('Player saved ✓');
  closePlayerDetail();
  renderPlTab();
}

// ── LAPSED / NOT RETURNED TAB ─────────────────────────────────────
async function renderPlLapsed() {
  document.getElementById('pl-body').innerHTML =
    '<div style="text-align:center;padding:32px;color:var(--text-dim)"><div class="ls-spinner" style="margin:0 auto 12px"></div>Finding lapsed players…</div>';
  const res = await api('getLapsedPlayers', { year: plSeason });
  if (res.error) { document.getElementById('pl-body').innerHTML=`<div style="color:var(--red);padding:20px">${res.error}</div>`; return; }
  const lapsed = res.lapsed||[];
  if (!lapsed.length) {
    document.getElementById('pl-body').innerHTML =
      `<div style="text-align:center;padding:40px;color:var(--text-dim);">
        <div style="font-size:32px;margin-bottom:8px;">✅</div>
        All players from ${res.prevYear} have re-registered for ${plSeason}${res.prevYear?(', or there is no '+res.prevYear+' data yet'):''}.</div>`;
    return;
  }

  const calcCurAge = p => p.calcAge;

  document.getElementById('pl-body').innerHTML = `
    <div style="background:#fef9c3;border:1.5px solid #ca8a04;border-radius:10px;padding:12px 16px;margin-bottom:16px;display:flex;gap:10px;align-items:center;">
      <span style="font-size:20px;">⚠️</span>
      <div><strong>${lapsed.length} player${lapsed.length!==1?'s':''}</strong> registered in ${res.prevYear} have not yet re-registered for ${res.year}.</div>
    </div>
    <input class="pl-search" id="lapsed-search" placeholder="Search name, school…" oninput="filterLapsed()" style="width:100%;margin-bottom:12px;">
    <div id="lapsed-list">
    ${lapsed.map(p => `
      <div class="lapsed-row" id="lapsed-${p.profileId}" onclick="openPlayerDetail('${p.profileId}')"
           style="cursor:pointer;" onmouseenter="this.style.background='var(--green-light)'" onmouseleave="this.style.background=''">
        <div class="pl-avatar">${plInitials(p)}</div>
        <div style="flex:1;min-width:0;">
          <div style="font-weight:700;font-size:13px;">${plName(p)}
            <span style="font-size:10px;font-weight:400;color:var(--text-dim);margin-left:6px;">${p.lastAgeGroup||''} · ${p.gender||''}</span>
          </div>
          <div style="font-size:11px;color:var(--text-dim);">Age ${calcCurAge(p)||'?'} in ${res.year} · ${p.school||'—'} · ${p.suburb||'—'}</div>
        </div>
        <div style="flex-shrink:0;min-width:180px;">
          ${p.parent1Name||p.parent1Phone ? `
            <div style="font-size:11px;display:flex;gap:6px;align-items:baseline;">
              <span style="font-weight:600;font-size:11px;min-width:90px;">${p.parent1Name||''}</span>
              <span style="color:var(--text-dim);">${p.parent1Phone?fmtPhone(p.parent1Phone):''}</span>
            </div>` : ''}
          ${p.parent2Name||p.parent2Phone ? `
            <div style="font-size:11px;display:flex;gap:6px;align-items:baseline;margin-top:1px;">
              <span style="font-weight:600;font-size:11px;min-width:90px;">${p.parent2Name||''}</span>
              <span style="color:var(--text-dim);">${p.parent2Phone?fmtPhone(p.parent2Phone):''}</span>
            </div>` : ''}
          ${!p.parent1Name&&!p.parent1Phone&&!p.parent2Name&&!p.parent2Phone ?
            '<div style="font-size:11px;color:var(--text-dim);">No contact info</div>' : ''}
        </div>
      </div>`).join('')}
    </div>
    <div style="margin-top:12px;text-align:right;">
      <button class="msecondary" onclick="exportLapsed(${JSON.stringify(lapsed).replace(/"/g,'&quot;')})">⬇ Export CSV</button>
    </div>
  `;
}

function filterLapsed() {
  const q = (document.getElementById('lapsed-search')?.value||'').toLowerCase();
  document.querySelectorAll('.lapsed-row').forEach(row => {
    row.style.display = !q || row.textContent.toLowerCase().includes(q) ? '' : 'none';
  });
}

function exportLapsed(lapsed) {
  const rows = [['First Name','Last Name','Last Age Group','Age This Year','School','Suburb','Parent Name','Parent Phone','Parent Email']];
  lapsed.forEach(p => rows.push([toTitleCase(p.firstName||''),toTitleCase(p.lastName||''),p.lastAgeGroup||'',p.calcAge||'',p.school||'',p.suburb||'',p.parent1Name||'',p.parent1Phone||'',p.parent1Email||'']));
  const csv = rows.map(r=>r.map(v=>'"'+String(v).replace(/"/g,'""')+'"').join(',')).join('\n');
  const a = document.createElement('a');
  a.href = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csv);
  a.download = `lapsed_players_${plSeason}.csv`;
  a.click();
}

// ── SCHOOLS TAB ───────────────────────────────────────────────────
function renderPlSchools() {
  const rows = plSeasonRows();
  const pm   = plPlayerMap();
  const bySch = {};
  rows.forEach(r => {
    const p   = pm[r.profileId]||{};
    const sch = p.school || 'Unknown';
    // Shorten school name for display
    const short = sch.replace(/,.*$/,'').trim();
    if (!bySch[short]) bySch[short] = { count:0, boys:0, girls:0, ags:{} };
    bySch[short].count++;
    if (p.gender==='Male') bySch[short].boys++;
    if (p.gender==='Female') bySch[short].girls++;
    const ag = effectiveAgeGroup(r);
    bySch[short].ags[ag] = (bySch[short].ags[ag]||0)+1;
  });

  const sorted = Object.entries(bySch).sort((a,b)=>b[1].count-a[1].count);
  const max    = sorted[0]?.[1]?.count||1;

  if (!sorted.length) {
    document.getElementById('pl-body').innerHTML = '<div style="color:var(--text-dim);padding:20px;text-align:center;">No player data. Import players first.</div>';
    return;
  }

  document.getElementById('pl-body').innerHTML = `
    <div style="margin-bottom:16px;font-size:13px;color:var(--text-dim);">${rows.length} players across ${sorted.length} schools · ${plSeason}</div>
    ${sorted.map(([sch,d])=>`
      <div class="school-bar-row">
        <div style="width:180px;font-size:13px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;" title="${sch}">${sch}</div>
        <div class="school-bar-track"><div class="school-bar-fill" style="width:${Math.round(d.count/max*100)}%"></div></div>
        <div style="width:36px;text-align:right;font-size:13px;font-weight:700;color:var(--green);">${d.count}</div>
        <div style="width:80px;text-align:right;font-size:11px;color:var(--text-dim);">${d.boys}M · ${d.girls}F</div>
      </div>`).join('')}
  `;
}

// ── IMPORT TAB ────────────────────────────────────────────────────
// ── IMPORT STATE ─────────────────────────────────────────────────
let _importData = null; // { season, include[], exclude[] } set after parsing

// ── TEAMS TAB ────────────────────────────────────────────────────────────────
function renderPlTeams() {
  const body     = document.getElementById('pl-body');
  const teams    = plSeasonTeams();
  const seasons  = (plData.players||[]).length ? null : null; // just for reference
  const allSeasonRows = (plData.seasons||[]).filter(s => +s.year === +plSeason);
  const pm       = plPlayerMap();

  // Count players per team
  const teamCount = {};
  allSeasonRows.forEach(s => { if (s.assignedTeam) teamCount[s.assignedTeam] = (teamCount[s.assignedTeam]||0)+1; });
  const unassigned = allSeasonRows.filter(s => !s.assignedTeam).length;

  body.innerHTML = `
    <div style="padding:16px 20px;">

      <!-- Header -->
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:8px;">
        <div>
          <div style="font-size:14px;font-weight:700;">${plSeason} Teams</div>
          <div style="font-size:12px;color:var(--text-dim);">${teams.length} team${teams.length!==1?'s':''} · ${allSeasonRows.length} registered · ${unassigned} unassigned</div>
        </div>
        <button class="mprimary" onclick="openTeamModal(null)" style="font-size:12px;padding:7px 14px;">+ Add Team</button>
      </div>

      <!-- Teams grid -->
      ${teams.length === 0 ? `
        <div style="text-align:center;padding:40px 20px;color:var(--text-dim);">
          <div style="font-size:32px;margin-bottom:10px;">🏉</div>
          <div style="font-weight:700;margin-bottom:6px;">No teams set up for ${plSeason}</div>
          <div style="font-size:13px;margin-bottom:16px;">Add teams first, then assign players from the Players tab or bulk-assign below.</div>
          <button class="mprimary" onclick="openTeamModal(null)">+ Add First Team</button>
        </div>
      ` : `
        <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:14px;margin-bottom:24px;">
          ${teams.map(t => {
            const count  = teamCount[t.id] || 0;
            const roster = allSeasonRows.filter(s => s.assignedTeam === t.id).map(s => pm[s.profileId]).filter(Boolean);
            return `
              <div style="background:#fff;border:1.5px solid var(--border);border-radius:12px;overflow:hidden;">
                <div style="background:var(--green);padding:10px 14px;display:flex;justify-content:space-between;align-items:center;">
                  <div>
                    <div style="font-weight:800;font-size:14px;color:#fff;font-family:'Barlow Condensed',sans-serif;">${t.name}</div>
                    <div style="font-size:11px;color:rgba(255,255,255,.75);">${[t.ageGroup,t.gender].filter(Boolean).join(' · ')}</div>
                  </div>
                  <div style="display:flex;gap:6px;align-items:center;">
                    <span style="background:rgba(255,255,255,.2);color:#fff;font-size:11px;font-weight:700;padding:2px 8px;border-radius:10px;">${count} player${count!==1?'s':''}</span>
                    <button onclick="openTeamModal('${t.id}')" style="background:rgba(255,255,255,.15);border:none;color:#fff;padding:3px 8px;border-radius:6px;font-size:11px;cursor:pointer;font-weight:600;">Edit</button>
                    <button onclick="deleteTeamConfirm('${t.id}','${t.name.replace(/'/g,"\'")}')" style="background:rgba(255,0,0,.2);border:none;color:#fff;padding:3px 8px;border-radius:6px;font-size:11px;cursor:pointer;font-weight:600;">✕</button>
                  </div>
                </div>
                <div style="padding:10px 14px;">
                  ${t.coach ? `<div style="font-size:11px;color:var(--text-dim);margin-bottom:6px;">👤 Coach: <strong>${t.coach}</strong>${t.assistantCoach?' · Asst: <strong>'+t.assistantCoach+'</strong>':''}</div>` : ''}
                  ${roster.length ? `
                    <div style="display:flex;flex-wrap:wrap;gap:4px;">
                      ${roster.map(p=>`<span style="background:var(--green-light);color:var(--green);font-size:11px;font-weight:600;padding:2px 7px;border-radius:10px;">${plName(p)}</span>`).join('')}
                    </div>
                  ` : `<div style="font-size:12px;color:var(--text-dim);font-style:italic;">No players assigned yet</div>`}
                </div>
              </div>`;
          }).join('')}
        </div>

        <!-- Bulk assign section -->
        <div style="border:1.5px solid var(--border);border-radius:12px;overflow:hidden;">
          <div style="background:var(--bg);padding:10px 14px;border-bottom:1px solid var(--border);font-weight:700;font-size:13px;">
            Bulk Assign Players
            <span style="font-size:11px;font-weight:400;color:var(--text-dim);margin-left:8px;">${unassigned} unassigned players</span>
          </div>
          <div style="padding:14px;">
            <table style="width:100%;border-collapse:collapse;font-size:12px;">
              <thead><tr>
                <th style="text-align:left;padding:5px 8px;color:var(--text-dim);font-size:10px;text-transform:uppercase;letter-spacing:.5px;border-bottom:1.5px solid var(--border);">Player</th>
                <th style="text-align:left;padding:5px 8px;color:var(--text-dim);font-size:10px;text-transform:uppercase;letter-spacing:.5px;border-bottom:1.5px solid var(--border);">Age Group</th>
                <th style="text-align:left;padding:5px 8px;color:var(--text-dim);font-size:10px;text-transform:uppercase;letter-spacing:.5px;border-bottom:1.5px solid var(--border);">Team</th>
              </tr></thead>
              <tbody>
                ${allSeasonRows.sort((a,b)=>{
                  const pa=pm[a.profileId]||{}, pb=pm[b.profileId]||{};
                  return (pa.lastName||'').localeCompare(pb.lastName||'');
                }).map(s => {
                  const p = pm[s.profileId]; if (!p) return '';
                  const ag = effectiveAgeGroup(s);
                  return `<tr style="border-bottom:1px solid var(--border);">
                    <td style="padding:5px 8px;font-weight:600;">${plName(p)}</td>
                    <td style="padding:5px 8px;color:var(--text-dim);">${ag||'—'}</td>
                    <td style="padding:5px 8px;">
                      <select onchange="bulkAssignTeam('${s.id}',this.value)" style="font-size:11px;padding:3px 6px;border:1px solid var(--border);border-radius:5px;background:#fff;">
                        <option value="">— unassigned —</option>
                        ${teams.map(t=>`<option value="${t.id}" ${s.assignedTeam===t.id?'selected':''}>${t.name}</option>`).join('')}
                      </select>
                    </td>
                  </tr>`;
                }).join('')}
              </tbody>
            </table>
          </div>
        </div>
      `}
    </div>

    <!-- Team modal -->
    <div id="team-modal-overlay" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:3000;align-items:center;justify-content:center;">
      <div style="background:#fff;border-radius:14px;padding:24px;width:420px;max-width:95vw;box-shadow:0 8px 40px rgba(0,0,0,.18);">
        <div style="font-weight:800;font-size:16px;font-family:'Barlow Condensed',sans-serif;margin-bottom:16px;" id="team-modal-title">Add Team</div>
        <input type="hidden" id="tm-id">
        <div style="display:grid;gap:10px;">
          <div>
            <div style="font-size:11px;font-weight:700;color:var(--text-dim);margin-bottom:4px;">TEAM NAME *</div>
            <input id="tm-name" type="text" placeholder="e.g. U12 Boys Blue" style="width:100%;padding:8px 10px;border:1.5px solid var(--border);border-radius:7px;font-size:13px;">
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
            <div>
              <div style="font-size:11px;font-weight:700;color:var(--text-dim);margin-bottom:4px;">AGE GROUP</div>
              <select id="tm-age" style="width:100%;padding:8px 10px;border:1.5px solid var(--border);border-radius:7px;font-size:13px;">
                <option value="">—</option>
                ${['U9','U10','U11','U12','U13','U14','U15','U16','U17'].map(g=>`<option>${g}</option>`).join('')}
              </select>
            </div>
            <div>
              <div style="font-size:11px;font-weight:700;color:var(--text-dim);margin-bottom:4px;">GENDER</div>
              <select id="tm-gender" style="width:100%;padding:8px 10px;border:1.5px solid var(--border);border-radius:7px;font-size:13px;">
                <option value="">—</option>
                <option>Boys</option><option>Girls</option><option>Mixed</option>
              </select>
            </div>
          </div>
          <div>
            <div style="font-size:11px;font-weight:700;color:var(--text-dim);margin-bottom:4px;">COACH</div>
            <input id="tm-coach" type="text" placeholder="Coach name" style="width:100%;padding:8px 10px;border:1.5px solid var(--border);border-radius:7px;font-size:13px;">
          </div>
          <div>
            <div style="font-size:11px;font-weight:700;color:var(--text-dim);margin-bottom:4px;">ASSISTANT COACH</div>
            <input id="tm-acoach" type="text" placeholder="Assistant coach name" style="width:100%;padding:8px 10px;border:1.5px solid var(--border);border-radius:7px;font-size:13px;">
          </div>
          <div>
            <div style="font-size:11px;font-weight:700;color:var(--text-dim);margin-bottom:4px;">NOTES</div>
            <input id="tm-notes" type="text" placeholder="Any notes" style="width:100%;padding:8px 10px;border:1.5px solid var(--border);border-radius:7px;font-size:13px;">
          </div>
        </div>
        <div style="display:flex;gap:10px;margin-top:18px;justify-content:flex-end;">
          <button onclick="closeTeamModal()" style="padding:8px 18px;border:1.5px solid var(--border);border-radius:8px;background:#fff;cursor:pointer;font-size:13px;">Cancel</button>
          <button onclick="saveTeamModal()" class="mprimary" style="padding:8px 18px;font-size:13px;">Save Team</button>
        </div>
      </div>
    </div>
  `;
}

function openTeamModal(teamId) {
  const overlay = document.getElementById('team-modal-overlay');
  const t = teamId ? (plData.teams||[]).find(x=>x.id===teamId) : null;
  document.getElementById('team-modal-title').textContent = t ? 'Edit Team' : 'Add Team';
  document.getElementById('tm-id').value       = t?.id || '';
  document.getElementById('tm-name').value     = t?.name || '';
  document.getElementById('tm-age').value      = t?.ageGroup || '';
  document.getElementById('tm-gender').value   = t?.gender || '';
  document.getElementById('tm-coach').value    = t?.coach || '';
  document.getElementById('tm-acoach').value   = t?.assistantCoach || '';
  document.getElementById('tm-notes').value    = t?.notes || '';
  overlay.style.display = 'flex';
}

function closeTeamModal() {
  document.getElementById('team-modal-overlay').style.display = 'none';
}

async function saveTeamModal() {
  const name = document.getElementById('tm-name').value.trim();
  if (!name) { showToast('Team name is required', 'err'); return; }
  const payload = {
    id:             document.getElementById('tm-id').value || undefined,
    season:         plSeason,
    name,
    ageGroup:       document.getElementById('tm-age').value,
    gender:         document.getElementById('tm-gender').value,
    coach:          document.getElementById('tm-coach').value.trim(),
    assistantCoach: document.getElementById('tm-acoach').value.trim(),
    notes:          document.getElementById('tm-notes').value.trim(),
  };
  const res = await api('saveTeam', payload);
  if (res.error) { showToast('Save failed: ' + res.error, 'err'); return; }

  // Update local data
  const existing = (plData.teams||[]).findIndex(t => t.id === payload.id);
  const newTeam  = { ...payload, id: res.id };
  if (existing >= 0) plData.teams[existing] = newTeam;
  else { plData.teams = plData.teams || []; plData.teams.push(newTeam); }

  closeTeamModal();
  showToast(payload.id ? 'Team updated' : 'Team added');
  renderPlTeams();
}

async function deleteTeamConfirm(id, name) {
  if (!confirm(`Delete team "${name}"? Players assigned to it will become unassigned.`)) return;
  const res = await api('deleteTeam', { id });
  if (res.error) { showToast('Delete failed: ' + res.error, 'err'); return; }
  plData.teams = (plData.teams||[]).filter(t => t.id !== id);
  // Clear assignedTeam for any player season that used this team
  (plData.seasons||[]).forEach(s => { if (s.assignedTeam === id) s.assignedTeam = ''; });
  showToast(`Team "${name}" deleted`);
  renderPlTeams();
}

async function bulkAssignTeam(seasonId, teamId) {
  const res = await api('updatePlayerSeason', { id: seasonId, assignedTeam: teamId });
  if (res.error) { showToast('Assign failed: ' + res.error, 'err'); return; }
  const s = (plData.seasons||[]).find(x => x.id === seasonId);
  if (s) s.assignedTeam = teamId;
  // Refresh team counts in the cards without full re-render
  renderPlTeams();
}

function renderPlImport() {
  _importData = null;
  document.getElementById('pl-body').innerHTML = `
    <div style="max-width:720px;">
      <h3 style="font-family:'Barlow Condensed',sans-serif;font-weight:900;font-size:17px;text-transform:uppercase;margin-bottom:8px;">Import PlayHQ Data</h3>
      <p style="font-size:13px;color:var(--text-dim);margin-bottom:16px;line-height:1.6;">
        Export a <strong>participants CSV</strong> from the PlayHQ admin portal, then drag it here.
        You'll be able to review all records — included, excluded, and duplicates — before committing.
      </p>
      <div style="margin-bottom:14px;display:flex;gap:10px;align-items:center;">
        <label style="font-size:12px;font-weight:700;color:var(--text-dim);">Import for season:</label>
        <select id="import-season" style="padding:6px 10px;border:1.5px solid var(--border);border-radius:6px;font-size:13px;"
          onchange="if(_importData){_importData=null;document.getElementById('import-review').innerHTML='<div style=\'color:var(--text-dim);font-size:13px;padding:12px 0;\'>Season changed — re-drop your file to re-process with the new season.</div>';}">
          ${(years||[new Date().getFullYear()]).map(y=>`<option value="${y}" ${y==plSeason?'selected':''}>${y}</option>`).join('')}
        </select>
      </div>
      <div class="import-drop" id="import-drop"
        ondragover="event.preventDefault();this.classList.add('drag')"
        ondragleave="this.classList.remove('drag')"
        ondrop="handleImportDrop(event)"
        onclick="document.getElementById('import-file-input').click()">
        <div style="font-size:32px;margin-bottom:8px;">📂</div>
        <div style="font-weight:700;font-size:14px;margin-bottom:4px;">Drop participants CSV here</div>
        <div style="font-size:12px;color:var(--text-dim);">or click to browse · PlayHQ participants export</div>
      </div>
      <input type="file" id="import-file-input" accept=".csv" style="display:none" onchange="handleImportFile(this.files[0])">
      <div id="import-review" style="margin-top:20px;"></div>
    </div>
  `;
}

function handleImportDrop(e) {
  e.preventDefault();
  document.getElementById('import-drop').classList.remove('drag');
  const file = e.dataTransfer.files[0];
  if (file) handleImportFile(file);
}

function handleImportFile(file) {
  if (!file) return;
  const review = document.getElementById('import-review');
  review.innerHTML = '<div style="color:var(--text-dim);font-size:13px;padding:16px 0;">Reading file…</div>';

  const reader = new FileReader();
  reader.onload = ev => {
    const allRows  = parseCSV(ev.target.result).filter(r => (r['First Name']||'').trim());

    // ── Auto-detect season from CSV's own Season column ──────────────
    // The CSV contains a "Season" column (e.g. "2026") — always use this
    // so historical imports calculate age against the correct year, not today's season.
    const csvSeason = allRows.find(r => r['Season'] && /^\d{4}$/.test((r['Season']||'').trim()))?.['Season']?.trim();
    const selEl     = document.getElementById('import-season');
    let   season    = +selEl.value;

    if (csvSeason) {
      season = +csvSeason;
      // Add option if not already in selector
      if (![...selEl.options].some(o => +o.value === season)) {
        const opt = document.createElement('option');
        opt.value = season; opt.textContent = season;
        selEl.appendChild(opt);
      }
      selEl.value = season;
    }

    // Compare against the import selector's value (not plSeason, which is the main
    // dashboard season and may legitimately differ from the import target year)
    const importSelSeason = +selEl.value;
    const seasonChanged = csvSeason && +csvSeason !== importSelSeason;

    // Build existing player lookup for duplicate detection
    const pm = plPlayerMap();
    const existingSeasonIds = new Set(
      (plData?.seasons||[]).filter(s=>+s.year===season).map(s=>s.profileId)
    );

    // Categorise every row
    const categorised = allRows.map((r, idx) => {
      const firstName = toTitleCase((r['First Name']||'').trim());
      const lastName  = toTitleCase((r['Last Name']||'').trim());
      const dob       = (r['Date of Birth']||'').trim();
      const profileId = (r['Profile ID']||'').trim() ||
                        'kjfc_'+firstName.toLowerCase()+'_'+lastName.toLowerCase()+'_'+dob.replace(/\//g,'');
      // Age is always calculated against the SEASON year (what age they turn in that calendar year)
      const age       = calcAgeClient(dob, season);
      const ageGroup  = (r['Age Group']||'').toUpperCase();
      const role      = (r['Role']||'').trim();
      const club      = (r['Club']||'').trim();
      const status    = (r['Status']||'').trim();
      const gender    = (r['Gender']||'').trim();
      const school    = (r['School Details']||'').trim().replace(/,.*$/,'');
      const suburb    = (r['Participant Suburb/Town']||'').trim();

      // Exclusion reasons
      let excludeReason = null;
      if (status && status !== 'Active')                          excludeReason = `Status: ${status}`;
      else if (role && role !== 'Player')                         excludeReason = `Role: ${role}`;
      else if (club && !club.toLowerCase().includes('kinglake'))  excludeReason = `Club: ${club}`;
      else if (ageGroup === 'SENIOR')                             excludeReason = 'Senior (age group tag)';
      else if (age !== null && age > 17)                          excludeReason = `Over 17 (age ${age} in ${season})`;
      else if (age !== null && age < 5)                           excludeReason = `Age error (age ${age})`;

      // Duplicate detection
      let dupType = null;
      if (!excludeReason) {
        if (existingSeasonIds.has(profileId)) {
          dupType = 'already_this_season';
        } else {
          if (pm[profileId]) {
            dupType = 'returning';
          } else {
            const nameKey = `${firstName.toLowerCase()}_${lastName.toLowerCase()}_${dob}`;
            const fuzzyMatch = Object.values(pm).find(p =>
              `${p.firstName.toLowerCase()}_${p.lastName.toLowerCase()}_${p.dob}` === nameKey
            );
            if (fuzzyMatch) dupType = 'name_dob_match';

            const csvDup = allRows.slice(0, idx).find(prev =>
              (prev['First Name']||'').trim().toLowerCase() === firstName.toLowerCase() &&
              (prev['Last Name']||'').trim().toLowerCase()  === lastName.toLowerCase()  &&
              (prev['Date of Birth']||'').trim()            === dob
            );
            if (csvDup) dupType = 'csv_duplicate';
          }
        }
      }

      return { r, idx, firstName, lastName, dob, profileId, age, ageGroup, gender, school, suburb,
               excludeReason, dupType,
               // Pre-checked: new players + returning (contact update) + name_dob_match (contact update)
               // Unchecked: already_this_season (skip), csv_duplicate (skip), any excluded row
               _checked: !excludeReason && dupType !== 'already_this_season' && dupType !== 'csv_duplicate' };
    });

    _importData = { season, rows: categorised, file: file.name, rawCsv: ev.target.result };
    renderImportReview(categorised, season, file.name, seasonChanged ? csvSeason : null);
  };
  reader.readAsText(file);
}

function renderImportReview(rows, season, filename, autoDetectedSeason) {
  const review = document.getElementById('import-review');

  const include = rows.filter(r => !r.excludeReason);
  const exclude = rows.filter(r =>  r.excludeReason);
  const dups    = include.filter(r => r.dupType && r.dupType !== 'returning');
  const fresh   = include.filter(r => !r.dupType);
  const returning = include.filter(r => r.dupType === 'returning');

  const tabs = [
    { id:'inc',  label:`✓ Include (${include.length})`,  colour:'var(--green)' },
    { id:'exc',  label:`✗ Excluded (${exclude.length})`, colour:'var(--red)'   },
    { id:'dup',  label:`⚠ Flagged (${dups.length})`,    colour:'#ca8a04'      },
  ];

  review.innerHTML = `
    <!-- Auto-detect notice: only shown when CSV season differs from selector -->
    ${autoDetectedSeason ? `
    <div style="background:#fefce8;border:1.5px solid #fde68a;border-radius:10px;padding:10px 14px;margin-bottom:12px;display:flex;gap:8px;align-items:center;">
      <span style="font-size:16px;">⚠️</span>
      <div style="font-size:13px;">CSV season (<strong>${autoDetectedSeason}</strong>) differs from the selected import season (<strong>${season}</strong>). Ages are calculated against <strong>end of ${season}</strong>. Use the selector above to correct this if needed.</div>
    </div>` : ''}

    <!-- Summary bar -->
    <div style="background:var(--green-light);border:1.5px solid var(--green);border-radius:10px;padding:13px 16px;margin-bottom:16px;">
      <div style="font-weight:700;font-size:14px;color:var(--green);margin-bottom:6px;">📂 ${filename} — Season ${season}</div>
      <div style="display:flex;gap:20px;flex-wrap:wrap;font-size:13px;">
        <span><strong style="color:var(--green)">${include.length}</strong> to include</span>
        <span><strong style="color:var(--red)">${exclude.length}</strong> excluded</span>
        <span><strong style="color:#ca8a04">${dups.length}</strong> flagged</span>
        <span><strong>${fresh.length}</strong> new · <strong>${returning.length}</strong> update contact details · <strong>${rows.filter(r=>r.dupType==='already_this_season').length}</strong> already imported</span>
      </div>
      <div style="font-size:11px;color:var(--text-dim);margin-top:5px;">Age eligibility assessed at end of ${season} (player's age turning during ${season} calendar year)</div>
    </div>

    <!-- View tabs -->
    <div style="display:flex;gap:0;margin-bottom:0;border-bottom:2px solid var(--border);">
      ${tabs.map((t,i)=>`<button class="imp-vtab${i===0?' act':''}" data-vtab="${t.id}"
        onclick="switchImportTab(this,'${t.id}')"
        style="padding:8px 16px;background:transparent;border:none;border-bottom:3px solid ${i===0?t.colour:'transparent'};
               font-size:12px;font-weight:700;cursor:pointer;color:${i===0?t.colour:'var(--text-dim)'};
               font-family:'Barlow Condensed',sans-serif;text-transform:uppercase;letter-spacing:.5px;white-space:nowrap;">
        ${t.label}</button>`).join('')}
      <div style="flex:1;"></div>
      <button onclick="importToggleAll(true)"  style="font-size:11px;padding:6px 10px;background:transparent;border:none;color:var(--green);cursor:pointer;font-weight:700;">✓ All</button>
      <button onclick="importToggleAll(false)" style="font-size:11px;padding:6px 10px;background:transparent;border:none;color:var(--red);cursor:pointer;font-weight:700;">✗ None</button>
    </div>

    <!-- Record list -->
    <div id="imp-list" style="max-height:420px;overflow-y:auto;border:1.5px solid var(--border);border-top:none;border-radius:0 0 8px 8px;"></div>

    <!-- Confirm bar -->
    <div style="margin-top:14px;display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
      <div id="imp-sel-count" style="flex:1;font-size:13px;color:var(--text-dim);"></div>
      <button class="msecondary" onclick="renderPlImport()">← Start over</button>
      <button class="mprimary" id="imp-confirm-btn" onclick="runImport()">Import selected players</button>
    </div>
  `;

  renderImportTab('inc', rows);
  updateImportCount(rows);
}

function switchImportTab(btn, tabId) {
  document.querySelectorAll('.imp-vtab').forEach(b => {
    b.style.borderBottomColor = 'transparent';
    b.style.color = 'var(--text-dim)';
    b.classList.remove('act');
  });
  const colours = { inc:'var(--green)', exc:'var(--red)', dup:'#ca8a04' };
  btn.style.borderBottomColor = colours[tabId]||'var(--green)';
  btn.style.color = colours[tabId]||'var(--green)';
  btn.classList.add('act');
  renderImportTab(tabId, _importData.rows);
}

function renderImportTab(tabId, rows) {
  const list = document.getElementById('imp-list');
  if (!list) return;

  let filtered;
  if (tabId === 'inc') filtered = rows.filter(r => !r.excludeReason);
  else if (tabId === 'exc') filtered = rows.filter(r =>  r.excludeReason);
  else filtered = rows.filter(r => !r.excludeReason && r.dupType);

  if (!filtered.length) {
    list.innerHTML = `<div style="padding:24px;text-align:center;color:var(--text-dim);font-size:13px;">No records in this category.</div>`;
    return;
  }

  const dupColour = {
    already_this_season: { bg:'#f0fdf4', badge:'#16a34a', label:'Already imported' },
    returning:           { bg:'#eff6ff', badge:'#2563eb', label:'Returning — will update contact details' },
    name_dob_match:      { bg:'#fefce8', badge:'#ca8a04', label:'Name+DOB match — will update contact details' },
    csv_duplicate:       { bg:'#fef2f2', badge:'#dc2626', label:'Duplicate in file' },
  };

  list.innerHTML = filtered.map(item => {
    const age     = item.age;
    const ageDisp = age ? `U${age}` : (item.ageGroup||'?');
    const dc      = item.dupType ? dupColour[item.dupType] : null;
    const rowBg   = item.excludeReason ? '#fef2f2' : (dc?.bg || '#fff');
    const canCheck = !item.excludeReason;

    return `<div style="display:flex;align-items:center;gap:10px;padding:9px 12px;border-bottom:1px solid var(--border);background:${rowBg};${!item._checked&&canCheck?'opacity:.6':''}" id="imp-row-${item.idx}">
      ${canCheck
        ? `<input type="checkbox" ${item._checked?'checked':''} onchange="importToggleRow(${item.idx},this.checked)"
             style="width:15px;height:15px;cursor:pointer;accent-color:var(--green);flex-shrink:0;">`
        : `<div style="width:15px;height:15px;flex-shrink:0;"></div>`}
      <div style="flex:1;min-width:0;">
        <div style="font-size:13px;font-weight:600;">${toTitleCase(item.firstName)} ${toTitleCase(item.lastName)}
          ${dc ? `<span style="background:${dc.bg};color:${dc.badge};border:1px solid ${dc.badge};font-size:9px;font-weight:700;border-radius:4px;padding:1px 5px;margin-left:4px;text-transform:uppercase;">${dc.label}</span>` : ''}
          ${item.excludeReason ? `<span style="background:#fee2e2;color:#dc2626;font-size:9px;font-weight:700;border-radius:4px;padding:1px 5px;margin-left:4px;">${item.excludeReason}</span>` : ''}
        </div>
        <div style="font-size:11px;color:var(--text-dim);margin-top:1px;">
          ${ageDisp} · ${item.gender||'—'} · DOB ${item.dob||'—'} · ${item.school||'—'} · ${item.suburb||'—'}
        </div>
      </div>
    </div>`;
  }).join('');
}

function importToggleRow(idx, checked) {
  if (!_importData) return;
  const item = _importData.rows.find(r => r.idx === idx);
  if (item) item._checked = checked;
  const row = document.getElementById(`imp-row-${idx}`);
  if (row) row.style.opacity = checked ? '1' : '0.6';
  updateImportCount(_importData.rows);
}

function importToggleAll(checked) {
  if (!_importData) return;
  _importData.rows.forEach(r => { if (!r.excludeReason) r._checked = checked; });
  // Re-render the active tab
  const activeTab = document.querySelector('.imp-vtab.act');
  const tabId = activeTab?.dataset?.vtab || 'inc';
  renderImportTab(tabId, _importData.rows);
  updateImportCount(_importData.rows);
}

function updateImportCount(rows) {
  const sel = rows.filter(r => r._checked).length;
  const el  = document.getElementById('imp-sel-count');
  const btn = document.getElementById('imp-confirm-btn');
  if (el)  el.textContent  = `${sel} player${sel!==1?'s':''} selected for import`;
  if (btn) btn.textContent = `Import ${sel} player${sel!==1?'s':''}`;
  if (btn) btn.disabled    = sel === 0;
}

async function runImport() {
  if (!_importData) return;
  const selected = _importData.rows.filter(r => r._checked);
  const season   = _importData.season;
  if (!selected.length) { showToast('No players selected', 'err'); return; }

  const btn     = document.getElementById('imp-confirm-btn');
  const countEl = document.getElementById('imp-sel-count');
  btn.disabled  = true;
  console.log('[KJFC import] Starting import: ' + selected.length + ' players, season ' + season);

  const setStatus = (msg, colour) => {
    if (!countEl) return;
    countEl.innerHTML = `<span style="font-size:13px;color:${colour||'var(--text-dim)'};">${msg}</span>`;
  };

  // ── Step 1: Build filtered CSV (only selected rows) ───────────────────────
  setStatus('Preparing CSV…');
  const allParsed   = parseCSV(_importData.rawCsv);
  const selectedKeys = new Set(selected.map(item => {
    const r = item.r;
    return (r['Profile ID']||'').trim() ||
      ((r['First Name']||'').trim()+'_'+(r['Last Name']||'').trim()+'_'+(r['Date of Birth']||'').trim());
  }));
  const filteredRows = allParsed.filter(r => {
    const key = (r['Profile ID']||'').trim() ||
      ((r['First Name']||'').trim()+'_'+(r['Last Name']||'').trim()+'_'+(r['Date of Birth']||'').trim());
    return selectedKeys.has(key);
  });
  const csvHeaders = Object.keys(allParsed[0] || {});
  const esc = v => { const s = String(v||''); return (s.includes(',') || s.includes('"') || s.includes('\n')) ? '"'+s.replace(/"/g,'""')+'"' : s; };
  const csvText = [
    csvHeaders.map(esc).join(','),
    ...filteredRows.map(r => csvHeaders.map(h => esc(r[h]||'')).join(','))
  ].join('\n');

  // ── Step 2: Chunked JSONP upload via ScriptProperties ────────────────────
  // CSV is base64-encoded first to eliminate special chars (commas, quotes,
  // slashes) that would bloat URLs when JSON+encodeURIComponent'd.
  // Base64 output is only A-Za-z0-9+/= — ~2% URL encoding overhead vs ~50% raw.
  // 65KB CSV → ~87KB base64, split into 2000-char chunks = ~44 JSONP calls.
  // Each URL stays under 2500 chars — well within all limits.
  const b64Csv = btoa(unescape(encodeURIComponent(csvText)));
  const CHUNK_SIZE = 2000; // base64 chars per chunk — safe for URL encoding
  const chunks = [];
  for (let i = 0; i < b64Csv.length; i += CHUNK_SIZE) {
    chunks.push(b64Csv.slice(i, i + CHUNK_SIZE));
  }
  console.log('[KJFC import] Uploading ' + chunks.length + ' chunks (' + csvText.length + ' chars total)');

  // 2a: Start upload session
  setStatus('Starting upload… (0/' + chunks.length + ')');
  const startRes = await api('startUpload', { totalChunks: chunks.length });
  if (startRes.error) {
    btn.disabled = false;
    setStatus('❌ Upload failed: ' + startRes.error, '#dc2626');
    showToast('Upload failed: ' + startRes.error, 'err');
    return;
  }
  const uploadId = startRes.uploadId;

  // 2b: Send chunks in parallel batches of 8 — ~8x faster than sequential
  const PARALLEL = 8;
  let sent = 0;
  for (let i = 0; i < chunks.length; i += PARALLEL) {
    const batch = chunks.slice(i, i + PARALLEL);
    const results = await Promise.all(
      batch.map((data, j) => api('appendChunk', { uploadId, index: i + j, data }))
    );
    for (let j = 0; j < results.length; j++) {
      if (results[j].error) {
        btn.disabled = false;
        setStatus('❌ Chunk ' + (i+j) + ' failed: ' + results[j].error, '#dc2626');
        showToast('Upload failed: ' + results[j].error, 'err');
        return;
      }
    }
    sent += batch.length;
    setStatus('Uploading… ' + sent + '/' + chunks.length);
  }

  // 2c: Finalise — backend reassembles, saves to Drive, runs import
  setStatus('Importing players…');
  const res = await api('finaliseUpload', { uploadId, season });

  btn.disabled = false;
  console.log('[KJFC import] finaliseUpload result:', JSON.stringify(res));
  if (!res || res.error) {
    setStatus('❌ Import failed: ' + (res && res.error || 'Unknown error'), '#dc2626');
    showToast('Import failed: ' + (res && res.error || 'Unknown error'), 'err');
    return;
  }

  const s = res.stats || {};
  setStatus('✓ Import complete', 'var(--green)');
  showToast(`Import done — ${s.imported} new · ${s.updated} updated · ${s.seniors} seniors excluded${s.errors?' · '+s.errors+' errors':''}`);
  _importData = null;
  plData      = null;
  plSeason    = season;
  document.getElementById('pl-season-sel').value = season;
  await loadPlayerData();
  switchPlTab(document.querySelector('.pl-tab[data-tab="overview"]'), 'overview');
}


// Client-side age calc (mirrors backend)
// Normalise any DOB to DD/MM/YYYY - handles ISO strings and existing strings
function normaliseDob(raw) {
  if (!raw) return '';
  if (raw instanceof Date && !isNaN(raw)) {
    return String(raw.getDate()).padStart(2,'0') + '/' +
           String(raw.getMonth()+1).padStart(2,'0') + '/' + raw.getFullYear();
  }
  const s = String(raw).trim();
  if (/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(s)) return s;
  const iso = s.match(/^(\d{4})-(\d{2})-(\d{2})/);
  if (iso) return iso[3] + '/' + iso[2] + '/' + iso[1];
  return s;
}

function calcAgeClient(dobStr, season) {
  if (!dobStr) return null;
  const s = normaliseDob(dobStr);
  const parts = s.split('/');
  if (parts.length < 3) return null;
  let yr = parseInt(parts[2], 10);
  if (yr < 100) yr += (yr < 30 ? 2000 : 1900);
  return parseInt(season, 10) - yr;
}

function parseCSV(text) {
  const lines = text.split(/\r?\n/);
  if (!lines.length) return [];
  const headers = parseCSVLine(lines[0]);
  const rows = [];
  for (let i = 1; i < lines.length; i++) {
    if (!lines[i].trim()) continue;
    const vals = parseCSVLine(lines[i]);
    if (!vals.some(v=>v.trim())) continue;
    const obj = {};
    headers.forEach((h,i) => obj[h] = vals[i]||'');
    rows.push(obj);
  }
  return rows;
}

function parseCSVLine(line) {
  const result = [];
  let cur = '', inQ = false;
  for (let i = 0; i < line.length; i++) {
    const c = line[i];
    if (c === '"') { inQ = !inQ; }
    else if (c === ',' && !inQ) { result.push(cur); cur = ''; }
    else { cur += c; }
  }
  result.push(cur);
  return result;
}

// ── SETTINGS TAB ─────────────────────────────────────────────────
function renderPlSettings() {
  const settings = plData.settings || [];

  document.getElementById('pl-body').innerHTML = `
    <h3 style="font-family:'Barlow Condensed',sans-serif;font-weight:900;font-size:17px;text-transform:uppercase;margin-bottom:8px;">Age Group Settings</h3>
    <p style="font-size:13px;color:var(--text-dim);margin-bottom:16px;line-height:1.6;">
      Configure minimum and maximum player numbers per age group based on NFNL rules. These thresholds determine the colour coding on the overview (green/amber/red).
    </p>
    <div style="overflow-x:auto;">
    <table class="pl-table" id="settings-table">
      <thead><tr>
        <th>Age Group</th><th>Gender</th><th>Phase</th><th>Min Players</th><th>Max Players</th><th></th>
      </tr></thead>
      <tbody id="settings-tbody">
        ${settings.map((s,i)=>`
          <tr id="sg-row-${i}">
            <td><strong>${s.ageGroup}</strong></td>
            <td><select data-field="gender" style="padding:4px 6px;border:1px solid var(--border);border-radius:5px;font-size:12px;">
              ${['Mixed','Male','Female'].map(g=>`<option ${s.gender===g?'selected':''}>${g}</option>`).join('')}
            </select></td>
            <td><select data-field="phase" style="padding:4px 6px;border:1px solid var(--border);border-radius:5px;font-size:12px;">
              ${['Development','Competition'].map(p=>`<option ${s.phase===p?'selected':''}>${p}</option>`).join('')}
            </select></td>
            <td><input type="number" data-field="minPlayers" value="${s.minPlayers}" min="1" max="30"
              style="width:60px;padding:4px 6px;border:1px solid var(--border);border-radius:5px;font-size:13px;"></td>
            <td><input type="number" data-field="maxPlayers" value="${s.maxPlayers}" min="1" max="50"
              style="width:60px;padding:4px 6px;border:1px solid var(--border);border-radius:5px;font-size:13px;"></td>
            <td><button class="actbtn" style="color:var(--red)" onclick="removeSettingRow(${i})">Remove</button></td>
          </tr>`).join('')}
      </tbody>
    </table></div>
    <div style="display:flex;gap:8px;margin-top:14px;">
      <button class="msecondary" onclick="addSettingRow()">+ Add Age Group</button>
      <button class="mprimary" onclick="saveSettings()">Save Settings</button>
    </div>
  `;
}

function addSettingRow() {
  const tbody = document.getElementById('settings-tbody');
  const i = tbody.rows.length;
  const tr = document.createElement('tr');
  tr.id = 'sg-row-' + i;
  tr.innerHTML = `
    <td><input type="text" data-field="ageGroup" value="U" placeholder="U12"
      style="width:55px;padding:4px 6px;border:1px solid var(--border);border-radius:5px;font-size:13px;font-weight:700;"></td>
    <td><select data-field="gender" style="padding:4px 6px;border:1px solid var(--border);border-radius:5px;font-size:12px;">
      <option>Mixed</option><option>Male</option><option>Female</option>
    </select></td>
    <td><select data-field="phase" style="padding:4px 6px;border:1px solid var(--border);border-radius:5px;font-size:12px;">
      <option>Competition</option><option>Development</option>
    </select></td>
    <td><input type="number" data-field="minPlayers" value="14" min="1" max="30"
      style="width:60px;padding:4px 6px;border:1px solid var(--border);border-radius:5px;font-size:13px;"></td>
    <td><input type="number" data-field="maxPlayers" value="24" min="1" max="50"
      style="width:60px;padding:4px 6px;border:1px solid var(--border);border-radius:5px;font-size:13px;"></td>
    <td><button class="actbtn" style="color:var(--red)" onclick="this.closest('tr').remove()">Remove</button></td>
  `;
  tbody.appendChild(tr);
}

function removeSettingRow(i) {
  document.getElementById('sg-row-' + i)?.remove();
}

async function saveSettings() {
  const rows = [...document.querySelectorAll('#settings-tbody tr')].map(tr => {
    const get = f => tr.querySelector(`[data-field="${f}"]`)?.value?.trim()||'';
    return { ageGroup: get('ageGroup'), gender: get('gender'), phase: get('phase'),
             minPlayers: +get('minPlayers')||14, maxPlayers: +get('maxPlayers')||24 };
  }).filter(r => r.ageGroup);
  const res = await api('saveAgeSettings', { settings: rows });
  if (res.error) { showToast('Save failed: '+res.error, 'err'); return; }
  plData.settings = rows;
  showToast('Settings saved ✓');
}

document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>